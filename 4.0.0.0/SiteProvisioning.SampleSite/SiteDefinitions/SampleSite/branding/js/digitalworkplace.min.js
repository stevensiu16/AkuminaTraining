function __getTemplatePrefix(){return _spPageContextInfo.siteServerRelativeUrl=="/"?"":_spPageContextInfo.siteServerRelativeUrl}function __getWebPrefix(){return _spPageContextInfo.webServerRelativeUrl=="/"?"":_spPageContextInfo.webServerRelativeUrl}function DWPViewDebugger(){console.info("Digi ViewDebugger Start");console.info(this);console.info("Digi ViewDebugger End")}function ShowHeroItem(data,def){me=this;Akumina.AddIn.Logger.WriteInfoLog("ShowHeroItem");GetCompanyNewsFromSite(data,def)}function GetTagAsValue(dataLoadProperties){return dataLoadProperties.tag}function GetTagAsDepartment(){return Akumina.Digispace.UserContext.Department}function GetTagAsCity(){return Akumina.Digispace.UserContext.City}function CallTargetedNewsRequest(listRequest){var tag="",featured="",dataloadproperties,theCallBack;return dataloadproperties=typeof listRequest.dataLoadProperties=="string"?JSON.parse(listRequest.dataLoadProperties):listRequest.dataLoadProperties,dataloadproperties&&(dataloadproperties.callback!=null&&(theCallBack=window[dataloadproperties.callback],typeof theCallBack=="function"&&(tag=theCallBack(dataloadproperties))),dataloadproperties.featured!=null&&(featured=JSON.parse(dataloadproperties.featured))),{tag:tag,featured:featured?"1":"0",callback:dataloadproperties.callback}}function GetTargetedCAMLQuery(targetModel){var filter='<Where><And><And><And><Leq><FieldRef Name="Start_x0020_Date" /><Value IncludeTimeValue="TRUE" Type="DateTime"><Today /><\/Value><\/Leq><Or><Geq><FieldRef Name="Expires" /><Value IncludeTimeValue="TRUE" Type="DateTime"><Today /><\/Value><\/Geq><IsNull><FieldRef Name="Expires" /><\/IsNull><\/Or><\/And>';return filter+='<Eq><FieldRef Name="Category"/><Value Type="Managed">'+targetModel.tag+"<\/Value><\/Eq><\/And>",filter+='<Eq><FieldRef Name="Featured"/><Value Type="Boolean">'+targetModel.featured+"<\/Value><\/Eq><\/And><\/Where>","<View><Query>"+filter+'<OrderBy><FieldRef Name="Start_x0020_Date" Ascending="False"><\/FieldRef><\/OrderBy><\/Query><RowLimit>1<\/RowLimit><\/View>'}function GetCompanyNewsFromSite(listRequest,def){var utils=Akumina.AddIn.Utilities,web,context=new SP.ClientContext;web=context.get_web();var list=web.get_lists().getByTitle(listRequest.listName),camlQuery=new SP.CamlQuery,query=listRequest.viewXml,tagModel=CallTargetedNewsRequest(listRequest);utils.IsNullOrEmpty(query)&&(query=GetTargetedCAMLQuery(tagModel));camlQuery.set_viewXml(query);listRequest.listItems=list.getItems(camlQuery);utils.IsNullOrEmpty(listRequest.selectFields)?(listRequest.listFields=list.get_fields(),context.load(listRequest.listFields),context.load(listRequest.listItems)):context.load(listRequest.listItems,"Include("+listRequest.selectFields+")");Akumina.AddIn.Logger.logSPCall("GetCompanyNewsFromSite");context.executeQueryAsync(Function.createDelegate(me,function(){CompanyNewsSuccesshandler(listRequest,tagModel,def)}),Function.createDelegate(me,function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace());CompanyNewsErrorhandler(listRequest,def)}))}function CompanyNewsSuccesshandler(listRequest,tagModel,def){for(var listEnumerator=listRequest.listItems.getEnumerator(),item={},itemFound=!1,listItem,fields,i,fieldName;listEnumerator.moveNext();){if(listItem=listEnumerator.get_current(),typeof listRequest.listFields!="undefined")for(fields=listRequest.listFields.getEnumerator();fields.moveNext();)fieldName=fields.get_current().get_staticName(),Akumina.AddIn.Configuration.containsInExcludeField(fieldName)||(item[fieldName]=listItem.get_item(fieldName));else for(fields=listRequest.selectFields.split(","),i=0;i<fields.length;i++)fieldName=fields[i],Akumina.AddIn.Configuration.containsInExcludeField(fieldName)||(item[fieldName]=listItem.get_item(fieldName));item={Title:item.AnnouncementTitle,Category:tagModel.tag,Image:item.Image!=null?item.Image.get_url():"",Link:item.FriendlyUrl,HasImage:item.Image!=null?!0:!1};itemFound=!0}itemFound||(item={Title:"News Item Not Found",Category:"Tag = "+tagModel.tag+", Featured = "+tagModel.featured+", Callback = "+tagModel.callback,Image:"",Link:"",HasImage:!1});def.resolve({response:item})}function CompanyNewsErrorhandler(listRequest,def){def.reject()}function NewsOrderDate(itemList){return itemList.sort(function(a,b){return b.DateCreated-a.DateCreated})}function NewsGetByCategory(itemList){return itemList.map(function(el){return el.Department.toLowerCase()}).indexOf("corporate")}function ShowDepartmentFeaturedNewsItems(data){var i,dataItem,newItem;Akumina.AddIn.Logger.WriteInfoLog("ShowDepartmentFeaturedNewsItems");var newData={},itemList=[],isFirstItem=!0;for(i=0;i<data.Items.length;i++)dataItem=data.Items[i],isFirstItem?(isFirstItem=!1,newData.FirstItem={Title:dataItem.AnnouncementTitle,Image:dataItem.Image!=null?dataItem.Image.get_url():"",Link:dataItem.FriendlyUrl}):(newItem={Title:dataItem.AnnouncementTitle,Image:dataItem.Image!=null?dataItem.Image.get_url():"",Link:dataItem.FriendlyUrl},itemList.push(newItem));return newData.ViewMoreLink=_spPageContextInfo.webServerRelativeUrl+"/Pages/NewsList.aspx",newData.ViewMoreText="View All News",newData.Items=itemList,newData.HasItems=data.Items.length>0?!0:!1,newData}function ShowHomePageDepartmentNewsItems(data,def){var listRequest,sitelist,orderedSiteList,siteIndex,allresults;for(me=this,Akumina.AddIn.Logger.WriteInfoLog("ShowHomePageDepartmentNewsItems"),listRequest=data,(listRequest.dataLoadProperties==null||listRequest.dataLoadProperties=="")&&(listRequest.dataLoadProperties="{'sites':[]}"),sitelist=JSON.parse(listRequest.dataLoadProperties.replace(/'/g,'"')),orderedSiteList=[],Akumina.Digispace.ConfigurationContext.EnableAzureAD&&orderedSiteList.push(GetSiteForDepartment()),siteIndex=getRandomInt(0,sitelist.sites.length-1);orderedSiteList.length<4;)orderedSiteList.indexOf(sitelist.sites[siteIndex])==-1?orderedSiteList.push(sitelist.sites[siteIndex]):(siteIndex=getRandomInt(0,sitelist.sites.length-1),orderedSiteList.push(sitelist.sites[siteIndex]));allresults={};allresults.Items=[];GetNewsFromSite(listRequest,orderedSiteList,allresults,def)}function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}function GetSiteForDepartment(){var ret=Akumina.Digispace.UserContext.Department,urltokens;return typeof Akumina.Digispace.ConfigurationContext.DepartmentSiteMap[ret]!="undefined"&&(urltokens=Akumina.Digispace.ConfigurationContext.DepartmentSiteMap[ret].SiteName.split("/"),ret=urltokens[urltokens.length-1]),ret}function ShowMediaGalleryVideoItems(data){var newData,itemList,i,dataItem,newItem;for(Akumina.AddIn.Logger.WriteInfoLog("ShowMediaGalleryVideoItems"),newData={},itemList=[],i=0;i<data.Items.length;i++)dataItem=data.Items[i],newItem={Title:dataItem.Title,Image:dataItem.Thumbnail!=null?dataItem.Thumbnail.get_url():"",VideoId:dataItem.VideoId,ChannelId:dataItem.ChannelId},dataItem.Visible&&itemList.push(newItem);return newData.TenantUrl=Akumina.Digispace.ConfigurationContext.TenantUrl,newData.Items=itemList,newData}function ShowMediaGalleryPhotoItems(data){var newData,itemList,i,dataItem,newItem;if(Akumina.AddIn.Logger.WriteInfoLog("ShowMediaGalleryPhotoItems"),newData={},itemList=[],data.Items.length==0)newData.isEmpty=!0;else for(newData.isEmpty=!1,i=0;i<data.Items.length;i++)dataItem=data.Items[i],newItem={Image:dataItem.Image!=null?dataItem.Image.get_url():""},itemList.push(newItem);return newData.Items=itemList,newData}function ShowFeaturedVideoItems(data){var dataItem,newItem,i,mod;Akumina.AddIn.Logger.WriteInfoLog("ShowVideoItems");var newData={},itemList=[],isFirstItem=!0;for(i=0;i<data.Items.length;i++)dataItem=data.Items[i],dataItem.Visible&&(isFirstItem?(isFirstItem=!1,newData.FirstItem={Title:dataItem.Title,Image:dataItem.Thumbnail!=null?dataItem.Thumbnail.get_url():"",VideoId:dataItem.VideoId,ChannelId:dataItem.ChannelId,IsFirstItem:!0}):(newItem={Title:dataItem.Title,Department:"Marketing",Image:dataItem.Thumbnail!=null?dataItem.Thumbnail.get_url():"",VideoId:dataItem.VideoId,ChannelId:dataItem.ChannelId,StartRow:!0,EndRow:!1},itemList.push(newItem)));for(i=0;i<itemList.length;i++)mod=i%2,mod==0?(itemList[i].StartRow=!0,itemList[i].EndRow=!1):(itemList[i].StartRow=!1,itemList[i].EndRow=!0),i==itemList.length-1&&(itemList[i].EndRow=!0);return newData.TenantUrl=Akumina.Digispace.ConfigurationContext.TenantUrl,newData.ViewMoreLink=__getWebPrefix()+"/Pages/MediaGalleryVideoList.aspx",newData.ViewMoreText="Video Gallery",newData.Items=itemList,newData.HasItems=newData.Items.length>0?!0:!1,newData}function ShowFeaturedPhotoItems(data){for(var newItem,newData={},itemList=[],isFirstItem=!0,j=0;j<data.Items.length;j++)dataItem=data.Items[j],(dataItem._ModerationStatus==0||dataItem._ModerationStatus==undefined)&&(isFirstItem?(newData.HeaderImage=dataItem.Image!=null?dataItem.Image.get_url():"",isFirstItem=!1):(newItem={Image:dataItem.Image!=null?dataItem.Image.get_url():""},itemList.push(newItem)));return newData.WebPartTitle="Photo Gallery",newData.ViewMoreLink=__getWebPrefix()+"/Pages/MediaGalleryPhotoList.aspx",newData.ViewMoreText="Photo Gallery",newData.Items=itemList,newData.HasItems=newData.Items.length>0?!0:!1,newData}function ShowFAQItems(data){for(var dataItem,newItem,newData={},itemList=[],i=0;i<data.Items.length;i++)dataItem=data.Items[i],newItem={Title:dataItem.Title,Answer:dataItem.Answer,Active:dataItem.ItemActive},itemList.push(newItem);return newData.Items=itemList,newData.HasItems=newData.Items.length>0?!0:!1,newData.ViewMoreLink=_spPageContextInfo.webServerRelativeUrl+"/Pages/FAQ.aspx",newData.ViewMoreText="All Questions",newData}function ShowNewsItems(data){for(var date,newData={Items:[]},i=0;i<data.Items.length;i++)date=data.Items[i].Created,data.Items[i].ImageUrl=data.Items[i].Image!=null?data.Items[i].Image.get_url():"",data.Items[i].DateCreated=moment(date).format("YYYYMMDDHHMMSS"),data.Items[i].Url=data.Items[i].FriendlyUrl,newData.Items.push(data.Items[i]);return newData.HasViewAllLink=!0,newData.ViewAllLink=__getWebPrefix()+"/Pages/NewsList.aspx",newData.WebPartTitle="News ",newData.Items=NewsOrderDate(newData.Items),newData.Items=newData.Items.slice(0,4),newData}function ShowNewsDetail(data){var newData=data,body;return newData.Title=newData.AnnouncementTitle,newData.ImageUrl=newData.Image,newData.Date=data.Start_x0020_Date!=null?moment(data.Start_x0020_Date).format("MMMM D, YYYY"):"",data.Body!=null&&(body=jQuery.parseHTML(data.Body),$(body).find(".ak-cke-href-frm").each(function(index,element){var id=$(element).attr("data-frmid");$(element).attr("onclick",'ShowAKFormModal("'+id+'")')}),newData.Body=body[0].outerHTML),newData}function ShowDepartmentItems(data,def){GetDepartmentSites().done(function(itemList){var newData={},result;newData.Title="MY DEPARTMENTS";newData.ViewAllLink="#";newData.Items=itemList;newData.HasItems=newData.Items.length>0?!0:!1;result={};result.response=newData;def.resolve(result)})}function ShowMyTeamItems(data){var newData={},itemList=[],item;for(i=0;i<data.Items.length;i++)item={},item.Id=data.Items[i].Id,item.Name=data.Items[i].displayname,item.Phone=data.Items[i].mobilephone,item.Fax=data.Items[i].facsimiletelephonenumber,item.Email=data.Items[i].mail==null||data.Items[i].mail==""?data.Items[i].userprincipalname:data.Items[i].mail,item.Image=__getTemplatePrefix()+"/Style%20Library/DigitalWorkPlace/images/anonymous-user.png",itemList.push(item);return newData.Items=itemList,newData.WebPartTitle="My Team",newData.HasItems=itemList.length>0?!0:!1,newData}function ShowFavoritesItems(data){for(var favorite,newData={Items:data.Items},itemList=[],max=data.Items.length,i=0;i<max;i++){var id=data.Items[i].ID,title=data.Items[i].Title,link=data.Items[i].HyperLink,target="_self",targetValue=data.Items[i].Open_x0020_With;targetValue.toLowerCase().indexOf("new")>-1&&(target="_blank");favorite={Id:id,Title:title,Link:link,Target:target};itemList.push(favorite)}return newData.WebPartTitle="MY FAVORITES",newData.Items=itemList,newData}function GetUserAccessibleApps(groups,appsData){for(var k,accessibleApps=[],i=0;i<appsData.length;i++)for(k=0;k<groups.length;k++)if(appsData[i].Authorization.indexOf(groups[k])!=-1){accessibleApps.push(appsData[i]);break}return accessibleApps}function DashboardShowAppsItems(data,def){var interchangeUrl=Akumina.Digispace.ConfigurationContext.InterchangeURL,ua=window.navigator.userAgent,msie=ua.indexOf(" Trident/")>-1,siteId=Akumina.AddIn.Cache.Get("akumina:apps:siteid:"+_spPageContextInfo.siteAbsoluteUrl),interchangeLogin=Akumina.AddIn.Cache.Get("akumina:apps:interchangelogin:"+_spPageContextInfo.siteAbsoluteUrl),ieoptions,myappsurl;if(siteId==null){var ctx=new SP.ClientContext.get_current,site=ctx.get_site(),web=ctx.get_web();siteId=web.get_id().toString()}ieoptions="forie?siteId="+siteId+"&interchangeQueryKey="+Akumina.Digispace.ConfigurationContext.InterchangeQueryKey;myappsurl=interchangeUrl+"/api/connector/myapps"+(msie?ieoptions:"");$.ajax({type:"GET",url:myappsurl,xhrFields:{withCredentials:!0}}).done(function(response){var groups=Akumina.Digispace.UserContext.userSharePointGroups,allApps=response.data.results,appsData=msie?GetUserAccessibleApps(groups,allApps):allApps,appsForSite=response.data.appsForSite,appsModel={},tab,j,newdata,i,result;if(appsModel.Tabs=[],appsModel.Tabs.push({Name:"Content Apps",Items:[]}),appsModel.Tabs.push({Name:"Management Apps",Items:[]}),appsModel.Tabs.push({Name:"Control Apps",Items:[]}),appsModel.Tabs.push({Name:"Reporting Apps",Items:[]}),appsData)for(i=0;i<appsData.length;i++){for(tab=undefined,j=0;j<appsModel.Tabs.length;j++)if(appsModel.Tabs[j].Name.toLowerCase()==appsData[i].AppGroup.toLowerCase()){tab=appsModel.Tabs[j];break}tab.Items.push({Title:appsData[i].Title,Image:appsData[i].Image,Link:appsData[i].Link})}if(newdata={WebPartTitle:"My Apps",Tabs:appsModel.Tabs,HasItems:allApps.length>0?!0:!1,IsLoggedIn:response.data.isloggedin&&!msie||msie&&interchangeLogin!=null,AppManagerURL:Akumina.Digispace.ConfigurationContext.InterchangeLoginURL,InstanceIdFound:Akumina.Digispace.ConfigurationContext.InterchangeLoginURL.toLowerCase().indexOf("not found")==-1?!0:!1},newdata.IsLoggedIn)if(appsModel.Sites=Akumina.AddIn.Cache.Get(GetMyAppsCacheKey("sites")),appsModel.Sites==null){appsModel.Sites=[];var context=new SP.ClientContext,web=context.get_web(),site=context.get_site(),rootWeb=site.get_rootWeb(),subWebs=rootWeb.getSubwebsForCurrentUser(null);context.load(rootWeb);context.load(subWebs);Akumina.AddIn.Logger.logSPCall("DashboardShowAppsItems");context.executeQueryAsync(function(){var webUrl,i,result;for(appsModel.Sites.push({SiteName:rootWeb.get_serverRelativeUrl().replace("/sites/",""),SiteId:rootWeb.get_id().toString(),Selected:appsForSite?appsForSite.toLowerCase()==rootWeb.get_id().toString().toLowerCase()?"selected":"":rootWeb.get_url().toLowerCase()==_spPageContextInfo.webAbsoluteUrl.toLowerCase()?"selected":""}),webUrl=_spPageContextInfo.webServerRelativeUrl.toLowerCase().replace("/sites/",""),i=0;i<subWebs.get_count();i++){var subWeb=subWebs.itemAt(i),subwebUrl=subWeb.get_serverRelativeUrl().toLowerCase().replace("/sites/",""),subWebTemplate=subWeb.get_webTemplate().toLowerCase();subWebTemplate.indexOf("cmspublishing")!=-1&&appsModel.Sites.push({SiteName:subWeb.get_serverRelativeUrl().replace("/sites/",""),SiteId:subWeb.get_id().toString(),Selected:appsForSite?appsForSite.toLowerCase()==subWeb.get_id().toString().toLowerCase()?"selected":"":subwebUrl==webUrl?"selected":""})}Akumina.AddIn.Cache.Set(GetMyAppsCacheKey("sites"),appsModel.Sites,Akumina.Digispace.ConfigurationContext.CachingStrategyInterval);newdata.Sites=appsModel.Sites;result={response:newdata,request:data};def.resolve(result)},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message());var errorMsg="Error communicating with "+interchangeUrl;Akumina.AddIn.Logger.WriteErrorLog(errorMsg);def.reject(errorMsg)})}else{for(i=0;i<appsModel.Sites.length;i++)appsModel.Sites[i].Selected=appsModel.Sites[i].SiteId.toLowerCase()==appsForSite?"selected":"";newdata.Sites=appsModel.Sites;result={response:newdata,request:data};def.resolve(result)}else result={response:newdata,request:data},def.resolve(result)}).error(function(xhr,ajaxOptions,thrownError){Akumina.AddIn.Logger.WriteErrorLog(xhr.status);Akumina.AddIn.Logger.WriteErrorLog(thrownError);var errorMsg="Error communicating with "+interchangeUrl;Akumina.AddIn.Logger.WriteErrorLog(errorMsg);def.reject(errorMsg)})}function ShowDashboardUserInfo(){var userLoginName=_spPageContextInfo.userLoginName,profileImageUrl=__getTemplatePrefix()+"/_layouts/15/userphoto.aspx?size=L&username="+userLoginName;$(".ak-user-avatar img").attr("src",profileImageUrl);$(".ak-user-info .ak-user-name").text(Akumina.Digispace.UserContext.DisplayName);$(".ak-user-info .ak-user-title").text(Akumina.Digispace.UserContext.JobTitle);$(".ak-user-info .ak-user-dept").text(Akumina.Digispace.UserContext.Department);$(".ak-user-info .ak-user-locaiton .fa-map-marker").text(" "+Akumina.Digispace.UserContext.City)}function ShowDashboardItems(data){var newData,selectedItems,j,maxLength,firstSectionNumber,i,startColumn,endColumn;Akumina.AddIn.Logger.WriteInfoLog("ShowDashboardItems");newData={Items:[],DashboardWidgets:[]};selectedItems=[];data.Items.length>0&&data.Items[0].ItemList&&(selectedItems=data.Items[0].ItemList.split("\n"));var templateData={Items:[],DashboardWidgets:[]},widgetsManager=new Akumina.Digispace.Data.WidgetManager,items=Akumina.AddIn.Cache.Get(widgetsManager.GetDashboardWidgetsCacheKey());for(i=0;i<items.length;i++)templateData.DashboardWidgets.push({Title:items[i].title,WidgetId:items[i].widgetId,WidgetName:items[i].widgetName,IsSelected:selectedItems.indexOf(items[i].title)==-1?!1:!0});for(j=0;j<selectedItems.length;j++)for(i=0;i<items.length;i++)if(items[i].title.toLowerCase().trim()==selectedItems[j].toLowerCase().trim()){templateData.Items.push({Snippet:'<div id="'+items[i].widgetId+'" class="ak-widget"><\/div>'});break}for((selectedItems.length>0||data.Items.length>0)&&(templateData.ControlListId=data.Items[0].ID,templateData.ControlList=selectedItems.join(";")),maxLength=templateData.Items.length,firstSectionNumber=Math.floor(maxLength/2),i=0;i<templateData.Items.length;i++)startColumn=i==0||i==firstSectionNumber,endColumn=i==firstSectionNumber-1||i==templateData.Items.length-1,templateData.Items[i].StartColumn=startColumn,templateData.Items[i].EndColumn=endColumn;return templateData.HasItems=templateData.Items.length>0,templateData.HasWidgets=templateData.DashboardWidgets.length>0,templateData}function GetUserProperties(){var userProperties={Role:"Partner",Location:"Boston",PracticeArea:"Litigation",Departments:["admin","attorney","finance","hr"]},userLoginName=_spPageContextInfo.userLoginName.toLowerCase();switch(userLoginName){case"lawrence@akuminademo.onmicrosoft.com":userProperties={Role:"Partner",Location:"Boston",PracticeArea:"Real Estate",Departments:["attorney","finance","hr","admin"]};break;case"kristen@akuminademo.onmicrosoft.com":userProperties={Role:"Partner",Location:"New York",PracticeArea:"Litigation",Departments:["attorney","finance","hr","admin"]};break;case"theresa@akuminademo.onmicrosoft.com":userProperties={Role:"Secretary",Location:"New York",PracticeArea:"Healthcare",Departments:["admin","attorney","finance","hr"]}}return userProperties}function GetWeatherLocation(data){var utils=Akumina.AddIn.Utilities;return Akumina.AddIn.Logger.WriteInfoLog("GetWeatherLocation"),data.Location=data.Location,data.ShowHeader=!1,data.WebPartTitle="",data.WebPartIcon=utils.GetIcon("none"),data.ShowFooter=!1,data}function GetTrafficLocation(data){var utils=Akumina.AddIn.Utilities;return Akumina.AddIn.Logger.WriteInfoLog("GetTrafficLocation"),data.Location=data.Location,data.ShowHeader=!1,data.WebPartTitle="",data.WebPartIcon=utils.GetIcon("none"),data.ShowFooter=!1,data}function ShowNewsFromSubsites(data,def){me=this;Akumina.AddIn.Logger.WriteInfoLog("ShowNewsFromSubsites");var listRequest=data,sitelist=JSON.parse(listRequest.dataLoadProperties.replace(/'/g,'"')),allresults={};allresults.Items=[];GetNewsFromSite(listRequest,sitelist.sites,allresults,def)}function GetNewsFromSite(listRequest,sites,data,def){var siteName=sites[0],utils=Akumina.AddIn.Utilities,web,context=new SP.ClientContext(_spPageContextInfo.siteServerRelativeUrl+"/"+siteName);web=context.get_web();var list=web.get_lists().getByTitle(listRequest.listName),camlQuery=new SP.CamlQuery,query=listRequest.viewXml;utils.IsNullOrEmpty(query)&&(query='<View><Query><OrderBy><FieldRef Name="Created" Ascending="False"><\/FieldRef><\/OrderBy><\/Query><RowLimit>1<\/RowLimit><\/View>');camlQuery.set_viewXml(query);listRequest.listItems=list.getItems(camlQuery);utils.IsNullOrEmpty(listRequest.selectFields)?(listRequest.listFields=list.get_fields(),context.load(listRequest.listFields),context.load(listRequest.listItems)):context.load(listRequest.listItems,"Include("+listRequest.selectFields+")");context.executeQueryAsync(Function.createDelegate(me,function(){GetNewsFromSiteSucessHandler(listRequest,siteName,sites,data,def)}),Function.createDelegate(me,function(sender,args){console.log("Request failed. "+args.get_message()+"\n"+args.get_stackTrace());GetNewsFromSiteErrorHandler(listRequest,sites,data,def)}))}function GetNewsFromSiteSucessHandler(listRequest,siteName,sites,data,def){for(var listEnumerator=listRequest.listItems.getEnumerator(),item,listItem,result;listEnumerator.moveNext();){if(item={},listItem=listEnumerator.get_current(),typeof listRequest.listFields!="undefined")for(fields=listRequest.listFields.getEnumerator();fields.moveNext();)fieldName=fields.get_current().get_staticName(),Akumina.AddIn.Configuration.containsInExcludeField(fieldName)||(item[fieldName]=listItem.get_item(fieldName));else for(fields=listRequest.selectFields.split(","),i=0;i<fields.length;i++)fieldName=fields[i],Akumina.AddIn.Configuration.containsInExcludeField(fieldName)||(item[fieldName]=listItem.get_item(fieldName));item={Title:item.Title,Department:GetDepartmentForSite(siteName),Image:item.Image!=null?item.Image.get_url():"",Link:item.FriendlyUrl};data.FirstItem&&data.FirstItem!=null?(item.IsFirstItem=!1,data.Items.push(item)):(item.IsFirstItem=!0,data.FirstItem=item)}data.HasItems=data.Items.length>0||data.FirstItem?!0:!1;data.UserDepartment=Akumina.Digispace.UserContext.Department;sites.length==1?(result={response:data,request:this.listRequest},def.resolve(result)):GetNewsFromSite(listRequest,sites.slice(1,sites.length),data,def)}function GetNewsFromSiteErrorHandler(listRequest,sites,data,def){if(sites.length==1){var result={response:data,request:this.listRequest};def.resolve(result)}else GetNewsFromSite(listRequest,sites.slice(1,sites.length),data,def)}function GetDepartmentForSite(siteName){var ret=siteName,site,urltokens;for(site in Akumina.Digispace.ConfigurationContext.DepartmentSiteMap)urltokens=Akumina.Digispace.ConfigurationContext.DepartmentSiteMap[site].SiteName.split("/"),urltokens.length>0&&siteName.toLowerCase()==urltokens[urltokens.length-1].toLowerCase()&&(ret=Akumina.Digispace.ConfigurationContext.DepartmentSiteMap[site].Department);return ret}function renderDocumentListCallback(data){for(var dataItem,newItem,newData={},itemList=[],i=0;i<data.Items.length;i++)dataItem=data.Items[i],newItem={Title:dataItem.FileLeafRef,Url:dataItem.FileRef,Date:moment(dataItem.Last_x0020_Modified).format("MM.DD.YY"),Topics:dataItem.Topic!=null?dataItem.Topic.get_label():"No Topics"},itemList.push(newItem);return newData.WebSiteUrl=_spPageContextInfo.webAbsoluteUrl,newData.Items=itemList,newData}function initAnnouncementItems(){$(".ak-announcementitems-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),AnnouncementItems=new Akumina.AddIn.AnnouncementItemsWidget;AnnouncementItems.Init(props)})}function initContentblock(){$(".ak-contentblock-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),contentBlock=new Akumina.AddIn.ContentBlockWidget;contentBlock.Init(props)})}function initDMS(){var editMode=Akumina.AddIn.Utilities.getEditMode();$(".ak-documentsfoldertree-control").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),documentsFolderTreeRequest={};documentsFolderTreeRequest.SenderId=Akumina.AddIn.Utilities.getPropertyParameter(props,"id","");documentsFolderTreeRequest.DisplayTemplateUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"displaytemplateurl","");documentsFolderTreeRequest.DisplayTemplateUrl=documentsFolderTreeRequest.DisplayTemplateUrl==""?__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DocumentsFolderTree/templates.html":__getTemplatePrefix()+documentsFolderTreeRequest.DisplayTemplateUrl;documentsFolderTreeRequest.isSitePageHosted=Akumina.AddIn.Utilities.getPropertyParameter(props,"issitepagehosted","false");documentsFolderTreeRequest.startFolder=Akumina.AddIn.Utilities.getPropertyParameter(props,"documentlibrary","");documentsFolderTreeRequest.cssClass=".ia-folder-tree";documentsFolderTreeRequest.Hosted=!1;documentsFolderTreeRequest.DefaultDisplayTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DocumentsFolderTree/default.html";editMode||$.ajax(documentsFolderTreeRequest.DefaultDisplayTemplateUrl).done(function(template){$("#"+documentsFolderTreeRequest.SenderId).html(template);$.ajax(__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DocumentsFolderTree/templates.html").done(function(template){$(".documentsFolderTreeTemplates").html(template);var documentsFolderTree=new Akumina.AppPart.DMS.FolderTree;documentsFolderTree.settings=documentsFolderTreeRequest;documentsFolderTree.Init()})})});$(".ak-documentsgrid-control").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),documentsGridRequest={};documentsGridRequest.SenderId=Akumina.AddIn.Utilities.getPropertyParameter(props,"id","");documentsGridRequest.DisplayTemplateUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"displaytemplateurl","");documentsGridRequest.DisplayTemplateUrl=documentsGridRequest.DisplayTemplateUrl==""?__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DocumentsGrid/templates.html":__getTemplatePrefix()+documentsGridRequest.DisplayTemplateUrl;documentsGridRequest.isSitePageHosted=Akumina.AddIn.Utilities.getPropertyParameter(props,"issitepagehosted","false");documentsGridRequest.startFolder=Akumina.AddIn.Utilities.getPropertyParameter(props,"documentlibrary","");documentsGridRequest.pageSize=Akumina.AddIn.Utilities.getPropertyParameter(props,"pagesize","");documentsGridRequest.sortField="FileLeafRef";documentsGridRequest.sortAscending=!0;documentsGridRequest.tabSettings={};documentsGridRequest.tabSettings.cssClass=".ia-tabs";documentsGridRequest.tabSettings.selectedTab="allFiles";documentsGridRequest.tabSettings.numberOfRecentFiles=Akumina.AddIn.Utilities.getPropertyParameter(props,"recentfilescount","");documentsGridRequest.tabSettings.numberOfPopularFiles=Akumina.AddIn.Utilities.getPropertyParameter(props,"popularfilescount","");documentsGridRequest.dragDrop={};documentsGridRequest.dragDrop.id="#drop_zone";documentsGridRequest.dragDrop.cssClassHighlighted="ia-highlighted";documentsGridRequest.Hosted=!1;documentsGridRequest.DefaultDisplayTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DocumentsGrid/default.html";editMode||$.ajax(documentsGridRequest.DefaultDisplayTemplateUrl).done(function(template){$("#"+documentsGridRequest.SenderId).html(template);$.ajax(__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DocumentsGrid/templates.html").done(function(template){$(".documentsGridTemplates").html(template);var documentsGrid=new Akumina.AppPart.DMS.Grid;documentsGrid.settings=documentsGridRequest;documentsGrid.Init()})})});$(".ak-documentsrefinement-control").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),documentsRefinementRequest={};documentsRefinementRequest.SenderId=Akumina.AddIn.Utilities.getPropertyParameter(props,"id","");documentsRefinementRequest.DisplayTemplateUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"displaytemplateurl","");documentsRefinementRequest.DisplayTemplateUrl=documentsRefinementRequest.DisplayTemplateUrl==""?__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DocumentsRefinements/templates.html":__getTemplatePrefix()+documentsRefinementRequest.DisplayTemplateUrl;documentsRefinementRequest.isSitePageHosted=Akumina.AddIn.Utilities.getPropertyParameter(props,"issitepagehosted","false");documentsRefinementRequest.categoryName=Akumina.AddIn.Utilities.getPropertyParameter(props,"categories","");documentsRefinementRequest.Hosted=!1;documentsRefinementRequest.DefaultDisplayTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DocumentsRefinements/default.html";editMode||$.ajax(documentsRefinementRequest.DefaultDisplayTemplateUrl).done(function(template){$("#"+documentsRefinementRequest.SenderId).html(template);$.ajax(__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DocumentsRefinements/templates.html").done(function(template){$(".documentRefinementTemplates").html(template);var documentsRefinements=new Akumina.AppPart.DMS.Refinements;documentsRefinements.settings=documentsRefinementRequest;documentsRefinements.Init()})})})}function initGenericItem(){$(".ak-genericitem-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),control=new Akumina.AddIn.GenericItemWidget;control.Init(props)})}function initGenericList(controlId){$(".ak-genericlist-widget").each(function(){var displayControl=!0,props,control;controlId!=null&&(displayControl=controlId==$(this).attr("id"));displayControl&&(props=Akumina.AddIn.Utilities.getProperties($(this)),control=new Akumina.AddIn.GenericListControlWidget,control.Init(props))})}function initDashboardContainer(){$(".ak-dashboardcontainer-widget").each(function(){var props,wrapperControl;!0&&(props=Akumina.AddIn.Utilities.getProperties($(this)),wrapperControl=new Akumina.AddIn.DashboardContainerWidget,wrapperControl.Init(props))})}function RenderDashboardWidgets(){for(var prop,namespace,widget,k,widgetsManager=new Akumina.Digispace.Data.WidgetManager,items=Akumina.AddIn.Cache.Get(widgetsManager.GetDashboardWidgetsCacheKey()),i=0;i<items.length;i++){var widgetName=items[i].widgetName,widgetclass=items[i].widgetclass,widgetId=items[i].widgetId,widgetprops=JSON.parse(items[i].widgetprops),widgetRequest={};for(prop in widgetprops)widgetRequest[prop]=widgetprops[prop];for(widgetRequest.id=widgetId,namespace=widgetclass.split("."),widget=window,k=0;k<namespace.length;k++)widget=widget[namespace[k]];typeof widget=="function"&&(instance=new widget,instance.Init(widgetRequest),instance.Render())}}function initWeather(){$(".ak-weather-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),control=new Akumina.AddIn.WeatherWidget;control.Init(props)})}function initFinancialData(){$(".ak-financialdata-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),control=new Akumina.AddIn.FinancialDataWidget;control.Init(props)})}function initRssNews(){$(".ak-rssnews-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),control=new Akumina.AddIn.RssNewsWidget;control.Init(props)})}function initTraffic(){$(".ak-traffic-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),control=new Akumina.AddIn.TrafficWidget;control.Init(props)})}function initPageLayout(){$(".ak-pagelayout-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),pageLayout=new Akumina.AddIn.PageLayoutWidget;pageLayout.Init(props)})}function initQuickLinks(){$(".ak-quicklinks-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),QuickLinks=new Akumina.AddIn.QuickLinksWidget;QuickLinks.Init(props)})}function initDirectory(){$(".ak-directory-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),peopleDirectory=new Akumina.AddIn.PeopleDirectoryWidget;peopleDirectory.Init(props)})}function initCompanyCalendar(){$(".ak-companycalendar-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),Calendar=new Akumina.AddIn.CompanyCalendarWidget;Calendar.Init(props)})}function getCompanyCalendarStartDate(){var year=(new Date).getFullYear(),month=(new Date).getMonth()+1,yearValue=Akumina.AddIn.Utilities.getQueryStringParameter("y",""),monthValue=Akumina.AddIn.Utilities.getQueryStringParameter("m",""),hashValue=location.hash.replace("#",""),dateValue,dateValueParts;return hashValue.toLowerCase().indexOf("caldate=")==0&&(dateValue=hashValue.substring(8),dateValue!=""&&(dateValueParts=dateValue.split("-"),dateValueParts.length==2&&(yearValue=dateValueParts[0],monthValue=dateValueParts[1]))),yearValue&&yearValue!=""&&(year=parseInt(yearValue)),monthValue&&monthValue!=""&&(month=parseInt(monthValue)),new Date(year,month,1)}function initEventDetail(){$(".ak-eventdetail-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),EventDetail=new Akumina.AddIn.EventDetailWidget;EventDetail.Init(props)})}function initCalendar(){$(".ak-calendar-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),Calendar=new Akumina.AddIn.CalendarWidget;Calendar.Init(props)})}function getCalendarStartDate(){var year=(new Date).getFullYear(),month=(new Date).getMonth()+1,yearValue=Akumina.AddIn.Utilities.getQueryStringParameter("y",""),monthValue=Akumina.AddIn.Utilities.getQueryStringParameter("m",""),hashValue=location.hash.replace("#",""),dateValue,dateValueParts;return hashValue.toLowerCase().indexOf("caldate=")==0&&(dateValue=hashValue.substring(8),dateValue!=""&&(dateValueParts=dateValue.split("-"),dateValueParts.length==2&&(yearValue=dateValueParts[0],monthValue=dateValueParts[1]))),yearValue&&yearValue!=""&&(year=parseInt(yearValue)),monthValue&&monthValue!=""&&(month=parseInt(monthValue)),new Date(year,month-1,1)}function initBanner(){$(".ak-banner-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),Banner=new Akumina.AddIn.BannerWidget;Banner.Init(props)})}function getCategoryForCalendar(){return Akumina.AddIn.Utilities.getQueryStringParameter("c","")}function initImportantDates(){$(".ak-importantdates-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),ImportantDates=new Akumina.AddIn.ImportantDatesWidget;ImportantDates.Init(props)})}function initializeCKEditor(callback){window.CKEDITOR_BASEPATH=__getTemplatePrefix()+"/Style Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/content/editor/ck/";jQuery.ajax({type:"GET",url:__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/content/editor/ck/ckeditor.min.js",success:function(){jQuery.ajax({type:"GET",url:__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/content/editor/ck/adapters/jquery.js",success:function(){callback()},dataType:"script",cache:!0})},dataType:"script",cache:!0})}function initCreateDiscussion(){initializeCKEditor(function(){$(".ak-creatediscussion-control").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),createDiscussionRequest=new Akumina.AddIn.discussionRequest,createDiscussion;createDiscussionRequest.SenderId=Akumina.AddIn.Utilities.getPropertyParameter(props,"id","");createDiscussionRequest.DisplayTemplateUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"displaytemplateurl","");createDiscussionRequest.DisplayTemplateUrl==""&&(createDiscussionRequest.DisplayTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/CreateNewDiscussion/Default.html");createDiscussionRequest.Title=Akumina.AddIn.Utilities.getPropertyParameter(props,"title","");createDiscussionRequest.ListName=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionlistname","");createDiscussionRequest.DocumentListName=Akumina.AddIn.Utilities.getPropertyParameter(props,"documentlistname","");createDiscussionRequest.DiscussionListingUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionlistingurl","");createDiscussionRequest.DiscussionThreadUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionthreadurl","");createDiscussionRequest.DiscussionCreateUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussioncreateurl","");createDiscussionRequest.Hosted=!1;createDiscussion=new Akumina.AddIn.createDiscussionBlock(createDiscussionRequest);createDiscussion.renderdiscussion()})})}function initDiscussionBoardListing(){$(".ak-discussionboardlisting-control").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),discussionBoardRequest=new Akumina.AddIn.discussionRequest,discussionBoardListing;discussionBoardRequest.SenderId=Akumina.AddIn.Utilities.getPropertyParameter(props,"id","");discussionBoardRequest.DisplayTemplateUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"displaytemplateurl","");discussionBoardRequest.DisplayTemplateUrl==""&&(discussionBoardRequest.DisplayTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DiscussionBoard/Default.html");discussionBoardRequest.Title=Akumina.AddIn.Utilities.getPropertyParameter(props,"title","");discussionBoardRequest.ListName=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionlistname","");discussionBoardRequest.DocumentListName=Akumina.AddIn.Utilities.getPropertyParameter(props,"documentlistname","");discussionBoardRequest.DiscussionListingUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionlistingurl","");discussionBoardRequest.DiscussionThreadUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionthreadurl","");discussionBoardRequest.DiscussionCreateUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussioncreateurl","");discussionBoardRequest.DisplayAvatar=Akumina.AddIn.Utilities.getPropertyParameter(props,"displayavatar","");discussionBoardRequest.NumberPosts=Akumina.AddIn.Utilities.getPropertyParameter(props,"noofposts","5");discussionBoardRequest.PostType=Akumina.AddIn.Utilities.getPropertyParameter(props,"posttype","op");discussionBoardRequest.TitleCount=Akumina.AddIn.Utilities.getPropertyParameter(props,"titlecount","20");discussionBoardRequest.PreviewCount=Akumina.AddIn.Utilities.getPropertyParameter(props,"previewcount","100");discussionBoardRequest.Hosted=!1;discussionBoardListing=new Akumina.AddIn.discussionBoardListingBlock(discussionBoardRequest);discussionBoardListing.renderdiscussion()})}function initDiscussionSummary(){$(".ak-discussionsummary-control").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),discussionSummaryRequest=new Akumina.AddIn.discussionRequest,discussionSummary;discussionSummaryRequest.SenderId=Akumina.AddIn.Utilities.getPropertyParameter(props,"id","");discussionSummaryRequest.DisplayTemplateUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"displaytemplateurl","");discussionSummaryRequest.DisplayTemplateUrl==""&&(discussionSummaryRequest.DisplayTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DiscussionSummary/Default.html");discussionSummaryRequest.Title=Akumina.AddIn.Utilities.getPropertyParameter(props,"title","");discussionSummaryRequest.ListName=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionlistname","");discussionSummaryRequest.DocumentListName=Akumina.AddIn.Utilities.getPropertyParameter(props,"documentlistname","");discussionSummaryRequest.DiscussionListingUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionlistingurl","");discussionSummaryRequest.DiscussionThreadUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionthreadurl","");discussionSummaryRequest.DiscussionCreateUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussioncreateurl","");discussionSummaryRequest.DisplayAvatar=Akumina.AddIn.Utilities.getPropertyParameter(props,"displayavatar","");discussionSummaryRequest.NumberPosts=Akumina.AddIn.Utilities.getPropertyParameter(props,"noofposts","5");discussionSummaryRequest.PostType=Akumina.AddIn.Utilities.getPropertyParameter(props,"posttype","op");discussionSummaryRequest.TitleCount=Akumina.AddIn.Utilities.getPropertyParameter(props,"titlecount","20");discussionSummaryRequest.PreviewCount=Akumina.AddIn.Utilities.getPropertyParameter(props,"previewcount","100");discussionSummaryRequest.Icon=Akumina.AddIn.Utilities.getPropertyParameter(props,"icon",Akumina.AddIn.Icons.None.toString());discussionSummaryRequest.Hosted=!1;discussionSummary=new Akumina.AddIn.discussionSummaryBlock(discussionSummaryRequest);discussionSummary.renderdiscussion()})}function initDiscussionThread(){$(".ak-discussionthread-control").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),discussionThreadRequest=new Akumina.AddIn.discussionRequest,discussionThread;discussionThreadRequest.SenderId=Akumina.AddIn.Utilities.getPropertyParameter(props,"id","");discussionThreadRequest.DisplayTemplateUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"displaytemplateurl","");discussionThreadRequest.DisplayTemplateUrl==""&&(discussionThreadRequest.DisplayTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DiscussionBoardThread/Default.html");discussionThreadRequest.Title=Akumina.AddIn.Utilities.getPropertyParameter(props,"title","");discussionThreadRequest.ListName=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionlistname","");discussionThreadRequest.DocumentListName=Akumina.AddIn.Utilities.getPropertyParameter(props,"documentlistname","");discussionThreadRequest.DiscussionListingUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionlistingurl","");discussionThreadRequest.DiscussionThreadUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussionthreadurl","");discussionThreadRequest.DiscussionCreateUrl=Akumina.AddIn.Utilities.getPropertyParameter(props,"discussioncreateurl","");discussionThreadRequest.DisplayAvatar=Akumina.AddIn.Utilities.getPropertyParameter(props,"displayavatar","");discussionThreadRequest.Hosted=!1;discussionThread=new Akumina.AddIn.discussionThreadBlock(discussionThreadRequest);discussionThread.renderdiscussion()})}function initForm(){jQuery.ajax({type:"GET",url:__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/js/vendor/form-render.min.js",success:function(){var params={};window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(str,key,value){params[key.toLowerCase()]=value});$(".ak-form-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),instructionSet=Akumina.AddIn.Utilities.getPropertyParameter(props,"instructionset","");typeof params.formid!="undefined"&&(instructionSet=decodeURIComponent(params.formid));instructionSet="~."+instructionSet;props.instructionset=instructionSet;props.formtype="survey";props.displaynonmodal=!0;PrepareAKForm(props)})},dataType:"script",cache:!0})}function PrepareAKForm(props){var form=new Akumina.AddIn.FormWidget;form.Init(props);form.Render()}function ShowAKFormModal(instructionset,itemId){var props={};instructionset="~."+instructionset;props.instructionset=instructionset;props.formtype="survey";props.itemid=itemId;PrepareAKForm(props)}function initMyForms(){Akumina.AddIn.Logger.StartTraceLog("initMyForms");$(".ak-myforms-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),control=new Akumina.AddIn.MyFormsWidget;control.Init(props);control.Render()});Akumina.AddIn.Logger.StopTraceLog("initMyForms")}function initDocumentSummaryList(){Akumina.AddIn.Logger.StartTraceLog("initDocumentSummaryList");$(".ak-documentssummarylist-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),control=new Akumina.AddIn.DocumentsSummaryListWidget;control.Init(props)});Akumina.AddIn.Logger.StopTraceLog("initDocumentSummaryList")}function initPeopleListSearchWidget(){$(".ak-peoplelistsearch-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),peopleListSearchWidget=new Akumina.AddIn.PeopleListSearchWidget;peopleListSearchWidget.Init(props)})}function initPeopleListWidget(){$(".ak-peoplelist-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),peopleListWidget=new Akumina.AddIn.PeopleListWidget;peopleListWidget.Init(props)})}function initEmployeeDetail(){$(".ak-employeedetail-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),employeeDetailWidget=new Akumina.AddIn.EmployeeDetailWidget;employeeDetailWidget.Init(props)})}function initDocumentFilter(){$(".ak-documentfilter-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),documentFilterWidget=new Akumina.AddIn.DocumentFilterWidget;documentFilterWidget.Init(props)})}function initDocumentList(){$(".ak-documentlist-widget").each(function(){var props=Akumina.AddIn.Utilities.getProperties($(this)),documentListWidget=new Akumina.AddIn.DocumentListWidget;documentListWidget.Init(props)})}function GetSteps(){var steps=[];return steps.push({name:"Auto Clear Local Cache",callback:CoreSteps.AutoClearCache.Init}),steps.push({name:"Getting Additional Markup template",callback:CoreSteps.AdditionalMarkupStep.Init}),steps.push({name:"Display Loader",callback:CoreSteps.DisplayLoader.Init}),steps.push({name:"Fetching Digispace Configuration",callback:CoreSteps.FetchDigispaceConfiguration.Init}),steps.push({name:"Event Subscription",callback:CoreSteps.EventSubscription.Init}),steps.push({name:"Set Site Theme",callback:CoreSteps.SetTheme.Init}),steps.push({name:"Validating Interchange Query Key",callback:CoreSteps.ValidateInterchangeQueryKey.Init}),steps.push({name:"Get Loading Template",callback:CoreSteps.GetLoadingTemplate.Init}),steps.push({name:"Index Page Data",callback:CoreSteps.IndexPageData.Init}),window.location.href.toLowerCase().indexOf("logout")==-1&&(steps.push({name:"Getting Interchange LoginURL",callback:CoreSteps.SetInterchangeLoginURL.Init}),Akumina.AddIn.Utilities.getEditMode()||(steps.push({name:"Getting Graph Token",callback:CoreSteps.GetGraphTokenCallback.Init}),steps.push({name:"Fetching User Properties",callback:CoreSteps.FetchUserProperties.Init}),steps.push({name:"Load Widgets",callback:CoreSteps.LoadWidgets.Init}),steps.push({name:"Initialize Widgets",callback:CoreSteps.InitializeWidgets.Init}),steps.push({name:"Initialize Generic Controls",callback:CoreSteps.InitializeGenericControls.Init}),steps.push({name:"Load Dashboard Widgets",callback:CoreSteps.LoadDashboardWidgets.Init}),steps.push({name:"Display Sharepoint Bar",callback:CoreSteps.SharepointBar.Init}),steps.push({name:"Debug Info",callback:CoreSteps.DisplayDebugInformation.Init}),steps.push({name:"Init Tray",callback:CoreSteps.InitBottomTray.Init}))),window.self!==window.top?steps.push({name:"Resume Main Window Loader",callback:CoreSteps.ResumeMainWindowLoader.Init}):window.CallParentLoaderComplete=function(){Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")},typeof GetAdditionalLoaderSteps=="function"&&GetAdditionalLoaderSteps(),steps}function getCalendarEvents(){var def=new $.Deferred,authContext,isCallback,user;if(Akumina.Digispace.ConfigurationContext.EnableAzureAD){var token=localStorage["adal.idtoken"],startDate=moment(new Date).format("YYYY-MM-DD")+"T00:00:01",endDate=moment(new Date).format("YYYY-MM-DD")+"T23:59:59",query="/v1.0/me/calendarView?startDateTime="+startDate+"&endDateTime="+endDate+"&$top=20",subscriptionId=Akumina.Digispace.ConfigurationContext.GraphSubscriptionId,clientId=Akumina.Digispace.ConfigurationContext.GraphClientId;config={subscriptionId:subscriptionId,clientId:clientId,postLogoutRedirectUri:window.location.origin,endpoints:{graphApiUri:"https://graph.microsoft.com"},cacheLocation:"localStorage"};authContext=new AuthenticationContext(config);isCallback=authContext.isCallback(window.location.hash);authContext.handleWindowCallback();isCallback&&!authContext.getLoginError()&&(window.location=authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST));user=authContext.getCachedUser();user||authContext.login();authContext.acquireToken(config.endpoints.graphApiUri,function(error,token){if(error||!token){Akumina.AddIn.Logger.WriteErrorLog("ADAL error occurred: "+error);return}var filesUri=config.endpoints.graphApiUri+query;$.ajax({type:"GET",url:filesUri,headers:{Authorization:"Bearer "+token}}).done(function(response){var calendar,graphData,listItem,startTime,endTime,usermailLink,railItemModel;for(Akumina.AddIn.Logger.WriteInfoLog("Successfully fetched events from Graph."),calendar={events:[]},graphData=response.value,i=0;i<graphData.length;i++)listItem=graphData[i],moment(listItem.start.dateTime).format("DD")==moment().format("DD")&&(startTime="",endTime="",listItem.isAllDay?(startTime="12:00 AM",endTime="11:59 PM"):(startTime=moment(new Date(listItem.start.dateTime+"Z")).format("hh:mm A"),endTime=moment(new Date(listItem.end.dateTime+"Z")).format("hh:mm A")),calendar.events.push({sortTime:moment(listItem.start.dateTime).format("HHmmss"),startTime:startTime.toLowerCase(),endTime:endTime.toLowerCase(),subject:listItem.subject}));usermailLink=String.format("https://outlook.office.com/owa/?realm={0}&path=/calendar/view/Month",_spPageContextInfo.userLoginName);calendar.events=CalendarOrderDate(calendar.events);railItemModel={Header:"Today",events:calendar.events,HasItems:calendar.events.length>0?!0:!1,Footer:{Text:"My Calendar",Link:usermailLink}};def.resolve(railItemModel)}).error(function(xhr,ajaxOptions,thrownError){Akumina.AddIn.Logger.WriteErrorLog(xhr.status);Akumina.AddIn.Logger.WriteErrorLog(thrownError);def.reject("Calendar data not available.")})})}else def.reject("Your Azure AD is not configured");return def}function CalendarOrderDate(calendar){return calendar.sort(function(a,b){return a.sortTime-b.sortTime})}function tasksCallback(item){var def=$.Deferred(),title=$(item).find("span.ak-nav-title").text();return setTimeout(function(){var railItemModel={Header:title,RailItemContent:"Tasks content goes here...",Footer:"Footer"};def.resolve(railItemModel)},3e3),def}function SharepointBarCallback(item){var isSharepointBarShown=!1,args;$(item).find("i").hasClass("fa-toggle-on")&&(isSharepointBarShown=!0);args={ShowSharepointBar:!isSharepointBarShown,SetCookie:!0};Akumina.Digispace.AppPart.Eventing.Publish("/loader/handlesharepointbar/",args)}function onlineCallback(item){var def=$.Deferred(),title;return Akumina.Digispace.ConfigurationContext.EnableAzureAD?(title=$(item).find("span.ak-nav-title").text(),jQuery.ajax({type:"GET",url:"https://swx.cdn.skype.com/shared/v/1.2.15/SkypeBootstrap.min.js",success:function(){getLyncContacts().then(function(contacts){var railItemModel={Header:contacts.Header,RailItemContent:contacts.content,Footer:contacts.Footer};def.resolve(railItemModel)})},dataType:"script",cache:!0})):def.reject("Your Azure AD is not configured"),def}function getStatusLync(status){switch(status.toLowerCase()){case"berightback":case"away":status="away";break;case"Online":status="available";break;case"offline":case"unknown":status="unavailable";break;case"donotdisturb":case"busy":status="busy";break;default:status="available"}return status}function getLyncContacts(){var def=$.Deferred(),rootsiteUrl,loadimgUrl,contacts;return $(".ak-user-nav-flyout.ak-active").html(""),rootsiteUrl=window.location.protocol+"//"+window.location.host+__getTemplatePrefix(),loadimgUrl=rootsiteUrl+"/Style Library/DigitalWorkPlace/Images/ia-loader-sm.gif",$(".ak-user-nav-flyout.ak-active").append(String.format("<img id='loading' src='{0}' class='ia-loading-gif' />",loadimgUrl.replace("#",""))),contacts={},contacts.Header=null,contacts.Footer=null,contacts.content="",/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(contacts.content="<p> This feature is not available on tablet and mobile.<\/p>",$("#loading").hide(),def.resolve(contacts)),subP=[],InitializeLync().then(function(){var totalitems;clientLync.personsAndGroupsManager.all.persons.subscribe();var htmlCached=Akumina.AddIn.Cache.Get("lyncContacts"),isCached=!1,htmlArray={};typeof htmlCached!="undefined"&&htmlCached!=null&&(contacts.content=htmlCached,isCached=!0);totalitems=0;clientLync.personsAndGroupsManager.all.persons.added(function(contact){contact.id.get().then(function(id){var sip=id,email,htmlContact,cStatus,onPresenceChanged;id=id.replace("sip:","");email=id;id=id.replace("@","_");isCached||(htmlContact=String.format('<div class="ak-online-item" id="{0}"><a href="{1}"><div class="ak-online-image"><img  src="skype_avatar_" style="cursor:pointer"><span id="skypestatusid_{0}" class="ak-online-status ak-skype_status"><\/span><\/div><div class="ak-online-name">skype_name_<\/div><\/a><\/div>',id,sip),htmlArray[id]=htmlContact);cStatus=$('[id="skypestatusid_'+id+'"]');contact.displayName.get().then(function(displayName){htmlArray[id]=htmlArray[id].replace("skype_name_",displayName)});onPresenceChanged=function(status){status=getStatusLync(status);$(cStatus.selector).attr("class","ak-online-status ak-"+status)};contact.status.changed(onPresenceChanged);contact.avatarUrl.get().then(function(){htmlArray[id]=htmlArray[id].replace("skype_avatar_",setDefaultAvatar(email))});contact.status.get().then(function(status){status=getStatusLync(status);htmlArray[id]=htmlArray[id].replace("skype_status",status);totalitems++;contacts.content+=htmlArray[id];totalitems==clientLync.personsAndGroupsManager.all.persons().length&&($("#headerLync").hide(),!isCached,$("#loading").hide(),def.resolve(contacts))});subP.push(contact.status.subscribe())})},function(){var elementCall=$(".ak-user-nav-flyout.ak-active").attr("id");setTimeout(function(){$(".ak-user-nav-flyout.ak-active .ak-online-item").length==0&&elementCall==$(".ak-user-nav-flyout.ak-active").attr("id")&&($(".ak-user-nav-flyout.ak-active").html(""),$(".ak-user-nav-flyout.ak-active").append(String.format("<p>{0}<\/p>","Setup Required - Add users to your local Skype for Business")))},4e3)})}),def}function setDefaultAvatar(email){return String.format(window.location.origin+"/_layouts/15/userphoto.aspx?size=s&accountname={0}",email)}function dashboardCallback(){window.location=__getTemplatePrefix()+"/Pages/Dashboard.aspx"}function getActivities(){var def=new $.Deferred,activities={activities:[]},appWebUrl;return Akumina.Digispace.ConfigurationContext.EnableAzureAD?(appWebUrl=window.location.protocol+"//"+window.location.host,appWebUrl+=String.format("/_api/search/query?Querytext='*'&Properties='GraphQuery:OR(ACTOR({0}\\, action\\:1003)\\, ACTOR({0}\\, action\\:1001))'&RowLimit=10&sortlist='LastModifiedTime:descending'&SelectProperties='listitemid,listid,SitePath,FileExtension,Path,Title,Author,SPWebUrl,Edges'",Akumina.Digispace.UserContext.GraphUserId),$.ajax({url:appWebUrl,method:"GET",headers:{Accept:"application/json; odata=verbose"},success:function(d){var sortActionFnc=function(action){return action.sort(function(a,b){return b.Time-a.Time})},railItemModel;d.d.query.PrimaryQueryResult!=null&&d.d.query.PrimaryQueryResult.RelevantResults!=null&&d.d.query.PrimaryQueryResult.RelevantResults.Table!=null&&d.d.query.PrimaryQueryResult.RelevantResults.Table.Rows!=null&&d.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results!=null&&d.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results.length>0?($(d.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results).each(function(i,row){var activityResult=parseObjectResults(row),type="",sortAction,i,obj;switch(activityResult.ext){case"doc":case"docx":type="word";break;case"xls":case"xlst":case"xlsx":type="excel";break;case"ppt":case"pptx":type="powerpoint";break;case"pdf":type="pdf";break;case"img":case"png":case"img":case"gif":type="image";break;case"zip":type="zip";break;case"mpeg":case"mp4":case"avi":type="movie";break;case"mp3":case"wav":type="sound";break;case"aspx":case"html":case"ini":case"config":case"one":type="code";break;default:type=activityResult.ext}for(sortAction=[],i=0;i<activityResult.Edges.length;i++)obj={},obj.Action=activityResult.Edges[i].Properties.Action,obj.Time=moment(activityResult.Edges[i].Properties.Time).format("YYYYMMDDhhmmss"),obj.Timestamp=moment(activityResult.Edges[i].Properties.Time).format("MM/DD/YYYY"),sortAction.push(obj);var sortResult=sortActionFnc(sortAction),action=sortResult[0].Action=="1003"?"modified":"viewed",timestamp=sortResult[0].Timestamp,time=sortResult[0].Time,activity={action:action,title:activityResult.title,Time:time,timestamp:timestamp,category:"document",type:type,activitylink:activityResult.path,id:activityResult.id,listid:activityResult.listid,author:activityResult.author,SPWebUrl:activityResult.SPWebUrl};activities.activities.push(activity)}),activities.activities=sortActionFnc(activities.activities),railItemModel={Header:"My Activity",activities:activities.activities,HasItems:activities.activities.length>0?!0:!1,Footer:{Text:"All Activity",Link:window.location.protocol+"//"+window.location.host+"/_layouts/15/sharepoint.aspx"}},def.resolve(railItemModel)):(activities.HasItems=!1,def.resolve(activities))},error:function(){Akumina.AddIn.Logger.WriteErrorLog("Fail fetching activities");def.reject("Error fetching activities")}})):def.reject("Your Azure AD is not configured"),def}function documentshowPreview(me){var activityDocument=new Akumina.AppPart.DMS.Grid,obj=$(me).parent(),siteUrl=obj.attr("ia:SPWebUrl"),docTitle=obj.attr("ia:title");activityDocument.GetSiteUrl=function(){return siteUrl};activityDocument.previewFileFollow=function(itemId,docName,listId){docName=docTitle;var siteUrl=this.GetSiteUrl();listId!=null&&itemId!=null&&docName!=null&&listId!=undefined&&itemId!=undefined&&docName!=undefined&&SP.SOD.executeFunc("followingcommon.js","FollowDocumentFromEmail",function(){var dialog=function(a,c,b){SP.SOD.executeFunc("SP.UI.MySiteCommon.js","SP.UI.MySiteCommon.MySiteDialog",function(){var e=String.format(Strings.STS.L_DialogFollowAction_Title,a),f=c,d=new SP.UI.MySiteCommon.MySiteDialog(e,f);d.set_okButtonText(Strings.STS.L_DialogFollowButton_Text);d.set_okButtonCallback(b);d.show()})};dialog(docName,Strings.STS.L_DialogFollowSiteAction_Content,function(){var url=siteUrl+"?listId="+listId+"&itemId="+itemId;window.SetFollowStatus(url,!0,!0);$(".document-preview-1").magnificPopup("close")})})};activityDocument.OnDocumentPreview=function(obj){var model;Akumina.AppPart.DMS.Logger.Write("Grid.OnDocumentPreview");var docId=obj.attr("ia:id"),docTitle=obj.attr("ia:title"),docAuthor=obj.attr("ia:modifiedby"),IframedocURL=activityDocument.getFileUrl(obj),docURL=obj.attr("path"),listId=obj.attr("ia:listid")?obj.attr("ia:listid"):obj.parent().parent().parent().find(".itemhiddenListId").justtext(),profileurl=obj.parent().parent().parent().find(".ia-doc-list-modifiedBy a").attr("href"),modified=obj.parent().parent().parent().find(".ia-doc-list-modified").justtext(),showPreview=!1;!0&&(showPreview=!0);model={docId:docId,docTitle:docTitle,showPreview:showPreview,IframedocURL:IframedocURL,docURL:docURL,previewHeight:600,docAuthor:docAuthor,listId:listId,profileurl:profileurl,modified:modified};(new Akumina.AppPart.DMS.Data).Templates.FindAndRenderHandleBarGeneric("#template-activityDocumentPreviewTemplate",null,"#document-activityPreview-1",model);$.magnificPopup.open({items:{src:".ia-modal-action-preview ",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0});activityDocument.RegisterClickPreviewEventsForMenuItems(".ia-preview-details .ia-button-group li");$(".ia-preview-details").find(".ia-doc-shared a").click(function(){activityDocument.previewFileShareWith(docId,listId)});$(".ia-button").bind("click",function(){$(".document-preview-1").magnificPopup("close")})};activityDocument.PreviewfileShare=function(itemId,listId){var baseUrl=activityDocument.GetSiteUrl(),options={url:baseUrl+"/_layouts/15/aclinv.aspx?forSharing=1&List="+listId+"&obj={"+listId+"},"+itemId+",DOCUMENT&IsDlg=1",title:"Share File",allowMaximize:!1,width:800,height:600,showClose:!0,dialogReturnValueCallback:function(res){var passedArgs=this.get_args();res===SP.UI.DialogResult.OK?setTimeout(function(){activityDocument.OnDocumentPreview(obj)},1500):res===SP.UI.DialogResult.cancel&&activityDocument.OnDocumentPreview(obj)}};SP.SOD.execute("sp.ui.dialog.js","SP.UI.ModalDialog.showModalDialog",options);$.magnificPopup.close()};activityDocument.OnDocumentPreview(obj)}function roundtableCallback(item){var def=$.Deferred(),title=$(item).find("span.ak-nav-title").text(),railItemModel={Header:title,RailItemContent:"Round table coming soon...",Footer:"Footer"};return def.resolve(railItemModel),def}function myappsCallback(item){var def=$.Deferred(),title=$(item).find("span.ak-nav-title").text(),id=$(item).data("id"),selector="#ak-user-nav-flyout-"+id,interchangeUrl=Akumina.Digispace.ConfigurationContext.InterchangeURL,ua=window.navigator.userAgent,msie=ua.indexOf(" Trident/")>-1,siteId=Akumina.AddIn.Cache.Get("akumina:apps:siteid:"+_spPageContextInfo.siteAbsoluteUrl);if(siteId==null){var ctx=new SP.ClientContext.get_current,site=ctx.get_site(),web=ctx.get_web();siteId=web.get_id().toString()}var interchangeLogin=Akumina.AddIn.Cache.Get("akumina:apps:interchangelogin:"+_spPageContextInfo.siteAbsoluteUrl),ieoptions="forie?siteId="+siteId+"&interchangeQueryKey="+Akumina.Digispace.ConfigurationContext.InterchangeQueryKey,myappsurl=interchangeUrl+"/api/connector/myapps"+(msie?ieoptions:"");return $.ajax({type:"GET",url:myappsurl,xhrFields:{withCredentials:!0}}).done(function(response){var groups=Akumina.Digispace.UserContext.userSharePointGroups,allApps=response.data.results,appsData=msie?GetUserAccessibleApps(groups,allApps):allApps,appsForSite=response.data.appsForSite,appsModel={},tab,j,items,i;if(appsModel.Tabs=[],appsModel.Tabs.push({Name:"Content Apps",Items:[]}),appsModel.Tabs.push({Name:"Management Apps",Items:[]}),appsModel.Tabs.push({Name:"Control Apps",Items:[]}),appsModel.Tabs.push({Name:"Reporting Apps",Items:[]}),appsData)for(i=0;i<appsData.length;i++){for(tab=undefined,j=0;j<appsModel.Tabs.length;j++)if(appsModel.Tabs[j].Name.toLowerCase()==appsData[i].AppGroup.toLowerCase()){tab=appsModel.Tabs[j];break}tab.Items.push({Title:appsData[i].Title,Image:appsData[i].Image,Link:appsData[i].Link})}if(items={Header:title,Footer:{Text:"App Manager",Link:Akumina.Digispace.ConfigurationContext.InterchangeLoginURL},Tabs:appsModel.Tabs,HasItems:response.data.results.length>0?!0:!1,IsLoggedIn:response.data.isloggedin&&!msie||msie&&interchangeLogin!=null,AppManagerURL:Akumina.Digispace.ConfigurationContext.InterchangeLoginURL,InstanceIdFound:Akumina.Digispace.ConfigurationContext.InterchangeLoginURL.toLowerCase().indexOf("not found")==-1?!0:!1},items.IsLoggedIn)if(appsModel.Sites=Akumina.AddIn.Cache.Get(GetMyAppsCacheKey("sites")),appsModel.Sites==null){appsModel.Sites=[];var context=new SP.ClientContext,web=context.get_web(),site=context.get_site(),rootWeb=site.get_rootWeb(),subWebs=rootWeb.getSubwebsForCurrentUser(null);context.load(rootWeb);context.load(subWebs);Akumina.AddIn.Logger.logSPCall("myappsCallback");context.executeQueryAsync(function(){var webUrl,i;for(appsModel.Sites.push({SiteName:rootWeb.get_serverRelativeUrl().replace("/sites/",""),SiteId:rootWeb.get_id().toString(),Selected:appsForSite?appsForSite.toLowerCase()==rootWeb.get_id().toString().toLowerCase()?"selected":"":rootWeb.get_url().toLowerCase()==_spPageContextInfo.webAbsoluteUrl.toLowerCase()?"selected":""}),webUrl=_spPageContextInfo.webServerRelativeUrl.toLowerCase().replace("/sites/",""),i=0;i<subWebs.get_count();i++){var subWeb=subWebs.itemAt(i),subwebUrl=subWeb.get_serverRelativeUrl().toLowerCase().replace("/sites/",""),subWebTemplate=subWeb.get_webTemplate().toLowerCase();subWebTemplate.indexOf("cmspublishing")!=-1&&appsModel.Sites.push({SiteName:subWeb.get_serverRelativeUrl().replace("/sites/",""),SiteId:subWeb.get_id().toString(),Selected:appsForSite?appsForSite.toLowerCase()==subWeb.get_id().toString().toLowerCase()?"selected":"":subwebUrl==webUrl?"selected":""})}Akumina.AddIn.Cache.Set(GetMyAppsCacheKey("sites"),appsModel.Sites,Akumina.Digispace.ConfigurationContext.CachingStrategyInterval);items.Sites=appsModel.Sites;items.HasItems&&$(selector).addClass("ak-user-nav-apps");def.resolve(items)},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message());var errorMsg="Error communicating with "+interchangeUrl;Akumina.AddIn.Logger.WriteErrorLog(errorMsg);def.reject(errorMsg)})}else{for(i=0;i<appsModel.Sites.length;i++)appsModel.Sites[i].Selected=appsModel.Sites[i].SiteId.toLowerCase()==appsForSite?"selected":"";items.Sites=appsModel.Sites;items.HasItems&&$(selector).addClass("ak-user-nav-apps");def.resolve(items)}else def.resolve(items)}).error(function(xhr,ajaxOptions,thrownError){Akumina.AddIn.Logger.WriteErrorLog(xhr.status);Akumina.AddIn.Logger.WriteErrorLog(thrownError);Akumina.AddIn.Logger.WriteErrorLog("Error communicating with "+interchangeUrl);def.reject("Error fetching Apps from "+interchangeUrl)}),def}function GetMyAppsCacheKey(attribute){var prefix="akumina:digispace:myapps:"+_spPageContextInfo.userLoginName+":";return attribute!=null&&(prefix+=attribute),prefix}function RefreshApps(item){var id=$(item).data("id"),selector="#ak-user-nav-flyout-"+id,defaultFlyout=$(item).data("flyout");defaultFlyout&&defaultFlyout==!0&&($(selector).html("<div>Loading...<\/div>"),$(selector).addClass("ak-active"));(new Akumina.Digispace.AppPart.Rail).GetItemContents(item)}function GetSharepointBarElement(){return $("span.ak-nav-title").filter(function(){return $(this).text()==="SHAREPOINT BAR"}).parent()}function UpdateDashboardControls(){var itemIdVal=$("#ak-dashboard-controllist-id").val(),i,control,controlId,controlList;itemIdVal==""&&(itemIdVal=0);var itemId=parseInt(itemIdVal),selectedControls=[],controlItems=$(".ak-dashboard-check-list .ak-dashboard-check-item input");for(i=0;i<controlItems.length;i++)control=controlItems[i],controlId=$(control).attr("id"),$(control).prop("checked")&&selectedControls.push(controlId);controlList=selectedControls.join("\n");itemId>0?UpdateDashboardControlsItem(itemId,controlList):AddDashboardControlsItem(controlList)}function AddDashboardControlsItem(controlList){var clientContext=new SP.ClientContext,oList=clientContext.get_web().get_lists().getByTitle("MyDashBoard_AK"),itemCreateInfo=new SP.ListItemCreationInformation,assignedToVal;this.oListItem=oList.addItem(itemCreateInfo);oListItem.set_item("ItemList",controlList);assignedToVal=new SP.FieldUserValue;assignedToVal.set_lookupId(_spPageContextInfo.userId);oListItem.set_item("DashboardUser",assignedToVal);oListItem.update();Akumina.AddIn.Logger.logSPCall("AddDashboardControlsItem");clientContext.executeQueryAsync(Function.createDelegate(this,this.onUpdateDashboardControlsSucceeded),Function.createDelegate(this,this.onUpdateDashboardControlsFailed))}function UpdateDashboardControlsItem(itemId,controlList){var clientContext=new SP.ClientContext,oList=clientContext.get_web().get_lists().getByTitle("MyDashBoard_AK");this.oListItem=oList.getItemById(itemId);oListItem.set_item("ItemList",controlList);oListItem.update();Akumina.AddIn.Logger.logSPCall("UpdateDashboardControlsItem");clientContext.executeQueryAsync(Function.createDelegate(this,this.onUpdateDashboardControlsSucceeded),Function.createDelegate(this,this.onUpdateDashboardControlsFailed))}function onUpdateDashboardControlsSucceeded(){var dashboardId=$("#ak-dashboard-controllist").parents().closest(".ak-dashboardcontainer-widget").attr("id"),key;ShowCustomizedPopupSuccessMessage();key=Akumina.Digispace.ConfigurationContext.getCacheKey(dashboardId);Akumina.AddIn.Cache.Remove(key);Akumina.Digispace.AppPart.Eventing.Publish("/dashboardcontainer/render/")}function ShowCustomizedPopupSuccessMessage(){$("#successMessage").show();setTimeout(function(){$("#successMessage").fadeOut();$.magnificPopup.close();$(".ak-customize-modal .ak-modal-save").attr("disabled",!1)},1500)}function ShowCustomizedPopupErrorMessage(){$("#errorMessage").show();setTimeout(function(){$("#errorMessage").fadeOut();$.magnificPopup.close();$(".ak-customize-modal .ak-modal-save").attr("disabled",!1)},1500)}function onUpdateDashboardControlsFailed(sender,args){ShowCustomizedPopupErrorMessage();console.error("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())}function PerformChangeSite(selectedSiteId){var def=$.Deferred(),interchangeUrl=Akumina.Digispace.ConfigurationContext.InterchangeURL;return $.ajax({type:"GET",url:interchangeUrl+"/api/connector/changesite?siteId="+selectedSiteId,xhrFields:{withCredentials:!0}}).done(function(){Akumina.AddIn.Cache.Set("akumina:apps:siteid:"+_spPageContextInfo.siteAbsoluteUrl,selectedSiteId,Akumina.AddIn.Constants.HOUR_CACHE_EXPIRATION);def.resolve()}).error(function(xhr,ajaxOptions,thrownError){Akumina.AddIn.Logger.WriteErrorLog(xhr.status);Akumina.AddIn.Logger.WriteErrorLog(thrownError);var errorMsg="Error communicating with "+interchangeUrl;Akumina.AddIn.Logger.WriteErrorLog(errorMsg);def.reject({sender:"PerformChangeSite",message:errorMsg})}),def}function GetFieldValueForSearchKey(searchKey,listItem){var currentValue=null,i;if(currentValue=listItem[searchKey[0]],currentValue!=null&&searchKey.length>1)for(i=1;i<searchKey.length;i++)currentValue[searchKey[i]]!=null&&(currentValue=currentValue[searchKey[i]]);return currentValue}function convertRowsToObjects(itemRows){for(var row,item,j,author,Editor,items=[],i=0;i<itemRows.length;i++){for(row=itemRows[i],item={},j=0;j<row.Cells.results.length;j++)row.Cells.results[j].Key==="ModifiedBy"?(author=row.Cells.results[j].Value,Editor=author.indexOf("\n")>-1?author.substr(author.lastIndexOf("\n")+1,author.length):author,item[row.Cells.results[j].Key]=Editor):item[row.Cells.results[j].Key]=row.Cells.results[j].Value;items.push(item)}return items}function GetMetaDataTreeView(){$(".ia-treeview ul li span").click(function(){$(".ia-treeview ul").find("span").removeClass("ia-selected");$(this).addClass("ia-selected");var selectedLabel=$(this).text();$(".ia-selected-label").html(selectedLabel)});$(".ia-treeview").each(function(){var currentSelected=$(this).next(".ia-current-selected").children(".ia-current-selected-list"),hiddenSelected=$(this).next(".ia-current-selected").children(".selectedTaxonomy"),treeview=$(this);$(this).find("input[type=checkbox]").on("change",function(){$(currentSelected).html("");$(hiddenSelected).html("");var arrTemp=[],arrTempVal=[];$(treeview).find("input[type=checkbox]:checked").each(function(ind,val){arrTemp.push(" <span>"+$(val).next().html()+"<\/span>");arrTempVal.push($(val).val())});$(currentSelected).append(arrTemp.join());$(hiddenSelected).val(arrTempVal.join())})})}function Jquery_Multiple_category(){$(".ia-filter-name-list a").click(function(e){$(this).fadeOut(300,function(){$(this).remove()});e.preventDefault()});$(".ia-document-filters .ia-accordion-header").each(function(){$(this).children("span.ia-accordion-icon").hasClass("ia-open")?$(this).next(".ia-accordion-body").show():$(this).children("span.ia-accordion-icon").hasClass("ia-open")||$(this).next(".ia-accordion-body").hide();$(this).click(function(){$(this).children(".ia-accordion-icon").toggleClass("ia-open");$(this).next(".ia-accordion-body").slideToggle()})});$(".ia-filter-subcategory-header").each(function(){$(this).children("span.ia-accordion-icon").hasClass("ia-open")?$(this).next(".ia-filter-subcategory-body").show():$(this).children("span.ia-accordion-icon").hasClass("ia-open")||$(this).next(".ia-filter-subcategory-body").hide();$(this).click(function(){$(this).children(".ia-accordion-icon").toggleClass("ia-open");$(this).next(".ia-filter-subcategory-body").slideToggle()})});$(".ia-filter-subcategory-checkboxes li").each(function(){$(this).children("ul").length>0&&$(this).children("ul").hide();var ele=$(this).children(".ia-filter-subcategory-expand");$(ele).click(function(){$(this).siblings("ul").toggle()})});$(".ia-filter-subcategory-checkboxes").each(function(){var checkboxWrap=$(this),numitems;$(checkboxWrap).children("li").slice(5).hide();numitems=$(checkboxWrap).children("li").length;numitems>5&&($(checkboxWrap).append('<span class="ia-filter-subcategory-more">+ more<\/span>'),$(checkboxWrap).children(".ia-filter-subcategory-more").click(function(){$(checkboxWrap).children("li:gt(4)").toggle();$(this).toggleClass("ia-open");$(this).hasClass("ia-open")?$(this).html("- less"):$(this).html("+ more")}))})}function GetMoreOptionForCategory(ele){var checkboxWrap=ele,numitems;$(checkboxWrap).children("li").slice(4).hide();numitems=$(checkboxWrap).children("li").length;numitems>4&&($(checkboxWrap).append('<span class="ia-filter-subcategory-more">+ more<\/span>'),$(checkboxWrap).children(".ia-filter-subcategory-more").click(function(){$(checkboxWrap).children("li:gt(3)").toggle();$(this).toggleClass("ia-open");$(this).hasClass("ia-open")?$(this).html("- less"):$(this).html("+ more")}))}function callPreview(){$(".interAction .ia-modal-inline-trigger-upload").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0});$(".interAction .ia-modal-inline-trigger-taxonomy-grid").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0});$(".interAction .ia-modal-inline-trigger-taxonomy").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0});$(".interAction .ia-modal-inline-trigger").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0,fixedBgPos:!0});$(".interAction .ia-modal-inline-trigger-preview").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!1,showCloseBtn:!0,fixedBgPos:!0});$(document).on("click",".interAction .ia-modal-dismiss",function(e){e.preventDefault();$.magnificPopup.close()})}function addSelectedFile(event){if(event.preventDefault(),$(selectedNode).length>0){var url=$(selectedNode).parent("li").attr("url-data"),title=$(selectedNode).parent("li").attr("title"),listname=$(selectedNode).parent("li").attr("list-name"),itemid=$(selectedNode).parent("li").attr("item-id"),template=$("#"+filesAdd_MustempId).html(),frameJSON='{ "Name":"'+title+'" , "Url":"'+url+'" , "ListName":"'+listname+'" , "ItemId":"'+itemid+'" }',tempJson=JSON.parse(frameJSON),output=Mustache.render(template,tempJson),Names=listname+":"+itemid;$("."+addFileDivId).find('a[href="'+url+'"]').length==0&&(document.getElementsByClassName(addFileDivId)[0].innerHTML+=output,$("."+filesAdd_Hidden).val($("."+filesAdd_Hidden).val()+Names+"|"));$.magnificPopup.close();$("input[name='ia-discussion-add-reply-box']").length>0&&$("input[name='ia-discussion-add-reply-box']").trigger("focus");!$(".ia-folder-tree").hasClass("jstree")}else alert("Please select the file");$(".ia-folder-tree").jstree("close_all")}function cancelSelectedFile(){$(".ia-folder-tree").jstree("close_all")}function btnPermissions_CallServerClick(event){event.preventDefault();$.magnificPopup.close();$(".hdnbtnPermissions").trigger("click")}function fileRemove(element){$(element).parent().remove();var listname=$(element).parent("span").attr("list-name"),itemid=$(element).parent("span").attr("item-id"),Names=listname+":"+itemid+"|",content=$("."+filesAdd_Hidden).val(),replacedContent=content.replace(Names,"");$("."+filesAdd_Hidden).val(replacedContent)}function postValidation(event){$(".ia-discussion-create-title").val()==""?(event.preventDefault(),$("#titleMandatory").show()):showloader()}function EndRequestDiscussionThread(){hideloader();$(".ia-discussion-reply-content").on("focus","input[name='ia-discussion-add-reply-box']",function(){$(this).fadeOut("fast",function(){$(".ia-discussion-reply-editor").fadeIn("fast")})});DisplayEditor();$(".ia-search-picker").chosen({width:"100%",no_results_text:"No results match"});$(".interAction .ia-modal-inline-trigger").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0});$(".interAction .ia-modal-inline-trigger-preview").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!1,showCloseBtn:!0});$(document).on("click",".interAction .ia-modal-dismiss",function(e){e.preventDefault();$.magnificPopup.close()})}function DisplayEditor(){$(".ia-discussion-reply-editor .ia-button-row").on("click","a.anchrPostreply",function(){$(".ia-discussion-reply-editor").hide();$(".ia-discussion-reply-content input[name='ia-discussion-add-reply-box']").show()});$(".ia-action-menu-content").on("click",addReplyPostId,function(e){e.preventDefault();$("input[name='ia-discussion-add-reply-box']").trigger("focus")})}function DeleteReplyFunction(id){$("#hdnDeleteReplyId").val(id)}function hideloader(){$(".ia-loading-panel")&&$(".ia-loading-panel").addClass("ia-hide");$(".ia-loading-panel").removeClass("ia-show")}function showloader(){$.magnificPopup.close();$(".ia-loading-panel")&&$(".ia-loading-panel").addClass("ia-show");$(".ia-loading-panel").removeClass("ia-hide")}function archiveFunction(id){$("#hdnArchieveId").val(id)}function deleteFunction(id){$("#hdnDeleteId").val(id)}function commonDiscussionThreadListing(){typeof Sys.Browser.WebKit=="undefined"&&(Sys.Browser.WebKit={});navigator.userAgent.indexOf("WebKit/")>-1&&(Sys.Browser.agent=Sys.Browser.WebKit,Sys.Browser.version=parseFloat(navigator.userAgent.match(/WebKit\/(\d+(\.\d+)?)/)[1]),Sys.Browser.name="WebKit");$("#hdnCurrentPage").attr("value")=="first"?($("#iafirstpage").removeAttr("class").attr("class","ia-paging-first ia-paging-disabled"),$("#iapreviouspage").removeAttr("class").attr("class","ia-paging-previous ia-paging-disabled")):$("#hdnCurrentPage").attr("value")=="last"?($("#ianextpage").removeAttr("class").attr("class","ia-paging-next ia-paging-disabled"),$("#ialastpage").removeAttr("class").attr("class","ia-paging-last ia-paging-disabled")):$("#hdnCurrentPage").attr("value")=="inbetween"&&($("#iafirstpage").removeAttr("class").attr("class","ia-paging-first"),$("#iapreviouspage").removeAttr("class").attr("class","ia-paging-previous"),$("#ianextpage").removeAttr("class").attr("class","ia-paging-next"),$("#ialastpage").removeAttr("class").attr("class","ia-paging-last"));$("#hdnSortBy").attr("value")=="Created"?($("#hdnSortDirection").attr("value")=="ASC"?$("[id$=linkSortCreated]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-desc ia-sort-desc"):$("[id$=linkSortCreated]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-asc ia-sort-asc"),$("[id$=linkSortPostTime]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off"),$("[id$=linkSortReplies]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off")):$("#hdnSortBy").attr("value")=="DiscussionLastUpdated"?($("#hdnSortDirection").attr("value")=="ASC"?$("[id$=linkSortPostTime]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-desc ia-sort-desc"):$("[id$=linkSortPostTime]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-asc ia-sort-asc"),$("[id$=linkSortCreated]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off"),$("[id$=linkSortReplies]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off")):$("#hdnSortBy").attr("value")=="ItemChildCount"&&($("#hdnSortDirection").attr("value")=="ASC"?$("[id$=linkSortReplies]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-desc ia-sort-desc"):$("[id$=linkSortReplies]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-asc ia-sort-asc"),$("[id$=linkSortCreated]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off"),$("[id$=linkSortPostTime]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off"))}function EndRequestThreadListing(){hideloader();$(".interAction .ia-modal-inline-trigger").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0});$(".interAction .ia-modal-inline-trigger-preview").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!1,showCloseBtn:!0});$(document).on("click",".interAction .ia-modal-dismiss",function(e){e.preventDefault();$.magnificPopup.close()});commonDiscussionThreadListing()}function __akPageDataDefer(callback){if(window.jQuery){var frames=document.getElementsByTagName("iframe");(frames==null||frames.length==0)&&(frames=$(".ak-controls"));frames!=null&&$(".interAction")!=null&&$(".interAction").length>0&&($(".interAction").length>=$(".ak-controls")||$(".interAction").length>=frames.length)?callback():frames!=null&&setTimeout(function(){__akPageDataDefer(callback)},100)}else setTimeout(function(){__akPageDataDefer(callback)},100)}function setPageHeight(){s4Height=$("#s4-bodyContainer").height();$(".ak-user-nav").css("min-height",s4Height)}function doneResizing(){var elementRail,diff,bottomMargin,divMaxHeight;setPageHeight();elementRail=$(".ak-user-nav-flyout.ak-active");elementRail.length>0&&(diff=$(window).height()-elementRail.parent().offset().top,elementRail[0].scrollHeight>diff?(bottomMargin=18,divMaxHeight=diff-bottomMargin,elementRail.css("overflow","auto"),elementRail.css("max-height",divMaxHeight+"px")):(elementRail.css("overflow",""),elementRail.css("max-height","")))}function ShowAddFavoriteDialog(){var urlPathnameAndQuery=window.location.pathname+window.location.search;$("#favorites-popup input#name").val("");$("#favorites-popup input#link").val(urlPathnameAndQuery);$("#favorites-popup select#openwith").val($("#favorites-popup select#openwith option:first").val());$.magnificPopup.open({items:{src:".ak-favorites-modal",type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0,fixedBgPos:!0}});$(".ak-favorites-modal .ak-modal-save").off();$(".ak-favorites-modal .ak-modal-save").click(function(){$(".ak-favorites-modal .ak-modal-save").attr("disabled",!0);AddFavorite()});$(".ak-favorites-modal .ak-modal-cancel").click(function(e){e.preventDefault();$.magnificPopup.close()})}function AddFavorite(){var itemTitle=$("#favorites-popup input#name").val(),itemLink=$("#favorites-popup  input#link").val(),itemOpenWith=$("#favorites-popup  select#openwith").val();if(!ValidateFavoriteData(itemTitle,itemLink)){SetFavoritesErrorMessage("All fields are required.");ShowFavoriteErrorMessage(!1);return}AddFavoriteItem(itemTitle,itemLink,itemOpenWith)}function ValidateFavoriteData(itemTitle,itemLink){return titleValid=itemTitle!=null&&itemTitle!="",linkValid=itemLink!=null&&itemLink!="",linkValid=itemLink!=null&&itemLink!="",titleValid&&linkValid}function AddFavoriteItem(itemTitle,itemLink,itemOpenWith){var clientContext=new SP.ClientContext,oList=clientContext.get_site().get_rootWeb().get_lists().getByTitle("Favorites_AK"),itemCreateInfo=new SP.ListItemCreationInformation;this.oListItem=oList.addItem(itemCreateInfo);this.oListItem.set_item("Title",itemTitle);this.oListItem.set_item("HyperLink",itemLink);this.oListItem.set_item("Open_x0020_With",itemOpenWith);this.oListItem.update();clientContext.load(this.oListItem);Akumina.AddIn.Logger.logSPCall("AddFavoriteItem");clientContext.executeQueryAsync(Function.createDelegate(this,this.onAddFavoriteSucceeded),Function.createDelegate(this,this.onAddFavoriteFailed))}function onAddFavoriteSucceeded(){ShowFavoriteSuccessMessage();Akumina.Digispace.AppPart.Eventing.Publish("/dashboardcontainer/render/")}function onAddFavoriteFailed(sender,args){ShowFavoriteErrorMessage();Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())}function ShowFavoriteSuccessMessage(){$("#favoriteSuccessMessage").show();setTimeout(function(){$("#favoriteSuccessMessage").fadeOut();$.magnificPopup.close();$(".ak-favorites-modal .ak-modal-save").attr("disabled",!1)},1500)}function SetFavoritesErrorMessage(msg){msg==null&&(msg="ia-upload-failed");$("#favoriteErrorMessage .ia-upload-failed").text(msg)}function ShowFavoriteErrorMessage(fadeOut){$("#favoriteErrorMessage").show();setTimeout(function(){$("#favoriteErrorMessage").fadeOut();fadeOut==!1||$.magnificPopup.close();$(".ak-favorites-modal .ak-modal-save").attr("disabled",!1)},1500)}function DeleteFavorite(item){var itemIdValue=$(item).data("item-id"),itemId=parseInt(itemIdValue),parentControl=$(item).closest("div.ak-controls");DeleteFavoriteItem(itemId,parentControl)}function DeleteFavoriteItem(itemId,parentControl){var parentControlId=$(parentControl).attr("id"),clientContext=new SP.ClientContext,oList=clientContext.get_site().get_rootWeb().get_lists().getByTitle("Favorites_AK"),oListItem=oList.getItemById(itemId);oListItem.deleteObject();Akumina.AddIn.Logger.logSPCall("DeleteFavoriteItem");clientContext.executeQueryAsync(Function.createDelegate(this,function(){onDeleteItemSucceeded(parentControlId)}),Function.createDelegate(this,onDeleteItemFailed))}function onDeleteItemSucceeded(){Akumina.Digispace.AppPart.Eventing.Publish("/dashboardcontainer/render/")}function onDeleteItemFailed(sender,args){alert("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())}var spEventsParser,PeopleDirectory_SearchAllUsers,browser,parseObjectResults,clientLync,subP,subM,ShippedSteps,CoreSteps,Akumina_Interaction_Search_Kql,__extends,Akumina,resizeId;if(!function(a,b){"function"==typeof define&&define.amd?define([],b):"undefined"!=typeof module&&module.exports?module.exports=b():a.lscache=b()}(this,function(){function a(){var a="__lscachetest__",c=a;if(void 0!==n)return n;try{if(!localStorage)return!1}catch(d){return!1}try{h(a,c);i(a);n=!0}catch(e){n=b(e)&&localStorage.length?!0:!1}return n}function b(a){return a&&"QUOTA_EXCEEDED_ERR"===a.name||"NS_ERROR_DOM_QUOTA_REACHED"===a.name||"QuotaExceededError"===a.name?!0:!1}function c(){return void 0===o&&(o=null!=window.JSON),o}function d(a){return a.replace(/[[\]{}()*+?.\\^$|]/g,"\\$&")}function e(a){return a+q}function f(){return Math.floor((new Date).getTime()/s)}function g(a){return localStorage.getItem(p+u+a)}function h(a,b){localStorage.removeItem(p+u+a);localStorage.setItem(p+u+a,b)}function i(a){localStorage.removeItem(p+u+a)}function j(a){for(var f,b=new RegExp("^"+p+d(u)+"(.*)"),c=localStorage.length-1;c>=0;--c)f=localStorage.key(c),f=f&&f.match(b),f=f&&f[1],f&&f.indexOf(q)<0&&a(f,e(f))}function k(a){var b=e(a);i(a);i(b)}function l(a){var b=e(a),c=g(b),d;if(c&&(d=parseInt(c,r),f()>=d))return i(a),i(b),!0}function m(a,b){v&&"console"in window&&"function"==typeof window.console.warn&&(window.console.warn("lscache - "+a),b&&window.console.warn("lscache - The error was: "+b.message))}var n,o,p="lscache-",q="-cacheexpiration",r=10,s=6e4,t=Math.floor(864e13/s),u="",v=!1;return{set:function(d,l,n){var p,q,s;if(a()){if("string"!=typeof l){if(!c())return;try{l=JSON.stringify(l)}catch(o){return}}try{h(d,l)}catch(o){if(!b(o))return void m("Could not add item with key '"+d+"'",o);for(q=[],j(function(a,b){var c=g(b);c=c?parseInt(c,r):t;q.push({key:a,size:(g(a)||"").length,expiration:c})}),q.sort(function(a,b){return b.expiration-a.expiration}),s=(l||"").length;q.length&&s>0;)p=q.pop(),m("Cache is full, removing item with key '"+d+"'"),k(p.key),s-=p.size;try{h(d,l)}catch(o){return void m("Could not add item with key '"+d+"', perhaps it's too big?",o)}}n?h(e(d),(f()+n).toString(r)):i(e(d))}},get:function(b){if(!a()||l(b))return null;var d=g(b);if(!d||!c())return d;try{return JSON.parse(d)}catch(e){return d}},remove:function(b){a()&&k(b)},supported:function(){return a()},flush:function(){a()&&j(function(a){k(a)})},flushExpired:function(){a()&&j(function(a){l(a)})},setBucket:function(a){u=a},resetBucket:function(){u=""},enableWarnings:function(a){v=a}}}),spEventsParser={parseEvents:function(events,start,end){for(var full=[],i=0;i<events.length;i++)full=full.concat(this.parseEvent(events[i],start,end));return full},formatString:function(str){var arr=str.split("'");return str=arr.join(""),arr=str.split('"'),str=arr.join(""),arr=str.split("="),str=arr.join(" "),str.trim(),str.split(" ")},parseDate:function(date,allDay){if(typeof date=="string")if(allDay){if(date.lastIndexOf("Z")==date.length-1){var dt=date.substring(0,date.length-1);return new Date(dt)}}else return new Date(date);return allDay?new Date(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),0,0,0):date},parseEvent:function(e,start,end){var arr,started,expired,str,endTagIndex,i,nd,dayOfMonth,temp,ed,ni;if(e.fRecurrence){start=start||this.parseDate(e.EventDate,e.fAllDayEvent);end=end||this.parseDate(e.EndDate,e.fAllDayEvent);this.parseDate(e.EndDate,e.fAllDayEvent)<end&&(end=e.EndDate);var er=[],wd=["su","mo","tu","we","th","fr","sa"],wom=["first","second","third","fourth"],rTotal=0,total=0;if(e.RecurrenceData.indexOf("<repeatInstances>")!=-1&&(rTotal=e.RecurrenceData.substring(e.RecurrenceData.indexOf("<repeatInstances>")+17),rTotal=parseInt(rTotal.substring(0,rTotal.indexOf("<")))),e.RecurrenceData.indexOf("<daily ")!=-1)if(str=e.RecurrenceData.substring(e.RecurrenceData.indexOf("<daily ")),endTagIndex=str.indexOf("/>"),str=endTagIndex==-1?str.substring(7,str.indexOf("><\/daily>")-1):str.substring(7,str.indexOf("/>")-1),arr=this.formatString(str),arr.indexOf("dayFrequency")!=-1)for(var frequency=parseInt(arr[arr.indexOf("dayFrequency")+1]),loop=!0,init=this.parseDate(e.EventDate,e.fAllDayEvent);loop;)started=new Date(init).getTime()>=start.getTime(),expired=!1,total++,started&&(ed=new Date(init),ed.setSeconds(ed.getSeconds()+e.Duration),ni=this.cloneObj(e),ni.EventDate=new Date(init),ni.EndDate=ed,ni.fRecurrence=!1,ni.Id=e.Id,ni.ID=ni.Id,er.push(ni)),init.setDate(init.getDate()+frequency),expired=new Date(init)>end,(expired||rTotal>0&&rTotal<=total)&&(loop=!1);else arr.indexOf("weekday")!=-1&&(e.RecurrenceData=e.RecurrenceData+"<weekly mo='TRUE' tu='TRUE' we='TRUE' th='TRUE' fr='TRUE' weekFrequency='1' />");if(e.RecurrenceData.indexOf("<weekly ")!=-1){str=e.RecurrenceData.substring(e.RecurrenceData.indexOf("<weekly "));endTagIndex=str.indexOf("/>");str=endTagIndex==-1?str.substring(8,str.indexOf("><\/weekly>")-1):str.substring(8,str.indexOf("/>")-1);for(var arr=this.formatString(str),frequency=parseInt(arr[arr.indexOf("weekFrequency")+1]),loop=!0,init=this.parseDate(e.EventDate,e.fAllDayEvent),initDay=init.getDay();loop;){for(i=initDay;i<7;i++)arr.indexOf(wd[i])!=-1&&(rTotal>total||rTotal==0)&&(total++,new Date(init).getTime()>=start.getTime()&&(nd=new Date(init),nd.setDate(nd.getDate()+(i-initDay)),ed=new Date(nd),ed.setSeconds(ed.getSeconds()+e.Duration),ni=this.cloneObj(e),expired=new Date(nd)>end,expired||(ni.EventDate=new Date(nd),ni.EndDate=ed,ni.fRecurrence=!1,ni.Id=e.Id,ni.ID=ni.Id,er.push(ni))));init.setDate(init.getDate()+(7*frequency-initDay));initDay=0;(new Date(init)>end||rTotal>0&&rTotal<=total)&&(loop=!1)}}if(e.RecurrenceData.indexOf("<monthly ")!=-1){str=e.RecurrenceData.substring(e.RecurrenceData.indexOf("<monthly "));endTagIndex=str.indexOf("/>");str=endTagIndex==-1?str.substring(9,str.indexOf("><\/monthly>")-1):str.substring(9,str.indexOf("/>")-1);for(var arr=this.formatString(str),frequency=parseInt(arr[arr.indexOf("monthFrequency")+1]),loop=!0,init=this.parseDate(e.EventDate,e.fAllDayEvent),day=parseInt(arr[arr.indexOf("day")+1]);loop;)total++,new Date(init).getTime()>=start.getTime()&&(nd=new Date(init),nd.setDate(day),nd.getMonth()==init.getMonth()&&(ed=new Date(nd),ed.setSeconds(ed.getSeconds()+e.Duration),ni=this.cloneObj(e),ni.EventDate=new Date(nd),ni.EndDate=ed,ni.fRecurrence=!1,ni.Id=e.Id,ni.ID=ni.Id,er.push(ni))),init.setMonth(init.getMonth()+frequency),(new Date(init)>end||rTotal>0&&rTotal<=total)&&(loop=!1)}if(e.RecurrenceData.indexOf("<monthlyByDay ")!=-1){str=e.RecurrenceData.substring(e.RecurrenceData.indexOf("<monthlyByDay "));endTagIndex=str.indexOf("/>");str=endTagIndex==-1?str.substring(14,str.indexOf("><\/monthlyByDay>")-1):str.substring(14,str.indexOf("/>")-1);for(var arr=this.formatString(str),frequency=parseInt(arr[arr.indexOf("monthFrequency")+1]),loop=!0,originalInit=new Date(this.parseDate(e.EventDate,e.fAllDayEvent)),init=this.parseDate(e.EventDate,e.fAllDayEvent),weekdayOfMonth=arr[arr.indexOf("weekdayOfMonth")+1],temp=new Date;loop;){if(total++,new Date(init).getTime()>=start.getTime()){if(nd=new Date(init),nd.setDate(1),arr.indexOf("weekday")!=-1)if(nd.getDay()==0?nd.setDate(nd.getDate()+1):nd.getDay()==6&&nd.setDate(nd.getDate()+2),weekdayOfMonth=="last"){while(nd.getMonth()==init.getMonth())temp=new Date(nd),nd.getDay()==5?nd.setDate(nd.getDate()+3):nd.setDate(nd.getDate()+1);nd=new Date(temp)}else for(i=0;i<wom.indexOf(weekdayOfMonth);i++)nd.getDay()==5?nd.setDate(nd.getDate()+3):nd.setDate(nd.getDate()+1);else if(arr.indexOf("weekend_day")!=-1)if(nd.getDay()!=0&&nd.getDay()!=6&&nd.setDate(nd.getDate()+(6-nd.getDay())),weekdayOfMonth=="last"){while(nd.getMonth()==init.getMonth())temp=new Date(nd),nd.getDay()==0?nd.setDate(nd.getDate()+6):nd.setDate(nd.getDate()+1);nd=new Date(temp)}else for(i=0;i<wom.indexOf(weekdayOfMonth);i++)nd.getDay()==0?nd.setDate(nd.getDate()+6):nd.setDate(nd.getDate()+1);else if(arr.indexOf("day")!=-1)weekdayOfMonth=="last"?(nd=nd.setMonth(nd.getMonth()+1),nd.setDate(0)):nd.setDate(nd.getDate()+wom.indexOf(weekdayOfMonth));else{for(i=0;i<wd.length;i++)arr.indexOf(wd[i])!=-1&&(nd.getDate()>i?nd.setDate(nd.getDate()+(7-(nd.getDay()-i))):nd.getDate()+(i-nd.getDay())>0?nd.setDate(nd.getDate()+(i-nd.getDay())):nd.setDate(nd.getDate()+(7-(nd.getDay()-i))));if(weekdayOfMonth=="last"){while(nd.getMonth()==init.getMonth())temp=new Date(nd),nd.setDate(nd.getDate()+7);nd=new Date(temp)}else for(i=0;i<wom.indexOf(weekdayOfMonth);i++)nd.setDate(nd.getDate()+7)}nd.getMonth()==init.getMonth()&&nd.getTime()>=originalInit.getTime()&&(ed=new Date(nd),ed.setSeconds(ed.getSeconds()+e.Duration),ni=this.cloneObj(e),ni.EventDate=new Date(nd),ni.EndDate=ed,ni.fRecurrence=!1,ni.Id=e.Id,ni.ID=ni.Id,er.push(ni))}init.setMonth(init.getMonth()+frequency);(new Date(init)>end||rTotal>0&&rTotal<=total)&&(loop=!1)}}if(e.RecurrenceData.indexOf("<yearly ")!=-1){str=e.RecurrenceData.substring(e.RecurrenceData.indexOf("<yearly "));endTagIndex=str.indexOf("/>");str=endTagIndex==-1?str.substring(8,str.indexOf("><\/yearly>")-1):str.substring(8,str.indexOf("/>")-1);for(var arr=this.formatString(str),frequency=parseInt(arr[arr.indexOf("yearFrequency")+1]),loop=!0,init=this.parseDate(e.EventDate,e.fAllDayEvent),month=parseInt(arr[arr.indexOf("month")+1])-1,day=parseInt(arr[arr.indexOf("day")+1]);loop;)nd=new Date(init),nd.setMonth(month),nd.setDate(day),new Date(init).getTime()<=nd.getTime()&&(total++,nd.getTime()>=start.getTime()&&(ed=new Date(nd),ed.setSeconds(ed.getSeconds()+e.Duration),ni=this.cloneObj(e),ni.EventDate=new Date(nd),ni.EndDate=ed,ni.fRecurrence=!1,ni.Id=e.Id,ni.ID=ni.Id,er.push(ni))),init.setFullYear(init.getFullYear()+frequency),(new Date(init)>end||rTotal>0&&rTotal<=total)&&(loop=!1)}if(e.RecurrenceData.indexOf("<yearlyByDay ")!=-1){str=e.RecurrenceData.substring(e.RecurrenceData.indexOf("<yearlyByDay "));endTagIndex=str.indexOf("/>");str=endTagIndex==-1?str.substring(13,str.indexOf("><\/yearlyByDay>")-1):str.substring(13,str.indexOf("/>")-1);var arr=this.formatString(str),frequency=parseInt(arr[arr.indexOf("yearFrequency")+1]),loop=!0,init=this.parseDate(e.EventDate,e.fAllDayEvent),month=parseInt(arr[arr.indexOf("month")+1])-1,weekdayOfMonth=arr[arr.indexOf("weekdayOfMonth")+1],day=0;for(i=0;i<wd.length;i++)arr.indexOf(wd[i])!=-1&&arr[arr.indexOf(wd[i])+1].toLowerCase()=="true"&&(day=i);while(loop){if(nd=new Date(init),nd.setMonth(month),new Date(init).getTime()<=nd.getTime()&&(total++,new Date(init).getTime()>=start.getTime())){if(nd.setDate(1),dayOfMonth=nd.getDay(),day<dayOfMonth?nd.setDate(nd.getDate()+(7-dayOfMonth+day)):nd.setDate(nd.getDate()+(day-dayOfMonth)),weekdayOfMonth=="last")for(temp=new Date(nd);temp.getMonth()==month;)nd=new Date(temp),temp.setDate(temp.getDate()+7);else nd.setDate(nd.getDate()+7*wom.indexOf(weekdayOfMonth));nd.getMonth()==month&&(ed=new Date(nd),ed.setSeconds(ed.getSeconds()+e.Duration),ni=this.cloneObj(e),ni.EventDate=new Date(nd),ni.EndDate=ed,ni.fRecurrence=!1,ni.Id=e.Id,ni.ID=ni.Id,er.push(ni))}init.setFullYear(init.getFullYear()+frequency);init.setMonth(month);init.setDate(1);(new Date(init)>end||rTotal>0&&rTotal<=total)&&(loop=!1)}}return er}return e.EventDate=new Date(this.parseDate(e.EventDate,e.fAllDayEvent)),e.EndDate=new Date(this.parseDate(e.EndDate,e.fAllDayEvent)),[e]},cloneObj:function(obj){var copy,i,len,attr;if(null==obj||"object"!=typeof obj)return obj;if(obj instanceof Date)return copy=new Date,copy.setTime(obj.getTime()),copy;if(obj instanceof Array){for(copy=[],i=0,len=obj.length;i<len;i++)copy[i]=this.cloneObj(obj[i]);return copy}if(obj instanceof Object){copy={};for(attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=this.cloneObj(obj[attr]));return copy}throw new Error("Unable to copy obj! Its type isn't supported.");}},function(Akumina){var AddIn;(function(AddIn){var Themes,Icons,QueryType,ColorTheme,TransitionEffect,Alignment,Location,Logger,Configuration,BaseRequest,Dictionary,InstructionResponse,Instructions,Utilities,Cache,Constants;(function(Themes){Themes[Themes.Alert=0]="Alert";Themes[Themes.Red=1]="Red";Themes[Themes.Yellow=2]="Yellow";Themes[Themes.Orange=3]="Orange";Themes[Themes.Green=4]="Green";Themes[Themes.Blue=5]="Blue";Themes[Themes.Bluegreen=6]="Bluegreen";Themes[Themes.Violet=7]="Violet";Themes[Themes.Gray=8]="Gray";Themes[Themes.Black=9]="Black";Themes[Themes.White=10]="White"})(AddIn.Themes||(AddIn.Themes={}));Themes=AddIn.Themes,function(Icons){Icons[Icons.None=0]="None";Icons[Icons.Bar=1]="Bar";Icons[Icons.Calendar=2]="Calendar";Icons[Icons.Camera=3]="Camera";Icons[Icons.Car=4]="Car";Icons[Icons.Cloud=5]="Cloud";Icons[Icons.Comment=6]="Comment";Icons[Icons.Comments=7]="Comments";Icons[Icons.Envelope=8]="Envelope";Icons[Icons.Exclamation=9]="Exclamation";Icons[Icons.Feed=10]="Feed";Icons[Icons.File=11]="File";Icons[Icons.Files=12]="Files";Icons[Icons.Filter=13]="Filter";Icons[Icons.Folder=14]="Folder";Icons[Icons.Gear=15]="Gear";Icons[Icons.Image=16]="Image";Icons[Icons.Info=17]="Info";Icons[Icons.Link=18]="Link";Icons[Icons.Newspaper=19]="Newspaper";Icons[Icons.Pencil=20]="Pencil";Icons[Icons.Phone=21]="Phone";Icons[Icons.Pie=22]="Pie";Icons[Icons.Question=23]="Question";Icons[Icons.Search=24]="Search";Icons[Icons.Shopping=25]="Shopping";Icons[Icons.Sun=26]="Sun"}(AddIn.Icons||(AddIn.Icons={}));Icons=AddIn.Icons,function(QueryType){QueryType[QueryType.ListQuery=0]="ListQuery";QueryType[QueryType.SearchQuery=1]="SearchQuery"}(AddIn.QueryType||(AddIn.QueryType={}));QueryType=AddIn.QueryType,function(ColorTheme){ColorTheme[ColorTheme.White=0]="White";ColorTheme[ColorTheme.Black=1]="Black";ColorTheme[ColorTheme.Gray=2]="Gray"}(AddIn.ColorTheme||(AddIn.ColorTheme={}));ColorTheme=AddIn.ColorTheme,function(TransitionEffect){TransitionEffect[TransitionEffect.Horizontal=0]="Horizontal";TransitionEffect[TransitionEffect.Fade=1]="Fade"}(AddIn.TransitionEffect||(AddIn.TransitionEffect={}));TransitionEffect=AddIn.TransitionEffect,function(Alignment){Alignment[Alignment.left=0]="left";Alignment[Alignment.right=1]="right";Alignment[Alignment.center=2]="center"}(AddIn.Alignment||(AddIn.Alignment={}));Alignment=AddIn.Alignment,function(Location){Location[Location.top_left=0]="top_left";Location[Location.top_center=1]="top_center";Location[Location.top_right=2]="top_right";Location[Location.middle_left=3]="middle_left";Location[Location.middle_center=4]="middle_center";Location[Location.middle_right=5]="middle_right";Location[Location.bottom_left=6]="bottom_left";Location[Location.bottom_center=7]="bottom_center";Location[Location.bottom_right=8]="bottom_right"}(AddIn.Location||(AddIn.Location={}));Location=AddIn.Location;Logger=function(){function Logger(){}var counter=0;return Logger.log=function(){},Logger.logSPCall=function(caller){counter++;Logger.WriteInfoLog(caller+" - fetching data from SharePoint")},Logger.WriteInfoLog=function(message){!0&&window.console&&console.log("Digi Info: ",message)},Logger.WriteErrorLog=function(message){!0&&window.console&&console.error("Digi Error: ",message)},Logger.StartTraceLog=function(label){if(!0&&window.console)try{console.time(label)}catch(err){}},Logger.StopTraceLog=function(label){if(!0&&window.console)try{console.timeEnd(label)}catch(err){}},Logger.getSPCallCount=function(){return counter},Logger}();AddIn.Logger=Logger;Configuration=function(){function Configuration(){}return Configuration.getInstructionField=function(source,propName){for(var field,i=0;i<this.instructionFields.length;i++)if(this.instructionFields[i].ObjectId===source)return field=this.instructionFields[i].Fields[propName],Akumina.AddIn.Utilities.IsNullOrEmpty(field)?propName:field;return propName},Configuration.getSelectFields=function(source){for(var i=0;i<this.selectFields.length;i++)if(this.selectFields[i].ObjectId===source)return this.selectFields[i].Fields;return[]},Configuration.containsInExcludeField=function(field){return $.inArray(field.toLowerCase(),this.excludeInstructionFields)>=0},Configuration.instructionFields=[{ObjectId:"bannerRequest",Fields:{ShowNavigator:"SlideNavigation",MaxSlideCount:"MaximumSlideCount",TransitionEffect:"Animation_x002e_SlideTransition",SlideDuration:"Animation_x002e_SlideDuration",TextColorTheme:"TextSettings_x002e_ColorTheme",TextLocation:"TextSettings_x002e_Location",TextAlignment:"TextSettings_x002e_Alignment",H1MaxCharacters:"TextSettings_x002e_MaxCharacters",H2MaxCharacters:"TextSettings_x002e_SubtitleMaxCh",ButtonMaxCharacters:"TextSettings_x002e_ButtonMaxChar",AutoPlay:"Autoplay"}},{ObjectId:"contentRequest",Fields:{EnableAlert:"EnableAlert"}}],Configuration.excludeInstructionFields=["contentversion","appauthor","appeditor","_moderationstatus","_moderationcomments","attachments","syncclientid","contenttype","contenttypeid","_copysource","created","created_x0020_date","edit","_editmenutableend","_editmenutablestart","_editmenutablestart2","permmask","encodedabsurl","basename","file_x0020_type","folderchildcount","guid","_hascopydestinations","html_x0020_file_x0020_type","instanceid","_iscurrentversion","itemchildcount","fsobjtype","smlastmodifieddate","_level","modified","last_x0020_modified","editor","fileleafref","linkfilenamenomenu","linkfilename","linkfilename2","noexecute","order","originatorid","owshiddenversion","filedirref","progid","metainfo","restricted","scopeid","selecttitle","serverurl","sortbehavior","linktitlenomenu","linktitle","linktitle2","smtotalfilecount","smtotalfilestreamsize","smtotalsize","docicon","_uiversion","uniqueid","fileref","_uiversionstring","workflowinstanceid","workflowversion"],Configuration.selectFields=[{ObjectId:"AnnouncementItems",Fields:["ID","Title","Summary","FriendlyUrl","Expires","Created","Start_x0020_Date"]},{ObjectId:"AnnouncementDetail",Fields:["ID","Title","Summary","Body","FriendlyUrl","Expires","Created","Start_x0020_Date","Seo_x002d_Title","Seo_x002d_Keywords","Seo_x002d_Description"]},{ObjectId:"Banner",Fields:["ID","BannerActive","BannerHeading","BannerImageAltText","BannerImage","BannerItemOrder","BannerLinkHoverText","BannerLinkTarget","BannerLinkText","BannerSubHeading","BannerLinkUrl","Expires"]},{ObjectId:"Calendar",Fields:["ID","EventTitle","Body","FriendlyUrl","EventDate","EndDate","Category","Location","fAllDayEvent","fRecurrence","RecurrenceData","Duration"]},{ObjectId:"ContentBlock",Fields:["ID","Title","Html","IsAlert","Expires"]},{ObjectId:"NewDiscussion",Fields:["ID","Title","Html","Expires"]},{ObjectId:"DiscussionBoard",Fields:["ID","Title","Author","ItemChildCount","Body","FileRef","DiscussionLastUpdated,Created"]},{ObjectId:"DiscussionSummary",Fields:["ID","Title","Author","ItemChildCount","DiscussionLastUpdated","Body","FileRef"]},{ObjectId:"DiscussionReply",Fields:["ID","Title","Author","ItemChildCount","Body","FileRef","DiscussionLastUpdated,Created"]},{ObjectId:"DiscussionThread",Fields:["ID","Title","Html","Expires"]},{ObjectId:"EventDetail",Fields:["ID","Title","EventTitle","Body","FriendlyUrl","EventDate","EndDate","Category","Location","fAllDayEvent","fRecurrence","RecurrenceData","Duration"]},{ObjectId:"ImportantDates",Fields:["ID","Title","DetailsLink","MoreWindow","Subtext","Expires","Created","Start_x0020_Date","DoNotDisplayThisItem"]},{ObjectId:"QuickLinks",Fields:["ID","Title","NodeType","Link","Open_x0020_With","DisplayOrder","ParentItem_x003a_ID","Active","FormID","Icon"]},{ObjectId:"Traffic",Fields:["ID","Title","Location","ApiKey"]}],Configuration.versionSoapEnvelope="<soap:Envelope xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xmlns:xsd='http://www.w3.org/2001/XMLSchema' xmlns:soap='http://schemas.xmlsoap.org/soap/envelope/'><soap:Body><GetVersionCollection xmlns='http://schemas.microsoft.com/sharepoint/soap/'><strlistID>{0}<\/strlistID><strlistItemID>{1}<\/strlistItemID><strFieldName>{2}<\/strFieldName><\/GetVersionCollection><\/soap:Body><\/soap:Envelope>",Configuration}();AddIn.Configuration=Configuration;BaseRequest=function(){function BaseRequest(){}return BaseRequest}();AddIn.BaseRequest=BaseRequest;Dictionary=function(){function Dictionary(init){this._keys=[];this._values=[];for(var x=0;x<init.length;x++)this[init[x].key]=init[x].value,this._keys.push(init[x].key),this._values.push(init[x].value)}return Dictionary.prototype.add=function(key,value){this[key]=value;this._keys.push(key);this._values.push(value)},Dictionary.prototype.remove=function(key){var index=this._keys.indexOf(key,0);this._keys.splice(index,1);this._values.splice(index,1);delete this[key]},Dictionary.prototype.keys=function(){return this._keys},Dictionary.prototype.values=function(){return this._values},Dictionary.prototype.containsKey=function(key){return typeof this[key]=="undefined"?!1:!0},Dictionary.prototype.toLookup=function(){return this},Object.defineProperty(Dictionary.prototype,"length",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Dictionary}();AddIn.Dictionary=Dictionary;InstructionResponse=function(){function InstructionResponse(dictionary){this.dictionary=dictionary;this.splitby="_x002e_";this.defaultCategory="AkuminaInterActionDefault"}return InstructionResponse.prototype.getValue=function(columnName,defaultValue){var columnValue;try{var arr=columnName.split("."),firstKey=arr.length===1?this.defaultCategory:arr[0],secondKey=arr.length===1?arr[0]:arr[1];return!this.dictionary.containsKey(firstKey)||!this.dictionary[firstKey].containsKey(secondKey)?defaultValue:(columnValue=this.dictionary[firstKey][secondKey],columnValue!=null?columnValue:defaultValue)}catch(ex){return defaultValue}},InstructionResponse}();AddIn.InstructionResponse=InstructionResponse;Instructions=function(){function Instructions(){this.splitby="_x002e_";this.defaultCategory="AkuminaInterActionDefault";this.map=new Dictionary([]);this.await=null;this.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));this.current=null}return Instructions.prototype.executeAsync=function(current,instructionName,sourceType){var qp,listName,idOrTitle,context,web,control,parentContext,site;if(this.sourceType=sourceType,this.current=current,this.await=Q.defer(),Akumina.AddIn.Utilities.IsNullOrEmpty(instructionName))return this.await.resolve(this.current),this.await.promise;qp=instructionName.split(".");this.rootWeb=!1;listName=qp[0];idOrTitle=qp[1];qp.length===3&&(this.rootWeb=!0,listName=qp[1],idOrTitle=qp[2]);context=new SP.ClientContext.get_current;control=this.current[this.sourceType];control.Hosted?(parentContext=new SP.AppContextSite(context,this.hostUrl),this.rootWeb?(site=parentContext.get_site(),web=site.get_rootWeb()):web=parentContext.get_web()):this.rootWeb?(site=context.get_site(),web=site.get_rootWeb()):web=context.get_web();var list=web.get_lists().getByTitle(listName),camlQuery=new SP.CamlQuery,query="<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+idOrTitle+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>";return isNaN(idOrTitle)&&(query="<View><Query><Where><Eq><FieldRef Name='Title'/><Value Type='Text'>"+idOrTitle+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>"),camlQuery.set_viewXml(query),this.listItems=list.getItems(camlQuery),this.listFields=list.get_fields(),context.load(this.listFields),context.load(this.listItems),Akumina.AddIn.Logger.logSPCall("Instructions.prototype.executeAsync"),context.executeQueryAsync(Function.createDelegate(this,Instructions.prototype.success),Function.createDelegate(this,Instructions.prototype.error)),this.await.promise},Instructions.prototype.success=function(){for(var listEnumerator=this.listItems.getEnumerator(),listItem,fields,source,propertyName,val,fieldName;listEnumerator.moveNext();)for(listItem=listEnumerator.get_current(),fields=this.listFields.getEnumerator();fields.moveNext();)fieldName=fields.get_current().get_staticName(),Logger.log("FieldName="+fieldName),Akumina.AddIn.Configuration.containsInExcludeField(fieldName)||this.create(fieldName,listItem.get_item(fieldName));if(source=this.current[this.sourceType],this.instruction=new InstructionResponse(this.map),this.instruction!==null&&this.instruction.dictionary.length>0)for(propertyName in source)source.hasOwnProperty(propertyName)&&(val=source[propertyName],fieldName=this.sourceType===""?propertyName:AddIn.Configuration.getInstructionField(this.sourceType,propertyName),source[propertyName]=this.instruction.getValue(fieldName,val));this.current.contentRequest=source;this.await.resolve(this.current)},Instructions.prototype.error=function(sender,args){Logger.log("Request failed. "+args.get_message()+"\n"+args.get_stackTrace());this.await.resolve(this.current)},Instructions.prototype.create=function(name,val){var cat=this.defaultCategory,field=name;this.map.containsKey(cat)?this.map[cat].containsKey(field)||this.map[cat].add(field,val):this.map.add(cat,new Dictionary([{key:field,value:val}]))},Instructions}();AddIn.Instructions=Instructions;Utilities=function(){function Utilities(){}return Utilities.isInDay=function(data,day,month,year){var sameDay=data.StartDate.date()==day,sameMonth=data.StartDate.month()+1==month,sameYear=data.StartDate.year()==year;return sameDay&&sameMonth&&sameYear},Utilities.isInMonth=function(data,month,year){var inMonth=!1,startSameYear=data.StartDate.year()===year,startEarlierYear=data.StartDate.year()<year,startSameMonth=data.StartDate.month()+1==month,startEarlierMonth=data.StartDate.month()+1<month,endSameYear=data.EndDate.year()==year,endLaterYear=data.EndDate.year()>year,endSameMonth=data.EndDate.month()+1==month,endLaterMonth=data.EndDate.month()+1>month,startsBefore=startSameYear&&startEarlierMonth||startEarlierYear,endsAfter=endSameYear&&endLaterMonth||endLaterYear;return startSameYear&&startSameMonth?inMonth=!0:endSameYear&&endSameMonth?inMonth=!0:startsBefore&&endsAfter&&(inMonth=!0),inMonth},Utilities.addRecurrenceDataAsJson=function(event){if(typeof event.RecurrenceData=="string"&&event.RecurrenceData.length>0&&event.RecurrenceData[0]==="<"){var xmlDoc=$.parseXML(event.RecurrenceData),jsonRecurrenceData=JXON.build(xmlDoc.documentElement);event.JSONRecurrenceData=jsonRecurrenceData}return event},Utilities.setDateValues=function(data,startDate,endDate){var dtStartDate=startDate.isValid()?startDate.clone():moment(startDate),dtEndDate;return data.AllDay&&(dtStartDate=dtStartDate.utc()),data.StartDate=dtStartDate,data.StartDateYear=dtStartDate.year(),data.StartDateMonth=dtStartDate.month(),data.Date=dtStartDate.format("dddd, MMMM DD, YYYY"),data.DisplayStartDate=dtStartDate.format("dddd, MMMM DD, YYYY"),data.AllDay?(data.Time="",data.DisplayStartTime=""):(data.Time=dtStartDate.format("h:mm A"),data.DisplayStartTime=dtStartDate.format("h:mm A")),data.StartDateUTC=dtStartDate.utc().format("YYYY-MM-DDTHH:mm:ss+00:00"),dtEndDate=moment(endDate),data.AllDay&&(dtEndDate=dtEndDate.utc()),data.EndDate=dtEndDate,data.EndDateYear=dtEndDate.year(),data.EndDateMonth=dtEndDate.month(),dtEndDate.year()>=dtStartDate.year()&&dtEndDate.month()>=dtStartDate.month()&&dtEndDate.date()>dtStartDate.date()&&(data.Date=data.Date+=" - "+dtEndDate.format("dddd, MMMM DD, YYYY")),data.AllDay?(data.Time="",data.DisplayEndTime=""):(data.Time=data.Time+=" - "+dtEndDate.format("h:mm A"),data.DisplayEndTime=dtEndDate.format("h:mm A")),data.DisplayEndDate=dtEndDate.format("dddd, MMMM DD, YYYY"),data.DisplayEndDate==data.DisplayStartDate&&(data.DisplayEndDate=""),data.EndDateUTC=dtEndDate.utc().format("YYYY-MM-DDTHH:mm:ss+00:00"),data.DisplayDateRange=data.Date,data.DisplayTimeRange=data.Time,data},Utilities.addRecurringEvents=function(data,month,year){var items=[],dt,rstartDate,rendDate,recurrenceItems,eventUrl,modifiedEventUrl;for(eventObject={Id:data.Id,Title:data.Title,EventDate:data.StartDate.toDate(),EndDate:data.EndDate.toDate(),RecurrenceData:data.RecurrenceData,fAllDayEvent:data.AllDay,fRecurrence:!0,Duration:data.Duration},dt=new Date,rstartDate=new Date(year,month-1,1),rstartDate.setDate(rstartDate.getDate()-5),rendDate=new Date(year,month-1,1),rendDate.setDate(rendDate.getDate()+40),recurrenceItems=spEventsParser.parseEvent(eventObject,rstartDate,rendDate),i=0;i<recurrenceItems.length;i++){var recurrenceItem=recurrenceItems[i],recurringEvent=$.extend(!0,{},data),currentStartDate=moment(recurrenceItem.EventDate),currentEndDate=moment(recurrenceItem.EndDate);recurringEvent=recurringEvent.AllDay?Akumina.AddIn.Utilities.setDateValues(recurringEvent,moment([currentStartDate.year(),currentStartDate.month(),currentStartDate.date(),0,0,0,0]),moment([currentStartDate.year(),currentStartDate.month(),currentStartDate.date(),0,0,0,0])):Akumina.AddIn.Utilities.setDateValues(recurringEvent,moment(currentStartDate),moment(currentEndDate));items.push(recurringEvent)}for(Akumina.AddIn.Logger.WriteInfoLog(data.Title+": "+recurrenceItems.length),i=0;i<items.length;i++)eventUrl=items[i].Url,modifiedEventUrl=eventUrl,modifiedEventUrl+=eventUrl.indexOf("?")>-1?"&":"?",modifiedEventUrl+="caldate="+items[i].StartDate.format("YYYY-MM-DD"),items[i].Url=modifiedEventUrl;return items},Utilities.getQueryStringParameter=function(paramToRetrieve,defaultValue){var paramSplit=document.URL.split("?"),params,i,singleParam;if(paramSplit.length>1)for(params=paramSplit[1].split("&"),i=0;i<params.length;i=i+1)if(singleParam=params[i].split("="),singleParam[0]===paramToRetrieve)return decodeURIComponent(singleParam[1]);return defaultValue},Utilities.getEditMode=function(){var inDesignMode=document.forms[0]!=null&&document.forms[0].MSOLayout_InDesignMode!=null&&document.forms[0].MSOLayout_InDesignMode.value,wikiInEditMode=document.forms[0]!=null&&document.forms[0]._wikiPageMode!=null&&document.forms[0]._wikiPageMode.value,inDesignModeValue="",wikiInEditModeValue="";return inDesignMode&&(inDesignModeValue=document.forms[0].MSOLayout_InDesignMode.value),wikiInEditMode&&(wikiInEditModeValue=document.forms[0]._wikiPageMode.value),inDesignModeValue=="1"||wikiInEditModeValue=="Edit"},Utilities.getPropertyParameter=function(props,paramToRetrieve,defaultValue){return props!=null&&props[paramToRetrieve]?props[paramToRetrieve]:defaultValue},Utilities.getProperties=function(element){var props={};return $(element).each(function(){$.each(this.attributes,function(){if(this.specified&&(this.name.toLowerCase()=="id"||this.name.indexOf("ak:")==0)){var adjustedName=this.name.replace("ak:","");props[adjustedName]=this.value}})}),props},Utilities.GetTitleFromUrl=function(currentUrl){var urlParts;return currentUrl==null&&(currentUrl=document.URL),urlParts=currentUrl.split("/"),urlParts.splice(0,3),"/"+urlParts.join("/")},Utilities.NthWeekdayOfMonth=function(weekday,n,date){var date=new Date(date.getFullYear(),date.getMonth(),1),add=(weekday-date.getDay()+7)%7+(n-1)*7;return date.setDate(1+add),date},Utilities.ItemExpired=function(expires){var expiresUtc;if(this.IsNullOrEmpty(expires))return!1;var today=new Date,todayUtc=new Date(today.getTime()+today.getTimezoneOffset()*6e4),dtExpires=new Date(expires);return dtExpires.getTimezoneOffset()>0?(expiresUtc=new Date(dtExpires.getTime()+dtExpires.getTimezoneOffset()*6e4),todayUtc>expiresUtc):today>dtExpires},Utilities.ItemExpiredBeforeThisMonth=function(year,month,expires){var expiresUtc;if(this.IsNullOrEmpty(expires))return!1;var today=new Date(year,month-1,1),todayUtc=new Date(today.getTime()+today.getTimezoneOffset()*6e4),dtExpires=new Date(expires);return dtExpires.getTimezoneOffset()>0?(expiresUtc=new Date(dtExpires.getTime()+dtExpires.getTimezoneOffset()*6e4),todayUtc>expiresUtc):today>dtExpires},Utilities.GetDayIndicies=function(recurrenceRule){var dayIndecies=[];return recurrenceRule["@su"]!=null&&recurrenceRule["@su"]==!0&&dayIndecies.push(0),recurrenceRule["@mo"]!=null&&recurrenceRule["@mo"]==!0&&dayIndecies.push(1),recurrenceRule["@tu"]!=null&&recurrenceRule["@tu"]==!0&&dayIndecies.push(2),recurrenceRule["@we"]!=null&&recurrenceRule["@we"]==!0&&dayIndecies.push(3),recurrenceRule["@th"]!=null&&recurrenceRule["@th"]==!0&&dayIndecies.push(4),recurrenceRule["@fr"]!=null&&recurrenceRule["@fr"]==!0&&dayIndecies.push(5),recurrenceRule["@sa"]!=null&&recurrenceRule["@sa"]==!0&&dayIndecies.push(6),dayIndecies},Utilities.GetRecurrenceDayPosition=function(weekdayOfMonth){var position=1;switch(weekdayOfMonth){case"first":position=1;break;case"second":position=2;break;case"third":position=3;break;case"fourth":position=4;break;case"last":position=Number.MAX_SAFE_INTEGER}return position},Utilities.GetDayIndex=function(recurrenceRule){var dayIndex=-1;return recurrenceRule["@su"]!=null&&recurrenceRule["@su"]==!0?dayIndex=0:recurrenceRule["@mo"]!=null&&recurrenceRule["@mo"]==!0?dayIndex=1:recurrenceRule["@tu"]!=null&&recurrenceRule["@tu"]==!0?dayIndex=2:recurrenceRule["@we"]!=null&&recurrenceRule["@we"]==!0?dayIndex=3:recurrenceRule["@th"]!=null&&recurrenceRule["@th"]==!0?dayIndex=4:recurrenceRule["@fr"]!=null&&recurrenceRule["@fr"]==!0?dayIndex=5:recurrenceRule["@sa"]!=null&&recurrenceRule["@sa"]==!0&&(dayIndex=6),dayIndex},Utilities.ItemStarted=function(startDate){var startDateUtc;if(this.IsNullOrEmpty(startDate))return!0;var today=new Date,todayUtc=new Date(today.getTime()+today.getTimezoneOffset()*6e4),dtStartDate=new Date(startDate);return dtStartDate.getTimezoneOffset()>0?(startDateUtc=new Date(dtStartDate.getTime()+dtStartDate.getTimezoneOffset()*6e4),todayUtc>startDateUtc):today>dtStartDate},Utilities.ItemStartedAfterThisMonth=function(year,month,startDate){var startDateUtc;if(this.IsNullOrEmpty(startDate))return!0;var today=new Date(year,month,1),todayUtc=new Date(today.getTime()+today.getTimezoneOffset()*6e4),dtStartDate=new Date(startDate);return dtStartDate.getTimezoneOffset()>0?(startDateUtc=new Date(dtStartDate.getTime()+dtStartDate.getTimezoneOffset()*6e4),todayUtc>startDateUtc):today>dtStartDate},Utilities.GetFriendlyUrl=function(currentUrl){var itemUrl="";currentUrl==null&&(currentUrl=document.URL);var a=$("<a>",{href:currentUrl})[0],currentPath=a.pathname,urlParts=currentPath.split("/");return itemUrl=urlParts[urlParts.length-1],decodeURI(itemUrl)},Utilities.TryParseInt=function(str,defaultValue){var retValue=defaultValue;return str!==null&&str.length>0&&(isNaN(str)||(retValue=parseInt(str))),retValue},Utilities.GetIcon=function(icons){if(typeof icons=="undefined")return"none";switch(icons.toLowerCase()){case"bar":return"bar-chart";case"exclamation":return"exclamation-triangle";case"feed":return"rss";case"files":return"files-o";case"gear":return"cog";case"image":return"picture-o";case"info":return"info-circle";case"newspaper":return"newspaper-o";case"pie":return"pie-chart";case"question":return"question-circle";case"shopping":return"shopping-cart";case"sun":return"sun-o";default:return icons.toLowerCase()}},Utilities.resizeIframe=function(){var body=document.body,html=document.documentElement,height=Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight,html.scrollHeight,html.offsetHeight);window.parent.postMessage("<message senderId="+senderId+">resize(100%,"+height+"px)<\/message>","*")},Utilities.sendMessage=function(html,senderId){var messageToPost={message:""};return messageToPost.message="akumina.webparts.controls.html",messageToPost.html=html,messageToPost.senderid=senderId,window.parent.postMessage(JSON.stringify(messageToPost),document.referrer),!1},Utilities.SendModelToParent=function(model,senderId,control){var messageToPost={message:""};return messageToPost.message="akumina.appparts."+control+".model",messageToPost.model=model,messageToPost.senderid=senderId,window.parent.postMessage(JSON.stringify(messageToPost),document.referrer),!1},Utilities.IsNullOrEmpty=function(data){return data===undefined||data===null||data===""?!0:!1},Utilities.substring=function(data,len){return this.IsNullOrEmpty(data)?"":data.substring(0,len)},Utilities.format=function(){for(var regEx,formatStr=arguments[0],i=1;i<arguments.length;i++)regEx=new RegExp("\\{"+(i-1)+"\\}","gm"),formatStr=formatStr.replace(regEx,arguments[i]);return formatStr},Utilities.ToggleWidgetManager=function(){var isMenuActive=!1;$(".ak-controls").hasClass("ak-control-menuactive")?($(".ak-controls").removeClass("ak-control-menuactive"),$(".ak-control-menu").remove(),isMenuActive=!0):$(".ak-controls").addClass("ak-control-menuactive");$(".ak-widget").children().hasClass("ak-control-menuactive")?($(".ak-widget").children().removeClass("ak-control-menuactive"),$(".ak-control-menu").remove(),isMenuActive=!0):$(".ak-widget").children().addClass("ak-control-menuactive");isMenuActive||(new Akumina.WidgetManager).Init()},Utilities.ToggleDebugger=function(){var userContext=Akumina.Digispace.UserContext.getUserContext(),model={Version:Akumina.Digispace.Version,Items:[]},digiConfigItems=CoreSteps.DisplayDebugInformation.GetDigispaceConfigHTML(),total,x,amount,userContextItems,displayTemplateUrl;model.Items=model.Items.concat(digiConfigItems);model.Items.push({Key:"SP Call Count",Value:Akumina.AddIn.Logger.getSPCallCount(),IsHeading:!1});total=0;for(x in localStorage)localStorage[x]!=null&&(amount=localStorage[x].length/524288,$.isNumeric(amount)&&(total+=amount));model.Items.push({Key:"LocalStorage cache size",Value:total.toFixed(2)+"MB",IsHeading:!1});userContextItems=[];userContextItems=CoreSteps.DisplayDebugInformation.GetUserContextHTML(userContext,userContextItems);model.Items=model.Items.concat(userContextItems);displayTemplateUrl=(new Akumina.Digispace.AppPart.Data).Templates.GetCoreTemplate("DebugPopup.html");(new Akumina.Digispace.AppPart.Data).Templates.FindAndRender(displayTemplateUrl,"#debug-popup",model,null,CoreSteps.DisplayDebugInformation.DisplayDebugPopup)},Utilities}();AddIn.Utilities=Utilities;Cache=function(){function Cache(){}var MissCount=0;return Cache.Set=function(key,value,time){return Akumina.AddIn.Logger.WriteInfoLog("CACHE SET: "+key),MissCount++,time&&time!=null&&time>0?lscache.set(key,value,time):void 0},Cache.Get=function(key){return Akumina.AddIn.Logger.WriteInfoLog("CACHE GET: "+key),lscache.get(key)},Cache.Remove=function(key){return Akumina.AddIn.Logger.WriteInfoLog("CACHE REMOVE: "+key),lscache.remove(key)},Cache.GetMisses=function(){return MissCount},Cache}();AddIn.Cache=Cache;Constants=function(){function Constants(){}return Constants.MIN_CACHE_EXPIRATION=1,Constants.SHORT_CACHE_EXPIRATION=5,Constants.CACHE_EXPIRATION=10,Constants.HOUR_CACHE_EXPIRATION=60,Constants.TWOHOUR_CACHE_EXPIRATION=120,Constants.LONG_CACHE_EXPIRATION=360,Constants.DAY_CACHE_EXPIRATION=1440,Constants}();AddIn.Constants=Constants})(AddIn=Akumina.AddIn||(Akumina.AddIn={}))}(Akumina||(Akumina={})),Akumina===undefined&&(Akumina={}),Akumina.AppParts===undefined&&(Akumina.AppParts={}),Akumina.AppParts.Banner===undefined&&(Akumina.AppParts.Banner=function(options){var me=this;me.targetDiv="";this.uniqueId="";this.webPartTheme="";this.slideDuration=3e3;this.transitionEffect="fade";this.showNavigator=!0;this.autoPlay=!0;this.infiniteLoop=!0;this.Init=function(options){var me=this,senderId,webPartIframe,owl;this.uniqueId=options.UniqueId;this.hosted=options.apppart;this.targetDiv="."+this.uniqueId;this.slideDuration=options.options.slideduration;this.transitionEffect=options.options.transitioneffect;this.showNavigator=options.options.shownavigator;this.autoPlay=options.options.autoplay;this.infiniteLoop=options.options.infiniteloop;this.webPartTheme=options.options.webparttheme;senderId=this.uniqueId;this.hosted==!0?(webPartIframe=$("iframe[src*='SenderId%3D"+senderId+"']"),webPartIframe.length==0&&(webPartIframe=$("iframe[src*='SenderId%253D"+senderId+"']")),this.targetDiv="#"+$(webPartIframe).parents(".ms-WPBody").attr("id")+" .interAction"):this.targetDiv="#"+this.uniqueId+" .interAction";$(me.targetDiv).addClass(this.webPartTheme);$(me.targetDiv+" .ia-banner-item").length<2&&(me.autoPlay=!1,me.showNavigator=!1);$(" .ia-banner-slides",me.targetDiv).owlCarousel({autoplayHoverPause:!1,smartSpeed:500,dotsEach:!0,navContainer:".ia-banner-nav",dotsContainer:".ia-banner-dots",navText:['<span class="ia-banner-prev fa fa-chevron-left"><\/span>','<span class="ia-banner-next fa fa-chevron-right"><\/span>'],items:1,autoplaySpeed:500,mouseDrag:$(".ia-banner-item").length<2?!1:!0,singleItem:$(".ia-banner-item").length<2?!0:!1,loop:typeof me.infiniteLoop!="undefined"?me.infiniteLoop:!1,autoplay:typeof me.autoPlay!="undefined"?me.autoPlay:!1,autoplayTimeout:typeof me.slideDuration!="undefined"?me.slideDuration:5e3,nav:me.showNavigator,dots:me.showNavigator,animateOut:typeof me.transitionEffect!="undefined"?me.transitionEffect.toLowerCase()=="fade"?"fadeOut":me.transitionEffect.toLowerCase()=="vertical"?"owl-goDown-out":!1:!1,animateIn:typeof me.transitionEffect!="undefined"?me.transitionEffect.toLowerCase()=="fade"?"fadeIn":me.transitionEffect.toLowerCase()=="vertical"?"owl-goDown-in":!1:!1});me.autoPlay!=!1?(owl=$(me.targetDiv+" .ia-banner-slides"),$(me.targetDiv+" .ia-banner-play-control").click(function(){owl.trigger("play.owl.autoplay",[1e3])}),$(me.targetDiv+" .ia-banner-pause-control").click(function(){owl.trigger("stop.owl.autoplay")})):$(me.targetDiv+" .ia-banner-pause").hide();$(me.targetDiv+" .ia-banner-content span:empty").parent().hide()};this.Init(options)}),Akumina===undefined&&(Akumina={}),Akumina.AppParts===undefined&&(Akumina.AppParts={}),Akumina.AppParts.DocumentsSummaryList===undefined&&(Akumina.AppParts.DocumentsSummaryList=function(options){var me=this;this.Init=function(options){var me=this,senderId,webPartIframe;this.uniqueId=options.UniqueId;this.targetDiv="."+this.uniqueId;this.targetDivObject="";this.resultTemplateJson=options.options.dataJSON;Tabs.init();senderId=this.uniqueId;webPartIframe=$("iframe[src*='SenderId%3D"+senderId+"']");webPartIframe.length==0&&(webPartIframe=$("iframe[src*='SenderId%253D"+senderId+"']"));this.targetDiv="#"+$(webPartIframe).parents(".ms-WPBody").attr("id")+" .interAction:first";this.targetDivObject=$(this.targetDiv);$(this.targetDivObject).find(".ia-site-summary-list").addClass("tablesorter");$(this.targetDivObject).find(".ia-site-summary-list").tablesorter();$(this.targetDivObject).find(".ia-transformer-tab-nav li a").each(function(){$(this).html()==""&&$(this).hide()});options.options.currentsite&&$(this.targetDivObject).find("table.ia-site-summary-list td:nth-child(2),table.ia-site-summary-list th:nth-child(2)").hide();me.OrderTabs()};this.OrderTabs=function(){var tabs=$(this.targetDivObject).find(".ia-transformer-tab-nav li"),firstTab,firstTabLink,tabHash;for(i=tabs.length-1;i>=0;i--){var thisControl=$(this.targetDivObject).find(".ia-transformer-tab-nav li[data-position='"+i+"']"),thisControlPos=$(thisControl).data("position"),tabsAgain=$(this.targetDivObject).find(".ia-transformer-tab-nav li");$(thisControl).insertBefore($(tabsAgain)[0])}firstTab=$(this.targetDivObject).find(".ia-transformer-tab-nav li").first();$(firstTab).addClass("ia-tab-active");firstTabLink=$(firstTab).find("a");$(firstTabLink).addClass("ia-tab-active-link");tabHash=$(firstTabLink).attr("href");Tabs.changeTab(tabHash)};this.Init(options)}),Akumina===undefined&&(Akumina={}),Akumina.AppParts===undefined&&(Akumina.AppParts={}),Akumina.AppParts.QuickLinks===undefined&&(Akumina.AppParts.QuickLinks=function(options){var me=this;me.targetDiv="";this.uniqueId="";this.Init=function(options){var me=this,senderId,webPartIframe,flyout;this.uniqueId=options.UniqueId;this.targetDiv="."+this.uniqueId;senderId=this.uniqueId;options.options.hosted==!0?(webPartIframe=$("iframe[src*='SenderId%3D"+senderId+"']"),webPartIframe.length==0&&(webPartIframe=$("iframe[src*='SenderId%253D"+senderId+"']")),$(webPartIframe).hide(),$(webPartIframe).parents(".ms-WPBody").attr("id")==undefined&&$(webPartIframe).parents(".ms-WPBody").attr("id",senderId),this.targetDiv="#"+$(webPartIframe).parents(".ms-WPBody").attr("id")+" .interAction",this.targetDivObject=$(this.targetDiv)):(this.targetDiv="#"+this.uniqueId+" .interAction",this.targetDivObject=$(this.targetDiv));$(this.targetDivObject).find(".ia-top-nav > ul > li:has(ul)").addClass("hasSubmenu");$(this.targetDivObject).find(".ia-top-nav > ul > li.hasSubmenu > .ia-dropdown-trigger").click(function(e){$(this).parent("li").is(":not(.menuActive)")?($(".ia-top-nav ul li.hasSubmenu ul").slideUp("fast"),$(".ia-top-nav ul li.hasSubmenu").removeClass("menuActive"),$(this).siblings("ul").slideDown("fast"),$(this).parent("li").addClass("menuActive")):$(this).parent("li").hasClass("menuActive")&&($(this).siblings("ul").slideUp("fast"),$(this).parent("li").removeClass("menuActive"));e.preventDefault()});$(document).on("click",function(event){$(event.target).closest(".ia-top-nav ul li.hasSubmenu").length||($(".ia-top-nav ul li.hasSubmenu ul").slideUp("fast"),$(".ia-top-nav ul li.hasSubmenu").removeClass("menuActive"))});$(this.targetDivObject).find(".ia-top-nav > ul li ul > li:has(ul)").addClass("hasSubmenu");$(this.targetDivObject).find(".ia-top-nav > ul li ul > li.hasSubmenu > .ia-dropdown-trigger").click(function(e){$(this).parent("li").is(":not(.menuActive)")?($(".ia-top-nav ul li ul li.hasSubmenu ul").slideUp("fast"),$(".ia-top-nav ul li ul li.hasSubmenu").removeClass("menuActive"),$(this).siblings("ul").slideDown("fast"),$(this).parent("li").addClass("menuActive")):$(this).parent("li").hasClass("menuActive")&&($(this).siblings("ul").slideUp("fast"),$(this).parent("li").removeClass("menuActive"));e.preventDefault()});$(this.targetDivObject).find(".ia-top-nav > ul > li.hasSubmenu > ul li a").click(function(){$(this).parent().siblings("li.hasSubmenu").removeClass("menuActive")});$(document).on("click",function(event){$(event.target).closest(".ia-top-nav ul li.hasSubmenu ul li.hasSubmenu").length||($(".ia-top-nav ul li.hasSubmenu ul li.hasSubmenu ul").slideUp("fast"),$(".ia-top-nav ul li.hasSubmenu ul li.hasSubmenu ul").removeClass("menuActive"))});$(this.targetDivObject).find(".ia-quicklinks-level-1 li .ia-quicklink-flyout-trigger").unbind();$(this.targetDivObject).find(".ia-quicklinks-level-1 li .ia-quicklink-flyout-trigger").click(function(e){$(this).siblings(".ia-quicklink-cols").is(":not(:visible)")?($(".ia-quicklink-cols").fadeOut(),$(".ia-quicklinks-level-3").fadeOut(),$(".ia-quicklinks-level-1 > li .ia-quicklink-flyout-trigger").removeClass("menu-active"),$(this).siblings(".ia-quicklink-cols").fadeIn(),$(this).addClass("menu-active")):$(this).siblings(".ia-quicklink-cols").is(":visible")&&($(this).siblings(".ia-quicklink-cols").fadeOut(),$(".ia-quicklinks-level-3").fadeOut(),$(this).removeClass("menu-active"));e.preventDefault()});$(this.targetDivObject).find(".ia-quicklinks-level-2 .ia-quicklink-sublevel").click(function(e){$(this).siblings(".ia-quicklinks-level-3").is(":not(:visible)")?($(".ia-quicklinks-level-3").fadeOut(),$(".ia-quicklinks-level-2 .ia-quicklink-sublevel").removeClass("menu-active"),$(this).siblings(".ia-quicklinks-level-3").fadeIn(),$(this).addClass("menu-active")):$(this).siblings(".ia-quicklinks-level-3").is(":visible")&&($(this).siblings(".ia-quicklinks-level-3").fadeOut(),$(this).removeClass("menu-active"));e.preventDefault()});$(document).on("click",function(event){$(event.target).closest(".ia-quicklinks, .ia-quicklink-cols").length||($(".ia-quicklink-cols").fadeOut(),$(".ia-quicklinks-level-1 > li .ia-quicklink-flyout-trigger").removeClass("menu-active"))});$(this.targetDivObject).find(".ia-quicklinks-level-1 > li .ia-quicklink-cols.category-cols").each(function(){var count=$(this).children(".ia-quicklink-col").length;$(this).addClass("ia-cols-"+count)});$(this.targetDivObject).find(".ia-dept-nav-menu ul > li:has(ul)").addClass("ia-dept-nav-submenu");$(this.targetDivObject).find(".ia-dept-nav-menu ul > li:has(ul) > span").addClass("ia-dept-sublevel-trigger");$(this.targetDivObject).find(".ia-top-nav li a").each(function(){$(this).attr("href")==""&&$(this).removeAttr("href")});$(this.targetDivObject).parent().find(".ak-col-template .ak-dept-nav").length>0;$(this.targetDivObject).parent().find(".ak-col-template .ak-dept-nav").append($(".interAction.flyOut"));$(this.targetDivObject).parent().find(".ia-dept-nav-menu ul > li:has(ul)").addClass("ia-dept-nav-submenu");$(this.targetDivObject).parent().find(".ia-dept-nav-menu ul > li:has(ul) > span").addClass("ia-dept-sublevel-trigger");$(this.targetDivObject.parent()).find(".ia-dept-nav-trigger").click(function(){$(".ia-dept-nav-wrapper").toggleClass("ia-show-dept-nav");$(".ia-dept-nav-wrapper").fadeToggle();$(".ia-dept-nav-wrapper").css({height:$(".ak-col-template").height()+"px"});$(".ia-dept-nav-wrapper").css({width:$(".ak-col-template").width()+"px"})});$(this.targetDivObject).parent().find(".ia-dept-nav-close").click(function(){$(".ia-dept-nav-wrapper").removeClass("ia-show-dept-nav");$(".ia-dept-nav-wrapper").fadeOut()});$(this.targetDivObject).parent().find(".ia-dept-sublevel-trigger").click(function(){$(this).siblings("ul").slideToggle();$(this).toggleClass("ia-dept-sublevel-active")});flyout=$(this.targetDivObject).parent().find(".interAction.flyOut");flyout.length>0&&$(".ak-col-template .ak-dept-nav").append($(flyout))};this.Init(options)}),__extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},function(Akumina){var AddIn;(function(AddIn){var AnnouncementDetailResponse=function(){function AnnouncementDetailResponse(){}return AnnouncementDetailResponse}(),AnnouncementDetailRequest,AnnouncementDetail;AddIn.AnnouncementDetailResponse=AnnouncementDetailResponse;AnnouncementDetailRequest=function(){function AnnouncementDetailRequest(){}return AnnouncementDetailRequest}(AddIn.BaseRequest);AddIn.AnnouncementDetailRequest=AnnouncementDetailRequest;AnnouncementDetail=function(){function AnnouncementDetail(AnnouncementDetailRequest){this.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));this.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));this.AnnouncementDetailRequest=AnnouncementDetailRequest;this.AnnouncementDetailRequest.EditMode=Akumina.AddIn.Utilities.getEditMode()}return AnnouncementDetail.prototype.getItem=function(){var context=new SP.ClientContext.get_current,me=this,web,parentContext;this.AnnouncementDetailRequest.Hosted?(parentContext=new SP.AppContextSite(context,this.hostUrl),web=parentContext.get_web()):web=context.get_web();var list=web.get_lists().getByTitle(this.AnnouncementDetailRequest.ListName),camlQuery=new SP.CamlQuery,query="<View><Query><Where><Eq><FieldRef Name='Title'/><Value Type='Text'>"+this.AnnouncementDetailRequest.FriendlyUrl+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>";camlQuery.set_viewXml(query);this.listItems=list.getItems(camlQuery);context.load(this.listItems,"Include("+Akumina.AddIn.Configuration.getSelectFields("AnnouncementDetail").join()+")");Akumina.AddIn.Logger.logSPCall("AnnouncementDetail.prototype.getItem");context.executeQueryAsync(Function.createDelegate(me,me.success),Function.createDelegate(me,me.error))},AnnouncementDetail.prototype.success=function(){for(var listEnumerator=this.listItems.getEnumerator(),model=new AnnouncementDetailResponse,dtCreated;listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),itemId=0,title="",summary="",body="",url="",expires="",created="",startDate="",seoTitle="",seoKeywords="",seoDescription="";if(itemId=listItem.get_item("ID"),title=listItem.get_item("Title"),summary=listItem.get_item("Summary"),body=listItem.get_item("Body"),url=listItem.get_item("FriendlyUrl"),expires=listItem.get_item("Expires"),created=listItem.get_item("Created"),startDate=listItem.get_item("Start_x0020_Date"),seoTitle=listItem.get_item("Seo_x002d_Title"),seoKeywords=listItem.get_item("Seo_x002d_Keywords"),seoDescription=listItem.get_item("Seo_x002d_Description"),Akumina.AddIn.Utilities.ItemExpired(expires))break;if(!Akumina.AddIn.Utilities.ItemStarted(startDate))break;model.Id=itemId;model.Title=title;model.Body=body;model.SEOTitle=seoTitle;model.SEOKeywords=seoKeywords;model.SEODescription=seoDescription;created&&created!=""&&(dtCreated=moment(created),model.CreatedDateTime=dtCreated,model.Created=dtCreated.format("MMMM DD, YYYY"))}model.SenderId=this.AnnouncementDetailRequest.SenderId;model.Hosted=this.AnnouncementDetailRequest.Hosted;this.AnnouncementDetailRequest.EditMode||this.render(this.AnnouncementDetailRequest.DisplayTemplateUrl,model)},AnnouncementDetail.prototype.error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},AnnouncementDetail.prototype.render=function(templateUri,data){$.ajax(templateUri).done(function(template){var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){data.Hosted?($("body").html(data.Html),AKSenderData.options={seoTitle:data.SEOTitle,seoKeywords:data.SEOKeywords,seoDescription:data.SEODescription},AKNotifyParent(data.SenderId)):($("#"+data.SenderId).html(data.Html),data.SEOTitle&&data.SEOTitle!=""&&(document.title=data.SEOTitle),data.SEOKeywords&&data.SEOKeywords!=""&&($("meta[name=keywords]").remove(),$("head").append('<meta name="keywords" content="">'),$("meta[name=keywords]").attr("content",data.SEOKeywords)),data.SEODescription&&data.SEODescription!=""&&($("meta[name=description]").remove(),$("head").append('<meta name="description" content="">'),$("meta[name=description]").attr("content",data.SEODescription)))})},AnnouncementDetail}();AddIn.AnnouncementDetail=AnnouncementDetail})(AddIn=Akumina.AddIn||(Akumina.AddIn={}))}(Akumina||(Akumina={})),Akumina===undefined&&(Akumina={}),Akumina.AppParts===undefined&&(Akumina.AppParts={}),Akumina.AppParts.Calendar===undefined&&(Akumina.AppParts.Calendar=function(options){var me=this;this.Init=function(options){var me=this,currentDate,senderId,webPartIframe,categoryOptions,i;for(this.uniqueId=options.UniqueId,this.hosted=options.apppart,this.targetDiv="."+this.uniqueId,this.resultTemplateJson=options.options.dataJSON,this.tertiaryRedirect=!1,currentDate=new Date,senderId=this.uniqueId,this.hosted==!0?(webPartIframe=$("iframe[src*='SenderId%3D"+senderId+"']"),webPartIframe.length==0&&(webPartIframe=$("iframe[src*='SenderId%253D"+senderId+"']"),this.tertiaryRedirect=!0),this.targetDiv="#"+$(webPartIframe).parents(".ms-WPBody").attr("id")+" .interAction"):(this.targetDiv="#"+this.uniqueId+" .interAction",currentDate=new Date(this.resultTemplateJson.Year,this.resultTemplateJson.Month-1,1)),$(this.targetDiv).siblings("input[name$='hdnMonthValue']").length==0&&$(me.targetDiv).parent().append("<input type='hidden' name='hdnMonthValue' value='"+(currentDate.getMonth()+1)+"'/>"),$(this.targetDiv).siblings("input[name$='hdnYearValue']").length==0&&$(me.targetDiv).parent().append("<input type='hidden' name='hdnYearValue' value='"+currentDate.getFullYear()+"'/>"),$(this.targetDiv).siblings("input[name$='hdnCategoryValue']").length==0&&$(me.targetDiv).parent().append("<input type='hidden' name='hdnCategoryValue' value='"+this.resultTemplateJson.Category+"'/>"),$($(this.targetDiv+" .ia-cal-year-nav .ia-cal-year-months li")[this.resultTemplateJson.Month-1]).addClass("ia-cal-current"),categoryOptions=$(this.targetDiv+" .ia-cal-categories option"),i=0;i<categoryOptions.length;i++)if(categoryOptions[i].value.toLowerCase()==this.resultTemplateJson.Category.toLowerCase()){$(this.targetDiv+" .ia-cal-categories").val(categoryOptions[i].value);break}$(this.targetDiv+" .ia-cal-year-nav .ia-cal-year-months li a").click({obj:me},function(e){var dateValue=$(this).data("date");me.SetDate(dateValue);e.preventDefault()});$(this.targetDiv+" .ia-cal-year-nav .ia-cal-year-header .ia-cal-prev").click({obj:me},function(){me.PreviousYear()});$(this.targetDiv+" .ia-cal-year-nav .ia-cal-year-header .ia-cal-next").click({obj:me},function(){me.NextYear()});$(this.targetDiv+" .ia-cal-categories").change({obj:me},function(){var selectedValue=$(this).val();me.Filter(selectedValue)});$(this.targetDiv+" .ia-cal-header .ia-cal-month-nav .ia-cal-prev").click({obj:me},function(){me.PreviousMonth()});$(this.targetDiv+" .ia-cal-header .ia-cal-month-nav .ia-cal-next").click({obj:me},function(){me.NextMonth()});$(this.targetDiv+" .ia-cal-header .ia-cal-view-toggle .ia-cal-grid-view").click({obj:me},function(){me.SetView("month")});$(this.targetDiv+" .ia-cal-header .ia-cal-view-toggle .ia-cal-list-view").click({obj:me},function(){me.SetView("list")});$(this.targetDiv+" .ia-cal-header .ia-cal-current-month").click({obj:me},function(){$(me.targetDiv+" .ia-cal-year-nav").toggleClass("ia-cal-year-nav-modal")});$(this.targetDiv+" .ia-cal-close").click({obj:me},function(){$(me.targetDiv+" .ia-cal-year-nav").removeClass("ia-cal-year-nav-modal")});$(this.targetDiv+" .ia-cal-year-nav").click({obj:me},function(e){$(this).hasClass("ia-cal-year-nav-modal")&&e.target==this&&$(me.targetDiv+" .ia-cal-year-nav").removeClass("ia-cal-year-nav-modal")});var monthField=$(me.targetDiv).siblings("input[name$='hdnMonthValue']"),yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),selectedYear=$(yearField).val(),selectedMonth=$(monthField).val(),parsedMonth=parseInt(selectedMonth);parsedMonth<10&&(selectedMonth="0"+selectedMonth.toString());$(this.targetDiv+" .ia-cal-grid .ia-calendar-grid").fullCalendar({header:{left:"",center:"",right:""},fixedWeekCount:!1,defaultDate:selectedYear+"-"+selectedMonth+"-01",eventSources:[{events:function(start,end,timezone,callback){for(var parsedEnd,endTime,events=[],i=0;i<me.resultTemplateJson.Events.length;i++){var event=me.resultTemplateJson.Events[i],fcioEvent={title:event.Title,url:event.Url},parsedStart=moment(event.StartDateUTC),startTime=parsedStart.hours()<10?"0"+parsedStart.hours().toString():parsedStart.hours();startTime+=":";startTime+=parsedStart.minutes()<10?"0"+parsedStart.minutes().toString():parsedStart.minutes();parsedEnd=moment(event.EndDateUTC);endTime=parsedEnd.hours()<10?"0"+parsedEnd.hours().toString():parsedEnd.hours();endTime+=":";endTime+=parsedEnd.minutes()<10?"0"+parsedEnd.minutes().toString():parsedEnd.minutes();fcioEvent.start=parsedStart.format("YYYY-MM-DD");event.AllDay?fcioEvent.start=parsedStart.utc().format("YYYY-MM-DD"):event.AllDay||(fcioEvent.start+="T"+startTime);fcioEvent.end=parsedEnd.format("YYYY-MM-DD");event.AllDay?fcioEvent.end=parsedEnd.utc().add(1,"d").format("YYYY-MM-DD"):event.AllDay||(fcioEvent.end+="T"+endTime);events.push(fcioEvent)}callback(events)}}],eventClick:function(event){return event.url&&(location.href=event.url),!1}});me.SetView()};this.FormatDate=function(dateValue){dateValue=dateValue.replace("/Date(","").replace(")/","");var dateTicks=parseInt(dateValue),parsedDate=new Date(dateTicks);return parsedDate.getYear()+"-"+(parsedDate.getMonth()+1)+parsedDate.getDay()};this.ShowOverlay=function(){var overlay=$("body #ia-calendar-overlay"),docHeight;$(overlay).length==0&&(docHeight=$(document).height(),$("body").append("<div id='ia-calendar-overlay'><\/div>"),$("#ia-calendar-overlay").height(docHeight).css({opacity:.4,position:"absolute",top:0,left:0,"background-color":"black",width:"100%","z-index":5e3}))};this.HideOverlay=function(){$("body #ia-calendar-overlay").remove()};this.SetDate=function(dateValue){var dateSplit=dateValue.split("-"),monthField,yearField;dateSplit.length==2&&(monthField=$(me.targetDiv).siblings("input[name$='hdnMonthValue']"),yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),$(yearField).val(parseInt(dateSplit[0])),$(monthField).val(parseInt(dateSplit[1])),me.UpdateView())};this.PreviousYear=function(){var yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),oldValue=parseInt($(yearField).val()),newValue=oldValue-1;$(yearField).val(newValue);me.UpdateView()};this.NextYear=function(){var yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),oldValue=parseInt($(yearField).val()),newValue=oldValue+1;$(yearField).val(newValue);me.UpdateView()};this.PreviousMonth=function(){var monthField=$(me.targetDiv).siblings("input[name$='hdnMonthValue']"),yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),currentMonthValue=parseInt($(monthField).val()),currenYearValue=parseInt($(yearField).val());currentMonthValue==1?($(monthField).val(12),$(yearField).val(currenYearValue-1)):$(monthField).val(currentMonthValue-1);me.UpdateView()};this.NextMonth=function(){var monthField=$(me.targetDiv).siblings("input[name$='hdnMonthValue']"),yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),currentMonthValue=parseInt($(monthField).val()),currenYearValue=parseInt($(yearField).val());currentMonthValue==12?($(monthField).val(1),$(yearField).val(currenYearValue+1)):$(monthField).val(currentMonthValue+1);me.UpdateView()};this.SetView=function(view){view==null&&(view=localStorage.calendarView,(view==null||view=="")&&(view="month"));view=="list"?($(me.targetDiv+" .fc-view-container").hide(),$(me.targetDiv+" .ia-cal-list").show(),localStorage.calendarView="list"):($(me.targetDiv+" .fc-view-container").show(),$(me.targetDiv+" .ia-cal-list").hide(),localStorage.calendarView="month")};this.UpdateView=function(){var interiorRedirectUrl,container,props,Calendar;this.ShowOverlay();var catField=$(me.targetDiv).siblings("input[name$='hdnCategoryValue']"),monthField=$(me.targetDiv).siblings("input[name$='hdnMonthValue']"),yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),catValue=$(catField).val(),monthValue=$(monthField).val(),yearValue=$(yearField).val();if(window.location.hash="#caldate="+yearValue+"-"+monthValue,this.hosted){var iframeObj=document.getElementById($(me.targetDiv).parent().find("iframe").attr("id")),iframeUrl=iframeObj.src,redirectUrl=decodeURIComponent(getquerystringparam(iframeUrl,"redirect_uri",""));this.tertiaryRedirect?(interiorRedirectUrl=decodeURIComponent(getquerystringparam(redirectUrl,"redirect_uri","")),interiorRedirectUrl=this.UpdateQueryStringParam(interiorRedirectUrl,"c",catValue),interiorRedirectUrl=this.UpdateQueryStringParam(interiorRedirectUrl,"m",monthValue),interiorRedirectUrl=this.UpdateQueryStringParam(interiorRedirectUrl,"y",yearValue),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"redirect_uri",encodeURIComponent(interiorRedirectUrl))):(redirectUrl=this.UpdateQueryStringParam(redirectUrl,"c",catValue),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"m",monthValue),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"y",yearValue));iframeUrl=updatequerystringparam(iframeUrl,"redirect_uri",encodeURIComponent(redirectUrl));iframeObj.src=iframeUrl}else container=$("#"+this.uniqueId),props=Akumina.AddIn.Utilities.getProperties($(container)),props.StartDate=new Date(yearValue,monthValue-1,1),props.category=catValue,Calendar=new Akumina.AddIn.CalendarWidget,Calendar.Init(props),Calendar.Render(),this.HideOverlay()};this.Filter=function(filter){var categoryField=$(me.targetDiv).siblings("input[name$='hdnCategoryValue']");$(categoryField).val(filter);me.UpdateView()};this.UpdateQueryStringParam=function(uri,key,value){var re=new RegExp("([?&])"+key+"=.*?(&|$)","i"),separator=uri.indexOf("?")!==-1?"&":"?";return uri.match(re)?uri.replace(re,"$1"+key+"="+value+"$2"):uri+separator+key+"="+value};this.Init(options)}),Akumina===undefined&&(Akumina={}),Akumina.AppParts===undefined&&(Akumina.AppParts={}),Akumina.AppParts.EventDetail===undefined&&(Akumina.AppParts.EventDetail=function(options){var me=this;this.Init=function(options){var me=this,calendarEvent;this.uniqueId=options.uniqueId;this.targetDiv="."+options.uniqueId;calendarEvent=options.options.event;$(".ia-event-detail-ics").click({param1:calendarEvent},this.GetICS)};this.GetICS=function(event){var calendarEvent=event.data.param1,todayDate=new Date,msgData=todayDate.toISOString(),startDate=todayDate.toISOString(),endDate=todayDate.toISOString(),title=calendarEvent.Title,filename=calendarEvent.FileName,location=calendarEvent.Location,body,startDateFormat,endDateFormat;location==null&&(location="");body=calendarEvent.Body;body==null&&(body="");var bodyText=$("<div/>").html(body.replace(/<(?:.|\n)*?>/gm,"")).text(),allDay=calendarEvent.AllDay,startDate=calendarEvent.StartDateUTC,endDate=calendarEvent.EndDateUTC,icsMSG="";if(icsMSG+="BEGIN:VCALENDAR\r\n",icsMSG+="PRODID:-//Microsoft Corporation//Outlook 16.0 MIMEDIR//EN\r\n",icsMSG+="VERSION:2.0\r\n",icsMSG+="METHOD:PUBLISH\r\n",icsMSG+="BEGIN:VEVENT\r\n",icsMSG+="UID;TYPE=SharePoint:1\r\n",icsMSG+="DTSTAMP:"+msgData+"Z\r\n",allDay){var startTLocation=startDate.indexOf("T"),endTLocation=endDate.indexOf("T"),startDateOnly=startDate.substring(0,startTLocation).replace(/-/g,""),endDateOnly=moment(endDate.substring(0,endTLocation)).add(1,"days").format("YYYYMMDD");icsMSG+="DTEND;VALUE=DATE:"+endDateOnly+"\r\n";icsMSG+="DTSTART;VALUE=DATE:"+startDateOnly+"\r\n"}else startDateFormat=moment.utc(startDate).format("YYYYMMDDTHHmm00")+"z",endDateFormat=moment.utc(endDate).format("YYYYMMDDTHHmm00")+"z",icsMSG+="DTEND;VALUE=DATE:"+endDateFormat+"\r\n",icsMSG+="DTSTART;VALUE=DATE:"+startDateFormat+"\r\n";return icsMSG+="LOCATION;ENCODING=8BIT;CHARSET=utf-8:"+location+"\r\n",icsMSG+="SEQUENCE:0\r\n",icsMSG+="SUMMARY;LANGUAGE=en-us:"+title+"\r\n",icsMSG+="X-ALT-DESC;FMTTYPE=text/html:"+body+"\r\n",icsMSG+="CLASS:PUBLIC\r\n",icsMSG+="END:VEVENT\r\n",icsMSG+="END:VCALENDAR",saveAs(new Blob([icsMSG],{type:"text/calendar;charset=utf8"}),filename+".ics"),!1};this.Init(options)}),Akumina===undefined&&(Akumina={}),Akumina.AppParts===undefined&&(Akumina.AppParts={}),Akumina.AppParts.CompanyCalendar===undefined&&(Akumina.AppParts.CompanyCalendar=function(options){var me=this;this.Init=function(options){function checkPopupElement(element,show){show?$(element).parent().show():$(element).parent().hide()}function convertICS(event,isGrid){var todayDate=new Date,msgData=todayDate.toISOString(),startDate=todayDate.toISOString(),endDate=todayDate.toISOString(),startDateFormat,endDateFormat;if(isGrid)var title=event.Title,filename=title,body=body=event.Body!=""?$(event.Body).filter("#divtagdefaultwrapper").prop("outerHTML").replace(/(?:\r\n|\r|\n)/g,""):"",allDay=event.AllDay,startDateUTC=event.StartDateUTC,endDateUTC=event.EndDateUTC,location=event.Location;else var title=event.Title,filename=title,body=event.Body!=""?$(event.Body).filter("#divtagdefaultwrapper").prop("outerHTML").replace(/(?:\r\n|\r|\n)/g,""):"",allDay=event.AllDay,startDateUTC=event.StartDateUTC,endDateUTC=event.EndDateUTC,location=event.Location;body==null&&(body="");var bodyText=body,startDate=startDateUTC,endDate=endDateUTC,icsMSG="";if(icsMSG+="BEGIN:VCALENDAR\r\n",icsMSG+="PRODID:-//Microsoft Corporation//Outlook 16.0 MIMEDIR//EN\r\n",icsMSG+="VERSION:2.0\r\n",icsMSG+="METHOD:PUBLISH\r\n",icsMSG+="BEGIN:VEVENT\r\n",icsMSG+="UID;TYPE=SharePoint:1\r\n",icsMSG+="DTSTAMP:"+msgData+"Z\r\n",allDay){var startTLocation=startDate.indexOf("T"),endTLocation=endDate.indexOf("T"),startDateOnly=startDate.substring(0,startTLocation).replace(/-/g,""),endDateOnly=moment(endDate.substring(0,endTLocation)).format("YYYYMMDD 23:59:59");icsMSG+="DTEND;VALUE=DATE:"+endDateOnly+"\r\n";icsMSG+="DTSTART;VALUE=DATE:"+startDateOnly+"\r\n"}else startDateFormat=moment.utc(startDate).format("YYYYMMDDTHHmm00")+"z",endDateFormat=moment.utc(endDate).format("YYYYMMDDTHHmm00")+"z",icsMSG+="DTEND;VALUE=DATE:"+endDateFormat+"\r\n",icsMSG+="DTSTART;VALUE=DATE:"+startDateFormat+"\r\n";icsMSG+="LOCATION;ENCODING=8BIT;CHARSET=utf-8:"+location+"\r\n";icsMSG+="SEQUENCE:0\r\n";icsMSG+="SUMMARY;LANGUAGE=en-us:"+title+"\r\n";icsMSG+="X-ALT-DESC;FMTTYPE=text/html:"+body+"\r\n";icsMSG+="CLASS:PUBLIC\r\n";icsMSG+="END:VEVENT\r\n";icsMSG+="END:VCALENDAR";saveAs(new Blob([icsMSG],{type:"text/calendar;charset=utf8"}),filename+".ics")}var me=this,currentDate,senderId,webPartIframe;this.uniqueId=options.UniqueId;this.hosted=options.apppart;this.targetDiv="."+this.uniqueId;this.resultTemplateJson=options.options.dataJSON;this.tertiaryRedirect=!1;currentDate=new Date;senderId=this.uniqueId;this.hosted==!0?(webPartIframe=$("iframe[src*='SenderId%3D"+senderId+"']"),webPartIframe.length==0&&(webPartIframe=$("iframe[src*='SenderId%253D"+senderId+"']"),this.tertiaryRedirect=!0),this.targetDiv="#"+$(webPartIframe).parents(".ms-WPBody").attr("id")+" .interAction"):(this.targetDiv="#"+this.uniqueId+" .interAction",currentDate=new Date(this.resultTemplateJson.Year,this.resultTemplateJson.Month-1,1));$(this.targetDiv).siblings("input[name$='hdnMonthValue']").length==0&&$(me.targetDiv).parent().append("<input type='hidden' name='hdnMonthValue' value='"+(currentDate.getMonth()+1)+"'/>");$(this.targetDiv).siblings("input[name$='hdnYearValue']").length==0&&$(me.targetDiv).parent().append("<input type='hidden' name='hdnYearValue' value='"+currentDate.getFullYear()+"'/>");$(this.targetDiv).siblings("input[name$='hdnCategoryValue']").length==0&&$(me.targetDiv).parent().append("<input type='hidden' name='hdnCategoryValue' value='"+this.resultTemplateJson.Category+"'/>");$(this.targetDiv).siblings("input[name$='hdnCompanyCalendarToken']").length==0&&$(me.targetDiv).parent().append("<input type='hidden' name='hdnCompanyCalendarToken' value='"+this.resultTemplateJson.TokenURL+"'/>");$(this.targetDiv).siblings("input[name$='hdnCompanyCalendarGroupId']").length==0&&$(me.targetDiv).parent().append("<input type='hidden' name='hdnCompanyCalendarGroupId' value='"+this.resultTemplateJson.GroupId+"'/>");$(me.targetDiv+" .ia-cal-grid-view").bind("click",function(){$(me.targetDiv+" .ia-cal-grid-view").addClass("ia-current-view");$(me.targetDiv+" .ia-cal-list-view").removeClass("ia-current-view")});$(me.targetDiv+" .ia-cal-list-view").bind("click",function(){$(me.targetDiv+" .ia-cal-grid-view").removeClass("ia-current-view");$(me.targetDiv+" .ia-cal-list-view").addClass("ia-current-view")});$($(this.targetDiv+" .ia-cal-year-nav .ia-cal-year-months li")[this.resultTemplateJson.Month-1]).addClass("ia-cal-current");$(".ia-cal-event-title a").on("click",function(e){e.preventDefault();var eventObject=JSON.parse($(e.target).attr("data-object")),title=eventObject.Title,end=eventObject.end,start=eventObject.start,location=eventObject.Location,organizer=eventObject.Organizer,attachments=eventObject.Attachments,hasAttachments=eventObject.HasAttachments,body=eventObject.Body!=""&&$(eventObject.Body).filter("#divtagdefaultwrapper").prop("outerHTML").replace(/(?:\r\n|\r|\n)/g,"<br />").replace(/<(?:.|\n)*?>/gm,"").trim()!=""?eventObject.Body:"";title!=""?(checkPopupElement($("#ia-list-event-content .ia-event-title"),!0),$("#ia-list-event-content .ia-event-title").html(title)):checkPopupElement($("#ia-list-event-content .ia-event-title"),!1);end!=""?(checkPopupElement($("#ia-list-event-content .ia-event-end"),!0),$("#ia-list-event-content .ia-event-end").html(end)):checkPopupElement($("#ia-list-event-content .ia-event-end"),!1);start!=""?(checkPopupElement($("#ia-list-event-content .ia-event-start"),!0),$("#ia-list-event-content .ia-event-start").html(start)):checkPopupElement($("#ia-list-event-content .ia-event-start"),!1);location!=""?(checkPopupElement($("#ia-list-event-content .ia-event-location"),!0),$("#ia-list-event-content .ia-event-location").html(location)):checkPopupElement($("#ia-list-event-content .ia-event-location"),!1);organizer!=""?(checkPopupElement($("#ia-list-event-content .ia-event-organizer"),!0),$("#ia-list-event-content .ia-event-organizer").html(organizer)):checkPopupElement($("#ia-list-event-content .ia-event-organizer"),!1);hasAttachments?(checkPopupElement($("#ia-list-event-content .ia-event-item-attachments"),!0),$("#ia-list-event-content .ia-event-item-attachments a").attr("href",attachments)):checkPopupElement($("#ia-list-event-content .ia-event-item-attachments a"),!1);body!=""?(checkPopupElement($("#ia-list-event-content .ia-event-description"),!0),$("#ia-list-event-content .ia-event-description").html(body)):checkPopupElement($("#ia-list-event-content .ia-event-description"),!1);$("#ia-list-event-content .ia-download-event").unbind();$("#ia-list-event-content .ia-download-event").on("click",function(e){e.preventDefault();convertICS(eventObject,!1)});element=$("#ia-list-event-content");$.magnificPopup.open({items:{src:element},type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0,fixedBgPos:!0,closeOnContentClick:!1})});$(this.targetDiv+" .ia-cal-categories").val(this.resultTemplateJson.Category);$(this.targetDiv+" .ia-cal-year-nav .ia-cal-year-months li a").click({obj:me},function(e){var dateValue=$(this).data("date");me.SetDate(dateValue);e.preventDefault()});$(this.targetDiv+" .ia-cal-year-nav .ia-cal-year-header .ia-cal-prev").click({obj:me},function(){me.PreviousYear()});$(this.targetDiv+" .ia-cal-year-nav .ia-cal-year-header .ia-cal-next").click({obj:me},function(){me.NextYear()});$(this.targetDiv+" .ia-cal-categories").change({obj:me},function(){var selectedValue=$(this).val();me.Filter(selectedValue)});$(this.targetDiv+" .ia-cal-header .ia-cal-month-nav .ia-cal-prev").click({obj:me},function(){me.PreviousMonth()});$(this.targetDiv+" .ia-cal-header .ia-cal-month-nav .ia-cal-next").click({obj:me},function(){me.NextMonth()});$(this.targetDiv+" .ia-cal-header .ia-cal-view-toggle .ia-cal-grid-view").click({obj:me},function(){me.SetView("month")});$(this.targetDiv+" .ia-cal-header .ia-cal-view-toggle .ia-cal-list-view").click({obj:me},function(){me.SetView("list")});$(this.targetDiv+" .ia-cal-header .ia-cal-current-month").click({obj:me},function(){$(me.targetDiv+" .ia-cal-year-nav").toggleClass("ia-cal-year-nav-modal")});$(this.targetDiv+" .ia-cal-close").click({obj:me},function(){$(me.targetDiv+" .ia-cal-year-nav").removeClass("ia-cal-year-nav-modal")});$(this.targetDiv+" .ia-cal-year-nav").click({obj:me},function(e){$(this).hasClass("ia-cal-year-nav-modal")&&e.target==this&&$(me.targetDiv+" .ia-cal-year-nav").removeClass("ia-cal-year-nav-modal")});var monthField=$(me.targetDiv).siblings("input[name$='hdnMonthValue']"),yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),selectedYear=$(yearField).val(),selectedMonth=$(monthField).val(),parsedMonth=parseInt(selectedMonth);parsedMonth<10&&(selectedMonth="0"+selectedMonth.toString());$(this.targetDiv+" .ia-cal-grid .ia-calendar-grid").fullCalendar({header:{left:"",center:"",right:""},eventRender:function(event,element){element.magnificPopup({items:{src:"#ia-grid-event-content",type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0,fixedBgPos:!0,closeOnContentClick:!1}})},eventClick:function(event){function createPopupContent(eventParameter,eventClass){eventParameter?($(eventClass).html(eventParameter),$(eventClass).parent("[class^='ia-event-item-']").addClass("ia-populated")):eventParameter||$(eventClass).parent("[class^='ia-event-item-']").removeClass("ia-populated")}function createURLPopupContent(eventParameter,eventClass){eventParameter?($(eventClass).attr("href",eventParameter),$(eventClass).parent("[class^='ia-event-item-']").addClass("ia-populated")):eventParameter||$(eventClass).parent("[class^='ia-event-item-']").removeClass("ia-populated")}createPopupContent(event.title,"#ia-grid-event-content .ia-event-title");createPopupContent(event.description,"#ia-grid-event-content .ia-event-description");createPopupContent(event.location,"#ia-grid-event-content .ia-event-location");createPopupContent(event.start.format("ddd, MM/DD/YYYY, h:mm:ss a"),"#ia-grid-event-content .ia-event-start");createPopupContent(event.end.format("ddd, MM/DD/YYYY, h:mm:ss a"),"#ia-grid-event-content .ia-event-end");createPopupContent(event.organizer,"#ia-grid-event-content .ia-event-organizer");event.hasattachment&&createURLPopupContent(event.attachmentUrl,"#ia-grid-event-content .ia-event-item-attachments a");$("#ia-grid-event-content .ia-download-event").on("click",function(e){e.preventDefault();convertICS(JSON.parse(event.eventObject),!0)})},fixedWeekCount:!1,defaultDate:selectedYear+"-"+selectedMonth+"-01",eventSources:[{events:function(start,end,timezone,callback){for(var parsedEnd,endTime,events=[],i=0;i<me.resultTemplateJson.Events.length;i++){var event=me.resultTemplateJson.Events[i],fcioEvent={title:event.Title,url:event.Url,location:event.Location,organizer:event.Organizer,description:(event.Body!=""&&$(event.Body).filter("#divtagdefaultwrapper").prop("outerHTML").replace(/(?:\r\n|\r|\n)/g,"<br />").replace(/<(?:.|\n)*?>/gm,"").trim())!=""?event.Body:"",className:"ia-event-"+event.Color.toLowerCase(),attachmentUrl:event.Attachments,hasattachment:event.HasAttachments,eventObject:JSON.stringify(event)},parsedStart=moment(event.StartDateUTC),startTime=parsedStart.hours()<10?"0"+parsedStart.hours().toString():parsedStart.hours();startTime+=":";startTime+=parsedStart.minutes()<10?"0"+parsedStart.minutes().toString():parsedStart.minutes();parsedEnd=moment(event.EndDateUTC);endTime=parsedEnd.hours()<10?"0"+parsedEnd.hours().toString():parsedEnd.hours();endTime+=":";endTime+=parsedEnd.minutes()<10?"0"+parsedEnd.minutes().toString():parsedEnd.minutes();fcioEvent.start=parsedStart.format("YYYY-MM-DD");event.AllDay?fcioEvent.start=parsedStart.utc().format("YYYY-MM-DD"):event.AllDay||(fcioEvent.start+="T"+startTime);event.AllDay?(fcioEvent.end=parsedStart.utc().format("YYYY-MM-DD"),fcioEvent.end+="T23:59"):event.AllDay||(fcioEvent.end=parsedEnd.format("YYYY-MM-DD"),fcioEvent.end+="T"+endTime);events.push(fcioEvent)}callback(events)}}]});me.SetView()};this.FormatDate=function(dateValue){dateValue=dateValue.replace("/Date(","").replace(")/","");var dateTicks=parseInt(dateValue),parsedDate=new Date(dateTicks);return parsedDate.getYear()+"-"+(parsedDate.getMonth()+1)+parsedDate.getDay()};this.ShowOverlay=function(){var overlay=$("body #ia-calendar-overlay"),docHeight;$(overlay).length==0&&(docHeight=$(document).height(),$("body").append("<div id='ia-calendar-overlay'><\/div>"),$("#ia-calendar-overlay").height(docHeight).css({opacity:.4,position:"absolute",top:0,left:0,"background-color":"black",width:"100%","z-index":5e3}))};this.HideOverlay=function(){$("body #ia-calendar-overlay").remove()};this.SetDate=function(dateValue){var dateSplit=dateValue.split("-"),monthField,yearField;dateSplit.length==2&&(monthField=$(me.targetDiv).siblings("input[name$='hdnMonthValue']"),yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),$(yearField).val(parseInt(dateSplit[0])),$(monthField).val(parseInt(dateSplit[1])),me.UpdateView())};this.PreviousYear=function(){var yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),oldValue=parseInt($(yearField).val()),newValue=oldValue-1;$(yearField).val(newValue);me.UpdateView()};this.NextYear=function(){var yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),oldValue=parseInt($(yearField).val()),newValue=oldValue+1;$(yearField).val(newValue);me.UpdateView()};this.PreviousMonth=function(){var monthField=$(me.targetDiv).siblings("input[name$='hdnMonthValue']"),yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),currentMonthValue=parseInt($(monthField).val()),currenYearValue=parseInt($(yearField).val());currentMonthValue==1?($(monthField).val(12),$(yearField).val(currenYearValue-1)):$(monthField).val(currentMonthValue-1);me.UpdateView()};this.NextMonth=function(){var monthField=$(me.targetDiv).siblings("input[name$='hdnMonthValue']"),yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),currentMonthValue=parseInt($(monthField).val()),currenYearValue=parseInt($(yearField).val());currentMonthValue==12?($(monthField).val(1),$(yearField).val(currenYearValue+1)):$(monthField).val(currentMonthValue+1);me.UpdateView()};this.SetView=function(view){view==null&&(view=localStorage.calendarView,(view==null||view=="")&&(view="month"));view=="list"?($(me.targetDiv+" .fc-view-container").hide(),$(me.targetDiv+" .ia-cal-list").show(),localStorage.calendarView="list"):($(me.targetDiv+" .fc-view-container").show(),$(me.targetDiv+" .ia-cal-list").hide(),localStorage.calendarView="month")};this.UpdateView=function(){var interiorRedirectUrl,container,props,Calendar;this.ShowOverlay();var catField=$(me.targetDiv).siblings("input[name$='hdnCategoryValue']"),monthField=$(me.targetDiv).siblings("input[name$='hdnMonthValue']"),yearField=$(me.targetDiv).siblings("input[name$='hdnYearValue']"),tokenHashField=$(me.targetDiv).siblings("input[name$='hdnCompanyCalendarToken']"),groupIdField=$(me.targetDiv).siblings("input[name$='hdnCompanyCalendarGroupId']"),catValue=$(catField).val(),monthValue=$(monthField).val(),yearValue=$(yearField).val(),tokenHash=$(tokenHashField).val(),groupId=$(groupIdField).val();if(this.hosted){var iframeObj=document.getElementById($(me.targetDiv).parent().find("iframe").attr("id")),iframeUrl=iframeObj.src,redirectUrl=decodeURIComponent(getquerystringparam(iframeUrl,"redirect_uri",""));this.tertiaryRedirect?(interiorRedirectUrl=decodeURIComponent(getquerystringparam(redirectUrl,"redirect_uri","")),interiorRedirectUrl=this.UpdateQueryStringParam(interiorRedirectUrl,"c",catValue),interiorRedirectUrl=this.UpdateQueryStringParam(interiorRedirectUrl,"m",monthValue),interiorRedirectUrl=this.UpdateQueryStringParam(interiorRedirectUrl,"y",yearValue),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"redirect_uri",encodeURIComponent(interiorRedirectUrl))):(redirectUrl=this.UpdateQueryStringParam(redirectUrl,"c",catValue),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"m",monthValue),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"y",yearValue));iframeUrl=updatequerystringparam(iframeUrl,"redirect_uri",encodeURIComponent(redirectUrl));iframeObj.src=iframeUrl}else container=$("#"+this.uniqueId),props=Akumina.AddIn.Utilities.getProperties($(container)),props.StartDate=new Date(yearValue,monthValue,1),props.Category=catValue,Calendar=new Akumina.AddIn.CompanyCalendarWidget,Calendar.Init(props),Calendar.Render(),this.HideOverlay()};this.Filter=function(filter){var categoryField=$(me.targetDiv).siblings("input[name$='hdnCategoryValue']");$(categoryField).val(filter);me.UpdateView()};this.UpdateQueryStringParam=function(uri,key,value){var re=new RegExp("([?&])"+key+"=.*?(&|$)","i"),separator=uri.indexOf("?")!==-1?"&":"?";return uri.match(re)?uri.replace(re,"$1"+key+"="+value+"$2"):uri+separator+key+"="+value};this.Init(options)}),Akumina===undefined&&(Akumina={}),Akumina.AppParts===undefined&&(Akumina.AppParts={}),Akumina.AppParts.Form===undefined&&(Akumina.AppParts.Form=function(options){var me=this,postMessageElement="",formElement="";this.AttachmentFolder="";this.ExcludeAttachmentsInput=[];this.AttachmentsInput={};this.FormFields;this.CurrentStatus="";this.GetCurrentUsername=function(){var def=$.Deferred(),me=this,ctxt=new SP.ClientContext.get_current,web=ctxt.get_web();return me.currentUser=web.get_currentUser(),ctxt.load(me.currentUser),Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.GetCurrentUsername"),ctxt.executeQueryAsync(Function.createDelegate(me,function(){def.resolve(this.currentUser)}),Function.createDelegate(me,function(){def.reject()})),def};this.decodeBase64=function(string){return/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/.test(string)?decodeURIComponent(escape(window.atob(string))):string};this.UseDatePicker=function(element,value){element!=null?($(element).attr("type","text"),$(element).attr("subtype","date"),$(element).datepicker({dateFormat:"mm/dd/yy"}),$(element).datepicker("setDate",value)):($("input[type=date]").datepicker({dateFormat:"mm/dd/yy"}),$("input[type=date]").each(function(item,element){$(element).attr("type","text");$(element).attr("subtype","date")}))};this.addItemToFormSubmissions_AK=function(submissionID){var clientContext=new SP.ClientContext.get_current,site=clientContext.get_site(),rootSite=site.get_rootWeb(),oList=rootSite.get_lists().getByTitle("FormSubmissions_AK"),itemCreateInfo=new SP.ListItemCreationInformation,oListItem=oList.addItem(itemCreateInfo),objectForm=me.getFormObject(),success,error;oListItem.set_item("SiteId",objectForm.SiteId);oListItem.set_item("FormName",objectForm.ReferenceList);oListItem.set_item("FormID",objectForm.FormID);oListItem.set_item("SubmissionID",submissionID);success=function(){me.showPostMessageMessage()};error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("addItemToFormSubmissions_AK failed. "+args.get_message()+"\n"+args.get_stackTrace())};oListItem.update();clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.addItemToFormSubmissions_AK");clientContext.executeQueryAsync(Function.createDelegate(this,success),Function.createDelegate(this,error))};this.updateItemToFormSubmissions_AK=function(formItemObj){var OnItemError=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("updateItemToFormSubmissions_AK failed. "+args.get_message()+"\n"+args.get_stackTrace())},temObj={};temObj.ReferenceList="FormSubmissions_AK";temObj.FormID=formItemObj.FormID;temObj.ListItemId=formItemObj.ListItemId;$("#"+formItemObj.FormID+"_"+formItemObj.ListItemId).html()=="Rejected"&&$("#"+formItemObj.FormID+"_"+formItemObj.ListItemId).html("Pending");me.getFormData(temObj,function(oListItem){for(var OnItemError=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},listEnumerator=oListItem.getEnumerator(),listItem,clientContext;listEnumerator.moveNext();)listItem=listEnumerator.get_current(),listItem.set_item("Processed",0),me.CurrentStatus==2&&listItem.set_item("ProcessType","Terminate"),listItem.update(),clientContext=new SP.ClientContext.get_current,clientContext.load(listItem),Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.updateItemToFormSubmissions_AK"),clientContext.executeQueryAsync(Function.createDelegate(this,me.showPostMessageMessage),Function.createDelegate(this,OnItemError))},OnItemError,!0)};this.checkEmail=function(emailAddress){var sAtom="[^\\x00-\\x20\\x22\\x28\\x29\\x2c\\x2e\\x3a-\\x3c\\x3e\\x40\\x5b-\\x5d\\x7f-\\xff]+",sQuotedPair="\\x5c[\\x00-\\x7f]",sDomainLiteral="\\x5b([^\\x0d\\x5b-\\x5d\\x80-\\xff]|"+sQuotedPair+")*\\x5d",sQuotedString="\\x22([^\\x0d\\x22\\x5c\\x80-\\xff]|"+sQuotedPair+")*\\x22",sDomain_ref=sAtom,sSubDomain="("+sDomain_ref+"|"+sDomainLiteral+")",sWord="("+sAtom+"|"+sQuotedString+")",sDomain=sSubDomain+"(\\x2e"+sSubDomain+")*",sLocalPart=sWord+"(\\x2e"+sWord+")*",sAddrSpec=sLocalPart+"\\x40"+sDomain,sValidEmail="^"+sAddrSpec+"$",reValidEmail=new RegExp(sValidEmail);return reValidEmail.test(emailAddress)};this.isNumeric=function(n){return!isNaN(parseFloat(n))&&isFinite(n)};this.isFormValid=function(objectForm){var isFormValid=!0,valid=!0,validationFormElement;return $(".rendered-form label").removeClass("ia-required"),validationFormElement=$("#ia-form-popup .ia-form-required-error"),$(validationFormElement).html("<p>Please fill out all required fields.<\/p>"),$(validationFormElement).hide(),me.FormFields.filter('[required="required"],[required="true"]').each(function(item,element){var fieldName=$(element).attr("name"),staticName=objectForm.MapFields[fieldName],fieldType=$(element).attr("type"),fieldValue="";fieldType=="checkbox"&&$(element).attr("toggle")=="true"&&(fieldType="toggle");switch(fieldType){case"radio-group":valid=$(".rendered-form [name='"+fieldName+"']:checked").length>0;break;case"checkbox":valid=$(".rendered-form [name='"+fieldName+"']").is(":checked");break;case"toggle":valid=$(".rendered-form [name='"+fieldName+"']").attr("checked")=="checked";break;case"checkbox-group":valid=$(".rendered-form [name='"+fieldName+"[]']:checked").length>0;break;case"file":valid=me.checkFieldHasAttachment(element);break;default:fieldValue=$(".rendered-form [name='"+fieldName+"']").val();valid=fieldValue!=""}valid?$(".rendered-form label[for='"+fieldName+"']").removeClass("ia-required"):(isFormValid=!1,$(validationFormElement).show(),$(".rendered-form label[for='"+fieldName+"']").addClass("ia-required"))}),isFormValid};this.RemoveInputAttachment=function(element){me.ExcludeAttachmentsInput.push($(this).parent().attr("id"));$(element).parent("li").fadeOut(500,function(){$(this).remove()})};this.getAttachmentFiles=function(listItem,success,error){var ctx=listItem.get_context(),attachmentFolderUrl=String.format("{0}/Attachments/{1}",listItem.get_fieldValues().FileDirRef,listItem.get_fieldValues().ID),folder=ctx.get_web().getFolderByServerRelativeUrl(attachmentFolderUrl),files=folder.get_files();ctx.load(files);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.getAttachmentFiles");ctx.executeQueryAsync(function(){for(var attachments=[],i=0;file=files.get_item(i);i++)attachments.push({url:file.get_serverRelativeUrl(),name:file.get_name()});success(attachments)},error)};this.checkFieldHasAttachment=function(element){var objectForm=me.getFormObject(),attachmentFiles=typeof $(element)[0].files!="undefined"?$(element)[0].files:[],items=0,fieldName=$(element).attr("name"),staticName=objectForm.MapFields[fieldName],attachments,i,fileName;if(typeof me.AttachmentsInput[staticName]=="undefined")return!1;for(attachments=me.AttachmentsInput[staticName].Attachments,i=0;i<attachments.length;i++)fileName=typeof attachments[i].name!="undefined"?attachments[i].name:attachments[i],$.inArray(fileName,me.ExcludeAttachmentsInput)==-1&&items++;return items>0};this.checkFileExist=function(item){var staticName,attachments,i,file;for(staticName in me.AttachmentsInput)for(attachments=me.AttachmentsInput[staticName].Attachments,i=0;i<attachments.length;i++)if(file=typeof attachments[i].name!="undefined"?attachments[i].name:attachments[i],file.toLowerCase()==item.name.toLowerCase())return!0;return!1};this.controlAttachment=function(element){var objectForm=me.getFormObject(),clone=$(element).clone(),i;$(element).hide();$(element).unbind();var fieldName=$(element).attr("name"),staticName=objectForm.MapFields[fieldName];({}).element=$(element);var attachmentFiles=$(element)[0].files,elementList=$(element).parent().find(".ia-form-file-list"),attachmentsHtml=$(elementList).length==0?'<div class="ia-form-file-list"><ul>':"";for(i=0;i<attachmentFiles.length;i++)typeof me.AttachmentsInput[staticName]=="undefined"&&(me.AttachmentsInput[staticName]={},me.AttachmentsInput[staticName].Attachments=[]),$.inArray(attachmentFiles[i].name,me.ExcludeAttachmentsInput)!=-1?(me.ExcludeAttachmentsInput=jQuery.grep(me.ExcludeAttachmentsInput,function(value){return value!=attachmentFiles[i].name}),attachmentsHtml+=String.format('<li id="{0}"><button class="ia-button secondary ia-file-delete-btn deleteAttachment">Remove<\/button><span class="ia-file-name">{1}<\/span><\/li>',attachmentFiles[i].name,attachmentFiles[i].name)):me.checkFileExist(attachmentFiles[i])||(attachmentsHtml+=String.format('<li id="{0}"><button class="ia-button secondary ia-file-delete-btn deleteAttachment">Remove<\/button><span class="ia-file-name">{1}<\/span><\/li>',attachmentFiles[i].name,attachmentFiles[i].name)),me.checkFileExist(attachmentFiles[i])||me.AttachmentsInput[staticName].Attachments.push(attachmentFiles[i]);attachmentsHtml+=$(elementList).length==0?"<\/ul><\/div>":"";$(elementList).length==0?$(attachmentsHtml).insertAfter($(element).parent().find("label")):$(element).parent().find(".ia-form-file-list ul").append($(attachmentsHtml));$(".deleteAttachment").unbind();$(".deleteAttachment").click(function(e){e.preventDefault();me.ExcludeAttachmentsInput.push($(this).parent().attr("id"));$(this).parent("li").fadeOut(500,function(){$(this).remove()})});$(clone).on("change",function(){me.controlAttachment($(clone))});$(clone).insertAfter($(element));$(clone).attr("style","color:transparent")};this.deleteAttachment=function(listTitle,itemId,fileName){var objectForm=me.getFormObject(),ctx=SP.ClientContext.get_current(),web=ctx.get_site().openWebById(objectForm.SiteId),list=web.get_lists().getByTitle(listTitle),item=list.getItemById(itemId),attachmentFile=item.get_attachmentFiles().getByFileName(fileName);attachmentFile.deleteObject();Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.deleteAttachment");ctx.executeQueryAsync(function(){Akumina.AddIn.Logger.WriteInfoLog("Attachment file has been deleted")},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("deleteAttachment failed: "+args.get_message())})};this.isFormatValid=function(objectForm){var valid=!0,validationFormElement;return $(".rendered-form label").removeClass("ia-required"),validationFormElement=$("#ia-form-popup .ia-form-required-error"),$(validationFormElement).hide(),$(me.FormFields).each(function(item,element){var fieldName=$(element).attr("name"),staticName=objectForm.MapFields[fieldName],fieldType=$(element).attr("subtype"),fieldValue="";switch(fieldType){case"radio-group":fieldValue=$(".rendered-form [name='"+fieldName+"']:checked").val();break;default:fieldValue=$(".rendered-form [name='"+fieldName+"']").val()}if(fieldType=="number"&&typeof fieldValue!="undefined"&&fieldValue!="")if($(validationFormElement).html("<p>Incorrect format.  Please enter a valid number<\/p>"),valid=me.isNumeric(fieldValue),valid)$(".rendered-form [name='"+fieldName+"']").prev().removeClass("ia-required");else return $(validationFormElement).show(),$(".rendered-form [name='"+fieldName+"']").prev().addClass("ia-required"),!1;if(fieldType=="email"&&typeof fieldValue!="undefined"&&fieldValue!="")if($(validationFormElement).html("<p>Incorrect format.  Please enter a valid email address<\/p>"),valid=me.checkEmail(fieldValue),valid)$(".rendered-form [name='"+fieldName+"']").prev().removeClass("ia-required");else return $(validationFormElement).show(),$(".rendered-form [name='"+fieldName+"']").prev().addClass("ia-required"),!1}),valid};this.ExecuteSubmission=function(){var objectForm=me.getFormObject();me.isFormValid(objectForm,me)&&me.isFormatValid(objectForm)&&me.updateListItem(objectForm)};this.ShowConfirmation=function(){$("#form-confirmation").insertAfter($(".ia-modal-form"));$(".ia-modal-form").hide();$("#form-confirmation").show()};this.htmlEscape=function(str){return String(str).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};this.htmlUnescape=function(str){return String(str).replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")};this.includeObjValue=function(obj,key,value){typeof obj[key]=="undefined"&&(obj[key]=[]);obj[key].push(value)};this.checkFileIsValid=function(item){return isValid=!0,isValid=isValid&&$.inArray(item,me.ExcludeAttachmentsInput)==-1};this.UpdateAttachmentFields=function(id){var objectForm=me.getFormObject(),OnItemError;objectForm.ListItemId=id;OnItemError=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Update Attachment fields: "+args.get_message()+"\n"+args.get_stackTrace())};me.getFormData(objectForm,function(oListItem){for(var success=function(){Akumina.AddIn.Logger.WriteInfoLog("Updated Attachment fields")},listEnumerator=oListItem.getEnumerator(),staticName,attachments,i,file,clientContext;listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),fieldValue="",attachmentFolderUrl=String.format("{0}/Attachments/{1}",listItem.get_fieldValues().FileDirRef,listItem.get_fieldValues().ID),folder=window.location.protocol+"//"+window.location.host+attachmentFolderUrl;for(staticName in me.AttachmentsInput){for(fieldValue="",attachments=me.AttachmentsInput[staticName].Attachments,i=0;i<attachments.length;i++)file=attachments[i],me.checkFileIsValid(file.name,staticName)&&(fieldValue+=folder+"/"+file.name+";");listItem.set_item(staticName,fieldValue)}listItem.update();clientContext=new SP.ClientContext.get_current;clientContext.load(listItem);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.me.UpdateAttachmentFields");clientContext.executeQueryAsync(Function.createDelegate(this,success),Function.createDelegate(this,OnItemError))}},OnItemError,!1)};this.GetValueByType=function(element,fieldName){var fieldType=$(element).attr("type"),fieldValue="";fieldType=="select"&&$(element).attr("multiple")=="multiple"&&(fieldType="multi");fieldType=="checkbox"&&$(element).attr("toggle")=="true"&&(fieldType="toggle");switch(fieldType){case"radio-group":fieldValue=$(".rendered-form [name='"+fieldName+"']:checked").val();break;case"checkbox":fieldValue=$(".rendered-form [name='"+fieldName+"']").is(":checked");break;case"toggle":fieldValue=$(".rendered-form [name='"+fieldName+"']").attr("checked")=="checked";break;case"checkbox-group":fieldGroup=$(".rendered-form [name='"+fieldName+"[]']");fieldValue=";";$(fieldGroup).each(function(item,element){$(element).is(":checked")&&(fieldValue+="#"+$(element).val()+";")});fieldValue+="#";break;case"date":if(fieldValue=$(".rendered-form [name='"+fieldName+"']").val(),fieldValue=me.convertDateToSharepoint(fieldValue),fieldValue=="")return;break;case"file":$(".rendered-form [name='"+fieldName+"']");break;case"multi":fieldGroup=$(".rendered-form [name='"+fieldName+"'] option:checked");fieldValue=";";$(fieldGroup).each(function(item,element){fieldValue+="#"+$(element).val()+";"});fieldValue+="#";break;default:fieldValue=$(".rendered-form [name='"+fieldName+"']").val()}return fieldValue};this.updateListItem=function(formItemObj){me.getFormData(formItemObj,function(oListItem,formItemObj){for(var listEnumerator=oListItem.getEnumerator(),listItem,OnItemError,clientContext;listEnumerator.moveNext();)listItem=listEnumerator.get_current(),$(me.FormFields).each(function(item,element){var fieldName=$(element).attr("name"),staticName=formItemObj.MapFields[fieldName],fieldType=$(element).attr("type"),fieldValue=me.GetValueByType(element,fieldName,staticName),i,fileName;if(fieldType=="file"){fieldValue="";var attachments=me.AttachmentsInput[staticName].Attachments,attachmentFolderUrl=String.format("{0}/Attachments/{1}",listItem.get_fieldValues().FileDirRef,listItem.get_fieldValues().ID),folder=window.location.protocol+"//"+window.location.host+attachmentFolderUrl;for(i=0;i<attachments.length;i++)fileName=typeof attachments[i].name!="undefined"?attachments[i].name:attachments[i],me.checkFileIsValid(fileName,staticName)&&(fieldValue+=folder+"/"+fileName+";")}listItem.set_item(staticName,fieldValue);listItem.update()}),me.CurrentStatus=listItem.get_item("_ModerationStatus");OnItemError=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("UpdateAttachmentFields failed: "+args.get_message()+"\n"+args.get_stackTrace())};clientContext=new SP.ClientContext.get_current;Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.me.updateListItem");clientContext.executeQueryAsync(function(){if($(".rendered-form [type='file']").length>0){if(me.ExcludeAttachmentsInput.length>0)for(var i=0;i<me.ExcludeAttachmentsInput.length;i++)me.deleteAttachment(formItemObj.ReferenceList,formItemObj.ListItemId,me.ExcludeAttachmentsInput[i]);me.startUploadProcess(formItemObj.ReferenceList,formItemObj.ListItemId)}me.updateItemToFormSubmissions_AK(formItemObj)},OnItemError)},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("updateListItem-> getFormsData failed. "+args.get_message()+"\n"+args.get_stackTrace())})};this.showListItem=function(){var formItemObj=me.getFormObject();me.getFormData(formItemObj,function(oListItem,formItemObj){for(var listEnumerator=oListItem.getEnumerator(),listItem;listEnumerator.moveNext();)listItem=listEnumerator.get_current(),$(me.FormFields).each(function(item,element){var fieldName=$(element).attr("name"),staticName=formItemObj.MapFields[fieldName],fieldType=$(element).attr("type"),attachmentsHtml,file,i,itemValue;switch(fieldType){case"radio-group":itemValue=listItem.get_item(staticName);$(".rendered-form [name='"+fieldName+"'][value='"+itemValue+"']").prop("checked",!0);break;case"checkbox":itemValue=listItem.get_item(staticName);$(element).attr("toggle")=="true"?($(".rendered-form [name='"+fieldName+"']").attr("checked",itemValue),itemValue&&$(".rendered-form [name='"+fieldName+"']").parents(".kc-toggle").addClass(" on")):$(".rendered-form [name='"+fieldName+"']").prop("checked",itemValue);break;case"file":if(itemValue=listItem.get_item(staticName),attachmentsHtml='<div class="ia-form-file-list"><ul>',itemValue!=""&&itemValue!=null){for(itemValue=itemValue.split(";"),i=0;i<itemValue.length;i++)file=itemValue[i],file=file.split("/").pop(),file!=""&&(typeof me.AttachmentsInput[staticName]!="undefined"?me.AttachmentsInput[staticName].Attachments.push(file):(me.AttachmentsInput[staticName]={},me.AttachmentsInput[staticName].Attachments=[],me.AttachmentsInput[staticName].Attachments.push(file)),attachmentsHtml+=String.format('<li id="{0}"><button class="ia-button secondary ia-file-delete-btn">Remove<\/button><span class="ia-file-name">{1}<\/span><\/li>',file,file));attachmentsHtml+="<\/ul><\/div>";$(attachmentsHtml).insertAfter($(".rendered-form [name='"+fieldName+"']").parent().find("label"));$(".ia-file-delete-btn").click(function(){me.ExcludeAttachmentsInput.push($(this).parent().attr("id"));me.ExcludeAttachment($(this).parent().attr("id"));$(this).parent("li").fadeOut(500,function(){$(this).remove()})})}break;case"checkbox-group":if(listItem.get_item(staticName)!=null)for(i=0;i<listItem.get_item(staticName).length;i++)itemValue=listItem.get_item(staticName)[i],$(".rendered-form [name='"+fieldName+"[]'][value='"+itemValue+"']").prop("checked",!0);break;case"date":itemValue=listItem.get_item(staticName)!=null?listItem.get_item(staticName):"";itemValue!=""&&(itemValue=moment(itemValue).format("MM/DD/YYYY"));me.UseDatePicker($(".rendered-form [name='"+fieldName+"']"),itemValue);break;default:itemValue=listItem.get_item(staticName);$(".rendered-form [name='"+fieldName+"']").val(itemValue)}}),$(".rendered-form .file-input:first").length>0&&$("input[type=file]").attr("style","color:transparent")},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("showListItem-> getdata failed. "+args.get_message()+"\n"+args.get_stackTrace())})};this.getFormObject=function(){var jsonElement=$(me.targetDiv+" input[name$='hdnFormJson']");return JSON.parse(me.htmlUnescape($(jsonElement).val()))};this.CheckHasSubmission=function(formID){var clientContext=new SP.ClientContext.get_current,site=clientContext.get_site(),rootSite=site.get_rootWeb(),oList=rootSite.get_lists().getByTitle("FormSubmissions_AK"),camlQuery=new SP.CamlQuery,query='<View><Query><Where><And><Eq><FieldRef Name="FormID"/><Value Type="Text">'+formID+'<\/Value><\/Eq><Eq><FieldRef Name="Author" LookupId="TRUE" /><Value Type="Integer"><UserID /><\/Value><\/Eq><\/And><\/Where><\/Query><\/View>',OnItemError,oListItem;camlQuery.set_viewXml(query);OnItemError=function(sendera,args){Akumina.AddIn.Logger.WriteErrorLog("Error in CheckHasSubmission function: "+args.get_message())};oListItem=oList.getItems(camlQuery);clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.CheckHasSubmission");clientContext.executeQueryAsync(function(){oListItem.get_count()==0&&($(" #ia-form-popup .ia-button:first").removeAttr("disabled"),$(" #ia-form-popup .ia-button:first").removeAttr("style"))},OnItemError)};this.getFormData=function(formItemObj,OnItemAdded,OnItemError,isRootSite){var clientContext=new SP.ClientContext.get_current,oListItem;if(isRootSite)var site=clientContext.get_site(),rootSite=site.get_rootWeb(),oList=rootSite.get_lists().getByTitle(formItemObj.ReferenceList),camlQuery=new SP.CamlQuery,query="<View><Query><Where><And><Eq><FieldRef Name='FormID'/><Value Type='Text'>"+formItemObj.FormID+"<\/Value><\/Eq><Eq><FieldRef Name='SubmissionID'/><Value Type='Text'>"+formItemObj.ListItemId+"<\/Value><\/Eq><\/And><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>";else var oList=clientContext.get_site().openWebById(formItemObj.SiteId).get_lists().getByTitle(formItemObj.ReferenceList),camlQuery=new SP.CamlQuery,query="<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+formItemObj.ListItemId+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>";camlQuery.set_viewXml(query);oListItem=oList.getItems(camlQuery);clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.getFormData");clientContext.executeQueryAsync(function(){OnItemAdded(oListItem,formItemObj)},OnItemError)};this.showPostMessageMessage=function(){var objectForm=me.getFormObject(),postBack=objectForm.PostMessage,messageValue,container,scrollTo,magnificPopup;if(postBack.type=="message")if(messageValue=me.decodeBase64(postBack.value),$(postMessageElement).find(" .ia-form-postback").html(messageValue),objectForm.DisplayNonModal)$(formElement).find("#ia-form-popup").hide(),$(formElement).find(" #ia-form-postback-popup").removeClass("mfp-hide"),$(formElement).find(" #ia-form-postback-popup").removeClass("ia-modal"),$(formElement).find(".ia-form-close").hide(),container=$("div"),scrollTo=$("#form-confirmation"),container.scrollTop(scrollTo.offset().top-container.offset().top+container.scrollTop());else{if(messageValue==""){magnificPopup=$.magnificPopup.instance;magnificPopup.close();return}magnificPopup=$.magnificPopup.instance;magnificPopup.close();$.magnificPopup.open({items:{src:postMessageElement},type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0,fixedBgPos:!0,closeOnContentClick:!1})}else window.location=postBack.value};this.convertDateToSharepoint=function(date){var dateObj,convertedDate;return date==""?null:(dateObj=date.split("/"),convertedDate=dateObj[0]+"/"+dateObj[1]+"/"+dateObj[2]+" 12:00:00",new Date(convertedDate).toISOString())};this.addListItem=function(listTitle,OnItemAdded,OnItemError){me.GetCurrentUsername().then(function(currentUser){var clientContext=new SP.ClientContext.get_current,objectForm=me.getFormObject(),web=clientContext.get_site().openWebById(objectForm.SiteId),oList=web.get_lists().getByTitle(listTitle),itemCreateInfo=new SP.ListItemCreationInformation,oListItem=oList.addItem(itemCreateInfo),fullName=currentUser.get_title();oListItem.set_item("Title",listTitle+" by "+fullName);$(me.FormFields).each(function(item,element){var fieldName=$(element).attr("name"),staticName=objectForm.MapFields[fieldName],fieldValue=me.GetValueByType(element,fieldName,staticName);oListItem.set_item(staticName,fieldValue)});oListItem.update();clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.addListItem");clientContext.executeQueryAsync(function(){OnItemAdded(oListItem)},OnItemError)},function(){Akumina.AddIn.Logger.WriteErrorLog("There is a problem fetching user.")})};this.processUpload=function(attachmentsUrlFolder,fileInput,listTitle,itemId,success,error){var reader=new FileReader;reader.onload=function(result){var fileContent=new Uint8Array(result.target.result);me.performAttachmentUpload(attachmentsUrlFolder,listTitle,fileInput.name,itemId,fileContent,success,error)};reader.readAsArrayBuffer(fileInput)};this.performAttachmentUpload=function(attachmentsUrlFolder,listTitle,fileName,itemId,fileContent,success,error){me.uploadFile(attachmentsUrlFolder,fileName,fileContent,success,error)};this.ensureAttachmentFolder=function(listTitle,itemId){var def=$.Deferred(),objectForm=me.getFormObject(),ctx=SP.ClientContext.get_current(),web=ctx.get_site().openWebById(objectForm.SiteId),list,item,error;return ctx.load(web),list=web.get_lists().getByTitle(listTitle),ctx.load(list,"RootFolder"),item=list.getItemById(itemId),ctx.load(item),error=Function.createDelegate(me,function(){var error=Function.createDelegate(me,function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("ensureAttachmentFolder failed "+args.get_message()+"\n"+args.get_stackTrace());def.reject()}),attachmentFolderUrl=String.format("{0}/Attachments/{1}",list.get_rootFolder().get_serverRelativeUrl(),itemId);attachmentsFolder=web.getFolderByServerRelativeUrl(attachmentFolderUrl);ctx.load(attachmentsFolder);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.ensureAttachmentFolder");ctx.executeQueryAsync(Function.createDelegate(me,function(){def.resolve(attachmentsFolder)}),error)}),Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.ensureAttachmentFolder"),ctx.executeQueryAsync(function(){var attachmentsFolder,attachmentRootFolderUrl,attachmentsRootFolder,attachmentFolderUrl;item.get_fieldValues().Attachments?(attachmentFolderUrl=String.format("{0}/Attachments/{1}",list.get_rootFolder().get_serverRelativeUrl(),itemId),attachmentsFolder=web.getFolderByServerRelativeUrl(attachmentFolderUrl),ctx.load(attachmentsFolder)):(attachmentRootFolderUrl=String.format("{0}/Attachments",list.get_rootFolder().get_serverRelativeUrl()),attachmentsRootFolder=web.getFolderByServerRelativeUrl(attachmentRootFolderUrl),attachmentsFolder=attachmentsRootFolder.get_folders().add("_"+itemId),attachmentsFolder.moveTo(attachmentRootFolderUrl+"/"+itemId),ctx.load(attachmentsFolder));Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.ensureAttachmentFolder");ctx.executeQueryAsync(Function.createDelegate(me,function(){def.resolve(attachmentsFolder)}),error)},error),def};this.ExcludeAttachment=function(item){var staticName,attachments,i,file;for(staticName in me.AttachmentsInput)for(attachments=me.AttachmentsInput[staticName].Attachments,i=0;i<attachments.length;i++)file=attachments[i],typeof file.name=="undefined"&&file.toLowerCase()==item.toLowerCase()&&(me.AttachmentsInput[staticName].Attachments=jQuery.grep(me.AttachmentsInput[staticName].Attachments,function(value){return value!=file}))};this.startUploadProcess=function(listTitle,id){me.ensureAttachmentFolder(listTitle,id).then(function(attachmentsFolder){var attachmentsUrlFolder=attachmentsFolder.get_serverRelativeUrl(),staticName,attachments,i,file;for(staticName in me.AttachmentsInput)for(attachments=me.AttachmentsInput[staticName].Attachments,i=0;i<attachments.length;i++)file=attachments[i],typeof file.name!="undefined"&&me.checkFileIsValid(file.name,staticName)&&me.processUpload(attachmentsUrlFolder,file,listTitle,id,function(){Akumina.AddIn.Logger.WriteInfoLog("Attachment file has been uploaded")},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message())})})};this.uploadFile=function(folderUrl,fileName,fileContent,success,error){for(var createInfo,ctx=SP.ClientContext.get_current(),objectForm=me.getFormObject(),web=ctx.get_site().openWebById(objectForm.SiteId),folder=web.getFolderByServerRelativeUrl(folderUrl),encContent=new SP.Base64EncodedByteArray,b=0;b<fileContent.length;b++)encContent.append(fileContent[b]);createInfo=new SP.FileCreationInformation;createInfo.set_content(encContent);createInfo.set_url(fileName);folder.get_files().add(createInfo);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.Form.uploadFile");ctx.executeQueryAsync(success,error)};this.Init=function(options){var me=this,senderId,htmlForm,fbTemplate,element,isEdit,chartObject;if(this.uniqueId=options.UniqueId,this.hosted=options.apppart,this.targetDiv="."+this.uniqueId,this.resultTemplateJson=options.options.dataJSON,this.context=options.options.Context,$(" #ia-form-popup .ia-button:first").attr("disabled","true"),typeof this.resultTemplateJson.FormRestrictions!="undefined"&&this.resultTemplateJson.FormRestrictions.toLowerCase()=="onesubmission"?($(" #ia-form-popup .ia-button:first").attr("style","background:#bbb"),me.CheckHasSubmission(me.resultTemplateJson.FormID)):$(" #ia-form-popup .ia-button:first").removeAttr("disabled"),senderId=this.uniqueId,this.targetDiv=senderId!=""?"#"+this.uniqueId:"#"+$("#ia-form-popup").parent().attr("id"),Akumina.AddIn.Logger.WriteInfoLog("Form 1"),postMessageElement=$(this.targetDiv+" #ia-form-postback-popup"),formElement=$(this.targetDiv),$(this.targetDiv).siblings("input[name$='hdnFormJson']").length==0&&$(me.targetDiv).append("<input type='hidden' name='hdnFormJson' value='"+me.htmlEscape(JSON.stringify(this.resultTemplateJson))+"'/>"),this.resultTemplateJson.FormType=="survey"){htmlForm=$($.parseHTML(this.resultTemplateJson.FormDefinition)).html();$(this.targetDiv+" #ak-form-submitted").html(htmlForm);me.FormFields=$(htmlForm).find("field");fbTemplate=$(this.targetDiv+" #ak-form-submitted");$(fbTemplate).formRender();$(".rendered-form [type='file']").attr("multiple","true");$(".rendered-form [type='file']").each(function(item,element){$(element).on("change",function(){me.controlAttachment($(this))})});element=$(this.targetDiv+" #ia-form-popup");$(".ia-modal-form .ia-button-row a:first").html(this.resultTemplateJson.ActionButtonText);$(element).find(".ia-form-title").html(this.resultTemplateJson.Title);$(element).find(".ia-form-description").text(this.resultTemplateJson.Description);this.resultTemplateJson.DisplayNonModal?($(element).removeClass("mfp-hide"),$(element).removeClass("ia-modal"),$(element).find(" .ia-modal-dismiss").hide()):$.magnificPopup.open({items:{src:element},type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0,fixedBgPos:!0,closeOnContentClick:!1});isEdit=this.resultTemplateJson.ListItemId!=""&&typeof this.resultTemplateJson.ListItemId!="undefined";isEdit?($("#ia-form-popup .ia-button:first").html("Resubmit"),me.showListItem()):($(".rendered-form .file-input:first").length>0&&$("input[type=file]").attr("style","color:transparent"),me.UseDatePicker());$(" #ia-form-popup .ia-button:first").on("click",function(e){var objectForm,listTitle,isEdit;(Akumina.AddIn.Logger.WriteInfoLog("click"),$(this).attr("disabled")!="disabled")&&(e.preventDefault(),objectForm=me.getFormObject(),me.isFormValid(objectForm,me))&&me.isFormatValid(objectForm)&&(listTitle=objectForm.ReferenceList,isEdit=objectForm.ListItemId!=""&&typeof objectForm.ListItemId!="undefined",isEdit?me.ShowConfirmation():me.addListItem(listTitle,function(oListItem){var id=oListItem.get_id();me.addItemToFormSubmissions_AK(id);$(".rendered-form [type='file']").length>0&&(me.UpdateAttachmentFields(id),me.startUploadProcess(listTitle,id))},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("addListItem failed. "+args.get_message()+"\n"+args.get_stackTrace())}))});$(" #btncanConfirm").on("click",function(e){e.preventDefault();me.ExecuteSubmission()})}else $(this.targetDiv+" #ia-form-popup").hide(),chartObject=this.resultTemplateJson.Chart,$(this.targetDiv+" #chartContainer").CanvasJSChart(chartObject),$(".canvasjs-chart-canvas").attr("style",""),me.showPostMessageMessage()};this.Init(options)}),Akumina===undefined&&(Akumina={}),Akumina.AppParts===undefined&&(Akumina.AppParts={}),Akumina.AppParts.MyForms===undefined){function editForm(formId,submittedID){ShowAKFormModal("Forms_AK."+formId,submittedID)}Akumina.AppParts.MyForms=function(options){var me=this;this.ListId="";this.divMyForm="";this.LastIdFetched="";this.isLoazyLoading=!1;this.viewDivForm="";this.listItems="";this.error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.ActiveLazyLoad=function(senderId,pageSize){var formContent=$("#"+senderId).find(".ia-forms-submission-list");$(formContent).bind("mousewheel DOMMouseScroll",function(event){var rootsiteUrl,imgUrl,context,web;if(!(event.originalEvent.wheelDelta>0)&&!(event.originalEvent.detail<0)&&!me.isLoazyLoading&&(rootsiteUrl=window.location.protocol+"//"+window.location.host+_spPageContextInfo.siteServerRelativeUrl,imgUrl=rootsiteUrl+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/images/ia-loader-sm.gif",$(".ia-loading-gif").attr("src")==""&&$(".ia-loading-gif").attr("src",imgUrl),$(window).scrollTop()>=$(formContent).offset().top+$(formContent).outerHeight()-window.innerHeight)){$(".ia-loading-row").show();me.isLoazyLoading=!0;context=new SP.ClientContext.get_current;web=context.get_web();var list=web.get_lists().getByTitle("FormSubmissions_AK"),camlQuery=new SP.CamlQuery,lastId=me.LastIdFetched,query=String.format('<View><Query><OrderBy><FieldRef Name="ID" Ascending="FALSE"/><\/OrderBy><Where><And><Lt><FieldRef Name="ID"/><Value Type="Number">{0}<\/Value><\/Lt><Eq><FieldRef Name="Author" LookupId="TRUE" /><Value Type="Integer"><UserID /><\/Value><\/Eq><\/And><\/Where><\/Query><RowLimit>{1}<\/RowLimit><\/View>',lastId,pageSize);camlQuery.set_viewXml(query);me.listItems=list.getItems(camlQuery);context.load(me.listItems);Akumina.AddIn.Logger.logSPCall("MyForms.prototype.ActiveLazyLoad");context.executeQueryAsync(function(){me.loadMyForms()},me.error)}})};this.GetStatusItem=function(formItemObj,OnItemAdded,OnItemError){var clientContext=new SP.ClientContext.get_current,searchId=formItemObj.SubmittedID,oList=clientContext.get_site().openWebById(formItemObj.SiteId).get_lists().getByTitle(formItemObj.ReferenceList),camlQuery=new SP.CamlQuery,query="<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+searchId+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>",oListItem;camlQuery.set_viewXml(query);oListItem=oList.getItems(camlQuery);clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("MyForms.prototype.GetStatusItem");clientContext.executeQueryAsync(function(){OnItemAdded(oListItem,formItemObj)},OnItemError)};this.GetMyFormsAK=function(formItemObj,OnItemAdded,OnItemError){var clientContext=new SP.ClientContext.get_current,searchId=formItemObj.SubmittedID,site=clientContext.get_site(),rootSite=site.get_rootWeb(),oList=rootSite.get_lists().getByTitle(formItemObj.ReferenceList),camlQuery,query,oListItem;searchId=formItemObj.FormId;camlQuery=new SP.CamlQuery;query="<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+searchId+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>";camlQuery.set_viewXml(query);oListItem=oList.getItems(camlQuery);clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("MyForms.prototype.GetMyFormsAK");clientContext.executeQueryAsync(function(){OnItemAdded(oListItem,formItemObj)},OnItemError)};this.GetList=function(formItemObj,OnItemAdded,OnItemError){var clientContext=new SP.ClientContext.get_current,searchId=formItemObj.SubmittedID,site=clientContext.get_site(),rootSite=site.get_rootWeb(),oList=clientContext.get_site().openWebById(formItemObj.SiteId).get_lists().getByTitle(formItemObj.ReferenceList),camlQuery=new SP.CamlQuery,query="<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+searchId+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>500<\/RowLimit><\/View>",oListItem,oListFields;camlQuery.set_viewXml(query);oListItem=oList.getItems(camlQuery);clientContext.load(oListItem);oListFields=oList.get_fields();clientContext.load(oListFields);clientContext.load(oList,"Id");formItemObj.ListForm=oList;Akumina.AddIn.Logger.logSPCall("MyForms.prototype.GetList");clientContext.executeQueryAsync(function(){OnItemAdded(oListItem,oListFields,formItemObj)},OnItemError)};this.GetCommentsAK=function(formItemObj,OnItemAdded,OnItemError){var clientContext=new SP.ClientContext.get_current,searchId=formItemObj.SubmittedID,oList=clientContext.get_site().openWebById(formItemObj.SiteId).get_lists().getByTitle("Comments_AK"),camlQuery=new SP.CamlQuery,query="<View><Query><Where><And><Eq><FieldRef Name='AppId'/><Value Type='Text'>"+formItemObj.ListForm.get_id()+"<\/Value><\/Eq><Eq><FieldRef Name='ItemId'/><Value Type='Text'>"+searchId+"<\/Value><\/Eq><\/And><\/Where><\/Query><RowLimit>500<\/RowLimit><\/View>",oListItem;camlQuery.set_viewXml(query);oListItem=oList.getItems(camlQuery);clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("MyForms.prototype.GetCommentsAK");clientContext.executeQueryAsync(function(){OnItemAdded(oListItem,formItemObj)},OnItemError)};this.getAttachmentFiles=function(listItem,success,error){var ctx=listItem.get_context(),attachmentFolderUrl=String.format("{0}/Attachments/{1}",listItem.get_fieldValues().FileDirRef,listItem.get_fieldValues().ID),folder=ctx.get_web().getFolderByServerRelativeUrl(attachmentFolderUrl),files=folder.get_files();ctx.load(files);Akumina.AddIn.Logger.logSPCall("MyForms.prototype.getAttachmentFiles");ctx.executeQueryAsync(function(){for(var attachments=[],i=0;file=files.get_item(i);i++)attachments.push({url:file.get_serverRelativeUrl(),name:file.get_name()});success(attachments)},error)};this.FetchMyFormItems=function(resultTemplateJson,loadLi){for(var formItemObj,liHtml,viewButton,i=0;i<resultTemplateJson.length;i++){formItemObj=resultTemplateJson[i];loadLi&&(liHtml='<tr data-title="{0}"><td>{0}<\/td><td id="{1}" class="{2}"><\/td><td>{3}<\/td><td>',liHtml+='<button disabled class="ia-button ia-modal-inline-trigger">Edit<\/button> ',liHtml+='<button class="ia-button ia-modal-inline-trigger" id="view_{1}">View<\/button><\/td><\/tr>',liHtml=String.format(liHtml,formItemObj.Title,formItemObj.markupLiId,formItemObj.myFormStatus,formItemObj.Submitted),$(liHtml).insertBefore(".ia-forms-submission-list:first tbody .ia-loading-row"));me.LastIdFetched=formItemObj.FormSubmissionID;me.GetStatusItem(formItemObj,function(oListItem,formItemObj){for(var listEnumerator=oListItem.getEnumerator();listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),status=listItem.get_item("_ModerationStatus"),li=$(me.divMyForm+" #"+formItemObj.FormId+"_"+formItemObj.SubmittedID);switch(status){case 0:status="Approved";break;case 1:status="Rejected";$(li).parent().find(".ia-button:first").removeAttr("disabled");$(li).parent().find(".ia-button:first").attr("onClick","editForm("+formItemObj.FormId+","+formItemObj.SubmittedID+");return false;");break;case 2:status="Pending";$(li).parent().find(".ia-button:first").removeAttr("disabled");$(li).parent().find(".ia-button:first").attr("onClick","editForm("+formItemObj.FormId+","+formItemObj.SubmittedID+");return false;");break;default:status="Approved"}$(li).html(status);$(".ia-forms-submission-list.tablesorter").trigger("update");$(".ia-forms-submission-list.tablesorter").trigger("sorton",[[[2,1,0]]])}},function(sender,args){alert("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},!1);viewButton=$(me.divMyForm+" #view_"+formItemObj.FormId+"_"+formItemObj.SubmittedID);$(viewButton).attr("data-obj",JSON.stringify(formItemObj));$(viewButton).on("click",function(e){e.preventDefault();formItemObj=JSON.parse($(e.target).attr("data-obj"));me.viewPopupModal(formItemObj)})}formItemObj.FullView&&me.ActiveLazyLoad(me.uniqueId,formItemObj.PageSize)};this.GetMyFormsAKPagination=function(me,searchId,listItem,totalItems,totalProcessed){var def=$.Deferred(),clientContext=new SP.ClientContext.get_current,site=clientContext.get_site(),rootSite=site.get_rootWeb(),oList=rootSite.get_lists().getByTitle("Forms_AK"),camlQuery=new SP.CamlQuery,query="<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+searchId+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>",oListItem;return camlQuery.set_viewXml(query),oListItem=oList.getItems(camlQuery),clientContext.load(oListItem),Akumina.AddIn.Logger.logSPCall("MyForms.prototype.GetMyFormsAKPagination"),clientContext.executeQueryAsync(Function.createDelegate(me,function(){def.resolve(oListItem,listItem,totalItems,totalProcessed)}),Function.createDelegate(me,function(){def.reject()})),def};this.loadMyForms=function(){var data={},listEnumerator=me.listItems.getEnumerator(),utils=Akumina.AddIn.Utilities,item,totalItems,totalProcessed,listItem,formID;for(data.Items=[],data.FormItems=[],item={FormTitle:"All"},data.FormItems.push(item),totalItems=me.listItems.get_count(),totalItems==0&&$(".ia-loading-row").hide(),totalProcessed=0;listEnumerator.moveNext();)totalProcessed++,listItem=listEnumerator.get_current(),formID=listItem.get_item("FormID"),me.GetMyFormsAKPagination(me,formID,listItem,totalItems,totalProcessed).then(function(formaklistItems,listItem,totalItems,totalProcessed){for(var id=listItem.get_item("SubmissionID"),formSubmissionId=listItem.get_id(),siteId=listItem.get_item("SiteId"),formName=listItem.get_item("FormName"),title="",formakEnumerator=formaklistItems.getEnumerator(),formaklistItem,formID,createdDate,liID,myFormItem,search,item;formakEnumerator.moveNext();)formaklistItem=formakEnumerator.get_current(),title=formaklistItem.get_item("Title");formID=listItem.get_item("FormID");createdDate=listItem.get_item("Modified");createdDate=moment(createdDate).format("MM-DD-YYYY");liID=formID+"_"+id;myFormItem={SiteId:siteId,FormId:formID,Title:title,ReferenceList:formName,Submitted:createdDate,SubmittedID:id,markupLiId:liID,FormSubmissionID:formSubmissionId};data.Items.push(myFormItem);search=$.grep(data.FormItems,function(e){return e.FormTitle==title});search.length<1&&(item={FormTitle:title},data.FormItems.push(item));totalProcessed==totalItems&&(me.FetchMyFormItems(data.Items,!0),$(".ia-loading-row").hide(),me.isLoazyLoading=!1)})};this.viewPopupModal=function(formItemObj){var viewList=$(me.divMyForm+" .ia-form-view-list"),ignoreFields="Title,Order,FileLeafRef, MetaInfo",objTemp;$(viewList).html("");$(me.viewDivForm).find(" .ia-form-comments ul").html("");$(me.viewDivForm).find(" .ia-form-comments").hide();$(me.viewDivForm).find(" [id='forms-view.Status']").html("");$(me.viewDivForm).find(" [id='forms-view.Form']").html("");$(me.viewDivForm).find(" [id='forms-view.Submitted']").html("");objTemp={};objTemp.ReferenceList="Forms_AK";objTemp.FormId=formItemObj.FormId;me.GetMyFormsAK(objTemp,function(oListItem){for(var listEnumerator=oListItem.getEnumerator(),listItem,fieldDefinition;listEnumerator.moveNext();)listItem=listEnumerator.get_current(),fieldDefinition=listItem.get_item("FormDefinition"),fieldDefinition=decodeURIComponent(escape(window.atob(fieldDefinition))),formItemObj.FormDefinition=fieldDefinition;me.GetList(formItemObj,function(oListItem,oListFields,formItemObj){var statusElement=$(me.divMyForm+" #"+formItemObj.FormId+"_"+formItemObj.SubmittedID),status=$(statusElement).html(),listEnumerator,listItem,fields,fieldXml,objField,formDefinitionElement,isRequiredField,requiredHtml,labelField,type,file,newValue,i,viewLiHtml;for($(me.viewDivForm).find(" [id='forms-view.Status']").html(status),$(me.viewDivForm).find(" [id='forms-view.Form']").html(formItemObj.Title),$(me.viewDivForm).find(" [id='forms-view.Submitted']").html(formItemObj.Submitted),listEnumerator=oListItem.getEnumerator();listEnumerator.moveNext();)for(listItem=listEnumerator.get_current(),fields=oListFields.getEnumerator();fields.moveNext();)if(fieldXml=fields.get_current().get_schemaXml(),objField=schemaXml2Json(fieldXml),objField.Type!="Computed"){var fieldName=objField.StaticName,item=listItem.get_item(fieldName),isValid=typeof objField.ReadOnly=="undefined"&&objField.ReadOnly!="TRUE";if(isValid&&ignoreFields.indexOf(fieldName)<0&&(formDefinitionElement=$.parseHTML(formItemObj.FormDefinition),isRequiredField=$(formDefinitionElement).find('field[name="'+objField.DisplayName+'"]').attr("required"),typeof isRequiredField=="undefined"&&(isRequiredField=""),requiredHtml="",isRequiredField.toLowerCase()=="required"&&(requiredHtml='<span class="ia-required">*<\/span>'),labelField=$(formDefinitionElement).find('field[name="'+objField.DisplayName+'"]').attr("label"),typeof labelField!="undefined")){if(type=$(formDefinitionElement).find('field[name="'+objField.DisplayName+'"]').attr("type"),type=="date"&&item!=null?item=moment(item).format("MM-DD-YYYY"):type=="date"&&item==null?item="":type=="checkbox"&&$(formDefinitionElement).find('field[name="'+objField.DisplayName+'"]').attr("toggle")=="true"&&(item=item==!0?"on":"off"),type=="select"&&$(formDefinitionElement).find('field[name="'+objField.DisplayName+'"]').attr("multiple")=="multiple"&&(type="multi-select"),type=="file"){var itemValue=item,staticName=fieldName,attachmentsHtml='<li><div class="ia-form-field">'+labelField+": "+requiredHtml+'<\/div><div class="ia-form-value">';if(itemValue!=""&&itemValue!=null){for(itemValue=itemValue.split(";"),i=0;i<itemValue.length;i++)file=itemValue[i],file=file.split("/").pop(),file!=""&&(attachmentsHtml+=String.format('<p><a href="{0}" target="_new">{1}<\/a><\/p>',itemValue[i],file));attachmentsHtml+="<\/div><\/li>";$(viewList).append(attachmentsHtml)}}if((type=="checkbox-group"||type=="multi-select")&&item!=null){for(newValue="",i=0;i<item.length;i++)newValue+=$(formDefinitionElement).find('field[name="'+objField.DisplayName+'"] option[value="'+item[i]+'"]').text()+"<\/br>";item=newValue}(type=="select"||type=="radio-group")&&(item=$(formDefinitionElement).find('field[name="'+objField.DisplayName+'"] option[value="'+item+'"]').text());type=="textarea"&&item!=null&&(item=item.replace(/\n/g,"<br/>"));viewLiHtml='<li><div class="ia-form-field">'+labelField+": "+requiredHtml+'<\/div><div class="ia-form-value">'+item+"<\/div><\/li>";type!="file"&&$(viewList).append(viewLiHtml)}}me.GetCommentsAK(formItemObj,function(oListItem){for(var listEnumerator=oListItem.getEnumerator(),commentHtml;listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),comment=listItem.get_item("Comment"),dateComment=listItem.get_item("Created"),author=listItem.get_item("Author");$(me.viewDivForm).find(" .ia-form-comments").show();commentHtml='<li><div class="ia-form-comment">'+comment+'<\/div><div class="ia-form-comment-details">';commentHtml+='<div class="ia-form-comment-details"><span class="ia-comment-author">'+author.get_lookupValue()+'  <\/span><span class="ia-comment-date">'+moment(dateComment).format("MM/DD/YYYY HH:MM")+"<\/span><\/div><\/li>";$(me.viewDivForm).find(" .ia-form-comments ul").append(commentHtml)}});displayModal()},function(sender,args){alert("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},!0,!1)},function(sender,args){alert("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())})};this.Init=function(options){var me,senderId;Akumina.AddIn.Logger.WriteInfoLog(options);me=this;this.uniqueId=options.UniqueId;this.hosted=options.apppart;this.targetDiv="."+this.uniqueId;this.resultTemplateJson=options.options.dataJSON;this.context=options.options.Context;senderId=this.uniqueId;this.targetDiv=senderId!=""?"#"+this.uniqueId:"#"+senderId;me.divMyForm="#"+this.resultTemplateJson.SenderId;$(me.divMyForm+" .ia-forms-submission-list").tablesorter({sortList:[[2,1,0]]});$(me.divMyForm+" #ia-filter-by-form").on("change",function(){var optionSelected=$("option:selected",this),valueSelected=this.value;$(".ia-forms-submission-list tr").not(":first").hide();valueSelected!="All"?$(me.divMyForm+' .ia-forms-submission-list tr[data-title="'+valueSelected+'"]').show():$(me.divMyForm+" .ia-forms-submission-list tr").show()});me.viewDivForm=$(me.divMyForm+" #ia-form-view-popup");displayModal=function(){var magnificPopup=$.magnificPopup.instance;magnificPopup.close();$.magnificPopup.open({items:{src:me.viewDivForm},type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0,fixedBgPos:!0,closeOnContentClick:!1})};schemaXml2Json=function(schemaXml){var jsonObject={},schemaXmlDoc=$.parseXML(schemaXml);return $(schemaXmlDoc).find("Field").each(function(){$.each(this.attributes,function(i,attr){jsonObject[attr.name]=attr.value})}),jsonObject};me.FetchMyFormItems(this.resultTemplateJson.Items,!1)};this.Init(options)}}PeopleDirectory_SearchAllUsers=function(seachParameters){this.subscriptionId=seachParameters.SubscriptionId;this.clientId=seachParameters.AppId;this.skipToken=seachParameters.SkipToken;this.FetchPhotoFromAD=seachParameters.FetchPhotoFromAD;this.graphConfig={subscriptionId:this.subscriptionId,clientId:this.clientId,postLogoutRedirectUri:window.location.origin,endpoints:{graphApiUri:"https://graph.microsoft.com"},cacheLocation:"localStorage"}};PeopleDirectory_SearchAllUsers.prototype.graphSearchAllUsers=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory_SearchAllUsers.graphSearchAllUsers");var me=this,def=new $.Deferred,authContext=this.getAuthenticationContext();return authContext.acquireToken(me.graphConfig.endpoints.graphApiUri,function(error,token){if(error||!token){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("Error acquiring token: "+error);return}var uri=me.graphConfig.endpoints.graphApiUri+"/v1.0/users?&$select=Department,UsageLocation,DisplayName,BusinessPhones,MobilePhone,OfficeLocation,Mail,FacsimileTelephoneNumber,JobTitle,GivenName,Surname,UserPrincipalName",query=me.skipToken!=null?uri+"&$skiptoken="+me.skipToken:uri,filesUri=query;$.ajax({type:"GET",url:filesUri,headers:{Authorization:"Bearer "+token}}).done(function(response){def.resolve(response)}).fail(function(){def.reject()})}),def};PeopleDirectory_SearchAllUsers.prototype.createQuery=function(){var facetsQuery;Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory_SearchAllUsers.createQuery");var finalfilter="",searchType=this.searchType.toLowerCase()=="last"?"surname":"givenName",searchTextFilter="startswith("+searchType+",%27"+this.searchText+"%27)",selectedLetterFilter="startswith("+searchType+",%27"+this.selectedLetter+"%27)";return this.searchText.trim()!=""&&(finalfilter+=searchTextFilter),this.selectedLetter.trim()!=""&&(this.searchText.trim()!=""&&(finalfilter+="%20and%20"),finalfilter+=selectedLetterFilter),finalfilter!=""&&(finalfilter="$filter="+finalfilter),facetsQuery=this.formFacetsQuery(),facetsQuery!=""&&(finalfilter+=finalfilter==""?"$filter=":"%20and%20",finalfilter+=facetsQuery),finalfilter+"&$select=Department,UsageLocation,DisplayName,BusinessPhones,MobilePhone,OfficeLocation,PhysicalDeliveryOfficeName,Mail,FacsimileTelephoneNumber,JobTitle,GivenName,Surname"};PeopleDirectory_SearchAllUsers.prototype.formFacetsQuery=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory_SearchAllUsers.formFacetsQuery");var facetSet=[];return $(".ia-people-filter").each(function(){var $subFacets=$(this),facetName=$subFacets.find(".ia-people-filter-header").text();facetName=="Departments"?facetName="Department":facetName=="Office"?facetName="OfficeLocation":facetName=="Location"&&(facetName="UsageLocation");facetOptions=[];$subFacets.find(".ia-people-filter-options input:checked").each(function(){facetOptions.push(facetName+"%20eq%20%27"+$(this).val()+"%27")});facetOptions.length>0&&facetSet.push("("+facetOptions.join("%20or%20")+")")}),facetSet.join(" and ")};PeopleDirectory_SearchAllUsers.prototype.getProfilePictureCacheKey=function(userName,loggedInUserEmail){return"akumina:pd:profilepic:"+loggedInUserEmail+":"+userName};PeopleDirectory_SearchAllUsers.prototype.getAllUserCacheKey=function(loggedInUserEmail){return"akumina:pd:userdata:"+loggedInUserEmail};PeopleDirectory_SearchAllUsers.prototype.isDataCached=function(storageKey){var isUserDataCached=!1,userObj=Akumina.AddIn.Cache.Get(storageKey);return userObj&&(previous=userObj.timestamp,now=(new Date).getTime(),now-previous>=432e5?(Akumina.AddIn.Cache.Remove(storageKey),isUserDataCached=!1):isUserDataCached=!0),isUserDataCached};PeopleDirectory_SearchAllUsers.prototype.cacheProfilePic=function(userName,picData,loggedInUserEmail){var profileObj={data:picData,timestamp:(new Date).getTime()},storageKey=this.getProfilePictureCacheKey(userName,loggedInUserEmail);Akumina.AddIn.Cache.Set(this.getProfilePictureCacheKey(userName,loggedInUserEmail),profileObj,Akumina.AddIn.Constants.DAY_CACHE_EXPIRATION)};PeopleDirectory_SearchAllUsers.prototype.getProfilePicFromCache=function(userName,loggedInUserEmail){var storageKey=this.getProfilePictureCacheKey(userName,loggedInUserEmail),profileObj;return this.isDataCached(storageKey)?(profileObj=Akumina.AddIn.Cache.Get(storageKey),profileObj.data):null};PeopleDirectory_SearchAllUsers.prototype.getAuthenticationContext=function(){var authContext=new AuthenticationContext(this.graphConfig),isCallback=authContext.isCallback(window.location.hash),user;return authContext.handleWindowCallback(),isCallback&&!authContext.getLoginError()&&(window.location=authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST)),user=authContext.getCachedUser(),user?(Akumina.AddIn.Logger.WriteInfoLog("Cached user: "+user.userName),Akumina.AddIn.Logger.WriteInfoLog("Currently logged in as: "+_spPageContextInfo.userLoginName),user.userName.toLowerCase()!=_spPageContextInfo.userLoginName.toLowerCase()&&(Akumina.AddIn.Logger.WriteInfoLog("Clearing token for user: "+user.userName),Akumina.AddIn.Cache.Remove(this.getCacheKeyForAuthentication()))):authContext.login(),authContext};PeopleDirectory_SearchAllUsers.prototype.getCacheKeyForAuthentication=function(attribute){var prefix="adal.idtoken";return attribute!=null&&(prefix+=attribute),prefix};PeopleDirectory_SearchAllUsers.prototype.getProfilePicture=function(userName,image,loggedInUserEmail){var authContext;Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory_SearchAllUsers.getProfilePicture");var me=this,cachedPic=me.getProfilePicFromCache(userName,loggedInUserEmail),picUrlFromSharePoint=_spPageContextInfo.webAbsoluteUrl+"/_layouts/15/userphoto.aspx?size=S&username="+userName;if(cachedPic!=null){cachedPic!=""&&$(image).attr("src",cachedPic);return}this.FetchPhotoFromAD!=undefined&&this.FetchPhotoFromAD!=null&&$.parseJSON(this.FetchPhotoFromAD.toString().toLowerCase())?(authContext=this.getAuthenticationContext(),authContext.acquireToken(me.graphConfig.endpoints.graphApiUri,function(error,token){if(!error&&token){var uri=me.graphConfig.endpoints.graphApiUri+"/beta/users/"+encodeURIComponent(userName)+"/photo/$value",request=new XMLHttpRequest;request.open("GET",uri);request.setRequestHeader("Authorization","Bearer "+token);request.responseType="blob";request.onload=function(){if(request.readyState===4&&request.status===200){var reader=new FileReader;reader.onload=function(){$(image).attr("src",reader.result);me.cacheProfilePic(userName,reader.result,loggedInUserEmail)};reader.readAsDataURL(request.response)}else request.readyState===4&&request.status===404&&me.cacheProfilePic(userName,"",loggedInUserEmail)};request.send(null)}})):$(image).attr("src",picUrlFromSharePoint)};Akumina=Akumina||{};Akumina.namespace=function(ns_string){var parts=ns_string.split("."),parent=Akumina,i;for(parts[0]==="Akumina"&&(parts=parts.slice(1)),i=0;i<parts.length;i+=1)typeof parent[parts[i]]=="undefined"&&(parent[parts[i]]={}),parent=parent[parts[i]];return parent};Akumina.AddIn.PeopleDirectoryCommon=function(){var _cur=this;this.Init=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("Akumina.AddIn.PeopleDirectoryCommon.Load")};this.GetAbsoluteSiteName=function(){return _cur.GetBaseUrl()+"/"==_spPageContextInfo.webAbsoluteUrl?_cur.GetBaseUrl():_spPageContextInfo.webAbsoluteUrl};this.GetBaseUrl=function(){return window.location.protocol+"//"+window.location.host}};typeof Akumina.AddIn.PeopleDirectoryCommon.Eventing=="undefined"&&(Akumina.AddIn.PeopleDirectoryCommon.Eventing={events:{},Subscribe:function(e,func){this.events[e]||(this.events[e]=[]);this.events[e].push(func)},Publish:function(t,data){(Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("Event Published "+t),Akumina.AddIn.PeopleDirectoryCommon.Logger.Write(this.events),!this.events[t]||this.events[t].length<1)||this.events[t].forEach(function(func){func(data||{})})},FireSuccess:function(message){this.Publish("/peopledirectory/success/",message)},FireError:function(message){this.Publish("/peopledirectory/error/",message)}});Akumina.AddIn.PeopleDirectoryCommon.Logger={Write:function(message){!0&&Akumina.AddIn.Logger.WriteInfoLog(message)}};__extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},function(Akumina){var AddIn;(function(AddIn){var RollupResponse=function(){function RollupResponse(){}return RollupResponse}(),RollupRequest,Rollup;AddIn.RollupResponse=RollupResponse;RollupRequest=function(){function RollupRequest(){}return RollupRequest}(AddIn.BaseRequest);AddIn.RollupRequest=RollupRequest;Rollup=function(){function Rollup(RollupRequest){this.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));this.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));RollupRequest!=null?this.RollupRequest=RollupRequest:this.createRequest();this.RollupRequest.EditMode=Akumina.AddIn.Utilities.getEditMode()}return Rollup.prototype.getParam=function(key,val){var utils=Akumina.AddIn.Utilities,ret=utils.getQueryStringParameter(key,val);return utils.IsNullOrEmpty(ret)&&!utils.IsNullOrEmpty(val)?val:ret},Rollup.prototype.createRequest=function(){this.RollupRequest=new RollupRequest;this.RollupRequest.ListName=Akumina.AddIn.Utilities.getQueryStringParameter("ln","CompanyNews_AK");this.RollupRequest.DisplayTemplateUrl=Akumina.AddIn.Utilities.getQueryStringParameter("dtu","");this.RollupRequest.DisplayTemplateUrl==""&&(this.RollupRequest.DisplayTemplateUrl=_spPageContextInfo.siteServerRelativeUrl=="/"?"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/Rollup/Default.html":_spPageContextInfo.siteServerRelativeUrl+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/Rollup/Default.html");this.RollupRequest.InstructionSet=Akumina.AddIn.Utilities.getQueryStringParameter("is","");this.RollupRequest.WebPartTitle=Akumina.AddIn.Utilities.getQueryStringParameter("at","Announcement Items");var itemsToDisplayVal=Akumina.AddIn.Utilities.getQueryStringParameter("itd",0),itemsToDisplay=Akumina.AddIn.Utilities.TryParseInt(itemsToDisplayVal,null);this.RollupRequest.ItemsToDisplay=itemsToDisplay!=null?itemsToDisplay:0;this.RollupRequest.ViewAllLink=Akumina.AddIn.Utilities.getQueryStringParameter("val","NewsList.aspx");this.RollupRequest.DisplayTemplate=Akumina.AddIn.Utilities.getQueryStringParameter("dt","WidgetTemplate");this.RollupRequest.Icon=Akumina.AddIn.Utilities.getQueryStringParameter("i",Akumina.AddIn.Icons.None.toString());this.RollupRequest.SenderId=Akumina.AddIn.Utilities.getQueryStringParameter("SenderId","");this.RollupRequest.EditMode=this.editMode},Rollup.prototype.getItems=function(){this.ListName="NewsSections_AK";this.SectionIdField="Sections_x003a_ID";this.IDField="ID";this.TitleField="Title";this.SectionIconField="SectionIcon";this.SiteURLField="SiteURL";this.ListNameField="ListName";this.ItemsToDisplayField="ItemsToDisplay";this.ViewAllLinkField="ViewAllLink";this.DisplaySummaryField="DisplaySummary";this.SectionOrder=[];this.SectionList=[];this.SectionObtainedList=[];var instruction=new Akumina.AddIn.Instructions,me=this;this.RollupRequest[this.SectionIdField]=null;instruction.executeAsync(this,this.RollupRequest.InstructionSet,"RollupRequest").then(function(result){var context,web,parentContext;this.appWebUrl=result.appWebUrl;this.hostUrl=result.hostUrl;this.RollupRequest=result.RollupRequest;context=new SP.ClientContext.get_current;this.RollupRequest.Hosted?(parentContext=new SP.AppContextSite(context,this.hostUrl),web=parentContext.get_web()):web=context.get_web();me.SectionOrder=me.getSectionOrder(this.RollupRequest[me.SectionIdField]);var list=web.get_lists().getByTitle(me.ListName),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<Query><OrderBy><FieldRef Name='Created' Ascending='FALSE' /><\/OrderBy><\/Query><RowLimit>500<\/RowLimit>");this.RollupRequest.SectionListItems=list.getItems(camlQuery);context.load(this.RollupRequest.SectionListItems,"Include(ID,Title,SectionIcon,SiteURL,ListName,ItemsToDisplay,ViewAllLink,DisplaySummary)");Akumina.AddIn.Logger.logSPCall("Rollup.prototype.getItems");context.executeQueryAsync(Function.createDelegate(me,me.getSections),Function.createDelegate(me,me.error))})},Rollup.prototype.getSections=function(){for(var listEnumerator=this.RollupRequest.SectionListItems.getEnumerator(),sectionItem,i;listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),id=listItem.get_item(this.IDField),title=listItem.get_item(this.TitleField),icon=listItem.get_item(this.SectionIconField),siteURL=listItem.get_item(this.SiteURLField),listName=listItem.get_item(this.ListNameField),itemsToDisplay=parseInt(listItem.get_item(this.ItemsToDisplayField)),viewAllLink=listItem.get_item(this.ViewAllLinkField),displaySummary=listItem.get_item(this.DisplaySummaryField),sectionOrder=$.inArray(id,this.SectionOrder);sectionOrder>-1&&(sectionItem={Id:id,Title:title,Icon:Akumina.AddIn.Utilities.GetIcon(icon),SiteURL:siteURL,ListName:listName,Order:sectionOrder,ItemsToDisplay:itemsToDisplay,ViewAllLink:viewAllLink,HasViewAllLink:viewAllLink?!0:null,DisplaySummary:displaySummary,Items:null,Enumerator:null},this.SectionList.push(sectionItem))}if(this.SectionList.length>0)for(this.SectionList=this.sortSections(this.SectionList),i=0;i<this.SectionList.length;i++)this.getSectionItems(this.SectionList[i])},Rollup.prototype.getSectionItems=function(sectionItem){var siteContext=this.getSiteContext(sectionItem.SiteURL),context=new SP.ClientContext(siteContext),web,parentContext;this.RollupRequest.Hosted?(parentContext=new SP.AppContextSite(context,this.hostUrl),web=parentContext.get_web()):web=context.get_web();var list=web.get_lists().getByTitle(sectionItem.ListName),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<Query><OrderBy><FieldRef Name='Created' Ascending='FALSE' /><\/OrderBy><\/Query><RowLimit>500<\/RowLimit>");sectionItem.ListItems=list.getItems(camlQuery);context.load(sectionItem.ListItems,"Include(ID,Title,Summary,FriendlyUrl,Expires,Created,AnnouncementTitle,Start_x0020_Date)");Akumina.AddIn.Logger.logSPCall("Rollup.prototype.getSectionItems");context.executeQueryAsync(Function.createDelegate(this,function(){this.getSectionItemsSuccess(sectionItem)}),Function.createDelegate(this,function(){var args=arguments,error=args[1];this.getSectionItemsSuccess(sectionItem,error)}))},Rollup.prototype.getSectionItemsSuccess=function(sectionItem,error){var listEnumerator,itemAnnouncement,dtCreated,sitesToFind,sitesFound;if(this.SectionObtainedList.push(sectionItem.Id),error)Akumina.AddIn.Logger.WriteErrorLog("Error with "+sectionItem.Title),Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+error.get_message()+"\n"+(error.get_stackTrace()!=null?error.get_stackTrace():""));else for(listEnumerator=sectionItem.ListItems.getEnumerator(),sectionItem.Items=[];listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),id="",title="",announcementTitle="",summary="",url="",expires="",created="",startDate="";if((id=listItem.get_item(this.IDField),title=listItem.get_item(this.TitleField),announcementTitle=listItem.get_item("AnnouncementTitle"),summary=listItem.get_item("Summary"),url=listItem.get_item("FriendlyUrl"),expires=listItem.get_item("Expires"),created=listItem.get_item("Created"),startDate=listItem.get_item("Start_x0020_Date"),!Akumina.AddIn.Utilities.ItemExpired(expires))&&Akumina.AddIn.Utilities.ItemStarted(startDate)&&(itemAnnouncement={Title:title,AnnouncementTitle:announcementTitle,Summary:summary,Url:url,DisplaySummary:sectionItem.DisplaySummary?!0:null},created&&created!=""&&(dtCreated=moment(created),itemAnnouncement.CreatedDateTime=dtCreated,itemAnnouncement.Created=dtCreated.format("MMMM DD, YYYY")),sectionItem.Items.push(itemAnnouncement),sectionItem.ItemsToDisplay>0&&sectionItem.Items.length>=sectionItem.ItemsToDisplay))break}sitesToFind=this.SectionList.length;sitesFound=this.SectionObtainedList.length;sitesToFind>0&&sitesFound>0&&sitesToFind==sitesFound&&this.collateSections()},Rollup.prototype.collateSections=function(){var result=new RollupResponse;result.Items=this.SectionList;result.SenderId=this.RollupRequest.SenderId;result.hosted=this.RollupRequest.Hosted;this.RollupRequest.EditMode||Rollup.prototype.render(this.RollupRequest.DisplayTemplateUrl,result)},Rollup.prototype.error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},Rollup.prototype.render=function(templateUri,data){$.ajax(templateUri).done(function(template){var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){data.hosted?($("body").html(data.Html),AKNotifyParent(data.SenderId)):$("#"+data.SenderId).html(data.Html)})},Rollup.prototype.getSiteContext=function(siteURL){var siteContext=siteURL,rootUrl;return siteURL==""||siteURL.indexOf("http")==0||(siteURL.indexOf("/")==0?(rootUrl=_spPageContextInfo.webAbsoluteUrl.replace(_spPageContextInfo.webServerRelativeUrl,""),siteContext=rootUrl+siteURL):(rootUrl=_spPageContextInfo.webAbsoluteUrl,siteContext=rootUrl+"/"+siteURL)),siteContext},Rollup.prototype.getSectionOrder=function(sectionOrderField){var sectionOrder=[],i,sectionId;if(sectionOrderField!=null)for(i=0;i<sectionOrderField.length;i++)sectionId=sectionOrderField[i].get_lookupId(),sectionOrder.push(sectionId);return sectionOrder},Rollup.prototype.sortSections=function(sections){return sections.sort(function(a,b){return a.Order-b.Order})},Rollup}();AddIn.Rollup=Rollup})(AddIn=Akumina.AddIn||(Akumina.AddIn={}))}(Akumina||(Akumina={}));__extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},function(Akumina){var AddIn;(function(AddIn){var ThemeResponse=function(){function ThemeResponse(){}return ThemeResponse}(),ThemeRequest,Theme;AddIn.ThemeResponse=ThemeResponse;ThemeRequest=function(){function ThemeRequest(){}return ThemeRequest}(AddIn.BaseRequest);AddIn.ThemeRequest=ThemeRequest;Theme=function(){function Theme(ThemeRequest){this.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));this.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));this.ThemeRequest=ThemeRequest;this.ThemeRequest.EditMode=Akumina.AddIn.Utilities.getEditMode()}return Theme.prototype.getParam=function(key,val){var utils=Akumina.AddIn.Utilities,ret=utils.getQueryStringParameter(key,val);return utils.IsNullOrEmpty(ret)&&!utils.IsNullOrEmpty(val)?val:ret},Theme.prototype.getItem=function(){var instruction=new Akumina.AddIn.Instructions,me=this;instruction.executeAsync(this,this.ThemeRequest.InstructionSet,"ThemeRequest").then(function(result){var context,web,parentContext;this.appWebUrl=result.appWebUrl;this.hostUrl=result.hostUrl;this.ThemeRequest=result.ThemeRequest;context=new SP.ClientContext.get_current;this.ThemeRequest.Hosted?(parentContext=new SP.AppContextSite(context,this.hostUrl),web=parentContext.get_web()):web=context.get_web();this.sortAscending=!0;this.rowLimit=500;var list=web.get_lists().getByTitle(this.ThemeRequest.ResultSourceId),camlQuery=new SP.CamlQuery,order=this.sortAscending?"TRUE":"FALSE";this.ThemeRequest.listItems=list.getItems(camlQuery);context.load(this.ThemeRequest.listItems,"Include("+Akumina.AddIn.Configuration.getSelectFields("Theme").join()+")");Akumina.AddIn.Logger.logSPCall("Theme.prototype.getItem");context.executeQueryAsync(Function.createDelegate(me,me.success),Function.createDelegate(me,me.error))})},Theme.prototype.success=function(){var result=new ThemeResponse},Theme.prototype.error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},Theme.prototype.render=function(templateUri,data){$.ajax(templateUri).done(function(){}).always(function(){if(!data.hosted){$("#"+data.SenderId).html(data.Html);var options={background:data.Background,logo:data.Logo,theme:data.Theme},ThemeOptions={apppart:!1,UniqueId:data.SenderId,options:options},iaTheme=new Akumina.AppParts.Theme(ThemeOptions)}})},Theme}();AddIn.Theme=Theme})(AddIn=Akumina.AddIn||(Akumina.AddIn={}))}(Akumina||(Akumina={}));Akumina===undefined&&(Akumina={});Akumina.AppParts===undefined&&(Akumina.AppParts={});Akumina.AppParts.Theme===undefined&&(Akumina.AppParts.Theme=function(options){var me=this;me.targetDiv="";this.uniqueId="";this.webPartTheme="";this.slideDuration=3e3;this.transitionEffect="fade";this.showNavigator=!0;this.autoPlay=!0;this.infiniteLoop=!0;this.Init=function(options){var me=this,senderId,webPartIframe;this.uniqueId=options.UniqueId;this.hosted=options.apppart;this.targetDiv="."+this.uniqueId;this.background=options.options.background;this.logo=options.options.logo;this.theme=options.options.theme;senderId=this.uniqueId;this.hosted==!0?(webPartIframe=$("iframe[src*='SenderId%3D"+senderId+"']"),webPartIframe.length==0&&(webPartIframe=$("iframe[src*='SenderId%253D"+senderId+"']")),this.targetDiv="#"+$(webPartIframe).parents(".ms-WPBody").attr("id")+" .interAction"):this.targetDiv="#"+this.uniqueId+" .interAction"};this.Init(options)});browser={isIe:function(){return navigator.appVersion.indexOf("MSIE")!=-1},navigator:navigator.appVersion,getVersion:function(){var version=999;return navigator.appVersion.indexOf("MSIE")!=-1&&(version=parseFloat(navigator.appVersion.split("MSIE")[1])),version}};Akumina===undefined&&(Akumina={});Akumina.AppParts===undefined&&(Akumina.AppParts={});Akumina.AppParts.Traffic===undefined&&(Akumina.AppParts.Traffic=function(options){var me=this;me.targetDiv="";this.uniqueId="";this.webPartTheme="";this.googlemapkey="";this.location="";this.Init=function(options){if(typeof google=="object"&&typeof google.maps=="object")me.Load(options);else{var apiKey=options.options.googlemapkey,mapUrl="https://maps.googleapis.com/maps/api/js?key="+apiKey;$.getScript(mapUrl,function(){me.Load(options)})}};this.Load=function(options){var me=this,senderId,webPartIframe,intervalTraffic;this.uniqueId=options.UniqueId;this.hosted=options.apppart;this.targetDiv="."+this.uniqueId;this.location=options.options.location;senderId=this.uniqueId;this.hosted==!0?(webPartIframe=$("iframe[src*='SenderId%3D"+senderId+"']"),webPartIframe.length==0&&(webPartIframe=$("iframe[src*='SenderId%253D"+senderId+"']")),$(webPartIframe).hide(),this.targetDiv="#"+$(webPartIframe).parents(".ms-WPBody").attr("id")+" .interAction"):this.targetDiv="#"+this.uniqueId+" .interAction";browser.isIe()&&browser.getVersion()<=9&&(intervalTraffic=setInterval(me.CheckIsloadGoogleMap,1e3));$(me.targetDiv).find("#locationTrafficSearch").keypress(function(e){e.which==13&&(me.initializeGoogleMapControl($(me.targetDiv).find("#locationTrafficSearch").val(),!0),e.preventDefault())});this.CallInitializeGoogleMaps();$(this.targetDiv).find("#trafficGoSearch").bind("click",function(){me.initializeGoogleMapControl($(me.targetDiv).find("#locationTrafficSearch").val(),!0)})};this.CheckIsloadGoogleMap=function(){$(this.targetDiv).find("#map").html()==""?me.CallInitializeGoogleMaps():clearInterval(intervalTraffic)};this.initializeGoogleMapControl=function(location,newCookie){var googleMapUrlLocation="https://maps.googleapis.com/maps/api/geocode/json?address="+location,xdr;browser.isIe()&&browser.getVersion()<=9?(xdr=new XDomainRequest,xdr.open("get",googleMapUrlLocation),xdr.onload=function(){var JSON=$.parseJSON(xdr.responseText);(JSON==null||typeof JSON=="undefined")&&(JSON=$.parseJSON(data.firstChild.textContent));me.processDataTraffic(JSON,newCookie)},xdr.send()):$.getJSON(googleMapUrlLocation).done(function(data){me.processDataTraffic(data,newCookie)})};this.processDataTraffic=function(data,newCookie){try{var obj=data.results[0].geometry.location,map=new google.maps.Map(document.getElementById("map"),{zoom:13,center:obj}),trafficLayer=new google.maps.TrafficLayer;trafficLayer.setMap(map);newCookie&&me.createCookie("TrafficLocation_InterActionGoogle",$(me.targetDiv).find("#locationTrafficSearch").val(),365)}catch(exception){}};this.CallInitializeGoogleMaps=function(){var cookieLocation=this.readCookie("TrafficLocation_InterActionGoogle")==null?this.location:this.readCookie("TrafficLocation_InterActionGoogle");me.initializeGoogleMapControl(cookieLocation)};this.createCookie=function(name,value,days){var expires,date;days?(date=new Date,date.setTime(date.getTime()+days*864e5),expires="; expires="+date.toGMTString()):expires="";document.cookie=encodeURIComponent(name)+"="+encodeURIComponent(value)+expires+"; path=/"};this.readCookie=function(name){for(var c,nameEQ=encodeURIComponent(name)+"=",ca=document.cookie.split(";"),i=0;i<ca.length;i++){for(c=ca[i];c.charAt(0)===" ";)c=c.substring(1,c.length);if(c.indexOf(nameEQ)===0)return decodeURIComponent(c.substring(nameEQ.length,c.length))}return null};this.Init(options)});typeof Akumina.AddIn.QuickLinksWidget=="undefined"&&(Akumina.AddIn.QuickLinksWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn,utils=Akumina.AddIn.Utilities,templatefolderName=Akumina.Digispace.ConfigurationContext.TemplateFolderName,customDisplayTemplateUrl;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.QueryPart=decodeURI(_cur.GetPropertyValue(requestIn,"querypart","MainMenu_AK")),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.DisplayTemplateUrl=_spPageContextInfo.siteServerRelativeUrl=="/"?"/Style%20Library/"+templatefolderName+"/Content/Templates/QuickLinks/ItemTemplate.html":_spPageContextInfo.siteServerRelativeUrl+"/Style%20Library/"+templatefolderName+"/Content/Templates/QuickLinks/ItemTemplate.html",requestOut.Title=_cur.GetPropertyValue(requestIn,"title",""),requestOut.Icon=_cur.GetPropertyValue(requestIn,"icon",Akumina.AddIn.Icons.None.toString()),requestOut.DisplayAsTopMenu=_cur.GetPropertyValue(requestIn,"displayastopmenu","false"),requestOut.Direction=_cur.GetPropertyValue(requestIn,"direction","leftright"),requestOut.Direction.toLowerCase()=="topbottom"&&(requestOut.DisplayTemplateUrl=_spPageContextInfo.siteServerRelativeUrl=="/"?"/Style%20Library/"+templatefolderName+"/Content/Templates/QuickLinks/ItemTemplateSubSite.html":_spPageContextInfo.siteServerRelativeUrl+"/Style%20Library/"+templatefolderName+"/Content/Templates/QuickLinks/ItemTemplateSubSite.html"),requestOut.DisplayAsTopMenu=="true"&&(requestOut.DisplayTemplateUrl=_spPageContextInfo.siteServerRelativeUrl=="/"?"/Style%20Library/"+templatefolderName+"/Content/Templates/QuickLinks/ItemDetailTemplate.html":_spPageContextInfo.siteServerRelativeUrl+"/Style%20Library/"+templatefolderName+"/Content/Templates/QuickLinks/ItemDetailTemplate.html"),customDisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),Akumina.AddIn.Utilities.IsNullOrEmpty(customDisplayTemplateUrl)||(requestOut.DisplayTemplateUrl=customDisplayTemplateUrl),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","quicklinks"),requestOut};this.Init=function(quickLinksRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.QuickLinksRequest=_cur.SetDefaultsProperties(quickLinksRequest);_cur.QuickLinksRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();var qp=_cur.QuickLinksRequest.QueryPart.split(".");qp.length===2?(_cur.rootWeb=!0,_cur.listName=qp[1]):(_cur.rootWeb=!1,_cur.listName=qp[0]);_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=this.QuickLinksRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.GetItems);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="QuickLinks";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"Hosted","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayAsTopMenu","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){if(newProps.id==_cur.QuickLinksRequest.SenderId){_cur.QuickLinksRequest=_cur.SetDefaultsProperties(newProps);_cur.QuickLinksRequest.EditMode=!1;var qp=_cur.QuickLinksRequest.QueryPart.split(".");qp.length===2?(_cur.rootWeb=!0,_cur.listName=qp[1]):(_cur.rootWeb=!1,_cur.listName=qp[0]);_cur.GetItems()}};this.RequestTemplateFromServer=function(templateUri){return $.ajax(templateUri)};this.Render=function(templateUri,data){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){data.Html=html;_cur.BindTemplate(data)},function(errormsg){var data={sender:_cur.QuickLinksRequest.SenderId,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.QuickLinksRequest.SenderId).html(html)})})};this.BindTemplate=function(data){if(data.hosted)$("body").html(data.Html),AKSenderData.options={hosted:data.hosted,requiredJs:data.requiredJs},AKNotifyParent(data.SenderId);else{$("#"+data.SenderId).html(data.Html);var options={html:data.Html},controlOptions={apppart:!1,UniqueId:data.SenderId,options:options,hosted:data.hosted},iaQuickLinks=new Akumina.AppParts.QuickLinks(controlOptions)}};this.GetItems=function(){var cachedItems=Akumina.AddIn.Cache.Get(_cur.GetCacheKey()),context,web,parentContext,site;if(cachedItems&&cachedItems!=null)_cur.Render(_cur.QuickLinksRequest.DisplayTemplateUrl,cachedItems);else{context=SP.ClientContext.get_current();_cur.QuickLinksRequest.Hosted?(parentContext=new SP.AppContextSite(context,_cur.hostUrl),_cur.rootWeb?(site=parentContext.get_site(),web=site.get_rootWeb()):web=parentContext.get_web()):_cur.rootWeb?(site=context.get_site(),web=site.get_rootWeb()):web=context.get_web();var list=web.get_lists().getByTitle(_cur.listName),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<View><Query><\/Query><\/View>");_cur.listItems=list.getItems(camlQuery);context.load(_cur.listItems,"Include("+Akumina.AddIn.Configuration.getSelectFields("QuickLinks").join()+")");Akumina.AddIn.Logger.logSPCall("QuickLinks.prototype.getItems");context.executeQueryAsync(Function.createDelegate(_cur,_cur.ItemsLoadSuccess),Function.createDelegate(_cur,_cur.ItemsLoadError))}};this.ItemsLoadSuccess=function(){var listEnumerator=_cur.listItems.getEnumerator(),data={},utils=Akumina.AddIn.Utilities,isActive,formLink,icon,itemQuickLink;for(data.Items=[];listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),id=listItem.get_item("ID"),title=listItem.get_item("Title"),nodeType=listItem.get_item("NodeType"),link=listItem.get_item("Link")!=null?listItem.get_item("Link").get_url():"",openInNewWindow=listItem.get_item("Open_x0020_With");openInNewWindow=openInNewWindow!=null&&openInNewWindow.toLowerCase().indexOf("new")>-1;var target=openInNewWindow?"_blank":"_self",displayOrder=listItem.get_item("DisplayOrder"),parentId=listItem.get_item("ParentItem_x003a_ID");data.WebPartTitle=_cur.QuickLinksRequest.Title;data.WebPartIcon=utils.GetIcon(_cur.QuickLinksRequest.Icon);data.ShowHeader=_cur.QuickLinksRequest.Title!==""||utils.GetIcon(_cur.QuickLinksRequest.Icon).toLowerCase()!=="none";isActive=listItem.get_item("Active");formLink=listItem.get_item("FormID")!=null?listItem.get_item("FormID"):"";formLink!=null&&formLink!=""&&(link=link+"?formid=FORMS_AK."+formLink,formLink="");icon="";typeof listItem.get_fieldValues().Icon!="undefined"&&(icon=listItem.get_item("Icon"));itemQuickLink={Id:id,ParentId:parentId,Link:link,Target:target,NodeType:nodeType,OpenInNewWindow:openInNewWindow,Title:title,DisplayOrder:displayOrder,FormLink:formLink,Icon:icon};isActive&&data.Items.push(itemQuickLink)}allQuickLinkItems=data.Items;modelView=_cur.sortItemsDesc(data.Items);modelView.forEach(_cur.prepareModelforView);modelView=_cur.excludeNotRoot(modelView);data.Items=modelView[0].Items;data.SenderId=_cur.QuickLinksRequest.SenderId;data.hosted=_cur.QuickLinksRequest.Hosted;data.requiredJs=_cur.appWebUrl+"/scripts/controls/ak.addin.quicklinks.nav.js";_cur.QuickLinksRequest.EditMode||(Akumina.AddIn.Cache.Set(_cur.GetCacheKey(),data,_cur.GetCacheInterval()),_cur.Render(_cur.QuickLinksRequest.DisplayTemplateUrl,data))};this.GetCacheInterval=function(){return _cur.QuickLinksRequest.CacheInterval&&_cur.QuickLinksRequest.CacheInterval!=null&&!isNaN(_cur.QuickLinksRequest.CacheInterval)?parseInt(_cur.QuickLinksRequest.CacheInterval):Akumina.Digispace.ConfigurationContext.CachingStrategyInterval};this.GetCacheKey=function(){return Akumina.Digispace.ConfigurationContext.getCacheKey(_cur.QuickLinksRequest.SenderId)};this.ItemsLoadError=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.sortItemsDesc=function(model){return model.sort(function(a,b){return b.Id-a.Id})};this.sortItemsAsc=function(model){return model.sort(function(a,b){return a.DisplayOrder-b.DisplayOrder})};this.getElementById=function(array,id){return array.map(function(el){return el.Id}).indexOf(id)};this.excludeNotRoot=function(array){return array=array.filter(function(el){return el.NodeType==="Root"}),array[0].Title="QuickLinks",array[0].HasCategories=!1,array[0].HasLinks=!1,array};this.hasCategories=function(element){var items=jQuery.grep(allQuickLinkItems,function(item){return item.ParentId!==null&&item.ParentId.get_lookupId()===element.Id&&item.NodeType=="Category"});return items.length>0};this.hasItem=function(element){var items=jQuery.grep(allQuickLinkItems,function(item){return item.ParentId!==null&&item.ParentId.get_lookupId()===element.Id&&item.NodeType=="Item"});return items.length>0};this.getParentItems=function(element){for(var items=jQuery.grep(allQuickLinkItems,function(item){return item.ParentId!==null&&item.ParentId.get_lookupId()===element.Id}),i=0;i<items.length;i++)items[i].NodeType==="Category"&&(items[i].IsFolder=!0),items[i].NodeType==="Item"&&(items[i].IsItem=!0),items[i].HasCategories=_cur.hasCategories(items[i]),items[i].HasCategories||(items[i].HasLinks=_cur.hasItem(items[i]));return items};this.prepareModelforView=function(element){if(element.ParentId!=null){var parentId=element.ParentId.get_lookupId(),parentIndex=_cur.getElementById(modelView,parentId);modelView[parentIndex].Items==undefined&&(modelView[parentIndex].Items=[]);modelView[parentIndex].Items=_cur.sortItemsAsc(_cur.getParentItems(modelView[parentIndex]))}}});typeof Akumina.AddIn.GenericItemWidget=="undefined"&&(Akumina.AddIn.GenericItemWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.rootWeb=_cur.GetPropertyValue(requestIn,"isroot","true"),requestOut.selectFields=_cur.GetPropertyValue(requestIn,"selectfields",""),requestOut.listName=_cur.GetPropertyValue(requestIn,"listname",""),requestOut.instructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.displayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.callbackMethod=_cur.GetPropertyValue(requestIn,"callbackmethod",""),requestOut.idOrTitle=Akumina.AddIn.Utilities.GetFriendlyUrl(window.location.href),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","genericitem"),requestOut.CacheInterval=_cur.GetPropertyValue(requestIn,"cacheinterval",null),requestOut};this.Init=function(genericItemRequest){_cur.itemRequest=_cur.SetDefaultsProperties(genericItemRequest);_cur.itemRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=this.itemRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="GenericItem";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"displayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"rootWeb","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.itemRequest.SenderId&&(_cur.itemRequest=_cur.SetDefaultsProperties(newProps),_cur.itemRequest.EditMode=!1,_cur.Render())};this.Render=function(){var model=Akumina.AddIn.Cache.Get(_cur.GetCacheKey()),instruction;if(model!=null){_cur.BindData(_cur.itemRequest.displayTemplateUrl,model,_cur.itemRequest.SenderId);return}instruction=new Akumina.AddIn.Instructions;instruction.executeAsync(_cur,_cur.itemRequest.instructionSet,"").then(function(result){var utils=Akumina.AddIn.Utilities,context,web,site;_cur.itemRequest=result.itemRequest;context=new SP.ClientContext.get_current;JSON.parse(_cur.itemRequest.rootWeb)?(site=context.get_site(),web=site.get_rootWeb()):web=context.get_web();var list=web.get_lists().getByTitle(_cur.itemRequest.listName),camlQuery=new SP.CamlQuery,query=_cur.itemRequest.viewXml;utils.IsNullOrEmpty(query)&&(query="<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+_cur.itemRequest.idOrTitle+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>",isNaN(_cur.itemRequest.idOrTitle)&&(query="<View><Query><Where><Eq><FieldRef Name='Title'/><Value Type='Text'>"+_cur.itemRequest.idOrTitle+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>"));camlQuery.set_viewXml(query);_cur.itemRequest.listItems=list.getItems(camlQuery);_cur.itemRequest.listFields=list.get_fields();context.load(_cur.itemRequest.listFields);utils.IsNullOrEmpty(_cur.itemRequest.selectFields)?context.load(_cur.itemRequest.listItems):context.load(_cur.itemRequest.listItems,"Include("+_cur.itemRequest.selectFields+")");Akumina.AddIn.Logger.logSPCall("GenericItemControl.prototype.render  ("+_cur.itemRequest.listName+")");context.executeQueryAsync(Function.createDelegate(_cur,_cur.Success),Function.createDelegate(_cur,_cur.Error))})};this.Success=function(){var listEnumerator=_cur.itemRequest.listItems.getEnumerator(),data={},metadata={},utils=Akumina.AddIn.Utilities,listItem,fields,i,fieldName,result;if(typeof _cur.itemRequest.listFields!="undefined")for(fields=_cur.itemRequest.listFields.getEnumerator();fields.moveNext();)fieldName=fields.get_current().get_staticName(),Akumina.AddIn.Configuration.containsInExcludeField(fieldName)||(metadata[fieldName]=fields.get_current().get_fieldTypeKind());while(listEnumerator.moveNext())if(listItem=listEnumerator.get_current(),utils.IsNullOrEmpty(_cur.itemRequest.selectFields))for(i=0;i<metadata.length;i++)data[i]=metadata[i].fieldType==SP.FieldType.URL?listItem.get_fieldValues()[i]!=null?listItem.get_fieldValues()[i].get_url():"":listItem.get_fieldValues()[i];else for(fields=_cur.itemRequest.selectFields.split(","),i=0;i<fields.length;i++)fieldName=fields[i],Akumina.AddIn.Configuration.containsInExcludeField(fieldName)||(data[fieldName]=metadata[fieldName]==SP.FieldType.URL?listItem.get_fieldValues()[fieldName]!=null?listItem.get_fieldValues()[fieldName].get_url():"":listItem.get_fieldValues()[fieldName]);result={response:data,request:_cur.itemRequest};_cur.itemRequest.EditMode||(Akumina.AddIn.Cache.Set(_cur.GetCacheKey(),result.response,_cur.GetCacheInterval()),_cur.BindData(_cur.itemRequest.displayTemplateUrl,result.response,_cur.itemRequest.SenderId))};this.Error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.GetErrorTemplate=function(){return __getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/GenericList/Error.html"};this.GetCacheKey=function(){return Akumina.Digispace.ConfigurationContext.getCacheKey(_cur.itemRequest.SenderId+":"+_cur.itemRequest.idOrTitle)};this.GetCacheInterval=function(){return _cur.itemRequest.CacheInterval&&_cur.itemRequest.CacheInterval!=null&&!isNaN(_cur.itemRequest.CacheInterval)?parseInt(_cur.itemRequest.CacheInterval):Akumina.Digispace.ConfigurationContext.CachingStrategyInterval};this.BindTemplate=function(templateUri,data,targetDiv){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){$("#"+targetDiv).html(html)},function(errormsg){_cur.BindTemplate(_cur.GetErrorTemplate(),{sender:_cur.itemRequest.SenderId,message:errormsg},targetDiv)})};this.BindData=function(templateUri,data,targetDiv){var theCallBack=window[this.itemRequest.callbackMethod];typeof theCallBack=="function"&&(data=theCallBack(data));_cur.BindTemplate(templateUri,data,targetDiv)}});typeof Akumina.AddIn.GenericListPaging=="undefined"&&(Akumina.AddIn.GenericListPaging=function(){_cur=this;_cur.nextPagingInfo=null;_cur.position=null;_cur.isScrollReady=!0;_cur.result=[];_cur.pageWiseResult=[];_cur.pageNumber=1;_cur.isLastPage=!1;this.GetFinalResult=function(data){return _cur.result=$.merge(_cur.result,data),_cur.result};this.Reset=function(){_cur.nextPagingInfo=null;_cur.position=null;_cur.Result=[]};this.IsDataCachedForCurrentPage=function(){return _cur.pageWiseResult[_cur.pageNumber-1]?!0:!1};this.GetPageWiseCachedData=function(){var data=_cur.pageWiseResult.slice(0,_cur.pageNumber);for(var obj in data)_cur.result=_cur.result.concat(data[obj]);return _cur.result}});typeof Akumina.AddIn.GenericListControlWidget=="undefined"&&(Akumina.AddIn.GenericListControlWidget=function(){var _cur=this;this.GetCacheKey=function(){return Akumina.Digispace.ConfigurationContext.getCacheKey(_cur.listRequest.SenderId)};this.GetCacheInterval=function(){return _cur.listRequest.CacheInterval&&_cur.listRequest.CacheInterval!=null&&!isNaN(_cur.listRequest.CacheInterval)?parseInt(_cur.listRequest.CacheInterval):Akumina.Digispace.ConfigurationContext.CachingStrategyInterval};this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.rootWeb=_cur.GetPropertyValue(requestIn,"isroot","true"),requestOut.selectFields=_cur.GetPropertyValue(requestIn,"selectfields",""),requestOut.isPaging=_cur.GetPropertyValue(requestIn,"ispaging","false"),requestOut.pageSize=_cur.GetPropertyValue(requestIn,"pagesize","10"),requestOut.listName=_cur.GetPropertyValue(requestIn,"listname",""),requestOut.instructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.displayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.callbackMethod=_cur.GetPropertyValue(requestIn,"callbackmethod",""),requestOut.isAsyncCallback=_cur.GetPropertyValue(requestIn,"isasynccallback","false"),requestOut.viewXml=_cur.GetPropertyValue(requestIn,"viewxml",""),requestOut.callbackType=_cur.GetPropertyValue(requestIn,"callbacktype","postdataload"),requestOut.dataLoadProperties=_cur.GetPropertyValue(requestIn,"dataloadproperties",""),requestOut.CacheInterval=_cur.GetPropertyValue(requestIn,"cacheinterval",null),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","genericlist"),requestOut};this.Init=function(genericListRequest){_cur.listRequest=_cur.SetDefaultsProperties(genericListRequest);_cur.listRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.genericListPagingObj=new Akumina.AddIn.GenericListPaging;_cur.listRequest.isPaging||(_cur.listRequest.isPaging="false");_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=_cur.listRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="GenericList";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"displayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"rootWeb","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"isPaging","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"isAsyncCallback","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.listRequest.SenderId&&(_cur.listRequest=_cur.SetDefaultsProperties(newProps),_cur.listRequest.EditMode=!1,_cur.genericListPagingObj=new Akumina.AddIn.GenericListPaging,_cur.listRequest.isPaging||(_cur.listRequest.isPaging="false"),_cur.Render())};this.GetErrorTemplate=function(){return __getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/GenericList/Error.html"};this.Render=function(){var dataLoadProperties,cachedItems,instruction;_cur.listRequest.callbackType.toLowerCase()=="customdataload"?_cur.listRequest.EditMode||(Akumina.AddIn.Logger.WriteInfoLog("GenericListControlWidget.Render customdataload"),dataLoadProperties={response:_cur.listRequest,request:_cur.listRequest},cachedItems=Akumina.AddIn.Cache.Get(_cur.GetCacheKey()),cachedItems&&cachedItems!=null?_cur.BindTemplate(_cur.listRequest.displayTemplateUrl,cachedItems,_cur.listRequest.SenderId):_cur.GetDataAsync(dataLoadProperties).then(function(result){Akumina.AddIn.Cache.Set(_cur.GetCacheKey(),result.response,_cur.GetCacheInterval());_cur.BindTemplate(_cur.listRequest.displayTemplateUrl,result.response,_cur.listRequest.SenderId)},function(errorObj){_cur.BindTemplate(_cur.GetErrorTemplate(),errorObj,_cur.listRequest.SenderId);Akumina.AddIn.Logger.WriteErrorLog("GenericListControlWidget GetDataAsync error: "+errorObj.message)})):(cachedItems=Akumina.AddIn.Cache.Get(_cur.GetCacheKey()),cachedItems&&cachedItems!=null?_cur.BindTemplate(_cur.listRequest.displayTemplateUrl,cachedItems,_cur.listRequest.SenderId):(instruction=new Akumina.AddIn.Instructions,instruction.executeAsync(_cur,_cur.listRequest.instructionSet,"").then(function(result){var utils=Akumina.AddIn.Utilities,context,web,site;_cur.listRequest=result.listRequest;context=new SP.ClientContext.get_current;JSON.parse(_cur.listRequest.rootWeb)?(site=context.get_site(),web=site.get_rootWeb()):web=context.get_web();var list=web.get_lists().getByTitle(_cur.listRequest.listName),camlQuery=new SP.CamlQuery,query=_cur.listRequest.viewXml;utils.IsNullOrEmpty(query)&&(query="<View><RowLimit>"+_cur.listRequest.pageSize+"<\/RowLimit><\/View>");JSON.parse(_cur.listRequest.isPaging)&&(_cur.genericListPagingObj.nextPagingInfo?(_cur.genericListPagingObj.position=new SP.ListItemCollectionPosition,_cur.genericListPagingObj.position.set_pagingInfo(_cur.genericListPagingObj.nextPagingInfo)):_cur.genericListPagingObj.position=null,camlQuery.set_listItemCollectionPosition(_cur.genericListPagingObj.position));camlQuery.set_viewXml(query);_cur.listRequest.listItems=list.getItems(camlQuery);utils.IsNullOrEmpty(_cur.listRequest.selectFields)?(_cur.listRequest.listFields=list.get_fields(),context.load(_cur.listRequest.listFields),context.load(_cur.listRequest.listItems)):context.load(_cur.listRequest.listItems,"ListItemCollectionPosition","Include("+_cur.listRequest.selectFields+")");Akumina.AddIn.Logger.logSPCall("GenericListControl.prototype.render ("+_cur.listRequest.listName+")");context.executeQueryAsync(Function.createDelegate(_cur,_cur.Success),Function.createDelegate(_cur,_cur.Error))})))};this.GetDataAsync=function(data){var def,theCallBack,errorObj;if(Akumina.AddIn.Logger.WriteInfoLog("GenericListControlWidget.GetDataAsync Executing callback method: "+_cur.listRequest.callbackMethod),def=$.Deferred(),theCallBack=window[_cur.listRequest.callbackMethod],typeof theCallBack=="function")try{theCallBack(data.response,def)}catch(e){Akumina.AddIn.Logger.WriteErrorLog(this.listRequest.callbackMethod+" had an error: "+e);errorObj={sender:this.listRequest.callbackMethod,message:e};def.reject(errorObj)}return def};this.Success=function(){var listEnumerator=_cur.listRequest.listItems.getEnumerator(),data={},item,listItem,fields,i,fieldName,result;for(data.Items=[],JSON.parse(_cur.listRequest.isPaging)&&(_cur.genericListPagingObj.nextPagingInfo=_cur.listRequest.listItems.get_listItemCollectionPosition()?_cur.listRequest.listItems.get_listItemCollectionPosition().get_pagingInfo():null,_cur.genericListPagingObj.nextPagingInfo||(_cur.genericListPagingObj.isLastPage=!0));listEnumerator.moveNext();){if(item={},listItem=listEnumerator.get_current(),typeof _cur.listRequest.listFields!="undefined")for(fields=_cur.listRequest.listFields.getEnumerator();fields.moveNext();)fieldName=fields.get_current().get_staticName(),item[fieldName]=listItem.get_fieldValues()[fieldName];else for(fields=_cur.listRequest.selectFields.split(","),i=0;i<fields.length;i++)fieldName=fields[i],item[fieldName]=listItem.get_fieldValues()[fieldName];data.Items.push(item)}JSON.parse(_cur.listRequest.isPaging)&&(_cur.genericListPagingObj.pageWiseResult.push(data.Items),data.Items=_cur.genericListPagingObj.GetFinalResult(data.Items));result={response:data,request:_cur.listRequest};_cur.listRequest.EditMode||_cur.BindData(_cur.listRequest.displayTemplateUrl,result.response,_cur.listRequest.SenderId)};this.BindEvents=function(){JSON.parse(_cur.listRequest.isPaging)&&$("#"+_cur.listRequest.SenderId+" .showMoreResults a").unbind().click(function(){_cur.genericListPagingObj.isLastPage||_cur.Render()})};this.GetPagingParameterValue=function(parameterName){for(var singleParam,params=_cur.genericListPagingObj.nextPagingInfo.split("&"),i=0;i<params.length;i=i+1)if(singleParam=params[i].split("="),singleParam[0]===parameterName)return decodeURIComponent(singleParam[1]);return""};this.Error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("GenericListControlWidget Request failed. "+args.get_message()+"\n"+args.get_stackTrace());var errorObj={sender:sender,message:args.get_message()};_cur.BindTemplate(_cur.GetErrorTemplate(),errorObj,_cur.listRequest.SenderId)};this.BindTemplate=function(templateUri,data,targetDiv){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){$("#"+targetDiv).html(html);_cur.BindEvents();Akumina.Digispace.AppPart.Eventing.Publish("/genericlistcontrol/loaded/",{callback:_cur.listRequest.callbackMethod});(!JSON.parse(_cur.listRequest.isPaging)||_cur.genericListPagingObj.isLastPage)&&$("#"+_cur.listRequest.SenderId+" .showMoreResults").hide()},function(errormsg){_cur.BindTemplate(_cur.GetErrorTemplate(),{sender:_cur.listRequest.SenderId,message:errormsg},_cur.listRequest.SenderId)})};this.BindData=function(templateUri,data,targetDiv){var theCallBack=window[this.listRequest.callbackMethod],hadError=!1,errorObj;if(typeof theCallBack=="function"){Akumina.AddIn.Logger.WriteInfoLog("GenericListControlWidget Executing callback method: "+this.listRequest.callbackMethod);try{data=theCallBack(data)}catch(e){Akumina.AddIn.Logger.WriteErrorLog(this.listRequest.callbackMethod+" had an error: "+e);hadError=!0;errorObj={sender:this.listRequest.callbackMethod,message:e};_cur.BindTemplate(_cur.GetErrorTemplate(),errorObj,_cur.listRequest.SenderId)}}hadError==!1&&(JSON.parse(_cur.listRequest.isPaging)||Akumina.AddIn.Cache.Set(_cur.GetCacheKey(),data,_cur.GetCacheInterval()),_cur.BindTemplate(templateUri,data,targetDiv))}});typeof Akumina.AddIn.DashboardContainerWidget=="undefined"&&(Akumina.AddIn.DashboardContainerWidget=function(){var _cur=this;_cur.Request=null;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.GetDefaultTemplateUrl=function(){return(new Akumina.Digispace.AppPart.Data).Templates.GetCoreTemplate("DashboardList.html")};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.rootWeb=_cur.GetPropertyValue(requestIn,"isroot","true"),requestOut.selectFields=_cur.GetPropertyValue(requestIn,"selectfields","ID,ItemList"),requestOut.isPaging=_cur.GetPropertyValue(requestIn,"ispaging","false"),requestOut.pageSize=_cur.GetPropertyValue(requestIn,"pagesize","10"),requestOut.listName=_cur.GetPropertyValue(requestIn,"listname","MyDashboard_AK"),requestOut.instructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.displayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",_cur.GetDefaultTemplateUrl()),requestOut.callbackMethod=_cur.GetPropertyValue(requestIn,"callbackmethod","ShowDashboardItems"),requestOut.isAsyncCallback=_cur.GetPropertyValue(requestIn,"isasynccallback","false"),requestOut.viewXml=_cur.GetPropertyValue(requestIn,"viewxml","<View><Query><Where><Eq><FieldRef Name='DashboardUser'/><Value Type='User'><UserID/><\/Value><\/Eq><\/Where><\/Query><\/View>"),requestOut.callbackType=_cur.GetPropertyValue(requestIn,"callbacktype","postdataload"),requestOut.dataLoadProperties=_cur.GetPropertyValue(requestIn,"dataloadproperties",""),requestOut.CacheInterval=_cur.GetPropertyValue(requestIn,"cacheinterval","0"),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","dashboardcontainer"),requestOut};this.Init=function(genericListControl){_cur.Request=_cur.SetDefaultsProperties(genericListControl);var control=new Akumina.AddIn.GenericListControlWidget;control.Init(genericListControl);_cur.listControl=control;_cur.Prerender()};this.Prerender=function(){Akumina.Digispace.AppPart.Eventing.Subscribe("/dashboardcontainer/render/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RefreshWidget=function(newProps){if(newProps.id==_cur.Request.id){var control=new Akumina.AddIn.GenericListControlWidget;control.Init(newProps);_cur.listControl=control;_cur.Render()}};this.Render=function(){_cur.listControl.Render()}});typeof Akumina.AddIn.MyTeamWidget=="undefined"&&(Akumina.AddIn.MyTeamWidget=function(){var _cur=this;_cur.viewModel={};this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.rootWeb=_cur.GetPropertyValue(requestIn,"isroot","true"),requestOut.selectFields=_cur.GetPropertyValue(requestIn,"selectfields",""),requestOut.isPaging=_cur.GetPropertyValue(requestIn,"ispaging","false"),requestOut.pageSize=_cur.GetPropertyValue(requestIn,"pagesize","10"),requestOut.listName=_cur.GetPropertyValue(requestIn,"listname",""),requestOut.instructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.callbackMethod=_cur.GetPropertyValue(requestIn,"callbackmethod",""),requestOut.isAsyncCallback=_cur.GetPropertyValue(requestIn,"isasynccallback","false"),requestOut.viewXml=_cur.GetPropertyValue(requestIn,"viewxml",""),requestOut.callbackType=_cur.GetPropertyValue(requestIn,"callbacktype","postdataload"),requestOut.dataLoadProperties=_cur.GetPropertyValue(requestIn,"dataloadproperties",""),requestOut.CacheInterval=_cur.GetPropertyValue(requestIn,"cacheinterval",null),requestOut.FetchPhotoFromAD=_cur.GetPropertyValue(requestIn,"fetchphotofromad",null),requestOut};this.Init=function(MyTeamRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.MyTeamRequest=_cur.SetDefaultsProperties(MyTeamRequest);_cur.MyTeamRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=this.MyTeamRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/myteam/profileclicked/",_cur.OnProfileClicked);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="MyTeam";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"rootWeb","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"isPaging","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"isAsyncCallback","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"FetchPhotoFromAD","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.MyTeamRequest.SenderId&&(_cur.MyTeamRequest=_cur.SetDefaultsProperties(newProps),_cur.MyTeamRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.Render())};this.Render=function(caller){var data={},searchText;data.Items=[];data.SenderId=_cur.MyTeamRequest.SenderId;_cur.viewModel.filter={filters:[]};caller&&caller=="search"&&(searchText=$(".ia-searchBox").val(),searchText.trim().length>2&&_cur.viewModel.filter.filters.push({property:"displayName",values:[searchText],operator:"starts-with"}));_cur.GetUsersForDepartment(_cur.viewModel.filter).then(function(users){var result;data.Items=users;data.Items=data.Items.slice(0,_cur.MyTeamRequest.pageSize);_cur.viewModel.users=data.Items;result={response:data,request:_cur.MyTeamRequest};_cur.MyTeamRequest.EditMode||(result=_cur.GetData(result),_cur.BindTemplate(_cur.MyTeamRequest.DisplayTemplateUrl,result,_cur.MyTeamRequest.SenderId,caller))})};this.GetUsersForDepartment=function(filter){var def=$.Deferred(),peopleDirectoryObj;return Akumina.Digispace.ConfigurationContext.EnableAzureAD?(filter.filters.push({property:"department",values:[Akumina.Digispace.UserContext.Department],operator:"equals"}),peopleDirectoryObj=new Akumina.AddIn.PeopleDirectoryWidget,peopleDirectoryObj.GetGraphUsersDataModel(_spPageContextInfo.userLoginName,filter,peopleDirectoryObj.PagingManager.pageSize,peopleDirectoryObj.PagingManager.pageNumber,"givenName").then(function(graphUsers){def.resolve(graphUsers)},function(errorMessage){_cur.OnError(errorMessage)})):_cur.OnError("Your Azure AD is not configured"),def};this.OnError=function(errorMessage){$("#"+_cur.MyTeamRequest.SenderId).html(errorMessage)};this.BindTemplate=function(templateUri,data,targetDiv,caller){caller=="search"?((new Akumina.Digispace.AppPart.Data).Templates.BindTemplateAndCallback(_cur.viewModel.resultsSection.html(),".ia-users-data",data),_cur.PostRender()):(new Akumina.Digispace.AppPart.Data).Templates.RequestTemplateFromServer(templateUri).then(function(template){(new Akumina.Digispace.AppPart.Data).Templates.CacheTemplate(templateUri,template);_cur.viewModel.resultsSection=$(template).find(".ia-users-data");(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).done(function(html){$("#"+targetDiv).html(html);_cur.PostRender()})},function(errormsg){var data={sender:_cur.MyTeamRequest.SenderId,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.MyTeamRequest.SenderId).html(html)})})};this.PostRender=function(){_cur.BindEvents()};this.BindEvents=function(){var subscriptionId=Akumina.Digispace.ConfigurationContext.GraphSubscriptionId,clientId=Akumina.Digispace.ConfigurationContext.GraphClientId,searchContext={SubscriptionId:subscriptionId,AppId:clientId,SkipToken:null,FetchPhotoFromAD:_cur.MyTeamRequest.FetchPhotoFromAD},peopleSearch=new PeopleDirectory_SearchAllUsers(searchContext);$(".ia-profile-detail-link img").each(function(){var me=this,profileUserName=$(me).attr("data-user");peopleSearch.getProfilePicture(profileUserName,me,_spPageContextInfo.userLoginName)});$(".ia-modal-inline-trigger").unbind().click(function(){var itemId=$(this).data("id"),profileDetails={itemId:itemId};Akumina.Digispace.AppPart.Eventing.Publish("/myteam/profileclicked/",profileDetails)});$(".ia-searchBox").unbind();$(".ia-searchBox").donetyping(function(){var val=$(this).val();val.length<3&&(val="");val!=""&&_cur.Render("search")});$(".ia-searchBox").on("keyup",function(event){var val=$(this).val();(val.length<=2&&event.keyCode==8||event.keyCode==46)&&(oldValue="",_cur.Render("search"))});$(".ia-searchBox").keypress(function(event){event.keyCode==13&&event.preventDefault()})};this.OnProfileClicked=function(profileDetails){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("OnProfileClicked");var itemInformation=_cur.viewModel.users.filter(function(element){if(element.Id==profileDetails.itemId)return element});_cur.ShowDetailedProfile(itemInformation[0])};this.ShowDetailedProfile=function(itemInformation){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("ShowDetailedProfile");var mail=itemInformation.mail==null||itemInformation.mail==""?itemInformation.userprincipalname:itemInformation.mail,pictureURL=$(".ia-profile-detail-link img[data-user='"+mail+"']").attr("src"),model={PictureURL:pictureURL,FirstName:itemInformation.givenname,LastName:itemInformation.surname,Name:itemInformation.displayname,Title:itemInformation.jobtitle,Department:itemInformation.department,Office:itemInformation.officelocation,WorkPhone:itemInformation.businessphones,CellPhone:itemInformation.mobilephone,Fax:itemInformation.facsimiletelephonenumber,Email:mail};$("#user-popup").html($("#template-userpopup").html().replace(/{ {/g,"{{").replace(/} }/g,"}}"));(new Akumina.Digispace.AppPart.Data).Templates.BindTemplateAndCallback($("#user-popup").html(),"#user-popup",model);$.magnificPopup.open({items:{src:".user-popup",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0})};this.GetData=function(data){var data,theCallBack=window[_cur.MyTeamRequest.callbackMethod];return typeof theCallBack=="function"&&(data=theCallBack(data.response)),data}});typeof Akumina.AddIn.RssNewsWidget=="undefined"&&(Akumina.AddIn.RssNewsWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.RssUrl=_cur.GetPropertyValue(requestIn,"rssurl",""),requestOut.callbackMethod=_cur.GetPropertyValue(requestIn,"callbackmethod",""),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","rssnews"),requestOut};this.Init=function(RssNewsRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.RssNewsRequest=_cur.SetDefaultsProperties(RssNewsRequest);_cur.RssNewsRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=this.RssNewsRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="RssNews";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.RssNewsRequest.SenderId&&(_cur.RssNewsRequest=_cur.SetDefaultsProperties(newProps),_cur.RssNewsRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.Render())};this.Render=function(){var data={},rssUrl;data.Items=[];rssUrl=_cur.RssNewsRequest.RssUrl;$.ajax({url:rssUrl,success:function(json){var feedItems,maxItems,i,feedEntry,result;for(data.SenderId=_cur.RssNewsRequest.SenderId,feedItems=[],json.query.results.feed!=null?feedItems=json.query.results.feed.entry:json.query.results.rss!=null&&(feedItems=json.query.results.rss.channel.item),maxItems=3,i=0;i<feedItems.length;i++){var feedEntryData=feedItems[i],title=feedEntryData.title,url="";if(feedEntryData.origLink!=null?url=feedEntryData.origLink:feedEntryData.link!=null&&(url=feedEntryData.link),data.Items.length>=maxItems)break;feedEntry={Title:title,Url:url};data.Items.push(feedEntry)}result={response:data,request:_cur.RssNewsRequest};_cur.RssNewsRequest.EditMode||(result=_cur.GetData(result),_cur.BindTemplate(_cur.RssNewsRequest.DisplayTemplateUrl,result,_cur.RssNewsRequest.SenderId))},error:function(){Akumina.AddIn.Logger.WriteErrorLog("Error with getting feed from url - "+rssUrl)}})};this.BindTemplate=function(templateUri,data,targetDiv){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){$("#"+targetDiv).html(html)},function(errormsg){var data={sender:_cur.RssNewsRequest.SenderId,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.RssNewsRequest.SenderId).html(html)})})};this.GetData=function(data){var data,theCallBack=window[_cur.RssNewsRequest.callbackMethod];return typeof theCallBack=="function"&&(data=theCallBack(data.response)),data}});typeof Akumina.AddIn.WeatherWidget=="undefined"&&(Akumina.AddIn.WeatherWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue,useDefaultFirstOption){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return defaultValue!=null&&defaultValue.toString().trim()!=""&&useDefaultFirstOption==!0?defaultValue:propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.GetDefaultTemplateUrl=function(){return __getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/Weather.html"};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",_cur.GetDefaultTemplateUrl()),requestOut.City=_cur.GetPropertyValue(requestIn,"city",Akumina.Digispace.UserContext.City,!0),requestOut.State=_cur.GetPropertyValue(requestIn,"state",Akumina.Digispace.UserContext.State,!0),requestOut.PostalCode=_cur.GetPropertyValue(requestIn,"postalcode",Akumina.Digispace.UserContext.PostalCode,!0),requestOut.callbackMethod=_cur.GetPropertyValue(requestIn,"callbackmethod",""),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","weather"),requestOut};this.Init=function(WeatherRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.WeatherRequest=_cur.SetDefaultsProperties(WeatherRequest);_cur.WeatherRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=this.WeatherRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="Weather";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.WeatherRequest.SenderId&&(_cur.WeatherRequest=_cur.SetDefaultsProperties(newProps),_cur.WeatherRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.Render())};this.Render=function(){var postalCode=_cur.WeatherRequest.PostalCode,location=_cur.getLocation(),data={},rssUrl;data.Items=[];rssUrl="https://query.yahooapis.com/v1/public/yql?q=select item.condition from weather.forecast where woeid in (select woeid from geo.places(1) where text='"+postalCode+"')&format=json";$.ajax({url:rssUrl,success:function(json){var weatherItem,currentCondition,result;data.SenderId=_cur.WeatherRequest.SenderId;weatherItem=json.query.results.channel.item;currentCondition=weatherItem.condition;data.Location=location;data.Temperature=currentCondition.temp;var currentDate=currentCondition.date,currentYear=(new Date).getFullYear().toString(),yearIndex=currentDate.indexOf(currentYear)+currentYear.length,currentTime=currentDate.substring(yearIndex);data.Time=currentTime;data.Description=currentCondition.text;result={response:data,request:_cur.WeatherRequest};_cur.WeatherRequest.EditMode||(result.response=_cur.GetData(result),_cur.BindTemplate(_cur.WeatherRequest.DisplayTemplateUrl,result,_cur.WeatherRequest.SenderId))},error:function(){Akumina.AddIn.Logger.WriteErrorLog("Error with getting weather.")}})};this.getLocation=function(){var location=_cur.WeatherRequest.City;return location+(location!=""?", "+_cur.WeatherRequest.State:_cur.WeatherRequest.State)};this.BindTemplate=function(templateUri,data,targetDiv){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){$("#"+targetDiv).html(html)},function(errormsg){var data={sender:_cur.WeatherRequest.SenderId,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.WeatherRequest.SenderId).html(html)})})};this.GetData=function(data){var data,theCallBack=window[_cur.WeatherRequest.callbackMethod];return typeof theCallBack=="function"&&(data=theCallBack(data.response)),data}});typeof Akumina.AddIn.DocumentsSummaryListWidget=="undefined"&&(Akumina.AddIn.DocumentsSummaryListWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.GetDefaultTemplateUrl=function(){return __getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/DocumentsSummaryList/Default.html"};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.Title=_cur.GetPropertyValue(requestIn,"title","Document Summary List"),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",_cur.GetDefaultTemplateUrl()),requestOut.Icon=_cur.GetPropertyValue(requestIn,"icon","None"),requestOut.TargetDocumentLibrary=_cur.GetPropertyValue(requestIn,"targetdocumentlibrary","Documents"),requestOut.TabList=_cur.GetPropertyValue(requestIn,"tablist","Newest,My Recent,Popular,Recommended"),requestOut.NewestNumberOfFiles=JSON.parse(_cur.GetPropertyValue(requestIn,"newestnumberoffiles",20)),requestOut.RecentNumberOfFiles=JSON.parse(_cur.GetPropertyValue(requestIn,"recentnumberoffiles",20)),requestOut.PopularNumberOfFiles=JSON.parse(_cur.GetPropertyValue(requestIn,"popularnumberoffiles",20)),requestOut.RecommendedNumberOfFiles=JSON.parse(_cur.GetPropertyValue(requestIn,"recommendednumberoffiles",20)),requestOut.NewestInformationText=_cur.GetPropertyValue(requestIn,"newestinformationtext",""),requestOut.RecentInformationText=_cur.GetPropertyValue(requestIn,"recentinformationtext",""),requestOut.PopularInformationText=_cur.GetPropertyValue(requestIn,"popularinformationtext",""),requestOut.RecommendedInformationText=_cur.GetPropertyValue(requestIn,"recommendedinformationtext",""),requestOut.PopularNumberOfDays=JSON.parse(_cur.GetPropertyValue(requestIn,"popularnumberofdays",30)),requestOut.CurrentSite=_cur.GetPropertyValue(requestIn,"currentsite","false"),requestOut.CurrentSite=requestOut.CurrentSite=="true"||requestOut.CurrentSite==!0,requestOut.SiteId=_cur.GetPropertyValue(requestIn,"siteid",""),requestOut.SiteUrl=_cur.GetPropertyValue(requestIn,"siteurl",""),requestOut.WebId=_cur.GetPropertyValue(requestIn,"webid",""),requestOut.ListIds=_cur.GetPropertyValue(requestIn,"listids",[]),requestOut.SitesToFind=_cur.GetPropertyValue(requestIn,"sitestofind",[]),requestOut.SitesFound=_cur.GetPropertyValue(requestIn,"sitesfound",[]),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","documentssummarylist"),requestOut};this.Init=function(DocumentSummaryRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.DocumentSummaryRequest=_cur.SetDefaultsProperties(DocumentSummaryRequest);_cur.DocumentSummaryRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.getCacheKey=function(attribute){var prefix=Akumina.Digispace.ConfigurationContext.getCacheKey("dsl:"+_cur.DocumentSummaryRequest.SenderId),basedOnRequest=_cur.DocumentSummaryRequest.CurrentSite.toString();return basedOnRequest+=":"+_cur.DocumentSummaryRequest.TargetDocumentLibrary,basedOnRequest+=":"+_cur.DocumentSummaryRequest.TabList.split(",").join(","),attribute!=null&&(basedOnRequest+=":"+attribute),prefix+basedOnRequest};this.Prerender=function(){var targetDiv=_cur.DocumentSummaryRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="DocumentsSummaryList";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"CurrentSite","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"Hosted","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.DocumentSummaryRequest.SenderId&&(_cur.DocumentSummaryRequest=_cur.SetDefaultsProperties(newProps),_cur.DocumentSummaryRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.Render())};this.Render=function(){var searchJSPath="/_layouts/15/SP.Search.JS";_spPageContextInfo.siteServerRelativeUrl!="/"&&(searchJSPath=_spPageContextInfo.siteServerRelativeUrl+searchJSPath);$.getScript(searchJSPath,function(){_cur.getItem()})};this.getItem=function(){var model=Akumina.AddIn.Cache.Get(_cur.getCacheKey()),context,parentContext;if(model!=null){_cur.postData(model);return}context=new SP.ClientContext.get_current;_cur.DocumentSummaryRequest.Hosted?(parentContext=new SP.AppContextSite(context,_cur.hostUrl),_cur.DocumentSummaryRequest.CurrentSite?(_cur.web=parentContext.get_web(),_cur.site=parentContext.get_site(),_cur.listCollection=_cur.web.get_lists(),_cur.webCollection=null):(_cur.web=parentContext.get_site().get_rootWeb(),_cur.site=parentContext.get_site(),_cur.listCollection=_cur.web.get_lists(),_cur.webCollection=_cur.web.getSubwebsForCurrentUser(null),context.load(_cur.webCollection,"Include(Title, Id, Lists)"))):_cur.DocumentSummaryRequest.CurrentSite?(_cur.web=context.get_web(),_cur.site=context.get_site(),_cur.listCollection=_cur.web.get_lists(),_cur.webCollection=null):(_cur.web=context.get_site().get_rootWeb(),_cur.site=context.get_site(),_cur.listCollection=_cur.web.get_lists(),_cur.webCollection=_cur.web.getSubwebsForCurrentUser(null),context.load(_cur.webCollection,"Include(Title, Id, Lists)"));_cur.user=_cur.web.get_currentUser();context.load(_cur.web);context.load(_cur.site);context.load(_cur.user);context.load(_cur.listCollection,"Include(Title, Id)");Akumina.AddIn.Logger.logSPCall("DocumentsSummaryList.prototype.getItem");context.executeQueryAsync(Function.createDelegate(_cur,_cur.getValues),Function.createDelegate(_cur,_cur.error))};this.convertSearchKeywordQuery=function(targetDocumentLibrary){var keywordFormat,index,docListID;if(targetDocumentLibrary=="")return"";for(keywordFormat=" AND (",index=0,i=0;i<_cur.DocumentSummaryRequest.ListIds.length;i++)docListID=_cur.DocumentSummaryRequest.ListIds[i],keywordFormat+=index==0?" ListID:"+docListID:" OR ListID:"+docListID,index++;return keywordFormat+" )"};this.obtainListIds=function(currentListEnumerator){var lists=_cur.DocumentSummaryRequest.TargetDocumentLibrary.split(","),listName;if(currentListEnumerator!=null)while(currentListEnumerator.moveNext()){var oList=currentListEnumerator.get_current(),listTitle=oList.get_title();for(i=0;i<lists.length;i++)if(listName=$.trim(lists[i]).toLowerCase(),listName!=""&&listTitle.toString().toLowerCase()==listName){_cur.DocumentSummaryRequest.ListIds.push(oList.get_id().toString());break}}};this.retrieveSpecificListProperties=function(parentWeb,siteId){var clientContext=null;parentWeb!=null&&(_cur["spWeb-"+siteId]=parentWeb,clientContext=parentWeb.get_context(),_cur["webCollection-"+siteId]=parentWeb.get_webs(),_cur["listCollection-"+siteId]=parentWeb.get_lists(),clientContext.load(_cur["spWeb-"+siteId]),clientContext.load(_cur["webCollection-"+siteId],"Include(Title, Id, Lists)"),clientContext.load(_cur["listCollection-"+siteId],"Include(Title, Id)"),Akumina.AddIn.Logger.logSPCall("DocumentsSummaryList.prototype.retrieveSpecificListProperties"),clientContext.executeQueryAsync(Function.createDelegate(_cur,function(){_cur.getValues(siteId)}),Function.createDelegate(_cur,_cur.error)))};this.setDisplayTabs=function(model){var tabList,i,tab;for(model.ShowNewestTab=!1,model.NewestTabPosition=0,model.ShowRecentTab=!1,model.RecentTabPosition=0,model.ShowPopularTab=!1,model.PopularTabPosition=0,model.ShowRecommendedTab=!1,model.RecommendedTabPosition=0,tabList=_cur.DocumentSummaryRequest.TabList.split(","),i=0;i<tabList.length;i++){tab=tabList[i].toLowerCase().replace(/ /gi,"");switch(tab){case"newest":model.ShowNewestTab=!0;model.NewestTabPosition=i;break;case"myrecent":model.ShowRecentTab=!0;model.RecentTabPosition=i;break;case"popular":model.ShowPopularTab=!0;model.PopularTabPosition=i;break;case"recommended":model.ShowRecommendedTab=!0;model.RecommendedTabPosition=i}}return model};this.getValues=function(siteId){var rootSite=!0,fromCache,cacheListIds,currentListEnumerator,localWebCollection,webEnumerator,web,theWebId;if(_cur.DocumentSummaryRequest.SiteId==""&&(_cur.DocumentSummaryRequest.SiteId=_cur.site.get_id().toString()),_cur.DocumentSummaryRequest.SiteUrl==""&&(_cur.DocumentSummaryRequest.SiteUrl=_cur.web.get_url().toString()),_cur.DocumentSummaryRequest.WebId==""?(_cur.DocumentSummaryRequest.WebId=_cur.web.get_id().toString(),siteId=_cur.DocumentSummaryRequest.WebId,_cur.DocumentSummaryRequest.SitesToFind.push(siteId)):rootSite=!1,fromCache=!1,cacheListIds=Akumina.AddIn.Cache.Get(_cur.getCacheKey("ListIds")),cacheListIds!=null)_cur.DocumentSummaryRequest.ListIds=cacheListIds,fromCache=!0;else if(currentListEnumerator=null,currentListEnumerator=rootSite?_cur.listCollection.getEnumerator():_cur["listCollection-"+siteId].getEnumerator(),_cur.obtainListIds(currentListEnumerator),_cur.DocumentSummaryRequest.SitesFound.push(siteId),localWebCollection=null,localWebCollection=rootSite?_cur.webCollection:_cur["webCollection-"+siteId],localWebCollection!=null)for(webEnumerator=localWebCollection.getEnumerator();webEnumerator.moveNext();)web=webEnumerator.get_current(),theWebId=web.get_id().toString(),_cur.DocumentSummaryRequest.SitesToFind.push(web.get_id().toString()),_cur.retrieveSpecificListProperties(web,theWebId);fromCache||_cur.DocumentSummaryRequest.CurrentSite?_cur.getSearch():_cur.DocumentSummaryRequest.SitesToFind.length>0&&_cur.DocumentSummaryRequest.SitesFound.length>0&&_cur.DocumentSummaryRequest.SitesToFind.length==_cur.DocumentSummaryRequest.SitesFound.length&&(Akumina.AddIn.Cache.Set(_cur.getCacheKey("ListIds"),_cur.DocumentSummaryRequest.ListIds,Akumina.AddIn.Constants.LONG_CACHE_EXPIRATION),_cur.getSearch())};this.getSearch=function(){var context=new SP.ClientContext.get_current,newKeywordQuery=new Microsoft.SharePoint.Client.Search.Query.KeywordQuery(context),queryText=_cur.getDocumentsQuery(_cur.convertSearchKeywordQuery(_cur.DocumentSummaryRequest.TargetDocumentLibrary)),recentKeywordQuery,popularKeywordQuery,recommendedKeywordQuery,sortproperties,searchExecutor;newKeywordQuery.set_queryText(queryText);newKeywordQuery.set_rowLimit(_cur.DocumentSummaryRequest.NewestNumberOfFiles);newKeywordQuery.set_trimDuplicates(!1);newKeywordQuery.set_enableSorting(!0);sortproperties=newKeywordQuery.get_sortList();sortproperties.add("LastModifiedTime",1);recentKeywordQuery=new Microsoft.SharePoint.Client.Search.Query.KeywordQuery(context);queryText=_cur.getDocumentsQuery(_cur.convertSearchKeywordQuery(_cur.DocumentSummaryRequest.TargetDocumentLibrary)+" AND ModifiedBy:'"+_cur.user.get_title()+"'");recentKeywordQuery.set_queryText(queryText);recentKeywordQuery.set_rowLimit(_cur.DocumentSummaryRequest.RecentNumberOfFiles);recentKeywordQuery.set_trimDuplicates(!1);recentKeywordQuery.set_enableSorting(!0);sortproperties=recentKeywordQuery.get_sortList();sortproperties.add("LastModifiedTime",1);popularKeywordQuery=new Microsoft.SharePoint.Client.Search.Query.KeywordQuery(context);queryText=_cur.getDocumentsQuery(_cur.convertSearchKeywordQuery(_cur.DocumentSummaryRequest.TargetDocumentLibrary));popularKeywordQuery.set_queryText(queryText);popularKeywordQuery.set_rowLimit(_cur.DocumentSummaryRequest.PopularNumberOfFiles);popularKeywordQuery.set_trimDuplicates(!1);popularKeywordQuery.set_enableSorting(!0);sortproperties=popularKeywordQuery.get_sortList();sortproperties.add("ViewsRecent",0);recommendedKeywordQuery=new Microsoft.SharePoint.Client.Search.Query.KeywordQuery(context);queryText=_cur.getDocumentsQuery(_cur.convertSearchKeywordQuery(_cur.DocumentSummaryRequest.TargetDocumentLibrary)+" AND owstaxidmetadataalltagsinfo:Recommended");recommendedKeywordQuery.set_queryText(queryText);recommendedKeywordQuery.set_rowLimit(_cur.DocumentSummaryRequest.RecommendedNumberOfFiles);recommendedKeywordQuery.set_trimDuplicates(!1);recommendedKeywordQuery.set_enableSorting(!0);sortproperties=recommendedKeywordQuery.get_sortList();sortproperties.add("LastModifiedTime",1);searchExecutor=new Microsoft.SharePoint.Client.Search.Query.SearchExecutor(context);_cur.newSearchResults=searchExecutor.executeQuery(newKeywordQuery);_cur.recentSearchResults=searchExecutor.executeQuery(recentKeywordQuery);_cur.popularSearchResults=searchExecutor.executeQuery(popularKeywordQuery);_cur.recommendedSearchResults=searchExecutor.executeQuery(recommendedKeywordQuery);Akumina.AddIn.Logger.logSPCall("DocumentsSummaryList.prototype.getSearch");context.executeQueryAsync(Function.createDelegate(_cur,_cur.success),Function.createDelegate(_cur,_cur.error))};this.success=function(){var model={},i,searchResult,searchItem;for(model.NewItems=[],model.RecentItems=[],model.PopularItems=[],model.RecommendedItems=[],i=0;i<_cur.newSearchResults.m_value.ResultTables[0].ResultRows.length;i++)searchResult=_cur.newSearchResults.m_value.ResultTables[0].ResultRows[i],searchItem=_cur.getSearchItem(searchResult),model.NewItems.push(searchItem);for(i=0;i<_cur.recentSearchResults.m_value.ResultTables[0].ResultRows.length;i++)searchResult=_cur.recentSearchResults.m_value.ResultTables[0].ResultRows[i],searchItem=_cur.getSearchItem(searchResult),model.RecentItems.push(searchItem);for(i=0;i<_cur.popularSearchResults.m_value.ResultTables[0].ResultRows.length;i++)searchResult=_cur.popularSearchResults.m_value.ResultTables[0].ResultRows[i],searchItem=_cur.getSearchItem(searchResult),model.PopularItems.push(searchItem);for(i=0;i<_cur.recommendedSearchResults.m_value.ResultTables[0].ResultRows.length;i++)searchResult=_cur.recommendedSearchResults.m_value.ResultTables[0].ResultRows[i],searchItem=_cur.getSearchItem(searchResult),model.RecommendedItems.push(searchItem);Akumina.AddIn.Cache.Set(_cur.getCacheKey(),model,Akumina.AddIn.Constants.SHORT_CACHE_EXPIRATION);_cur.postData(model)};this.postData=function(model){_cur.DocumentSummaryRequest=_cur.setDisplayTabs(_cur.DocumentSummaryRequest);model.Title=_cur.DocumentSummaryRequest.Title;model.WebPartIcon=Akumina.AddIn.Utilities.GetIcon(_cur.DocumentSummaryRequest.Icon);model.ShowHeader=model.Title!=""||model.WebPartIcon!="none";model.NewestInformationText=_cur.DocumentSummaryRequest.NewestInformationText;model.RecentInformationText=_cur.DocumentSummaryRequest.RecentInformationText;model.PopularInformationText=_cur.DocumentSummaryRequest.PopularInformationText;model.RecommendedInformationText=_cur.DocumentSummaryRequest.RecommendedInformationText;model.PopularDays=_cur.DocumentSummaryRequest.PopularNumberOfDays;model.CurrentSite=_cur.DocumentSummaryRequest.CurrentSite;model.ShowNewestTab=_cur.DocumentSummaryRequest.ShowNewestTab;model.NewestTabPosition=_cur.DocumentSummaryRequest.NewestTabPosition;model.ShowRecentTab=_cur.DocumentSummaryRequest.ShowRecentTab;model.RecentTabPosition=_cur.DocumentSummaryRequest.RecentTabPosition;model.ShowPopularTab=_cur.DocumentSummaryRequest.ShowPopularTab;model.PopularTabPosition=_cur.DocumentSummaryRequest.PopularTabPosition;model.ShowRecommendedTab=_cur.DocumentSummaryRequest.ShowRecommendedTab;model.RecommendedTabPosition=_cur.DocumentSummaryRequest.RecommendedTabPosition;model.SenderId=_cur.DocumentSummaryRequest.SenderId;model.hosted=_cur.DocumentSummaryRequest.Hosted;_cur.DocumentSummaryRequest.EditMode||_cur.render(_cur.DocumentSummaryRequest.DisplayTemplateUrl,model)};this.getSearchItem=function(searchResult){var ParentLink=searchResult.ParentLink,path=ParentLink.replace("/Forms/AllItems.aspx","").replace("/AllItems.aspx","").replace("/Forms/Thumbnails.aspx",""),serverRedirectURL=searchResult.OriginalPath.toString(),docID=searchResult.DocId.toString(),title=searchResult.Title.toString(),authorVal=searchResult.EditorOWSUSER,author=authorVal==null||authorVal==""?"":authorVal.split("|")[1],lastModifiedTime=searchResult.LastModifiedTime.toString(),lastModifiedTimeMoment=moment(lastModifiedTime),lastModifiedTimeDisplay=lastModifiedTimeMoment.format("MM/DD/YYYY"),fileType=searchResult.SecondaryFileExtension!=null?searchResult.SecondaryFileExtension.toString():"",spWebUrl="",spWebUrl="",siteName="",siteUrl="",spWebUrlParams;typeof searchResult.SPWebUrl!="undefined"?(spWebUrl=searchResult.SPWebUrl,spWebUrlParams=spWebUrl.split("/"),siteName=spWebUrlParams[spWebUrlParams.length-1],siteUrl=spWebUrl):(path=searchResult.ParentLink.replace("/Forms/AllItems.aspx","").replace("/AllItems.aspx","").replace("/Forms/Thumbnails.aspx",""),siteName=path.split("/")[path.split("/").length-2],siteUrl=path.substring(0,path.lastIndexOf("/")));var originalFileVal=searchResult.OriginalPath.toString(),originalFile=originalFileVal.split("/")[originalFileVal.split("/").length-1],fileName=originalFile.toLowerCase().indexOf("dispform.aspx")>-1?title+"."+fileType:originalFile,totalLogsForItem=searchResult.ViewsRecent!=null?searchResult.ViewsRecent:0;return{SiteName:siteName,Url:siteUrl,IconSrc:_cur.getIconUrl(fileType),FileUrl:path+"/"+fileName,FileName:fileName,DateModified:lastModifiedTime,DateModifiedDisplay:lastModifiedTimeDisplay,ModifiedBy:author,IsCurrentUserLastEditor:author==_cur.user.get_title(),IsRecommended:!1,TotalLogs:totalLogsForItem,LogDateOcurred:lastModifiedTime,LogDateOcurredDisplay:lastModifiedTimeDisplay}};this.getIconUrl=function(fileType){var iconUrl="/_layouts/15/images/icgen.gif";switch(fileType){case"pdf":iconUrl="/_layouts/15/images/icpdf.png";break;case"doc":case"docx":case"xls":case"xlsx":case"zip":case"txt":case"js":case"gif":case"jpg":case"jpeg":case"png":iconUrl="/_layouts/15/images/ic"+fileType+".gif"}return this.DocumentSummaryRequest.SiteUrl+iconUrl};this.getDocumentsQuery=function(listTarget){var contentClass=_cur.getContentClass();return _cur.DocumentSummaryRequest.CurrentSite?"webid:"+_cur.DocumentSummaryRequest.WebId+" AND "+contentClass+listTarget:"siteid:"+_cur.DocumentSummaryRequest.SiteId+" AND "+contentClass+listTarget};this.getContentClass=function(){return"(contentclass:STS_ListItem_DocumentLibrary OR FileExtension:doc OR FileExtension:docx OR FileExtension:xls OR FileExtension:xlsx OR FileExtension:ppt OR FileExtension:pptx OR FileExtension:pdf OR FileExtension:png  OR FileExtension:gif OR FileExtension:jpeg OR FileExtension:jpg OR FileExtension:pub OR FileExtension:mpp OR FileExtension:vsx OR FileExtension:vsdx OR FileExtension:xls OR FileExtension:xsl OR FileExtension:xslx OR FileExtension:xlsx OR FileExtension:txt OR FileExtension:zip) ((IsDocument:True OR contentclass:STS_ListItem) AND (-ContentTypeId:0x0120* OR ProgID:OneNote.Notebook))"};this.error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.render=function(templateUri,data){var me=_cur,template=Akumina.AddIn.Cache.Get("template:"+templateUri),hbstemplate;template!=null?(hbstemplate=Handlebars.compile(template),data.Html=hbstemplate(data),me.renderAlways(data)):$.ajax(templateUri).done(function(template){Akumina.AddIn.Cache.Set("template:"+templateUri,template);var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){me.renderAlways(data)})};this.renderAlways=function(data){if(data.hosted)$("body").html(data.Html),AKSenderData.options={numberOfDaysPopular:data.numberOfDaysPopular,currentsite:data.CurrentSite},AKNotifyParent(data.SenderId);else{$("#"+data.SenderId).html(data.Html);var options={html:data.Html},controlOptions={apppart:!1,UniqueId:data.SenderId,options:options,numberOfDaysPopular:data.numberOfDaysPopular,currentsite:data.CurrentSite},iaDocumentsSummaryList=new Akumina.AppParts.DocumentsSummaryList(controlOptions)}}});typeof Akumina.AddIn.MyFormsWidget=="undefined"&&(Akumina.AddIn.MyFormsWidget=function(){var _cur=this;this.Init=function(MyFormsRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.MyFormsRequest=_cur.SetDefaultsProperties(MyFormsRequest);_cur.MyFormsRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.GetDefaultTemplateUrl=function(){return __getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/MyForms/Default.html"};this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",_cur.GetDefaultTemplateUrl()),requestOut.Title=_cur.GetPropertyValue(requestIn,"title",""),requestOut.ListName=_cur.GetPropertyValue(requestIn,"listname","FormSubmissions_AK"),requestOut.Icon=_cur.GetPropertyValue(requestIn,"icon",Akumina.AddIn.Icons.None.toString()),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),requestOut.Version=_cur.GetPropertyValue(requestIn,"version","fullview"),requestOut.PageSize=_cur.GetPropertyValue(requestIn,"pagesize","25"),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","myforms"),requestOut};this.Prerender=function(){var targetDiv=_cur.MyFormsRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="MyForms";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"Hosted","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.MyFormsRequest.SenderId&&(_cur.MyFormsRequest=_cur.SetDefaultsProperties(newProps),_cur.MyFormsRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.Render())};this.Render=function(){_cur.getItems()};this.getParam=function(key,val){var utils=Akumina.AddIn.Utilities,ret=utils.getQueryStringParameter(key,val);return utils.IsNullOrEmpty(ret)&&!utils.IsNullOrEmpty(val)?val:ret};this.getItems=function(){var me=_cur,context=new SP.ClientContext.get_current,web,parentContext;_cur.MyFormsRequest.Hosted?(parentContext=new SP.AppContextSite(context,_cur.hostUrl),web=parentContext.get_web()):web=context.get_web();_cur.MyFormsRequest.Context=context;var listName=_cur.MyFormsRequest.ListName,list=web.get_lists().getByTitle(listName),camlQuery=new SP.CamlQuery,pagesize=_cur.MyFormsRequest.PageSize,query='<View><Query><OrderBy><FieldRef Name="ID" Ascending="FALSE"/><\/OrderBy><Where><And><Eq><FieldRef Name="Author" LookupId="TRUE" /><Value Type="Integer"><UserID /><\/Value><\/Eq><Neq><FieldRef Name="SubmissionID"/><Value Type="Text">0<\/Value><\/Neq><\/And><\/Where><\/Query><RowLimit>'+pagesize+"<\/RowLimit><\/View>";camlQuery.set_viewXml(query);_cur.listItems=list.getItems(camlQuery);context.load(_cur.listItems);Akumina.AddIn.Logger.logSPCall("MyForms.prototype.getItems ("+listName+")");context.executeQueryAsync(Function.createDelegate(me,me.loadMyForms),Function.createDelegate(me,me.error))};this.GetMyFormsAK=function(me,searchId,listItem,totalItems,totalProcessed){var def=$.Deferred(),clientContext=new SP.ClientContext.get_current,site=clientContext.get_site(),rootSite=site.get_rootWeb(),oList=rootSite.get_lists().getByTitle("Forms_AK"),camlQuery=new SP.CamlQuery,query="<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+searchId+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>",oListItem;return camlQuery.set_viewXml(query),oListItem=oList.getItems(camlQuery),clientContext.load(oListItem),Akumina.AddIn.Logger.logSPCall("MyForms.prototype.GetMyFormsAK"),clientContext.executeQueryAsync(Function.createDelegate(me,function(){def.resolve(oListItem,listItem,totalItems,totalProcessed)}),Function.createDelegate(me,function(){def.reject()})),def};this.loadMyForms=function(){var me=_cur,data={},listEnumerator=_cur.listItems.getEnumerator(),utils=Akumina.AddIn.Utilities,item,totalItems,totalProcessed,listItem,formID,errorTemplateUri;for(data.Items=[],data.FormItems=[],item={FormTitle:"All"},data.FormItems.push(item),totalItems=_cur.listItems.get_count(),totalProcessed=0;listEnumerator.moveNext();)totalProcessed++,listItem=listEnumerator.get_current(),formID=listItem.get_item("FormID"),me.GetMyFormsAK(me,formID,listItem,totalItems,totalProcessed).then(function(formaklistItems,listItem,totalItems,totalProcessed){for(var formSubmissionId=listItem.get_id(),id=listItem.get_item("SubmissionID"),siteId=listItem.get_item("SiteId"),formName=listItem.get_item("FormName"),title="",formakEnumerator=formaklistItems.getEnumerator(),formaklistItem,formID,createdDate,search,item,rootsiteUrl;formakEnumerator.moveNext();)formaklistItem=formakEnumerator.get_current(),title=formaklistItem.get_item("Title");formID=listItem.get_item("FormID");createdDate=listItem.get_item("Modified");createdDate=moment(createdDate).format("MM-DD-YYYY");var liID=formID+"_"+id,isFullView=me.MyFormsRequest.Version=="fullview",myFormItem={SiteId:siteId,FormId:formID,Title:title,ReferenceList:formName,Submitted:createdDate,SubmittedID:id,markupLiId:liID,FormSubmissionID:formSubmissionId,FullView:isFullView,PageSize:_cur.MyFormsRequest.PageSize};data.Items.push(myFormItem);search=$.grep(data.FormItems,function(e){return e.FormTitle==title});search.length<1&&(item={FormTitle:title},data.FormItems.push(item));totalProcessed==totalItems&&(isFullView||(rootsiteUrl=window.location.protocol+"//"+window.location.host+_spPageContextInfo.siteServerRelativeUrl,data.LinkViewAll=rootsiteUrl+"/pages/myforms.aspx"),data.SenderId=me.MyFormsRequest.SenderId,data.hosted=me.MyFormsRequest.Hosted,data.FullView=isFullView,data.WebPartIcon=utils.GetIcon(me.MyFormsRequest.Icon),me.MyFormsRequest.EditMode||_cur.render(me.MyFormsRequest.DisplayTemplateUrl,data))});totalItems==0&&(errorTemplateUri=_spPageContextInfo.siteAbsoluteUrl+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/MyForms/NoForms.html",(new Akumina.Digispace.AppPart.Data).Templates.FindAndRender(errorTemplateUri,"#"+me.MyFormsRequest.SenderId,data,null,null))};this.error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.render=function(templateUri,data){Akumina.AddIn.Logger.WriteInfoLog(templateUri,data);$.ajax(templateUri).done(function(template){var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){var options,newSenderId,controlOptions,iaMyForms;data.hosted?($("body").html(data.Html),AKSenderData.options={dataJSON:data},AKNotifyParent(data.SenderId)):(options={dataJSON:data},newSenderId=data.SenderId,$("#"+newSenderId).html(data.Html),controlOptions={apppart:!1,UniqueId:newSenderId,options:options},iaMyForms=new Akumina.AppParts.MyForms(controlOptions))})}});typeof Akumina.AddIn.TrafficWidget=="undefined"&&(Akumina.AddIn.TrafficWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue,useDefaultFirstOption){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return defaultValue!=null&&defaultValue.toString().trim()!=""&&useDefaultFirstOption==!0?defaultValue:propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.GetDefaultTemplateUrl=function(){return __getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/Traffic/Default.html"};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",_cur.GetDefaultTemplateUrl()),requestOut.City=_cur.GetPropertyValue(requestIn,"city",Akumina.Digispace.UserContext.City),requestOut.State=_cur.GetPropertyValue(requestIn,"state",Akumina.Digispace.UserContext.State),requestOut.PostalCode=_cur.GetPropertyValue(requestIn,"postalcode",Akumina.Digispace.UserContext.PostalCode,!0),requestOut.callbackMethod=_cur.GetPropertyValue(requestIn,"callbackmethod",""),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","traffic"),requestOut};this.Init=function(trafficRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.trafficRequest=_cur.SetDefaultsProperties(trafficRequest);_cur.trafficRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=_cur.trafficRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.getItem);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="Traffic";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.trafficRequest.SenderId&&(_cur.trafficRequest=_cur.SetDefaultsProperties(newProps),_cur.trafficRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.getItem())};this.getItem=function(){var me=_cur,context=new SP.ClientContext.get_current,web,parentContext,model;if(_cur.trafficRequest.Hosted?(parentContext=new SP.AppContextSite(context,_cur.hostUrl),web=parentContext.get_web()):web=context.get_web(),model=Akumina.AddIn.Cache.Get(_cur.getCacheKey("model")),model!=null){_cur.render(_cur.trafficRequest.DisplayTemplateUrl,model);return}model={};model.hosted=_cur.trafficRequest.Hosted;model.SenderId=_cur.trafficRequest.SenderId;model.GoogleMapKey=Akumina.Digispace.ConfigurationContext.GoogleMapKey;model.Location=_cur.trafficRequest.PostalCode;model.GoogleMapKey==""&&(model.ApiKeyMissing=!0);_cur.trafficRequest.EditMode||(Akumina.AddIn.Cache.Set(_cur.getCacheKey("model"),model,Akumina.AddIn.Constants.LONG_CACHE_EXPIRATION),_cur.render(_cur.trafficRequest.DisplayTemplateUrl,model))};this.getCacheKey=function(attribute){var prefix="akumina:traffic:"+_spPageContextInfo.siteAbsoluteUrl+":";return attribute!=null&&(prefix+=attribute),prefix};this.render=function(templateUri,data){$.ajax(templateUri).done(function(template){var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){if(data.hosted)$("body").html(data.Html),AKNotifyParent(data.SenderId);else{$("#"+data.SenderId).html(data.Html);var options={html:data.Html,googlemapkey:data.GoogleMapKey,location:data.Location},controlOptions={apppart:!1,UniqueId:data.SenderId,options:options},iaTraffic=new Akumina.AppParts.Traffic(controlOptions)}})}});typeof Akumina.AddIn.CompanyCalendarWidget=="undefined"&&(Akumina.AddIn.CompanyCalendarWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.ClientId=_cur.GetPropertyValue(requestIn,"clientid",""),requestOut.SubscriptionId=_cur.GetPropertyValue(requestIn,"subscriptionid",""),requestOut.GroupName=_cur.GetPropertyValue(requestIn,"groupname",""),requestOut.Color=_cur.GetPropertyValue(requestIn,"color",""),requestOut.Title=_cur.GetPropertyValue(requestIn,"title","Company Calendar"),requestOut.CalendarTitle=_cur.GetPropertyValue(requestIn,"calendartitle","Company Calendar"),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.DisplayTemplateUrl==""&&(requestOut.DisplayTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/CompanyCalendar/Default.html"),requestOut.IsPreview=_cur.GetPropertyValue(requestIn,"preview",!1),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.Icon=_cur.GetPropertyValue(requestIn,"icon",Akumina.AddIn.Icons.None.toString()),requestOut.StartDate=_cur.GetPropertyValue(requestIn,"startdate",getCompanyCalendarStartDate()),requestOut.Category=_cur.GetPropertyValue(requestIn,"category",""),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","companycalendar"),requestOut};this.Init=function(CompanyCalendarRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.CompanyCalendarRequest=_cur.SetDefaultsProperties(CompanyCalendarRequest);_cur.CompanyCalendarRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=this.CompanyCalendarRequest.SenderId;Akumina.Digispace.ConfigurationContext.EnableAzureAD?($("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml),Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render),Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)):$("#"+targetDiv).html("Azure Active Directory in not enabled for this site.")};this.RegisterPropertyViews=function(){var widgetName="CompanyCalendar";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"IsPreview","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"Hosted","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.CompanyCalendarRequest.SenderId&&(_cur.CompanyCalendarRequest=_cur.SetDefaultsProperties(newProps),_cur.CompanyCalendarRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.Render())};this.Render=function(){_cur.GetItems()};this.GetItems=function(){Akumina.AddIn.Logger.WriteInfoLog("CompanyCalendar getItems");var instruction=new Akumina.AddIn.Instructions;Akumina.AddIn.Logger.logSPCall("CompanyCalendar GetItems");instruction.executeAsync(_cur,_cur.CompanyCalendarRequest.InstructionSet,"CompanyCalendarRequest").then(function(result){Akumina.AddIn.Logger.WriteInfoLog("CompanyCalendar getItems instruction executeAsync then");_cur.appWebUrl=result.appWebUrl;_cur.hostUrl=result.hostUrl;result.CompanyCalendarRequest.SubscriptionId=Akumina.Digispace.ConfigurationContext.GraphSubscriptionId?Akumina.Digispace.ConfigurationContext.GraphSubscriptionId:"";result.CompanyCalendarRequest.ClientId=Akumina.Digispace.ConfigurationContext.GraphClientId?Akumina.Digispace.ConfigurationContext.GraphClientId:"";_cur.CompanyCalendarRequest=result.CompanyCalendarRequest;_cur.GetCalendar()})};this.GetCalendar=function(){Akumina.AddIn.Logger.WriteInfoLog("CompanyCalendar getCalendar");var browserDate=new Date,browserOffSetMinutes=browserDate.getTimezoneOffset(),result={},items=[],clientId=_cur.CompanyCalendarRequest.ClientId,subscriptionId=_cur.CompanyCalendarRequest.SubscriptionId,groupName=_cur.CompanyCalendarRequest.GroupName,url="/v1.0/groups?$filter=startswith(displayName,'"+groupName+"')";_cur.GetGraphData(clientId,clientId,url).then(function(graphData){var groupId=graphData[0].id,endDate=moment(_cur.CompanyCalendarRequest.StartDate).format("YYYY-MM-DD"),startDate=moment(_cur.CompanyCalendarRequest.StartDate).subtract(1,"month").format("YYYY-MM-DD"),url="/v1.0/groups/"+groupId+"/calendarView?startDateTime="+startDate+"&endDateTime="+endDate+"&$top=400";_cur.GetGraphData(clientId,clientId,url).then(function(graphData){var isoStartDate,isoEndDate,parsedStart,startTime,parsedEnd,endTime;for(i=0;i<graphData.length;i++){var listItem=graphData[i],data={},itemId=0,title="",body="",url="",startDate="",endDate="",category="",location="",allDayEvent=!1,isRecurring=!1,recurrenceData="";itemId=listItem.id;title=listItem.subject;body=listItem.body.content;url="";startDate=listItem.start.dateTime;endDate=listItem.end.dateTime;category="";location=listItem.location.displayName;allDayEvent=listItem.isAllDay;isRecurring="";recurrenceData="";data.Id=itemId;data.Title=title;data.Url="";data.Body=body;data.Location=location;data.Category=category;data.Date="";data.Time="";data.AllDay=allDayEvent;data.Location=listItem.location.displayName;data.Organizer=listItem.organizer.emailAddress.name;isoStartDate=new Date(moment(startDate).format("YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"));data.StartDate=moment(isoStartDate);isoEndDate=allDayEvent?new Date(moment(startDate).format("YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")):new Date(moment(endDate).format("YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"));data.EndDate=moment(isoEndDate);data.Color=_cur.CompanyCalendarRequest.Color.toLowerCase();data.Attachments=listItem.webLink;data.HasAttachments=listItem.hasAttachments;data.RecurrenceData="";data=_cur.SetDateValues(data,data.StartDate,data.EndDate);parsedStart=moment(data.StartDateUTC);startTime=parsedStart.hours()<10?"0"+parsedStart.hours().toString():parsedStart.hours();startTime+=":";startTime+=parsedStart.minutes()<10?"0"+parsedStart.minutes().toString():parsedStart.minutes();parsedEnd=moment(data.EndDateUTC);endTime=parsedEnd.hours()<10?"0"+parsedEnd.hours().toString():parsedEnd.hours();endTime+=":";endTime+=parsedEnd.minutes()<10?"0"+parsedEnd.minutes().toString():parsedEnd.minutes();data.start=parsedStart.format("YYYY-MM-DD");data.AllDay?data.start=parsedStart.utc().format("YYYY-MM-DD"):data.AllDay||(data.start+="T"+startTime);data.AllDay?(data.end=parsedStart.utc().format("YYYY-MM-DD"),data.end+="T23:59"):data.AllDay||(data.end=parsedEnd.format("YYYY-MM-DD"),data.end+="T"+endTime);data.end=moment(data.end).format("ddd, MM/DD/YYYY, h:mm:ss a");data.start=moment(data.start).format("ddd, MM/DD/YYYY, h:mm:ss a");data.JsonEvent=JSON.stringify(data);items.push(data)}result.TokenURL=_cur.TokenURL;result.GroupId=_cur.GroupId;result.Events=items;result.Month=_cur.CompanyCalendarRequest.StartDate.getMonth()>0?_cur.CompanyCalendarRequest.StartDate.getMonth():12;result.MonthFullName=_cur.GetMonthName(result.Month-1);result.MonthName=result.MonthFullName.substring(0,3);result.Year=_cur.CompanyCalendarRequest.StartDate.getFullYear();result.Month==12&&--result.Year;result.HasCategories=!1;result.Categories="";result.Category="";result.SelectedCategory=result.Category;result.Title=_cur.CompanyCalendarRequest.CalendarTitle;result.WebPartTitle=_cur.CompanyCalendarRequest.CalendarTitle;result.WebPartIcon=Akumina.AddIn.Utilities.GetIcon(_cur.CompanyCalendarRequest.Icon);result.DisplayWebPartIcon=result.WebPartIcon=="0"||result.WebPartIcon.toLowerCase().trim()=="none"?!1:!0;result.ShowHeader=result.Title!==""||result.WebPartIcon!=="none";result.SenderId=_cur.CompanyCalendarRequest.SenderId;result.hosted=_cur.CompanyCalendarRequest.Hosted;result.StartDate=_cur.CompanyCalendarRequest.StartDate;_cur.CompanyCalendarRequest.EditMode||(Akumina.AddIn.Cache.Set(_cur.GetCacheKey(),result,_cur.GetCacheInterval()),_cur.render(_cur.CompanyCalendarRequest.DisplayTemplateUrl,result))})},function(){_cur.OnGroupNameError()})};this.GetGraphData=function(clientId,subscriptionId,query){var def=new $.Deferred,authContext,isCallback,user;return config={subscriptionId:subscriptionId,clientId:clientId,postLogoutRedirectUri:window.location.origin,endpoints:{graphApiUri:"https://graph.microsoft.com"},cacheLocation:"localStorage"},authContext=new AuthenticationContext(config),isCallback=authContext.isCallback(window.location.hash),authContext.handleWindowCallback(),isCallback&&!authContext.getLoginError()&&(window.location=authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST)),user=authContext.getCachedUser(),user||authContext.login(),authContext.acquireToken(config.endpoints.graphApiUri,function(error,token){if(error||!token){Akumina.AddIn.Logger.WriteErrorLog("ADAL error occurred: "+error);return}var filesUri=config.endpoints.graphApiUri+query;$.ajax({type:"GET",url:filesUri,headers:{Authorization:"Bearer "+token}}).done(function(response){Akumina.AddIn.Logger.WriteInfoLog("Successfully fetched users from Graph.");Akumina.AddIn.Logger.WriteInfoLog(response);def.resolve(response.value)}).fail(function(){Akumina.AddIn.Logger.WriteErrorLog("Fetching users failed.");def.reject()})}),def};this.OnGroupNameError=function(){var groupName=_cur.CompanyCalendarRequest.GroupName,html="<h1>Failed to load the Company Calendar for GroupName '"+groupName+"'<\/h1>";$("#"+_cur.CompanyCalendarRequest.SenderId).html(html)};this.GetCacheInterval=function(){return _cur.CompanyCalendarRequest.CacheInterval&&_cur.CompanyCalendarRequest.CacheInterval!=null&&!isNaN(_cur.CompanyCalendarRequest.CacheInterval)?parseInt(_cur.CompanyCalendarRequest.CacheInterval):Akumina.Digispace.ConfigurationContext.CachingStrategyInterval};this.GetCacheKey=function(){return Akumina.Digispace.ConfigurationContext.getCacheKey(_cur.CompanyCalendarRequest.SenderId)};this.SetDateValues=function(data,startDate,endDate){var dtStartDate=startDate.isValid()?startDate.clone():moment(startDate),dtEndDate;return data.AllDay&&(dtStartDate=dtStartDate.utc()),data.StartDate=dtStartDate,data.StartDateYear=dtStartDate.year(),data.StartDateMonth=dtStartDate.month(),data.Date=dtStartDate.format("dddd, MMMM DD, YYYY"),data.DisplayStartDate=dtStartDate.format("dddd, MMMM DD, YYYY"),data.AllDay?(data.Time="",data.DisplayStartTime=""):(data.Time=dtStartDate.format("h:mm A"),data.DisplayStartTime=dtStartDate.format("h:mm A")),data.StartDateUTC=dtStartDate.utc().format("YYYY-MM-DDTHH:mm:ss+00:00"),dtEndDate=moment(endDate),data.AllDay&&(dtEndDate=dtEndDate.utc()),data.EndDate=dtEndDate,data.EndDateYear=dtEndDate.year(),data.EndDateMonth=dtEndDate.month(),dtEndDate.year()>=dtStartDate.year()&&dtEndDate.month()>=dtStartDate.month()&&dtEndDate.date()>dtStartDate.date()&&(data.Date=data.Date+=" - "+dtEndDate.format("dddd, MMMM DD, YYYY")),data.AllDay?(data.Time="",data.DisplayEndTime=""):(data.Time=data.Time+=" - "+dtEndDate.format("h:mm A"),data.DisplayEndTime=dtEndDate.format("h:mm A")),data.DisplayEndDate=dtEndDate.format("dddd, MMMM DD, YYYY"),data.DisplayEndDate==data.DisplayStartDate&&(data.DisplayEndDate=""),data.EndDateUTC=dtEndDate.utc().format("YYYY-MM-DDTHH:mm:ss+00:00"),data.DisplayDateRange=data.Date,data.DisplayTimeRange=data.Time,data};this.GetMonthName=function(monthIndex){var monthNames=[];return monthNames[0]="January",monthNames[1]="February",monthNames[2]="March",monthNames[3]="April",monthNames[4]="May",monthNames[5]="June",monthNames[6]="July",monthNames[7]="August",monthNames[8]="September",monthNames[9]="October",monthNames[10]="November",monthNames[11]="December",monthNames[monthIndex]};this.OnError=function(errorMessage){$("#"+_cur.CompanyCalendarRequest.SenderId).html(errorMessage)};this.render=function(templateUri,data){Akumina.AddIn.Logger.WriteInfoLog(templateUri,data);(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){data.Html=html;_cur.BindData(data)},function(errormsg){var data={sender:_cur.CompanyCalendarRequest.SenderId,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.CompanyCalendarRequest.SenderId).html(html)})})};this.BindData=function(data){if(data.hosted)$("body").html(data.Html),AKSenderData.options={dataJSON:data},AKNotifyParent(data.SenderId);else{$("#"+data.SenderId).html(data.Html);var options={dataJSON:data},controlOptions={apppart:!1,UniqueId:data.SenderId,options:options},iaCompanyCalendar=new Akumina.AppParts.CompanyCalendar(controlOptions)}}});typeof Akumina.AddIn.PeopleDirectoryWidget=="undefined"&&(Akumina.AddIn.PeopleDirectoryWidget=function(){var _cur=this;this.viewModel={};this.PagingManager={pageNumber:1,pageSize:9,scrollReady:!0,searchResults:[],isLastPage:!0,Reset:function(element){this.pageNumber=1;element.scrollTop(0);this.scrollReady=!0},NextPage:function(){return this.isLastPage?!1:(this.pageNumber=this.pageNumber+1,!0)}};this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.Title=_cur.GetPropertyValue(requestIn,"title",""),requestOut.SearchType=_cur.GetPropertyValue(requestIn,"searchtype","First"),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.DisplayTemplateUrl==""&&(requestOut.DisplayTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/PeopleDirectory/Default.html"),requestOut.SearchListingDisplay=_cur.GetPropertyValue(requestIn,"searchlistingdisplay","FL"),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.SubscriptionId=_cur.GetPropertyValue(requestIn,"subscriptionid",""),requestOut.EnableAZSelector=_cur.GetPropertyValue(requestIn,"enableazselector","True"),requestOut.FacetName=_cur.GetPropertyValue(requestIn,"facetname",""),requestOut.FacetValue=_cur.GetPropertyValue(requestIn,"facetvalue",""),requestOut.ClientId=_cur.GetPropertyValue(requestIn,"appid",""),requestOut.DisplayView=_cur.GetPropertyValue(requestIn,"displayview","tile"),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),requestOut.Facets=_cur.GetPropertyValue(requestIn,"facets","{ }"),requestOut.FetchPhotoFromAD=_cur.GetPropertyValue(requestIn,"fetchphotofromad",!0),requestOut};this.Init=function(PeopleDirectoryRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.PeopleDirectoryRequest=_cur.SetDefaultsProperties(PeopleDirectoryRequest);_cur.PeopleDirectoryRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.RegisterPropertyViews=function(){var widgetName="PeopleDirectory";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"FetchPhotoFromAD","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"EnableAZSelector","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"Hosted","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.Prerender=function(){var targetDiv=this.PeopleDirectoryRequest.SenderId;Akumina.Digispace.ConfigurationContext.EnableAzureAD?($("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml),Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render),Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Subscribe("/peopledirectory/search/",_cur.Search),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Subscribe("/peopledirectory/searchcompleted/",_cur.OnSearchCompleted),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Subscribe("/peopledirectory/error/",_cur.OnError),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Subscribe("/peopledirectory/success/",_cur.OnSuccess),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Subscribe("/peopledirectory/viewchanged/",_cur.OnViewChanged),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Subscribe("/peopledirectory/azselectorclicked/",_cur.OnAZSelectorChanged),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Subscribe("/peopledirectory/profileclicked/",_cur.OnProfileClicked),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Subscribe("/peopledirectory/refinementchanged/",_cur.OnRefinementChanged)):$("#"+targetDiv).html("Azure Active Directory in not enabled for this site.")};this.RefreshWidget=function(newProps){newProps.id==_cur.PeopleDirectoryRequest.SenderId&&(_cur.PeopleDirectoryRequest=_cur.SetDefaultsProperties(newProps),_cur.PeopleDirectoryRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.Render())};this.Render=function(){_cur.InitPeopleDirectory()};this.InitPeopleDirectory=function(){if(Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.InitPeopleDirectory"),!_cur.PeopleDirectoryRequest.EditMode){var instruction=new Akumina.AddIn.Instructions;instruction.executeAsync(_cur,_cur.PeopleDirectoryRequest.InstructionSet,"PeopleDirectoryRequest").then(function(result){var utils,sortField;result.PeopleDirectoryRequest.SubscriptionId=Akumina.Digispace.ConfigurationContext.GraphSubscriptionId?Akumina.Digispace.ConfigurationContext.GraphSubscriptionId:"";result.PeopleDirectoryRequest.ClientId=Akumina.Digispace.ConfigurationContext.GraphClientId?Akumina.Digispace.ConfigurationContext.GraphClientId:"";_cur.PeopleDirectoryRequest=result.PeopleDirectoryRequest;_cur.ShowLoading();_cur.viewModel.urlSearchText=_cur.GetSearchTextFromUrl();_cur.InitializeState();utils=Akumina.AddIn.Utilities;_cur.PeopleDirectoryRequest.Hosted&&utils.IsNullOrEmpty(_cur.PeopleDirectoryRequest.DisplayTemplateUrl)&&(_cur.PeopleDirectoryRequest.DisplayTemplateUrl="/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/PeopleDirectory/Default.html");_cur.PeopleDirectoryRequest.DisplayTemplateUrl=_cur.appWebUrl+_cur.PeopleDirectoryRequest.DisplayTemplateUrl;_cur.SetFacetsFilter();sortField=_cur.GetSortField(_cur.PeopleDirectoryRequest.SearchType.toLowerCase().trim());_cur.userName=_spPageContextInfo.userLoginName;_cur.GetGraphUsersData(_cur.userName,_cur.filter,_cur.PagingManager.pageSize,_cur.PagingManager.pageNumber,sortField).then(function(graphUsers){_cur.allUsers=graphUsers;_cur.GetFacets(_cur.filter).then(function(facets){_cur.viewModel.facets=facets;var resultsModel={searchResults:_cur.allUsers,caller:null};Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/searchcompleted/",resultsModel)},function(error){Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/error/",error)})},function(error){Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/error/",error)})},function(){Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/error/","Error in getting Instruction set data.")})}};this.GetSearchTextFromUrl=function(){var url=location.href,urltokens,params,i;if(Akumina.AddIn.Logger.WriteInfoLog("GetSearchTextFromUrl - "+url),urltokens=url.split("?"),urltokens.length>1)for(Akumina.AddIn.Logger.WriteInfoLog("GetSearchTextFromUrl - "+urltokens[1]),params=urltokens[1].split("="),i=0;i<params.length;i+=2)if(params[i].toLowerCase()=="searchtext")return params[i+1];return""};this.InitializeState=function(){_cur.viewModel.selectedLetter="";_cur.viewModel.firstNameSearchText="";_cur.viewModel.lastNameSearchText="";_cur.viewModel.searchText="";_cur.viewModel.currentView=_cur.PeopleDirectoryRequest.DisplayView;_cur.viewModel.isScrollReady=!0;_cur.peopleModel={People:[]};_cur.allUsers=[];_cur.filter={filters:[]}};this.GetGraphUsersDataModel=function(currentUserName,filters,pageSize,pageNumber,orderByField){var def=new $.Deferred;return _cur.GetGraphUsersData(currentUserName,filters,pageSize,pageNumber,orderByField).then(function(result){var model=_cur.GetResultAsModel(result,0);def.resolve(model.People)},function(){def.reject("Error fetching users.")}),def};this.GetGraphUsersData=function(currentUserName,filters,pageSize,pageNumber,orderByField){var def=new $.Deferred,searchContext={filters:filters,pageSize:pageSize,pageNumber:pageNumber,orderBy:orderByField};return _cur.GetAllUsers(searchContext,currentUserName,def),def};this.GetAllUsers=function(searchContext,currentUserName,def){var interchangeUrl=Akumina.Digispace.ConfigurationContext.InterchangeURL,interchangeQueryKey=Akumina.Digispace.ConfigurationContext.InterchangeQueryKey;$.ajax({type:"POST",url:interchangeUrl+"/api/connector/users?pageSize="+searchContext.pageSize+"&pageNumber="+searchContext.pageNumber+"&orderBy="+searchContext.orderBy+"&interchangeQueryKey="+interchangeQueryKey,data:searchContext.filters,dataType:"json",xhrFields:{withCredentials:!0}}).done(function(response){_cur.PagingManager.isLastPage=response.IsLastPage;_cur.PagingManager.pageNumber=response.CurrentPage;def.resolve(response.Users)}).fail(function(){def.reject("Error fetching users.")})};this.GetResultAsModel=function(results,peopleModelIndex){var picURL,peopleModel,itemResults;for(Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.getResultAsModel"),picURL="",peopleModel={People:[]},i=0;i<results.length;i++)picURL=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/images/anonymous-user.png",itemResults=results[i],itemResults.Properties.Id=i+peopleModelIndex,itemResults.Properties.pictureurl=picURL,peopleModel.People.push(itemResults.Properties);return peopleModel};this.BindEvents=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.bindEvents");$(".ia-people-results-byList").unbind().click(function(){_cur.viewModel.currentView="list";Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/viewchanged/")});$(".ia-people-results-byGrid").unbind().click(function(){_cur.viewModel.currentView="tile";Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/viewchanged/")});$(".ia-people-az-list li").unbind().click(function(){_cur.ShowLoading();$(this).siblings().removeClass("ak-selected");$(this).addClass("ak-selected");var selectedLetter=$(this).find("a").text();_cur.viewModel.selectedLetter=selectedLetter=="All"?"":selectedLetter;Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/azselectorclicked/")});$(".ia-modal-inline-trigger").unbind().click(function(){var itemId=$(this).data("id"),profileDetails={itemId:itemId};Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/profileclicked/",profileDetails)});$(".ia-people-filter-wrapper input[type='checkbox']").unbind().click(function(){Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/refinementchanged/")});$(".ia-firstNameSearchBox, .ia-lastNameSearchBox").unbind();$(".ia-firstNameSearchBox").donetyping(function(){var val=$(this).val();$(".ia-libList-searchBar-input").length>0&&$(".ia-libList-searchBar-input").val(val);val.length<3&&(val="");val!=""&&(_cur.ShowLoading(),_cur.viewModel.firstNameSearchText=$(".ia-firstNameSearchBox").val(),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/search/","search"))});$(".ia-lastNameSearchBox").donetyping(function(){var val=$(this).val();$(".ia-libList-searchBar-input").length>0&&$(".ia-libList-searchBar-input").val(val);val.length<3&&(val="");val!=""&&(_cur.ShowLoading(),_cur.viewModel.lastNameSearchText=$(".ia-lastNameSearchBox").val(),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/search/","search"))});var firstNameOldValue="",lastNameOldValue="";$(".ia-firstNameSearchBox").on("keyup",function(event){var val=$(this).val(),makeSearchCall;$(".ia-libList-searchBar-input").length>0&&$(".ia-libList-searchBar-input").val(val);val.length>2&&(firstNameOldValue=val);(val.length<=2&&event.keyCode==8||event.keyCode==46)&&(firstNameOldValue="",makeSearchCall=!1,firstNameOldValue!=_cur.viewModel.firstNameSearchText&&(makeSearchCall=!0),_cur.viewModel.firstNameSearchText=$(".ia-firstNameSearchBox").val(),makeSearchCall&&(_cur.ShowLoading(),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/search/","search")))});$(".ia-lastNameSearchBox").on("keyup",function(event){var val=$(this).val(),makeSearchCall;$(".ia-libList-searchBar-input").length>0&&$(".ia-libList-searchBar-input").val(val);val.length>2&&(lastNameOldValue=val);(val.length<=2&&event.keyCode==8||event.keyCode==46)&&(lastNameOldValue="",makeSearchCall=!1,lastNameOldValue!=_cur.viewModel.lastNameSearchText&&(makeSearchCall=!0),_cur.viewModel.lastNameSearchText=$(".ia-lastNameSearchBox").val(),makeSearchCall&&(_cur.ShowLoading(),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/search/","search")))});$(".ia-firstNameSearchBox").on("cut paste",function(){setTimeout(function(){_cur.ShowLoading();_cur.viewModel.firstNameSearchText=$(".ia-firstNameSearchBox").val();Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/search/","search")},100)});$(".ia-lastNameSearchBox").on("cut paste",function(){setTimeout(function(){_cur.ShowLoading();_cur.viewModel.lastNameSearchText=$(".ia-lastNameSearchBox").val();Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/search/","search")},100)});this.verticalScrollPosition=$("#s4-workspace").scrollTop();$("#s4-workspace").unbind().scroll(function(){_cur.viewModel.isScrollReady&&$(this).scrollTop()>_cur.verticalScrollPosition&&$(this).scrollTop()+$(this).innerHeight()+10>=$(this)[0].scrollHeight&&(_cur.viewModel.isScrollReady=!1,_cur.viewModel.scrollPosition=$("#s4-workspace").scrollTop(),_cur.ShowNextPage())});$(".showMoreResults a").unbind().click(function(){_cur.viewModel.scrollPosition=$("#s4-workspace").scrollTop();_cur.ShowNextPage()});$(".ia-firstNameSearchBox, .ia-lastNameSearchBox").keypress(function(event){event.keyCode==13&&event.preventDefault()});Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/viewchanged/")};this.ShowDetailedProfile=function(itemInformation){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.showDetailedProfile");itemInformation.pictureurl=_cur.viewModel.currentView.toLowerCase().trim()=="tile"?$(".ia-people-results-grid .ia-profile-avatar [data-id='"+itemInformation.Id+"'] img").attr("src"):$(".ia-people-results-list a[data-id='"+itemInformation.Id+"'] img").attr("src");itemInformation.DisplayFL=_cur.PeopleDirectoryRequest.SearchListingDisplay.toLowerCase().trim()=="lf"?!1:!0;$("#user-popup").html($("#template-userpopup").html().replace(/{ {/g,"{{").replace(/} }/g,"}}"));_cur.FindAndRenderHandleBar("#user-popup",null,"#user-popup",itemInformation);$.magnificPopup.open({items:{src:".user-popup",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0})};this.Search=function(caller){var results,sortField;Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.search");results=[];switch(caller){case"search":case"facets":case"azselector":_cur.peopleModel.People=[];_cur.PagingManager.Reset($("#s4-workspace"));_cur.filter.filters=[];_cur.SetAZSelectorFilter();_cur.SetSearchTextFilter();_cur.SetFacetsFilter()}sortField=_cur.GetSortField(_cur.PeopleDirectoryRequest.SearchType.toLowerCase().trim());_cur.GetGraphUsersData(_spPageContextInfo.userLoginName,_cur.filter,_cur.PagingManager.pageSize,_cur.PagingManager.pageNumber,sortField).then(function(graphUsers){var resultsModel={searchResults:graphUsers,caller:caller};Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/searchcompleted/",resultsModel)})};this.SetAZSelectorFilter=function(){var searchText,searchField,filter;Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.getResultsForAZSelector");searchText=_cur.viewModel.selectedLetter;searchField=_cur.PeopleDirectoryRequest.SearchType.toLowerCase().trim()=="last"?"surname":"givenName";searchText.trim()!=""&&(filter={property:searchField,values:[searchText],operator:"starts-with"},_cur.filter.filters.push(filter))};this.SetSearchTextFilter=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.getResultsForSearch");var searchField="",operator="starts-with";_cur.viewModel.isURLSearch?(_cur.filter.filters.push(_cur.CreateFilter("displayName",[_cur.viewModel.searchText],operator)),_cur.viewModel.isURLSearch=!1):searchField=_cur.PeopleDirectoryRequest.SearchType.toLowerCase().trim()=="last"?"surname":"givenName";_cur.viewModel.firstNameSearchText!=""&&_cur.viewModel.firstNameSearchText.trim().length>=3&&_cur.filter.filters.push(_cur.CreateFilter("givenName",[_cur.viewModel.firstNameSearchText],operator));_cur.viewModel.lastNameSearchText!=""&&_cur.viewModel.lastNameSearchText.trim().length>=3&&_cur.filter.filters.push(_cur.CreateFilter("surname",[_cur.viewModel.lastNameSearchText],operator))};this.CreateFilter=function(searchField,searchValues,operator){return{property:searchField,values:searchValues,operator:operator}};this.IsFacetAsProperty=function(){var facetParams,i,param;Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.isFacetAsProperty");var facetName="",facetValue="",url=window.location.href,queryString=url.split("?");if(queryString.length>1)for(facetParams=queryString[1].split("&"),i=0;i<facetParams.length;i++)param=facetParams[i].split("="),param.length>1&&(param[0].toLowerCase().trim()=="facetname"&&(facetName=param[1]),param[0].toLowerCase().trim()=="facetvalue"&&(facetValue=param[1]));if(facetName==""||facetValue==""){if(_cur.PeopleDirectoryRequest.FacetName==""||_cur.PeopleDirectoryRequest.FacetValue=="")return!1}else _cur.PeopleDirectoryRequest.FacetName=facetName,_cur.PeopleDirectoryRequest.FacetValue=facetValue;return!0};this.SetFacetsFilter=function(){var selectedFacets,key,filter;Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.getResultsForFacets");selectedFacets={};_cur.IsFacetAsProperty()?selectedFacets[_cur.PeopleDirectoryRequest.FacetName.toLowerCase().trim()]=_cur.PeopleDirectoryRequest.FacetValue:selectedFacets=_cur.GetSelectedFacets();for(key in selectedFacets)filter={property:key,values:selectedFacets[key].split(","),operator:"equals"},_cur.filter.filters.push(filter)};this.GetSelectedFacets=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.getSelectedFacets");var facetSet={};return $(".ia-people-filter").each(function(){var $subFacets=$(this),facetName=$subFacets.find(".ia-people-filter-header").data("filtername");facetOptions=[];$subFacets.find(".ia-people-filter-options input:checked").each(function(){facetOptions.push($(this).val().toLowerCase().trim())});facetOptions.length>0&&(facetSet[facetName.toLowerCase()]=facetOptions.join(","))}),facetSet};this.GetFacets=function(){var i;Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.getFacets");var facets={RefinementFilters:[]},def=new $.Deferred,interchangeUrl=Akumina.Digispace.ConfigurationContext.InterchangeURL,interchangeQueryKey=Akumina.Digispace.ConfigurationContext.InterchangeQueryKey,facetObj=_cur.PeopleDirectoryRequest.Facets?JSON.parse(_cur.PeopleDirectoryRequest.Facets):[],facetProperties={},facetNames=[];for(i=0;i<facetObj.length;i++)facetProperties[facetObj[i].facetName.toLowerCase()]=facetObj[i].facetDisplayName,facetNames.push(facetObj[i].facetName.toLowerCase());return $.ajax({type:"GET",url:interchangeUrl+"/api/connector/facets?facetNames="+facetNames.join(",")+"&interchangeQueryKey="+interchangeQueryKey,xhrFields:{withCredentials:!0}}).done(function(response){var key,filterObject,i;for(key in response){for(filterObject={FilterName:key,FilterHeader:facetProperties[key.toLowerCase()],FilterOptions:[]},i=0;i<response[key].length;i++)filterObject.FilterOptions.push({id:response[key][i].split(" ").join("-"),value:response[key][i]});facets.RefinementFilters.push(filterObject)}def.resolve(facets)}).error(function(xhr,ajaxOptions,thrownError){Akumina.AddIn.Logger.WriteErrorLog(xhr.status);Akumina.AddIn.Logger.WriteErrorLog(thrownError);Akumina.AddIn.Logger.WriteErrorLog("Error communicating with "+interchangeUrl);def.reject("Error fetching facets")}),def};this.OnSearchCompleted=function(searchContext){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.onSearchCompleted");_cur.PagingManager.isLastPage&&$(".showMoreResults").hide();var currentPagePeopleModel=_cur.GetResultAsModel(searchContext.searchResults,_cur.peopleModel.People.length);_cur.AddPageResults(currentPagePeopleModel.People);_cur.peopleModel.SearchType=_cur.PeopleDirectoryRequest.SearchType;_cur.peopleModel.SelectedLetter=_cur.viewModel.selectedLetter;_cur.render(_cur.PeopleDirectoryRequest.DisplayTemplateUrl,_cur.peopleModel,searchContext.caller,currentPagePeopleModel)};this.GetProfilePicForView=function(peopleSearchAllUsers){var loggedInUserName=_cur.userName;_cur.viewModel.currentView.toLowerCase().trim()=="tile"?$(".ia-people-results-grid li img").each(function(){var me=this,profileUserName=$(me).attr("data-user");peopleSearchAllUsers.getProfilePicture(profileUserName,me,loggedInUserName)}):$(".ia-people-results-list a img").each(function(){var me=this,profileUserName=$(me).attr("data-user");peopleSearchAllUsers.getProfilePicture(profileUserName,me,loggedInUserName)})};this.GetProfilePictures=function(currentPagePeople,peopleSearchAllUsers){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.getProfilePictures");_cur.GetProfilePicForView(peopleSearchAllUsers)};this.AddPageResults=function(pagedSearchResults){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.AddPageResults");_cur.peopleModel.People.push.apply(_cur.peopleModel.People,pagedSearchResults)};this.OnViewChanged=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.onViewChanged");_cur.viewModel.currentView.toLowerCase().trim()=="list"?($(".ia-people-results-grid").removeClass("ia-active"),$(".ia-people-results-list").addClass("ia-active"),$(".ia-people-results-byList").addClass("ia-active"),$(".ia-people-results-byGrid").removeClass("ia-active")):($(".ia-people-results-list").removeClass("ia-active"),$(".ia-people-results-grid").addClass("ia-active"),$(".ia-people-results-byList").removeClass("ia-active"),$(".ia-people-results-byGrid").addClass("ia-active"));var context={SubscriptionId:_cur.PeopleDirectoryRequest.SubscriptionId,AppId:_cur.PeopleDirectoryRequest.ClientId,SkipToken:null,FetchPhotoFromAD:_cur.PeopleDirectoryRequest.FetchPhotoFromAD},peopleSearchAllUsers=new PeopleDirectory_SearchAllUsers(context);_cur.GetProfilePicForView(peopleSearchAllUsers)};this.OnAZSelectorChanged=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.onAZSelectorChanged");Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/search/","azselector")};this.OnProfileClicked=function(profileDetails){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.onProfileClicked");var itemInformation=_cur.peopleModel.People.filter(function(element){if(element.Id==profileDetails.itemId)return element});_cur.ShowDetailedProfile(itemInformation[0])};this.OnRefinementChanged=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.onRefinementChanged");_cur.ShowLoading();Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/search/","facets")};this.ShowNextPage=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.showNextPage");_cur.PagingManager.NextPage()&&(_cur.ShowLoading(),Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/search/","nextpage"))};this.GetSortField=function(field){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.sortItems");var sortField="givenName";switch(field.toLowerCase()){case"last":sortField="surname"}return sortField};this.ShowLoading=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.showLoading");$(".ia-loading-panel").length==0?$("#"+_cur._settings.SenderId).html('<div class="interAction"><h1 id="loadingMessage">Fetching users...<\/h1><div class="ia-loading-panel ia-show"><div class="ia-loader"><\/div><\/div><\/div>'):($(".ia-loading-panel").removeClass("ia-hide"),$(".ia-loading-panel").addClass("ia-show"))};this.HideLoading=function(){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.hideLoading");$(".ia-loading-panel").removeClass("ia-show");$(".ia-loading-panel").addClass("ia-hide")};this.OnSuccess=function(){};this.OnError=function(message){$("#loadingMessage").html(message);_cur.HideLoading()};this.PostRender=function(currentPagePeopleModel){var context,peopleSearchAllUsers,searchText;_cur.BindEvents();_cur.HideLoading();_cur.viewModel.isScrollReady=!0;_cur.PagingManager.isLastPage&&$(".showMoreResults").hide();context={SubscriptionId:_cur.PeopleDirectoryRequest.SubscriptionId,AppId:_cur.PeopleDirectoryRequest.ClientId,SkipToken:null,FetchPhotoFromAD:_cur.PeopleDirectoryRequest.FetchPhotoFromAD};peopleSearchAllUsers=new PeopleDirectory_SearchAllUsers(context);_cur.viewModel.urlSearchText!=""&&(searchText=decodeURIComponent(_cur.viewModel.urlSearchText),_cur.viewModel.urlSearchText="",_cur.viewModel.isURLSearch=!0,_cur.viewModel.searchText=searchText,Akumina.AddIn.PeopleDirectoryCommon.Eventing.Publish("/peopledirectory/search/","search"));_cur.GetProfilePictures(currentPagePeopleModel.People,peopleSearchAllUsers)};this.FindAndRenderHandleBar=function(template,partialTemplate,selector,jsonModel){var main,finalHtml;Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.findAndRenderHandleBar");main=Handlebars.compile($(template).html());partialTemplate!=null&&Handlebars.registerPartial(partialTemplate,$("#"+partialTemplate).html());finalHtml=main(jsonModel);$(selector).html(finalHtml)};this.GetCacheInterval=function(){return _cur.CompanyCalendarRequest.CacheInterval&&_cur.CompanyCalendarRequest.CacheInterval!=null&&!isNaN(_cur.CompanyCalendarRequest.CacheInterval)?parseInt(_cur.CompanyCalendarRequest.CacheInterval):Akumina.Digispace.ConfigurationContext.CachingStrategyInterval};this.GetCacheKey=function(){return Akumina.Digispace.ConfigurationContext.getCacheKey(_cur.CompanyCalendarRequest.SenderId)};this.render=function(templateUri,data,caller,currentPagePeopleModel){Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory.render");data.DisplayFL=_cur.PeopleDirectoryRequest.SearchListingDisplay.toLowerCase().trim()=="lf"?!1:!0;data.DisplayAZSelector=_cur.PeopleDirectoryRequest.EnableAZSelector;_cur.IsFacetAsProperty()&&(data.FilterAsProperty=!0);caller=="facets"||caller=="azselector"||caller=="search"||caller=="nextpage"?(_cur.FindAndRenderHandleBar(_cur.viewModel.resultsSection,null,".ia-people-results",data),_cur.PostRender(currentPagePeopleModel),caller!="nextpage"?$("#s4-workspace").scrollTop(0):$("#s4-workspace").scrollTop(_cur.viewModel.scrollPosition)):$.ajax(templateUri).done(function(template){_cur.viewModel.resultsSection=$(template).find(".ia-people-results");_cur.viewModel.filtersSection=$(template).find(".ia-people-filters");_cur.viewModel.azselectorSection=$(template).find(".ia-people-az");_cur.viewModel.searchSection=$(template).find(".ia-people-search");_cur.IsFacetAsProperty()||(data.RefinementFilters=_cur.viewModel.facets.RefinementFilters);var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){_cur.PeopleDirectoryRequest.Hosted?($("body").html(data.Html),AKNotifyParent(_cur.PeopleDirectoryRequest.SenderId)):$("#"+_cur.PeopleDirectoryRequest.SenderId).html(data.Html);_cur.PostRender(currentPagePeopleModel)})}});typeof Akumina.AddIn.ImportantDatesWidget=="undefined"&&(Akumina.AddIn.ImportantDatesWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn,itemsToDisplayVal,itemsToDisplay;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.ListName=_cur.GetPropertyValue(requestIn,"listname","ImportantDates_AK"),requestOut.ViewAllLink=_cur.GetPropertyValue(requestIn,"viewalllink","Calendar.aspx"),requestOut.Title=_cur.GetPropertyValue(requestIn,"title","Important Dates"),requestOut.Icon=_cur.GetPropertyValue(requestIn,"icon",Akumina.AddIn.Icons.None.toString()),requestOut.Calendar=_cur.GetPropertyValue(requestIn,"calendar",!1),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.DisplayTemplateUrl==""&&(requestOut.DisplayTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/ImportantDates/Default.html"),requestOut.FeaturedField=_cur.GetPropertyValue(requestIn,"featuredfield","Featured"),requestOut.CalendarDisplay=_cur.GetPropertyValue(requestIn,"calendardisplay","today"),requestOut.CacheInterval=_cur.GetPropertyValue(requestIn,"cacheinterval","0"),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),itemsToDisplayVal=_cur.GetPropertyValue(requestIn,"itemstodisplay",0),itemsToDisplay=Akumina.AddIn.Utilities.TryParseInt(itemsToDisplayVal,null),requestOut.ItemsToDisplay=itemsToDisplay!=null?itemsToDisplay:0,requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","importantdates"),requestOut};this.Init=function(ImportantDatesRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.ImportantDatesRequest=_cur.SetDefaultsProperties(ImportantDatesRequest);_cur.ImportantDatesRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=_cur.ImportantDatesRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="ImportantDates";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.ImportantDatesRequest.SenderId&&(_cur.ImportantDatesRequest=_cur.SetDefaultsProperties(newProps),_cur.ImportantDatesRequest.EditMode=!1,_cur.Render())};this.Render=function(){var context=new SP.ClientContext.get_current,web,result=Akumina.AddIn.Cache.Get(_cur.GetCacheKey(_cur.ImportantDatesRequest.SenderId)),parentContext,additionalFields;if(result!=null){_cur.BindTemplate(_cur.ImportantDatesRequest.DisplayTemplateUrl,result,_cur.ImportantDatesRequest.SenderId);return}_cur.ImportantDatesRequest.Hosted?(parentContext=new SP.AppContextSite(context,_cur.hostUrl),web=parentContext.get_web()):web=context.get_web();_cur.ImportantDatesRequest.timeZone=web.get_regionalSettings().get_timeZone();context.load(_cur.ImportantDatesRequest.timeZone);var list=web.get_lists().getByTitle(_cur.ImportantDatesRequest.ListName),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("");_cur.listItems=list.getItems(camlQuery);context.load(_cur.listItems);_cur.IsCalendar()?(additionalFields=["Description"],_cur.UsesFeatured()&&additionalFields.push(_cur.ImportantDatesRequest.FeaturedField),context.load(_cur.listItems,"Include("+Akumina.AddIn.Configuration.getSelectFields("Calendar").join()+","+additionalFields.join()+")")):context.load(_cur.listItems);Akumina.AddIn.Logger.logSPCall("ImportantDates.prototype.getItem");context.executeQueryAsync(Function.createDelegate(_cur,_cur.Success),Function.createDelegate(_cur,_cur.Error))};this.UsesFeatured=function(){return this.ImportantDatesRequest.FeaturedField!=null};this.IsCalendar=function(){return _cur.ImportantDatesRequest.Calendar!=null&&(_cur.ImportantDatesRequest.Calendar==!0||_cur.ImportantDatesRequest.Calendar=="true")};this.GetCacheKey=function(attribute){var prefix="akumina:importantdates:"+_spPageContextInfo.siteAbsoluteUrl+":";return attribute!=null&&(prefix+=attribute),prefix};this.GetCacheInterval=function(){return _cur.ImportantDatesRequest.CacheInterval&&_cur.ImportantDatesRequest.CacheInterval!=null&&!isNaN(_cur.ImportantDatesRequest.CacheInterval)?parseInt(_cur.ImportantDatesRequest.CacheInterval):Akumina.Digispace.ConfigurationContext.CachingStrategyInterval};this.ShowItem=function(data){var showItem=!0,calendardisplay="month",lastDayOfPreviousMonth,previousDay;_cur.ImportantDatesRequest.CalendarDisplay!=null&&(calendardisplay=_cur.ImportantDatesRequest.CalendarDisplay);switch(calendardisplay.toLowerCase()){case"month":lastDayOfPreviousMonth=moment().subtract(1,"months").endOf("month");showItem=data.StartDate.isAfter(lastDayOfPreviousMonth);break;default:previousDay=moment().subtract(1,"days");showItem=data.StartDate.isAfter(previousDay)}return showItem};this.Success=function(){var listEnumerator=_cur.listItems.getEnumerator(),model={},siteOffsetMinutes,browserSiteDifference,year,month,recurrenceItem,targetVal,itemImportantDate,dtStartDate;if(model.Items=[],_cur.IsCalendar()){model.showAllLink=!0;for(var browserDate=new Date,browserOffSetMinutes=browserDate.getTimezoneOffset(),info=_cur.ImportantDatesRequest.timeZone.get_information(),offset=(info.get_bias()+info.get_daylightBias())/60,items=[];listEnumerator.moveNext();){var recurrenceItems=[],listItem=listEnumerator.get_current(),data={},itemId=0,title="",body="",url="",startDate="",endDate="",category="",location="",allDayEvent=!1,isRecurring=!1,recurrenceData="",duration=0,description="",featured=!0;if(itemId=listItem.get_item("ID"),title=listItem.get_item("EventTitle"),body=listItem.get_item("Body"),url=listItem.get_item("FriendlyUrl"),startDate=listItem.get_item("EventDate"),endDate=listItem.get_item("EndDate"),category=listItem.get_item("Category"),location=listItem.get_item("Location"),allDayEvent=listItem.get_item("fAllDayEvent"),isRecurring=listItem.get_item("fRecurrence"),recurrenceData=listItem.get_item("RecurrenceData"),duration=listItem.get_item("Duration"),description=listItem.get_item("Description"),_cur.UsesFeatured()&&(featured=listItem.get_item(_cur.ImportantDatesRequest.FeaturedField)),data.Id=itemId,data.Title=title,data.Url=url,data.Body=body,data.Location=location,data.Category=category,data.Date="",data.Time="",data.AllDay=allDayEvent,data.Duration=duration,data.Description=description,data.StartDate=moment(startDate),data.EndDate=moment(endDate),featured)if(data.Featured=featured,siteOffsetMinutes=offset*60,data.AllDay||siteOffsetMinutes===browserOffSetMinutes||(browserSiteDifference=siteOffsetMinutes-browserOffSetMinutes,data.StartDate.subtract(browserSiteDifference,"minutes"),data.EndDate.subtract(browserSiteDifference,"minutes")),data.RecurrenceData=recurrenceData,isRecurring)for(_cur.ImportantDatesRequest.StartDate==null&&(year=(new Date).getFullYear(),month=(new Date).getMonth()+1,_cur.ImportantDatesRequest.StartDate=new Date(year,month-1,1)),recurrenceItems=Akumina.AddIn.Utilities.addRecurringEvents(data,_cur.ImportantDatesRequest.StartDate.getMonth()+1,_cur.ImportantDatesRequest.StartDate.getFullYear()),i=0;i<recurrenceItems.length;i++)recurrenceItem=recurrenceItems[i],_cur.ShowItem(data)&&items.push(recurrenceItem);else data=Akumina.AddIn.Utilities.setDateValues(data,data.StartDate,data.EndDate),_cur.ShowItem(data)&&items.push(data)}for(items.sort(function(a,b){return a.StartDate.diff(b.StartDate,"days")}),i=0;i<items.length;i++)if(itemImportantDate=items[i],itemImportantDate.LinkText=itemImportantDate.Title,itemImportantDate.LinkSrc=itemImportantDate.Url,itemImportantDate.Target="_self",itemImportantDate.SubText=$("<div/>").html(itemImportantDate.Description).text(),itemImportantDate.HasLink=itemImportantDate.Url!="",dtStartDate=moment(itemImportantDate.StartDate),itemImportantDate.StartDate=dtStartDate,itemImportantDate.FullDate=dtStartDate.format("YYYY-MM-DD"),itemImportantDate.DateMonth=dtStartDate.format("MMM"),itemImportantDate.DateDay=dtStartDate.format("DD"),model.Items.push(itemImportantDate),_cur.ImportantDatesRequest.ItemsToDisplay>0&&model.Items.length>=_cur.ImportantDatesRequest.ItemsToDisplay)break}else while(listEnumerator.moveNext()){var listItem=listEnumerator.get_current(),itemId=0,title="",titleLink="",target="",subtext="",expires="",created="",startDate="",doNotDisplay=!1;if((itemId=listItem.get_item("ID"),title=listItem.get_item("Title"),listItem.get_item("DetailsLink")!=null&&(titleLink=listItem.get_item("DetailsLink").get_url()),targetVal=listItem.get_item("MoreWindow"),target=targetVal=="New Window"?"_blank":"_self",subtext=listItem.get_item("Subtext"),expires=listItem.get_item("Expires"),created=listItem.get_item("Created"),typeof listItem.get_fieldValues().Start_x0020_Date!="undefined"?startDate=listItem.get_item("Start_x0020_Date"):typeof listItem.get_fieldValues().StartDate!="undefined"&&(startDate=listItem.get_item("StartDate")),doNotDisplay=listItem.get_item("DoNotDisplayThisItem"),doNotDisplay!=!0&&doNotDisplay!="true")&&!Akumina.AddIn.Utilities.ItemExpired(expires)&&(itemImportantDate={LinkText:title,LinkSrc:titleLink,Target:target,SubText:subtext,HasLink:titleLink!=""},startDate&&startDate!=""&&(dtStartDate=moment(startDate),itemImportantDate.StartDate=dtStartDate,itemImportantDate.FullDate=dtStartDate.format("YYYY-MM-DD"),itemImportantDate.DateMonth=dtStartDate.format("MMM"),itemImportantDate.DateDay=dtStartDate.format("DD")),model.Items.push(itemImportantDate),_cur.ImportantDatesRequest.ItemsToDisplay>0&&model.Items.length>=_cur.ImportantDatesRequest.ItemsToDisplay))break}model.Items.sort(function(a,b){return a.StartDate.diff(b.StartDate,"days")});model.WebPartTitle=_cur.ImportantDatesRequest.Title;model.WebPartIcon=Akumina.AddIn.Utilities.GetIcon(_cur.ImportantDatesRequest.Icon);model.ShowHeader=_cur.ImportantDatesRequest.Title!=""||model.WebPartIcon!="none";model.SenderId=_cur.ImportantDatesRequest.SenderId;model.ViewAllLink=_cur.ImportantDatesRequest.ViewAllLink;model.HasItems=model.Items.length>0;_cur.ImportantDatesRequest.EditMode||(Akumina.AddIn.Cache.Set(_cur.GetCacheKey(_cur.ImportantDatesRequest.SenderId),model,_cur.GetCacheInterval()),_cur.BindTemplate(_cur.ImportantDatesRequest.DisplayTemplateUrl,model,_cur.ImportantDatesRequest.SenderId))};this.Error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.BindTemplate=function(templateUri,data,targetDiv){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){$("#"+targetDiv).html(html)},function(errormsg){var data={sender:_cur.ImportantDatesRequest.SenderId,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.ImportantDatesRequest.SenderId).html(html)})})}});typeof Akumina.AddIn.ContentBlockWidget=="undefined"&&(Akumina.AddIn.ContentBlockWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.QueryPart=decodeURI(_cur.GetPropertyValue(requestIn,"querypart","")),requestOut.SiteWideAlertMessage=_cur.GetPropertyValue(requestIn,"sitewidealertmessage",""),requestOut.DisableAlert=_cur.GetPropertyValue(requestIn,"disabledalert",""),requestOut.DisableAlert=Akumina.AddIn.Utilities.IsNullOrEmpty(requestOut.DisableAlert)?!1:requestOut.DisableAlert==="true",requestOut.IsPreview=_cur.GetPropertyValue(requestIn,"preview",!1),requestOut.DynamicPreview=_cur.GetPropertyValue(requestIn,"dynamicpreview",""),requestOut.Title=_cur.GetPropertyValue(requestIn,"title",""),requestOut.Icon=_cur.GetPropertyValue(requestIn,"icon",Akumina.AddIn.Icons.None.toString()),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.DisplayTemplateUrl==""&&(requestOut.DisplayTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/contentBlock/Default.html"),requestOut.CacheInterval=_cur.GetPropertyValue(requestIn,"cacheinterval","0"),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","contentblock"),requestOut};this.Init=function(contentRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.contentRequest=_cur.SetDefaultsProperties(contentRequest);_cur.contentRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=_cur.contentRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="ContentBlock";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisableAlert","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"IsPreview","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"Hosted","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.contentRequest.SenderId&&(_cur.contentRequest=_cur.SetDefaultsProperties(newProps),_cur.contentRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.Render())};this.Render=function(){var cachedItems=Akumina.AddIn.Cache.Get(_cur.GetCacheKey(_cur.contentRequest.SenderId)),me,instruction;cachedItems&&cachedItems!=null&&_cur.BindTemplate(_cur.contentRequest.DisplayTemplateUrl,cachedItems,_cur.contentRequest.SenderId);_cur.contentRequest.EnableAlert==null&&(_cur.contentRequest.EnableAlert=!_cur.contentRequest.DisableAlert);me=this;instruction=new Akumina.AddIn.Instructions;instruction.executeAsync(_cur,_cur.contentRequest.InstructionSet,"contentRequest").then(function(result){var utils=Akumina.AddIn.Utilities,templatePrefix,data,qp,context,web,parentContext,site;if(_cur.appWebUrl=result.appWebUrl,_cur.hostUrl=result.hostUrl,_cur.contentRequest=result.contentRequest,_cur.contentRequest.Hosted?utils.IsNullOrEmpty(_cur.contentRequest.DisplayTemplateUrl)&&(_cur.contentRequest.DisplayTemplateUrl=_cur.appWebUrl+"/Content/Templates/ContentBlock/Default.html",!utils.IsNullOrEmpty(_cur.contentRequest.SiteWideAlertMessage)&&_cur.contentRequest.EnableAlert&&(_cur.contentRequest.DisplayTemplateUrl=_cur.appWebUrl+"/Content/Templates/ContentBlock/Alert.html")):utils.IsNullOrEmpty(_cur.contentRequest.DisplayTemplateUrl)&&(templatePrefix=_spPageContextInfo.siteServerRelativeUrl,_spPageContextInfo.siteServerRelativeUrl==="/"&&(templatePrefix=""),_cur.contentRequest.DisplayTemplateUrl=_cur.GetParam("dtu",templatePrefix+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/ContentBlock/Default.html"),!utils.IsNullOrEmpty(_cur.contentRequest.SiteWideAlertMessage)&&_cur.contentRequest.EnableAlert&&(_cur.contentRequest.DisplayTemplateUrl=_cur.GetParam("dtu",templatePrefix+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/ContentBlock/Alert.html"))),utils.IsNullOrEmpty(_cur.contentRequest.QueryPart))data={ShowContent:!0},data.SenderId=_cur.contentRequest.SenderId,data.Id=0,data.Title=_cur.contentRequest.Title,data.WebPartTitle=_cur.contentRequest.Title,data.WebPartIcon=utils.GetIcon(_cur.contentRequest.Icon),data.ShowHeader=_cur.contentRequest.Title!==""||utils.GetIcon(contentRequest.Icon)!=="none",data.hosted=_cur.contentRequest.Hosted,!_cur.contentRequest.EnableAlert||utils.ItemExpired(data.Expired)?(data.Title="",data.Html="",data.ShowContent=!1):data.Html=utils.IsNullOrEmpty(_cur.contentRequest.SiteWideAlertMessage)?data.Html:_cur.contentRequest.SiteWideAlertMessage,Akumina.AddIn.Cache.Set(_cur.GetCacheKey(_cur.contentRequest.SenderId),data,_cur.GetCacheInterval()),_cur.BindTemplate(_cur.contentRequest.DisplayTemplateUrl,data,_cur.contentRequest.SenderId);else{qp=_cur.contentRequest.QueryPart.split(".");qp.length===3?(_cur.rootWeb=!0,_cur.listName=qp[1],_cur.idOrTitle=qp[2]):(_cur.rootWeb=!1,_cur.listName=qp[0],_cur.idOrTitle=qp[1]);context=new SP.ClientContext.get_current;_cur.contentRequest.Hosted?(parentContext=new SP.AppContextSite(context,_cur.hostUrl),_cur.rootWeb?(site=parentContext.get_site(),web=site.get_rootWeb()):web=parentContext.get_web()):_cur.rootWeb?(site=context.get_site(),web=site.get_rootWeb()):web=context.get_web();var list=web.get_lists().getByTitle(_cur.listName),camlQuery=new SP.CamlQuery,query="<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+_cur.idOrTitle+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>";isNaN(_cur.idOrTitle)&&(query="<View><Query><Where><Eq><FieldRef Name='Title'/><Value Type='Text'>"+_cur.idOrTitle+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>");camlQuery.set_viewXml(query);_cur.contentRequest.listItems=list.getItems(camlQuery);context.load(_cur.contentRequest.listItems,"Include("+Akumina.AddIn.Configuration.getSelectFields("ContentBlock").join()+")");Akumina.AddIn.Logger.logSPCall("ContentBlock.prototype.getItems");context.executeQueryAsync(Function.createDelegate(_cur,_cur.Success),Function.createDelegate(_cur,_cur.Error))}})};this.BindFormModal=function(){$(".ak-cke-href-frm").unbind();$(".ak-cke-href-frm").on("click",function(){var formId=$(this).data("frmid");ShowAKFormModal(formId)})};this.GetParam=function(key,val){var utils=Akumina.AddIn.Utilities,ret=utils.getQueryStringParameter(key,val);return utils.IsNullOrEmpty(ret)&&!utils.IsNullOrEmpty(val)?val:ret};this.Success=function(){var listEnumerator=_cur.contentRequest.listItems.getEnumerator(),data={ShowContent:!0},utils=Akumina.AddIn.Utilities,listItem;for(data.hosted=_cur.contentRequest.Hosted;listEnumerator.moveNext();)listItem=listEnumerator.get_current(),data.SenderId=_cur.contentRequest.SenderId,data.Id=listItem.get_item("ID"),data.Title=listItem.get_item("Title"),data.Html=listItem.get_item("Html"),data.Expired=listItem.get_item("Expires"),data.IsAlert=listItem.get_item("IsAlert"),data.WebPartTitle=_cur.contentRequest.Title,data.WebPartIcon=utils.GetIcon(_cur.contentRequest.Icon),data.ShowHeader=_cur.contentRequest.Title!==""||utils.GetIcon(_cur.contentRequest.Icon)!=="none";!_cur.contentRequest.EnableAlert||utils.ItemExpired(data.Expired)?(data.Title="",data.Html="",data.ShowContent=!1):data.Html=utils.IsNullOrEmpty(_cur.contentRequest.SiteWideAlertMessage)?data.Html:_cur.contentRequest.SiteWideAlertMessage;data.IsAlert&&(_cur.contentRequest.DisplayTemplateUrl=_cur.appWebUrl+"/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/ContentBlock/Alert.html");_cur.contentRequest.EditMode||(Akumina.AddIn.Cache.Set(_cur.GetCacheKey(_cur.contentRequest.SenderId),data,_cur.GetCacheInterval()),_cur.BindTemplate(_cur.contentRequest.DisplayTemplateUrl,data,_cur.contentRequest.SenderId))};this.Error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.GetCacheKey=function(attribute){var prefix="akumina:contentblock:"+_spPageContextInfo.siteAbsoluteUrl+":";return attribute!=null&&(prefix+=attribute),prefix};this.GetCacheInterval=function(){return _cur.contentRequest.CacheInterval&&_cur.contentRequest.CacheInterval!=null&&!isNaN(_cur.contentRequest.CacheInterval)?parseInt(_cur.contentRequest.CacheInterval):Akumina.Digispace.ConfigurationContext.CachingStrategyInterval};this.BindTemplate=function(templateUri,data,targetDiv){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){$("#"+targetDiv).html(html);_cur.BindFormModal()},function(errormsg){var data={sender:_cur.contentRequest.SenderId,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.contentRequest.SenderId).html(html)})})}});typeof Akumina.AddIn.AnnouncementItemsWidget=="undefined"&&(Akumina.AddIn.AnnouncementItemsWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn,itemsToDisplayVal,itemsToDisplay;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.ListName=_cur.GetPropertyValue(requestIn,"listname",""),requestOut.WebPartTitle=_cur.GetPropertyValue(requestIn,"title","Announcement Items"),requestOut.Icon=_cur.GetPropertyValue(requestIn,"icon",Akumina.AddIn.Icons.None.toString()),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.DisplayTemplate=_cur.GetPropertyValue(requestIn,"displaytemplate","WidgetTemplate"),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.DisplayTemplateUrl==""&&(requestOut.DisplayTemplateUrl=_spPageContextInfo.siteServerRelativeUrl=="/"?"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/AnnouncementItems/Default.html":_spPageContextInfo.siteServerRelativeUrl+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/AnnouncementItems/Default.html"),itemsToDisplayVal=_cur.GetPropertyValue(requestIn,"itemstodisplay",10),itemsToDisplay=Akumina.AddIn.Utilities.TryParseInt(itemsToDisplayVal,null),requestOut.ItemsToDisplay=itemsToDisplay!=null?itemsToDisplay:10,requestOut.ViewAllLink=_cur.GetPropertyValue(requestIn,"viewalllink","NewsList.aspx"),requestOut.isPaging=_cur.GetPropertyValue(requestIn,"ispaging","false"),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","announcementitems"),requestOut};this.Init=function(announcementItemsRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.announcementItemsRequest=_cur.SetDefaultsProperties(announcementItemsRequest);_cur.announcementItemsRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.announcementItemsPagingObj=new Akumina.AddIn.GenericListPaging;_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=_cur.announcementItemsRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="AnnouncementItems";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisableAlert","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"isPaging","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"Hosted","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.announcementItemsRequest.SenderId&&(_cur.announcementItemsRequest=_cur.SetDefaultsProperties(newProps),_cur.announcementItemsRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.announcementItemsPagingObj=new Akumina.AddIn.GenericListPaging,_cur.Render())};this.Render=function(){var instruction=new Akumina.AddIn.Instructions;instruction.executeAsync(_cur,_cur.announcementItemsRequest.InstructionSet,"announcementItemsRequest").then(function(result){var context,web,parentContext;_cur.appWebUrl=result.appWebUrl;_cur.hostUrl=result.hostUrl;_cur.announcementItemsRequest=result.announcementItemsRequest;context=new SP.ClientContext.get_current;_cur.announcementItemsRequest.Hosted?(parentContext=new SP.AppContextSite(context,_cur.hostUrl),web=parentContext.get_web()):web=context.get_web();var list=web.get_lists().getByTitle(_cur.announcementItemsRequest.ListName),camlQuery=new SP.CamlQuery,query="<View><Query><OrderBy><FieldRef Name='Start_x0020_Date' Ascending='FALSE'><\/FieldRef><\/OrderBy><Where><And><Leq><FieldRef Name='Start_x0020_Date' /><Value IncludeTimeValue='TRUE' Type='DateTime'><Today /><\/Value><\/Leq><Or><Geq><FieldRef Name='Expires' /><Value IncludeTimeValue='TRUE' Type='DateTime'><Today /><\/Value><\/Geq><IsNull><FieldRef Name='Expires' /><\/IsNull><\/Or><\/And><\/Where><\/Query><RowLimit>"+_cur.announcementItemsRequest.ItemsToDisplay+"<\/RowLimit><\/View>";JSON.parse(_cur.announcementItemsRequest.isPaging)&&(_cur.announcementItemsPagingObj.nextPagingInfo?(_cur.announcementItemsPagingObj.position=new SP.ListItemCollectionPosition,_cur.announcementItemsPagingObj.position.set_pagingInfo(_cur.announcementItemsPagingObj.nextPagingInfo)):_cur.announcementItemsPagingObj.position=null,camlQuery.set_listItemCollectionPosition(_cur.announcementItemsPagingObj.position));camlQuery.set_viewXml(query);_cur.announcementItemsRequest.ListItems=list.getItems(camlQuery);context.load(_cur.announcementItemsRequest.ListItems,"ListItemCollectionPosition","Include(ID,Title,Summary,FriendlyUrl,Expires,Created,AnnouncementTitle,Start_x0020_Date)");Akumina.AddIn.Logger.logSPCall("AnnouncementItems.prototype.getItems");context.executeQueryAsync(Function.createDelegate(_cur,_cur.Success),Function.createDelegate(_cur,_cur.Error))})};this.Success=function(){var listEnumerator=_cur.announcementItemsRequest.ListItems.getEnumerator(),result={},itemAnnouncement,dtCreated,dtStartDate;for(result.IsPageTemplate=_cur.announcementItemsRequest.DisplayTemplate=="PageTemplate",result.Items=[],JSON.parse(_cur.announcementItemsRequest.isPaging)&&(_cur.announcementItemsPagingObj.nextPagingInfo=_cur.announcementItemsRequest.ListItems.get_listItemCollectionPosition()?_cur.announcementItemsRequest.ListItems.get_listItemCollectionPosition().get_pagingInfo():null,_cur.announcementItemsPagingObj.nextPagingInfo||(_cur.announcementItemsPagingObj.isLastPage=!0));listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),title="",announcementTitle="",summary="",url="",created="",startDate="";title=listItem.get_item("Title");announcementTitle=listItem.get_item("AnnouncementTitle");summary=listItem.get_item("Summary");url=listItem.get_item("FriendlyUrl");created=listItem.get_item("Created");startDate=listItem.get_item("Start_x0020_Date");startDate==null&&(startDate=created);itemAnnouncement={Title:title,AnnouncementTitle:announcementTitle,Summary:summary,Url:url,IsPageTemplate:result.IsPageTemplate,Created:created,StartDate:moment(startDate),StartedDisplay:""};created&&created!=""&&(dtCreated=moment(created),itemAnnouncement.CreatedDateTime=dtCreated,itemAnnouncement.Created=dtCreated.format("MMMM DD, YYYY"));startDate&&startDate!=""&&(dtStartDate=moment(startDate),itemAnnouncement.StartedDateTime=dtStartDate,itemAnnouncement.StartedDisplay=dtStartDate.format("MMMM DD, YYYY"));result.Items.push(itemAnnouncement)}JSON.parse(_cur.announcementItemsRequest.isPaging)&&(_cur.announcementItemsPagingObj.pageWiseResult.push(result.Items),result.Items=_cur.announcementItemsPagingObj.GetFinalResult(result.Items));result.WebPartTitle=_cur.announcementItemsRequest.WebPartTitle;result.ViewAllLink=_cur.announcementItemsRequest.ViewAllLink;result.HasViewAllLink=_cur.announcementItemsRequest.ViewAllLink&&_cur.announcementItemsRequest.ViewAllLink!="";result.WebPartIcon=Akumina.AddIn.Utilities.GetIcon(_cur.announcementItemsRequest.Icon);result.SenderId=_cur.announcementItemsRequest.SenderId;result.hosted=_cur.announcementItemsRequest.Hosted;_cur.announcementItemsRequest.EditMode||_cur.BindTemplate(_cur.announcementItemsRequest.DisplayTemplateUrl,result,_cur.announcementItemsRequest.SenderId)};this.BindEvents=function(){var me=this;JSON.parse(_cur.announcementItemsRequest.isPaging)&&($("#"+_cur.announcementItemsRequest.SenderId+" .showMoreResults a").unbind().click(function(){_cur.announcementItemsPagingObj.isLastPage||_cur.Render()}),$(window).trigger("resize"))};this.Error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.BindTemplate=function(templateUri,data,targetDiv){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){$("#"+targetDiv).html(html);_cur.BindEvents();(!JSON.parse(_cur.announcementItemsRequest.isPaging)||_cur.announcementItemsPagingObj.isLastPage)&&$("#"+_cur.announcementItemsRequest.SenderId+" .showMoreResults").hide()},function(errormsg){var data={sender:_cur.announcementItemsRequest.SenderId,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.announcementItemsRequest.SenderId).html(html)})})}});typeof Akumina.AddIn.EventDetailWidget=="undefined"&&(Akumina.AddIn.EventDetailWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.GetDefaultTemplateUrl=function(){return __getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/EventDetail/Default.html"};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.ListName=_cur.GetPropertyValue(requestIn,"listname","Calendar_AK"),requestOut.CalendarLink=_cur.GetPropertyValue(requestIn,"calendarlink","Calendar"),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.FriendlyUrl=Akumina.AddIn.Utilities.GetFriendlyUrl(window.location.href),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",_cur.GetDefaultTemplateUrl()),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","eventdetail"),requestOut.RootWeb=_cur.GetPropertyValue(requestIn,"isroot","false"),requestOut.Category=_cur.GetPropertyValue(requestIn,"category",getCategoryForCalendar()),requestOut};this.Init=function(eventDetailRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.EventDetailRequest=_cur.SetDefaultsProperties(eventDetailRequest);_cur.EventDetailRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=_cur.EventDetailRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="EventDetail";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"Hosted","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.EventDetailRequest.SenderId&&(_cur.EventDetailRequest=_cur.SetDefaultsProperties(newProps),_cur.EventDetailRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.Render())};this.Render=function(){var context=new SP.ClientContext.get_current,web,parentContext,site,camlQuery,categoryFilter,titleFilter,query;_cur.EventDetailRequest.Hosted?(parentContext=new SP.AppContextSite(context,_cur.hostUrl),JSON.parse(_cur.EventDetailRequest.RootWeb)?(site=parentContext.get_site(),web=site.get_rootWeb()):web=parentContext.get_web()):JSON.parse(_cur.EventDetailRequest.RootWeb)?(site=context.get_site(),web=site.get_rootWeb()):web=context.get_web();_cur.timeZone=web.get_regionalSettings().get_timeZone();_cur.list=web.get_lists().getByTitle(_cur.EventDetailRequest.ListName);camlQuery=new SP.CamlQuery;categoryFilter="";_cur.EventDetailRequest.Category&&_cur.EventDetailRequest.Category.trim()!=""&&(categoryFilter="<Eq><FieldRef Name='Category'/><Value Type='Choice'>"+_cur.EventDetailRequest.Category+"<\/Value><\/Eq>");titleFilter="<Eq><FieldRef Name='Title'/><Value Type='Text'>"+_cur.EventDetailRequest.FriendlyUrl+"<\/Value><\/Eq>";query="<View><Query><Where>";query+=categoryFilter!=""?"<And>"+categoryFilter:"";query+=titleFilter;query+=categoryFilter!=""?"<\/And>":"";query+="<\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>";camlQuery.set_viewXml(query);context.load(_cur.list);context.load(_cur.timeZone);_cur.listItems=_cur.list.getItems(camlQuery);context.load(_cur.listItems,"Include("+Akumina.AddIn.Configuration.getSelectFields("EventDetail").join()+")");Akumina.AddIn.Logger.logSPCall("EventDetail.prototype.getItem");context.executeQueryAsync(Function.createDelegate(_cur,_cur.Success),Function.createDelegate(_cur,_cur.Error))};this.Success=function(){for(var listEnumerator=_cur.listItems.getEnumerator(),browserDate=new Date,browserOffSetMinutes=browserDate.getTimezoneOffset(),info=_cur.timeZone.get_information(),offset=(info.get_bias()+info.get_daylightBias())/60,model={},listId=_cur.list.get_id().toString(),siteOffsetMinutes,browserSiteDifference,recurrenceItem;listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),itemId=0,title="",body="",url="",startDate="",endDate="",category="",location="",allDayEvent=!1,isRecurring=!1,duration=0;if(itemId=listItem.get_item("ID"),eventTitle=listItem.get_item("EventTitle"),title=listItem.get_item("Title"),body=listItem.get_item("Body"),url=listItem.get_item("FriendlyUrl"),startDate=listItem.get_item("EventDate"),endDate=listItem.get_item("EndDate"),category=listItem.get_item("Category"),location=listItem.get_item("Location"),allDayEvent=listItem.get_item("fAllDayEvent"),isRecurring=listItem.get_item("fRecurrence"),recurrenceData=listItem.get_item("RecurrenceData"),duration=listItem.get_item("Duration"),model.Id=itemId,model.Title=eventTitle,model.Url=url,model.FileName=title,model.Body=body,model.Location=location,model.Category=category,model.CalendarLink=_cur.EventDetailRequest.CalendarLink,model.HasCalendarLink=model.CalendarLink!=null&&model.CalendarLink!="",model.Date="",model.Time="",model.AllDay=allDayEvent,model.HasRecurrence=isRecurring,model.RecurrenceDisplay=_cur.GetRecurrenceMessage(recurrenceData),model.CalDate=Akumina.AddIn.Utilities.getQueryStringParameter("caldate",""),model.Duration=duration,model.StartDate=moment(startDate),model.EndDate=moment(endDate),siteOffsetMinutes=offset*60,model.AllDay||siteOffsetMinutes==browserOffSetMinutes||(browserSiteDifference=siteOffsetMinutes-browserOffSetMinutes,model.StartDate.subtract(browserSiteDifference,"minutes"),model.EndDate.subtract(browserSiteDifference,"minutes")),model.RecurrenceData=recurrenceData,isRecurring){var currentDate=new Date,calDate=Akumina.AddIn.Utilities.getQueryStringParameter("caldate"),calparts=calDate.split("-"),eventYear=calparts.length==3?parseInt(calparts[0]):currentDate.getFullYear(),eventMonth=calparts.length==3?parseInt(calparts[1]):currentDate.getMonth()+1,eventDay=calparts.length==3?parseInt(calparts[2]):currentDate.getDate(),recurrenceItems=Akumina.AddIn.Utilities.addRecurringEvents(model,eventMonth,eventYear);for(i=0;i<recurrenceItems.length;i++)if(recurrenceItem=recurrenceItems[i],Akumina.AddIn.Utilities.isInDay(recurrenceItem,eventDay,eventMonth,eventYear)){model=recurrenceItem;break}}else _cur.SetDateValues(model,model.StartDate,model.EndDate);model.AllDay&&(model.Time="All day")}model._spPageContextInfositeServerRelativeUrl=typeof _spPageContextInfo!="undefined"?_spPageContextInfo.siteServerRelativeUrl:"";model._spPageContextInfowebServerRelativeUrl=typeof _spPageContextInfo!="undefined"?_spPageContextInfo.webServerRelativeUrl:"";model.ListId=listId;model.SenderId=_cur.EventDetailRequest.SenderId;model.hosted=_cur.EventDetailRequest.Hosted;_cur.EventDetailRequest.EditMode||_cur.render(_cur.EventDetailRequest.DisplayTemplateUrl,model)};this.SetDateValues=function(data,startDate,endDate){var dtStartDate=startDate.isValid()?startDate.clone():moment(startDate),dtEndDate;return data.AllDay&&(dtStartDate=dtStartDate.utc()),data.StartDate=dtStartDate,data.StartDateYear=dtStartDate.year(),data.StartDateMonth=dtStartDate.month()+1,data.Date=dtStartDate.format("dddd, MMMM DD, YYYY"),data.DisplayStartDate=dtStartDate.format("dddd, MMMM DD, YYYY"),data.AllDay?(data.Time="",data.DisplayStartTime=""):(data.Time=dtStartDate.format("h:mm A"),data.DisplayStartTime=dtStartDate.format("h:mm A")),data.StartDateUTC=dtStartDate.utc().format("YYYY-MM-DDTHH:mm:ss+00:00"),dtEndDate=moment(endDate),data.AllDay&&(dtEndDate=dtEndDate.utc()),data.EndDate=dtEndDate,data.EndDateYear=dtEndDate.year(),data.EndDateMonth=dtEndDate.month(),dtEndDate.year()>=dtStartDate.year()&&dtEndDate.month()>=dtStartDate.month()&&dtEndDate.date()>dtStartDate.date()&&(data.Date=data.Date+=" - "+dtEndDate.format("dddd, MMMM DD, YYYY")),data.AllDay?(data.Time="",data.DisplayEndTime=""):(data.Time=data.Time+=" - "+dtEndDate.format("h:mm A"),data.DisplayEndTime=dtEndDate.format("h:mm A")),data.DisplayEndDate=dtEndDate.format("dddd, MMMM DD, YYYY"),data.DisplayEndDate==data.DisplayStartDate&&(data.DisplayEndDate=""),data.EndDateUTC=dtEndDate.utc().format("YYYY-MM-DDTHH:mm:ss+00:00"),data.DisplayDateRange=data.Date,data.DisplayTimeRange=data.Time,data};this.GetRecurrenceMessage=function(recurrenceData){var recurrenceMsg="",recurrenceXml,valuesToTest,nameToShow,recurrenceFreq,daysOfWeekActive,monthdayText,weekdayText,thisVal;if(recurrenceData!="")if(recurrenceMsg="Occurs every ",recurrenceXml=$.parseXML(recurrenceData),$xml=$(recurrenceXml),$daily=$xml.find("daily"),$weekly=$xml.find("weekly"),$monthly=$xml.find("monthly"),$monthlyByDay=$xml.find("monthlyByDay"),$yearly=$xml.find("yearly"),$yearlyByDay=$xml.find("yearlyByDay"),$repeatForever=$xml.find("repeatForever"),$repeatInstances=$xml.find("repeatInstances"),$repeatEndDate=$xml.find("windowEnd"),valuesToTest=["day","weekday","weekend_day","su","mo","tu","we","th","fr","sa"],nameToShow=["day","weekday","weekend day","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],$daily.length>0)$freq=$daily.attr("dayFrequency"),recurrenceMsg+=$freq!=null&&$freq!=""?$freq+" days ":"weekday ";else if($weekly.length>0)recurrenceFreq="",daysOfWeekActive=[],$freq=$weekly.attr("weekFrequency"),$freq!=""&&(recurrenceFreq=$freq),$weekly.attr("su")!=null&&daysOfWeekActive.push("Sunday"),$weekly.attr("mo")!=null&&daysOfWeekActive.push("Monday"),$weekly.attr("tu")!=null&&daysOfWeekActive.push("Tuesday"),$weekly.attr("we")!=null&&daysOfWeekActive.push("Wednesday"),$weekly.attr("th")!=null&&daysOfWeekActive.push("Thursday"),$weekly.attr("fr")!=null&&daysOfWeekActive.push("Friday"),$weekly.attr("sa")!=null&&daysOfWeekActive.push("Saturday"),recurrenceMsg+=recurrenceFreq+" week(s) on "+daysOfWeekActive.join(", ")+" ";else if($monthly.length>0||$monthlyByDay.length>0){if($monthly.length>0)$day=$monthly.attr("day"),$freq=$monthly.attr("monthFrequency"),recurrenceMsg+=$freq+" month(s) on day "+$day;else if($monthlyByDay.length>0){for($weekdayOfMonth=$monthlyByDay.attr("weekdayOfMonth"),$freq=$monthlyByDay.attr("monthFrequency"),monthdayText="",i=0;i<valuesToTest.length;i++)if(thisVal=valuesToTest[i],$valToTest=$monthlyByDay.attr(thisVal),$valToTest=="TRUE"){monthdayText=nameToShow[i];break}recurrenceMsg+=$freq+" month(s) on the "+$weekdayOfMonth+" "+monthdayText}}else if($yearly.length>0||$yearlyByDay.length>0)if($yearly.length>0)$month=$yearly.attr("month"),$freq=$yearly.attr("day"),recurrenceMsg+=" year on "+_cur.GetMonthName($month)+" "+$freq;else if($yearlyByDay.length>0){for($weekOfMonth=$yearlyByDay.attr("weekdayOfMonth"),$freq=$yearlyByDay.attr("month"),weekdayText="",i=0;i<valuesToTest.length;i++)if(thisVal=valuesToTest[i],$valToTest=$yearlyByDay.attr(thisVal),$valToTest=="TRUE"){weekdayText=nameToShow[i];break}recurrenceMsg+=_cur.GetMonthName($freq)+" on the "+$weekOfMonth+" "+weekdayText}return recurrenceMsg};this.GetMonthName=function(monthIndex){var month=[];return month[0]="January",month[1]="February",month[2]="March",month[3]="April",month[4]="May",month[5]="June",month[6]="July",month[7]="August",month[8]="September",month[9]="October",month[10]="November",month[11]="December",month[monthIndex]};this.GetCacheKey=function(attribute){var prefix="akumina:eventdetail:"+_spPageContextInfo.siteAbsoluteUrl+":";return attribute!=null&&(prefix+=attribute),prefix};this.GetCacheInterval=function(){return _cur.EventDetailRequest.CacheInterval&&_cur.EventDetailRequest.CacheInterval!=null&&!isNaN(_cur.EventDetailRequest.CacheInterval)?parseInt(_cur.EventDetailRequest.CacheInterval):Akumina.Digispace.ConfigurationContext.CachingStrategyInterval};this.Error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.render=function(templateUri,data){var template=Akumina.AddIn.Cache.Get("template:"+templateUri),hbstemplate;template!=null?(hbstemplate=Handlebars.compile(template),data.Html=hbstemplate(data),_cur.RenderAlways(data)):$.ajax(templateUri).done(function(template){Akumina.AddIn.Cache.Set("template:"+templateUri,template);var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){_cur.RenderAlways(data)})};this.RenderAlways=function(data){if(data.hosted)$("body").html(data.Html),AKNotifyParent(data.SenderId);else{$("#"+data.SenderId).html(data.Html);var options={event:data},controlOptions={apppart:!1,UniqueId:data.SenderId,options:options},iaEventDetail=new Akumina.AppParts.EventDetail(controlOptions)}}});typeof Akumina.AddIn.CalendarWidget=="undefined"&&(Akumina.AddIn.CalendarWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.GetDefaultTemplateUrl=function(){return __getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/Calendar/Default.html"};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.ListName=_cur.GetPropertyValue(requestIn,"listname","Calendar_AK"),requestOut.Title=_cur.GetPropertyValue(requestIn,"title","Calendar"),requestOut.IsPreview=_cur.GetPropertyValue(requestIn,"preview",!1),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.Icon=_cur.GetPropertyValue(requestIn,"icon",Akumina.AddIn.Icons.None.toString()),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",_cur.GetDefaultTemplateUrl()),requestOut.StartDate=_cur.GetPropertyValue(requestIn,"startdate",getCalendarStartDate()),requestOut.Category=_cur.GetPropertyValue(requestIn,"category",getCategoryForCalendar()),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","calendar"),requestOut.RootWeb=_cur.GetPropertyValue(requestIn,"isroot","false"),requestOut.ShowCategories=_cur.GetPropertyValue(requestIn,"showcategories","true"),requestOut};this.Init=function(calendarRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.CalendarRequest=_cur.SetDefaultsProperties(calendarRequest);_cur.CalendarRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.CalendarRequest.distinctChoices=[];_cur.GetChoiceFields(_cur.CalendarRequest.ListName);_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=_cur.CalendarRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="Calendar";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"IsPreview","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"Hosted","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.CalendarRequest.SenderId&&(_cur.CalendarRequest=_cur.SetDefaultsProperties(newProps),_cur.CalendarRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.CalendarRequest.distinctChoices=[],_cur.GetChoiceFields(_cur.CalendarRequest.ListName),_cur.Render())};this.Render=function(){var instruction=new Akumina.AddIn.Instructions;instruction.executeAsync(_cur,_cur.CalendarRequest.InstructionSet,"CalendarRequest").then(function(result){var context,web,parentContext,site,query;_cur.appWebUrl=result.appWebUrl;_cur.hostUrl=result.hostUrl;_cur.CalendarRequest=result.CalendarRequest;context=new SP.ClientContext.get_current;_cur.CalendarRequest.Hosted?(parentContext=new SP.AppContextSite(context,_cur.hostUrl),JSON.parse(_cur.CalendarRequest.RootWeb)?(site=parentContext.get_site(),web=site.get_rootWeb()):web=parentContext.get_web()):JSON.parse(_cur.CalendarRequest.RootWeb)?(site=context.get_site(),web=site.get_rootWeb()):web=context.get_web();_cur.CalendarRequest.timeZone=web.get_regionalSettings().get_timeZone();var list=web.get_lists().getByTitle(_cur.CalendarRequest.ListName),camlQuery=new SP.CamlQuery,categoryFilter="";_cur.CalendarRequest.Category&&_cur.CalendarRequest.Category.trim()!=""&&(categoryFilter="<Where><Eq><FieldRef Name='Category'/><Value Type='Choice'>"+_cur.CalendarRequest.Category+"<\/Value><\/Eq><\/Where>");query="<View><Query>"+categoryFilter+"<OrderBy><FieldRef Name='Id' Ascending='TRUE' /><\/OrderBy><\/Query><RowLimit>500<\/RowLimit><\/View>";camlQuery.set_viewXml(query);context.load(_cur.CalendarRequest.timeZone);_cur.CalendarRequest.listItems=list.getItems(camlQuery);context.load(_cur.CalendarRequest.listItems,"Include("+Akumina.AddIn.Configuration.getSelectFields("Calendar").join()+")");Akumina.AddIn.Logger.logSPCall("Calendar.prototype.getItems");context.executeQueryAsync(Function.createDelegate(_cur,_cur.Success),Function.createDelegate(_cur,_cur.Error))})};this.Success=function(){for(var listEnumerator=_cur.CalendarRequest.listItems.getEnumerator(),browserDate=new Date,browserOffSetMinutes=browserDate.getTimezoneOffset(),info=_cur.CalendarRequest.timeZone.get_information(),offset=(info.get_bias()+info.get_daylightBias())/60,result={},items=[],siteOffsetMinutes,browserSiteDifference,recurrenceItem;listEnumerator.moveNext();){var recurrenceItems=[],listItem=listEnumerator.get_current(),data={},itemId=0,title="",body="",url="",startDate="",endDate="",category="",location="",allDayEvent=!1,isRecurring=!1,recurrenceData="",duration=0;if(itemId=listItem.get_item("ID"),title=listItem.get_item("EventTitle"),body=listItem.get_item("Body"),url=listItem.get_item("FriendlyUrl"),startDate=listItem.get_item("EventDate"),endDate=listItem.get_item("EndDate"),category=listItem.get_item("Category"),location=listItem.get_item("Location"),allDayEvent=listItem.get_item("fAllDayEvent"),isRecurring=listItem.get_item("fRecurrence"),recurrenceData=listItem.get_item("RecurrenceData"),duration=listItem.get_item("Duration"),data.Id=itemId,data.Title=title,data.Url=url,data.Body=body,data.Location=location,data.Category=category,data.Date="",data.Time="",data.AllDay=allDayEvent,data.Duration=duration,data.StartDate=moment(startDate),data.EndDate=moment(endDate),siteOffsetMinutes=offset*60,data.AllDay||siteOffsetMinutes===browserOffSetMinutes||(browserSiteDifference=siteOffsetMinutes-browserOffSetMinutes,data.StartDate.subtract(browserSiteDifference,"minutes"),data.EndDate.subtract(browserSiteDifference,"minutes")),data.RecurrenceData=recurrenceData,isRecurring)for(recurrenceItems=Akumina.AddIn.Utilities.addRecurringEvents(data,_cur.CalendarRequest.StartDate.getMonth()+1,_cur.CalendarRequest.StartDate.getFullYear()),i=0;i<recurrenceItems.length;i++)recurrenceItem=recurrenceItems[i],recurrenceItem.BelongstoCurrentMonth=Akumina.AddIn.Utilities.isInMonth(recurrenceItem,_cur.CalendarRequest.StartDate.getMonth()+1,_cur.CalendarRequest.StartDate.getFullYear()),items.push(recurrenceItem);else data=Akumina.AddIn.Utilities.setDateValues(data,data.StartDate,data.EndDate),data.BelongstoCurrentMonth=Akumina.AddIn.Utilities.isInMonth(data,_cur.CalendarRequest.StartDate.getMonth()+1,_cur.CalendarRequest.StartDate.getFullYear()),items.push(data)}items.sort(function(a,b){return a.StartDate.diff(b.StartDate,"days")});result.Events=items;result.Month=_cur.CalendarRequest.StartDate.getMonth()+1;result.MonthFullName=_cur.GetMonthName(result.Month-1);result.MonthName=result.MonthFullName.substring(0,3);result.Year=_cur.CalendarRequest.StartDate.getFullYear();result.HasCategories=JSON.parse(_cur.CalendarRequest.ShowCategories.toString().toLowerCase());result.Categories=_cur.CombineCategories(_cur.CalendarRequest.distinctChoices,[]);result.Category=_cur.CalendarRequest.Category&&_cur.CalendarRequest.Category!=""?_cur.CalendarRequest.Category:"";result.SelectedCategory=result.Category;result.Title=_cur.CalendarRequest.Title;result.WebPartTitle=_cur.CalendarRequest.Title;result.WebPartIcon=Akumina.AddIn.Utilities.GetIcon(_cur.CalendarRequest.Icon);result.DisplayWebPartIcon=result.WebPartIcon=="0"||result.WebPartIcon.toLowerCase().trim()=="none"?!1:!0;result.ShowHeader=result.Title!==""||result.WebPartIcon!=="none";result.SenderId=_cur.CalendarRequest.SenderId;result.hosted=_cur.CalendarRequest.Hosted;result.StartDate=_cur.CalendarRequest.StartDate;_cur.CalendarRequest.EditMode||_cur.render(_cur.CalendarRequest.DisplayTemplateUrl,result)};this.ChoiceSuccess=function(){_cur.CalendarRequest.distinctChoices=_cur.choiceField.get_choices()};this.CombineCategories=function(listCategories,itemCategories){var i,itemCategory,existsInListCategories;if(itemCategories!=null)for(i=0;i<itemCategories.length;i++)itemCategory=itemCategories[i],existsInListCategories=$.inArray(itemCategory,listCategories)>-1,existsInListCategories||listCategories.push(itemCategory);return listCategories.sort(),listCategories};this.GetChoiceFields=function(listName){var ctx=new SP.ClientContext.get_current,web,site,list,field;JSON.parse(_cur.CalendarRequest.RootWeb)?(site=ctx.get_site(),web=site.get_rootWeb()):web=ctx.get_web();list=web.get_lists().getByTitle(listName);field=list.get_fields().getByInternalNameOrTitle("Category");_cur.choiceField=ctx.castTo(field,SP.FieldChoice);ctx.load(field);Akumina.AddIn.Logger.logSPCall("Calendar.prototype.getChoiceFields");ctx.executeQueryAsync(Function.createDelegate(_cur,_cur.ChoiceSuccess),function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message())})};this.GetMonthName=function(monthIndex){var monthNames=[];return monthNames[0]="January",monthNames[1]="February",monthNames[2]="March",monthNames[3]="April",monthNames[4]="May",monthNames[5]="June",monthNames[6]="July",monthNames[7]="August",monthNames[8]="September",monthNames[9]="October",monthNames[10]="November",monthNames[11]="December",monthNames[monthIndex]};this.GetCacheKey=function(attribute){var prefix="akumina:calendar:"+_spPageContextInfo.siteAbsoluteUrl+":";return attribute!=null&&(prefix+=attribute),prefix};this.GetCacheInterval=function(){return _cur.CalendarRequest.CacheInterval&&_cur.CalendarRequest.CacheInterval!=null&&!isNaN(_cur.CalendarRequest.CacheInterval)?parseInt(_cur.CalendarRequest.CacheInterval):Akumina.Digispace.ConfigurationContext.CachingStrategyInterval};this.Error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.render=function(templateUri,data){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){data.Html=html;_cur.RenderAlways(data)},function(errormsg){var data={sender:_cur.CalendarRequest.SenderId,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.CalendarRequest.SenderId).html(html)})})};this.RenderAlways=function(data){if(data.hosted)$("body").html(data.Html),AKSenderData.options={dataJSON:data},AKNotifyParent(data.SenderId);else{$("#"+data.SenderId).html(data.Html);var options={dataJSON:data},controlOptions={apppart:!1,UniqueId:data.SenderId,options:options},iaCalendar=new Akumina.AppParts.Calendar(controlOptions)}}});typeof Akumina.AddIn.FormWidget=="undefined"&&(Akumina.AddIn.FormWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.GetDefaultTemplateUrl=function(){return __getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/form/Default.html"};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.FormType=_cur.GetPropertyValue(requestIn,"formtype",""),requestOut.ChartField=_cur.GetPropertyValue(requestIn,"chartfield",""),requestOut.DisplayNonModal=_cur.GetPropertyValue(requestIn,"displaynonmodal","true"),requestOut.ItemId=_cur.GetPropertyValue(requestIn,"itemid",""),requestOut.Title=_cur.GetPropertyValue(requestIn,"title",""),requestOut.FormDescription=_cur.GetPropertyValue(requestIn,"formdescription",""),requestOut.PostBack=_cur.GetPropertyValue(requestIn,"postback",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",_cur.GetDefaultTemplateUrl()),requestOut.ReferenceList=_cur.GetPropertyValue(requestIn,"referencelist",""),requestOut.ColumnOrder=_cur.GetPropertyValue(requestIn,"columnorder",""),requestOut.SiteId=_cur.GetPropertyValue(requestIn,"siteid",""),requestOut.FormDefinition=_cur.GetPropertyValue(requestIn,"formdefinition",""),requestOut.ActionButtonText=_cur.GetPropertyValue(requestIn,"actionbuttontext",""),requestOut.ChartTitle=_cur.GetPropertyValue(requestIn,"charttitle",""),requestOut.ChartTitleSize=_cur.GetPropertyValue(requestIn,"charttitlesize","24"),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","formwidget"),requestOut};this.Init=function(FormRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.FormRequest=_cur.SetDefaultsProperties(FormRequest);_cur.FormRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=_cur.FormRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="FormWidget";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayNonModal","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"Hosted","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.FormRequest.SenderId&&(_cur.FormRequest=_cur.SetDefaultsProperties(newProps),_cur.FormRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.Render())};this.Render=function(){var instruction=new Akumina.AddIn.Instructions,data,templateUri;_cur.FormRequest.InstructionSet!=""?instruction.executeAsync(_cur,_cur.FormRequest.InstructionSet,"FormRequest").then(function(result){var context,web,parentContext,listName,siteId,list;if(this.appWebUrl=result.appWebUrl,this.hostUrl=result.hostUrl,this.FormRequest=result.FormRequest,context=new SP.ClientContext.get_current,_cur.FormRequest.Hosted?(parentContext=new SP.AppContextSite(context,_cur.hostUrl),web=parentContext.get_web()):web=context.get_web(),this.FormRequest.Context=context,listName=_cur.FormRequest.ReferenceList,siteId=_cur.FormRequest.SiteId,_cur.FormRequest.FormType.toLowerCase()=="survey")list=context.get_site().openWebById(siteId).get_lists().getByTitle(listName),_cur.FormRequest.listFields=list.get_fields(),context.load(_cur.FormRequest.listFields),Akumina.AddIn.Logger.logSPCall("Form.prototype.getItems"),context.executeQueryAsync(Function.createDelegate(_cur,_cur.LoadForm),Function.createDelegate(_cur,_cur.Error));else{var list=web.get_lists().getByTitle(listName),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<Query><OrderBy><FieldRef Name='Id' Ascending='TRUE' /><\/OrderBy><\/Query><RowLimit>500<\/RowLimit>");_cur.FormRequest.listItems=list.getItems(camlQuery);context.load(_cur.FormRequest.listItems);_cur.FormRequest.listFields=list.get_fields();context.load(_cur.FormRequest.listFields);Akumina.AddIn.Logger.logSPCall("Form.prototype.getItems");context.executeQueryAsync(Function.createDelegate(_cur,_cur.LoadChart),Function.createDelegate(_cur,_cur.Error))}}):(data={},data.SenderId=_cur.FormRequest.SenderId,templateUri=_cur.FormRequest.DisplayTemplateUrl,$.ajax(templateUri).done(function(template){var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data);$("#"+data.SenderId).html(data.Html)}))};this.PrepareChartObject=function(){for(var listEnumerator=_cur.FormRequest.listItems.getEnumerator(),items=[],options=[],mapfields=_cur.MapFields(),listItem,fields,fieldName,optionValue,itemsIncluded,dataChart,i,chart;listEnumerator.moveNext();)for(listItem=listEnumerator.get_current(),fields=_cur.FormRequest.ColumnOrder.split(","),i=0;i<fields.length;i++)fieldName=fields[i],fieldName==_cur.FormRequest.ChartField&&(optionValue=listItem.get_item(mapfields[fieldName]),items.push(optionValue),itemsIncluded=jQuery.grep(options,function(a){return a==optionValue}).length,itemsIncluded==0&&options.push(optionValue));for(dataChart={},dataChart.type="pie",dataChart.showInLegend=!0,dataChart.toolTipContent="{label} <br/> {y} %",dataChart.indexLabel="{y} %",dataChart.dataPoints=[],i=0;i<options.length;i++){var optionName=options[i],totalItems=jQuery.grep(items,function(a){return a==optionName}).length,item={};item.label=optionName;item.y=Math.round(100*totalItems/items.length);item.legendText=optionName;dataChart.dataPoints.push(item)}return chart={},chart.title={},chart.title.text=_cur.FormRequest.ChartTitle,chart.title.fontSize=_cur.FormRequest.ChartTitleSize,chart.axisY={},chart.axisY.title="",chart.legend={},chart.legend.verticalAlign="center",chart.legend.horizontalAlign="right",chart.data=[],chart.data.push(dataChart),chart};this.SchemaXml2Json=function(schemaXml){var jsonObject={},schemaXmlDoc=$.parseXML(schemaXml);return $(schemaXmlDoc).find("Field").each(function(){$.each(this.attributes,function(i,attr){jsonObject[attr.name]=attr.value})}),jsonObject};this.MapFields=function(){for(var mapFields={},fields=_cur.FormRequest.listFields.getEnumerator();fields.moveNext();){var fieldXml=fields.get_current().get_schemaXml(),objField=_cur.SchemaXml2Json(fieldXml),fieldName=objField.DisplayName;$.inArray(fieldName,_cur.FormRequest.ColumnOrder.split(","))>-1&&(mapFields[fieldName]=objField.StaticName)}return mapFields};this.GetFormId=function(){if(_cur.FormRequest.InstructionSet!=""){if(_cur.FormRequest.InstructionSet.split(".").length==2)return _cur.FormRequest.InstructionSet.split(".")[1];if(_cur.FormRequest.InstructionSet.split(".").length==3)return _cur.FormRequest.InstructionSet.split(".")[2]}else return""};this.LoadChart=function(){var result={},postmessage=_cur.FormRequest.PostBack,title=_cur.FormRequest.ReferenceList,chart=_cur.PrepareChartObject(me);result.Chart=chart;result.Title=title;result.WebPartTitle=title;result.SenderId=_cur.FormRequest.SenderId;result.hosted=_cur.FormRequest.Hosted;result.PostMessage=JSON.parse(postmessage);result.FormType=_cur.FormRequest.FormType;_cur.FormRequest.EditMode||_cur.BindTemplate(_cur.FormRequest.DisplayTemplateUrl,result,_cur.FormRequest.SenderId)};this.LoadForm=function(){var result={},idsFormDefinition=_cur.FormRequest.FormDefinition,formDefinition=decodeURIComponent(escape(window.atob(idsFormDefinition))),referenceList=_cur.FormRequest.ReferenceList,title=_cur.FormRequest.Title,description=_cur.FormRequest.FormDescription,postmessage=_cur.FormRequest.PostBack,formId=_cur.GetFormId();result.FormDefinition=formDefinition;result.FormID=formId;result.SiteId=_cur.FormRequest.SiteId;result.ReferenceList=referenceList;result.MapFields=_cur.MapFields();result.Title=_cur.FormRequest.Title;result.Description=description;result.FormRestrictions=_cur.FormRequest.FormRestrictions;result.PostMessage=JSON.parse(postmessage);result.ActionButtonText=_cur.FormRequest.ActionButtonText;result.WebPartTitle=title;result.SenderId=_cur.FormRequest.SenderId;result.hosted=_cur.FormRequest.Hosted;result.FormType=_cur.FormRequest.FormType;result.ChartField=_cur.FormRequest.ChartField==""&&_cur.FormRequest.ColumnOrder.split(",").length==1?result.MapFields[_cur.FormRequest.ColumnOrder]:_cur.FormRequest.ChartField;result.InstructionSet=_cur.FormRequest.InstructionSet;result.ListItemId=_cur.FormRequest.ItemId;result.DisplayNonModal=JSON.parse(_cur.FormRequest.DisplayNonModal.toString().toLowerCase());_cur.FormRequest.EditMode||_cur.BindTemplate(_cur.FormRequest.DisplayTemplateUrl,result,_cur.FormRequest.SenderId)};this.Error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.BindTemplate=function(templateUri,data,targetDiv){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){var options,newSenderId,newFormDiv,controlOptions,iaForm;data.hosted?($("body").html(data.Html),AKSenderData.options={dataJSON:data},AKNotifyParent(targetDiv)):(options={dataJSON:data},newSenderId=targetDiv,newSenderId==""&&(newSenderId="formModal",$("#"+newSenderId).length==0&&(newFormDiv=$("<div id='formModal'><\/div>"),$("body").append(newFormDiv))),$("#"+newSenderId).html(html),controlOptions={apppart:!1,UniqueId:newSenderId,options:options},iaForm=new Akumina.AppParts.Form(controlOptions))},function(errormsg){var data={sender:_cur.FormRequest.SenderId,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.FormRequest.SenderId).html(html)})})}});typeof Akumina.AddIn.BannerWidget=="undefined"&&(Akumina.AddIn.BannerWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id","");requestOut.ResultSourceId=decodeURI(_cur.GetPropertyValue(requestIn,"resultsourceid","Banner_AK"));requestOut.InfiniteLoop=_cur.GetPropertyValue(requestIn,"infiniteloop",!0);requestOut.AutoPlay=_cur.GetPropertyValue(requestIn,"autoplay",!0);requestOut.ShowNavigator=_cur.GetPropertyValue(requestIn,"shownavigator",!0);requestOut.TransitionEffect=_cur.GetPropertyValue(requestIn,"transitioneffect",Akumina.AddIn.TransitionEffect[Akumina.AddIn.TransitionEffect.Fade]);requestOut.TransitionEffect.toString()==="horizontal"&&(requestOut.TransitionEffect=Akumina.AddIn.TransitionEffect[Akumina.AddIn.TransitionEffect.Horizontal]);requestOut.SlideDuration=_cur.GetPropertyValue(requestIn,"slideduration",3e3);requestOut.TextColorTheme=_cur.GetPropertyValue(requestIn,"textcolor",Akumina.AddIn.ColorTheme[Akumina.AddIn.ColorTheme.White]);switch(requestOut.TextColorTheme.toString().toLowerCase()){case"b":case"black":requestOut.TextColorTheme=Akumina.AddIn.ColorTheme[Akumina.AddIn.ColorTheme.Black];break;case"g":case"gray":requestOut.TextColorTheme=Akumina.AddIn.ColorTheme[Akumina.AddIn.ColorTheme.Gray]}requestOut.TextLocation=_cur.GetPropertyValue(requestIn,"textlocation",Akumina.AddIn.Location[Akumina.AddIn.Location.top_left]);switch(requestOut.TextLocation.toString().toLowerCase()){case"tc":case"top_center":requestOut.TextLocation=Akumina.AddIn.Location[Akumina.AddIn.Location.top_center];break;case"tr":case"top_right":requestOut.TextLocation=Akumina.AddIn.Location[Akumina.AddIn.Location.top_right];break;case"tl":case"top_left":requestOut.TextLocation=Akumina.AddIn.Location[Akumina.AddIn.Location.top_left];break;case"ml":case"middle_left":requestOut.TextLocation=Akumina.AddIn.Location[Akumina.AddIn.Location.middle_left];break;case"mc":case"middle_center":requestOut.TextLocation=Akumina.AddIn.Location[Akumina.AddIn.Location.middle_center];break;case"mr":case"middle_right":requestOut.TextLocation=Akumina.AddIn.Location[Akumina.AddIn.Location.middle_right];break;case"bl":case"bottom_left":requestOut.TextLocation=Akumina.AddIn.Location[Akumina.AddIn.Location.bottom_left];break;case"bc":case"bottom_center":requestOut.TextLocation=Akumina.AddIn.Location[Akumina.AddIn.Location.bottom_center];break;case"br":case"bottom_right":requestOut.TextLocation=Akumina.AddIn.Location[Akumina.AddIn.Location.bottom_right]}requestOut.TextAlignment=_cur.GetPropertyValue(requestIn,"textalignment",Akumina.AddIn.Alignment[Akumina.AddIn.Alignment.left]);switch(requestOut.TextAlignment.toString().toLowerCase()){case"r":case"right":requestOut.TextAlignment=Akumina.AddIn.Alignment[Akumina.AddIn.Alignment.right];break;case"c":case"center":requestOut.TextAlignment=Akumina.AddIn.Alignment[Akumina.AddIn.Alignment.center]}return requestOut.H1MaxCharacters=_cur.GetPropertyValue(requestIn,"h1maxcharacters",80),requestOut.H2MaxCharacters=_cur.GetPropertyValue(requestIn,"h2maxcharacters",80),requestOut.ButtonMaxCharacters=_cur.GetPropertyValue(requestIn,"buttonmaxcharacters",80),requestOut.WebPartTheme=_cur.GetPropertyValue(requestIn,"webparttheme",""),requestOut.LinkButtonTheme=_cur.GetPropertyValue(requestIn,"linkbuttontheme",""),requestOut.LinkButtonTextTheme=_cur.GetPropertyValue(requestIn,"linkbuttontexttheme",""),requestOut.DisplayTemplateUrl=_spPageContextInfo.siteServerRelativeUrl=="/"?_cur.GetPropertyValue(requestIn,"displaytemplateurl","/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/Banner/Default.html"):_cur.GetPropertyValue(requestIn,"displaytemplateurl",_spPageContextInfo.siteServerRelativeUrl+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/Banner/Default.html"),requestOut.IsPreview=_cur.GetPropertyValue(requestIn,"preview",!1),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.Hosted=_cur.GetPropertyValue(requestIn,"hosted",!1),requestOut.WidgetName=_cur.GetPropertyValue(requestIn,"widgetname","banner"),requestOut};this.Init=function(bannerRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.bannerRequest=_cur.SetDefaultsProperties(bannerRequest);_cur.bannerRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){var targetDiv=_cur.bannerRequest.SenderId;$("#"+targetDiv).html(Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render);Akumina.Digispace.AppPart.Eventing.Subscribe("/widget/updated/",_cur.RefreshWidget)};this.RegisterPropertyViews=function(){var widgetName="Banner";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"InfiniteLoop","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"AutoPlay","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"ShowNavigator","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"IsPreview","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"Hosted","CheckboxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.RefreshWidget=function(newProps){newProps.id==_cur.bannerRequest.SenderId&&(_cur.bannerRequest=_cur.SetDefaultsProperties(newProps),_cur.bannerRequest.EditMode=Akumina.AddIn.Utilities.getEditMode(),_cur.Render())};this.Render=function(){var result=Akumina.AddIn.Cache.Get(_cur.GetCacheKey(_cur.bannerRequest.SenderId)),instruction;if(result!=null){_cur.render(_cur.bannerRequest.DisplayTemplateUrl,result);return}instruction=new Akumina.AddIn.Instructions;instruction.executeAsync(_cur,_cur.bannerRequest.InstructionSet,"bannerRequest").then(function(result){var context,web,parentContext;_cur.appWebUrl=result.appWebUrl;_cur.hostUrl=result.hostUrl;_cur.bannerRequest=result.bannerRequest;context=new SP.ClientContext.get_current;_cur.bannerRequest.Hosted?(parentContext=new SP.AppContextSite(context,_cur.hostUrl),web=parentContext.get_web()):web=context.get_web();_cur.sortAscending=!0;_cur.rowLimit=500;var list=web.get_lists().getByTitle(_cur.bannerRequest.ResultSourceId),camlQuery=new SP.CamlQuery,order=_cur.sortAscending?"TRUE":"FALSE",query="<View><Query><OrderBy><FieldRef Name='BannerItemOrder' Ascending='"+order+"' /><\/OrderBy><\/Query><RowLimit>"+_cur.rowLimit+"<\/RowLimit><\/View>";camlQuery.set_viewXml(query);_cur.bannerRequest.listItems=list.getItems(camlQuery);context.load(_cur.bannerRequest.listItems,"Include("+Akumina.AddIn.Configuration.getSelectFields("Banner").join()+")");Akumina.AddIn.Logger.logSPCall("Banner.prototype.getItems");context.executeQueryAsync(Function.createDelegate(_cur,_cur.Success),Function.createDelegate(_cur,_cur.Error))})};this.GetParam=function(key,val){var utils=Akumina.AddIn.Utilities,ret=utils.getQueryStringParameter(key,val);return utils.IsNullOrEmpty(ret)&&!utils.IsNullOrEmpty(val)?val:ret};this.Success=function(){for(var listEnumerator=_cur.bannerRequest.listItems.getEnumerator(),result={},items=[],utils=Akumina.AddIn.Utilities,expires;listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),data={},bannerActive=listItem.get_item("BannerActive");(utils.IsNullOrEmpty(bannerActive)||bannerActive.toString().toLocaleLowerCase()!=="false")&&(data.BannerHeadingOWSTEXT=utils.substring(listItem.get_item("BannerHeading"),_cur.bannerRequest.H1MaxCharacters),data.BannerImageAltTextOWSTEXT=listItem.get_item("BannerImageAltText"),data.BannerImageOWSURLH=listItem.get_item("BannerImage").get_url(),data.BannerItemOrderOWSNMBR=listItem.get_item("BannerItemOrder"),data.BannerLinkHoverTextOWSTEXT=listItem.get_item("BannerLinkHoverText"),data.BannerLinkTargetOWSCHCS=listItem.get_item("BannerLinkTarget")!=null&&listItem.get_item("BannerLinkTarget").startsWith("Same")?"_self":listItem.get_item("BannerLinkTarget"),data.BannerLinkTextOWSTEXT=utils.substring(listItem.get_item("BannerLinkText"),_cur.bannerRequest.ButtonMaxCharacters),data.BannerSubHeadingOWSTEXT=utils.substring(listItem.get_item("BannerSubHeading"),_cur.bannerRequest.H2MaxCharacters),data.BannerLinkUrlOWSURLH=listItem.get_item("BannerLinkUrl")!=null?listItem.get_item("BannerLinkUrl").get_url():"",data.TextAlignment="ia-text-"+_cur.bannerRequest.TextAlignment,data.TextColorTheme="ia-text-"+_cur.bannerRequest.TextColorTheme.toString().toLowerCase(),data.TextLocation="ia-"+_cur.bannerRequest.TextLocation.toString().replace("_","-"),data.LinkButtonTextTheme=_cur.bannerRequest.LinkButtonTextTheme,data.LinkButtonTheme=_cur.bannerRequest.LinkButtonTheme,expires=listItem.get_item("Expires"),utils.ItemExpired(expires)||items.push(data))}result.Items=items;result.SlideDuration=_cur.bannerRequest.SlideDuration;result.AutoPlay=_cur.bannerRequest.AutoPlay.toString().toLowerCase()==="false"?!1:!0;result.InfiniteLoop=_cur.bannerRequest.InfiniteLoop.toString().toLowerCase()==="false"?!1:!0;result.ShowNavigator=_cur.bannerRequest.ShowNavigator.toString().toLowerCase()==="false"?!1:!0;result.TransitionEffect=_cur.bannerRequest.TransitionEffect;result.WebPartTheme=_cur.bannerRequest.WebPartTheme;result.SenderId=_cur.bannerRequest.SenderId;result.hosted=_cur.bannerRequest.Hosted;_cur.bannerRequest.EditMode||(Akumina.AddIn.Cache.Set(_cur.GetCacheKey(_cur.bannerRequest.SenderId),result,_cur.GetCacheInterval()),_cur.render(_cur.bannerRequest.DisplayTemplateUrl,result))};this.Error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.GetCacheInterval=function(){return _cur.bannerRequest.CacheInterval&&_cur.bannerRequest.CacheInterval!=null&&!isNaN(_cur.bannerRequest.CacheInterval)?parseInt(_cur.bannerRequest.CacheInterval):Akumina.Digispace.ConfigurationContext.CachingStrategyInterval};this.GetCacheKey=function(){return Akumina.Digispace.ConfigurationContext.getCacheKey(_cur.bannerRequest.SenderId)};this.render=function(templateUri,data){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){data.Html=html;_cur.BindData(data)},function(errormsg){var data={sender:_cur.bannerRequest.SenderId,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.bannerRequest.SenderId).html(html)})})};this.BindData=function(data){if(data.hosted)$("body").html(data.Html),AKNotifyParent(data.SenderId);else{$("#"+data.SenderId).html(data.Html);var options={autoplay:data.AutoPlay,infiniteloop:data.InfiniteLoop,shownavigator:data.ShowNavigator,slideduration:data.SlideDuration,transitioneffect:data.TransitionEffect,webparttheme:data.WebPartTheme,html:data.Html},bannerOptions={apppart:!1,UniqueId:data.SenderId,options:options},iaBanner=new Akumina.AppParts.Banner(bannerOptions)}}});typeof Akumina.AddIn.PeopleListSearchWidget=="undefined"&&(Akumina.AddIn.PeopleListSearchWidget=function(){var _cur=this;_cur.filter={filters:[]};_cur.viewModel={};this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.id=_cur.GetPropertyValue(requestIn,"id",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.PracticeArea=_cur.GetPropertyValue(requestIn,"practicearea",""),requestOut};this.Init=function(peopleListSearchRequest){_cur.PeopleListSearchRequest=_cur.SetDefaultsProperties(peopleListSearchRequest);_cur.PeopleListSearchRequest.SubscriptionId=Akumina.Digispace.ConfigurationContext.GraphSubscriptionId?Akumina.Digispace.ConfigurationContext.GraphSubscriptionId:"";_cur.PeopleListSearchRequest.ClientId=Akumina.Digispace.ConfigurationContext.GraphClientId?Akumina.Digispace.ConfigurationContext.GraphClientId:"";_cur.PeopleListSearchRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.InterchangeDataFetcher=new Akumina.Digispace.Data.InterchangeAPI;_cur.RegisterPropertyViews();_cur.Prerender();Akumina.Digispace.AppPart.Eventing.Subscribe("/peoplelistsearch/error/",_cur.OnError)};this.Prerender=function(){$("#"+_cur.PeopleListSearchRequest.id).html("Loading...");Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render)};this.RegisterPropertyViews=function(){var widgetName="PeopleListSearchWidget";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.Render=function(){if(!_cur.PeopleListSearchRequest.EditMode)_cur.InterchangeDataFetcher.GetFacets([{facetName:"department",facetDisplayName:"Department"}]).then(function(data){var model={},departmentObj,i;for(model.Departments=[],model.Groups=[],departmentObj=$.grep(data.RefinementFilters,function(n){return n.FilterName=="department"})[0],i=0;i<departmentObj.FilterOptions.length;i++){var item=departmentObj.FilterOptions[i].value.split(","),group=item[0]?item[0].trim():"",department=item[1]?item[1].trim():"";group&&group!=null&&group!=""&&model.Groups.push(group);department&&department!=null&&department!=""&&model.Departments.push(department)}_cur.render(_cur.PeopleListSearchRequest.DisplayTemplateUrl,model)})};this.GetFilters=function(){return _cur.filter.filters=[],_cur.SetFirstNameFilter(),_cur.SetLastNameFilter(),_cur.SetPracticeAreaFilter(),_cur.SetGroupFilter(),_cur.filter};this.SetFirstNameFilter=function(){if(_cur.viewModel.firstName=$("#firstName").val(),_cur.viewModel.firstName&&_cur.viewModel.firstName!=null&&_cur.viewModel.firstName!=""){var filter={property:"givenName",values:[],operator:"starts-with"};filter.values.push(_cur.viewModel.firstName);_cur.filter.filters.push(filter)}};this.SetLastNameFilter=function(){if(_cur.viewModel.lastName=$("#lastName").val(),_cur.viewModel.lastName&&_cur.viewModel.lastName!=null&&_cur.viewModel.lastName!=""){var filter={property:"surname",values:[],operator:"starts-with"};filter.values.push(_cur.viewModel.lastName);_cur.filter.filters.push(filter)}};this.SetGroupFilter=function(){if(_cur.viewModel.group&&_cur.viewModel.group!=null){var filter={property:"department",values:[],operator:"starts-with"};filter.values.push(_cur.viewModel.group);_cur.filter.filters.push(filter)}};this.GetSortOptions=function(){var sortOptions={SortField:"givenName",SortAsc:!0};return _cur.viewModel.sortField&&_cur.viewModel.sortField!=null&&(sortOptions.SortField=_cur.viewModel.sortField,sortOptions.SortAsc=_cur.viewModel.sortAsc),sortOptions};this.SetPracticeAreaFilter=function(){if(_cur.viewModel.practiceArea&&_cur.viewModel.practiceArea!=null){var filter={property:"department",values:[],operator:"contains"};filter.values.push(_cur.viewModel.practiceArea);_cur.filter.filters.push(filter)}};this.BindEvents=function(){$(".ia-practicearea-dropdown").unbind().change(function(){_cur.viewModel.practiceArea=this.value});$(".ia-sort-dropdown").unbind().change(function(){_cur.viewModel.sortField=$(this).find(":selected").data("sortfield");_cur.viewModel.sortAsc=JSON.parse($(this).find(":selected").data("sortasc"))});$(".ia-group-dropdown").unbind().change(function(){_cur.viewModel.group=this.value});$("#searchPeople").unbind().click(function(){_cur.Search()})};this.PostRender=function(){_cur.BindEvents()};this.Search=function(){var filters=_cur.GetFilters(),sortOptions=_cur.GetSortOptions(),model={caller:"search",filters:filters,sortOptions:sortOptions};Akumina.Digispace.AppPart.Eventing.Publish("/peoplelistsearch/searchclick/",model)};this.render=function(templateUri,data){$.ajax(templateUri).done(function(template){var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){$("#"+_cur.PeopleListSearchRequest.id).html(data.Html);_cur.PostRender()})};this.OnError=function(){$("#"+_cur.PeopleListSearchRequest.id).html("An error occurred.")}});typeof Akumina.AddIn.PeopleListWidget=="undefined"&&(Akumina.AddIn.PeopleListWidget=function(){var _cur=this;_cur.peopleModel={People:[],HasItems:!1};_cur.filter={filters:[]};_cur.viewModel={};this.PagingManager={pageNumber:1,pageSize:10,scrollReady:!0,searchResults:[],isLastPage:!0,Reset:function(element){this.pageNumber=1;element.scrollTop(0);this.scrollReady=!0},NextPage:function(){return this.isLastPage?!1:(this.pageNumber=this.pageNumber+1,!0)}};this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.id=_cur.GetPropertyValue(requestIn,"id",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.PracticeArea=_cur.GetPropertyValue(requestIn,"practicearea",""),requestOut.SortField=_cur.GetPropertyValue(requestIn,"sortfield","givenName"),requestOut.SortAsc=_cur.GetPropertyValue(requestIn,"sortasc","true"),requestOut.FetchPhotoFromAD=_cur.GetPropertyValue(requestIn,"fetchphotofromad",null),requestOut};this.Init=function(practiceAreaPeopleRequest){_cur.PracticeAreaPeopleRequest=_cur.SetDefaultsProperties(practiceAreaPeopleRequest);_cur.PracticeAreaPeopleRequest.SubscriptionId=Akumina.Digispace.ConfigurationContext.GraphSubscriptionId?Akumina.Digispace.ConfigurationContext.GraphSubscriptionId:"";_cur.PracticeAreaPeopleRequest.ClientId=Akumina.Digispace.ConfigurationContext.GraphClientId?Akumina.Digispace.ConfigurationContext.GraphClientId:"";_cur.PracticeAreaPeopleRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.sortOptions={SortField:_cur.PracticeAreaPeopleRequest.SortField,SortAsc:JSON.parse(_cur.PracticeAreaPeopleRequest.SortAsc)};_cur.InterchangeDataFetcher=new Akumina.Digispace.Data.InterchangeAPI;_cur.GraphDataFetcher=new Akumina.Digispace.Data.GraphAPI;_cur.RegisterPropertyViews();_cur.Prerender();Akumina.Digispace.AppPart.Eventing.Subscribe("/practiceareapeople/search/",_cur.Search);Akumina.Digispace.AppPart.Eventing.Subscribe("/peoplelistsearch/searchclick/",_cur.OnSearchClick);Akumina.Digispace.AppPart.Eventing.Subscribe("/practiceareapeople/searchcompleted/",_cur.OnSearchCompleted);Akumina.Digispace.AppPart.Eventing.Subscribe("/practiceareapeople/error/",_cur.OnError)};this.Prerender=function(){$("#"+_cur.PracticeAreaPeopleRequest.id).html("Loading...");Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render)};this.RegisterPropertyViews=function(){var widgetName="PeopleListWidget";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"FetchPhotoFromAD","CheckBoxView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.Render=function(){_cur.GetUsers()};this.GetUsers=function(){_cur.PracticeAreaPeopleRequest.EditMode||(_cur.ShowLoading(),_cur.SetFilter(),_cur.sortOptions=_cur.GetSortOptions(),_cur.userName=_spPageContextInfo.userLoginName,_cur.InterchangeDataFetcher.GetUsersData(_cur.userName,_cur.filter,_cur.PagingManager.pageSize,_cur.PagingManager.pageNumber,_cur.sortOptions.SortField,_cur.sortOptions.SortAsc).then(function(response){_cur.PagingManager.isLastPage=response.IsLastPage;_cur.PagingManager.pageNumber=response.CurrentPage;_cur.allUsers=response.Users;var resultsModel={searchResults:_cur.allUsers,caller:null};Akumina.Digispace.AppPart.Eventing.Publish("/practiceareapeople/searchcompleted/",resultsModel)},function(error){Akumina.Digispace.AppPart.Eventing.Publish("/practiceareapeople/error/",error)}))};this.SetFilter=function(){_cur.SetPracticeAreaFilter()};this.SetPracticeAreaFilter=function(){if(_cur.PracticeAreaPeopleRequest.PracticeArea&&_cur.PracticeAreaPeopleRequest.PracticeArea!=null&&_cur.PracticeAreaPeopleRequest.PracticeArea!=""){var filter={property:"department",values:[],operator:"contains"};filter.values.push(_cur.PracticeAreaPeopleRequest.PracticeArea);_cur.filter.filters.push(filter)}};this.GetSortOptions=function(){return _cur.sortOptions};this.OnSearchCompleted=function(searchContext){_cur.PagingManager.isLastPage&&$(".showMoreResults").hide();var currentPagePeopleModel=_cur.GetResultAsModel(searchContext.searchResults,_cur.peopleModel.People.length);_cur.AddPageResults(currentPagePeopleModel.People);_cur.peopleModel.HasItems=_cur.peopleModel.People.length>0;_cur.render(_cur.PracticeAreaPeopleRequest.DisplayTemplateUrl,_cur.peopleModel,searchContext.caller,currentPagePeopleModel)};this.OnSearchClick=function(model){Akumina.Digispace.AppPart.Eventing.Publish("/practiceareapeople/search/",model)};this.Search=function(model){_cur.ShowLoading();_cur.filter=model.filters;_cur.sortOptions=model.sortOptions;switch(model.caller){case"nextpage":break;default:_cur.peopleModel.People=[];_cur.PagingManager.Reset($("#"+_cur.PracticeAreaPeopleRequest.id))}_cur.InterchangeDataFetcher.GetUsersData(_cur.userName,_cur.filter,_cur.PagingManager.pageSize,_cur.PagingManager.pageNumber,_cur.sortOptions.SortField,_cur.sortOptions.SortAsc).then(function(response){_cur.PagingManager.isLastPage=response.IsLastPage;_cur.PagingManager.pageNumber=response.CurrentPage;var resultsModel={searchResults:response.Users,caller:model.caller};Akumina.Digispace.AppPart.Eventing.Publish("/practiceareapeople/searchcompleted/",resultsModel)})};this.GetResultAsModel=function(results,peopleModelIndex){var picURL,peopleModel,itemResults;for(Akumina.AddIn.Logger.WriteInfoLog("PeopleDirectory.getResultAsModel"),picURL="",peopleModel={People:[]},i=0;i<results.length;i++)picURL=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/images/anonymous-user.png",itemResults=results[i],itemResults.Properties.Id=i+peopleModelIndex,itemResults.Properties.pictureurl=picURL,itemResults.Properties.websiteurl=_spPageContextInfo.siteServerRelativeUrl,peopleModel.People.push(itemResults.Properties);return peopleModel};this.GetSubSiteUrl=function(title){var url="#";switch(title.toLowerCase()){case"creative & digital solutions":url=_spPageContextInfo.siteServerRelativeUrl+"/pa-cdsnew/"}return url};this.AddPageResults=function(pagedSearchResults){_cur.peopleModel.People.push.apply(_cur.peopleModel.People,pagedSearchResults)};this.render=function(templateUri,data,caller,currentPagePeopleModel){caller=="practiceareachanged"||caller=="nextpage"?((new Akumina.Digispace.AppPart.Data).Templates.BindTemplateAndCallback(_cur.viewModel.resultsSection.html(),".template-practice-team",data),_cur.PostRender(currentPagePeopleModel),caller!="nextpage"?$("#s4-workspace").scrollTop(0):$("#s4-workspace").scrollTop(_cur.viewModel.scrollPosition)):$.ajax(templateUri).done(function(template){_cur.viewModel.resultsSection=$(template);var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){$("#"+_cur.PracticeAreaPeopleRequest.id).html(data.Html);_cur.PostRender(currentPagePeopleModel)})};this.PostRender=function(currentPagePeopleModel){_cur.BindEvents();_cur.HideLoading();_cur.PagingManager.isLastPage&&$(".showMoreResults").hide();_cur.GetProfilePictures(currentPagePeopleModel.People)};this.GetProfilePictures=function(){$(".team-list span img").each(function(){var me=this,profileUserName=$(me).attr("data-user");_cur.GraphDataFetcher.GetProfilePicture(profileUserName,_spPageContextInfo.userLoginName,_cur.PracticeAreaPeopleRequest.FetchPhotoFromAD).then(function(profilePic){$(me).attr("src",profilePic)},function(){Akumina.AddIn.Logger.WriteErrorLog("GetProfilePicture failed for "+profileUserName)})})};this.BindEvents=function(){$(".showMoreResults a").unbind().click(function(){_cur.viewModel.scrollPosition=$("#s4-workspace").scrollTop();_cur.ShowNextPage()})};this.ShowNextPage=function(){if(_cur.PagingManager.NextPage()){var model={caller:"nextpage",filters:_cur.filter,sortOptions:_cur.sortOptions};Akumina.Digispace.AppPart.Eventing.Publish("/practiceareapeople/search/",model)}};this.ShowLoading=function(){$(".ia-loading-panel").length==0?$("#"+_cur.PracticeAreaPeopleRequest.id).html('<div class="interAction"><h1 id="loadingMessage">Fetching users...<\/h1><div class="ia-loading-panel ia-show"><div class="ia-loader"><\/div><\/div><\/div>'):($(".ia-loading-panel").removeClass("ia-hide"),$(".ia-loading-panel").addClass("ia-show"))};this.HideLoading=function(){$(".ia-loading-panel").removeClass("ia-show");$(".ia-loading-panel").addClass("ia-hide")};this.OnError=function(){$("#"+_cur.PracticeAreaPeopleRequest.id).html("An error occurred.")}});typeof Akumina.AddIn.EmployeeDetailWidget=="undefined"&&(Akumina.AddIn.EmployeeDetailWidget=function(){var _cur=this;_cur.filter={filters:[]};this.graphConfig={subscriptionId:Akumina.Digispace.ConfigurationContext.GraphSubscriptionId,clientId:Akumina.Digispace.ConfigurationContext.GraphClientId,postLogoutRedirectUri:window.location.origin,endpoints:{graphApiUri:"https://graph.microsoft.com"},cacheLocation:"localStorage"};this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.id=_cur.GetPropertyValue(requestIn,"id",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.CacheInterval=_cur.GetPropertyValue(requestIn,"cacheinterval","0"),requestOut};this.Init=function(employeeDetailRequest){_cur.EmployeeDetailRequest=_cur.SetDefaultsProperties(employeeDetailRequest);_cur.EmployeeDetailRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.InterchangeDataFetcher=new Akumina.Digispace.Data.InterchangeAPI;_cur.GraphDataFetcher=new Akumina.Digispace.Data.GraphAPI;_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){$("#"+_cur.EmployeeDetailRequest.id).html("Loading...");Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render)};this.RegisterPropertyViews=function(){var widgetName="EmployeeDetailWidget";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.Render=function(){if(!_cur.EmployeeDetailRequest.EditMode)if(_cur.email=Akumina.AddIn.Utilities.getQueryStringParameter("email"),_cur.email&&_cur.email!=""){var filter={property:"userprincipalname",values:[_cur.email.toLowerCase()],operator:"equals"};_cur.filter.filters.push(filter);_cur.userName=_spPageContextInfo.userLoginName;_cur.InterchangeDataFetcher.GetUsersData(_cur.userName,_cur.filter,1,1,"givenName",!0).then(function(response){var data=_cur.GetResultAsModel(response.Users);_cur.BindTemplate(_cur.EmployeeDetailRequest.DisplayTemplateUrl,data)},function(){Akumina.AddIn.Logger.WriteErrorLog("Error Getting user info.");_cur.Error("Error Getting user info.")})}else _cur.Error("Error fetching employee details.")};this.GetResultAsModel=function(results){var picURL="",userModel={},itemResults,item;for(i=0;i<results.length;i++)picURL=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/images/anonymous-user.png",itemResults=results[i],item=itemResults.Properties.department!=null?itemResults.Properties.department.split(","):"",itemResults.Properties.practicearea=item[1]?item[1].trim():"",itemResults.Properties.pictureurl=picURL,userModel=itemResults.Properties;return userModel};this.BindTemplate=function(templateUri,data){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,data).then(function(html){$("#"+_cur.EmployeeDetailRequest.id).html(html);_cur.PostRender()},function(errormsg){var data={sender:_cur.EmployeeDetailRequest.id,message:errormsg};(new Akumina.Digispace.AppPart.Data).Templates.GetErrorTemplate(data).then(function(html){$("#"+_cur.EmployeeDetailRequest.id).html(html)})})};this.Error=function(message){$("#"+_cur.EmployeeDetailRequest.id).html(message)};this.PostRender=function(){_cur.GraphDataFetcher.GetProfilePicture(_cur.email,_spPageContextInfo.userLoginName,!0).then(function(profilePic){$("#ed-photo").attr("src",profilePic)},function(){Akumina.AddIn.Logger.WriteErrorLog("GetProfilePicture failed for "+_cur.email)})}});typeof Akumina.AddIn.DocumentFilterWidget=="undefined"&&(Akumina.AddIn.DocumentFilterWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.id=_cur.GetPropertyValue(requestIn,"id",""),requestOut.DisplayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.ListName=_cur.GetPropertyValue(requestIn,"listname",""),requestOut.TaxonomyColumnName=_cur.GetPropertyValue(requestIn,"taxonomycolumnname",""),requestOut};this.Init=function(documentFilterRequest){_cur.DocumentFilterRequest=_cur.SetDefaultsProperties(documentFilterRequest);_cur.DocumentFilterRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.RegisterPropertyViews();_cur.Prerender()};this.Prerender=function(){$("#"+_cur.DocumentFilterRequest.id).html("Loading...");Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.Render)};this.RegisterPropertyViews=function(){var widgetName="DocumentFilterWidget";Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"DisplayTemplateUrl","TemplatePicker");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"id","LabelView");Akumina.Digispace.WidgetPropertyViews.AddViewForProperty(widgetName,"widgetname","LabelView")};this.Render=function(){if(!_cur.DocumentFilterRequest.EditMode){var clientContext=new SP.ClientContext.get_current,oList=clientContext.get_web().get_lists().getByTitle(_cur.DocumentFilterRequest.ListName);clientContext.load(oList);clientContext.executeQueryAsync(Function.createDelegate(_cur,function(){_cur.Success(oList.get_id(),_cur.DocumentFilterRequest.ListName)}),Function.createDelegate(_cur,_cur.error))}};this.Success=function(listId,listName){var data={HasTopics:!1,Topics:[]};_cur.meta=new Akumina.AppPart.DMS.MetaData;_cur.meta.Init(listId,listName);_cur.meta.deferred.done(function(){var taxFields=_cur.meta.GetTaxonomyFields(!1),i,columnName,termsetId;if(taxFields.length>0)for(i=0;i<taxFields.length;i++)columnName=taxFields[i].fieldTitle,columnName.toLowerCase()==_cur.DocumentFilterRequest.TaxonomyColumnName.toLowerCase()&&(termsetId=taxFields[i].field.get_termSetId().toString(),_cur.GetTerms(termsetId).done(function(terms){terms.length>0&&(data.HasTopics=!0);data.Topics=terms;_cur.BindTemplate(_cur.DocumentFilterRequest.DisplayTemplateUrl,data)}));else _cur.BindTemplate(_cur.DocumentFilterRequest.DisplayTemplateUrl,data)})};this.Error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.PostRender=function(){_cur.BindEvents()};this.GetTerms=function(termSetId){var def=$.Deferred(),context=SP.ClientContext.get_current(),taxSession=SP.Taxonomy.TaxonomySession.getTaxonomySession(context),termStores=taxSession.get_termStores(),termStore=taxSession.getDefaultSiteCollectionTermStore(),termSet=termStore.getTermSet(termSetId),terms=termSet.getAllTerms();return context.load(terms),context.executeQueryAsync(function(){for(var termsList=[],termEnumerator=terms.getEnumerator(),currentTerm;termEnumerator.moveNext();)currentTerm=termEnumerator.get_current(),termsList.push(currentTerm.get_name());def.resolve(termsList)},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace());def.resolve([])}),def};this.BindTemplate=function(templateUri,data){$.ajax(templateUri).done(function(template){var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){$("#"+_cur.DocumentFilterRequest.id).html(data.Html);_cur.PostRender()})};this.GetViewXML=function(){var searchText=$("#searchText").val(),topic=$("#filterByTopic option:selected").val(),sortAsc=$("#sortMethod option:selected").val().toLowerCase()=="asc"?!0:!1,viewxml="<Query>",whereQuery;return viewxml+="<OrderBy><FieldRef Name='Created' Ascending='"+sortAsc+"'/><\/OrderBy>",whereQuery="",searchText!=""&&topic!=""&&(whereQuery+="<And>"),searchText!=""&&(whereQuery+="<Contains><FieldRef Name='FileLeafRef'/><Value Type='Text'>"+searchText+"<\/Value><\/Contains>"),topic!=""&&(whereQuery+="<Eq><FieldRef Name='"+_cur.DocumentFilterRequest.TaxonomyColumnName+"'/><Value Type='Text'>"+topic+"<\/Value><\/Eq>"),searchText!=""&&topic!=""&&(whereQuery+="<\/And>"),whereQuery!=""&&(viewxml+="<Where>"+whereQuery+"<\/Where>"),viewxml+"<\/Query>"};this.BindEvents=function(){$("#searchDocument").unbind().click(function(e){e.preventDefault();var viewxml=_cur.GetViewXML(),model={viewxml:viewxml,caller:"search"};Akumina.Digispace.AppPart.Eventing.Publish("/documentlist/search",model)})}});typeof Akumina.AddIn.DocumentListWidget=="undefined"&&(Akumina.AddIn.DocumentListWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.rootWeb=_cur.GetPropertyValue(requestIn,"isroot","true"),requestOut.selectFields=_cur.GetPropertyValue(requestIn,"selectfields",""),requestOut.isPaging=_cur.GetPropertyValue(requestIn,"ispaging","false"),requestOut.pageSize=_cur.GetPropertyValue(requestIn,"pagesize","10"),requestOut.listName=_cur.GetPropertyValue(requestIn,"listname",""),requestOut.instructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.displayTemplateUrl=_cur.GetPropertyValue(requestIn,"displaytemplateurl",""),requestOut.callbackMethod=_cur.GetPropertyValue(requestIn,"callbackmethod",""),requestOut.isAsyncCallback=_cur.GetPropertyValue(requestIn,"isasynccallback","false"),requestOut.viewXml=_cur.GetPropertyValue(requestIn,"viewxml",""),requestOut.callbackType=_cur.GetPropertyValue(requestIn,"callbacktype","postdataload"),requestOut.dataLoadProperties=_cur.GetPropertyValue(requestIn,"dataloadproperties",""),requestOut.CacheInterval=_cur.GetPropertyValue(requestIn,"cacheinterval","0"),requestOut};this.Init=function(documentListRequest){_cur.DocumentListRequest=_cur.SetDefaultsProperties(documentListRequest);Akumina.Digispace.AppPart.Eventing.Subscribe("/documentlist/search",_cur.SearchList);_cur.genericListControl=new Akumina.AddIn.GenericListControlWidget;_cur.genericListControl.Init(_cur.DocumentListRequest)};this.SearchList=function(model){model.viewxml!=""&&(_cur.DocumentListRequest.viewXml="<View>"+model.viewxml,_cur.DocumentListRequest.pageSize&&(_cur.DocumentListRequest.viewXml+="<RowLimit>"+_cur.DocumentListRequest.pageSize+"<\/RowLimit>"),_cur.DocumentListRequest.viewXml+="<\/View>");_cur.genericListControl.Init(_cur.DocumentListRequest);_cur.genericListControl.Render()}}),function(jQuery){function keyHandler(handleObj){if(typeof handleObj.data=="string"&&(handleObj.data={keys:handleObj.data}),handleObj.data&&handleObj.data.keys&&typeof handleObj.data.keys=="string"){var origHandler=handleObj.handler,keys=handleObj.data.keys.toLowerCase().split(" ");handleObj.handler=function(event){var i,l;if(this===event.target||!(jQuery.hotkeys.options.filterInputAcceptingElements&&jQuery.hotkeys.textInputTypes.test(event.target.nodeName)||jQuery.hotkeys.options.filterContentEditable&&jQuery(event.target).attr("contenteditable")||jQuery.hotkeys.options.filterTextInputs&&jQuery.inArray(event.target.type,jQuery.hotkeys.textAcceptingInputTypes)>-1)){var special=event.type!=="keypress"&&jQuery.hotkeys.specialKeys[event.which],character=String.fromCharCode(event.which).toLowerCase(),modif="",possible={};for(jQuery.each(["alt","ctrl","shift"],function(index,specialKey){event[specialKey+"Key"]&&special!==specialKey&&(modif+=specialKey+"+")}),event.metaKey&&!event.ctrlKey&&special!=="meta"&&(modif+="meta+"),event.metaKey&&special!=="meta"&&modif.indexOf("alt+ctrl+shift+")>-1&&(modif=modif.replace("alt+ctrl+shift+","hyper+")),special?possible[modif+special]=!0:(possible[modif+character]=!0,possible[modif+jQuery.hotkeys.shiftNums[character]]=!0,modif==="shift+"&&(possible[jQuery.hotkeys.shiftNums[character]]=!0)),i=0,l=keys.length;i<l;i++)if(possible[keys[i]])return origHandler.apply(this,arguments)}}}}jQuery.hotkeys={version:"0.2.0",specialKeys:{8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},shiftNums:{"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},textAcceptingInputTypes:["text","password","number","email","url","range","date","month","week","time","datetime","datetime-local","search","color","tel"],textInputTypes:/textarea|input|select/i,options:{filterInputAcceptingElements:!0,filterTextInputs:!0,filterContentEditable:!0}};jQuery.each(["keydown","keyup","keypress"],function(){jQuery.event.special[this]={add:keyHandler}})}(jQuery||this.jQuery||window.jQuery);Akumina=Akumina||{};Akumina.namespace=function(ns_string){var parts=ns_string.split("."),parent=Akumina,i;for(parts[0]==="Akumina"&&(parts=parts.slice(1)),i=0;i<parts.length;i+=1)typeof parent[parts[i]]=="undefined"&&(parent[parts[i]]={}),parent=parent[parts[i]];return parent};Akumina.namespace("Akumina.Digispace.AppPart");Akumina.namespace("Akumina.Digispace.AppPart.Data");Akumina.namespace("Akumina.WidgetManager");Akumina.Digispace.Version="3.3.1612.0641";Akumina.WidgetManager=function(){var _cur=this,_browser=null;this.Init=function(){_browser=new Akumina.WidgetManager.Browser;_browser.Init();$(".ak-controls").each(function(){var current=$(this);this._menu=new Akumina.WidgetManager.Menu(this);this._menu.Draw()});$(".ak-widget").each(function(){var current=$(this);this._menu=new Akumina.WidgetManager.Menu(this);this._menu.Draw()})};this.Close=function(){this._browser.Dispose()}};Akumina.WidgetManager.Menu=function(p){var me=this,_menu=null,_parent=p;this.Draw=function(){if(_menu=$('<div class="ak-control-menu"><\/div>'),$(_parent).find(".ak-control-menu").length<=0){$(_parent).children()[0]==undefined?$(_parent).prepend(_menu):$(_parent).children().not("script").prepend(_menu);$(_menu).on("click",function(){return Akumina.Digispace.AppPart.Eventing.Publish("/MM/Go/",_parent),Akumina.AddIn.Logger.WriteInfoLog("clicked"),!1})}};this.Dispose=function(){$(_menu).remove()}};typeof Akumina.Digispace.Cookie=="undefined"&&(Akumina.Digispace.Cookie={ReadCookie:function(name){for(var c,nameEQ=encodeURIComponent(name)+"=",ca=document.cookie.split(";"),i=0;i<ca.length;i++){for(c=ca[i];c.charAt(0)===" ";)c=c.substring(1,c.length);if(c.indexOf(nameEQ)===0)return decodeURIComponent(c.substring(nameEQ.length,c.length))}return null},SetCookie:function(name,value,days){var expires,date;days?(date=new Date,date.setTime(date.getTime()+days*864e5),expires="; expires="+date.toGMTString()):expires="";document.cookie=encodeURIComponent(name)+"="+encodeURIComponent(value)+expires+"; path=/"},GetSharepointBarCookieKey:function(){return"akumina:showSharepointBar:user:"+_spPageContextInfo.userLoginName+":siteid:"+_spPageContextInfo.siteAbsoluteUrl}});Akumina.WidgetManager.Browser=function(){var me=this,ViewManagementModel;this.Init=function(){Akumina.Digispace.AppPart.Eventing.Subscribe("/MM/Go/",me.OnOpen);Akumina.Digispace.AppPart.Eventing.Subscribe("/MM/Save/",me.OnSave);Akumina.Digispace.AppPart.Eventing.Subscribe("/MM/Save/",me.OnClose)};this.OnOpen=function(parent){me._controlId=$(parent).attr("id");$(".ia-loading-panel").addClass("ia-show");window.setTimeout(function(){me.Show(me._controlId)},500)};this.Dispose=function(){};this.Show=function(id){var displayTemplateUrl=(new Akumina.Digispace.AppPart.Data).Templates.GetCoreTemplate("WidgetManager.html"),key=Akumina.Digispace.ConfigurationContext.getCacheKey(id),cacheTimeout=Akumina.AddIn.Cache.Get(key+"-cacheexpiration"),currentTime=Math.floor((new Date).getTime()/6e4),timeLeft=cacheTimeout-currentTime;timeLeft<=0&&(timeLeft=0);me.GetWidgetProperties(id).then(function(widgetProps){var properties=[],def=new $.Deferred;widgetProps!=null?me.MapWidgetProperties(widgetProps.widgetname,widgetProps).then(function(mappedProperties){mappedProperties.id=id;mappedProperties.widgetname=widgetProps.widgetname;for(var prop in mappedProperties)properties.push({key:prop,value:mappedProperties[prop].toString()});me.GetAvailableViewsForWidget(mappedProperties.widgetname).then(function(availableViews){if(mappedProperties.displaytemplateurl!=undefined){availableViews.length==0&&availableViews.push({viewName:"Default",viewTemplateUrl:mappedProperties.displaytemplateurl});properties.push({key:"availableviews",value:availableViews});var selectViewObject=$.grep(availableViews,function(a){return a.viewTemplateUrl.toLowerCase()==mappedProperties.displaytemplateurl.toString().toLowerCase()}),selectedViewUrl="";selectedViewUrl=selectViewObject!=null&&selectViewObject!=undefined&&selectViewObject.length>0?selectViewObject[0].viewTemplateUrl:availableViews[0].viewTemplateUrl;properties.push({key:"selectedview",value:selectedViewUrl})}me.LoadViews(mappedProperties.widgetname,properties,[],def)},function(errormsg){$(".ia-loading-panel").removeClass("ia-show");$(".ia-loading-panel").addClass("ia-hide");Akumina.AddIn.Logger.WriteErrorLog(errormsg)})},function(errorMsg){$(".ia-loading-panel").removeClass("ia-show");$(".ia-loading-panel").addClass("ia-hide");Akumina.AddIn.Logger.WriteErrorLog(errorMsg)}):def.resolve(properties);def.done(function(properties){var contents=$("#"+id)[0].outerHTML.trim(),tmp=contents.split("\n"),snippet=tmp[0];(new Akumina.Digispace.AppPart.Data).Templates.FindAndRender(displayTemplateUrl,"#widgetManager",{SenderId:id,CacheTimeout:timeLeft,SnippetHtml:snippet,widgetprops:properties,HasWidgetProperties:properties.length>0},null,me.DoPopUp)})},function(errormsg){$(".ia-loading-panel").removeClass("ia-show");$(".ia-loading-panel").addClass("ia-hide");Akumina.AddIn.Logger.WriteErrorLog(errormsg)})};this.GetAvailableViewsForWidget=function(widgetName){var me=this,def=$.Deferred(),context=new SP.ClientContext,site=context.get_site(),web=site.get_rootWeb(),oList=web.get_lists().getByTitle("widgetviews_ak"),query="<View><Query><Where><Eq><FieldRef Name='WidgetName'/><Value Type='Text'>"+widgetName+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1000<\/RowLimit><\/View>",camlQuery=new SP.CamlQuery,listItems;return camlQuery.set_viewXml(query),listItems=oList.getItems(camlQuery),context.load(listItems),context.executeQueryAsync(function(){me.AvailableViewsLoadedSuccess(listItems,def)},function(sender,args){me.AvailableViewsLoadedError(sender,args);def.reject(args.get_message())}),def};this.AvailableViewsLoadedSuccess=function(listItems,def){var listEnum=listItems.getEnumerator();for(availableViewsArray=[];listEnum.moveNext();){var currentItem=listEnum.get_current(),viewName=currentItem.get_item("ViewName"),viewtemplateUrl=currentItem.get_item("ViewTemplateUrl");availableViewsArray.push({viewName:viewName,viewTemplateUrl:_spPageContextInfo.siteAbsoluteUrl+viewtemplateUrl});Akumina.AddIn.Logger.logSPCall("AvailableViewsLoadedSuccess")}def.resolve(availableViewsArray)};this.AvailableViewsLoadedError=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message())};this.GetViewForProperty=function(widgetName,widgetPropertyName,widgetPropValue){var def=new $.Deferred,viewName=Akumina.Digispace.WidgetPropertyViews.GetViewForProperty(widgetName,widgetPropertyName).viewName,viewTemplate=_spPageContextInfo.siteServerRelativeUrl+Akumina.Digispace.DebugViewManager.GetView(viewName).viewTemplate;return(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(viewTemplate,{widgetName:widgetName,widgetPropertyName:widgetPropertyName,widgetPropValue:widgetPropValue}).done(function(html){def.resolve(html)}),def};this.LoadViews=function(widgetName,oldproperties,newproperties,def){if(oldproperties.length==0){def.resolve(newproperties);return}var propObject=oldproperties[0];me.GetViewForProperty(widgetName,propObject.key,propObject.value).done(function(html){propObject.DisplayProperty=propObject.key.toLowerCase()=="availableviews"||propObject.key.toLowerCase()=="selectedview"?!1:!0;html==null?(propObject.HasView=!1,newproperties.push(propObject),me.LoadViews(widgetName,oldproperties.slice(1,oldproperties.length),newproperties,def)):(propObject.HasView=!0,propObject.ViewHtml=html,newproperties.push(propObject),me.LoadViews(widgetName,oldproperties.slice(1,oldproperties.length),newproperties,def))})};this.GetWidgetAvailableProperties=function(widgetName){var def=new $.Deferred,widgetHandler=new Akumina.Digispace.Data.WidgetManager;return widgetHandler.GetWidgetTypes().then(function(widgets){var widgetProps=[],widgetObj;widgets!=null?(widgetObj=widgets.filter(function(obj){return obj.widgetName.toLowerCase()==widgetName.toLowerCase()}),widgetObj.length>0?(widgetProps=JSON.parse(widgetObj[0].widgetProperties),def.resolve(widgetProps)):def.resolve(widgetProps)):def.resolve(widgetProps)},function(errormsg){def.reject(errormsg)}),def};this.MapWidgetProperties=function(widgetName,widgetInstancePropertyObj){var def=$.Deferred();return me.GetWidgetAvailableProperties(widgetName).then(function(widgetAvailableProperties){widgetAvailableProperties=widgetAvailableProperties!=""?widgetAvailableProperties:[];var mappedProperties={};widgetInstancePropertyObj=me.ConvertKeysToLowerCase(widgetInstancePropertyObj);$.each(widgetAvailableProperties,function(index,obj){mappedProperties[obj.name.toLowerCase()]=widgetInstancePropertyObj.hasOwnProperty(obj.name.toLowerCase())?widgetInstancePropertyObj[obj.name.toLowerCase()]:obj.value});def.resolve(mappedProperties)},function(errormsg){def.reject(errormsg)}),def};this.ConvertKeysToLowerCase=function(obj){var output={};for(i in obj)output[i.toLowerCase()]=Object.prototype.toString.apply(obj[i])==="[object Object]"||Object.prototype.toString.apply(obj[i])==="[object Array]"?me.ConvertKeysToLowerCase(obj[i]):obj[i];return output};this.GetWidgetProperties=function(selectedWidgetId){var def=new $.Deferred,widgetHandler=new Akumina.Digispace.Data.WidgetManager;return widgetHandler.GetWidgetInstances().then(function(items){var i,prop;if(items!=null){for(i=0;i<items.length;i++){var widgetName=items[i].widgetName,widgetclass=items[i].widgetclass,widgetId=items[i].widgetId,widgetprops=JSON.parse(items[i].widgetprops),widgetRequest={};for(prop in widgetprops)widgetRequest[prop]=typeof widgetprops[prop]=="object"?JSON.stringify(widgetprops[prop]):widgetprops[prop];widgetRequest.id=widgetId;widgetRequest.widgetname=widgetName;selectedWidgetId==widgetId&&def.resolve(widgetRequest)}def.resolve(null)}},function(errormsg){def.reject(errormsg)}),def};ViewManagementModel=function(properties){function ToggleWidgetManager(){var e=$.Event("keydown");e.which=40;e.ctrlKey=!0;$(document).trigger(e)}var self=this,i,jsonValue;for(self.props={},i=0;i<properties.length;i++)try{jsonValue=JSON.parse(properties[i].value);props[properties[i].key]=typeof jsonValue=="boolean"?ko.observable(jsonValue):ko.observable(properties[i].value)}catch(err){props[properties[i].key]=$.isArray(properties[i].value)?ko.observableArray(properties[i].value):ko.observable(properties[i].value)}self.widgetprops=ko.observable(props);self.ValidateJson=function(data,event,propertyName){var newValue=self.widgetprops()[propertyName.toLowerCase()]();try{JSON.parse(newValue);alert("SUCCESS - Valid JSON.")}catch(err){alert("ERROR - Invalid JSON.")}};self.valueChanged=function(data,event,propertyName){var newValue="";newValue=event.target.type=="checkbox"?jQuery(event.target).is(":checked")?!0:!1:event.target.value;self.widgetprops()[propertyName](newValue)};self.UpdateWidgetProperties=function(){$("#ak-loading").show();var properties={},widgetInstanceId="",widgetName="",widgetHandler=new Akumina.Digispace.Data.WidgetManager;me.GetWidgetAvailableProperties(self.widgetprops().widgetname().toLowerCase()).then(function(widgetAKProperties){var key,propertyObj,validationModel,listItems;if(widgetAKProperties&&widgetAKProperties.length>0){for(key in self.widgetprops()){if(widgetAKProperties&&widgetAKProperties.length>0&&(propertyObj=widgetAKProperties.filter(function(obj){return obj.name.toLowerCase()==key.toLowerCase()}),propertyObj.length>0&&(validationModel=Akumina.Digispace.Validation.ValidateProperty(key,self.widgetprops()[key](),propertyObj[0].type),!validationModel.success)))return $(".ia-form-error").html("<p>"+validationModel.message+"<\/p>"),$(".ia-form-error").show(),!1;key=="id"?widgetInstanceId=self.widgetprops()[key]():key=="widgetname"?widgetName=self.widgetprops()[key]():key=="displaytemplateurl"?properties[key]=self.widgetprops().selectedview():key!="availableviews"&&key!="selectedview"&&(properties[key]=self.widgetprops()[key]())}var context=new SP.ClientContext,site=context.get_site(),web=site.get_rootWeb(),oList=web.get_lists().getByTitle("widgetproperties_ak"),query="<View><Query><Where><Eq><FieldRef Name='WidgetInstanceId'/><Value Type='Text'>"+widgetInstanceId+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>",camlQuery=new SP.CamlQuery;camlQuery.set_viewXml(query);listItems=oList.getItems(camlQuery);context.load(listItems);Akumina.AddIn.Logger.logSPCall("UpdateWidgetProperties");context.executeQueryAsync(function(){properties.id=widgetInstanceId;properties.widgetname=widgetName;self.WidgetPropsLoadedSuccess(context,listItems,properties)},function(sender,args){self.WidgetPropsLoadedError(sender,args)})}else self.CloseWidgetManager(properties)})};self.WidgetPropsLoadedSuccess=function(context,listItems,properties){var propertiesToSave,listEnum,currentItem;for($(".ia-form-error").hide(),propertiesToSave=$.extend({},properties),propertiesToSave.hasOwnProperty("id")&&delete propertiesToSave.id,propertiesToSave.hasOwnProperty("widgetname")&&delete propertiesToSave.widgetname,listEnum=listItems.getEnumerator();listEnum.moveNext();)currentItem=listEnum.get_current(),currentItem.set_item("WidgetProperties",JSON.stringify(propertiesToSave)),currentItem.update(),context.load(currentItem),Akumina.AddIn.Logger.logSPCall("WidgetPropsLoadedSuccess"),context.executeQueryAsync(function(){self.CloseWidgetManager(properties)},function(){$(".ia-form-error").html("<p>Error Updating Widget Properties<\/p>");$(".ia-form-error").show()})};self.CloseWidgetManager=function(properties){$(".ia-form-error").hide();$.magnificPopup.close();var cacheManager=new Akumina.Digispace.Data.CacheManager;cacheManager.clearContentCache();cacheManager.clearTemplatesCache();Akumina.Digispace.AppPart.Eventing.Publish("/widget/updated/",properties);ToggleWidgetManager()};self.WidgetPropsLoadedError=function(){$(".ia-form-error").html("<p>Error Loading Widget Properties<\/p>");$(".ia-form-error").show()}};this.DoPopUp=function(data){$.magnificPopup.open({items:{src:".mmModal",type:"inline"},closeOnBgClick:!1,showCloseBtn:!0});$(".ia-upload-cancel").on("click",function(){me.OnClose()});ko.applyBindings(ViewManagementModel(data.data.widgetprops),$(".mmModal").get(0));$(".ia-loading-panel").removeClass("ia-show");$(".ia-loading-panel").addClass("ia-hide")};this.OnSelectList=function(){};this.OnSelectModel=function(){};this.OnSelectView=function(){};this.BindLists=function(){};this.BindModels=function(){};this.BindViews=function(){};this.OnClose=function(){$.magnificPopup.close()};this.OnSave=function(){}};typeof Akumina.Digispace.AppPart.Eventing=="undefined"&&(Akumina.Digispace.AppPart.Eventing={events:{},Subscribe:function(e,func){this.events[e]||(this.events[e]=[]);this.events[e].push(func)},Publish:function(t,data){!this.events[t]||this.events[t].length<1||this.events[t].forEach(function(func){func(data||{})})}});Akumina.Digispace.AppPart.Data=function(){var _cur=this;this.Templates={FindAndRender:function(templateUri,selector,data,caller,callback){var cachedTemplate=_cur.Templates.GetCachedTemplate(templateUri);cachedTemplate&&cachedTemplate!=null?_cur.Templates.BindTemplateAndCallback(cachedTemplate,selector,data,caller,callback):_cur.Templates.RequestTemplateFromServer(templateUri).done(function(template){_cur.Templates.CacheTemplate(templateUri,template);_cur.Templates.BindTemplateAndCallback(template,selector,data,caller,callback)}).error(function(xhr,ajaxOptions,thrownError){Akumina.AddIn.Logger.WriteErrorLog(xhr.status);Akumina.AddIn.Logger.WriteErrorLog(thrownError);Akumina.AddIn.Logger.WriteErrorLog("Error downloading template "+templateUri);def.reject("Error downloading template "+templateUri)})},GetTemplateCacheKey:function(attribute){var prefix="akumina:template:";return attribute!=null&&(prefix+=attribute),prefix},ParseTemplate:function(templateUri,data){var def,cachedTemplate,hbstemplate;return Handlebars.registerHelper("debug",DWPViewDebugger),def=$.Deferred(),cachedTemplate=_cur.Templates.GetCachedTemplate(templateUri),cachedTemplate&&cachedTemplate!=null?(hbstemplate=Handlebars.compile(cachedTemplate),def.resolve(hbstemplate(data))):_cur.Templates.RequestTemplateFromServer(templateUri).then(function(template){_cur.Templates.CacheTemplate(templateUri,template);var hbstemplate=Handlebars.compile(template);def.resolve(hbstemplate(data))},function(){def.reject("Template Not Found at '"+templateUri+"'")}),def},RequestTemplateFromServer:function(templateUri){return $.ajax(templateUri)},BindTemplateAndCallback:function(template,selector,data,caller,callback){var hbstemplate,jsonObj;Handlebars.registerHelper("debug",DWPViewDebugger);hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data);jsonObj={caller:caller,selector:selector,data:data};$(selector).html(data.Html);callback&&callback!=null&&callback(jsonObj)},CacheTemplate:function(templateUri,template){Akumina.AddIn.Cache.Set(_cur.Templates.GetTemplateCacheKey(templateUri),template,Akumina.AddIn.Constants.TWOHOUR_CACHE_EXPIRATION)},GetCachedTemplate:function(templateUri){return Akumina.AddIn.Cache.Get(_cur.Templates.GetTemplateCacheKey(templateUri))},GetCoreTemplate:function(templateName){var templatefolderName=Akumina.Digispace.ConfigurationContext.TemplateCoreFolderName;return _spPageContextInfo.siteServerRelativeUrl=="/"?"/Style%20Library/"+templatefolderName+"/Content/Templates/Core/"+templateName:_spPageContextInfo.siteServerRelativeUrl+"/Style%20Library/"+templatefolderName+"/Content/Templates/Core/"+templateName},GetErrorTemplate:function(data){var def=$.Deferred(),errorTemplateUrl=_cur.Templates.GetCoreTemplate("Error.html");return _cur.Templates.ParseTemplate(errorTemplateUrl,data).then(function(html){def.resolve(html)}),def}}};typeof Akumina.Digispace.AppPart.Rail=="undefined"&&(Akumina.Digispace.AppPart.Rail=function(){var _cur=this;this.caller="rail";this.Init=function(items){Akumina.Digispace.AppPart.Eventing.Subscribe("/rail/loadcompleted/",_cur.OnLoad);Akumina.Digispace.AppPart.Eventing.Subscribe("/rail/itemclicked/",_cur.OnItemClick);Akumina.Digispace.AppPart.Eventing.Subscribe("/rail/itemhoverin/",_cur.OnItemHoverIn);Akumina.Digispace.AppPart.Eventing.Subscribe("/rail/itemhoverout/",_cur.OnItemHoverOut);Akumina.Digispace.AppPart.Eventing.Subscribe("/rail/itemcontentsloaded/",_cur.OnLoadItemContents);_cur._items=items;var data={Items:_cur._items};_cur.OnLoad(data)};this.OnLoad=function(data){var displayTemplateUrl=_cur.GetRailTemplate("RailTemplate.html");(new Akumina.Digispace.AppPart.Data).Templates.FindAndRender(displayTemplateUrl,".ak-user-nav",data,_cur.caller,_cur.OnRender)};this.GetRailTemplate=function(templateName){var templatefolderName=Akumina.Digispace.ConfigurationContext.TemplateFolderName;return _spPageContextInfo.siteServerRelativeUrl=="/"?"/Style%20Library/"+templatefolderName+"/Content/Templates/Rail/"+templateName:_spPageContextInfo.siteServerRelativeUrl+"/Style%20Library/"+templatefolderName+"/Content/Templates/Rail/"+templateName};this.OnItemClick=function(railItem){Akumina.AddIn.Logger.WriteInfoLog("OnItemClick called for "+railItem);var id=$(railItem).data("id"),selector="#ak-user-nav-flyout-"+id,defaultFlyout=$(railItem).data("flyout");defaultFlyout&&defaultFlyout==!0&&($(selector).html("<div>Loading...<\/div>"),$(selector).addClass("ak-active"));_cur.GetItemContents(railItem)};this.OnItemHoverOut=function(){};this.OnItemHoverIn=function(){};this.OnLoadItemContents=function(railItemContent){var id=$(railItemContent.Item).data("id"),selector="#ak-user-nav-flyout-"+id,displayTemplateUrl=_cur.GetRailTemplate("RailItemTemplate.html"),callBack=function(){var diff=$(window).height()-$(selector).parent().offset().top,elementRail=$(selector),bottomMargin,divMaxHeight;elementRail[0].scrollHeight>diff?(bottomMargin=18,divMaxHeight=diff-bottomMargin,elementRail.css("overflow","auto"),elementRail.css("max-height",divMaxHeight+"px")):(elementRail.css("overflow",""),elementRail.css("max-height",""))};(new Akumina.Digispace.AppPart.Data).Templates.FindAndRender(displayTemplateUrl,selector,railItemContent.RailItemModel,"RailItemClick",callBack)};this.GetItemContents=function(railItem){Akumina.AddIn.Logger.WriteInfoLog("GetItemContents called for "+railItem);var theCallBack=window[$(railItem).data("callback")],templateUri=$(railItem).data("template");typeof theCallBack=="function"&&_cur.RailItemCallback(railItem,templateUri,theCallBack).done(function(railItemModel){var contents={Item:railItem,RailItemModel:railItemModel};Akumina.Digispace.AppPart.Eventing.Publish("/rail/itemcontentsloaded/",contents)})};this.RailItemCallback=function(railItem,templateUri,callbackMethod){var def=$.Deferred();return callbackMethod(railItem).then(function(jsonData){(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(templateUri,jsonData).done(function(htmlContent){var railItemModel={Header:typeof jsonData.Header!="undefined"?jsonData.Header:"",RailItemContent:htmlContent,Footer:typeof jsonData.Footer!="undefined"?jsonData.Footer:""};def.resolve(railItemModel)})},function(errorData){var errorTemplateUri=_spPageContextInfo.siteAbsoluteUrl+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/Content/Templates/Rail/RailErrorTemplate.html";(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(errorTemplateUri,{ErrorMessage:errorData}).done(function(errorMessage){var railItemModel={Header:"Error",RailItemContent:errorMessage};def.resolve(railItemModel)})}),def};this.BindUIEvents=function(){$(".ak-user-nav-flyout").click(function(e){e.stopPropagation()});$("body").click(function(evt){$(evt.target).closest(".ak-user-nav").length==0&&$(".ak-user-nav-flyout").removeClass("ak-active")});$(".ak-user-nav li").hover(function(){Akumina.Digispace.AppPart.Eventing.Publish("/rail/itemhoverin/",this)},function(){Akumina.Digispace.AppPart.Eventing.Publish("/rail/itemhoverout/",this)});$(".ak-user-nav li").click(function(){$(".ak-user-nav-flyout").removeClass("ak-active");Akumina.Digispace.AppPart.Eventing.Publish("/rail/itemclicked/",this)});_cur.setProfileImage();$(".ak-user-profile-link img").on("click",function(event){event.preventDefault();var displayName=Akumina.Digispace.UserContext.DisplayName;displayName&&displayName!=""&&(location.href=_spPageContextInfo.siteAbsoluteUrl+"/Pages/Directory.aspx?searchText="+displayName)})};this.setProfileImage=function(){var image=document.createElement("IMG");image.alt=Akumina.Digispace.UserContext.LoginName;image.src=Akumina.Digispace.UserContext.Photo;$(".ak-user-profile-link").html(image)};this.OnRender=function(jsonObj){jsonObj.caller==_cur.caller&&_cur.BindUIEvents()}});typeof Akumina.Digispace.ConfigurationContext=="undefined"&&(Akumina.Digispace.ConfigurationContext={Settings:{},TemplateFolderName:"DigitalWorkPlace",TemplateCoreFolderName:"DigitalWorkPlace",GraphClientId:null,GraphSubscriptionId:null,SiteLogoURL:"",InterchangeURL:"",InterchangeLoginURL:"",CachingStrategyInterval:Akumina.AddIn.Constants.HOUR_CACHE_EXPIRATION,DepartmentSiteMap:[],GoogleMapKey:"",SkypeApiKey:"",SkypeApiKeyCC:"",TenantUrl:"",EnableAzureAD:!0,EnableDebugMode:!0,InterchangeQueryKey:"",Theme:"lightblue",SearchPageExclusionList:[],setDigispaceConfiguration:function(digispaceConfiguration){var searchPageExclusionList,isExternalUser;this.Settings=digispaceConfiguration;this.TenantUrl=_spPageContextInfo.siteAbsoluteUrl.replace(_spPageContextInfo.siteServerRelativeUrl,"");digispaceConfiguration.SubscriptionId!=null&&digispaceConfiguration.SubscriptionId!="Enter SubscriptionId here"&&digispaceConfiguration.SubscriptionId!=""?this.GraphSubscriptionId=digispaceConfiguration.SubscriptionId:this.clearCache();digispaceConfiguration.ClientId!=null&&digispaceConfiguration.ClientId!="Enter ClientId here"&&digispaceConfiguration.ClientId!=""?this.GraphClientId=digispaceConfiguration.ClientId:this.clearCache();digispaceConfiguration.SiteLogoURL!=null&&(this.SiteLogoURL=digispaceConfiguration.SiteLogoURL);digispaceConfiguration.InterchangeURL!=null&&(this.InterchangeURL=digispaceConfiguration.InterchangeURL);digispaceConfiguration.CachingStrategy!=null&&(this.CachingStrategyInterval=this.ResolveCachingStrategy(digispaceConfiguration.CachingStrategy));digispaceConfiguration.SiteDepartmentMap!=null&&(this.DepartmentSiteMap=this.MapDepartmentSites(digispaceConfiguration.SiteDepartmentMap));digispaceConfiguration.GoogleMapKey!=null&&(this.GoogleMapKey=digispaceConfiguration.GoogleMapKey);digispaceConfiguration.SkypeApiKey!=null&&(this.SkypeApiKey=digispaceConfiguration.SkypeApiKey);digispaceConfiguration.SkypeApiKeyCC!=null&&(this.SkypeApiKeyCC=digispaceConfiguration.SkypeApiKeyCC);digispaceConfiguration.EnableAzureAD!=null&&(this.EnableAzureAD=JSON.parse(digispaceConfiguration.EnableAzureAD.toLowerCase()));digispaceConfiguration.EnableDebugMode!=null&&(this.EnableDebugMode=JSON.parse(digispaceConfiguration.EnableDebugMode.toLowerCase()));digispaceConfiguration.InterchangeQueryKey!=null&&(this.InterchangeQueryKey=digispaceConfiguration.InterchangeQueryKey);digispaceConfiguration.Theme!=null&&(this.Theme=digispaceConfiguration.Theme);digispaceConfiguration.SearchPageExclusionList!=null&&(searchPageExclusionList=digispaceConfiguration.SearchPageExclusionList.split(","),this.SearchPageExclusionList=searchPageExclusionList);digispaceConfiguration.TemplateFolderName!=null&&(this.TemplateFolderName=digispaceConfiguration.TemplateFolderName);isExternalUser=_spPageContextInfo.userLoginName.indexOf("#ext#")>-1;isExternalUser&&(this.EnableAzureAD=!1)},clearCache:function(){Akumina.AddIn.Logger.WriteInfoLog("Clearing cache ClientId, SubscriptionId not configured");localStorage.clear()},getCacheKey:function(attribute){var prefix="akumina:digispace:"+_spPageContextInfo.siteAbsoluteUrl+":"+_spPageContextInfo.userLoginName+":";return attribute!=null&&(prefix+=attribute),prefix},ResolveCachingStrategy:function(cachingStrategy){if(cachingStrategy&&cachingStrategy!=null){if($.isNumeric(cachingStrategy)&&Math.floor(cachingStrategy)==cachingStrategy)return parseInt(cachingStrategy);switch(cachingStrategy.toLowerCase()){case"light":return Akumina.AddIn.Constants.MIN_CACHE_EXPIRATION;case"medium":return Akumina.AddIn.Constants.HOUR_CACHE_EXPIRATION;case"heavy":return Akumina.AddIn.Constants.LONG_CACHE_EXPIRATION;case"extreme":return Akumina.AddIn.Constants.DAY_CACHE_EXPIRATION;default:return Akumina.AddIn.Constants.HOUR_CACHE_EXPIRATION}}else return Akumina.AddIn.Constants.HOUR_CACHE_EXPIRATION},MapDepartmentSites:function(sitedepartments){var mappings,result,i;if(sitedepartments){for(mappings=JSON.parse(sitedepartments),result=[],i=0;i<mappings.length;i++)result[mappings[i].Department]=mappings[i];return result}},loadDigispaceConfiguration:function(){var def=$.Deferred(),me=this,digispaceConfiguration;if(me.def=def,digispaceConfiguration=Akumina.AddIn.Cache.Get(this.getCacheKey("configurationcontext")),digispaceConfiguration==null){Akumina.AddIn.Logger.WriteInfoLog("Did not find digispace configuration in cache.Fetching digispace configuration from SharePoint.");var me=this,context=new SP.ClientContext,site=context.get_site(),web=site.get_rootWeb(),list=web.get_lists().getByTitle("DigispaceConfigurationIDS_AK"),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<View><Query><\/Query><RowLimit>1000<\/RowLimit><\/View>");this.listItems=list.getItems(camlQuery);context.load(this.listItems);Akumina.AddIn.Logger.logSPCall("loadDigispaceConfiguration");context.executeQueryAsync(Function.createDelegate(me,me.digiConfigSuccess),Function.createDelegate(me,me.digiConfigError))}else this.setDigispaceConfiguration(digispaceConfiguration),Akumina.AddIn.Logger.WriteInfoLog("Found digispace configuration in cache."),def.resolve();return def},digiConfigSuccess:function(){for(var listEnumerator=this.listItems.getEnumerator(),digispaceConfiguration={};listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),key=listItem.get_item("Title");digispaceConfiguration[key]=listItem.get_item("Value")}this.setDigispaceConfiguration(digispaceConfiguration);Akumina.AddIn.Cache.Set(this.getCacheKey("configurationcontext"),digispaceConfiguration,Akumina.AddIn.Constants.HOUR_CACHE_EXPIRATION);this.def.resolve()},digiConfigError:function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Error fetching digispace configuration."+args.get_message());this.def.reject()}});typeof Akumina.Digispace.UserContext=="undefined"&&(Akumina.Digispace.UserContext={userSharePointGroups:[],userGroups:[],userProperties:{},Department:"",AdditionalDepartments:[],DisplayName:"",City:"",JobTitle:"",State:"",PostalCode:"",GraphUserId:"",LoginName:"",Photo:"",IsExternal:!1,getGraphConfig:function(){return{subscriptionId:Akumina.Digispace.ConfigurationContext.GraphSubscriptionId,clientId:Akumina.Digispace.ConfigurationContext.GraphClientId,postLogoutRedirectUri:window.location.origin,endpoints:{graphApiUri:"https://graph.microsoft.com"},cacheLocation:"localStorage"}},customProperties:"Department,UsageLocation,DisplayName,GivenName,Id,JobTitle,Mail,MobilePhone,OfficeLocation,PreferredLocation,Surname,UserPrincipalName,BusinessPhones,City,State,PostalCode",getUserContext:function(){return{UserGroups:this.userGroups,UserProperties:this.userProperties}},getUserProperties:function(){return this.userProperties},setUserProperties:function(userProperties){var departments,userdepartments,i;if(userProperties.CustomProperties.department){for(departments=userProperties.CustomProperties.department,departments=departments&&departments!=null?departments.split(","):[],userdepartments=[],i=0;i<departments.length;i++)departments[i].trim().length>0&&userdepartments.push(departments[i].trim());userdepartments.length>0&&(this.Department=userdepartments[0],this.AdditionalDepartments=userdepartments.slice(1,userdepartments.length))}userProperties.CustomProperties.displayName&&(this.DisplayName=userProperties.CustomProperties.displayName);userProperties.CustomProperties.city&&(this.City=userProperties.CustomProperties.city);userProperties.CustomProperties.jobTitle&&(this.JobTitle=userProperties.CustomProperties.jobTitle);userProperties.CustomProperties.state&&(this.State=userProperties.CustomProperties.state);userProperties.CustomProperties.postalCode&&(this.PostalCode=userProperties.CustomProperties.postalCode);userProperties.CustomProperties.id&&(this.GraphUserId=userProperties.CustomProperties.id);this.LoginName=_spPageContextInfo.userLoginName;this.Photo=__getTemplatePrefix()+"/_layouts/15/userphoto.aspx?size=S&username="+this.LoginName;this.userProperties=userProperties;this.IsExternal=_spPageContextInfo.userLoginName.indexOf("#ext#")>-1},getUserGroups:function(){return this.userGroups},setUserGroups:function(groups){this.userGroups=groups},getCacheKey:function(attribute){var prefix="akumina:digispace:"+_spPageContextInfo.userLoginName+":";return attribute!=null&&(prefix+=attribute),prefix},loadUserGroups:function(token,graphConfig){var me=this,filesUri=graphConfig.endpoints.graphApiUri+"/v1.0/me/memberOf";return $.ajax({type:"GET",url:filesUri,headers:{Authorization:"Bearer "+token}}).done(function(response){for(var userGroups=[],i=0;i<response.value.length;i++){var id=response.value[i].id,displayName=response.value[i].displayName,description=response.value[i].description,userGroup={id:id,displayName:displayName,description:description};userGroups.push(userGroup)}me.setUserGroups(userGroups)}).fail(function(){})},loadUserProperties:function(token,graphConfig){var me=this,filesUri=graphConfig.endpoints.graphApiUri+"/v1.0/me?&$select="+me.customProperties;return $.ajax({type:"GET",url:filesUri,headers:{Authorization:"Bearer "+token}}).done(function(response){var userProperties={},key;userProperties.CustomProperties={};for(key in response)userProperties.CustomProperties[key]=response[key];me.setUserProperties(userProperties)}).fail(function(){})},loadDigispaceUserContext:function(){var def=$.Deferred(),userContext=Akumina.AddIn.Cache.Get(this.getCacheKey("usercontext")),me=this;return userContext==null?(Akumina.AddIn.Logger.WriteInfoLog("Did not find userContext in cache. Fetching userContext from SharePoint."),CoreSteps.GetGraphTokenCallback.GetGraphToken().done(function(token){$.when(me.loadUserProperties(token,me.getGraphConfig()),me.loadUserGroups(token,me.getGraphConfig())).done(function(){var userContext=me.getUserContext();Akumina.AddIn.Cache.Set(me.getCacheKey("usercontext"),userContext,Akumina.AddIn.Constants.HOUR_CACHE_EXPIRATION);def.resolve(userContext)}).fail(function(){def.reject()})})):(me.setUserProperties(userContext.UserProperties),me.setUserGroups(userContext.UserGroups),Akumina.AddIn.Logger.WriteInfoLog("Found digispace user context in cache."),def.resolve()),def},Logout:function(){var me=this;me.ClearAdalTokensFromCache();window.setTimeout(function(){window.location="https://login.microsoftonline.com/logout.srf"},3e3)},ClearAdalTokensFromCache:function(){for(var x in localStorage)x.indexOf("adal.")!=-1&&localStorage.removeItem(x)},loadSharePointUserGroups:function(){var def=$.Deferred(),clientContext=SP.ClientContext.get_current(),currentUser=clientContext.get_web().get_currentUser(),userGroups;return clientContext.load(currentUser),userGroups=currentUser.get_groups(),clientContext.load(userGroups),clientContext.executeQueryAsync(function(){for(var groups=[],groupsEnumerator=userGroups.getEnumerator(),group;groupsEnumerator.moveNext();)group=groupsEnumerator.get_current(),groups.push(group.get_title());Akumina.Digispace.UserContext.userSharePointGroups=groups;def.resolve()},function(){Akumina.Digispace.UserContext.userSharePointGroups=[];def.resolve()}),def}});typeof Akumina.Digispace.Loader=="undefined"&&(Akumina.Digispace.Loader={_steps:null,_stepNumber:0,currentSPWeb:null,additionalSteps:{},Init:function(steps){Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/executestep/",Akumina.Digispace.Loader.Execute);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/onexecuted/",Akumina.Digispace.Loader.OnStepExecuted);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",Akumina.Digispace.Loader.OnCompleted);Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/showloading/",Akumina.Digispace.Loader.ShowOverlay);Akumina.Digispace.Loader._steps=Akumina.Digispace.Loader.MergeAdditionalSteps(steps);Akumina.Digispace.Loader._stepNumber=0;Akumina.Digispace.Loader.Execute()},AddStepsAfter:function(stepName,additionalStepsArray){Akumina.Digispace.Loader.additionalSteps[stepName]=additionalStepsArray},MergeAdditionalSteps:function(steps){var key,j,index,i,k;for(key in Akumina.Digispace.Loader.additionalSteps){if(key=="")for(j=0;j<Akumina.Digispace.Loader.additionalSteps[key].length;j++)steps.splice(j,0,Akumina.Digispace.Loader.additionalSteps[key][j]);for(index=-1,i=0;i<steps.length;i++)if(steps[i].name==key){index=i;break}if(index!=-1)for(k=0;k<Akumina.Digispace.Loader.additionalSteps[key].length;k++)steps.splice(++index,0,Akumina.Digispace.Loader.additionalSteps[key][k])}return steps},ExecuteParallel:function(callbacks){var def=$.Deferred(),asyncResults,i;if(callbacks){for(asyncResults=[],i=0;i<callbacks.length;i++)asyncResults.push(Akumina.Digispace.Loader.ExecuteAsync(callbacks[i]));Akumina.Digispace.Loader.WaitForResults(asyncResults,def)}else def.resolve();return def},ExecuteAsync:function(asyncMethod){var def=$.Deferred();return asyncMethod(def),def},WaitForResults:function(asyncResults,def){asyncResults&&asyncResults.length>0&&asyncResults[0].always(function(){asyncResults.length==1&&def.resolve();Akumina.Digispace.Loader.WaitForResults(asyncResults.slice(1,asyncResults.length),def)})},parallel1:function(def){window.setTimeout(function(){Akumina.AddIn.Logger.WriteInfoLog("parallel1");def.resolve()},2e3)},parallel2:function(def){window.setTimeout(function(){Akumina.AddIn.Logger.WriteInfoLog("parallel2");def.resolve()},1e3)},parallel3:function(def){window.setTimeout(function(){Akumina.AddIn.Logger.WriteInfoLog("parallel3");def.resolve()},3e3)},parallel4:function(def){window.setTimeout(function(){Akumina.AddIn.Logger.WriteInfoLog("parallel4");def.resolve()},500)},Execute:function(){if(Akumina.Digispace.Loader._stepNumber<Akumina.Digispace.Loader._steps.length){var currentStep=Akumina.Digispace.Loader._steps[Akumina.Digispace.Loader._stepNumber];Akumina.AddIn.Logger.StartTraceLog("Loader Executing Step "+currentStep.name);currentStep.callbackdata?currentStep.callback(currentStep.callbackdata).done(function(){Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")}):currentStep.callback()}else Akumina.Digispace.Loader._stepNumber>=Akumina.Digispace.Loader._steps.length&&Akumina.Digispace.AppPart.Eventing.Publish("/loader/completed/")},OnStepExecuted:function(){var currentStep=Akumina.Digispace.Loader._steps[Akumina.Digispace.Loader._stepNumber];Akumina.AddIn.Logger.StopTraceLog("Loader Executing Step "+currentStep.name);Akumina.Digispace.Loader._stepNumber+=1;Akumina.Digispace.AppPart.Eventing.Publish("/loader/executestep/")},OnCompleted:function(){Akumina.AddIn.Cache.Set(CoreSteps.DisplayLoader.GetCacheKey(),!0,Akumina.AddIn.Constants.DAY_CACHE_EXPIRATION);Akumina.Digispace.Loader.HideOverlay()},ShowOverlay:function(){$(".ia-loading-panel").removeClass("ia-hide");$(".ia-loading-panel").addClass("ia-show")},HideOverlay:function(){$(".ia-loading-panel").removeClass("ia-show");$(".ia-loading-panel").addClass("ia-hide")},clearTemplatesCache:function(){var templateKey=(new Akumina.Digispace.AppPart.Data).Templates.GetTemplateCacheKey();for(var x in localStorage)x.indexOf(templateKey)!=-1&&Akumina.AddIn.Cache.Remove(x.replace("lscache-",""))},clearContentCache:function(){var templateKey="lscache-"+Akumina.Digispace.UserContext.getCacheKey("usercontext");for(var x in localStorage)x.startsWith(templateKey)||x.startsWith("adal.")||Akumina.AddIn.Cache.Remove(x.replace("lscache-",""))}});typeof Akumina.Digispace.Utilities=="undefined"&&(Akumina.Digispace.Utilities={ShowSharepointBar:function(setCookie){setCookie&&Akumina.Digispace.Cookie.SetCookie(Akumina.Digispace.Cookie.GetSharepointBarCookieKey(),!0,Akumina.AddIn.Constants.LONG_CACHE_EXPIRATION);$("#ms-designer-ribbon").show()},HideSharepointBar:function(setCookie){setCookie&&Akumina.Digispace.Cookie.SetCookie(Akumina.Digispace.Cookie.GetSharepointBarCookieKey(),!1,Akumina.AddIn.Constants.LONG_CACHE_EXPIRATION);$("#ms-designer-ribbon").hide()}});typeof Akumina.Digispace.SiteContext=="undefined"&&(Akumina.Digispace.SiteContext={IsInDesignMode:function(){return typeof MSOWebPartPageFormName!="undefined"?document.forms[MSOWebPartPageFormName].MSOLayout_InDesignMode.value:""}});typeof Akumina.Digispace.DebugViewManager=="undefined"&&(Akumina.Digispace.DebugViewManager={views:[],Init:function(){this.views=[];this.views.push({viewName:"Default",viewTemplate:"/Style%20Library/DigitalWorkPlace/Content/Templates/Core/Views/Default.html"});this.views.push({viewName:"LabelView",viewTemplate:"/Style%20Library/DigitalWorkPlace/Content/Templates/Core/Views/Label.html"});this.views.push({viewName:"CheckBoxView",viewTemplate:"/Style%20Library/DigitalWorkPlace/Content/Templates/Core/Views/Checkbox.html"});this.views.push({viewName:"DropDown",viewTemplate:"/Style%20Library/DigitalWorkPlace/Content/Templates/Core/Views/Dropdown.html"});this.views.push({viewName:"TemplatePicker",viewTemplate:"/Style%20Library/DigitalWorkPlace/Content/Templates/Core/Views/TemplatePicker.html"});this.views.push({viewName:"JsonView",viewTemplate:"/Style%20Library/DigitalWorkPlace/Content/Templates/Core/Views/Json.html"})},GetViews:function(){return this.views.length==0&&this.Init(),this.views},GetView:function(viewName){this.views.length==0&&this.Init();for(var i=0;i<this.views.length;i++)if(this.views[i].viewName.toLowerCase()==viewName.toLowerCase())return this.views[i];return null},AddView:function(viewName,viewTemplateUrl){var view=this.GetView(viewName);view!=null?view.viewTemplate=viewTemplateUrl:this.views.push({viewName:"TemplatePicker",viewTemplate:viewTemplateUrl})}});typeof Akumina.Digispace.Validation=="undefined"&&(Akumina.Digispace.Validation={ValidateProperty:function(key,value,type){var validationModel={success:!0,message:""},value,c;switch(type.toLowerCase()){case"int":$.isNumeric(value)||(validationModel.success=!1,validationModel.message=key+" should be an integer.");break;case"bool":value=value.toString().toLowerCase();value!=""&&value!="true"&&value!="false"&&(validationModel.success=!1,validationModel.message=key+" should be a boolean value.");break;case"json":try{c=$.parseJSON(value)}catch(err){validationModel.success=!1;validationModel.message=key+" - Invalid json."}}return validationModel}});typeof Akumina.Digispace.WidgetPropertyViews=="undefined"&&(Akumina.Digispace.WidgetPropertyViews={views:[],GetViewForProperty:function(widgetName,propertyName){for(var viewName,i=0;i<this.views.length;i++)if(this.views[i].widgetName.toLowerCase()==widgetName.toLowerCase()&&this.views[i].propertyName.toLowerCase()==propertyName.toLowerCase())return this.views[i];return viewName="Default",(propertyName=="id"||propertyName=="widgetname")&&(viewName="LabelView"),{widgetName:widgetName,propertyName:propertyName,viewName:viewName}},AddViewForProperty:function(widgetName,propertyName,viewName){var view=this.GetViewForProperty(widgetName,propertyName);view.viewName.toLowerCase()!=viewName.toLowerCase()&&this.RemoveViewForProperty(widgetName,propertyName);this.views.push({widgetName:widgetName,propertyName:propertyName,viewName:viewName})},RemoveViewForProperty:function(widgetName,propertyName){for(var i=0;i<this.views.length;i++)this.views[i].widgetName.toLowerCase()==widgetName.toLowerCase()&&this.views[i].propertyName.toLowerCase()==propertyName.toLowerCase()&&this.views.splice(i,1)}});typeof Akumina.Digispace.Data=="undefined"&&(Akumina.Digispace.Data=function(){});typeof Akumina.Digispace.Data.WidgetManager=="undefined"&&(Akumina.Digispace.Data.WidgetManager=function(){var _cur=this,GetCacheInterval=function(){return Akumina.AddIn.Constants.HOUR_CACHE_EXPIRATION},GetWidgetTypesCacheKey=function(){return Akumina.Digispace.ConfigurationContext.getCacheKey("widgets_ak")},GetWidgetInstancesCacheKey=function(){return Akumina.Digispace.ConfigurationContext.getCacheKey("widgetproperties_ak")},SuccessHandler=function(listItems,def){for(var items=[],listEnumerator=listItems.getEnumerator();listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),title=listItem.get_item("Title"),widgetName=listItem.get_item("WidgetName"),widgetclass=listItem.get_item("WidgetClass"),widgetProperties=listItem.get_item("WidgetProperties");items.push({title:title,widgetName:widgetName,widgetclass:widgetclass,widgetProperties:widgetProperties})}Akumina.AddIn.Cache.Set(GetWidgetTypesCacheKey(),items,GetCacheInterval());def.resolve(items)},ErrorHandler=function(sender,args,def){var errormsg="Request failed. "+args.get_message()+"\n"+args.get_stackTrace();def.reject(errormsg)},LoadWidgetInstances=function(items,def){var listName="WidgetProperties_AK",web,context=SP.ClientContext.get_current(),site=context.get_site();web=site.get_rootWeb();var list=web.get_lists().getByTitle(listName),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<View><RowLimit>1000<\/RowLimit><\/View>");listItems=list.getItems(camlQuery);context.load(listItems,"Include(Title,WidgetName,WidgetInstanceId,WidgetProperties)");Akumina.AddIn.Logger.logSPCall("LoadWidgetInstances ("+listName+")");context.executeQueryAsync(function(){WidgetInstancesSuccessHandler(listItems,items,def)},function(sender,args){ErrorHandler(sender,args,def)})},WidgetInstancesSuccessHandler=function(listItems,items,def){for(var widgetInstances=[],listEnumerator=listItems.getEnumerator(),i;listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),title=listItem.get_item("Title"),widgetName=listItem.get_item("WidgetName"),instanceId=listItem.get_item("WidgetInstanceId"),widgetprops=listItem.get_item("WidgetProperties");for(i=0;i<items.length;i++)if(items[i].widgetName==widgetName){widgetInstances.push({title:items[i].title,widgetName:items[i].widgetName,widgetclass:items[i].widgetclass,widgetId:instanceId,widgetprops:widgetprops});continue}}Akumina.AddIn.Cache.Set(GetWidgetInstancesCacheKey(),widgetInstances,GetCacheInterval());def.resolve(widgetInstances)},LoadDashboardWidgets=function(widgets,def){var listName="DashboardWidgets_AK",web,context=SP.ClientContext.get_current(),site=context.get_site(),listItems;web=site.get_rootWeb();var list=web.get_lists().getByTitle(listName),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<View><Query><Where><Eq><FieldRef Name='Enabled' /><Value Type='Boolean'>1<\/Value><\/Eq><\/Where><\/Query><RowLimit>20<\/RowLimit><\/View>");listItems=list.getItems(camlQuery);context.load(listItems,"Include(Title,WidgetName,WidgetId)");Akumina.AddIn.Logger.logSPCall("LoadDashboardWidgets("+listName+")");context.executeQueryAsync(function(){LoadDashboardWidgetsSuccessHandler(listItems,widgets,def)},function(sender,args){ErrorHandler(sender,args,def)})},LoadDashboardWidgetsSuccessHandler=function(listItems,widgets,def){for(var items=[],listEnumerator=listItems.getEnumerator(),i;listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),title=listItem.get_item("Title"),widgetName=listItem.get_item("WidgetName"),widgetId=listItem.get_item("WidgetId");for(i=0;i<widgets.length;i++)widgets[i].widgetName==widgetName&&items.push({title:title,widgetName:widgetName,widgetclass:widgets[i].widgetclass,widgetId:widgetId,widgetprops:""})}SetWidgetPropertiesForWidget(items,def)},SetWidgetPropertiesForWidget=function(items,def){var listName="WidgetProperties_AK",web,context=SP.ClientContext.get_current(),site=context.get_site(),listItems;web=site.get_rootWeb();var list=web.get_lists().getByTitle(listName),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<View><RowLimit>1000<\/RowLimit><\/View>");listItems=list.getItems(camlQuery);context.load(listItems,"Include(Title,SiteId,WidgetInstanceId,WidgetProperties)");Akumina.AddIn.Logger.logSPCall("SetWidgetPropertiesForWidget ("+listName+")");context.executeQueryAsync(function(){WidgetPropertiesSuccessHandler(listItems,items,def)},function(sender,args){ErrorHandler(sender,args,def)})},WidgetPropertiesSuccessHandler=function(listItems,items,def){for(var listEnumerator=listItems.getEnumerator(),i;listEnumerator.moveNext();){var listItem=listEnumerator.get_current(),title=listItem.get_item("Title"),widgetId=listItem.get_item("WidgetInstanceId"),widgetprops=listItem.get_item("WidgetProperties");for(i=0;i<items.length;i++)if(items[i].widgetId==widgetId){items[i].widgetprops=widgetprops;continue}}Akumina.AddIn.Cache.Set(_cur.GetDashboardWidgetsCacheKey(),items,GetCacheInterval());def.resolve(items)},OverrideProperties=function(defaultProperties,overrideProperties){var mergedProperties=defaultProperties;for(var key in overrideProperties)mergedProperties[key]=overrideProperties[key];return mergedProperties};this.GetDashboardWidgetsCacheKey=function(){return Akumina.Digispace.ConfigurationContext.getCacheKey("dashboardwidgets_ak")};this.GetWidgetTypes=function(){var def=$.Deferred(),widgets=Akumina.AddIn.Cache.Get(GetWidgetTypesCacheKey()),listItems;if(widgets==null){var listName="Widgets_AK",web,context=SP.ClientContext.get_current(),site=context.get_site();web=site.get_rootWeb();var list=web.get_lists().getByTitle(listName),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<View><RowLimit>1000<\/RowLimit><\/View>");listItems=list.getItems(camlQuery);context.load(listItems,"Include(Title,WidgetName,WidgetClass,WidgetProperties)");Akumina.AddIn.Logger.logSPCall("Akumina.Digispace.Data.Widgets.GetWidgetTypes("+listName+")");context.executeQueryAsync(function(){SuccessHandler(listItems,def)},function(sender,args){ErrorHandler(sender,args,def)})}else def.resolve(widgets);return def};this.GetWidgetInstances=function(){var def=$.Deferred(),widgetInstances=Akumina.AddIn.Cache.Get(GetWidgetInstancesCacheKey());return widgetInstances==null?_cur.GetWidgetTypes().then(function(widgetTypes){LoadWidgetInstances(widgetTypes,def)},function(errormsg){def.reject(errormsg)}):def.resolve(widgetInstances),def};this.InitializeWidgets=function(items){for(var prop,k,i=0;i<items.length;i++){var widgetName=items[i].widgetName,widgetclass=items[i].widgetclass,widgetId=items[i].widgetId,widgetprops=JSON.parse(items[i].widgetprops),widgetRequest={};for(prop in widgetprops)widgetRequest[prop]=widgetprops[prop];widgetRequest.id=widgetId;widgetRequest.widgetname=widgetName;var pageContainsWidget=$("#"+widgetId),namespace=widgetclass.split("."),widget=window;try{for(k=0;k<namespace.length;k++)widget=widget[namespace[k]];if(typeof widget=="function"&&pageContainsWidget.length>0)try{instance=new widget;instance.Init(widgetRequest)}catch(ex){pageContainsWidget.length>0&&pageContainsWidget.html("Problem with the internals of '"+widgetclass+"', please contact your developer ("+ex.message+")")}}catch(ex){pageContainsWidget.length>0&&pageContainsWidget.html("Could not find widget class '"+widgetclass+"', please contact your developer ("+ex.message+")")}}};this.GetDashboardWidgets=function(){var def=$.Deferred(),dashboardWidgets=Akumina.AddIn.Cache.Get(_cur.GetDashboardWidgetsCacheKey());return dashboardWidgets==null?_cur.GetWidgetTypes().then(function(widgetTypes){LoadDashboardWidgets(widgetTypes,def)},function(errormsg){def.reject(errormsg)}):def.resolve(dashboardWidgets),def}});typeof Akumina.Digispace.Data.CacheManager=="undefined"&&(Akumina.Digispace.Data.CacheManager=function(){this.clearTemplatesCache=function(){var templateKey=(new Akumina.Digispace.AppPart.Data).Templates.GetTemplateCacheKey();for(var x in localStorage)x.indexOf(templateKey)!=-1&&Akumina.AddIn.Cache.Remove(x.replace("lscache-",""))};this.clearContentCache=function(){var templateKey="lscache-"+Akumina.Digispace.UserContext.getCacheKey("usercontext");for(var x in localStorage)x.startsWith(templateKey)||x.startsWith("adal.")||Akumina.AddIn.Cache.Remove(x.replace("lscache-",""))}});typeof Akumina.Digispace.Data.InterchangeAPI=="undefined"&&(Akumina.Digispace.Data.InterchangeAPI=function(){var GetAllUsers=function(searchContext,currentUserName,def){var interchangeUrl=Akumina.Digispace.ConfigurationContext.InterchangeURL,interchangeQueryKey=Akumina.Digispace.ConfigurationContext.InterchangeQueryKey;$.ajax({type:"POST",url:interchangeUrl+"/api/connector/users?pageSize="+searchContext.pageSize+"&pageNumber="+searchContext.pageNumber+"&orderBy="+searchContext.orderBy+"&interchangeQueryKey="+interchangeQueryKey+"&sortAsc="+searchContext.sortAsc,data:searchContext.filters,dataType:"json",xhrFields:{withCredentials:!0}}).done(function(response){response.IsLastPage;response.CurrentPage;def.resolve(response)}).fail(function(){def.reject("Error fetching users.")})};this.GetApps=function(){var def=$.Deferred(),interchangeUrl=Akumina.Digispace.ConfigurationContext.InterchangeURL,ua=window.navigator.userAgent,msie=ua.indexOf(" Trident/")>-1,siteId=Akumina.AddIn.Cache.Get("akumina:apps:siteid:"+_spPageContextInfo.siteAbsoluteUrl);if(siteId==null){var ctx=new SP.ClientContext.get_current,site=ctx.get_site(),web=ctx.get_web();siteId=web.get_id().toString()}var interchangeLogin=Akumina.AddIn.Cache.Get("akumina:apps:interchangelogin:"+_spPageContextInfo.siteAbsoluteUrl),ieoptions="forie?siteId="+siteId+"&interchangeQueryKey="+Akumina.Digispace.ConfigurationContext.InterchangeQueryKey,myappsurl=interchangeUrl+"/api/connector/myapps"+(msie?ieoptions:"");return $.ajax({type:"GET",url:myappsurl,xhrFields:{withCredentials:!0}}).done(function(response){var groups=Akumina.Digispace.UserContext.userSharePointGroups,allApps=response.data.results,appsData=msie?_cur.GetUserAccessibleApps(groups,allApps):allApps,appsForSite=response.data.appsForSite,appsModel={},tab,j,isLoggedIn,i;if(appsModel.Tabs=[],appsModel.Tabs.push({Name:"Content Apps",Items:[]}),appsModel.Tabs.push({Name:"Management Apps",Items:[]}),appsModel.Tabs.push({Name:"Control Apps",Items:[]}),appsModel.Tabs.push({Name:"Reporting Apps",Items:[]}),appsData)for(i=0;i<appsData.length;i++){for(tab=undefined,j=0;j<appsModel.Tabs.length;j++)if(appsModel.Tabs[j].Name.toLowerCase()==appsData[i].AppGroup.toLowerCase()){tab=appsModel.Tabs[j];break}tab.Items.push({Title:appsData[i].Title,Image:appsData[i].Image,Link:appsData[i].Link})}if(isLoggedIn=response.data.isloggedin&&!msie||msie&&interchangeLogin!=null,isLoggedIn)if(appsModel.Sites=Akumina.AddIn.Cache.Get(_cur.GetMyAppsCacheKey("sites")),appsModel.Sites==null){appsModel.Sites=[];var context=new SP.ClientContext,web=context.get_web(),site=context.get_site(),rootWeb=site.get_rootWeb(),subWebs=rootWeb.getSubwebsForCurrentUser(null);context.load(rootWeb);context.load(subWebs);Akumina.AddIn.Logger.logSPCall("myappsCallback");context.executeQueryAsync(function(){var webUrl,i;for(appsModel.Sites.push({SiteName:rootWeb.get_serverRelativeUrl().replace("/sites/",""),SiteId:rootWeb.get_id().toString(),Selected:appsForSite?appsForSite.toLowerCase()==rootWeb.get_id().toString().toLowerCase()?"selected":"":rootWeb.get_url().toLowerCase()==_spPageContextInfo.webAbsoluteUrl.toLowerCase()?"selected":""}),webUrl=_spPageContextInfo.webServerRelativeUrl.toLowerCase().replace("/sites/",""),i=0;i<subWebs.get_count();i++){var subWeb=subWebs.itemAt(i),subwebUrl=subWeb.get_serverRelativeUrl().toLowerCase().replace("/sites/",""),subWebTemplate=subWeb.get_webTemplate().toLowerCase();subWebTemplate.indexOf("cmspublishing")!=-1&&appsModel.Sites.push({SiteName:subWeb.get_serverRelativeUrl().replace("/sites/",""),SiteId:subWeb.get_id().toString(),Selected:appsForSite?appsForSite.toLowerCase()==subWeb.get_id().toString().toLowerCase()?"selected":"":subwebUrl==webUrl?"selected":""})}Akumina.AddIn.Cache.Set(_cur.GetMyAppsCacheKey("sites"),appsModel.Sites,Akumina.Digispace.ConfigurationContext.CachingStrategyInterval);def.resolve(appsModel)},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message());var errorMsg="Error communicating with "+interchangeUrl;Akumina.AddIn.Logger.WriteErrorLog(errorMsg);def.reject(errorMsg)})}else{for(i=0;i<appsModel.Sites.length;i++)appsModel.Sites[i].Selected=appsModel.Sites[i].SiteId.toLowerCase()==appsForSite?"selected":"";def.resolve(appsModel)}else def.resolve(appsModel)}).error(function(xhr,ajaxOptions,thrownError){Akumina.AddIn.Logger.WriteErrorLog(xhr.status);Akumina.AddIn.Logger.WriteErrorLog(thrownError);Akumina.AddIn.Logger.WriteErrorLog("Error communicating with "+interchangeUrl);def.reject("Error fetching Apps from "+interchangeUrl)}),def};this.GetUserAccessibleApps=function(groups,appsData){for(var k,accessibleApps=[],i=0;i<appsData.length;i++)for(k=0;k<groups.length;k++)if(appsData[i].Authorization.indexOf(groups[k])!=-1){accessibleApps.push(appsData[i]);break}return accessibleApps};this.GetMyAppsCacheKey=function(attribute){var prefix="akumina:digispace:myapps:"+_spPageContextInfo.userLoginName+":";return attribute!=null&&(prefix+=attribute),prefix};this.GetUsersData=function(currentUserName,filters,pageSize,pageNumber,orderByField,sortAsc){var def=new $.Deferred,searchContext={filters:filters,pageSize:pageSize,pageNumber:pageNumber,orderBy:orderByField,sortAsc:sortAsc};return GetAllUsers(searchContext,currentUserName,def),def};this.GetFacets=function(facetObj){var i;Akumina.AddIn.Logger.WriteInfoLog("PeopleDirectory.getFacets");var facets={RefinementFilters:[]},def=new $.Deferred,interchangeUrl=Akumina.Digispace.ConfigurationContext.InterchangeURL,interchangeQueryKey=Akumina.Digispace.ConfigurationContext.InterchangeQueryKey,facetProperties={},facetNames=[];for(i=0;i<facetObj.length;i++)facetProperties[facetObj[i].facetName.toLowerCase()]=facetObj[i].facetDisplayName,facetNames.push(facetObj[i].facetName.toLowerCase());return $.ajax({type:"GET",url:interchangeUrl+"/api/connector/facets?facetNames="+facetNames.join(",")+"&interchangeQueryKey="+interchangeQueryKey,xhrFields:{withCredentials:!0}}).done(function(response){var key,filterObject,i;for(key in response){for(filterObject={FilterName:key,FilterHeader:facetProperties[key.toLowerCase()],FilterOptions:[]},i=0;i<response[key].length;i++)filterObject.FilterOptions.push({id:response[key][i].split(" ").join("-"),value:response[key][i]});facets.RefinementFilters.push(filterObject)}def.resolve(facets)}).error(function(xhr,ajaxOptions,thrownError){Akumina.AddIn.Logger.WriteErrorLog(xhr.status);Akumina.AddIn.Logger.WriteErrorLog(thrownError);Akumina.AddIn.Logger.WriteErrorLog("Error communicating with "+interchangeUrl);def.reject("Error fetching facets")}),def}});typeof Akumina.Digispace.Data.GraphAPI=="undefined"&&(Akumina.Digispace.Data.GraphAPI=function(){var _cur=this,GetAuthenticationContext,GetCacheKeyForAuthentication;this.GetCalendarEvents=function(){var def=new $.Deferred,authContext,isCallback,user;if(Akumina.Digispace.ConfigurationContext.EnableAzureAD){var token=localStorage["adal.idtoken"],startDate=moment(new Date).format("YYYY-MM-DD")+"T00:00:01",endDate=moment(new Date).format("YYYY-MM-DD")+"T23:59:59",query="/v1.0/me/calendarView?startDateTime="+startDate+"&endDateTime="+endDate+"&$top=20",subscriptionId=Akumina.Digispace.ConfigurationContext.GraphSubscriptionId,clientId=Akumina.Digispace.ConfigurationContext.GraphClientId;config={subscriptionId:subscriptionId,clientId:clientId,postLogoutRedirectUri:window.location.origin,endpoints:{graphApiUri:"https://graph.microsoft.com"},cacheLocation:"localStorage"};authContext=new AuthenticationContext(config);isCallback=authContext.isCallback(window.location.hash);authContext.handleWindowCallback();isCallback&&!authContext.getLoginError()&&(window.location=authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST));user=authContext.getCachedUser();user||authContext.login();authContext.acquireToken(config.endpoints.graphApiUri,function(error,token){if(error||!token){Akumina.AddIn.Logger.WriteErrorLog("ADAL error occurred: "+error);return}var filesUri=config.endpoints.graphApiUri+query;$.ajax({type:"GET",url:filesUri,headers:{Authorization:"Bearer "+token}}).done(function(response){var calendar,graphData,listItem,startTime,endTime,usermailLink,eventModel;for(Akumina.AddIn.Logger.WriteInfoLog("Successfully fetched events from Graph."),calendar={events:[]},graphData=response.value,i=0;i<graphData.length;i++)listItem=graphData[i],moment(listItem.start.dateTime).format("DD")==moment().format("DD")&&(startTime="",endTime="",listItem.isAllDay?(startTime="12:00 AM",endTime="11:59 PM"):(startTime=moment(new Date(listItem.start.dateTime+"Z")).format("hh:mm A"),endTime=moment(new Date(listItem.end.dateTime+"Z")).format("hh:mm A")),calendar.events.push({sortTime:moment(listItem.start.dateTime).format("HHmmss"),startTime:startTime.toLowerCase(),endTime:endTime.toLowerCase(),subject:listItem.subject}));usermailLink=String.format("https://outlook.office.com/owa/?realm={0}&path=/calendar/view/Month",_spPageContextInfo.userLoginName);calendar.events=CalendarOrderDate(calendar.events);eventModel={events:calendar.events,HasItems:calendar.events.length>0?!0:!1,UserMailLink:usermailLink};def.resolve(eventModel)}).error(function(xhr,ajaxOptions,thrownError){Akumina.AddIn.Logger.WriteErrorLog(xhr.status);Akumina.AddIn.Logger.WriteErrorLog(thrownError);def.reject("Calendar data not available.")})})}else def.reject("Your Azure AD is not configured");return def};var CalendarOrderDate=function(calendar){return calendar.sort(function(a,b){return a.sortTime-b.sortTime})},GetProfilePicFromCache=function(userName,loggedInUserEmail){var storageKey=GetProfilePictureCacheKey(userName,loggedInUserEmail),profileObj;return IsDataCached(storageKey)?(profileObj=Akumina.AddIn.Cache.Get(storageKey),profileObj.data):null},GetProfilePictureCacheKey=function(userName,loggedInUserEmail){return"akumina:pd:profilepic:"+loggedInUserEmail+":"+userName},CacheProfilePic=function(userName,picData,loggedInUserEmail){var profileObj={data:picData,timestamp:(new Date).getTime()},storageKey=GetProfilePictureCacheKey(userName,loggedInUserEmail);Akumina.AddIn.Cache.Set(GetProfilePictureCacheKey(userName,loggedInUserEmail),profileObj,Akumina.AddIn.Constants.DAY_CACHE_EXPIRATION)},IsDataCached=function(storageKey){var isUserDataCached=!1,userObj=Akumina.AddIn.Cache.Get(storageKey);return userObj&&(previous=userObj.timestamp,now=(new Date).getTime(),now-previous>=432e5?(Akumina.AddIn.Cache.Remove(storageKey),isUserDataCached=!1):isUserDataCached=!0),isUserDataCached};_cur.graphConfig={subscriptionId:Akumina.Digispace.ConfigurationContext.GraphSubscriptionId,clientId:Akumina.Digispace.ConfigurationContext.GraphClientId,postLogoutRedirectUri:window.location.origin,endpoints:{graphApiUri:"https://graph.microsoft.com"},cacheLocation:"localStorage"};this.GetProfilePicture=function(userName,loggedInUserEmail,fetchPhotoFromAD){var def=$.Deferred(),authContext;Akumina.AddIn.PeopleDirectoryCommon.Logger.Write("PeopleDirectory_SearchAllUsers.getProfilePicture");var me=this,cachedPic=GetProfilePicFromCache(userName,loggedInUserEmail),picUrlFromSharePoint=_spPageContextInfo.webAbsoluteUrl+"/_layouts/15/userphoto.aspx?size=S&username="+userName;if(cachedPic!=null){if(cachedPic!="")return def.resolve(cachedPic);def.reject("")}return fetchPhotoFromAD!=undefined&&fetchPhotoFromAD!=null&&$.parseJSON(fetchPhotoFromAD.toString().toLowerCase())?(authContext=GetAuthenticationContext(),authContext.acquireToken(_cur.graphConfig.endpoints.graphApiUri,function(error,token){if(!error&&token){var uri=_cur.graphConfig.endpoints.graphApiUri+"/beta/users/"+encodeURIComponent(userName)+"/photo/$value",request=new XMLHttpRequest;request.open("GET",uri);request.setRequestHeader("Authorization","Bearer "+token);request.responseType="blob";request.onload=function(){if(request.readyState===4&&request.status===200){var reader=new FileReader;reader.onload=function(){CacheProfilePic(userName,reader.result,loggedInUserEmail);def.resolve(reader.result)};reader.readAsDataURL(request.response)}else request.readyState===4&&request.status===404&&(CacheProfilePic(userName,"",loggedInUserEmail),def.resolve(""))};request.send(null)}})):def.resolve(picUrlFromSharePoint),def};GetAuthenticationContext=function(){var authContext=new AuthenticationContext(_cur.graphConfig),isCallback=authContext.isCallback(window.location.hash),user;return authContext.handleWindowCallback(),isCallback&&!authContext.getLoginError()&&(window.location=authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST)),user=authContext.getCachedUser(),user?(Akumina.AddIn.Logger.WriteInfoLog("Cached user: "+user.userName),Akumina.AddIn.Logger.WriteInfoLog("Currently logged in as: "+_spPageContextInfo.userLoginName),user.userName.toLowerCase()!=_spPageContextInfo.userLoginName.toLowerCase()&&(Akumina.AddIn.Logger.WriteInfoLog("Clearing token for user: "+user.userName),Akumina.AddIn.Cache.Remove(GetCacheKeyForAuthentication()))):authContext.login(),authContext};GetCacheKeyForAuthentication=function(attribute){var prefix="adal.idtoken";return attribute!=null&&(prefix+=attribute),prefix}});$(document).ready(function(){SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){Akumina.Digispace.Loader.Init(GetSteps())});SP.SOD.executeOrDelayUntilScriptLoaded(function(){},"sp.js")});parseObjectResults=function(row){var o={},appWebUrl;return o.type="object",$(row.Cells.results).each(function(ii,ee){if(ee.Key=="Title")o.title=ee.Value;else if(ee.Key=="SiteID")o.siteId=ee.Value;else if(ee.Key=="WebId")o.webId=ee.Value;else if(ee.Key=="UniqueId")o.uniqueId=ee.Value;else if(ee.Key=="DocId")o.docId=ee.Value;else if(ee.Key=="Rank")o.rank=parseFloat(ee.Value);else if(ee.Key=="Path")o.path=ee.Value;else if(ee.Key=="Author")o.author=ee.Value;else if(ee.Key=="FileExtension")o.ext=ee.Value;else if(ee.Key=="SiteTitle")o.text2=ee.Value;else if(ee.Key=="LastModifiedTime")o.date=ee.Value;else if(ee.Key=="SitePath")o.sitePath=ee.Value;else if(ee.Key=="listid")o.listid=ee.Value;else if(ee.Key=="listitemid")o.id=ee.Value;else if(ee.Key=="SPWebUrl")o.SPWebUrl=ee.Value;else if(ee.Key=="Edges"){var edges=JSON.parse(ee.Value);o.Edges=edges}}),appWebUrl=window.location.protocol+"//"+window.location.host,o.pic=appWebUrl+"/_layouts/15/getpreview.ashx?guidFile="+o.uniqueId+"&guidSite="+o.siteId+"&guidWeb="+o.webId+"&docid="+o.docId+"&ClientType=CodenameOsloWeb&size=small",o};this.InitializeLync=function(){var def=$.Deferred(),config;return Akumina.AddIn.Logger.WriteInfoLog("InitializeLync"),typeof clientLync!="undefined"?def.resolve(clientLync):(config={version:"BuildConference/1.0.0",apiKey:Akumina.Digispace.ConfigurationContext.SkypeApiKey,apiKeyCC:Akumina.Digispace.ConfigurationContext.SkypeApiKeyCC},Skype.initialize({apiKey:config.apiKey},function(api){window.skypeWebAppCtor=api.application;window.skypeWebApp=new api.application;clientLync=window.skypeWebApp;lyncSignIn().then(function(clientLync){def.resolve(clientLync)})},function(err){Akumina.AddIn.Logger.WriteErrorLog(err);alert("Cannot load the SDK.")})),def};subP=[];subM=[];lyncSignIn=function(){var def=$.Deferred();return params={client_id:Akumina.Digispace.ConfigurationContext.GraphClientId,origins:["https://webdir.online.lync.com/autodiscover/autodiscoverservice.svc/root"],cors:!0,version:"SkypeOnlinePreviewApp/1.0.0",redirect_uri:window.location.protocol+"//"+window.location.host+_spPageContextInfo.siteServerRelativeUrl+"/_layouts/15/settings.aspx"},clientLync.signInManager.signIn(params).then(function(){Akumina.AddIn.Logger.WriteInfoLog("Signed in as "+clientLync.personsAndGroupsManager.mePerson.displayName());def.resolve(clientLync)},function(error){def.reject();Akumina.AddIn.Logger.WriteErrorLog(error||"Cannot sign in")}),def};ShippedSteps=ShippedSteps||{};CoreSteps=CoreSteps||{};typeof CoreSteps.FetchDigispaceConfiguration=="undefined"&&(CoreSteps.FetchDigispaceConfiguration={Init:function(){Akumina.Digispace.ConfigurationContext.loadDigispaceConfiguration().then(function(){Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")},function(){Akumina.AddIn.Logger.WriteErrorLog("Error fetching digispace configuration.")})}});typeof CoreSteps.GetLoadingTemplate=="undefined"&&(CoreSteps.GetLoadingTemplate={Init:function(){var loadingTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateCoreFolderName+"/Content/Templates/Core/Loading.html";(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(loadingTemplateUrl,{}).done(function(html){Akumina.Digispace.ConfigurationContext.LoadingTemplateHtml=html;Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")})}});typeof CoreSteps.IndexPageData=="undefined"&&(CoreSteps.IndexPageData={Init:function(){__akPageDataDefer(function(){var siteUrl=document.location.pathname;_spPageContextInfo.webServerRelativeUrl.toLowerCase()+"/"==document.location.pathname.toLowerCase()&&(siteUrl=_spPageContextInfo.webServerRelativeUrl);SP.SOD.executeFunc("sp.js","SP.ClientContext",(new Akumina.AddIn.JsPageData).createItem("PageData_AK",siteUrl,document.title,12))});Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")}});typeof CoreSteps.GetGraphTokenCallback=="undefined"&&(CoreSteps.GetGraphTokenCallback={Init:function(){Akumina.Digispace.ConfigurationContext.EnableAzureAD?CoreSteps.GetGraphTokenCallback.GetGraphToken().then(function(){Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")},function(error){if(error.toLowerCase().indexOf("timeout")>-1){var errormsg="There was a problem communicating with Microsoft Graph: "+error;errormsg+="\nIf this continues to happen for you in IE or Edge browsers Add the following url 'https://login.microsoftonline.com' to IE11 > Internet Options (Security)> Trusted Sites> Sites";errormsg+="\n\nOtherwise, click OK and try again";alert(errormsg);localStorage.clear();window.location.reload(!0)}Akumina.AddIn.Logger.WriteErrorLog(error)}):Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")},GetGraphToken:function(){var def=$.Deferred(),subscriptionId=Akumina.Digispace.ConfigurationContext.GraphSubscriptionId,clientId=Akumina.Digispace.ConfigurationContext.GraphClientId,authContext,isCallback,user;return(subscriptionId==null||clientId==null)&&(Akumina.AddIn.Logger.WriteErrorLog("Subscription id or Client id not found."),def.reject()),authContext=new AuthenticationContext(Akumina.Digispace.UserContext.getGraphConfig()),isCallback=authContext.isCallback(window.location.hash),authContext.handleWindowCallback(),isCallback&&!authContext.getLoginError()&&(window.location=authContext._getItem(authContext.CONSTANTS.STORAGE.LOGIN_REQUEST)),user=authContext.getCachedUser(),user?(Akumina.AddIn.Logger.WriteInfoLog("Found cached token for user: "+user.userName),Akumina.AddIn.Logger.WriteInfoLog("Currently logged in as: "+_spPageContextInfo.userLoginName),user.userName.toLowerCase()!=_spPageContextInfo.userLoginName.toLowerCase()&&(Akumina.AddIn.Logger.WriteInfoLog("Clearing token for user: "+user.userName),localStorage.removeItem(CoreSteps.GetGraphTokenCallback.GetCacheKeyForAuthentication()))):authContext.login(),authContext.acquireToken(Akumina.Digispace.UserContext.getGraphConfig().endpoints.graphApiUri,function(error,token){error||!token?def.reject(error):def.resolve(token)}),def},GetCacheKeyForAuthentication:function(attribute){var prefix="adal.idtoken";return attribute!=null&&(prefix+=attribute),prefix}});typeof CoreSteps.ResumeMainWindowLoader=="undefined"&&(CoreSteps.ResumeMainWindowLoader={Init:function(){Akumina.AddIn.Logger.WriteInfoLog("ResumeMainWindowLoader");parent.CallParentLoaderComplete()}});typeof CoreSteps.FetchUserProperties=="undefined"&&(CoreSteps.FetchUserProperties={Init:function(){Akumina.Digispace.ConfigurationContext.EnableAzureAD?Akumina.Digispace.UserContext.loadDigispaceUserContext().then(function(){Akumina.Digispace.UserContext.loadSharePointUserGroups().done(function(){Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")})},function(){Akumina.AddIn.Logger.WriteErrorLog("Error fetching user properties.")}):(Akumina.Digispace.UserContext.LoginName=_spPageContextInfo.userLoginName,Akumina.Digispace.UserContext.Photo=__getTemplatePrefix()+"/_layouts/15/userphoto.aspx?size=S&username="+Akumina.Digispace.UserContext.LoginName,Akumina.Digispace.UserContext.loadSharePointUserGroups().done(function(){Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")}))}});typeof CoreSteps.SharepointBar=="undefined"&&(CoreSteps.SharepointBar={Init:function(){var showSharepointBar=Akumina.Digispace.Cookie.ReadCookie(Akumina.Digispace.Cookie.GetSharepointBarCookieKey()),args;showSharepointBar=showSharepointBar==="true"||showSharepointBar==null;args={ShowSharepointBar:showSharepointBar,SetCookie:!1};Akumina.Digispace.AppPart.Eventing.Publish("/loader/handlesharepointbar/",args);Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")}});typeof CoreSteps.SetTheme=="undefined"&&(CoreSteps.SetTheme={Init:function(){var theme=Akumina.Digispace.ConfigurationContext.Theme,themeUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateFolderName+"/css/themes/"+theme+".css";(theme==null||theme=="")&&(theme="lightblue");theme&&theme!=""&&$.ajax({url:themeUrl,cache:!0,success:function(css){$('<style type="text/css"><\/style>').html(css).appendTo("head")}});Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")}});typeof CoreSteps.SetInterchangeLoginURL=="undefined"&&(CoreSteps.SetInterchangeLoginURL={appInstances:null,Init:function(){var cachedItem=Akumina.AddIn.Cache.Get(CoreSteps.SetInterchangeLoginURL.GetCacheKey());if(cachedItem&&cachedItem!=null)CoreSteps.SetInterchangeLoginURL.SetContext(cachedItem);else{var context=SP.ClientContext.get_current(),site=context.get_site(),web=site.get_rootWeb();CoreSteps.SetInterchangeLoginURL.appInstances=SP.AppCatalog.getAppInstances(context,web);context.load(CoreSteps.SetInterchangeLoginURL.appInstances);Akumina.AddIn.Logger.logSPCall("CoreSteps.SetInterchangeLoginURL.Init");context.executeQueryAsync(CoreSteps.SetInterchangeLoginURL.Success,CoreSteps.SetInterchangeLoginURL.Error)}},Success:function(){for(var instanceId="INTERCHANGE APP NOT FOUND",list=CoreSteps.SetInterchangeLoginURL.appInstances.getEnumerator(),current,title;list.moveNext();)if(current=list.get_current(),title=current.get_title(),title.toLowerCase().indexOf("akumina")!=-1&&title.toLowerCase().indexOf("interchange")!=-1){instanceId=current.get_id().toString();break}instanceId.toLowerCase().indexOf("not found")==-1?(Akumina.AddIn.Cache.Set(CoreSteps.SetInterchangeLoginURL.GetCacheKey(),instanceId.toString(),CoreSteps.SetInterchangeLoginURL.GetCacheInterval()),CoreSteps.SetInterchangeLoginURL.SetContext(instanceId)):CoreSteps.SetInterchangeLoginURL.SetDefaultContext()},SetDefaultContext:function(){Akumina.Digispace.ConfigurationContext.InterchangeLoginURL=Akumina.Digispace.ConfigurationContext.InterchangeURL;Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")},SetContext:function(instanceid){Akumina.AddIn.Logger.WriteInfoLog(instanceid);Akumina.Digispace.ConfigurationContext.InterchangeLoginURL=__getTemplatePrefix()+"/_layouts/15/appredirect.aspx?instance_id={"+instanceid+"}";Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")},GetCacheKey:function(){return Akumina.Digispace.ConfigurationContext.getCacheKey("interchangeloginurl")},GetCacheInterval:function(){return Akumina.AddIn.Constants.DAY_CACHE_EXPIRATION},Error:function(sender,args){alert(args.get_message())}});typeof CoreSteps.InitializeGenericControls=="undefined"&&(CoreSteps.InitializeGenericControls={Init:function(){initGenericList();initGenericItem();initContentblock();initWeather();initTraffic();initCalendar();initEventDetail();initFinancialData();initRssNews();initPageLayout();initQuickLinks();initDirectory();initCompanyCalendar();initImportantDates();initCreateDiscussion();initDiscussionBoardListing();initDiscussionSummary();initDiscussionThread();initDocumentSummaryList();initForm();initMyForms();initDashboardContainer();initDMS();initAnnouncementItems();initBanner();initPeopleListSearchWidget();initPeopleListWidget();initEmployeeDetail();initDocumentFilter();initDocumentList();Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")}});typeof CoreSteps.DisplayDebugInformation=="undefined"&&(CoreSteps.DisplayDebugInformation={Init:function(){Akumina.Digispace.ConfigurationContext.EnableDebugMode&&(jQuery(document).bind("keydown","ctrl+up",function(){Akumina.AddIn.Utilities.ToggleDebugger()}),jQuery(document).bind("keydown","ctrl+down",function(){Akumina.AddIn.Utilities.ToggleWidgetManager()}));Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")},DisplayDebugPopup:function(){$.magnificPopup.open({items:{src:".debug-popup",type:"inline"},closeOnBgClick:!1,showCloseBtn:!0});$("#refreshCache").unbind().click(function(){localStorage.clear()});$("#refreshTemplateCache").unbind().click(function(){Akumina.Digispace.Loader.clearTemplatesCache()});$("#refreshContentCache").unbind().click(function(){Akumina.Digispace.Loader.clearContentCache()})},GetDebugValueFromUrl:function(){var url=location.href,urltokens=url.split("?"),params,i;if(urltokens.length>1)for(params=urltokens[1].split("="),i=0;i<params.length;i+=2)if(params[i].toLowerCase()=="digi_debug")return JSON.parse(params[i+1].toLowerCase());return!1},GetDigispaceConfigHTML:function(){var items=[];return $.each(Akumina.Digispace.ConfigurationContext,function(key,value){value&&typeof value!="function"&&typeof value!="object"&&items.push({Key:key,Value:value,IsHeading:!1})}),items},GetUserContextHTML:function(userContext,items){return $.each(userContext,function(key,value){value&&typeof value=="object"?($.isArray(value)||key.toString().toLowerCase()!="customproperties"?$.isArray(value)&&key.toString().toLowerCase()=="usergroups"&&items.push({Key:key,Value:"",IsHeading:!0}):items.push({Key:key,Value:"",IsHeading:!0}),items.push({Key:" ",Value:"",IsHeading:!1}),items=CoreSteps.DisplayDebugInformation.GetUserContextHTML(value,items)):items.push({Key:key,Value:value,IsHeading:!1})}),items}});typeof CoreSteps.EventSubscription=="undefined"&&(CoreSteps.EventSubscription={Init:function(){Akumina.Digispace.AppPart.Eventing.Subscribe("/genericlistcontrol/loaded/",CoreSteps.EventSubscription.EventCallback);Akumina.Digispace.AppPart.Eventing.Publish("/loader/eventsubscription/");Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")},EventCallback:function(args){args.callback.toLowerCase()=="showdashboarditems"&&RenderDashboardWidgets()}});typeof CoreSteps.LoadDashboardWidgets=="undefined"&&(CoreSteps.LoadDashboardWidgets={Init:function(){var widgetsManager=new Akumina.Digispace.Data.WidgetManager;widgetsManager.GetDashboardWidgets().then(function(){CoreSteps.LoadDashboardWidgets.GotoNextStep()},function(errormsg){Akumina.AddIn.Logger.WriteErrorLog(errormsg);CoreSteps.LoadDashboardWidgets.GotoNextStep()})},GotoNextStep:function(){Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")}});typeof CoreSteps.AdditionalMarkupStep=="undefined"&&(CoreSteps.AdditionalMarkupStep={Init:function(){var popupTemplateUrl=__getTemplatePrefix()+"/Style%20Library/"+Akumina.Digispace.ConfigurationContext.TemplateCoreFolderName+"/Content/Templates/Core/AdditionalMasterMarkup.html";(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(popupTemplateUrl,{}).done(function(html){$("body").append(html);Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")})}});typeof CoreSteps.DisplayLoader=="undefined"&&(CoreSteps.DisplayLoader={Init:function(){var stepsCached=Akumina.AddIn.Cache.Get(CoreSteps.DisplayLoader.GetCacheKey());(typeof stepsCached=="undefined"||stepsCached==null)&&Akumina.Digispace.AppPart.Eventing.Publish("/loader/showloading/");Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")},GetCacheKey:function(){return Akumina.Digispace.ConfigurationContext.getCacheKey("digispaceloader")}});typeof CoreSteps.InitBottomTray=="undefined"&&(CoreSteps.InitBottomTray={Init:function(){var data={},displayTemplateUrl;data.Buttons=[];data.Buttons.push({Id:"widgetedit",Icon:"fa-pencil"});Akumina.Digispace.ConfigurationContext.EnableDebugMode&&data.Buttons.push({Id:"debug",Icon:"fa-refresh"});displayTemplateUrl=(new Akumina.Digispace.AppPart.Data).Templates.GetCoreTemplate("Tray.html");(new Akumina.Digispace.AppPart.Data).Templates.ParseTemplate(displayTemplateUrl,data).done(function(menuMarkup){$("body").append(menuMarkup);var toggle=$("#ss_toggle"),menu=$("#ss_menu"),rot;$("#ss_toggle").on("click",function(){rot=parseInt($(this).data("rot"))+180;menu.css("transform","rotate("+rot+"deg)");menu.css("webkitTransform","rotate("+rot+"deg)");rot/180%2==0?(toggle.parent().addClass("ss_active"),toggle.addClass("close")):(toggle.parent().removeClass("ss_active"),toggle.removeClass("close"));$(this).data("rot",rot)});menu.on("transitionend webkitTransitionEnd oTransitionEnd",function(){rot/180%2==0?$("#ss_menu div i").addClass("ss_animate"):$("#ss_menu div i").removeClass("ss_animate")})});Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")}});typeof CoreSteps.ValidateInterchangeQueryKey=="undefined"&&(CoreSteps.ValidateInterchangeQueryKey={Init:function(){CoreSteps.ValidateInterchangeQueryKey.Validate()},Validate:function(){var interchangeUrl=Akumina.Digispace.ConfigurationContext.InterchangeURL,interchangeQueryKey=Akumina.Digispace.ConfigurationContext.InterchangeQueryKey;$.ajax({type:"GET",url:interchangeUrl+"/api/connector/validate?interchangeQueryKey="+interchangeQueryKey,xhrFields:{withCredentials:!0}}).done(function(response){response?CoreSteps.ValidateInterchangeQueryKey.GotoNextStep():(Akumina.AddIn.Logger.WriteErrorLog("You have not configured the InterchangeQueryKey"),alert("You have not configured the InterchangeQueryKey. Please configure your Interchange Query Key."))}).fail(function(jqXHR,textStatus,error){Akumina.AddIn.Logger.WriteErrorLog("Error Validating InterchangeQueryKey");Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+error);var errormsg="Error Validating Interchange Query Key. Please configure your Interchange Query Key.";window.navigator.userAgent.indexOf("Edge/")&&(errormsg+="\n\nEdge browser users must perform following actions:",errormsg+="\n1. Add the url '"+window.location.href+"' to IE11 > Internet Options (Security)> Local intranet (Sites)> Advanced",errormsg+="\n2. Ensure that 'Remember my credentials' checkbox is checked when specifying the credentials.");errormsg+="\n\nAll browsers must perform the following action if using a self-signed cert for Interchange or if installed via the Azure Marketplace:";errormsg+="\n3. Please be sure to navigate to the following url to accept the cert: '"+interchangeUrl+"' in a new browser tab";alert(errormsg)})},GotoNextStep:function(){Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")}});typeof CoreSteps.LoadWidgets=="undefined"&&(CoreSteps.LoadWidgets={Init:function(){var widgetHandler=new Akumina.Digispace.Data.WidgetManager;widgetHandler.GetWidgetInstances().then(function(){CoreSteps.LoadWidgets.GotoNextStep()},function(errormsg){Akumina.AddIn.Logger.WriteErrorLog(errormsg);CoreSteps.LoadWidgets.GotoNextStep()})},GotoNextStep:function(){Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")}});typeof CoreSteps.InitializeWidgets=="undefined"&&(CoreSteps.InitializeWidgets={Init:function(){var widgetHandler=new Akumina.Digispace.Data.WidgetManager;widgetHandler.GetWidgetInstances().then(function(items){widgetHandler.InitializeWidgets(items);CoreSteps.InitializeWidgets.GotoNextStep()},function(errormsg){Akumina.AddIn.Logger.WriteErrorLog(errormsg)})},GotoNextStep:function(){Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")}});typeof CoreSteps.AutoClearCache=="undefined"&&(CoreSteps.AutoClearCache={Init:function(){var autoClearStorageKey=CoreSteps.AutoClearCache.GetCacheKey("AutoClearCache"),item=Akumina.AddIn.Cache.Get(autoClearStorageKey),obj;item!=null&&(item.siteAbsoluteUrl!=_spPageContextInfo.siteAbsoluteUrl.toLowerCase()||item.userName!=_spPageContextInfo.userLoginName.toLowerCase())&&(localStorage.clear(),Akumina.AddIn.Logger.WriteInfoLog("Cleared cache for "+item));obj={siteAbsoluteUrl:_spPageContextInfo.siteAbsoluteUrl.toLowerCase(),userName:_spPageContextInfo.userLoginName.toLowerCase()};Akumina.AddIn.Cache.Set(autoClearStorageKey,obj,Akumina.AddIn.Constants.DAY_CACHE_EXPIRATION);Akumina.AddIn.Logger.WriteInfoLog("Initialized cache for"+_spPageContextInfo.siteAbsoluteUrl);Akumina.Digispace.AppPart.Eventing.Publish("/loader/onexecuted/")},GetCacheKey:function(attribute){var prefix="akumina:digispace:";return attribute!=null&&(prefix+=attribute),prefix}});typeof Akumina.AddIn.PageLayoutWidget=="undefined"&&(Akumina.AddIn.PageLayoutWidget=function(){var _cur=this;this.GetPropertyValue=function(requestIn,key,defaultValue){var propertyValue="";for(var prop in requestIn)if(key.toLowerCase()==prop.toLowerCase()){propertyValue=requestIn[prop];break}return propertyValue==undefined||propertyValue.toString().trim()==""?defaultValue:propertyValue};this.SetDefaultsProperties=function(requestIn){var requestOut=requestIn;return requestOut.SenderId=_cur.GetPropertyValue(requestIn,"id",""),requestOut.Container=_cur.GetPropertyValue(requestIn,"container","true"),requestOut.InstructionSet=_cur.GetPropertyValue(requestIn,"instructionset",""),requestOut.ContainerControls=_cur.GetPropertyValue(requestIn,"containercontrols",""),requestOut.CacheInterval=_cur.GetPropertyValue(requestIn,"cacheinterval",""),requestOut};this.Init=function(PageLayoutRequest){_cur.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));_cur.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));_cur.PageLayoutRequest=_cur.SetDefaultsProperties(PageLayoutRequest);_cur.PageLayoutRequest.EditMode=Akumina.AddIn.Utilities.getEditMode();_cur.Prerender()};this.getParam=function(key,val){var utils=Akumina.AddIn.Utilities,ret=utils.getQueryStringParameter(key,val);return utils.IsNullOrEmpty(ret)&&!utils.IsNullOrEmpty(val)?val:ret};this.Prerender=function(){Akumina.Digispace.AppPart.Eventing.Subscribe("/loader/completed/",_cur.GetItem)};this.GetItem=function(){var cachedItems=Akumina.AddIn.Cache.Get(_cur.GetCacheKey(_cur.PageLayoutRequest.SenderId)),instruction;cachedItems&&cachedItems!=null?_cur.Render(cachedItems):(_cur.PageLayoutRequest.PageLayout="",_cur.PageLayoutRequest.ControlsList=null,Akumina.AddIn.Utilities.IsNullOrEmpty(_cur.PageLayoutRequest.Container)&&(_cur.PageLayoutRequest.Container=".large-3"),Akumina.AddIn.Utilities.IsNullOrEmpty(_cur.PageLayoutRequest.Container)&&(_cur.PageLayoutRequest.Container=".large-3"),instruction=new Akumina.AddIn.Instructions,instruction.executeAsync(_cur,_cur.PageLayoutRequest.InstructionSet,"PageLayoutRequest").then(function(result){_cur.appWebUrl=result.appWebUrl;_cur.hostUrl=result.hostUrl;_cur.PageLayoutRequest=result.PageLayoutRequest;_cur.Success()}))};this.Success=function(){var result={},controlListField,controlListValue,i,controlName;for(result.PageLayout=_cur.PageLayoutRequest.PageLayout,controlListField=_cur.PageLayoutRequest.ControlsList,controlListValue=[],i=0;i<controlListField.length;i++)controlName=controlListField[i].get_lookupValue(),controlListValue.push(controlName);controlList=controlListValue.join(",");result.ControlList=controlList;result.Container=_cur.PageLayoutRequest.Container;result.ContainerControls=_cur.PageLayoutRequest.ContainerControls;result.SenderId=_cur.PageLayoutRequest.SenderId;_cur.PageLayoutRequest.EditMode||Akumina.AddIn.Cache.Set(_cur.GetCacheKey(),result,_cur.GetCacheInterval());_cur.Render(result)};this.Error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.GetCacheKey=function(){return Akumina.Digispace.ConfigurationContext.getCacheKey(_cur.PageLayoutRequest.SenderId)};this.GetCacheInterval=function(){return _cur.PageLayoutRequest.CacheInterval&&_cur.PageLayoutRequest.CacheInterval!=null&&!isNaN(_cur.PageLayoutRequest.CacheInterval)?parseInt(_cur.PageLayoutRequest.CacheInterval):Akumina.Digispace.ConfigurationContext.CachingStrategyInterval};this.Render=function(data){var options={pagelayout:data.PageLayout,controllist:data.ControlList,container:data.Container,containercontrols:data.ContainerControls},controlOptions={apppart:!1,UniqueId:data.SenderId,options:options},iaPageDetail=new Akumina.AppParts.PageDetail(controlOptions)}});Akumina===undefined&&(Akumina={});Akumina.AppParts===undefined&&(Akumina.AppParts={});Akumina.AppParts.PageDetail===undefined&&(Akumina.AppParts.PageDetail=function(options){var me=this;this.uniqueId="";this.Init=function(options){var me=this,senderId,messageData,inDesignMode;this.uniqueId=options.UniqueId;this.pagelayout=options.options.pagelayout;this.controllist=options.options.controllist;senderId=this.uniqueId;messageData={};messageData.container=options.options.container?options.options.container:".large-3";messageData.containercontrols=options.options.containercontrols?options.options.containercontrols:"div.ms-WPBody";Akumina.AddIn.Logger.WriteInfoLog("Order: "+this.controllist);messageData.controllist=this.controllist.split(",");messageData.startindex=0;messageData.pagelayout=this.pagelayout;inDesignMode=Akumina.Digispace.SiteContext.IsInDesignMode();inDesignMode!="1"&&me.AlterPageLayout(messageData)};this.AlterPageLayout=function(messageData){var controlContainer=messageData.container,containerControls=messageData.containercontrols,controlList=messageData.controllist,startIndex=messageData.startindex,pagelayout=messageData.pagelayout,containers,controlClassList,i,controlIndex,checkControlName,thisControl,thisControlPos;switch(pagelayout.toLowerCase()){case"2 column right focus":case"twocolumnrightfocus":$(".large-9").css({float:"right"});$(".large-3").removeClass("columns-no-padding");break;case"1 column":case"onecolumn":$(".large-3").hide();$(".large-9").removeClass("large-push-3");$(".large-9").removeClass("columns-no-padding");$(".large-3").removeClass("large-pull-9");$(".large-9").addClass("large-12");$(".large-9").removeClass("large-9")}for(containers=$(controlContainer+" "+containerControls),$(containers).hide(),j=0;j<containers.length;j++){var thisControl=$(containers)[j],controlName="",akControl=$(thisControl).find(".ak-controls");if($(akControl).length>0){for(controlClassList=$(akControl).attr("class").split(" "),i=0;i<controlClassList.length;i++)if(controlClassList[i].indexOf("ak-")>-1&&controlClassList[i]!="ak-controls"){controlName=controlClassList[i].replace("ak-","").replace("-control","").replace("-widget","");break}for(controlIndex=-1,i=0;i<controlList.length;i++)checkControlName=controlList[i].replace(/ /g,"").toLowerCase(),controlName==checkControlName&&(controlIndex=i);controlIndex>-1&&$(thisControl).data("position",controlIndex)}}for(i=controlList.length-1;i>=0;i--)for(containers=$(controlContainer+" "+containerControls),j=0;j<containers.length;j++)if(thisControl=$(containers)[j],thisControlPos=$(thisControl).data("position"),thisControlPos==i){Akumina.AddIn.Logger.WriteInfoLog(controlList[i]+" - position "+thisControlPos);$(thisControl).insertBefore($(containers)[0]);$(thisControl).show();break}};this.Init(options)});
/*!
 * pickadate.js v3.5.3, 2014/07/12
 * By Amsul, http://amsul.ca
 * Hosted on http://amsul.github.io/pickadate.js
 * Licensed under MIT
 */
(function(factory){typeof define=="function"&&define.amd?define("picker",["jquery"],factory):typeof exports=="object"?module.exports=factory(require("jquery")):this.Picker=factory(jQuery)})(function($){function PickerConstructor(ELEMENT,NAME,COMPONENT,OPTIONS){function createWrappedComponent(){return PickerConstructor._.node("div",PickerConstructor._.node("div",PickerConstructor._.node("div",PickerConstructor._.node("div",P.component.nodes(STATE.open),CLASSES.box),CLASSES.wrap),CLASSES.frame),CLASSES.holder)}function prepareElement(){$ELEMENT.data(NAME,P).addClass(CLASSES.input).val($ELEMENT.data("value")?P.get("select",SETTINGS.format):ELEMENT.value).on("focus."+STATE.id+" click."+STATE.id,focusToOpen);if(!SETTINGS.editable)$ELEMENT.on("keydown."+STATE.id,function(event){var keycode=event.keyCode,isKeycodeDelete=/^(8|46)$/.test(keycode);if(keycode==27)return P.close(),!1;(keycode==32||isKeycodeDelete||!STATE.open&&P.component.key[keycode])&&(event.preventDefault(),event.stopPropagation(),isKeycodeDelete?P.clear().close():P.open())});aria(ELEMENT,{haspopup:!0,expanded:!1,readonly:!1,owns:ELEMENT.id+"_root"+(P._hidden?" "+P._hidden.id:"")})}function prepareElementRoot(){P.$root.on({focusin:function(event){P.$root.removeClass(CLASSES.focused);event.stopPropagation()},"mousedown click":function(event){var target=event.target;target!=P.$root.children()[0]&&(event.stopPropagation(),event.type!="mousedown"||$(target).is(":input")||target.nodeName=="OPTION"||(event.preventDefault(),ELEMENT.focus()))}}).on("click","[data-pick], [data-nav], [data-clear]",function(){var $target=$(this),targetData=$target.data(),targetDisabled=$target.hasClass(CLASSES.navDisabled)||$target.hasClass(CLASSES.disabled),activeElement=document.activeElement;activeElement=activeElement&&(activeElement.type||activeElement.href)&&activeElement;(targetDisabled||activeElement&&!$.contains(P.$root[0],activeElement))&&ELEMENT.focus();targetData.nav&&!targetDisabled?P.set("highlight",P.component.item.highlight,{nav:targetData.nav}):PickerConstructor._.isInteger(targetData.pick)&&!targetDisabled?P.set("select",targetData.pick).close(!0):targetData.clear&&P.clear().close(!0)}).on("click","[data-close]",function(){P.close(!0)});aria(P.$root[0],"hidden",!0)}function prepareElementHidden(){var name;SETTINGS.hiddenName===!0?(name=ELEMENT.name,ELEMENT.name=""):(name=[typeof SETTINGS.hiddenPrefix=="string"?SETTINGS.hiddenPrefix:"",typeof SETTINGS.hiddenSuffix=="string"?SETTINGS.hiddenSuffix:"_submit"],name=name[0]+ELEMENT.name+name[1]);P._hidden=$('<input type=hidden name="'+name+'"'+(ELEMENT.id?'id="'+ELEMENT.id+'_hidden"':"")+($ELEMENT.data("value")||ELEMENT.value?' value="'+P.get("select",SETTINGS.formatSubmit)+'"':"")+">")[0];$ELEMENT.on("change."+STATE.id,function(){P._hidden.value=ELEMENT.value?P.get("select",SETTINGS.formatSubmit):""}).after(P._hidden)}function focusToOpen(event){event.stopPropagation();event.type=="focus"&&P.$root.addClass(CLASSES.focused);P.open()}if(!ELEMENT)return PickerConstructor;var IS_DEFAULT_THEME=!1,STATE={id:ELEMENT.id||"P"+Math.abs(~~(Math.random()*new Date))},SETTINGS=COMPONENT?$.extend(!0,{},COMPONENT.defaults,OPTIONS):OPTIONS||{},CLASSES=$.extend({},PickerConstructor.klasses(),SETTINGS.klass),$ELEMENT=$(ELEMENT),PickerInstance=function(){return this.start()},P=PickerInstance.prototype={constructor:PickerInstance,$node:$ELEMENT,start:function(){if(STATE&&STATE.start)return P;STATE.methods={};STATE.start=!0;STATE.open=!1;STATE.type=ELEMENT.type;ELEMENT.autofocus=ELEMENT==document.activeElement;ELEMENT.readOnly=!SETTINGS.editable;ELEMENT.id=ELEMENT.id||STATE.id;ELEMENT.type!="text"&&(ELEMENT.type="text");P.component=new COMPONENT(P,SETTINGS);P.$root=$(PickerConstructor._.node("div",createWrappedComponent(),CLASSES.picker,'id="'+ELEMENT.id+'_root"'));prepareElementRoot();SETTINGS.formatSubmit&&prepareElementHidden();prepareElement();SETTINGS.container?$(SETTINGS.container).append(P.$root):$ELEMENT.after(P.$root);P.on({start:P.component.onStart,render:P.component.onRender,stop:P.component.onStop,open:P.component.onOpen,close:P.component.onClose,set:P.component.onSet}).on({start:SETTINGS.onStart,render:SETTINGS.onRender,stop:SETTINGS.onStop,open:SETTINGS.onOpen,close:SETTINGS.onClose,set:SETTINGS.onSet});return IS_DEFAULT_THEME=isUsingDefaultTheme(P.$root.children()[0]),ELEMENT.autofocus&&P.open(),P.trigger("start").trigger("render")},render:function(entireComponent){return entireComponent?P.$root.html(createWrappedComponent()):P.$root.find("."+CLASSES.box).html(P.component.nodes(STATE.open)),P.trigger("render")},stop:function(){return STATE.start?(P.close(),P._hidden&&P._hidden.parentNode.removeChild(P._hidden),P.$root.remove(),$ELEMENT.removeClass(CLASSES.input).removeData(NAME),setTimeout(function(){$ELEMENT.off("."+STATE.id)},0),ELEMENT.type=STATE.type,ELEMENT.readOnly=!1,P.trigger("stop"),STATE.methods={},STATE.start=!1,P):P},open:function(dontGiveFocus){if(STATE.open)return P;if($ELEMENT.addClass(CLASSES.active),aria(ELEMENT,"expanded",!0),setTimeout(function(){P.$root.addClass(CLASSES.opened);aria(P.$root[0],"hidden",!1)},0),dontGiveFocus!==!1){STATE.open=!0;IS_DEFAULT_THEME&&$html.css("overflow","hidden").css("padding-right","+="+getScrollbarWidth());$ELEMENT.trigger("focus");$document.on("click."+STATE.id+" focusin."+STATE.id,function(event){var target=event.target;target!=ELEMENT&&target!=document&&event.which!=3&&P.close(target===P.$root.children()[0])}).on("keydown."+STATE.id,function(event){var keycode=event.keyCode,keycodeToMove=P.component.key[keycode],target=event.target;keycode==27?P.close(!0):target==ELEMENT&&(keycodeToMove||keycode==13)?(event.preventDefault(),keycodeToMove?PickerConstructor._.trigger(P.component.key.go,P,[PickerConstructor._.trigger(keycodeToMove)]):P.$root.find("."+CLASSES.highlighted).hasClass(CLASSES.disabled)||P.set("select",P.component.item.highlight).close()):$.contains(P.$root[0],target)&&keycode==13&&(event.preventDefault(),target.click())})}return P.trigger("open")},close:function(giveFocus){return(giveFocus&&($ELEMENT.off("focus."+STATE.id).trigger("focus"),setTimeout(function(){$ELEMENT.on("focus."+STATE.id,focusToOpen)},0)),$ELEMENT.removeClass(CLASSES.active),aria(ELEMENT,"expanded",!1),setTimeout(function(){P.$root.removeClass(CLASSES.opened+" "+CLASSES.focused);aria(P.$root[0],"hidden",!0)},0),!STATE.open)?P:(STATE.open=!1,IS_DEFAULT_THEME&&$html.css("overflow","").css("padding-right","-="+getScrollbarWidth()),$document.off("."+STATE.id),P.trigger("close"))},clear:function(options){return P.set("clear",null,options)},set:function(thing,value,options){var thingItem,thingValue,thingIsObject=$.isPlainObject(thing),thingObject=thingIsObject?thing:{};if(options=thingIsObject&&$.isPlainObject(value)?value:options||{},thing){thingIsObject||(thingObject[thing]=value);for(thingItem in thingObject)thingValue=thingObject[thingItem],thingItem in P.component.item&&(thingValue===undefined&&(thingValue=null),P.component.set(thingItem,thingValue,options)),(thingItem=="select"||thingItem=="clear")&&$ELEMENT.val(thingItem=="clear"?"":P.get(thingItem,SETTINGS.format)).trigger("change");P.render()}return options.muted?P:P.trigger("set",thingObject)},get:function(thing,format){if(thing=thing||"value",STATE[thing]!=null)return STATE[thing];if(thing=="value")return ELEMENT.value;if(thing in P.component.item){if(typeof format=="string"){var thingValue=P.component.get(thing);return thingValue?PickerConstructor._.trigger(P.component.formats.toString,P.component,[format,thingValue]):""}return P.component.get(thing)}},on:function(thing,method,internal){var thingName,thingMethod,thingIsObject=$.isPlainObject(thing),thingObject=thingIsObject?thing:{};if(thing){thingIsObject||(thingObject[thing]=method);for(thingName in thingObject)thingMethod=thingObject[thingName],internal&&(thingName="_"+thingName),STATE.methods[thingName]=STATE.methods[thingName]||[],STATE.methods[thingName].push(thingMethod)}return P},off:function(){var i,thingName,names=arguments;for(i=0,namesCount=names.length;i<namesCount;i+=1)thingName=names[i],thingName in STATE.methods&&delete STATE.methods[thingName];return P},trigger:function(name,data){var _trigger=function(name){var methodList=STATE.methods[name];methodList&&methodList.map(function(method){PickerConstructor._.trigger(method,P,[data])})};return _trigger("_"+name),_trigger(name),P}};return new PickerInstance}function isUsingDefaultTheme(element){var theme,prop="position";return element.currentStyle?theme=element.currentStyle[prop]:window.getComputedStyle&&(theme=getComputedStyle(element)[prop]),theme=="fixed"}function getScrollbarWidth(){var $outer,widthWithoutScroll,$inner,widthWithScroll;return $html.height()<=$window.height()?0:($outer=$('<div style="visibility:hidden;width:100px" />').appendTo("body"),widthWithoutScroll=$outer[0].offsetWidth,$outer.css("overflow","scroll"),$inner=$('<div style="width:100%" />').appendTo($outer),widthWithScroll=$inner[0].offsetWidth,$outer.remove(),widthWithoutScroll-widthWithScroll)}function aria(element,attribute,value){if($.isPlainObject(attribute))for(var key in attribute)ariaSet(element,key,attribute[key]);else ariaSet(element,attribute,value)}function ariaSet(element,attribute,value){element.setAttribute((attribute=="role"?"":"aria-")+attribute,value)}function ariaAttr(attribute,data){var key,attr,attrVal;$.isPlainObject(attribute)||(attribute={attribute:data});data="";for(key in attribute)attr=(key=="role"?"":"aria-")+key,attrVal=attribute[key],data+=attrVal==null?"":attr+'="'+attribute[key]+'"';return data}var $window=$(window),$document=$(document),$html=$(document.documentElement);return PickerConstructor.klasses=function(prefix){return prefix=prefix||"picker",{picker:prefix,opened:prefix+"--opened",focused:prefix+"--focused",input:prefix+"__input",active:prefix+"__input--active",holder:prefix+"__holder",frame:prefix+"__frame",wrap:prefix+"__wrap",box:prefix+"__box"}},PickerConstructor._={group:function(groupObject){for(var loopObjectScope,nodesList="",counter=PickerConstructor._.trigger(groupObject.min,groupObject);counter<=PickerConstructor._.trigger(groupObject.max,groupObject,[counter]);counter+=groupObject.i)loopObjectScope=PickerConstructor._.trigger(groupObject.item,groupObject,[counter]),nodesList+=PickerConstructor._.node(groupObject.node,loopObjectScope[0],loopObjectScope[1],loopObjectScope[2]);return nodesList},node:function(wrapper,item,klass,attribute){return item?(item=$.isArray(item)?item.join(""):item,klass=klass?' class="'+klass+'"':"",attribute=attribute?" "+attribute:"","<"+wrapper+klass+attribute+">"+item+"<\/"+wrapper+">"):""},lead:function(number){return(number<10?"0":"")+number},trigger:function(callback,scope,args){return typeof callback=="function"?callback.apply(scope,args||[]):callback},digits:function(string){return/\d/.test(string[1])?2:1},isDate:function(value){return{}.toString.call(value).indexOf("Date")>-1&&this.isInteger(value.getDate())},isInteger:function(value){return{}.toString.call(value).indexOf("Number")>-1&&value%1==0},ariaAttr:ariaAttr},PickerConstructor.extend=function(name,Component){$.fn[name]=function(options,action){var componentData=this.data(name);return options=="picker"?componentData:componentData&&typeof options=="string"?PickerConstructor._.trigger(componentData[options],componentData,[action]):this.each(function(){var $this=$(this);$this.data(name)||new PickerConstructor(this,name,Component,options)})};$.fn[name].defaults=Component.defaults},PickerConstructor});
/*!
 * Date picker for pickadate.js v3.5.3
 * http://amsul.github.io/pickadate.js/date.htm
 */
(function(factory){typeof define=="function"&&define.amd?define(["picker","jquery"],factory):typeof exports=="object"?module.exports=factory(require("./picker.js"),require("jquery")):factory(Picker,jQuery)})(function(Picker,$){function DatePicker(picker,settings){var calendar=this,element=picker.$node[0],elementValue=element.value,elementDataValue=picker.$node.data("value"),valueString=elementDataValue||elementValue,formatString=elementDataValue?settings.formatSubmit:settings.format,isRTL=function(){return element.currentStyle?element.currentStyle.direction=="rtl":getComputedStyle(picker.$root[0]).direction=="rtl"};calendar.settings=settings;calendar.$node=picker.$node;calendar.queue={min:"measure create",max:"measure create",now:"now create",select:"parse create validate",highlight:"parse navigate create validate",view:"parse create validate viewset",disable:"deactivate",enable:"activate"};calendar.item={};calendar.item.clear=null;calendar.item.disable=(settings.disable||[]).slice(0);calendar.item.enable=-function(collectionDisabled){return collectionDisabled[0]===!0?collectionDisabled.shift():-1}(calendar.item.disable);calendar.set("min",settings.min).set("max",settings.max).set("now");valueString?calendar.set("select",valueString,{format:formatString}):calendar.set("select",null).set("highlight",calendar.item.now);calendar.key={40:7,38:-7,39:function(){return isRTL()?-1:1},37:function(){return isRTL()?1:-1},go:function(timeChange){var highlightedObject=calendar.item.highlight,targetDate=new Date(highlightedObject.year,highlightedObject.month,highlightedObject.date+timeChange);calendar.set("highlight",[targetDate.getFullYear(),targetDate.getMonth(),targetDate.getDate()],{interval:timeChange});this.render()}};picker.on("render",function(){picker.$root.find("."+settings.klass.selectMonth).on("change",function(){var value=this.value;value&&(picker.set("highlight",[picker.get("view").year,value,picker.get("highlight").date]),picker.$root.find("."+settings.klass.selectMonth).trigger("focus"))});picker.$root.find("."+settings.klass.selectYear).on("change",function(){var value=this.value;value&&(picker.set("highlight",[value,picker.get("view").month,picker.get("highlight").date]),picker.$root.find("."+settings.klass.selectYear).trigger("focus"))})},1).on("open",function(){var includeToday="";calendar.disabled(calendar.get("now"))&&(includeToday=":not(."+settings.klass.buttonToday+")");picker.$root.find("button"+includeToday+", select").attr("disabled",!1)},1).on("close",function(){picker.$root.find("button, select").attr("disabled",!0)},1)}var DAYS_IN_WEEK=7,WEEKS_IN_CALENDAR=6,_=Picker._;DatePicker.prototype.set=function(type,value,options){var calendar=this,calendarItem=calendar.item;return value===null?(type=="clear"&&(type="select"),calendarItem[type]=value,calendar):(calendarItem[type=="enable"?"disable":type=="flip"?"enable":type]=calendar.queue[type].split(" ").map(function(method){return value=calendar[method](type,value,options)}).pop(),type=="select"?calendar.set("highlight",calendarItem.select,options):type=="highlight"?calendar.set("view",calendarItem.highlight,options):type.match(/^(flip|min|max|disable|enable)$/)&&(calendarItem.select&&calendar.disabled(calendarItem.select)&&calendar.set("select",calendarItem.select,options),calendarItem.highlight&&calendar.disabled(calendarItem.highlight)&&calendar.set("highlight",calendarItem.highlight,options)),calendar)};DatePicker.prototype.get=function(type){return this.item[type]};DatePicker.prototype.create=function(type,value,options){var isInfiniteValue,calendar=this;return value=value===undefined?type:value,value==-Infinity||value==Infinity?isInfiniteValue=value:$.isPlainObject(value)&&_.isInteger(value.pick)?value=value.obj:$.isArray(value)?(value=new Date(value[0],value[1],value[2]),value=_.isDate(value)?value:calendar.create().obj):value=_.isInteger(value)||_.isDate(value)?calendar.normalize(new Date(value),options):calendar.now(type,value,options),{year:isInfiniteValue||value.getFullYear(),month:isInfiniteValue||value.getMonth(),date:isInfiniteValue||value.getDate(),day:isInfiniteValue||value.getDay(),obj:isInfiniteValue||value,pick:isInfiniteValue||value.getTime()}};DatePicker.prototype.createRange=function(from,to){var calendar=this,createDate=function(date){return date===!0||$.isArray(date)||_.isDate(date)?calendar.create(date):date};return _.isInteger(from)||(from=createDate(from)),_.isInteger(to)||(to=createDate(to)),_.isInteger(from)&&$.isPlainObject(to)?from=[to.year,to.month,to.date+from]:_.isInteger(to)&&$.isPlainObject(from)&&(to=[from.year,from.month,from.date+to]),{from:createDate(from),to:createDate(to)}};DatePicker.prototype.withinRange=function(range,dateUnit){return range=this.createRange(range.from,range.to),dateUnit.pick>=range.from.pick&&dateUnit.pick<=range.to.pick};DatePicker.prototype.overlapRanges=function(one,two){var calendar=this;return one=calendar.createRange(one.from,one.to),two=calendar.createRange(two.from,two.to),calendar.withinRange(one,two.from)||calendar.withinRange(one,two.to)||calendar.withinRange(two,one.from)||calendar.withinRange(two,one.to)};DatePicker.prototype.now=function(type,value,options){return value=new Date,options&&options.rel&&value.setDate(value.getDate()+options.rel),this.normalize(value,options)};DatePicker.prototype.navigate=function(type,value,options){var targetDateObject,targetYear,targetMonth,targetDate,isTargetArray=$.isArray(value),isTargetObject=$.isPlainObject(value),viewsetObject=this.item.view;if(isTargetArray||isTargetObject){for(isTargetObject?(targetYear=value.year,targetMonth=value.month,targetDate=value.date):(targetYear=+value[0],targetMonth=+value[1],targetDate=+value[2]),options&&options.nav&&viewsetObject&&viewsetObject.month!==targetMonth&&(targetYear=viewsetObject.year,targetMonth=viewsetObject.month),targetDateObject=new Date(targetYear,targetMonth+(options&&options.nav?options.nav:0),1),targetYear=targetDateObject.getFullYear(),targetMonth=targetDateObject.getMonth();new Date(targetYear,targetMonth,targetDate).getMonth()!==targetMonth;)targetDate-=1;value=[targetYear,targetMonth,targetDate]}return value};DatePicker.prototype.normalize=function(value){return value.setHours(0,0,0,0),value};DatePicker.prototype.measure=function(type,value){var calendar=this;return value?typeof value=="string"?value=calendar.parse(type,value):_.isInteger(value)&&(value=calendar.now(type,value,{rel:value})):value=type=="min"?-Infinity:Infinity,value};DatePicker.prototype.viewset=function(type,dateObject){return this.create([dateObject.year,dateObject.month,1])};DatePicker.prototype.validate=function(type,dateObject,options){var calendar=this,originalDateObject=dateObject,interval=options&&options.interval?options.interval:1,isFlippedBase=calendar.item.enable===-1,hasEnabledBeforeTarget,hasEnabledAfterTarget,minLimitObject=calendar.item.min,maxLimitObject=calendar.item.max,reachedMin,reachedMax,hasEnabledWeekdays=isFlippedBase&&calendar.item.disable.filter(function(value){if($.isArray(value)){var dateTime=calendar.create(value).pick;dateTime<dateObject.pick?hasEnabledBeforeTarget=!0:dateTime>dateObject.pick&&(hasEnabledAfterTarget=!0)}return _.isInteger(value)}).length;if((!options||!options.nav)&&(!isFlippedBase&&calendar.disabled(dateObject)||isFlippedBase&&calendar.disabled(dateObject)&&(hasEnabledWeekdays||hasEnabledBeforeTarget||hasEnabledAfterTarget)||!isFlippedBase&&(dateObject.pick<=minLimitObject.pick||dateObject.pick>=maxLimitObject.pick)))for(isFlippedBase&&!hasEnabledWeekdays&&(!hasEnabledAfterTarget&&interval>0||!hasEnabledBeforeTarget&&interval<0)&&(interval*=-1);calendar.disabled(dateObject);){if(Math.abs(interval)>1&&(dateObject.month<originalDateObject.month||dateObject.month>originalDateObject.month)&&(dateObject=originalDateObject,interval=interval>0?1:-1),dateObject.pick<=minLimitObject.pick?(reachedMin=!0,interval=1,dateObject=calendar.create([minLimitObject.year,minLimitObject.month,minLimitObject.date+(dateObject.pick===minLimitObject.pick?0:-1)])):dateObject.pick>=maxLimitObject.pick&&(reachedMax=!0,interval=-1,dateObject=calendar.create([maxLimitObject.year,maxLimitObject.month,maxLimitObject.date+(dateObject.pick===maxLimitObject.pick?0:1)])),reachedMin&&reachedMax)break;dateObject=calendar.create([dateObject.year,dateObject.month,dateObject.date+interval])}return dateObject};DatePicker.prototype.disabled=function(dateToVerify){var calendar=this,isDisabledMatch=calendar.item.disable.filter(function(dateToDisable){return _.isInteger(dateToDisable)?dateToVerify.day===(calendar.settings.firstDay?dateToDisable:dateToDisable-1)%7:$.isArray(dateToDisable)||_.isDate(dateToDisable)?dateToVerify.pick===calendar.create(dateToDisable).pick:$.isPlainObject(dateToDisable)?calendar.withinRange(dateToDisable,dateToVerify):void 0});return isDisabledMatch=isDisabledMatch.length&&!isDisabledMatch.filter(function(dateToDisable){return $.isArray(dateToDisable)&&dateToDisable[3]=="inverted"||$.isPlainObject(dateToDisable)&&dateToDisable.inverted}).length,calendar.item.enable===-1?!isDisabledMatch:isDisabledMatch||dateToVerify.pick<calendar.item.min.pick||dateToVerify.pick>calendar.item.max.pick};DatePicker.prototype.parse=function(type,value,options){var calendar=this,parsingObject={};return!value||typeof value!="string"?value:(options&&options.format||(options=options||{},options.format=calendar.settings.format),calendar.formats.toArray(options.format).map(function(label){var formattingLabel=calendar.formats[label],formatLength=formattingLabel?_.trigger(formattingLabel,calendar,[value,parsingObject]):label.replace(/^!/,"").length;formattingLabel&&(parsingObject[label]=value.substr(0,formatLength));value=value.substr(formatLength)}),[parsingObject.yyyy||parsingObject.yy,+(parsingObject.mm||parsingObject.m)-1,parsingObject.dd||parsingObject.d])};DatePicker.prototype.formats=function(){function getWordLengthFromCollection(string,collection,dateObject){var word=string.match(/\w+/)[0];return dateObject.mm||dateObject.m||(dateObject.m=collection.indexOf(word)+1),word.length}function getFirstWordLength(string){return string.match(/\w+/)[0].length}return{d:function(string,dateObject){return string?_.digits(string):dateObject.date},dd:function(string,dateObject){return string?2:_.lead(dateObject.date)},ddd:function(string,dateObject){return string?getFirstWordLength(string):this.settings.weekdaysShort[dateObject.day]},dddd:function(string,dateObject){return string?getFirstWordLength(string):this.settings.weekdaysFull[dateObject.day]},m:function(string,dateObject){return string?_.digits(string):dateObject.month+1},mm:function(string,dateObject){return string?2:_.lead(dateObject.month+1)},mmm:function(string,dateObject){var collection=this.settings.monthsShort;return string?getWordLengthFromCollection(string,collection,dateObject):collection[dateObject.month]},mmmm:function(string,dateObject){var collection=this.settings.monthsFull;return string?getWordLengthFromCollection(string,collection,dateObject):collection[dateObject.month]},yy:function(string,dateObject){return string?2:(""+dateObject.year).slice(2)},yyyy:function(string,dateObject){return string?4:dateObject.year},toArray:function(formatString){return formatString.split(/(d{1,4}|m{1,4}|y{4}|yy|!.)/g)},toString:function(formatString,itemObject){var calendar=this;return calendar.formats.toArray(formatString).map(function(label){return _.trigger(calendar.formats[label],calendar,[0,itemObject])||label.replace(/^!/,"")}).join("")}}}();DatePicker.prototype.isDateExact=function(one,two){var calendar=this;return _.isInteger(one)&&_.isInteger(two)||typeof one=="boolean"&&typeof two=="boolean"?one===two:(_.isDate(one)||$.isArray(one))&&(_.isDate(two)||$.isArray(two))?calendar.create(one).pick===calendar.create(two).pick:$.isPlainObject(one)&&$.isPlainObject(two)?calendar.isDateExact(one.from,two.from)&&calendar.isDateExact(one.to,two.to):!1};DatePicker.prototype.isDateOverlap=function(one,two){var calendar=this,firstDay=calendar.settings.firstDay?1:0;return _.isInteger(one)&&(_.isDate(two)||$.isArray(two))?(one=one%7+firstDay,one===calendar.create(two).day+1):_.isInteger(two)&&(_.isDate(one)||$.isArray(one))?(two=two%7+firstDay,two===calendar.create(one).day+1):$.isPlainObject(one)&&$.isPlainObject(two)?calendar.overlapRanges(one,two):!1};DatePicker.prototype.flipEnable=function(val){var itemObject=this.item;itemObject.enable=val||(itemObject.enable==-1?1:-1)};DatePicker.prototype.deactivate=function(type,datesToDisable){var calendar=this,disabledItems=calendar.item.disable.slice(0);return datesToDisable=="flip"?calendar.flipEnable():datesToDisable===!1?(calendar.flipEnable(1),disabledItems=[]):datesToDisable===!0?(calendar.flipEnable(-1),disabledItems=[]):datesToDisable.map(function(unitToDisable){for(var matchFound,index=0;index<disabledItems.length;index+=1)if(calendar.isDateExact(unitToDisable,disabledItems[index])){matchFound=!0;break}matchFound||(_.isInteger(unitToDisable)||_.isDate(unitToDisable)||$.isArray(unitToDisable)||$.isPlainObject(unitToDisable)&&unitToDisable.from&&unitToDisable.to)&&disabledItems.push(unitToDisable)}),disabledItems};DatePicker.prototype.activate=function(type,datesToEnable){var calendar=this,disabledItems=calendar.item.disable,disabledItemsCount=disabledItems.length;return datesToEnable=="flip"?calendar.flipEnable():datesToEnable===!0?(calendar.flipEnable(1),disabledItems=[]):datesToEnable===!1?(calendar.flipEnable(-1),disabledItems=[]):datesToEnable.map(function(unitToEnable){for(var matchFound,disabledUnit,isExactRange,index=0;index<disabledItemsCount;index+=1)if(disabledUnit=disabledItems[index],calendar.isDateExact(disabledUnit,unitToEnable)){matchFound=disabledItems[index]=null;isExactRange=!0;break}else if(calendar.isDateOverlap(disabledUnit,unitToEnable)){$.isPlainObject(unitToEnable)?(unitToEnable.inverted=!0,matchFound=unitToEnable):$.isArray(unitToEnable)?(matchFound=unitToEnable,matchFound[3]||matchFound.push("inverted")):_.isDate(unitToEnable)&&(matchFound=[unitToEnable.getFullYear(),unitToEnable.getMonth(),unitToEnable.getDate(),"inverted"]);break}if(matchFound)for(index=0;index<disabledItemsCount;index+=1)if(calendar.isDateExact(disabledItems[index],unitToEnable)){disabledItems[index]=null;break}if(isExactRange)for(index=0;index<disabledItemsCount;index+=1)if(calendar.isDateOverlap(disabledItems[index],unitToEnable)){disabledItems[index]=null;break}matchFound&&disabledItems.push(matchFound)}),disabledItems.filter(function(val){return val!=null})};DatePicker.prototype.nodes=function(isOpen){var calendar=this,settings=calendar.settings,calendarItem=calendar.item,nowObject=calendarItem.now,selectedObject=calendarItem.select,highlightedObject=calendarItem.highlight,viewsetObject=calendarItem.view,disabledCollection=calendarItem.disable,minLimitObject=calendarItem.min,maxLimitObject=calendarItem.max,tableHead=function(collection,fullCollection){return settings.firstDay&&(collection.push(collection.shift()),fullCollection.push(fullCollection.shift())),_.node("thead",_.node("tr",_.group({min:0,max:DAYS_IN_WEEK-1,i:1,node:"th",item:function(counter){return[collection[counter],settings.klass.weekdays,'scope=col title="'+fullCollection[counter]+'"']}})))}((settings.showWeekdaysFull?settings.weekdaysFull:settings.weekdaysShort).slice(0),settings.weekdaysFull.slice(0)),createMonthNav=function(next){return _.node("div"," ",settings.klass["nav"+(next?"Next":"Prev")]+(next&&viewsetObject.year>=maxLimitObject.year&&viewsetObject.month>=maxLimitObject.month||!next&&viewsetObject.year<=minLimitObject.year&&viewsetObject.month<=minLimitObject.month?" "+settings.klass.navDisabled:""),"data-nav="+(next||-1)+" "+_.ariaAttr({role:"button",controls:calendar.$node[0].id+"_table"})+' title="'+(next?settings.labelMonthNext:settings.labelMonthPrev)+'"')},createMonthLabel=function(){var monthsCollection=settings.showMonthsShort?settings.monthsShort:settings.monthsFull;return settings.selectMonths?_.node("select",_.group({min:0,max:11,i:1,node:"option",item:function(loopedMonth){return[monthsCollection[loopedMonth],0,"value="+loopedMonth+(viewsetObject.month==loopedMonth?" selected":"")+(viewsetObject.year==minLimitObject.year&&loopedMonth<minLimitObject.month||viewsetObject.year==maxLimitObject.year&&loopedMonth>maxLimitObject.month?" disabled":"")]}}),settings.klass.selectMonth,(isOpen?"":"disabled")+" "+_.ariaAttr({controls:calendar.$node[0].id+"_table"})+' title="'+settings.labelMonthSelect+'"'):_.node("div",monthsCollection[viewsetObject.month],settings.klass.month)},createYearLabel=function(){var focusedYear=viewsetObject.year,numberYears=settings.selectYears===!0?5:~~(settings.selectYears/2),availableYears,neededYears;if(numberYears){var minYear=minLimitObject.year,maxYear=maxLimitObject.year,lowestYear=focusedYear-numberYears,highestYear=focusedYear+numberYears;return minYear>lowestYear&&(highestYear+=minYear-lowestYear,lowestYear=minYear),maxYear<highestYear&&(availableYears=lowestYear-minYear,neededYears=highestYear-maxYear,lowestYear-=availableYears>neededYears?neededYears:availableYears,highestYear=maxYear),_.node("select",_.group({min:lowestYear,max:highestYear,i:1,node:"option",item:function(loopedYear){return[loopedYear,0,"value="+loopedYear+(focusedYear==loopedYear?" selected":"")]}}),settings.klass.selectYear,(isOpen?"":"disabled")+" "+_.ariaAttr({controls:calendar.$node[0].id+"_table"})+' title="'+settings.labelYearSelect+'"')}return _.node("div",focusedYear,settings.klass.year)};return _.node("div",(settings.selectYears?createYearLabel()+createMonthLabel():createMonthLabel()+createYearLabel())+createMonthNav()+createMonthNav(1),settings.klass.header)+_.node("table",tableHead+_.node("tbody",_.group({min:0,max:WEEKS_IN_CALENDAR-1,i:1,node:"tr",item:function(rowCounter){var shiftDateBy=settings.firstDay&&calendar.create([viewsetObject.year,viewsetObject.month,1]).day===0?-7:0;return[_.group({min:DAYS_IN_WEEK*rowCounter-viewsetObject.day+shiftDateBy+1,max:function(){return this.min+DAYS_IN_WEEK-1},i:1,node:"td",item:function(targetDate){targetDate=calendar.create([viewsetObject.year,viewsetObject.month,targetDate+(settings.firstDay?1:0)]);var isSelected=selectedObject&&selectedObject.pick==targetDate.pick,isHighlighted=highlightedObject&&highlightedObject.pick==targetDate.pick,isDisabled=disabledCollection&&calendar.disabled(targetDate)||targetDate.pick<minLimitObject.pick||targetDate.pick>maxLimitObject.pick;return[_.node("div",targetDate.date,function(klasses){return klasses.push(viewsetObject.month==targetDate.month?settings.klass.infocus:settings.klass.outfocus),nowObject.pick==targetDate.pick&&klasses.push(settings.klass.now),isSelected&&klasses.push(settings.klass.selected),isHighlighted&&klasses.push(settings.klass.highlighted),isDisabled&&klasses.push(settings.klass.disabled),klasses.join(" ")}([settings.klass.day]),"data-pick="+targetDate.pick+" "+_.ariaAttr({role:"gridcell",selected:isSelected&&calendar.$node.val()===_.trigger(calendar.formats.toString,calendar,[settings.format,targetDate])?!0:null,activedescendant:isHighlighted?!0:null,disabled:isDisabled?!0:null})),"",_.ariaAttr({role:"presentation"})]}})]}})),settings.klass.table,'id="'+calendar.$node[0].id+'_table" '+_.ariaAttr({role:"grid",controls:calendar.$node[0].id,readonly:!0}))+_.node("div",_.node("button",settings.today,settings.klass.buttonToday,"type=button data-pick="+nowObject.pick+(isOpen&&!calendar.disabled(nowObject)?"":" disabled")+" "+_.ariaAttr({controls:calendar.$node[0].id}))+_.node("button",settings.clear,settings.klass.buttonClear,"type=button data-clear=1"+(isOpen?"":" disabled")+" "+_.ariaAttr({controls:calendar.$node[0].id}))+_.node("button",settings.close,settings.klass.buttonClose,"type=button data-close=true "+(isOpen?"":" disabled")+" "+_.ariaAttr({controls:calendar.$node[0].id})),settings.klass.footer)};DatePicker.defaults=function(prefix){return{labelMonthNext:"Next month",labelMonthPrev:"Previous month",labelMonthSelect:"Select a month",labelYearSelect:"Select a year",monthsFull:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],weekdaysFull:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],weekdaysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],today:"Today",clear:"Clear",close:"Close",format:"d mmmm, yyyy",klass:{table:prefix+"table",header:prefix+"header",navPrev:prefix+"nav--prev",navNext:prefix+"nav--next",navDisabled:prefix+"nav--disabled",month:prefix+"month",year:prefix+"year",selectMonth:prefix+"select--month",selectYear:prefix+"select--year",weekdays:prefix+"weekday",day:prefix+"day",disabled:prefix+"day--disabled",selected:prefix+"day--selected",highlighted:prefix+"day--highlighted",now:prefix+"day--today",infocus:prefix+"day--infocus",outfocus:prefix+"day--outfocus",footer:prefix+"footer",buttonClear:prefix+"button--clear",buttonToday:prefix+"button--today",buttonClose:prefix+"button--close"}}}(Picker.klasses().picker+"__");Picker.extend("pickadate",DatePicker)});Akumina=Akumina||{};Akumina.namespace=function(ns_string){var parts=ns_string.split("."),parent=Akumina,i;for(parts[0]==="Akumina"&&(parts=parts.slice(1)),i=0;i<parts.length;i+=1)typeof parent[parts[i]]=="undefined"&&(parent[parts[i]]={}),parent=parent[parts[i]];return parent};Akumina.namespace("Akumina.AppPart.DMS");Akumina.namespace("Akumina.AppPart.DMS.Grid");Akumina.namespace("Akumina.AppPart.DMS.DragDrop");Akumina.namespace("Akumina.AppPart.DMS.Taxonomy");Akumina.namespace("Akumina.AppPart.DMS.FolderTree");Akumina.namespace("Akumina.AppPart.DMS.Refinements");Akumina.namespace("Akumina.AppPart.DMS.Models");Akumina.namespace("Akumina.AppPart.DMS.Data");Akumina.namespace("Akumina.AppPart.DMS.MetaData");Akumina.namespace("Akumina.AppPart.DMS.Cookies");Akumina.AppPart.DMS=function(){var _cur=this;this.Init=function(){Akumina.AppPart.DMS.Logger.Write("Akumina.AppPart.DMS.Load")};this.GetAbsoluteSiteName=function(){return _cur.GetBaseUrl()+"/"==_spPageContextInfo.webAbsoluteUrl?_cur.GetBaseUrl():_spPageContextInfo.webAbsoluteUrl};this.GetBaseUrl=function(){return window.location.protocol+"//"+window.location.host}};typeof Akumina.AppPart.DMS.Eventing=="undefined"&&(Akumina.AppPart.DMS.Eventing={events:{},Subscribe:function(e,func){this.events[e]||(this.events[e]=[]);this.events[e].push(func)},Publish:function(t,data){(Akumina.AppPart.DMS.Logger.Write("Event Published "+t),Akumina.AppPart.DMS.Logger.Write(this.events),!this.events[t]||this.events[t].length<1)||this.events[t].forEach(function(func){func(data||{})})},FireSuccess:function(message){this.Publish("/grid/success/",message)},FireError:function(message){this.Publish("/grid/error/",message)},FireFolderChange:function(object){this.Publish("/foldertree/change/",object)},FireGridFolderClick:function(folderPath){this.Publish("/grid/folderclick/",folderPath)},FireCreateFolderClick:function(folderPath){this.Publish("/grid/folderCreate/",folderPath)}});typeof Akumina.AppPart.DMS.Cache=="undefined"&&(Akumina.AppPart.DMS.Cache={cache:{},Add:function(key,obj){this.cache[key]||(this.cache[key]=[]);Akumina.AppPart.DMS.Logger.Write("Cache.Add=>"+key);this.cache[key].push(obj)},Get:function(key){return Akumina.AppPart.DMS.Logger.Write("Cache.Get=>"+key),!this.cache[key]||this.cache[key].length<1?null:this.cache[key]},Keys:{TemplatesHTML:"templateHTML"}});typeof Akumina.AppPart.DMS.Models=="undefined"&&(Akumina.AppPart.DMS.Models={FolderOnChangeModel:function(id,name,rootFolder,startFolder){var model={};return model.Id=id,model.Name=name,model.RootFolder=rootFolder,model.StartFolder=startFolder,model},RefinementUpdateModel:function(id,name){var model={};return model.Id=id,model.Name=name,model},GridTabUpdateModel:function(allfilescount,myfilescount,popularcount,recentcount,selectedTab){var model={};return model.AllFilesCount=allfilescount,model.MyFilesCount=myfilescount,model.PopularCount=popularcount,model.RecentCount=recentcount,model.selectedTab=selectedTab,model},GridTabOnChangeModel:function(selectedTab){var model={};return model.selectedText=selectedTab,model},FolderSearchModel:function(listId,listName,folderPath,searchText,currentTab,rowLimit,sortField,sortOrder,filters,skip,currentUserName,recentLimit,popularLimit){var model={};return model.listId=listId,model.listName=listName,model.folderPath=folderPath,model.searchText=searchText,model.currentTab=currentTab,model.rowLimit=rowLimit,model.sortField=sortField,model.sortOrder=sortOrder,model.filters=filters,model.skip=skip,model.currentUserName=currentUserName,model.recentLimit=recentLimit,model.popularLimit=popularLimit,model}});Akumina.AppPart.DMS.Logger={Write:function(message){!1&&Akumina.AddIn.Logger.WriteInfoLog(message)}};typeof Akumina.AppPart.DMS.Cookies=="undefined"&&(Akumina.AppPart.DMS.Cookies=function(){var _cur=this;_cur.cookieName="akuminaDMSCookie";this.readCookieOrQueryString=function(startFolder){var openFolder=Akumina.AddIn.Utilities.getQueryStringParameter("openFolder",""),cookieValue;return openFolder&&openFolder!=""?{selectedFolder:"/"+startFolder+openFolder}:(cookieValue=_cur.getCookie(),cookieValue&&cookieValue!="")?JSON.parse(cookieValue):undefined};this.createCookie=function(cookieModel){var d=new Date,expires;d.setTime(d.getTime()+864e5);expires="expires="+d.toGMTString();document.cookie=_cur.cookieName+"="+JSON.stringify(cookieModel)+"; "+expires};this.getCookie=function(){for(var c,name=_cur.cookieName+"=",ca=document.cookie.split(";"),i=0;i<ca.length;i++){for(c=ca[i];c.charAt(0)==" ";)c=c.substring(1);if(c.indexOf(name)==0)return c.substring(name.length,c.length)}return""};this.deleteCookie=function(){document.cookie=encodeURIComponent(_cur.cookieName)+"=deleted; expires="+new Date(0).toUTCString()}});$(document).ready(function(){});Akumina.AppPart.DMS.Models.Data={GridModel:function(name,date,author){var model={};return model.Name=name,model.Date=date,model.Author=author,model},TestModel:function(firstname,lastname,url){var model={};return model.firstName=lastname,model.lastName=firstname,model.URL=url,model},TestResponse:function(){return{}}};Akumina.AppPart.DMS.Data=function(){var _cur=this;this.Templates={_selector:null,_tmpData:null,FindAndRender:function(templateId,selector,data){_cur.Templates._selector=selector;_cur.Templates._tmpData=data;_cur.Templates.Find("template-"+templateId)},FindAndRenderHandleBar:function(template,partialTemplate,selector,data){var main=Handlebars.compile($(template).html()),leftTreeHtml;partialTemplate!=null&&Handlebars.registerPartial(partialTemplate,$("#"+partialTemplate).html());leftTreeHtml=main({children:data});$(selector).html(leftTreeHtml)},FindAndRenderHandleBarGeneric:function(template,partialTemplate,selector,jsonModel){var main=Handlebars.compile($(template).html()),finalHtml;partialTemplate!=null&&Handlebars.registerPartial(partialTemplate,$("#"+partialTemplate).html());finalHtml=main(jsonModel);$(selector).html(finalHtml)},Find:function(templateId){var html="",tempContainer,foundTemplate;$(".templates").each(function(){html+=$(this).html()});html!=null?(tempContainer=$('<div style="display:none;">'+html+"<\/div>"),$("body").append(tempContainer),foundTemplate=$(tempContainer).find("div#"+templateId).html(),$(tempContainer).length>0?($(tempContainer).remove(),_cur.Templates.Render(foundTemplate,_cur.Templates._tmpData)):Akumina.AppPart.DMS.Logger.Write("Template Not Found!=>"+templateId)):Akumina.AppPart.DMS.Logger.Write("You never fetched the Html, please see Core.GetAllTemplates")},Render:function(template,data){var selector=_cur.Templates._selector,html;data!=null?typeof template=="undefined"?Akumina.AppPart.DMS.Logger.Write("The template was undefined, most likely there was an issue finding your template in the markup"):(html=Mustache.to_html(template,data),$(selector).length>0?$(selector).html(html):Akumina.AppPart.DMS.Logger.Write("Destination ID not found!=>"+selector)):$(selector).html("")}};this.Lists={};this.Core={}};typeof Akumina.AppPart.DMS.MetaData=="undefined"&&(Akumina.AppPart.DMS.MetaData=function(){var _cur=this;this.Init=function(listId,listName){_cur.listId=listId;_cur.listName=listName;_cur.deferred=new $.Deferred;SP.SOD.loadMultiple(["sp.js"],function(){SP.SOD.registerSod("sp.taxonomy.js",SP.Utilities.Utility.getLayoutsPageUrl("sp.taxonomy.js"));SP.SOD.loadMultiple(["sp.taxonomy.js"],function(){_cur.GetFieldsMetaData()})})};this.GetFieldsMetaData=function(){_cur.LoadList()};this.LoadList=function(){var clientContext,webSite,selectedList,listTitle,listId;Akumina.AppPart.DMS.Logger.Write("LoadList");clientContext=SP.ClientContext.get_current();clientContext!=undefined&&clientContext!=null&&(webSite=clientContext.get_web(),clientContext.load(webSite),selectedList=webSite.get_lists().getByTitle(_cur.listName),clientContext.load(selectedList,"EnableVersioning","EnableMinorVersions","EffectiveBasePermissions","ForceCheckout"),listTitle=_cur.listName,listId=_cur.listId,Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.MetaData.LoadList"),clientContext.executeQueryAsync(Function.createDelegate(this,function(){_cur.OnLoadListSuccess(clientContext,webSite,selectedList)}),Function.createDelegate(this,function(sender,args){_cur.OnLoadListFailed(sender,args)})))};this.OnLoadListSuccess=function(clientContext,webSite,selectedList){var webServerUrl,selectedListFields;Akumina.AppPart.DMS.Logger.Write("OnLoadListSuccess");var enableVersioning=selectedList.get_enableVersioning(),enableMinorVersions=selectedList.get_enableMinorVersions(),forceCheckOut=selectedList.get_forceCheckout(),enableMinorCheckIn=enableVersioning&&enableMinorVersions?"minor":enableVersioning?"major":"no";_cur.enableMinorCheckIn=enableMinorCheckIn;_cur.forceCheckOut=forceCheckOut;_cur.enableVersioning=enableVersioning;_cur.enableMinorVersions=enableMinorVersions;_cur.effectivePermission=selectedList.get_effectiveBasePermissions();_cur.editPermission=_cur.effectivePermission.has(SP.PermissionKind.editListItems);_cur.addPermission=_cur.effectivePermission.has(SP.PermissionKind.addListItems);_cur.deletePermission=_cur.effectivePermission.has(SP.PermissionKind.deleteListItems);_cur.viewVersionsPermission=_cur.effectivePermission.has(SP.PermissionKind.viewVersions);_cur.deleteVersionsPermission=_cur.effectivePermission.has(SP.PermissionKind.deleteVersions);_cur.openPermission=_cur.effectivePermission.has(SP.PermissionKind.openItems);_cur.viewListItemsPermission=_cur.effectivePermission.has(SP.PermissionKind.viewListItems);webServerUrl=webSite.get_serverRelativeUrl();webServerUrl=="/"&&(webServerUrl="");Akumina.AppPart.DMS.Logger.Write("enableVersioning = "+enableVersioning);Akumina.AppPart.DMS.Logger.Write("enableMinorVersions = "+enableMinorVersions);Akumina.AppPart.DMS.Logger.Write("forceCheckOut = "+forceCheckOut);Akumina.AppPart.DMS.Logger.Write("enableMinorCheckIn = "+enableMinorCheckIn);Akumina.AppPart.DMS.Logger.Write("editPermission = "+_cur.editPermission);Akumina.AppPart.DMS.Logger.Write("addPermission = "+_cur.addPermission);Akumina.AppPart.DMS.Logger.Write("deletePermission = "+_cur.deletePermission);Akumina.AppPart.DMS.Logger.Write("viewVersionsPermission = "+_cur.viewVersionsPermission);Akumina.AppPart.DMS.Logger.Write("deleteVersionsPermission = "+_cur.deleteVersionsPermission);Akumina.AppPart.DMS.Logger.Write("openPermission = "+_cur.openPermission);Akumina.AppPart.DMS.Logger.Write("webServerUrl = "+webServerUrl);Akumina.AppPart.DMS.Logger.Write("viewListItemsPermission = "+_cur.viewListItemsPermission);selectedListFields=selectedList.get_fields();clientContext.load(selectedListFields);Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.MetaData.OnLoadListSuccess");clientContext.executeQueryAsync(Function.createDelegate(this,function(){_cur.OnLoadListFieldsSuccess(clientContext,webSite,selectedListFields)}),Function.createDelegate(this,function(sender,args){_cur.OnLoadListFieldsFailed(sender,args)}))};this.OnLoadListFailed=function(sender,args){Akumina.AppPart.DMS.Logger.Write("OnLoadListFailed");throw"Exception - "+args.get_message();};this.OnLoadListFieldsSuccess=function(clientContext,webSite,selectedListFields){var currentField;Akumina.AppPart.DMS.Logger.Write("OnLoadListFieldsSuccess");for(var fieldCount=selectedListFields.get_count(),fieldsArray=[],deferred=new $.Deferred,fieldEnumerator=selectedListFields.getEnumerator();fieldEnumerator.moveNext();)currentField=fieldEnumerator.get_current(),clientContext.load(currentField,"Title","InternalName","FieldTypeKind","TypeDisplayName");Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.MetaData.OnLoadListFieldsSuccess");clientContext.executeQueryAsync(function(){var currentField,idxField;for(fieldEnumerator=selectedListFields.getEnumerator();fieldEnumerator.moveNext();)currentField=fieldEnumerator.get_current(),_cur.OnLoadFieldSuccess(clientContext,webSite,currentField,fieldsArray);for(idxField=0;idxField<fieldsArray.length;idxField++)fieldsArray[idxField].fieldTypeDisplayName.toLowerCase()=="managed metadata"&&clientContext.load(fieldsArray[idxField].field);Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.MetaData.OnLoadListFieldsSuccess");clientContext.executeQueryAsync(function(){deferred.resolve()},function(sender,args){Akumina.AppPart.DMS.Logger.Write(args.get_message())})},function(sender,args){Akumina.AppPart.DMS.Logger.Write(args.get_message())});deferred.then(function(){_cur.metaData=fieldsArray;_cur.deferred.resolve()},function(){Akumina.AppPart.DMS.Logger.Write("Error getting list metadata !")})};this.OnLoadListFieldsFailed=function(sender,args){Akumina.AppPart.DMS.Logger.Write("OnLoadListFieldsFailed");throw"Exception - "+args.get_message();};this.OnLoadFieldSuccess=function(clientContext,webSite,currentField,fieldsArray){var fieldModel,defaultValue,taxonomyField,fixedTerms,terms,idxTerm;if(Akumina.AppPart.DMS.Logger.Write("currentField = "+currentField.get_title()),fieldModel={},currentField.get_title().toString().toLowerCase()!="name")if(fieldModel.field=currentField,fieldModel.isRequiredField=currentField.get_required(),fieldModel.fieldTitle=currentField.get_title(),fieldModel.fieldInternalName=currentField.get_internalName(),fieldModel.listId=_cur.listId,fieldModel.fieldId="DynamicCtrlField_"+fieldModel.fieldInternalName.toLowerCase(),fieldModel.fieldType=currentField.get_fieldTypeKind(),fieldModel.fieldTypeDisplayName=currentField.get_typeDisplayName(),defaultValue=currentField.get_defaultValue(),fieldModel.fieldType==SP.FieldType.dateTime)fieldModel.DateTimeField=!0,fieldModel.fieldDefaultValue=defaultValue!=null?DateTime.parse(defaultValue.toString()).toString("MMM dd, yyyy"):"",fieldsArray.push(fieldModel);else if(fieldModel.fieldType==SP.FieldType.text)fieldModel.TextField=!0,fieldModel.fieldDefaultValue=defaultValue!=null?defaultValue.toString():"",fieldsArray.push(fieldModel);else if(fieldModel.fieldTypeDisplayName.toLowerCase()=="managed metadata"){if(fieldModel.ManagedMetadataField=!0,taxonomyField=clientContext.castTo(currentField,SP.Taxonomy.TaxonomyField),fieldModel.field=taxonomyField,fieldModel.termSetId=taxonomyField.get_termSetId().toString(),defaultValue!=""&&defaultValue!=null){for(fixedTerms=[],terms=defaultValue.split(";"),idxTerm=1;idxTerm<terms.length;idxTerm+=2)fixedTerms.push(terms[idxTerm].split("|")[0].replace("#",""));defaultValue=fixedTerms.join(",")}fieldModel.fieldDefaultValue=defaultValue;fieldsArray.push(fieldModel)}else fieldModel.DefaultFormField=!0,fieldsArray.push(fieldModel)};this.OnLoadFieldFailed=function(sender,args){Akumina.AppPart.DMS.Logger.Write("OnLoadFieldFailed");throw"Exception - "+args.get_message();};this.GetAllFields=function(){return jQuery.extend(!0,{},_cur.metaData)};this.GetRequiredFields=function(){for(var requiredFields=[],idxField=0;idxField<_cur.metaData.length;idxField++)_cur.metaData[idxField].isRequiredField==!0&&requiredFields.push(jQuery.extend(!0,{},_cur.metaData[idxField]));return requiredFields};this.GetTaxonomyFields=function(requiredOnly){for(var taxonomyFields=[],idxField=0;idxField<_cur.metaData.length;idxField++)requiredOnly&&requiredOnly==!0&&_cur.metaData[idxField].isRequiredField!=!0||_cur.metaData[idxField].ManagedMetadataField&&taxonomyFields.push(jQuery.extend(!0,{},_cur.metaData[idxField]));return taxonomyFields}});typeof Akumina.AppPart.DMS.FolderTree=="undefined"&&(Akumina.AppPart.DMS.FolderTree=function(){var _cur=this;this.Init=function(){var editMode=Akumina.AddIn.Utilities.getEditMode();editMode||(_cur._settings=this.settings,_cur.checkStartFolderQueryString(),_cur.MetaData=new Akumina.AppPart.DMS.MetaData,_cur.Cookies=new Akumina.AppPart.DMS.Cookies,_cur.cookiesModel=_cur.Cookies.readCookieOrQueryString(_cur._settings.startFolder),_cur.checkPermissions())};this.checkStartFolderQueryString=function(){var startFolder=Akumina.AddIn.Utilities.getQueryStringParameter("libraryName","");startFolder&&startFolder!=""&&(_cur._settings.startFolder=startFolder)};this.checkPermissions=function(){_cur.GetListId(_cur._settings.startFolder).done(function(listId){_cur.listId=listId;_cur.GetFieldInformationForList(_cur.listId,_cur._settings.startFolder).done(function(){_cur.MetaData.viewListItemsPermission?($("#ia-Permissions-foldertree").hide(),$("#ia-Permissions-foldertree").html(""),_cur.showFolderTree(!1)):($("#ia-Permissions-foldertree").show(),$("#ia-Permissions-foldertree").html("You do not have access to library: '"+_cur._settings.startFolder+"'"))})}).fail(function(data){Akumina.AppPart.DMS.Logger.Write("Error occured on Getting List Info: "+JSON.stringify(data))})};this.GetListId=function(listName){var listInfoDef=new $.Deferred;return Akumina.AppPart.DMS.Logger.Write("FolderTree.GetListId"),$.ajax({url:_cur.GetSiteUrl()+"/_api/web/lists/getbytitle('"+listName+"')",method:"GET",headers:{Accept:"application/json; odata=verbose"},success:function(data){listInfoDef.resolve(data.d.Id)},error:function(data){listInfoDef.reject(data)}}),listInfoDef};this.GetFieldInformationForList=function(listId,listName){return Akumina.AppPart.DMS.Logger.Write("FolderTree.ReadFieldInformation for List = "+listName+", Id = "+listId),_cur.MetaData.Init(listId,listName),_cur.MetaData.deferred};this.showFolderTree=function(isRefresh,folderPath){var data=_cur.FetchData(function(){$.ajax({url:_cur.GetSiteUrl()+"/_api/web/Lists/GetByTitle('"+_cur._settings.startFolder+"')/RootFolder",method:"GET",headers:{Accept:"application/json; odata=verbose"},success:function(data){$("#folderTreeError").html("");_cur.rootFolder=data.d.Name;_cur.makeSearch=isRefresh;_cur.bindFoldertree(data.d.ServerRelativeUrl,isRefresh,folderPath);isRefresh||(Akumina.AppPart.DMS.Eventing.Subscribe("/grid/folderclick/",_cur.gridFolderItemclick),Akumina.AppPart.DMS.Eventing.Subscribe("/grid/folderCreate/",_cur.refreshGrid));var model=new Akumina.AppPart.DMS.Models.FolderOnChangeModel("/"+_cur._settings.startFolder,_cur._settings.startFolder,_cur.rootFolder,_cur._settings.startFolder);model.isFolderChangeFired=!0},error:function(data){$("#folderTreeError").html('Folder "'+_cur._settings.startFolder+'" not found.');Akumina.AppPart.DMS.Logger.Write(JSON.stringify(data))}})})};this.refreshGrid=function(folderPath){_cur.showFolderTree(!0,folderPath)};this.expandFolderFromCookie=function(cookiesModel){var selectedFolder=cookiesModel.selectedFolder,form=document.getElementById("aspnetForm"),action=form.getAttribute("action");$.ajax({type:"GET",url:action,success:function(){selectedFolder!=""&&_cur.expandTreeView(selectedFolder)},error:function(error){Akumina.AppPart.DMS.Logger.Write(error)}})};this.expandTreeView=function(folderPath){for(var folderurl=folderPath.split("/"),currentUrl="",currentFolder,i=0;i<folderurl.length;i++)currentUrl+=folderurl[i],currentFolder=$("span[id='"+currentUrl+"']"),currentUrl==folderPath?($("#folder-tree-node").jstree("deselect_all"),$("#folder-tree-node").jstree("select_node","span[id*='"+folderPath+"']")):currentFolder.parent().parent().find("i.jstree-ocl").click(),currentUrl+="/"};this.gridFolderItemclick=function(folderPath){var folderPath,i;_cur.ShowLoading();folderPath=folderPath.replace(_cur.GetSiteUrl(),"");folderPath=decodeURI(folderPath);folderPath=folderPath.replace(_cur.rootFolder,_cur._settings.startFolder);var title=folderPath.split("/"),openFolderArr=[],fpath="";for(i=0;i<title.length;i++)i!=""&&(fpath=fpath+"/"+title[i],openFolderArr.push(fpath));_cur.expandFolders(openFolderArr);$("#folder-tree-node").jstree("deselect_all");$("#folder-tree-node").jstree("select_node","span[id*='"+folderPath+"']")};this.expandFolders=function(openFolderArr){if(openFolderArr.length!=0){var element=$("span[id*='"+openFolderArr[0]+"']");$("#folder-tree-node").jstree("open_node",element);_cur.expandFolders(openFolderArr.slice(1,openFolderArr.length))}};this.ShowLoading=function(){Akumina.AppPart.DMS.Logger.Write("Grid.ShowLoading");$(".ia-loading-panel").addClass("ia-show")};this.HideLoading=function(){Akumina.AppPart.DMS.Logger.Write("Grid.HideLoading");$(".ia-loading-panel").removeClass("ia-show");$(".ia-loading-panel").addClass("ia-hide")};this.OnSelect=function(data){data.action!="deselect_all"&&(_cur.setCookie(data.attr("id")),_cur.getSelectedfolderData(data.attr("id"),data.attr("title"),_cur.rootFolder,_cur._settings.startFolder,!0))};this.setCookie=function(selectedFolder){if(selectedFolder.toString().toLowerCase().trim()!="/"+_cur._settings.startFolder.toString().toLowerCase().trim()){var cookieModel=_cur.GetCookieModel(selectedFolder);_cur.Cookies.createCookie(cookieModel)}};this.GetCookieModel=function(selectedFolder){return{selectedFolder:selectedFolder}};this.getSelectedfolderData=function(id,title,rootfolder,startFolder,isFolderChangeFired){var model=new Akumina.AppPart.DMS.Models.FolderOnChangeModel(id,title,rootfolder,startFolder);model.isFolderChangeFired=isFolderChangeFired;Akumina.AppPart.DMS.Eventing.FireFolderChange(model)};this.bindFoldertree=function(rootfolder,isRefresh,folderPath){var children=[],folderpathArray=[];$.ajax({url:_cur.GetSiteUrl()+"/_api/web/Lists/GetByTitle('"+_cur._settings.startFolder+"')/Items?$select=FileLeafRef,FileRef,FileSystemObjectType",method:"GET",headers:{Accept:"application/json; odata=verbose"},success:function(data){var dataArray=data.d.results,reducedData,i,selector,rootfolderPath;for(folderpathArray.push("/"+_cur._settings.startFolder),i=0;i<dataArray.length;i++)dataArray[i].FileSystemObjectType==1&&folderpathArray.push("/"+_cur._settings.startFolder+dataArray[i].FileRef.replace(rootfolder,""));for(reducedData=_cur.reducePrefixPaths(folderpathArray.sort()),i=0;i<reducedData.length;i++)children=_cur.GetFolderTree(reducedData[i].toString().split("/"),"/",children);selector=".ia-folder-tree";(new Akumina.AppPart.DMS.Data).Templates.FindAndRenderHandleBar("#leftGridTemplate","list",selector,children);$("#folder-tree-node").on("changed.jstree",function(e,data){for(var data,i=0,j=data.selected.length;i<j;i++)data=$(data.instance.get_node(data.selected[i]).text);_cur.OnSelect(data)}).jstree();isRefresh?_cur.gridFolderItemclick(folderPath):(rootfolderPath="/"+_cur._settings.startFolder,$("#folder-tree-node").jstree("deselect_all"),$("#folder-tree-node").jstree("select_node","span[id*='"+rootfolderPath+"']"));_cur.cookiesModel&&!_cur.makeSearch&&(_cur.expandFolderFromCookie(_cur.cookiesModel),_cur.Cookies.deleteCookie())},error:function(data){Akumina.AppPart.DMS.Logger.Write(JSON.stringify(data))}})};this.GetSiteName=function(){return _spPageContextInfo.webServerRelativeUrl=="/"?"":_spPageContextInfo.webServerRelativeUrl};this.GetBaseUrl=function(){return window.location.protocol+"//"+window.location.host};this.GetSiteUrl=function(){return _cur.GetBaseUrl()+_cur.GetSiteName()};this.stringStartsWith=function(string,prefix){var strArr=string.split("/"),prefixArr=prefix.split("/"),i;if(prefixArr.length<=strArr.length){for(i=0;i<prefixArr.length;i++)if(strArr[i].toLowerCase()!=prefixArr[i].toLowerCase())return!1;return!0}return!1};this.DedupArray=function(dataArray){for(var j,deduped=[],exists=!1,i=0;i<dataArray.length;i++){for(exists=!1,j=0;j<deduped.length;j++)if(dataArray[i]==deduped[j]){exists=!0;break}exists||deduped.push(dataArray[i])}return deduped};this.GetFolderTree=function(newFolders,basePath,existingFolders){var refexisting,folderpath,i,k,j,tempNew;if(newFolders.length==0)return existingFolders;for(refexisting=existingFolders,folderpath=basePath,i=0;i<newFolders.length;i++){for(folderpath=basePath,k=0;k<i;k++)folderpath+=newFolders[k]+"/";for(j=0;j<existingFolders.length;j++)if(existingFolders[j].name==newFolders[i])return tempNew=newFolders.slice(i+1,newFolders.length),existingFolders[j].children=_cur.GetFolderTree(tempNew,existingFolders[j].folderpath+"/",existingFolders[j].children),refexisting;existingFolders.push({name:newFolders[i],folderpath:folderpath+newFolders[i],children:[]});existingFolders=existingFolders[existingFolders.length-1].children}return refexisting};this.reducePrefixPaths=function(data){var reducedArray,i,prefix,j;for(data=_cur.DedupArray(data),reducedArray=[],i=0;i<data.length;i++)data[i].charAt(0)=="/"&&(data[i]=data[i].substring(1,data[i].length));for(i=0;i<data.length;i++){for(prefix=!1,j=0;j<data.length;j++)if(i!=j&&_cur.stringStartsWith(data[j],data[i])){prefix=!0;break}prefix||reducedArray.push(data[i])}return reducedArray};this.FetchData=function(callback){callback()}});typeof Akumina.AppPart.DMS.DragDrop=="undefined"&&(Akumina.AppPart.DMS.DragDrop=function(parentGrid){var _cur=this;this.parentGrid=parentGrid;this.CN_errorField="ia-field-error";this.files=null;this.fileStatus=[];this.folderPath="";this.currentCount=0;this.rejectedOWFiles=[];this.ConflictFiles=[];this.uploadingFiles=[];this.successfulUpload=[];this.percent=10;this.addPermission=!0;this.canUploadFiles=!0;this.selectedFileTermSets={};this.Init=function(){Akumina.AppPart.DMS.Eventing.Subscribe("/grid/dragdrop/uploadfiles/",_cur.DisplayUploadPopup);Akumina.AppPart.DMS.Eventing.Subscribe("/grid/dragdrop/minorversion/",_cur.ShowFileCheckInMinorOptionDialog);Akumina.AppPart.DMS.Eventing.Subscribe("/grid/dragdrop/majorversion/",_cur.ShowFileCheckInMajorOptionDialog);Akumina.AppPart.DMS.Eventing.Subscribe("/grid/dragdrop/uploadprogressdialog/",_cur.ShowFileUploadProgressDialog);Akumina.AppPart.DMS.Eventing.Subscribe("/grid/dragdrop/requiredfieldsdialog/",_cur.ShowRequiredFieldsDialog)};this.HandleDnDFileSelect=function(event){_cur.canUploadFiles&&(_cur.canUploadFiles=!1,_cur.fileStatus=[],_cur.folderPath="",_cur.selectedFileTermSets={},_cur.addPermission==!0?(this.files=event.dataTransfer.files,this.files.length==1&&_cur.getSelectedTerms(this.files[0]),$("#drop_zone").removeClass("ia-highlighted"),event.dataTransfer?(_cur.IntializeEmptyValues(),_cur.rejectedOWFiles.length=0,_cur.successfulUpload.length=0,_cur.ConflictFiles.length=0,_cur.ExistingFileCheck()):(alert("Browser doesn't support. Please use other browsers"),_cur.canUploadFiles=!0)):($("#drop_zone").removeClass("ia-highlighted"),alert("Drag and Drop Upload \nThe documents cannot be uploaded because different permissions are needed. Request the necessary permissions."),_cur.canUploadFiles=!0))};this.getSelectedTerms=function(fileName){var taxFields=_cur.parentGrid.viewModel.MetaData.GetTaxonomyFields(!0),clientContext=SP.ClientContext.get_current();if(clientContext!=undefined&&clientContext!=null){var folderPath=_cur.parentGrid.GetSiteName()+_cur.parentGrid.viewModel.selectedFolder,relUrl=folderPath+"/"+fileName.name,file=clientContext.get_web().getFileByServerRelativeUrl(relUrl);clientContext.load(file,"ListItemAllFields");Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.DragDrop.getSelectedTerms");clientContext.executeQueryAsync(function(){for(var taxField,taxFieldValues,taxFieldValuesEnumerator,listItem=file.get_listItemAllFields(),i=0;i<taxFields.length;i++)if(taxField=taxFields[i].fieldInternalName,taxFieldValues=listItem.get_fieldValues()[taxField],taxFieldValues)for(taxFieldValuesEnumerator=taxFieldValues.getEnumerator();taxFieldValuesEnumerator.moveNext();)_cur.selectedFileTermSets[taxField.toLowerCase()]||(_cur.selectedFileTermSets[taxField.toLowerCase()]=[]),_cur.selectedFileTermSets[taxField.toLowerCase()].push(_cur.parentGrid.viewModel.TaxonomyData.taxonomyMap[taxFieldValuesEnumerator.get_current().get_termGuid()])},function(){})}};this.IntializeEmptyValues=function(){_cur.fileStatus=[];_cur.folderPath="";_cur.currentCount=0;_cur.rejectedOWFiles=[];_cur.ConflictFiles=[];_cur.uploadingFiles=[];_cur.successfulUpload=[];_cur.percent=10;_cur.addPermission=!0;$(".ia-progress-percent")&&$(".ia-progress-percent").attr("style","width:0%;");$(".ia-progress-text")&&$(".ia-progress-text").html("0%");_cur.ReintializeCheckInComment();$(".ia-form").each(function(){$("."+_cur.CN_errorField).each(function(){$(this).removeClass(_cur.CN_errorField)})});$(".gridCategory").find("input[type=checkbox]:checked").length>0&&$(".gridCategory").find("input[type=checkbox]:checked").each(function(){$(this).click()});$(".ia-form-error")&&$(".ia-form-error").hide()};this.ReintializeCheckInComment=function(){$(".ia-form").each(function(){$(this).find("textarea.ax-checkincomment").each(function(){$(this).val("")})})};this.ExistingFileCheck=function(){_cur.folderPath=parentGrid.GetSiteName()+parentGrid.viewModel.selectedFolder;var tempfiles=this.files;if(tempfiles.length>0){var lengthTempFiles=tempfiles.length,i=-1;function nextcall(){var fileName;if(i++,lengthTempFiles>i)if(fileName=_cur.folderPath+"/"+tempfiles[i].name,tempfiles[i].type==""&&tempfiles[i].size==0)_cur.rejectedOWFiles.push(tempfiles[i].name),_cur.fileStatus.push(tempfiles[i].name+" - Folders and unsupported file types can't be uploaded."),nextcall();else if(tempfiles[i].size==0)_cur.rejectedOWFiles.push(tempfiles[i].name),_cur.fileStatus.push(tempfiles[i].name+" - This file is empty and needs content to be uploaded."),nextcall();else{var fileNameExist=tempfiles[i].name,clientContext=SP.ClientContext.get_current(),url=fileName,oweb=clientContext.get_web(),ofile=oweb.getFileByServerRelativeUrl(url);clientContext.load(ofile,"CheckOutType","Name","CheckedOutByUser");Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.DragDrop.ExistingFileCheck");clientContext.executeQueryAsync(Function.createDelegate(this,function(){_cur.ConflictFiles.push(fileNameExist);nextcall()}),Function.createDelegate(this,function(){nextcall()}))}else _cur.CallModalDialogExistingFile(),_cur.canUploadFiles=!0}nextcall()}else Akumina.AppPart.DMS.Eventing.FireError("Folders and unsupported file types can't be uploaded."),_cur.canUploadFiles=!0};this.CallModalDialogExistingFile=function(){_cur.ConflictFiles.length>0?($(".conflictDlg").prop("checked",!1),$(".divConflictCheck").show(),$(".currentUploadFileName").html(_cur.ConflictFiles[0]),_cur.ConflictFiles.splice(0,1),_cur.ConflictFiles.length>0?$(".remainingFiles").html(_cur.ConflictFiles.length):$(".divConflictCheck").hide(),$.magnificPopup.open({items:{src:".ia-library-multipleupload",type:"inline"},closeOnBgClick:!1,showCloseBtn:!0})):this.files.length!=_cur.rejectedOWFiles.length?Akumina.AppPart.DMS.Eventing.Publish("/grid/dragdrop/uploadfiles/"):_cur.fileStatus.length>0&&Akumina.AppPart.DMS.Eventing.FireSuccess(_cur.fileStatus)};this.DisplayUploadPopup=function(){_cur.ClearCheck();$(".ia-step1").length>0?_cur.BindRequiredFields():_cur.FileCheckinStep();_cur.GetPopupFunctions()};this.BindRequiredFields=function(){Akumina.AppPart.DMS.Logger.Write("BindRequiredFields");_cur.LoadMetadata()};this.LoadMetadata=function(){var fieldsArray,idxField,model;if(_cur.enableMinorCheckIn=parentGrid.viewModel.MetaData.enableMinorCheckIn,_cur.forceCheckOut=parentGrid.viewModel.MetaData.forceCheckOut,_cur.addPermission=parentGrid.viewModel.MetaData.addPermission,_cur.requiredFields==undefined){for(fieldsArray=parentGrid.viewModel.MetaData.GetRequiredFields(),idxField=0;idxField<fieldsArray.length;idxField++)fieldsArray[idxField].fieldTypeDisplayName.toLowerCase()=="managed metadata"&&_cur.UpdateModelWithTaxonomyDetails(fieldsArray[idxField].field,fieldsArray[idxField],fieldsArray[idxField].fieldDefaultValue);_cur.requiredFields=fieldsArray}_cur.requiredFields==undefined||_cur.requiredFields.length==0?($("#requiredFieldsNotFound").show(),$("#requiredFieldsFound").hide()):($("#requiredFieldsFound").show(),$("#requiredFieldsNotFound").hide());model={fields:_cur.requiredFields};(new Akumina.AppPart.DMS.Data).Templates.FindAndRender("ia-upload-form","#pnlRequiredFields_id",model);_cur.SetDefaultValueToRequiredFields();this.files.length==1&&_cur.selectAlreadySetValues();$(".pnlRequiredFields #btnCategoryBrowse").unbind().click(function(e){_cur.getCategoryModel(e.target)});Akumina.AppPart.DMS.Eventing.Publish("/grid/dragdrop/requiredfieldsdialog/");parentGrid.HideRequiredFieldsLoading()};this.UpdateModelWithTaxonomyDetails=function(taxonomyField,fieldModel,defaultValue){taxonomyField!=undefined&&taxonomyField!=null&&taxonomyField.get_isAnchorValid()&&(fieldModel.TaxonomyField=!0,fieldModel.AllowMultipleValues=taxonomyField.get_allowMultipleValues(),fieldModel.oAssociatedTaxonomy=taxonomyField.get_anchorId().toString()!="00000000-0000-0000-0000-000000000000"?_cur.GetMetaField(taxonomyField.get_title().toLowerCase()+"|"+taxonomyField.get_anchorId()):_cur.GetMetaField(taxonomyField.get_title().toLowerCase()+"|"+taxonomyField.get_termSetId()));fieldModel.oAssociatedTaxonomy!=null&&fieldModel.oAssociatedTaxonomy!=""&&(fieldModel.fieldDefaultValue=defaultValue!=null?defaultValue.toString():"",fieldModel.oDefaultTaxonomyPathValues=_cur.GetMetaField(defaultValue),fieldModel.oAssociatedTaxonomyNames=_cur.GetMetaFieldNames(defaultValue),fieldModel.oTaxonomoyDefaultValue=fieldModel.oAssociatedTaxonomyNames+"|"+fieldModel.oDefaultTaxonomyPathValues)};this.GetMetaField=function(metaValue){for(var value,metasingleValue,metaArr=[],multiValues=metaValue.split(";"),i=0;i<multiValues.length;i++)value=multiValues[i].split("|"),value.length>1&&parentGrid.viewModel.TaxonomyData.taxonomyMap[value[1]]!=null&&(metasingleValue=parentGrid.viewModel.TaxonomyData.taxonomyMap[value[1]],metaArr.push(metasingleValue));return metaArr.join(",")};this.GetMetaFieldNames=function(metaValue){for(var value,metasingleValue,metaArr=[],multiValues=metaValue.split(";"),i=0;i<multiValues;i++)value=multiValues[i].split("|"),value.length>1&&parentGrid.viewModel.TaxonomyData.taxonomyMap[value[1]]!=null&&(metasingleValue=value[0],metaArr.Add(metasingleValue));return metaArr.join(",")};this.ClearCheck=function(){$(".checkInCheckoutDraft").length>0&&$(".checkInCheckoutDraft").click();$(".checkInFileOption").length>0&&$(".checkInFileOption").click();$(".checkInDraftOption").length>0&&$(".checkInDraftOption").click();$(".ia-checkin").length>0&&$(".ia-checkin").click();$(".checkInDraft").length>0&&$(".checkInDraft").click();$(".conflictDlg").length>0&&$(".conflictDlg").prop("checked",!1);$(".ia-checkin-all").show();$(".ia-checkin-changes").hide();$(".checkInCheckoutDraft").length>0&&$(".checkInCheckoutDraft").click();$(".checkInCheckoutDraftOption").length>0&&$(".checkInCheckoutDraftOption").click()};this.GetPopupFunctions=function(){$(".interAction .ia-upload-category-confirm").unbind().click(function(e){var ele;e.preventDefault();$.magnificPopup.close();Akumina.AppPart.DMS.Eventing.Publish("/grid/dragdrop/requiredfieldsdialog/");var fieldname=$(".gridCategory .ax-treeview").attr("field-name"),selectedCats=$("#template-ia-upload-form #upload-category-popup .ia-current-selected-list").text(),selectedCatVals=$("#template-ia-upload-form #upload-category-popup .selectedTaxonomy").val();$(".pnlRequiredFields input[field-name='"+fieldname+"'].ia-upload-category-input").length>0&&(ele=$(".pnlRequiredFields input[field-name='"+fieldname+"'].ia-upload-category-input"),$(ele).val(selectedCats),$(ele).attr("selected-taxonomies",selectedCatVals),$("#"+fieldname+"_Hidden").val(selectedCatVals),$('[name="'+fieldname+'_Hidden"]').val()==""?$(ele).parents(".ia-form-row").hasClass(_cur.CN_errorField)||$(ele).parents(".ia-form-row").addClass(_cur.CN_errorField):($(ele).parents(".ia-form-row").removeClass(_cur.CN_errorField),$(".ia-form-error").hide()))});$(".interAction .ia-upload-category-cancel").unbind().click(function(e){e.preventDefault();$.magnificPopup.close();Akumina.AppPart.DMS.Eventing.Publish("/grid/dragdrop/requiredfieldsdialog/")});$(".interAction .ia-upload-confirm").unbind().click(function(e){e.preventDefault();_cur.FileCheckinStep(e)});$(".interAction .ia-upload-cancel").unbind().click(function(e){e.preventDefault();$.magnificPopup.close()});$(".interAction .ia-checkin-confirm").unbind().click(function(e){e.preventDefault();$.magnificPopup.close();Akumina.AppPart.DMS.Eventing.Publish("/grid/dragdrop/uploadprogressdialog/")});$(".interAction .ia-checkin-cancel").unbind().click(function(e){e.preventDefault();$.magnificPopup.close()});$('input[type="radio"].ia-checkin').unbind().click(function(){$(this).is(":checked")?($(".ia-checkin-all").show(),$(".ia-checkin-changes").hide()):$(".ia-checkin-all").hide()});$('input[type="radio"].ia-checkin-checkout').unbind().click(function(){$(this).is(":checked")?($(".ia-checkin-changes").show(),$(".ia-checkin-all").hide()):$(".ia-checkin-changes").hide()});$('input[type="radio"].ia-no-checkin').unbind().click(function(){$(this).is(":checked")&&($(".ia-checkin-changes").hide(),$(".ia-checkin-all").hide())});$(".ia-form").find(".ia-datepicker").each(function(){$(this).change(function(){$(this).val()==""?$(this).parents(".ia-form-row").hasClass(_cur.CN_errorField)||$(this).parents(".ia-form-row").addClass(_cur.CN_errorField):$(this).parents(".ia-form-row").removeClass(_cur.CN_errorField)})})};this.SetDefaultValueToRequiredFields=function(){$(".pnlRequiredFields").length>0&&($(".pnlRequiredFields").find(".ia-upload-category-input").each(function(){var pathANdValue=$(this).attr("default-value"),pathANdVal;pathANdValue!=""?(pathANdVal=pathANdValue.split("|"),$(this).attr("selected-taxonomies",pathANdVal[1]),$(this).val(pathANdVal[0])):($(this).attr("selected-taxonomies",""),$(this).val(""))}),$(".pnlRequiredFields").find(".ax-textbox").each(function(){var defaultValue=$(this).attr("default-value");defaultValue!=""?$(this).val(defaultValue):$(this).val("")}),$(".pnlRequiredFields").find("textarea").each(function(){var defaultValue=$(this).attr("default-value");defaultValue!=""?$(this).val(defaultValue):$(this).val("")}))};this.selectAlreadySetValues=function(){var key,selectedTermNames,selectedTerms,i,splitTermNames,termName;for(key in _cur.selectedFileTermSets){for(selectedTermNames=[],selectedTerms=_cur.selectedFileTermSets[key].join(","),i=0;i<_cur.selectedFileTermSets[key].length;i++)splitTermNames=_cur.selectedFileTermSets[key][i].split(">"),termName=splitTermNames[splitTermNames.length-1],selectedTermNames.push(termName);$("input[id='DynamicCtrlField_"+key+"'][type='text']").attr("selected-taxonomies",selectedTerms);$("input[id='DynamicCtrlField_"+key+"'][type='hidden']").attr("selected-taxonomies",selectedTerms);$("input[id='DynamicCtrlField_"+key+"'][type='text']").val(selectedTermNames.join(","));$("input[id='DynamicCtrlField_"+key+"'][type='hidden']").val(selectedTermNames.join(","))}};this.clearModal=function(){if($(".checkInFileOption:checked").length>0||$(".checkInCheckOutFileOption:checked").length>0){var Comment="";Comment=$(".checkInFileOption:checked").length>0?$(".checkinCommentOption").val():$(".checkInCheckOutCommentOption").val();$(".checkInFileOption:checked").length>0?($(".checkInDraftOption:checked").length>0?$(".checkInDraftOption").prop("checked",!1):$(".checkInPublishOption").prop("checked",!1),$(".checkInFileOption").prop("checked",!1)):$(".checkInCheckoutDraftOption:checked").length>0?$(".checkInCheckoutDraftOption").prop("checked",!1):$(".checkInCheckoutPublishOption").prop("checked",!1);$(".checkInCheckOutFileOption:checked").length>0&&$(".checkInCheckOutFileOption").prop("checked",!1);$(".ia-checkin-all").hide();$(".ia-checkin-changes").hide()}};this.CallReplaceIt=function(event){event.preventDefault();$.magnificPopup.close();$(".conflictDlg").prop("checked")==!0&&(_cur.ConflictFiles.length=0);_cur.CallModalDialogExistingFile()};this.RejectReplaceIt=function(event){var currentFile,i;if(event.preventDefault(),$.magnificPopup.close(),currentFile=$(".currentUploadFileName").html(),_cur.rejectedOWFiles.push(currentFile),_cur.fileStatus.push(currentFile+" skipped by you."),$(".conflictDlg").prop("checked")==!0){for(i=0;i<_cur.ConflictFiles.length;i++)_cur.rejectedOWFiles.push(_cur.ConflictFiles[0]),_cur.fileStatus.push(_cur.ConflictFiles[0]+" skipped by you.");_cur.ConflictFiles.length=0}_cur.CallModalDialogExistingFile()};this.ShowFileCheckInMinorOptionDialog=function(){_cur.forceCheckOut==!1&&$(".ia-step2 input[value='dontCheckIn']").length>0&&$(".ia-step2 input[value='dontCheckIn']").parent().parent().hide();$.magnificPopup.open({items:{src:".ia-step2",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0})};this.ShowFileCheckInMajorOptionDialog=function(){$(".dd_fileCheckinNo").length>0&&$(".dd_fileCheckinNo").click();$.magnificPopup.open({items:{src:".dd_fileCheckInMajorOption",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0})};this.ShowFileUploadProgressDialog=function(){$.magnificPopup.open({items:{src:".ia-step3",type:"inline"},closeOnBgClick:!1,showCloseBtn:!1});setTimeout(function(){_cur.FilesUploadToLibrary()},500)};this.ShowRequiredFieldsDialog=function(){$.magnificPopup.open({items:{src:".ia-step1",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0})};this.FileCheckinStep=function(){var validation=_cur.FieldValidation();validation?($.magnificPopup.close(),_cur.enableMinorCheckIn=="minor"?Akumina.AppPart.DMS.Eventing.Publish("/grid/dragdrop/minorversion/"):_cur.enableMinorCheckIn=="major"?Akumina.AppPart.DMS.Eventing.Publish("/grid/dragdrop/majorversion/"):Akumina.AppPart.DMS.Eventing.Publish("/grid/dragdrop/uploadprogressdialog/")):$(".ia-form-error").show()};this.FieldValidation=function(){var i=0;return $(".ia-library-upload-reqs .ia-form").find("input[type=text]:visible").each(function(){$(this).val()==""?(i=i+1,$(this).parents(".ia-form-row").hasClass(_cur.CN_errorField)||$(this).parents(".ia-form-row").addClass(_cur.CN_errorField)):$(this).parents(".ia-form-row").removeClass(_cur.CN_errorField)}),$(".ia-library-upload-reqs .ia-form").find("textarea").each(function(){$(this).val()==""?(i=i+1,$(this).parents(".ia-form-row").hasClass(_cur.CN_errorField)||$(this).parents(".ia-form-row").addClass(_cur.CN_errorField)):$(this).parents(".ia-form-row").removeClass(_cur.CN_errorField)}),i>0?!1:!0};this.FilesUploadToLibrary=function(){for(var k,filename,j=0,uploadedfiles=[],i=0;i<this.files.length;i++)filename=this.files[i].name,jQuery.inArray(filename,_cur.rejectedOWFiles)<0&&++j;if(_cur.uploadingFiles.length=0,_cur.currentCount=0,j>0){for($(".ia-progress-percent")&&$(".ia-progress-percent").attr("style","width: 10%;"),$(".ia-progress-text")&&$(".ia-progress-text").html("10%"),k=0,i=0;i<this.files.length;i++)filename=this.files[i].name,jQuery.inArray(filename,_cur.rejectedOWFiles)<0&&(++k,uploadedfiles.push(filename),_cur.uploadingFiles.push(i));_cur.uploadingFiles.length>0&&_cur.getBuffer(0,this.files[_cur.uploadingFiles[0]],j)}};this.getBuffer=function(i,file,len){if(file.size>0){var reader=new FileReader;reader.onload=function(e){_cur.createFile(i,e.target.result,file.name,len)};reader.onerror=function(){_cur.errorHandler(file.name,i,1e3)};reader.readAsArrayBuffer(file)}else _cur.errorHandler(file.name,i,len)};this.createFile=function(i,resultpanel,name,len){var serverRelativeUrlToFolder=parentGrid.GetSiteName()+parentGrid.viewModel.selectedFolder,baseUrl=parentGrid.GetSiteUrl();serverRelativeUrlToFolder=="/"&&(serverRelativeUrlToFolder=serverRelativeUrlToFolder+parentGrid.viewModel.listName);_cur.forceCheckoutFile(resultpanel,baseUrl,serverRelativeUrlToFolder,name,i,len)};this.forceCheckoutFile=function(arrayBuffer,serverUrl,serverRelativeUrlToFolder,fileName,i,len){if(_cur.parentGrid.viewModel.MetaData.forceCheckOut){var relativeURL=_cur.parentGrid.GetSiteName()+_cur.parentGrid.viewModel.selectedFolder+"/"+fileName;_cur.GetFileAsListItem(serverUrl,serverRelativeUrlToFolder,relativeURL).then(function(data){var fileItemId=data.d.Id,clientContext=SP.ClientContext.get_current(),webSite,item,file;clientContext!=undefined&&clientContext!=null&&(webSite=clientContext.get_web(),this.list=webSite.get_lists().getByTitle(_cur.parentGrid.viewModel.listName),item=this.list.getItemById(fileItemId),file=item.get_file(),file.checkOut(),clientContext.load(file),Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.DragDrop.forceCheckoutFile"),clientContext.executeQueryAsync(Function.createDelegate(this,function(){_cur.addFileToFolder(arrayBuffer,serverUrl,serverRelativeUrlToFolder,fileName,i,len)}),Function.createDelegate(this,function(sender,args){_cur.errorHandler(fileName,i,len,args.get_message())})))},function(error){error.status==404?_cur.addFileToFolder(arrayBuffer,serverUrl,serverRelativeUrlToFolder,fileName,i,len):_cur.errorHandler(fileName,i,len,error.statusText)})}else _cur.addFileToFolder(arrayBuffer,serverUrl,serverRelativeUrlToFolder,fileName,i,len)};this.addFileToFolder=function(arrayBuffer,serverUrl,serverRelativeUrlToFolder,fileName,i,len){var fileCollectionEndpoint=String.format("{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files/add(overwrite=true, url='{2}')",serverUrl,serverRelativeUrlToFolder,fileName);jQuery.ajax({url:fileCollectionEndpoint,type:"POST",data:arrayBuffer,processData:!1,headers:{accept:"application/json;odata=verbose","X-RequestDigest":jQuery("#__REQUESTDIGEST").val()},success:function(data){var currentFile=data.d,fileGuid=data.d.UniqueId;_cur.GetFileAsListItem(serverUrl,serverRelativeUrlToFolder,currentFile.ServerRelativeUrl,fileGuid).done(function(data){var fileItemId=data.d.Id,fileModerationLevel=currentFile.Level;_cur.UpdateTaxonomyData(fileItemId).then(function(){_cur.ProcessCheckinCheckoutFile(fileItemId,currentFile,fileModerationLevel);_cur.successHandler(fileName,i,len)},function(error){_cur.errorHandler(fileName,i,len,error)})}).fail(function(error){_cur.errorHandler(fileName,i,len,error.responseText)})},error:function(xhr,textStatus){try{var response=JSON.parse(xhr.responseText),message=response?response.error.message.value:" Unexpected response from server. The status code of response is "+textStatus.toString();_cur.errorHandler(fileName,i,len,message)}catch(err){_cur.errorHandler(fileName,i,len,"Unexpected response from server. The status code of response is "+xhr.status.toString())}}})};this.ProcessCheckinCheckoutFile=function(fileItemId,currentFile,fileModerationLevel){var listname=parentGrid.viewModel.listName,item,file,clientContext=SP.ClientContext.get_current(),webSite,checkincomment;clientContext!=undefined&&clientContext!=null&&(webSite=clientContext.get_web(),this.list=webSite.get_lists().getByTitle(listname),item=this.list.getItemById(fileItemId),file=item.get_file(),checkincomment="",currentFile.CheckOutType!=2?(checkincomment="",_cur.enableMinorCheckIn=="minor"?($("#checkInFile").is(":checked")==!0&&(checkincomment=$(".checkinComment").val(),$(".checkInDraft").is(":checked")&&file.checkIn(checkincomment,SP.CheckinType.minorCheckIn),$(".checkInPublish").is(":checked")&&file.checkIn(checkincomment,SP.CheckinType.majorCheckIn)),$("#checkInCheckOutFile").is(":checked")==!0&&(checkincomment=$(".checkInCheckOutComment").val(),$(".checkInCheckoutDraft").is(":checked")&&file.checkIn(checkincomment,SP.CheckinType.minorCheckIn),$(".checkInCheckOutPublish").is(":checked")&&file.checkIn(checkincomment,SP.CheckinType.majorCheckIn),file.checkOut())):(checkincomment=$(".dd_checkincomment").val(),file.checkIn(checkincomment,SP.CheckinType.majorCheckIn),$(".dd_fileCheckinYes").is(":checked")==!0&&file.checkOut())):(checkincomment="",_cur.enableMinorCheckIn=="minor"?fileModerationLevel==2&&(checkincomment="",$("#checkInFile").is(":checked")==!0&&(checkincomment=$(".checkinComment").val(),$(".checkInPublish").is(":checked")&&file.publish(checkincomment)),$("#checkInCheckOutFile").is(":checked")==!0&&(checkincomment=$(".checkInCheckOutComment").val(),$(".checkInCheckOutPublish").is(":checked")&&file.publish(checkincomment),file.checkOut())):(checkincomment=$(".dd_checkincomment").val(),fileModerationLevel==2&&file.publish(checkincomment),$(".dd_fileCheckinYes").is(":checked")==!0&&file.checkOut())),clientContext.load(item),Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.DragDrop.ProcessCheckinCheckoutFile"),clientContext.executeQueryAsync(Function.createDelegate(this,function(){}),Function.createDelegate(this,function(){})))};this.GetFileAsListItem=function(serverUrl,serverRelativeUrlToFolder,fileName,fileGuid){var appweburl=window.location.protocol+"//"+window.location.host+parentGrid.GetSiteUrl(),restSource=String.format("{0}/_api/web/GetFileByServerRelativeUrl('{1}')/listitemallfields",serverUrl,fileName),dfd;return fileGuid!=null&&fileGuid!=""&&(restSource=String.format("{0}/_api/web/GetFileById('{1}')/listitemallfields",serverUrl,fileGuid)),dfd=$.Deferred(),$.ajax({url:restSource,method:"GET",headers:{accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},success:function(data){var d=data;dfd.resolve(d)},error:function(err){dfd.reject(err)}}),dfd};this.UpdateTaxonomyData=function(fileItemId){var dfd=new $.Deferred,ctx=SP.ClientContext.get_current(),list=ctx.get_web().get_lists().getByTitle(parentGrid.viewModel.listName),item=list.getItemById(fileItemId);return ctx.load(item),Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.DragDrop.UpdateTaxonomyData.getItemById"),ctx.executeQueryAsync(Function.createDelegate(this,function(){for(var field,idxVal,termName,termGuid,termLabelSet,idxTerm,terms,termString="",termDelimiter="",idxField=0;idxField<_cur.requiredFields.length;idxField++)if(termString="",termDelimiter="",field=list.get_fields().getByInternalNameOrTitle(_cur.requiredFields[idxField].fieldInternalName),_cur.requiredFields[idxField].fieldTypeDisplayName!="Managed Metadata"&&(field.validateSetValue(item,$("#"+_cur.requiredFields[idxField].fieldId).val()),ctx.load(field)),_cur.requiredFields[idxField].fieldTypeDisplayName=="Managed Metadata"){var taxField=ctx.castTo(field,SP.Taxonomy.TaxonomyField),termSet=_cur.requiredFields[idxField].oAssociatedTaxonomy,taxTerms=$("#"+_cur.requiredFields[idxField].fieldId).val();for(taxTerms=taxTerms.split(","),idxVal=0;idxVal<taxTerms.length;idxVal++)for(termName=taxTerms[idxVal].toLowerCase().trim(),termName=_cur.FindTermInAssociatedTaxonomy(termName),termGuid=parentGrid.viewModel.TaxonomyData.reverseMap[termName].toString().trim(),termLabelSet=taxTerms[idxVal].trim().split(">"),idxTerm=0;idxTerm<termLabelSet.length;idxTerm++)termString+=termDelimiter+"-1;#"+termLabelSet[idxTerm].trim()+"|"+termGuid,termDelimiter=";#";if(_cur.requiredFields[idxField].AllowMultipleValues)terms=new SP.Taxonomy.TaxonomyFieldValueCollection(ctx,termString,taxField),taxField.setFieldValueByValueCollection(item,terms);else{var termName=taxTerms[0].toLowerCase().trim(),taxonomySession=SP.Taxonomy.TaxonomySession.getTaxonomySession(ctx),objtermStore=taxonomySession.getDefaultSiteCollectionTermStore(),objtermSet=objtermStore.getTermSetsByName(termSet,_spPageContextInfo.currentLanguage).getByName(termSet),objterm=objtermSet.get_terms().getByName(termName);ctx.load(objtermSet);ctx.load(objterm);terms=new SP.Taxonomy.TaxonomyFieldValue;taxField.setFieldValueByTerm(item,objterm,_spPageContextInfo.currentLanguage)}ctx.load(taxField)}item.update();Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.DragDrop.UpdateTaxonomyData.setFieldValueByTerm");ctx.executeQueryAsync(function(data){dfd.resolve(data)},function(sender,args){dfd.reject(args.get_message())})}),Function.createDelegate(this,function(sender,args){dfd.reject(args.get_message())})),dfd};this.FindTermInAssociatedTaxonomy=function(termName){var key,innerTerm;for(key in parentGrid.viewModel.TaxonomyData.reverseMap)if(parentGrid.viewModel.TaxonomyData.reverseMap.hasOwnProperty(key))if(key.lastIndexOf(">")!=-1){if(innerTerm=key.substring(key.lastIndexOf(">")+1,key.length),innerTerm.toLowerCase().trim()==termName.toLowerCase().trim())return key}else if(key.toLowerCase().trim()==termName.toLowerCase().trim())return key};this.successHandler=function(fileName,i,len){++_cur.currentCount;_cur.successfulUpload.push(fileName);var len=_cur.uploadingFiles.length;_cur.currentCount==len?(setTimeout(_cur.uploadProgress(Math.ceil(90/len),!0),500),_cur.percent=10):_cur.uploadProgress(Math.ceil(90/len),!1);_cur.currentCount<len?_cur.getBuffer(_cur.currentCount,this.files[_cur.uploadingFiles[_cur.currentCount]],len):_cur.showUploadMessages()};this.showUploadMessages=function(){_cur.successfulUpload.length>0&&parentGrid.OnCompleteDocumentOptions(!0,"File(s) uploaded successfully.",!0);_cur.fileStatus.length>0&&Akumina.AppPart.DMS.Eventing.FireError(_cur.fileStatus)};this.errorHandler=function(name,i,len,messsage){var filePath,len;++_cur.currentCount;len==1e3?_cur.fileStatus.push(name+" -\tFolders and unsupported file types can't be uploaded."):messsage!=null&&typeof messsage!="undefined"&&(filePath='"'+parentGrid.GetSiteUrl()+parentGrid.viewModel.selectedFolder+"/"+name+'"',_cur.fileStatus.push(name+" - "+messsage.replace(filePath,"")));len=_cur.uploadingFiles.length;_cur.currentCount==len?(setTimeout(_cur.uploadProgress(Math.ceil(90/len),!0),500),_cur.percent=10,Akumina.AppPart.DMS.Eventing.FireError(_cur.fileStatus)):_cur.uploadProgress(Math.round(90/len),!1);_cur.currentCount<len?_cur.getBuffer(_cur.currentCount,this.files[_cur.uploadingFiles[_cur.currentCount]],len):_cur.showUploadMessages()};this.uploadProgress=function(uploadPercent,status){_cur.percent=_cur.percent+uploadPercent;_cur.percent>100&&(_cur.percent=100);$(".ia-progress-percent")&&$(".ia-progress-percent").attr("style","width: "+_cur.percent+"%;");$(".ia-progress-text")&&$(".ia-progress-text").html(_cur.percent+"%");status&&($(".uploaded_Success").length>0&&$(".uploaded_Success").html(_cur.fileStatus),setTimeout(function(){_cur.callCodeBehindForUpload()},5e3))};this.callCodeBehindForUpload=function(){$.magnificPopup.close()};this.getCategoryModel=function(ele){var categoryelement=$(ele).prev(),fieldName=categoryelement.attr("field-name"),associatedcategory=categoryelement.attr("associated-taxonomy"),selectedcategory="",selectedTerms=[],key,selectedtree,TaxSelectedNames,TaxSelectedPath;for(key in _cur.selectedFileTermSets)selectedTerms.push(_cur.selectedFileTermSets[key].join(","));selectedTerms.length>0?(selectedcategory=selectedTerms.join(","),_cur.selectedFileTermSets={}):selectedcategory=categoryelement.attr("selected-taxonomies");$(".gridCategory .ax-treeview").html("");$(".gridCategory .ax-treeview").attr("field-name",fieldName);selectedtree="";$(".ax-category-tree").find("input[value='"+associatedcategory+"']").length>0?$(".ax-category-tree").find("input[value='"+associatedcategory+"']").parent().find("ul").length>0&&(selectedtree="<li>"+$(".ax-category-tree").find("input[value='"+associatedcategory+"']").parent().html()+"<\/li>"):$(".ax-category-tree").find("ul[category='"+associatedcategory+"']").length>0&&(selectedtree=$(".ax-category-tree").find("ul[category='"+associatedcategory+"']").html());$(".gridCategory .ax-treeview").html("<ul>"+selectedtree+"<\/ul>");$(".gridCategory .ax-treeview").find("input[value='"+associatedcategory+"']").length>0&&$(".gridCategory .ax-treeview").find("input[value='"+associatedcategory+"']").attr("disabled","");$(".gridCategory .ax-treeview ul").treeview({persist:"location",collapsed:!0});$(".ax-treeview").each(function(){var currentSelected=$(this).next(".ia-current-selected").children(".ia-current-selected-list"),hiddenSelected=$(this).next(".ia-current-selected").children(".selectedTaxonomy"),treeview=$(this);$(currentSelected).html("");$(hiddenSelected).html("");$(this).find("input[type=checkbox]").on("change",function(){$(currentSelected).html("");$(hiddenSelected).html("");var arrTemp=[],arrTempVal=[];$(treeview).find("input[type=checkbox]:checked").each(function(ind,val){arrTemp.push(" <span>"+$(val).next().html()+"<\/span>");arrTempVal.push($(val).val())});$(currentSelected).html(arrTemp.join());$(hiddenSelected).val(arrTempVal.join())})});selectedcategory!=""&&(_cur.SetValueToInput(selectedcategory),TaxSelectedNames=$("#template-ia-upload-form .ax-treeview").next(".ia-current-selected").children(".ia-current-selected-list").text(),TaxSelectedPath=$("#template-ia-upload-form .ax-treeview").next(".ia-current-selected").children(".selectedTaxonomy").val(),$(categoryelement).attr("selected-taxonomies",TaxSelectedPath),$(categoryelement).val(TaxSelectedNames));$.magnificPopup.open({items:{src:"#upload-category-popup",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0})};this.SetValueToInput=function(defaultVal){for(var values=defaultVal.split(","),i=0;i<values.length;i++)$(".gridCategory").find("input[value='"+values[i]+"']").length>0&&$(".gridCategory").find("input[value='"+values[i]+"']").click()};this.uploadFilesHighlight=function(){var fupload=_cur.successfulUpload;fupload!=undefined&&fupload.length>0&&$("#drop_zone table#grid tbody").find("tr").length>0&&$("#drop_zone table#grid tbody").find("tr").each(function(){var fileType=$.trim($(this).find(".itemhiddenFileType").find(".tablesaw-cell-label").justtext()),filecheck,that;fileType!=""&&(filecheck=$(this).find(".ia-doclist-name").find(".ia-doclist-title").justtext(),_cur.successfulUpload.indexOf(filecheck)!=-1&&($(this).attr("class","ia-doclist-row-successful"),that=$(this),setTimeout(function(){that.attr("class","");fupload!=undefined&&fupload.length>0&&(_cur.successfulUpload=[])},1e4)))})}});typeof Akumina.AppPart.DMS.Grid=="undefined"&&(Akumina.AppPart.DMS.Grid=function(){function unCheckSelections(){$(".ia-document-library tbody td input[type=checkbox]:checked").trigger("click");$(".ia-document-library tbody tr").removeClass("ia-doclist-row-selected");_cur.selection(selectionbox,!1);_cur.selection(allCheckbox,!1)}function callPreviewPopup(){$.magnificPopup.open({items:{src:".ia-modal-preview",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0})}var _cur=this,allCheckbox=".ia-doclist-selectAll",selectionbox=".selection",PagingManager;[];this.viewModel={};PagingManager={pageNumber:1,pageSize:25,totalPages:1,scrollReady:!0,ComputeTotalPages:function(resultCount){this.totalPages=1;resultCount>0&&(this.totalPages=Math.ceil(resultCount/this.pageSize))},Reset:function(element){this.pageNumber=1;this.totalPages=1;element.scrollTop(0);this.scrollReady=!0},IsFirstPage:function(){return this.pageNumber==1},IsLastPage:function(){return!(this.pageNumber<this.totalPages)},NextPage:function(){return this.IsLastPage()?!1:(this.pageNumber=this.pageNumber+1,!0)}};this.Init=function(){var editMode=Akumina.AddIn.Utilities.getEditMode(),pageParam;editMode||(_cur._settings=this.settings,pageParam=parseInt(_cur._settings.pageSize),PagingManager.pageSize=isNaN(pageParam)?25:pageParam,_cur.viewModel.searchReady=!0,_cur.viewModel.searchQueue=[],Akumina.AppPart.DMS.Logger.Write("Grid.Load"),Akumina.AppPart.DMS.Logger.Write("Settings: "+_cur._settings),Akumina.AppPart.DMS.Eventing.Subscribe("/grid/searchcompleted/",_cur.OnSearchCompleted),Akumina.AppPart.DMS.Eventing.Subscribe("/foldertree/change/",_cur.OnFolderChange),Akumina.AppPart.DMS.Eventing.Subscribe("/refinement/filterchange/",_cur.OnRefinementsChanged),Akumina.AppPart.DMS.Eventing.Subscribe("/grid/refreshgridcontents/",_cur.Search),Akumina.AppPart.DMS.Eventing.Subscribe("/gridtab/change/",_cur.OnTabChange),Akumina.AppPart.DMS.Eventing.Subscribe("/grid/error/",_cur.OnError),Akumina.AppPart.DMS.Eventing.Subscribe("/grid/success/",_cur.OnSuccess),Akumina.AppPart.DMS.Eventing.Subscribe("/grid/pagenext/",_cur.OnPageNext),_cur.InitializeItemArrays(),_cur.GetCurrentUser(),_cur.viewModel.MetaData=new Akumina.AppPart.DMS.MetaData,_cur.viewModel.Cookies=new Akumina.AppPart.DMS.Cookies,_cur.showDefaultFolder(_cur._settings.startFolder))};this.showDefaultFolder=function(listName){$.ajax({url:_cur.GetSiteUrl()+"/_api/web/Lists/GetByTitle('"+listName+"')/RootFolder",method:"GET",headers:{Accept:"application/json; odata=verbose"},success:function(data){$("#gridError").html("");var model=new Akumina.AppPart.DMS.Models.FolderOnChangeModel("/"+listName,listName,data.d.Name,listName);model.isFolderChangeFired=!0;Akumina.AppPart.DMS.Eventing.Publish("/foldertree/change/",model)},error:function(){$("#ia-loading").css("display","none");$("#gridError").html('Folder "'+listName+'" not found.')}})};this.InitializeItemArrays=function(){_cur.viewModel.allFileItems=[];_cur.viewModel.myFileItems=[];_cur.viewModel.recentFileItems=[];_cur.viewModel.popularFileItems=[]};this.GetCurrentUser=function(){Akumina.AppPart.DMS.Logger.Write("Grid.GetCurrentUser");_cur.viewModel.currentUserId=_spPageContextInfo.userId;var url=_cur.GetSiteUrl()+"/",requestUri=url+"/_api/web/getuserbyid("+_cur.viewModel.currentUserId+")";$.ajax({url:requestUri,contentType:"application/json;odata=verbose",headers:{accept:"application/json;odata=verbose"},success:_cur.OnGetCurrentUserSuccess,error:_cur.OnGetCurrentUserError})};this.OnGetCurrentUserSuccess=function(data){Akumina.AppPart.DMS.Logger.Write("Grid.OnGetCurrentUserSuccess");_cur.viewModel.currentUserName=data.d.Title};this.OnGetCurrentUserError=function(){Akumina.AppPart.DMS.Logger.Write("Grid.OnGetCurrentUserError")};this.OnFolderChange=function(model){var listInfoDef,folderName;Akumina.AppPart.DMS.Logger.Write("Grid.OnFolderChange");listInfoDef=new $.Deferred;_cur.viewModel.listName==undefined||model.StartFolder.toString().toLowerCase().trim()!=_cur.viewModel.listName.toString().toLowerCase().trim()?(_cur.ShowLoading(),_cur.fetchMetadata(model,listInfoDef)):model.Id.toString().toLowerCase().trim()!=_cur.viewModel.selectedFolder.toString().toLowerCase().trim()||_cur.viewModel.filters||_cur.viewModel.isFolderCreate?(_cur.ShowLoading(),_cur.viewModel.isFolderCreate=!1,listInfoDef.resolve()):listInfoDef.reject();_cur.viewModel.filters=_cur.viewModel.isFolderChangeFired?null:_cur.viewModel.filters;_cur.viewModel.isFolderChangeFired=model.isFolderChangeFired;model.Id==undefined&&(model.Id="/"+_cur.viewModel.listName);_cur.viewModel.selectedFolder=model.Id;folderName=_cur.GetInnermostFolderName(_cur.viewModel.selectedFolder);folderName.indexOf(_cur.viewModel.listRootFolder)>=0&&(folderName=folderName.replace(_cur.viewModel.listRootFolder,_cur.viewModel.listName));$("#currentFolderName").html(folderName);_cur.viewModel.selectedFolder.split("/")[1]!=_cur.viewModel.listRootFolder&&(_cur.viewModel.selectedFolder=_cur.viewModel.selectedFolder.replace(_cur.viewModel.listName,_cur.viewModel.listRootFolder));listInfoDef.then(function(){_cur.Search("folderchange")}).fail(function(){})};this.fetchMetadata=function(model,listInfoDef){_cur.viewModel.listName=model.StartFolder;_cur.viewModel.listRootFolder=model.RootFolder;_cur.GetListId(_cur.viewModel.listName).done(function(listId){_cur.viewModel.listId=listId;_cur.GetFieldInformationForList(_cur.viewModel.listId,_cur.viewModel.listName).done(function(){var taxFields,categories,idxField;if(_cur.viewModel.MetaData.viewListItemsPermission){for($("#ia-grid").show(),$("#ia-loading").show(),$("#ia-permission").hide(),$("#ia-permission").html(""),_cur.viewModel.MetaData.addPermission?$("#addDocs").show():$("#addDocs").hide(),taxFields=_cur.viewModel.MetaData.GetTaxonomyFields(),categories=[],idxField=0;idxField<taxFields.length;idxField++)categories.push(taxFields[idxField].termSetId);_cur.viewModel.TaxonomyData=new Akumina.AppPart.DMS.Taxonomy(categories.join(","));_cur.viewModel.TaxonomyData.LoadTaxonomyMap();_cur.viewModel.DragDropHandler=new Akumina.AppPart.DMS.DragDrop(_cur);_cur.viewModel.DragDropHandler.Init();listInfoDef.resolve()}else $("#ia-grid").hide(),$("#ia-loading").hide(),$("#ia-permission").show(),$("#ia-permission").html("You do not have access to library: '"+_cur.viewModel.listName+"'"),listInfoDef.reject()}).fail(function(data){_cur.HideLoading();Akumina.AppPart.DMS.Logger.Write("Error occured on Getting MetaData: "+JSON.stringify(data))})}).fail(function(data){_cur.HideLoading();Akumina.AppPart.DMS.Logger.Write("Error occured on Getting List Info: "+JSON.stringify(data))})};this.GetInnermostFolderName=function(folderPath){var pathTokens=folderPath.split("/");return pathTokens[pathTokens.length-1]};this.GetListId=function(listName){var listInfoDef=new $.Deferred,url;return Akumina.AppPart.DMS.Logger.Write("Grid.GetListId"),url=_cur.GetSiteUrl()+"/",$.ajax({url:url+"/_api/web/lists/getbytitle('"+listName+"')",method:"GET",headers:{Accept:"application/json; odata=verbose"},success:function(data){listInfoDef.resolve(data.d.Id)},error:function(data){listInfoDef.reject(data)}}),listInfoDef};this.GetFieldInformationForList=function(listId,listName){return Akumina.AppPart.DMS.Logger.Write("Grid.ReadFieldInformation for List = "+listName+", Id = "+listId),_cur.viewModel.MetaData.Init(_cur.viewModel.listId,listName),_cur.viewModel.MetaData.deferred};this.Search=function(caller){var refreshRefiner,newsearch,serverTimeDef;if(_cur.ShowLoading(),_cur.viewModel.searchReady)_cur.viewModel.searchReady=!1;else{_cur.viewModel.searchQueue.push(caller);return}refreshRefiner=!1;Akumina.AppPart.DMS.Logger.Write("Grid.Search");Akumina.AppPart.DMS.Logger.Write("Grid.Search - Caller => "+caller);$(".noMoreRecords").hide();$(".showMoreResults").show();caller==undefined&&(caller="folderchange");newsearch=!1;switch(caller){case"folderchange":newsearch=!0;_cur.InitializeItemArrays();PagingManager.Reset($("#s4-workspace"));refreshRefiner=!0;break;case"filterchange":newsearch=!1;_cur.ClearResultsForSelectedTab();PagingManager.Reset($("#s4-workspace"));break;case"tabchange":newsearch=!1;_cur.ClearResultsForSelectedTab();PagingManager.Reset($("#s4-workspace"));refreshRefiner=!0;break;case"itemstatechanged":newsearch=!1;_cur.ClearResultsForSelectedTab();PagingManager.Reset($("#s4-workspace"));break;case"filecountchanged":newsearch=!0;_cur.InitializeItemArrays();PagingManager.Reset($("#s4-workspace"));refreshRefiner=!0;break;case"sortchanged":newsearch=!1;_cur.ClearResultsForSelectedTab();PagingManager.Reset($("#s4-workspace"));break;case"searchtextchanged":newsearch=!1;_cur.ClearResultsForSelectedTab();PagingManager.Reset($("#s4-workspace"));break;case"pagechange":newsearch=!1;break;default:newsearch=!1}serverTimeDef=$.Deferred();_cur.getTimeZoneAndServerDateTime(serverTimeDef);serverTimeDef.then(function(timezoneOffset){var searchParameters=_cur.getSearchArguments(),search,result;searchParameters.timezoneOffset=timezoneOffset;search=new Akumina_AppParts_Search_CAML(searchParameters);result=search.Transform(newsearch).then(function(data){var searchContext={data:data,newsearch:newsearch,caller:caller,parameters:searchParameters,refreshRefiner:refreshRefiner};_cur.OnSearchSuccess(searchContext)},function(error){var searchContext={data:[],newsearch:newsearch,caller:caller,parameters:searchParameters,refreshRefiner:refreshRefiner};_cur.OnSearchFailed(error,searchContext)})},_cur.getTimeZoneAndServerDateTimeFailed)};this.getTimeZoneAndServerDateTime=function(def){var context=SP.ClientContext.get_current(),web=context.get_web(),timeZone=web.get_regionalSettings().get_timeZone();return context.load(timeZone),Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.Grid.getTimeZoneAndServerDateTime"),context.executeQueryAsync(function(){var info=timeZone.get_information(),offset=(info.get_bias()+info.get_daylightBias())/60;def.resolve(offset)},function(){def.reject()}),def};this.getTimeZoneAndServerDateTimeFailed=function(){Akumina.AppPart.DMS.Logger.Write("Error occured on getTimeZoneAndServerDateTime");_cur.HideLoading()};this.getSearchArguments=function(){_cur.viewModel.sortOptions==undefined&&(_cur.viewModel.sortOptions=_cur.GetSortOptions());var listId=_cur.viewModel.listId,listName=_cur.viewModel.listName,folderPath=_cur.GetSiteName()+_cur.viewModel.selectedFolder,currentTab=_cur._settings.tabSettings.selectedTab,isPopularTabSelected=_cur.IsPopularItemsTabSelected(),isRecentTabSelected=_cur.IsRecentItemsTabSelected(),recentLimit=_cur._settings.tabSettings.numberOfRecentFiles,popularLimit=_cur._settings.tabSettings.numberOfPopularFiles,searchText=_cur.viewModel.searchTerm==undefined?"":_cur.viewModel.searchTerm,rowLimit=isPopularTabSelected?popularLimit:isRecentTabSelected?recentLimit:PagingManager.pageSize,sortField=isRecentTabSelected?"Modified":_cur._settings.sortField,sortOrder=isRecentTabSelected?!1:_cur._settings.sortAscending,filters=_cur.viewModel.filters==null||_cur.viewModel.filters==undefined?{}:_cur.viewModel.filters,skip=(PagingManager.pageNumber-1)*PagingManager.pageSize,currentUserName=_cur.viewModel.currentUserName;return Akumina.AppPart.DMS.Models.FolderSearchModel(listId,listName,folderPath,searchText,currentTab,rowLimit,sortField,sortOrder,filters,skip,currentUserName,recentLimit,popularLimit)};this.GetSortOptions=function(sortByElement){var newsortOptions={},ascendingClass="ia-sort-asc",descendingClass="ia-sort-desc",ascendingImageClass="caret-up",nameColumn="ia-doclib-header-name",sortedClass="ia-doclib-header-sorted";if(sortByElement==undefined)return newsortOptions.columnName=nameColumn+" "+sortedClass,newsortOptions.sortType=ascendingClass,newsortOptions.sortImage=ascendingImageClass,newsortOptions.sortByName="true",newsortOptions;newsortOptions.columnName=sortByElement.attr("class").replace(sortedClass,"").trim();switch(newsortOptions.columnName){case nameColumn:newsortOptions.sortByName="true";_cur._settings.sortField="FileLeafRef";break;case"ia-doclib-header-modified":newsortOptions.sortByDate="true";_cur._settings.sortField="Modified";break;case"ia-doclib-header-modifiedBy":newsortOptions.sortByUser="true";_cur._settings.sortField="Editor"}return _cur.viewModel.sortOptions.columnName.replace(sortedClass,"").trim()==newsortOptions.columnName?(_cur.viewModel.sortOptions.sortType==ascendingClass&&(newsortOptions.sortType=descendingClass,_cur._settings.sortAscending=!1),_cur.viewModel.sortOptions.sortType==descendingClass&&(newsortOptions.sortType=ascendingClass,_cur._settings.sortAscending=!0)):newsortOptions.sortType=ascendingClass,newsortOptions.sortImage=newsortOptions.sortType==ascendingClass?ascendingImageClass:"caret-down",newsortOptions};this.IsPopularItemsTabSelected=function(){return _cur._settings.tabSettings.selectedTab.toString().toLowerCase()=="popularfiles"};this.IsRecentItemsTabSelected=function(){return _cur._settings.tabSettings.selectedTab.toString().toLowerCase()=="recentfiles"};this.OnSearchSuccess=function(searchContext){var camlresults=_cur.GetCamlSearchResultsAsModel(searchContext.data);searchContext.newsearch&&(_cur.viewModel.allResults=_cur.GetCamlSearchResultsAsModel(searchContext.data.allResults),_cur.viewModel.cachedRecentItems=_cur.GetCamlSearchResultsAsModel(searchContext.data.recentResults),_cur.viewModel.containsFolder=_cur.containsFolder(_cur.viewModel.allResults));_cur.searchKql(searchContext,camlresults)};this.OnSearchFailed=function(error,searchContext){Akumina.AppPart.DMS.Logger.Write("Error occured on Akumina_AppParts_Search_CAML.search");searchContext.data.totalResultCount=0;searchContext.data.allItemsCount=0;searchContext.data.myItemsCount=0;searchContext.data.recentItemsCount=0;searchContext.data.allResults=[];_cur.viewModel.allResults=[];_cur.searchKql(searchContext,[]);Akumina.AppPart.DMS.Eventing.FireError("Search failed.")};this.searchKql=function(searchContext,camlresults){var search_kql=new Akumina_Interaction_Search_Kql(searchContext.parameters),result=search_kql.GetDataForCaml().then(function(kqlresults){_cur.OnSearchSuccess_Kql(searchContext,camlresults,kqlresults)},function(error){_cur.OnSearchFailed_Kql(error,camlresults,searchContext)})};this.containsFolder=function(result){for(var i=0;i<result.length;i++)if(result[i].isFolder==!0)return!0;return!1};this.getFilteredResults=function(itemsArray,allItemsArray){for(var j,intersectedResults=[],i=0;i<allItemsArray.length;i++)for(j=0;j<itemsArray.length;j++)allItemsArray[i].docid==itemsArray[j].docid&&intersectedResults.push(itemsArray[j]);return intersectedResults};this.GetCamlSearchResultsAsModel=function(data){for(var item,result=[],i=0;i<data.length;i++)_cur.viewModel.filters&&(_cur.viewModel.filters.startdate&&data[i].Modified<_cur.viewModel.filters.startdate&&(data[i].Modified=_cur.viewModel.filters.startdate),_cur.viewModel.filters.enddate&&data[i].Modified>_cur.viewModel.filters.enddate&&(data[i].Modified=_cur.viewModel.filters.enddate)),item={selected:"",docid:data[i].Id,title:data[i].FileLeafRef,modified:_cur.formatDateForGrid(data[i].Modified),firstname:data[i].FieldValuesAsText.Editor,lastname:"",profileurl:_cur.GetSiteUrl()+"/_layouts/15/userdisp.aspx?ID="+data[i].EditorId,itemHidden:data[i].Id,itemhiddenFileType:data[i].File_x0020_Type,itemhiddenPath:data[i].EncodedAbsUrl,itemEditPermission:"yes:yes",itemhiddenListId:_cur.viewModel.listId,checkOutUserId:data[i].CheckoutUserId,isCheckedOut:data[i].CheckoutUserId!=null?!0:!1,isFolder:data[i].FileSystemObjectType==1,isWordDoc:data[i].FileSystemObjectType==0,iAmOwner:data[i].EditorId==_cur.viewModel.currentUserId?!0:!1,docIconURL:_cur.getDocImageClass(data[i].File_x0020_Type)},result.push(item);return result};this.OnSearchFailed_Kql=function(error,camlresults,searchContext){Akumina.AppPart.DMS.Logger.Write("Error occured on Akumina_AppParts_Search_KQL.search");_cur.showKQLResults(searchContext,camlresults,[]);_cur.IsPopularItemsTabSelected()&&Akumina.AppPart.DMS.Eventing.FireError("Cannot retrieve popular items. Please configure search service.")};this.OnSearchSuccess_Kql=function(searchContext,camlresults,data){_cur.showKQLResults(searchContext,camlresults,data)};this.showKQLResults=function(searchContext,camlresults,data){var kqlresults=_cur.GetKqlSearchResultsAsModel(data),searchResults;searchContext.newsearch?(_cur.viewModel.popularFileItems=_cur.CompareKQLAndCaml(kqlresults,_cur.viewModel.allResults,_cur._settings.tabSettings.numberOfPopularFiles),_cur.viewModel.cachedPopularItems=_cur.viewModel.popularFileItems):_cur.viewModel.popularFileItems=_cur.CompareKQLAndCaml(kqlresults,_cur.viewModel.cachedPopularItems,_cur._settings.tabSettings.numberOfPopularFiles);_cur.IsRecentItemsTabSelected()&&(camlresults=_cur.getFilteredResults(_cur.viewModel.cachedRecentItems,camlresults));_cur.IsPopularItemsTabSelected()||_cur.AddPageResults(camlresults);searchResults=_cur.GetResultsForSelectedTab();searchResults.totalResultCount=searchContext.data.totalResultCount;searchContext.newsearch&&(searchResults.totalResultCount=searchContext.data.totalResultCount,searchResults.allItemsCount=searchContext.data.allItemsCount,searchResults.myItemsCount=searchContext.data.myItemsCount,searchResults.recentItemsCount=searchContext.data.recentItemsCount,searchResults.popularItemsCount=_cur.viewModel.popularFileItems.length);_cur.UpdateTabModel(searchContext,searchResults);searchResults.filters=_cur.viewModel.filters;searchResults.refinerResults=searchResults;_cur.IsRecentItemsTabSelected()?searchResults.allResults=_cur.viewModel.cachedRecentItems:_cur.IsPopularItemsTabSelected()?searchResults.allResults=_cur.viewModel.cachedPopularItems:(searchResults.allResults=_cur.GetCamlSearchResultsAsModel(searchContext.data.allResults),searchResults.refinerResults=_cur.GetCamlSearchResultsAsModel(searchContext.data.allResults));searchResults.refreshRefiner=searchContext.refreshRefiner;searchResults.metaData=_cur.viewModel.MetaData.GetTaxonomyFields(!1);Akumina.AppPart.DMS.Eventing.Publish("/grid/searchcompleted/",searchResults);PagingManager.scrollReady=!0};this.GetKqlSearchResultsAsModel=function(data){for(var item,kqlresults=[],i=0;i<data.length;i++)item={docid:data[i].ListItemId,title:data[i].Title,modified:data[i].LastModifiedTime,firstname:data[i].ModifiedBy,lastname:"",profileurl:_cur.GetSiteUrl()+"/_layouts/15/userdisp.aspx?ID="+data[i].EditorId,itemHidden:data[i].ListItemId,itemhiddenFileType:data[i].SecondaryFileExtension,itemhiddenPath:data[i].OriginalPath,itemEditPermission:"yes:yes",itemhiddenListId:_cur.viewModel.listId,checkOutUserId:data[i].CheckoutUserId,isCheckedOut:data[i].CheckoutUserId!=null?!0:!1,isFolder:!1,isWordDoc:!0,iAmOwner:data[i].EditorId==_cur.viewModel.currentUserId?!0:!1},kqlresults.push(item);return kqlresults};this.AddPageResults=function(pagedSearchResults){var results=_cur.GetResultsForSelectedTab();results.push.apply(results,pagedSearchResults)};this.OnRefinementsChanged=function(filters){Akumina.AppPart.DMS.Logger.Write("Grid.OnRefinementsChanged");_cur.viewModel.filters=filters;Akumina.AppPart.DMS.Eventing.Publish("/grid/refreshgridcontents/","filterchange")};this.UpdateTabModel=function(searchContext,searchresults){searchContext.newsearch&&(searchContext.caller=="folderchange"||searchContext.caller=="filecountchanged")?_cur.viewModel.tabItems=new Akumina.AppPart.DMS.Models.GridTabUpdateModel(searchresults.allItemsCount.toString(),searchresults.myItemsCount.toString(),searchresults.popularItemsCount.toString(),searchresults.recentItemsCount.toString(),_cur._settings.tabSettings.selectedTab):_cur.viewModel.tabItems.selectedTab=_cur._settings.tabSettings.selectedTab;PagingManager.ComputeTotalPages(searchresults.totalResultCount)};this.GetResultsForSelectedTab=function(){switch(_cur._settings.tabSettings.selectedTab.toString().toLowerCase()){case"allfiles":return _cur.viewModel.allFileItems;case"myfiles":return _cur.viewModel.myFileItems;case"recentfiles":return _cur.viewModel.recentFileItems;case"popularfiles":return _cur.viewModel.popularFileItems}};this.ClearResultsForSelectedTab=function(){switch(_cur._settings.tabSettings.selectedTab.toString().toLowerCase()){case"allfiles":_cur.viewModel.allFileItems=[];break;case"myfiles":_cur.viewModel.myFileItems=[];break;case"recentfiles":_cur.viewModel.recentFileItems=[];break;case"popularfiles":_cur.viewModel.popularFileItems=[]}};this.getDocImageClass=function(fileType){var imageName=fileType==null||fileType==undefined?"default":fileType.toLowerCase(),docIconUrlMap={doc:"document-iconimage-doc",docx:"document-iconimage-doc",gif:"document-iconimage-gif",jpeg:"document-iconimage-jpeg",jpg:"document-iconimage-jpeg",onetoc2:"document-iconimage-onetoc2",notebk:"document-iconimage-onetoc2",one:"document-iconimage-onetoc2",pdf:"document-iconimage-pdf",ppt:"document-iconimage-ppt",pptx:"document-iconimage-ppt",mpp:"document-iconimage-mpp",pup:"document-iconimage-mpp",vsdx:"document-iconimage-vsdx",vsx:"document-iconimage-vsdx",xsl:"document-iconimage-xsl",xls:"document-iconimage-xsl",xslx:"document-iconimage-xsl",xlsx:"document-iconimage-xsl",txt:"document-iconimage-txt",png:"document-iconimage-png",zip:"document-iconimage-zip","default":"document-iconimage-default"};return docIconUrlMap[imageName]==undefined?docIconUrlMap["default"]:docIconUrlMap[imageName]};this.CompareKQLAndCaml=function(kqlListItems,camlListItems,limit){var limitPopular=parseInt(limit),baseUrl=_cur.GetSiteUrl(),currentfolderUrl="",i,id,documents;currentfolderUrl=_cur.viewModel.selectedFolder;currentfolderUrl=$.trim(baseUrl+currentfolderUrl+"/").toLowerCase();var currentfolderlength=currentfolderUrl.split("/").length,returnedData=$.grep(kqlListItems,function(element){var folderUrl=decodeURIComponent(element.itemhiddenPath).toLowerCase(),folderlength=folderUrl.split("/").length;return currentfolderUrl!=folderUrl&&folderUrl.indexOf(currentfolderUrl)>=0&&folderlength==currentfolderlength?!0:!1}),commonPopularItems=[],count=0;for(i=0;i<returnedData.length;i++)if(id=returnedData[i].docid,documents=camlListItems.filter(function(el){return el.docid==id}),documents.length>0&&(count++,commonPopularItems.push(documents[0])),limitPopular==count)break;return commonPopularItems};this.OnPageNext=function(){Akumina.AppPart.DMS.Logger.Write("Grid.OnPageNext");PagingManager.NextPage()&&Akumina.AppPart.DMS.Eventing.Publish("/grid/refreshgridcontents/","pagechange")};this.OnSearchCompleted=function(searchResults){if(Akumina.AppPart.DMS.Logger.Write("Grid.OnSearchCompleted"),_cur.BindGridData(searchResults),_cur.BindTabData(_cur.viewModel.tabItems),PagingManager.IsLastPage()&&($(".noMoreRecords").show(),$(".showMoreResults").hide()),_cur.viewModel.searchReady=!0,_cur.viewModel.searchQueue.length>0){var nextSearch=_cur.viewModel.searchQueue[0];_cur.viewModel.searchQueue=_cur.viewModel.searchQueue.slice(1,_cur.viewModel.searchQueue.length);Akumina.AppPart.DMS.Eventing.Publish("/grid/refreshgridcontents/",nextSearch)}else _cur.HideLoading()};this.BindGridData=function(results){Akumina.AppPart.DMS.Logger.Write("Grid.BindGridData");Akumina.AppPart.DMS.Logger.Write(results);(new Akumina.AppPart.DMS.Data).Templates.FindAndRender("selectedOptionsTemplate","#ia-dms-selectedOptions",null);results.length>0?((_cur.IsRecentItemsTabSelected()||_cur.IsPopularItemsTabSelected())&&(results=_cur.SortItems(results),results=_cur.SearchItems(results)),(new Akumina.AppPart.DMS.Data).Templates.FindAndRender("gridTemplate","#ia-dms-grid",{sortOptions:_cur.viewModel.sortOptions,results:results}),$("#gridError").html(""),$("#ia-loading").css("display","none"),$("#ia-grid").css("display","block"),_cur.viewModel.DragDropHandler.uploadFilesHighlight()):((new Akumina.AppPart.DMS.Data).Templates.FindAndRender("failedTemplate","#ia-dms-grid",{sortOptions:_cur.viewModel.sortOptions,message:"Your Search returned no results!"}),$("#gridError").html(""),$("#ia-loading").css("display","none"),$("#ia-grid").css("display","block"));_cur.BindGridEvents()};this.SearchItems=function(results){var filteredResults=[],searchText,i;if($(".ia-searchBox").length>0)if(searchText=$(".ia-searchBox").val().toString().toLowerCase(),searchText.length>2)for(i=0;i<results.length;i++)results[i].title.toString().toLowerCase().indexOf(searchText)!=-1&&filteredResults.push(results[i]);else filteredResults=results;return filteredResults};this.SortItems=function(itemArray){switch(_cur._settings.sortField.toString().toLowerCase()){case"fileleafref":itemArray=_cur._settings.sortAscending?itemArray.sort(function(a,b){return b.title>a.title?-1:a.title>b.title?1:0}):itemArray.sort(function(a,b){return b.title<a.title?-1:a.title<b.title?1:0});break;case"modified":itemArray=_cur._settings.sortAscending?itemArray.sort(function(a,b){return Date.parse(b.modified)>Date.parse(a.modified)?-1:Date.parse(a.modified)>Date.parse(b.modified)?1:0}):itemArray.sort(function(a,b){return Date.parse(b.modified)<Date.parse(a.modified)?-1:Date.parse(a.modified)<Date.parse(b.modified)?1:0});break;case"editor":itemArray=_cur._settings.sortAscending?itemArray.sort(function(a,b){return b.firstname>a.firstname?-1:a.firstname>b.firstname?1:0}):itemArray.sort(function(a,b){return b.firstname<a.firstname?-1:a.firstname<b.firstname?1:0})}return itemArray};this.BindGridEvents=function(){Akumina.AppPart.DMS.Logger.Write("Grid.BindGridEvents");$("#dropdown-1 li a").unbind().click(function(e){switch(e.target.id){case"folder":_cur.fileCreateFolder();break;case"docx":_cur.fileCreateDocument(1);break;case"xlsx":_cur.fileCreateDocument(2);break;case"pptx":_cur.fileCreateDocument(3)}});$(".ia-doclist-title").unbind().click(function(){var folderPath,model,fileurl;$(this).attr("isFolder")=="true"?(folderPath=$(this).attr("path"),_cur.setCookie(folderPath),$(".ia-folder-tree").length==0?(folderPath=folderPath.replace(_cur.GetSiteUrl(),""),folderPath=decodeURI(folderPath),folderPath=folderPath.replace(_cur.viewModel.listRootFolder,_cur.viewModel.listName),model=new Akumina.AppPart.DMS.Models.FolderOnChangeModel(folderPath,_cur.viewModel.listName,_cur.viewModel.listRootFolder,_cur.viewModel.listName),model.isFolderChangeFired=!0,model.makeSearch=!0,Akumina.AppPart.DMS.Eventing.Publish("/foldertree/change/",model)):Akumina.AppPart.DMS.Eventing.FireGridFolderClick(folderPath)):(fileurl=_cur.getFileUrl($(this)),$(this).attr("href",fileurl))});$("#confirmDelete").unbind().click(function(e){_cur.ConfirmDelete(e)});$("#cancelDelete").unbind().click(function(e){_cur.CancelDelete(e)});$("#ia-library-upload").unbind().click(function(){_cur.fileUpload()});$("#ia-dms-grid table tbody tr td").each(function(){var current=$(this),docPreview;current.unbind().click(function(e){e.target.nodeName!="A"&&_cur.OnSelect(current)});docPreview=current.children().find(".ia-document-preview");docPreview.on("click",function(){return _cur.OnDocumentPreview(docPreview),!1})});$(".ia-doclist-selectAll").click(function(){_cur.onSelectAllClick(this.checked)});Akumina.AppPart.DMS.Logger.Write("Grid.Bind End");$(_cur._settings.dragDrop.id).on("dragover",function(e){_cur.OnDragOver(e,this)});$(_cur._settings.dragDrop.id).on("dragleave",function(e){_cur.OnDragLeave(e,this)});$(_cur._settings.dragDrop.id).on("drop",function(e){_cur.OnDrop(e,this)});$("#btnUploadConfirmNext").unbind().click(function(e){e.preventDefault();_cur.viewModel.DragDropHandler.FileCheckinStep()});$("#btnUploadConfirmCancel").unbind().click(function(e){e.preventDefault();$.magnificPopup.close()});$("#ms-conflictDlgReplaceBtn").unbind().click(function(e){_cur.viewModel.DragDropHandler.CallReplaceIt(e)});$("#ms-conflictDlgNoUploadBtn").unbind().click(function(e){_cur.viewModel.DragDropHandler.RejectReplaceIt(e)});$("#fileCheckinMajorOption").unbind().click(function(){_cur.fileCheckinMajorOption()});$("#fileCheckinWithOptions").unbind().click(function(){_cur.fileCheckinWithOptions()});$(".ia-checkin-cancel").unbind().click(function(){_cur.viewModel.DragDropHandler.clearModal()});$("#btnMajorCheckinWindow").unbind().click(function(e){_cur.MajorCheckinWindow(e)});$("#ia-dms-grid table thead tr th").each(function(){var current=$(this);current.attr("class")!="ia-doclib-header-checkbox"&&current.unbind().click(function(){_cur.viewModel.sortOptions=_cur.GetSortOptions(current);Akumina.AppPart.DMS.Eventing.Publish("/grid/refreshgridcontents/","sortchanged")})});$(".ia-searchBox").unbind();$(".ia-searchBox").donetyping(function(){var val=$(this).val();$(".ia-libList-searchBar-input").length>0&&$(".ia-libList-searchBar-input").val(val);val.length<3&&(val="");val!=""&&(_cur.viewModel.searchTerm=val,_cur.viewModel.isFolderChangeFired=!1,Akumina.AppPart.DMS.Eventing.Publish("/grid/refreshgridcontents/","searchtextchanged"),Akumina.AppPart.DMS.Logger.Write("searchtextchanged => in done typing="+val))});var oldValue="";$(".ia-searchBox").on("keyup",function(event){var val=$(this).val(),makeSearchCall;$(".ia-libList-searchBar-input").length>0&&$(".ia-libList-searchBar-input").val(val);val.length>2&&(oldValue=val);(val.length<=2&&event.keyCode==8||event.keyCode==46)&&(oldValue="",makeSearchCall=!1,oldValue!=_cur.viewModel.searchTerm&&(makeSearchCall=!0,Akumina.AppPart.DMS.Logger.Write("searchtextchanged => make search call")),_cur.viewModel.searchTerm="",_cur.viewModel.isFolderChangeFired=!1,makeSearchCall&&Akumina.AppPart.DMS.Eventing.Publish("/grid/refreshgridcontents/","searchtextchanged"),Akumina.AppPart.DMS.Logger.Write("searchtextchanged => in key up="+val))});$(".ia-searchBox").on("cut paste",function(){setTimeout(function(){_cur.viewModel.searchTerm=$(".ia-searchBox").val();_cur.viewModel.isFolderChangeFired=!1;_cur.GetListItems(_cur.viewModel.listName)},100)});this.verticalScrollPosition=$("#s4-workspace").scrollTop();$("#s4-workspace").scroll(function(){_cur.SetContextMenuPosition();PagingManager.scrollReady&&$(this).scrollTop()>_cur.verticalScrollPosition&&$(this).scrollTop()+$(this).innerHeight()+10>=$(this)[0].scrollHeight&&_cur.showMoreResults()});$(".showMoreResults a").unbind().click(function(){_cur.showMoreResults()});Akumina.AppPart.DMS.Logger.Write("Grid.BindGridEvents End");_cur.ReplayItemSelectEvents()};this.showMoreResults=function(){PagingManager.IsLastPage()||(PagingManager.scrollReady=!1,Akumina.AppPart.DMS.Logger.Write("Show More Results Event - Next Page Call Made"),Akumina.AppPart.DMS.Eventing.Publish("/grid/pagenext/"))};this.onSelectAllClick=function(checkedState){checkedState?($(".ia-document-library tbody td input[type=checkbox]:not(:checked)").prop("checked",!0),$(".ia-document-library tbody tr").addClass("ia-doclist-row-selected"),_cur.ShowDocumentOptions()):($(".ia-document-library tbody td input[type=checkbox]:checked").prop("checked",!1),$(".ia-document-library tbody tr").removeClass("ia-doclist-row-selected"),_cur.HideDocumentOptions())};this.BindTabData=function(model){Akumina.AppPart.DMS.Logger.Write("Grid.BindTabData");Akumina.AppPart.DMS.Logger.Write(model);(new Akumina.AppPart.DMS.Data).Templates.FindAndRender("gridTabsTemplate","#ia-dms-gridTabs",model);var selectedTab=$("#ia-dms-gridTabs #"+model.selectedTab).parent().parent();_cur.HighlightSelectedTab(selectedTab);_cur.BindTabEvents()};this.BindTabEvents=function(){$(_cur._settings.tabSettings.cssClass+" ul li").each(function(){var current=$(this);Akumina.AppPart.DMS.Logger.Write("Grid.Tabs.BindTabEvents onclick"+current.html());current.unbind().click(function(){var selectedTab=$(this).find(".ia-tab-count").attr("id"),model;$(this).hasClass("ia-tab-active")||_cur.HighlightSelectedTab($(this));model=new Akumina.AppPart.DMS.Models.GridTabOnChangeModel(selectedTab);Akumina.AppPart.DMS.Eventing.Publish("/gridtab/change/",model)})})};this.HighlightSelectedTab=function(selectedTab){selectedTab.siblings().removeClass("ia-tab-active");selectedTab.addClass("ia-tab-active")};this.OnTabChange=function(selectedTab){Akumina.AppPart.DMS.Logger.Write("Grid.OnTabChange");_cur._settings.tabSettings.selectedTab=selectedTab.selectedText;Akumina.AppPart.DMS.Eventing.Publish("/grid/refreshgridcontents/","tabchange")};this.ShowSuccessStatus=function(message){var model={message:message};(new Akumina.AppPart.DMS.Data).Templates.FindAndRender("uploadSuccessTemplate","#ia-dms-successStatusMessages",model);setTimeout(function(){$("#ia-dms-successStatusMessages .ia-upload-success").html("");$("#ia-dms-successStatusMessages .ia-upload-success").fadeOut()},8e3)};this.ShowErrorStatus=function(message){var model={message:message};(new Akumina.AppPart.DMS.Data).Templates.FindAndRender("uploadFailedTemplate","#ia-dms-failedStatusMessages",model);setTimeout(function(){$("#ia-dms-failedStatusMessages .ia-upload-failed").html("");$("#ia-dms-failedStatusMessages .ia-upload-failed").fadeOut()},8e3)};this.ShowLoading=function(){Akumina.AppPart.DMS.Logger.Write("Grid.ShowLoading");$(".ia-loading-panel").addClass("ia-show")};this.HideLoading=function(){Akumina.AppPart.DMS.Logger.Write("Grid.HideLoading");$(".ia-loading-panel").removeClass("ia-show");$(".ia-loading-panel").addClass("ia-hide")};this.ShowRequiredFieldsLoading=function(note){_cur.ShowLoading();$(".ia-requiredfields-loading-panel").addClass("ia-show");$(".ia-loader-requiredfields").html("<b>"+note+"<\/b>")};this.HideRequiredFieldsLoading=function(){_cur.HideLoading();$(".ia-requiredfields-loading-panel").removeClass("ia-show");$(".ia-requiredfields-loading-panel").addClass("ia-hide")};this.HideStatus=function(){(new Akumina.AppPart.DMS.Data).Templates.FindAndRender(null,"#ia-dms-statusMessages",null)};this.OnSuccess=function(message){_cur.ShowSuccessStatus(message)};this.OnError=function(message){_cur.ShowErrorStatus(message)};this.GetSiteName=function(){return _spPageContextInfo.webServerRelativeUrl=="/"?"":_spPageContextInfo.webServerRelativeUrl};this.GetBaseUrl=function(){return window.location.protocol+"//"+window.location.host};this.GetSiteUrl=function(){return _cur.GetBaseUrl()+_cur.GetSiteName()};this.OnDragOver=function(e,obj){Akumina.AppPart.DMS.Logger.Write("Grid.OnDragOver");e.stopPropagation();e.preventDefault();$(obj).addClass(_cur._settings.dragDrop.cssClassHighlighted)};this.OnDragLeave=function(e,obj){Akumina.AppPart.DMS.Logger.Write("Grid.OnDragLeave");e.stopPropagation();e.preventDefault();$(obj).removeClass(_cur._settings.dragDrop.cssClassHighlighted)};this.OnDrop=function(e,obj){Akumina.AppPart.DMS.Logger.Write("Grid.OnDrop");e.stopPropagation();e.preventDefault();e.dataTransfer=e.originalEvent.dataTransfer;_cur.viewModel.MetaData.addPermission?_cur.viewModel.DragDropHandler.HandleDnDFileSelect(e):Akumina.AppPart.DMS.Eventing.FireError("You do not have permissions to add items");$(obj).removeClass(_cur._settings.dragDrop.cssClassHighlighted)};this.ShowDocumentOptions=function(id){Akumina.AppPart.DMS.Logger.Write("Grid.ShowDocumentOptions");var model=_cur.getContextMenuSettings(id);(new Akumina.AppPart.DMS.Data).Templates.FindAndRender("selectedOptionsTemplate","#ia-dms-selectedOptions",model);_cur.BindShowDocumentOptions()};this.getContextMenuSettings=function(){var model={showopen:!1,showdownload:!1,showcheckin:!1,showdelete:!0,showmore:!1,showcheckout:!1,showdischeckout:!1,showfileoptions:!0},folders=0,docs=0,checkedOutFiles=0,showCheckinOption;return $(".selection:checked").each(function(){var isFolder=$(this).closest("tr").find(".isFolder").html(),isWordDoc=$(this).closest("tr").find(".isWordDoc").html(),isCheckedOut=$(this).closest("tr").find(".isCheckedOut").html(),checkOutUserId=$(this).closest("tr").find(".checkOutUserId").html();isCheckedOut=="true"&&(checkedOutFiles=++checkedOutFiles);isFolder=="true"?folders=++folders:isWordDoc=="true"&&(docs=++docs)}),folders==0&&docs==0?model.showdelete=!1:folders>0?(model.showdelete=!0,folders==1&&docs==0&&(model.showmore=!0,model.showfileoptions=!1)):docs==1?(model.showopen=!0&&_cur.viewModel.MetaData.openPermission,model.showdownload=!0,model.showmore=!0,showCheckinOption=checkedOutFiles==docs?!0:!1,_cur.viewModel.MetaData.editPermission&&(showCheckinOption?($("#checkin").show(),$("#checkout").hide(),$("#discard").show()):($("#checkin").hide(),$("#checkout").show(),$("#discard").hide()))):docs>1&&(model.showcheckin=checkedOutFiles==docs?!0:!1,model.showdischeckout=checkedOutFiles==docs?!0:!1,model.showcheckout=checkedOutFiles==0?!0:!1),model.showcheckin=model.showcheckin&&_cur.viewModel.MetaData.editPermission,model.showcheckout=model.showcheckout&&_cur.viewModel.MetaData.editPermission,model.showdischeckout=model.showdischeckout&&_cur.viewModel.MetaData.editPermission,model.showdelete=model.showdelete&&_cur.viewModel.MetaData.deletePermission,model.showVersions=_cur.viewModel.MetaData.viewVersionsPermission,model.showEdit=_cur.viewModel.MetaData.editPermission,model};this.BindShowDocumentOptions=function(){Akumina.AppPart.DMS.Logger.Write("Grid.BindShowDocumentOptions");$(".ia-documentList .ia-button-group").sticky({topSpacing:30,responsiveWidth:!1});this.RegisterClickEventsForMenuItems(".ia-button-group li");this.RegisterClickEventsForMenuItems("#dropdown-2 .dropdown-menu li")};this.RegisterClickEventsForMenuItems=function(menuName){$(menuName).each(function(){var current=$(this);current.unbind().click(_cur.OnShowDocumentOptionsChange)})};this.OnShowDocumentOptionsChange=function(){Akumina.AppPart.DMS.Logger.Write("Grid.OnShowDocumentOptionsChange");Akumina.AppPart.DMS.Logger.Write("Command = "+$(this).children().first().attr("ia:selectedoptions:command"));var preview=$(this).parent().parent(),command=$(this).children().first().attr("ia:selectedoptions:command");if(command!==undefined)switch(command.toLowerCase()){case"open":_cur.fileOpen();break;case"previewopen":_cur.filePreviewOpen(preview.find(".ia-doc-link input").val());case"download":_cur.fileDownload();break;case"delete":_cur.fileDelete();break;case"checkin":_cur.fileCheckIn();break;case"checkout":_cur.fileCheckOut();break;case"discard":_cur.fileDisCheckOut();break;case"viewproperties":_cur.fileViewProperties();break;case"editproperties":_cur.fileEditProperties();break;case"share":_cur.fileShare();break;case"previewshare":_cur.PreviewfileShare(preview.find(".ia-doc-link input").attr("docid"),preview.attr("listId"));break;case"sharedwith":_cur.fileShareWith();break;case"follow":_cur.fileFollow();break;case"previewfollow":_cur.previewFileFollow(preview.find(".ia-doc-link input").attr("docid"),preview.find("h1").text(),preview.attr("listId"));break;case"details":_cur.fileComplianceDetails();break;case"versionhistory":_cur.fileVersionHistory();break;case"foldereditproperties":_cur.folderEditProperties()}};this.OnCompleteDocumentOptions=function(status,status_message,fileCountChanged){status?(Akumina.AppPart.DMS.Eventing.FireSuccess(status_message==undefined?"Success!":status_message),setTimeout(function(){fileCountChanged?(Akumina.AppPart.DMS.Eventing.Publish("/grid/refreshgridcontents/","filecountchanged"),Akumina.AppPart.DMS.Eventing.FireCreateFolderClick(_cur.viewModel.selectedFolder)):Akumina.AppPart.DMS.Eventing.Publish("/grid/refreshgridcontents/","itemstatechanged")},1500)):(Akumina.AppPart.DMS.Eventing.FireError(status_message==undefined?"Error!":status_message),setTimeout(function(){Akumina.AppPart.DMS.Eventing.FireError(status_message)},1500))};this.OnDocumentPreview=function(obj){var model;Akumina.AppPart.DMS.Logger.Write("Grid.OnDocumentPreview");var docId=obj.attr("ia:id"),docTitle=obj.attr("ia:title"),docAuthor=obj.attr("ia:modifiedby"),IframedocURL=_cur.getFileUrl(obj),docURL=obj.attr("path"),listId=obj.parent().parent().parent().find(".itemhiddenListId").justtext(),profileurl=obj.parent().parent().parent().find(".ia-doc-list-modifiedBy a").attr("href"),modified=obj.parent().parent().parent().find(".ia-doc-list-modified").justtext(),showPreview=!1;!0&&(showPreview=!0);model={docId:docId,docTitle:docTitle,showPreview:showPreview,IframedocURL:IframedocURL,docURL:docURL,previewHeight:600,docAuthor:docAuthor,listId:listId,profileurl:profileurl,modified:modified};(new Akumina.AppPart.DMS.Data).Templates.FindAndRenderHandleBarGeneric("#template-documentPreviewTemplate",null,"#document-preview-1",model);$.magnificPopup.open({items:{src:".ia-modal-preview",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0});_cur.RegisterClickPreviewEventsForMenuItems(".ia-preview-details .ia-button-group li");$(".ia-preview-details").find(".ia-doc-shared a").click(function(){_cur.previewFileShareWith(docId,listId)})};this.RegisterClickPreviewEventsForMenuItems=function(menuName){$(menuName).each(function(){var current=$(this);current.unbind().click(_cur.OnShowDocumentOptionsChange)})};this.HideDocumentOptions=function(id){Akumina.AppPart.DMS.Logger.Write("Grid.HideDocumentOptions");var model=_cur.getContextMenuSettings(id);(new Akumina.AppPart.DMS.Data).Templates.FindAndRender("selectedOptionsTemplate","#ia-dms-selectedOptions",model);_cur.BindShowDocumentOptions()};this.OnSelect=function(obj){var parent,id,checkbox,results,checkedValue;Akumina.AppPart.DMS.Logger.Write("Grid.OnSelect");parent=$(obj).parent();id=parent.attr("ia:id");parent.attr("class")=="ia-doclist-row-selected"?(parent.removeClass("ia-doclist-row-selected"),checkbox=parent.find(".ia-doclib-checkbox input"),$(checkbox).prop("checked",!1),_cur.HideDocumentOptions(id)):(parent.addClass("ia-doclist-row-selected"),checkbox=parent.find(".ia-doclib-checkbox input"),$(checkbox).prop("checked",!0),_cur.ShowDocumentOptions(id));results=_cur.GetResultsForSelectedTab();checkedValue="";$(".ia-doclist-selectAll  input:checked").length>0&&(checkedValue="checked");results.forEach(function(item){item.selected=checkedValue});checkedValue==""&&$(".ia-doclib-checkbox input:checked").each(function(){for(var absurl=$(this).parent().parent().find(".itemhiddenPath").justtext(),i=0;i<results.length;i++)results[i].itemhiddenPath==absurl&&(results[i].selected="checked")});_cur.SetContextMenuPosition();_cur.checkUncheckSelectAllCheckBox()};this.ReplayItemSelectEvents=function(){$(".ia-doclib-checkbox input:checked").each(function(){var id=$(this).parent().parent().attr("ia:id");$(this).parent().parent().addClass("ia-doclist-row-selected");_cur.ShowDocumentOptions(id)})};this.fileCreateFolder=function(){var listname=_cur.viewModel.listRootFolder,folderPath=_cur.GetSiteName()+_cur.viewModel.selectedFolder,baseUrl=_cur.GetSiteUrl(),options={url:baseUrl+"/"+listname+"/Forms/Upload.aspx?RootFolder="+folderPath+"&Type=1",title:"Create Folder",allowMaximize:!1,width:550,height:200,showClose:!0,dialogReturnValueCallback:_cur.onFolderCreateDialogClose};SP.SOD.execute("sp.ui.dialog.js","SP.UI.ModalDialog.showModalDialog",options)};this.onFolderCreateDialogClose=function(result){result==SP.UI.DialogResult.OK&&(Akumina.AppPart.DMS.Eventing.FireSuccess("Folder created successfully"),setTimeout(function(){Akumina.AppPart.DMS.Eventing.FireCreateFolderClick(_cur.viewModel.selectedFolder)},500),$(".ia-folder-tree").length==0&&_cur.OnCompleteDocumentOptions(!0,"Folder created successfully",!0),_cur.viewModel.isFolderCreate=!0)};this.onFileUploadDialogClose=function(result){result==SP.UI.DialogResult.OK&&_cur.OnCompleteDocumentOptions(!0,"File uploaded successfully",!0)};this.onFileEditPropertiesClose=function(result){result==SP.UI.DialogResult.OK&&_cur.OnCompleteDocumentOptions(!0,"File properties saved successfully",!1)};this.onFolderEditPropertiesClose=function(result){result==SP.UI.DialogResult.OK&&(Akumina.AppPart.DMS.Eventing.FireSuccess("Folder properties saved successfully"),setTimeout(function(){Akumina.AppPart.DMS.Eventing.FireCreateFolderClick(_cur.viewModel.selectedFolder)},500),$(".ia-folder-tree").length==0&&_cur.OnCompleteDocumentOptions(!0,"Folder properties saved successfully",!1),_cur.viewModel.isFolderCreate=!0)};this.fileCreateDocument=function(template){$("#dropdown-1").css("display","none");var listname=_cur.viewModel.listName,folderPath=_cur.GetSiteName()+_cur.viewModel.selectedFolder,baseUrl=_cur.GetSiteUrl();OpenPopUpPageWithTitle(baseUrl+"/_layouts/15/CreateNewDocument.aspx?SaveLocation="+folderPath+"&DefaultItemOpen=1&Source="+listname+"&TemplateType="+template,OnCloseDialogNavigate)};this.fileDownload=function(){var sDocument="";$(".selection:visible").each(function(){if(this.checked){var docurl=$(this).parent().parent().find(".itemhiddenPath").justtext();docurl=encodeURI(decodeURI(docurl));sDocument=_cur.GetSiteUrl()+"/_layouts/15/download.aspx?SourceUrl="+docurl}});window.open(sDocument,"_self");unCheckSelections()};this.setCookie=function(selectedFolder){var cookieModel=_cur.GetCookieModel(selectedFolder);_cur.viewModel.Cookies.createCookie(cookieModel)};this.GetCookieModel=function(selectedFolder){return{selectedFolder:selectedFolder}};this.fileViewProperties=function(){var listName="",itemId="",webUrl=_cur.GetSiteUrl()+"/",baseUrl,options;$(".selection:visible").each(function(){this.checked&&(listName=$(this).parent().parent().find(".itemhiddenPath").justtext().replace(webUrl,"").split("/")[0],itemId=$(this).parent().parent().find(".itemhidden").justtext())});baseUrl=_cur.GetSiteUrl();options={url:baseUrl+"/"+listName+"/Forms/DispForm.aspx?ID="+itemId,title:"View Properties",allowMaximize:!1,showClose:!1,width:800,height:600,showClose:!0};SP.SOD.execute("sp.ui.dialog.js","SP.UI.ModalDialog.showModalDialog",options);unCheckSelections()};this.fileEditProperties=function(){var itemId="",forceCheckout="",webUrl=_cur.GetSiteUrl()+"/",baseUrl,options;$(".selection:visible").each(function(){this.checked&&(listName=$(this).parent().parent().find(".itemhiddenPath").justtext().replace(webUrl,"").split("/")[0],itemId=$(this).parent().parent().find(".itemhidden").justtext(),forceCheckout=$(this).parent().parent().find(".itemForceCheckOut").justtext())});baseUrl=_cur.GetSiteUrl();forceCheckout=="true"&&$(".selection:checked").parent().parent().find(".ia-doc-checkedOut").length==0?confirm("You must check out this item before making changes.  Do you want to check out this item now?")&&fileEditCheckOut():(options={url:baseUrl+"/"+listName+"/Forms/EditForm.aspx?ID="+itemId,title:"Edit Properties",allowMaximize:!1,showClose:!1,width:800,height:600,showClose:!0,dialogReturnValueCallback:_cur.onFileEditPropertiesClose},SP.SOD.execute("sp.ui.dialog.js","SP.UI.ModalDialog.showModalDialog",options))};this.folderEditProperties=function(){var itemId="",webUrl=_cur.GetSiteUrl()+"/",baseUrl,options;$(".selection:visible").each(function(){this.checked&&(listName=$(this).parent().parent().find(".itemhiddenPath").justtext().replace(webUrl,"").split("/")[0],itemId=$(this).parent().parent().find(".itemhidden").justtext())});baseUrl=_cur.GetSiteUrl();options={url:baseUrl+"/"+listName+"/Forms/EditForm.aspx?ID="+itemId,title:"Edit Properties",allowMaximize:!1,showClose:!1,width:800,height:600,showClose:!0,dialogReturnValueCallback:_cur.onFolderEditPropertiesClose};SP.SOD.execute("sp.ui.dialog.js","SP.UI.ModalDialog.showModalDialog",options)};jQuery.fn.justtext=function(){return $(this).clone().children().remove().end().text()};this.checkUncheckSelectAllCheckBox=function(){$(".ia-doclist-selectAll").prop("checked",$(".ia-document-library tbody td input[type=checkbox]:checked").length==$(".ia-document-library tbody td input[type=checkbox].selection").length?!0:!1)};this.selection=function(element,option){option?$(element+":visible").each(function(){this.checked=option}):$(element).each(function(){this.checked=option})};this.fileFollow=function(){var itemId,docName,listId;$(".selection:visible").each(function(){this.checked&&(itemId=$(this).parent().parent().find(".itemhidden").justtext(),docName=$(this).parent().parent().find(".itemhiddenPath").justtext(),listId=$(this).parent().parent().find(".itemhiddenListId").justtext())});listId!=null&&itemId!=null&&docName!=null&&listId!=undefined&&itemId!=undefined&&docName!=undefined&&SP.SOD.executeFunc("followingcommon.js","FollowDocumentFromEmail",function(){FollowDocumentFromEmail(itemId,listId,docName)});unCheckSelections()};this.previewFileFollow=function(itemId,docName,listId){listId!=null&&itemId!=null&&docName!=null&&listId!=undefined&&itemId!=undefined&&docName!=undefined&&SP.SOD.executeFunc("followingcommon.js","FollowDocumentFromEmail",function(){FollowDocumentFromEmail(itemId,listId,docName)})};this.fileShareWith=function(){var baseUrl=_cur.GetSiteUrl(),itemId="",listId="";$(".selection:visible").each(function(){this.checked&&(itemId=$(this).parent().parent().find(".itemhidden").justtext(),listId=$(this).parent().parent().find(".itemhiddenListId").justtext())});EnsureScriptFunc("sharing.js","DisplaySharedWithDialog",function(){DisplaySharedWithDialog(baseUrl,"{"+listId+"}",itemId)})};this.previewFileShareWith=function(itemId,listId){var baseUrl=_cur.GetSiteUrl();EnsureScriptFunc("sharing.js","DisplaySharedWithDialog",function(){DisplaySharedWithDialog(baseUrl,"{"+listId+"}",itemId)})};this.fileShare=function(){var baseUrl=_cur.GetSiteUrl(),itemId="",listId="",isFolder=!1,title="Share File",options;$(".selection:visible").each(function(){this.checked&&(itemId=$(this).parent().parent().find(".itemhidden").justtext(),listId=$(this).parent().parent().find(".itemhiddenListId").justtext(),isFolder=JSON.parse($(this).parent().parent().find(".isFolder").justtext().toLowerCase()))});isFolder&&(title="Share Folder");options={url:baseUrl+"/_layouts/15/aclinv.aspx?forSharing=1&List="+listId+"&obj={"+listId+"},"+itemId+",DOCUMENT&IsDlg=1",title:title,allowMaximize:!1,width:800,height:600,showClose:!0,dialogReturnValueCallback:unCheckSelections};SP.SOD.execute("sp.ui.dialog.js","SP.UI.ModalDialog.showModalDialog",options);$.magnificPopup.close()};this.fileVersionHistory=function(){var listId="",baseUrl=_cur.GetSiteUrl(),options;$(".selection:visible").each(function(){this.checked&&(itemId=$(this).parent().parent().find(".itemhidden").justtext(),listId=$(this).parent().parent().find(".itemhiddenListId").justtext())});options={url:baseUrl+"/_layouts/15/Versions.aspx?list={"+listId+"}&ID="+itemId+"&IsDlg=1",title:"Version History",allowMaximize:!1,width:800,height:500,showClose:!0,dialogReturnValueCallback:unCheckSelections};SP.SOD.execute("sp.ui.dialog.js","SP.UI.ModalDialog.showModalDialog",options);$.magnificPopup.close()};this.PreviewfileShare=function(itemId,listId){var baseUrl=_cur.GetSiteUrl(),options={url:baseUrl+"/_layouts/15/aclinv.aspx?forSharing=1&List="+listId+"&obj={"+listId+"},"+itemId+",DOCUMENT&IsDlg=1",title:"Share File",allowMaximize:!1,width:800,height:600,showClose:!0,dialogReturnValueCallback:function(res){var passedArgs=this.get_args();res===SP.UI.DialogResult.OK?setTimeout(function(){callPreviewPopup()},1500):res===SP.UI.DialogResult.cancel&&callPreviewPopup()}};SP.SOD.execute("sp.ui.dialog.js","SP.UI.ModalDialog.showModalDialog",options);$.magnificPopup.close()};this.fileDelete=function(){$.magnificPopup.open({items:{src:".ia-library-fileDelete",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0})};this.CancelDelete=function(event){event.preventDefault();$.magnificPopup.close()};this.ConfirmDelete=function(event){var key,i;event.preventDefault();$.magnificPopup.close();_cur.ShowLoading();OverAllFailureMessage="";var dictionary={},listName="",listId="",itemId="",webUrl=_cur.GetSiteUrl()+"/";$(".selection:visible").each(function(){if(this.checked&&(listName=$(this).parent().parent().find(".itemhiddenPath").justtext().replace(webUrl,"").split("/")[0],listId=$(this).parent().parent().find(".itemhiddenListId").justtext(),itemId=$(this).parent().parent().find(".itemhidden").justtext(),dictionary=_cur.insertIntoDic(dictionary,listId,itemId),typeof tabBaseItems!="undefined")){var excludeIndexTab=tabBaseItems.map(function(el){return el.Id}).indexOf(eval(itemId));tabBaseItems.splice(excludeIndexTab,1)}});TotalCount=Object.keys(dictionary).length;_cur.viewModel.currentCount=0;for(key in dictionary)if(dictionary.hasOwnProperty(key)){for(var clientContext=SP.ClientContext.get_current(),oList=clientContext.get_web().get_lists().getById(key),lstID="",oListItem,myarray=dictionary[key],i=0;i<myarray.length;i++)lstID=myarray[i],oListItem=oList.getItemById(lstID),oListItem.deleteObject();Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.Grid.ConfirmDelete");clientContext.executeQueryAsync(Function.createDelegate(this,function(sender,args){_cur.HideLoading();_cur.OnFileDeleteSuccess(sender,args)}),Function.createDelegate(this,function(sender,args){_cur.HideLoading();_cur.OnFileDeleteFailed(sender,args)}))}};this.insertIntoDic=function(dictionary,key,value){return dictionary[key]&&dictionary[key]instanceof Array||(dictionary[key]=[]),dictionary[key]=dictionary[key].concat(value),dictionary};this.OnFileDeleteSuccess=function(){_cur.OnCompleteDocumentOptions(!0,"File(s) deleted successfully.",!0)};this.OnFileDeleteFailed=function(sender,args){_cur.OnCompleteDocumentOptions(!1,"Delete file(s) failed: "+args.get_message(),!1)};this.fileCheckOut=function(){var key,clientContext,webSite,lstID,myarray,item,file,i;OverAllFailureMessage="";var dictionary={},listName="",itemId="",webUrl=_cur.GetSiteUrl()+"/";$(".selection:visible").each(function(){this.checked&&(listName=$(this).parent().parent().find(".itemhiddenPath").justtext().replace(webUrl,"").split("/")[0],itemId=$(this).parent().parent().find(".itemhidden").justtext(),dictionary=_cur.insertIntoDic(dictionary,_cur.viewModel.listId,itemId))});TotalCount=Object.keys(dictionary).length;_cur.viewModel.currentCount=0;for(key in dictionary)if(dictionary.hasOwnProperty(key)&&(clientContext=SP.ClientContext.get_current(),clientContext!=undefined&&clientContext!=null)){for(webSite=clientContext.get_web(),this.list=webSite.get_lists().getById(key),lstID="",myarray=dictionary[key],i=0;i<myarray.length;i++)lstID=myarray[i],item=this.list.getItemById(lstID),file=item.get_file(),file.checkOut(),clientContext.load(file);Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.Grid.fileCheckOut");clientContext.executeQueryAsync(Function.createDelegate(this,function(sender,args){_cur.OnFileCheckOutSuccess(sender,args)}),Function.createDelegate(this,function(sender,args){_cur.OnFileCheckOutFailed(sender,args)}))}};this.OnFileCheckOutSuccess=function(){_cur.OnCompleteDocumentOptions(!0,"File(s) Checked Out successfully",!1)};this.OnFileCheckOutFailed=function(sender,args){_cur.OnCompleteDocumentOptions(!1,"Check Out of File(s) failed: "+args.get_message(),!1)};this.fileDisCheckOut=function(){var key,clientContext,webSite,lstID,myarray,item,file,i;OverAllFailureMessage="";var dictionary={},listName="",itemId="",webUrl=_cur.GetSiteUrl()+"/";$(".selection:visible").each(function(){this.checked&&(listName=$(this).parent().parent().find(".itemhiddenPath").justtext().replace(webUrl,"").split("/")[0],itemId=$(this).parent().parent().find(".itemhidden").justtext(),dictionary=_cur.insertIntoDic(dictionary,_cur.viewModel.listId,itemId))});TotalCount=Object.keys(dictionary).length;_cur.viewModel.currentCount=0;for(key in dictionary)if(dictionary.hasOwnProperty(key)&&(clientContext=SP.ClientContext.get_current(),clientContext!=undefined&&clientContext!=null)){for(webSite=clientContext.get_web(),this.list=webSite.get_lists().getById(key),lstID="",myarray=dictionary[key],i=0;i<myarray.length;i++)lstID=myarray[i],item=this.list.getItemById(lstID),file=item.get_file(),file.undoCheckOut(),clientContext.load(file);Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.Grid.fileDisCheckOut");clientContext.executeQueryAsync(Function.createDelegate(this,function(sender,args){_cur.OnLoadDiscCheckOutSuccess(sender,args)}),Function.createDelegate(this,function(sender,args){_cur.OnLoadDisCheckOutFailed(sender,args)}))}};this.OnLoadDiscCheckOutSuccess=function(){_cur.OnCompleteDocumentOptions(!0,"Discard CheckOut of File(s) successful",!1)};this.OnLoadDisCheckOutFailed=function(sender,args){_cur.OnCompleteDocumentOptions(!1,"Discard CheckOut of File(s) failed: "+args.get_message(),!1)};this.fileUpload=function(){var baseUrl=_cur.GetSiteUrl(),listId=_cur.viewModel.listId,absoluteFolderPath=_cur.GetSiteUrl()+_cur.viewModel.selectedFolder,relativeFolderPath=_cur.GetSiteName()+_cur.viewModel.selectedFolder,url=baseUrl+"/_layouts/15/Upload.aspx?List={"+listId+"}&RootFolder=",options;url+=_cur.viewModel.containsFolder||_cur.viewModel.selectedFolder.toString().toLowerCase().trim()!="/"+_cur.viewModel.listName.toString().toLowerCase().trim()?encodeURI(absoluteFolderPath):encodeURI(relativeFolderPath);options={url:url,title:"Upload Files",allowMaximize:!1,width:800,height:500,showClose:!0,dialogReturnValueCallback:_cur.onFileUploadDialogClose};SP.SOD.execute("sp.ui.dialog.js","SP.UI.ModalDialog.showModalDialog",options)};this.removehiddenvalue=function(element){var split=element.split("<\/b>");return split.length>1?split[1]:split[0]};this.fileCheckinMajorOption=function(){var sList,listname,clientContext,webSite,lstID,myarray,item,file,i,Comment;if($.magnificPopup.close(),sList="",$(".selection:visible").each(function(){this.checked&&(sList+=_cur.removehiddenvalue($(this).parent().parent().find(".itemhidden").html())+";")}),listname=_cur.viewModel.listName,_cur.viewModel.currentCount=0,clientContext=SP.ClientContext.get_current(),clientContext!=undefined&&clientContext!=null){for(webSite=clientContext.get_web(),this.list=webSite.get_lists().getByTitle(listname),lstID="",myarray=sList.split(";"),i=0;i<myarray.length;i++)lstID=myarray[i],item=this.list.getItemById(lstID),file=item.get_file(),$(".checkInMajorFileOption:checked").length>0?(Comment="",$(".checkInMajorFileOption:checked").length>0&&(Comment=$(".checkInMajorCommentOption").val()),$(".checkInMajorFileOption:checked").length>0&&(file.checkIn(Comment,1),$(".fileCheckinYes:checked").length>0&&file.checkOut())):file.checkIn("Checked in using ECMA script",1),clientContext.load(file);Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.Grid.fileCheckinMajorOption");clientContext.executeQueryAsync(Function.createDelegate(this,function(sender,args){_cur.OnLoadCheckInSuccess(sender,args)}),Function.createDelegate(this,function(sender,args){_cur.OnLoadCheckInFailed(sender,args)}))}};this.MajorCheckinWindow=function(){$.magnificPopup.close();Akumina.AppPart.DMS.Eventing.Publish("/grid/dragdrop/uploadprogressdialog/")};this.fileComplianceDetails=function(){var baseUrl=_cur.GetSiteUrl(),itemId="",listId=_cur.viewModel.listId,options;$(".selection:visible").each(function(){this.checked&&(itemId+=$(this).parent().parent().find(".itemhidden").justtext())});options={url:baseUrl+"/_layouts/15/itemexpiration.aspx?ID="+itemId+"&List={"+listId+"}",title:"Compliance Details",allowMaximize:!1,showClose:!1,width:800,height:600,showClose:!0};SP.SOD.execute("sp.ui.dialog.js","SP.UI.ModalDialog.showModalDialog",options)};this.fileCheckIn=function(){_cur.viewModel.DragDropHandler.ClearCheck();_cur.viewModel.DragDropHandler.ReintializeCheckInComment();$(".hintText").length>0&&$(".hintText").is(":visible")?$("#hdnMinorCheckInEnable").length>0&&$("#hdnMinorCheckInEnable").val()=="minor"?$.magnificPopup.open({items:{src:".ia-fileCheckInOption",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0}):$("#hdnMinorCheckInEnable").length>0&&$("#hdnMinorCheckInEnable").val()=="major"?($(".fileCheckinNo").length>0&&$(".fileCheckinNo").click(),$.magnificPopup.open({items:{src:".ia-fileCheckInMajorOption",type:"inline"},closeOnBgClick:!1,closeBtnInside:!0})):_cur.fileCheckinWithOutOptions():_cur.fileCheckinWithOutOptions()};this.fileCheckinWithOutOptions=function(){var key,clientContext,webSite,lstID,myarray,item,file,i;OverAllFailureMessage="";var dictionary={},listName="",itemId="",webUrl=_cur.GetSiteUrl()+"/";$(".selection:visible").each(function(){this.checked&&(listName=$(this).parent().parent().find(".itemhiddenPath").justtext().replace(webUrl,"").split("/")[0],itemId=$(this).parent().parent().find(".itemhidden").justtext(),dictionary=_cur.insertIntoDic(dictionary,_cur.viewModel.listId,itemId))});TotalCount=Object.keys(dictionary).length;_cur.viewModel.currentCount=0;for(key in dictionary)if(dictionary.hasOwnProperty(key)&&(clientContext=new SP.ClientContext,clientContext!=undefined&&clientContext!=null)){for(webSite=clientContext.get_web(),this.list=webSite.get_lists().getById(key),lstID="",myarray=dictionary[key],i=0;i<myarray.length;i++)lstID=myarray[i],item=this.list.getItemById(lstID),file=item.get_file(),file.checkIn("Checked in using ECMA script",1),clientContext.load(file);Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.Grid.fileCheckinWithOutOptions");clientContext.executeQueryAsync(Function.createDelegate(this,function(sender,args){_cur.OnLoadCheckInSuccess(sender,args)}),Function.createDelegate(this,function(sender,args){_cur.OnLoadCheckInFailed(sender,args)}))}};this.OnLoadCheckInSuccess=function(){_cur.OnCompleteDocumentOptions(!0,"File(s) checked-in successfully",!1)};this.OnLoadCheckInFailed=function(sender,args){_cur.OnCompleteDocumentOptions(!1,"File(s) check-in failed: "+args.get_message(),!1)};this.fileCheckinWithOptions=function(){var sList,listname,clientContext,webSite,lstID,myarray,item,file,i,Comment;if($.magnificPopup.close(),sList="",$(".selection:visible").each(function(){this.checked&&(sList+=_cur.removehiddenvalue($(this).parent().parent().find(".itemhidden").justtext())+";")}),listname=_cur.viewModel.listId,TotalCount=1,_cur.viewModel.currentCount=0,OverAllFailureMessage="",clientContext=SP.ClientContext.get_current(),clientContext!=undefined&&clientContext!=null){for(webSite=clientContext.get_web(),this.list=webSite.get_lists().getById(listname),lstID="",myarray=sList.split(";"),i=0;i<myarray.length;i++)lstID=myarray[i],item=this.list.getItemById(lstID),file=item.get_file(),$(".checkInFileOption:checked").length>0||$(".checkInCheckOutFileOption:checked").length>0?(Comment="",Comment=$(".checkInFileOption:checked").length>0?$(".checkinCommentOption").val():$(".checkInCheckOutCommentOption").val(),$(".checkInFileOption:checked").length>0?($(".checkInDraftOption:checked").length>0?(file.checkIn(Comment,0),$(".checkInDraftOption").prop("checked",!1)):(file.checkIn(Comment,1),$(".checkInPublishOption").prop("checked",!1)),$(".checkInFileOption").prop("checked",!1)):$(".checkInCheckoutDraftOption:checked").length>0?(file.checkIn(Comment,0),$(".checkInCheckoutDraftOption").prop("checked",!1)):(file.checkIn(Comment,1),$(".checkInCheckoutPublishOption").prop("checked",!1)),$(".checkInCheckOutFileOption:checked").length>0&&(file.checkOut(),$(".checkInCheckOutFileOption").prop("checked",!1)),$(".ia-checkin-all").hide(),$(".ia-checkin-changes").hide()):file.checkIn("Checked in using ECMA script",1),clientContext.load(file);Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.Grid.fileCheckinWithOptions");clientContext.executeQueryAsync(Function.createDelegate(this,function(sender,args){_cur.OnLoadCheckInSuccess(sender,args)}),Function.createDelegate(this,function(sender,args){_cur.OnLoadCheckInFailed(sender,args)}))}};this.filePreviewOpen=function(url){url!=undefined&&(window.location.href=url)};this.fileOpen=function(){var thisitem,fileurl;$(".selection:visible").each(function(){this.checked&&(thisitem=$(this).parent().parent().find(".ia-doclist-name a"))});fileurl=_cur.getFileUrl(thisitem);window.location.href=fileurl};this.getFileUrl=function(thisitem){var docurl,extension;return thisitem==undefined&&(docurl=".ia-doc-link input".attr),docurl=thisitem.attr("path"),docurl!=undefined?(docurl=encodeURI(decodeURI(docurl)),extension=docurl.substr(docurl.lastIndexOf(".")),extension==".doc"||extension==".docx"||extension==".ppt"||extension==".pptx"||extension==".xls"||extension==".xlsx"?_cur.GetSiteUrl()+"/_layouts/15/WopiFrame.aspx?sourcedoc="+docurl.replace(_cur.GetBaseUrl(),""):docurl):void 0};this.getFormattedDate=function(date){var year=date.getFullYear(),month=(1+date.getMonth()).toString(),day;return month=month.length>1?month:"0"+month,day=date.getDate().toString(),day=day.length>1?day:"0"+day,month+"/"+day+"/"+year};this.SetContextMenuPosition=function(){$("#drop_zone #ulContextMenu").attr("style","");var scrolltop=$(window).scrollTop(),ulpostion=$("#drop_zone  #ulContextMenu").offset()==undefined||$("#drop_zone  #ulContextMenu").offset()==null?0:$("#drop_zone  #ulContextMenu").offset().top,position=ulpostion-scrolltop;position<=65&&position!=0?$("#drop_zone #ulContextMenu").attr("style","position:fixed;top:65px;width:90%;"):$("#drop_zone #ulContextMenu").attr("style","")};this.formatDateForGrid=function(date){var input=date.toString().substring(0,10).replace(/-/g,"/"),datePart=input.match(/\d+/g),year=datePart[0];return month=datePart[1],day=datePart[2],month+"/"+day+"/"+year}});var RefinerCamlMapping="startdate:Geq/Modified/Datetime,enddate:Leq/Modified/Datetime,category:Eq/Category/TaxonomyFieldType,filepath:Eq/FileDirRef/Text,filetype:Eq/File_x0020_Type/Text,searchtext:Contains/FileLeafRef/Text,modifiedby:Eq/Editor/User,filetypenotnull:IsNotNull/File_x0020_Type/Text".split(","),oOperatorAnd="And",oOperatorOr="Or",Akumina_AppParts_Search_CAML=function(searchParameters){_cur=this;Grid_Field_Mapping={};Refiner_Field_Mapping={};RefinerToGrid={};Refiner_Filter_Mapping_Cache={};Refiner_Filter_Mapping={};this.searchParameters=searchParameters;this.listId=searchParameters.listId;this.listTitle=searchParameters.listName;this.folderPath=searchParameters.folderPath;this.searchText=searchParameters.searchText;this.currentTab=searchParameters.currentTab.toString().toLowerCase();this.rowLimit=searchParameters.rowLimit;this.sortField=searchParameters.sortField;this.sortOrder=searchParameters.sortOrder;this.Filters=searchParameters.filters;this.userName=searchParameters.currentUserName;this.Skip=searchParameters.skip;this.recentLimit=searchParameters.recentLimit;this.popularLimit=searchParameters.popularLimit;this.GetFilterFieldMapping("filter");this.timezoneOffset=searchParameters.timezoneOffset};Akumina_AppParts_Search_CAML.prototype.Transform=function(computeResultCounts){var def=new $.Deferred,filter=this.Filters,rowlimit=this.rowLimit,parseRowLimit=this.rowLimit,query=this.FormQuery(this.searchText,this.folderPath,this.currentTab,this.sortField,this.sortOrder,this.Filters),currentTab=this.currentTab;return this.Skip>0?this.Search(this.listTitle,query,this.rowLimit,this.Skip).done(function(data){var searchResults=data.d.results,countQuery="";switch(currentTab){case"allfiles":countQuery=_cur.FormQuery(_cur.searchText,_cur.folderPath,"allfiles",_cur.sortField,_cur.sortOrder,_cur.Filters);break;case"myfiles":countQuery=_cur.FormQuery(_cur.searchText,_cur.folderPath,"myfiles",_cur.sortField,_cur.sortOrder,_cur.Filters);break;case"recentfiles":searchResults.totalResultCount=_cur.recentLimit;break;case"popularfiles":searchResults.totalResultCount=_cur.popularLimit}countQuery!=""?_cur.Search(_cur.listTitle,countQuery,1e5,0).done(function(data){searchResults.allResults=data.d.results;searchResults.totalResultCount=data.d.results.length;def.resolve(searchResults)}):def.resolve(searchResults)}).fail(function(error){return def.reject(error)}):(computeResultCounts&&(parseRowLimit=1e5),this.Search(_cur.listTitle,query,parseRowLimit,0).done(function(searchResults){var countQuery;if(computeResultCounts){var allItemsquery=_cur.FormQuery(_cur.searchText,_cur.folderPath,"allfiles",_cur.sortField,_cur.sortOrder,_cur.Filters),myItemsquery=_cur.FormQuery(_cur.searchText,_cur.folderPath,"myfiles",_cur.sortField,_cur.sortOrder,_cur.Filters),recentItemsquery=_cur.FormQuery(_cur.searchText,_cur.folderPath,"recentfiles",_cur.sortField,_cur.sortOrder,_cur.Filters);_cur.Search(_cur.listTitle,allItemsquery,1e5,0).done(function(data){var allItemsResults=data.d.results,allItemsCount=data.d.results.length;_cur.Search(_cur.listTitle,myItemsquery,1e5,0).done(function(data){var myItemsResults=data.d.results,myItemsCount=data.d.results.length;_cur.Search(_cur.listTitle,recentItemsquery,1e5,0).done(function(data){var recentItemsResults=data.d.results,recentItemsCount=data.d.results.length,recentResultsquery;_cur.sortField="Modified";_cur.sortOrder=!1;recentResultsquery=_cur.FormQuery(_cur.searchText,_cur.folderPath,"recentfiles",_cur.sortField,_cur.sortOrder,{});_cur.Search(_cur.listTitle,recentResultsquery,_cur.recentLimit,0).done(function(recentResults){var firstPageResults=searchResults.d.results.slice(0,_cur.rowLimit),allResults;firstPageResults.allItemsCount=allItemsCount;firstPageResults.myItemsCount=myItemsCount;firstPageResults.recentItemsCount=recentResults.d.results.length;allResults=searchResults.d.results;firstPageResults.recentResults=recentResults.d.results;switch(currentTab){case"allfiles":firstPageResults.allResults=allItemsResults;firstPageResults.totalResultCount=firstPageResults.allItemsCount;break;case"myfiles":firstPageResults.allResults=myItemsResults;firstPageResults.totalResultCount=firstPageResults.myItemsCount;break;case"recentfiles":firstPageResults.allResults=recentItemsResults;firstPageResults.totalResultCount=_cur.recentLimit;break;case"popularfiles":firstPageResults.allResults=allItemsResults;firstPageResults.totalResultCount=_cur.popularLimit}def.resolve(firstPageResults)})})})})}else{countQuery="";switch(currentTab){case"allfiles":countQuery=_cur.FormQuery(_cur.searchText,_cur.folderPath,"allfiles",_cur.sortField,_cur.sortOrder,_cur.Filters);break;case"myfiles":countQuery=_cur.FormQuery(_cur.searchText,_cur.folderPath,"myfiles",_cur.sortField,_cur.sortOrder,_cur.Filters);break;case"recentfiles":searchResults.d.results.totalResultCount=_cur.recentLimit;break;case"popularfiles":searchResults.d.results.totalResultCount=_cur.popularLimit}countQuery!=""?_cur.Search(_cur.listTitle,countQuery,1e5,0).done(function(data){searchResults.d.results.allResults=data.d.results;searchResults.d.results.totalResultCount=data.d.results.length;def.resolve(searchResults.d.results)}):def.resolve(searchResults.d.results)}}).fail(function(error){return def.reject(error)})),def.promise()};Akumina_AppParts_Search_CAML.prototype.FormQuery=function(searchText,folderPath,currentTab,sortField,sortOrder,filters){var orderBy=sortField==null||sortField==""?'<OrderBy><FieldRef Name="FileLeafRef" Ascending="True"/><\/OrderBy>':'<OrderBy><FieldRef Name="'+sortField+'" Ascending="'+sortOrder+'"/><\/OrderBy>',query="",currentFilters=jQuery.extend(!0,{},filters),serverStartDate,serverEndDate,userName;return currentFilters.startdate&&(Akumina.AddIn.Logger.WriteInfoLog("Before converting start date: "+currentFilters.startdate[0]),serverStartDate=new Date(new Date(currentFilters.startdate[0]).getTime()-this.timezoneOffset*36e5).toISOString(),serverStartDate=serverStartDate.substring(0,10)+" 00:00:00",currentFilters.startdate[0]=serverStartDate,Akumina.AddIn.Logger.WriteInfoLog("After converting start date: "+currentFilters.startdate[0])),currentFilters.enddate&&(Akumina.AddIn.Logger.WriteInfoLog("Before converting end date: "+currentFilters.enddate[0]),serverEndDate=new Date(new Date(currentFilters.enddate[0]).getTime()-this.timezoneOffset*36e5).toISOString(),serverEndDate=serverEndDate.substring(0,10)+" 00:00:00",currentFilters.enddate[0]=serverEndDate,Akumina.AddIn.Logger.WriteInfoLog("After converting end date: "+currentFilters.enddate[0])),currentTab=="myfiles"?(userName=this.userName,currentFilters.modifiedby=[],currentFilters=this.insertIntoDic(currentFilters,"modifiedby",userName),currentFilters=this.insertIntoDic(currentFilters,"filetypenotnull",""),currentFilters=this.insertIntoDic(currentFilters,"filepath",folderPath),searchText!=""&&(currentFilters=this.insertIntoDic(currentFilters,"searchtext",searchText)),query='<View Scope="RecursiveAll"><Query><Where>'+this.DynamicCamlQuery(currentFilters)+"<\/Where>"+orderBy+"<\/Query><\/View>"):currentTab=="recentfiles"?(currentFilters=this.insertIntoDic(currentFilters,"filepath",folderPath),currentFilters=this.insertIntoDic(currentFilters,"filetypenotnull",""),searchText!=""&&(currentFilters=this.insertIntoDic(currentFilters,"searchtext",searchText)),query='<View Scope="RecursiveAll"><Query><Where>'+this.DynamicCamlQuery(currentFilters)+"<\/Where>"+orderBy+"<\/Query><\/View>"):(currentFilters=this.insertIntoDic(currentFilters,"filepath",folderPath),searchText!=""&&(currentFilters=this.insertIntoDic(currentFilters,"searchtext",searchText)),query='<View Scope="RecursiveAll"><Query><Where>'+this.DynamicCamlQuery(currentFilters)+"<\/Where>"+orderBy+"<\/Query><\/View>"),query};Akumina_AppParts_Search_CAML.prototype.insertIntoDic=function(dictionary,key,value){return dictionary[key]&&dictionary[key]instanceof Array||(dictionary[key]=[]),dictionary[key]!=null&&(dictionary[key]=dictionary[key].concat(value)),dictionary};Akumina_AppParts_Search_CAML.prototype.DynamicCamlQuery=function(filters){var oFilterQuery=[],query="",comparator="",columnName="",columnType="",key,value,categoryName,filterKey,j,i;for(key in filters)if(value=filters[key],categoryName="",key.indexOf("category_name")>-1&&(categoryName=key.split("-")[1],key="category"),query="",filterKey=Refiner_Filter_Mapping[key],filterKey!=null&&filterKey.length>0){for(comparator=filterKey[0],columnName=categoryName!=""?categoryName:filterKey[1],columnType=filterKey[2],j=0;j<value.length;j++)query=j>0?"<"+oOperatorOr+">"+query+this.QueryBuild(comparator,columnName,columnType,value[j])+"<\/"+oOperatorOr+">":this.QueryBuild(comparator,columnName,columnType,value[j]);oFilterQuery.push(query)}for(query="",i=oFilterQuery.length-1;i>-1;i--)query!=""?query="<"+oOperatorAnd+">"+query+oFilterQuery[i]+"<\/"+oOperatorAnd+">":query==""&&(query=oFilterQuery[i]);return query};Akumina_AppParts_Search_CAML.prototype.QueryBuild=function(comparator,columnName,columnType,value){var strValue=value.toString().trim();return comparator=="IsNotNull"||comparator=="IsNull"?"<"+comparator+'><FieldRef Name="'+columnName+'" /><\/'+comparator+">":strValue=="one"&&columnName=="File_x0020_Type"?"<"+comparator+'><FieldRef Name="ProgId" /><Value Type="'+columnType+'">OneNote.Notebook<\/Value><\/'+comparator+">":"<"+comparator+'><FieldRef Name="'+columnName+'" /><Value Type="'+columnType+'">'+strValue+"<\/Value><\/"+comparator+">"};Akumina_AppParts_Search_CAML.prototype.Search=function(listTitle,queryViewXml,rowLimit,Skip){var queryPayload={query:{__metadata:{type:"SP.CamlQuery"},ViewXml:queryViewXml}},skipItems=Skip>0?"&$skip="+Skip:"",endpointUrl;return _cur.currentTab.toString().toLowerCase()=="popularfiles"&&(skipItems=0,rowLimit=1e5),endpointUrl=(new Akumina.AppPart.DMS).GetAbsoluteSiteName()+"/_api/web/lists/getbytitle('"+listTitle+"')/getitems?$select=FieldValuesAsText,Folder,File,Editor,EncodedAbsUrl,FileSystemObjectType,EditorId,FileLeafRef,id,Modified,EffectiveBasePermissions,File_x0020_Type,CheckoutUserId,File/ListItemAllFields&$expand=Folder,File,FieldValuesAsText,File/ListItemAllFields&$top="+rowLimit+skipItems,$.ajax({type:"POST",headers:{accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},data:JSON.stringify(queryPayload),url:endpointUrl})};Akumina_AppParts_Search_CAML.prototype.SearchCount=function(listTitle,queryViewXml){var queryPayload={query:{__metadata:{type:"SP.CamlQuery"},ViewXml:queryViewXml}},endpointUrl=(new Akumina.AppPart.DMS).GetAbsoluteSiteName()+"/_api/web/lists/getbytitle('"+listTitle+"')/getitems";return $.ajax({type:"POST",headers:{accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},data:JSON.stringify(queryPayload),url:endpointUrl})};Akumina_AppParts_Search_CAML.prototype.GetListItemGridData=function(listItem){var obj={};for(var key in Grid_Field_Mapping){var fieldName=key,searchKey=Grid_Field_Mapping[fieldName],result_value=GetFieldValueForSearchKey(searchKey,listItem);if(result_value!=null)if(obj[fieldName]=result_value,fieldName=="ItemFullName")obj.NoExtensionName=result_value.split(".").length>2?result_value.substring(0,result_value.lastIndexOf(".")):result_value.split(".")[0];else if(fieldName=="Modified"){var modifieddateAndDate=result_value.split("T"),modifieddate=modifieddateAndDate[0].split("-"),modifiedTime=modifieddateAndDate[1].slice(0,-4),modifiedDateFormat=modifieddate[1]+"/"+modifieddate[2]+"/"+modifieddate[0];obj.ModifiedDate=modifiedDateFormat;obj.ModifiedTime=modifiedTime}else fieldName=="FileType"?obj.DocIconUrl=result_value!=null?GetFileIconUrl(result_value):"":fieldName=="EditorId"&&(obj.EditorUrl=siteUrl+"/_layouts/15/userdisp.aspx?ID="+result_value);else fieldName=="FileType"&&result_value==null&&listItem.FieldValuesAsText.HTML_x005f_x0020_x005f_File_x005f_x0020_x005f_Type=="OneNote.Notebook"&&(obj.DocIconUrl=GetFileIconUrl("one"),obj.FileType="one")}return obj};Akumina_AppParts_Search_CAML.prototype.ProcessQueryDataToGrid=function(listItems){listItemsJson=listItems};Akumina_AppParts_Search_CAML.prototype.GetFilterFieldMapping=function(){for(var i=0;i<RefinerCamlMapping.length;i++){var fieldKeys=RefinerCamlMapping[i].split(":"),commonKey=fieldKeys[0],searchKey=fieldKeys[1].split("/");Refiner_Filter_Mapping=this.insertIntoDic(Refiner_Filter_Mapping,commonKey,searchKey)}};var Grid_Fields="Id:ListItemId,FileCheckOut:CheckoutUserId,FileType:SecondaryFileExtension,ItemFullName:fileLeafRef,ProgID:Folder/ProgID,Modified:LastModifiedTime,EditorName:ModifiedBy,EditorId:EditorId,Url:DefaultEncodingURL,SiteTitle:SiteTitle,SiteId:SiteId,ListId:ListId,LibraryTitle:ListNameOWSTEXT".split(","),Grid_Field_Mapping={},RefinerFields="EditorName,FileType,ListId".split(","),Refiner_Field_Mapping={},RefinerToGrid={},LibIds=[],ListRef=[];if(Akumina_Interaction_Search_Kql===undefined&&(Akumina_Interaction_Search_Kql=function(searchParameters){Grid_Field_Mapping={};Refiner_Field_Mapping={};RefinerToGrid={};LibIds=[];ListRef=[];this.listId=searchParameters.listId;this.listTitle=searchParameters.listName;this.folderPath=searchParameters.folderPath;this.searchText=searchParameters.searchText;this.currentTab=searchParameters.currentTab.toString().toLowerCase();this.rowLimit=searchParameters.rowLimit;this.sortField=searchParameters.sortField;this.sortOrder=searchParameters.sortOrder;this.Filters=searchParameters.filters;this.userName=searchParameters.currentUserName;this.webdocLibrary=[];this.selecteddocLibrary=[];this.Skip=0}),Akumina_Interaction_Search_Kql.prototype.GetDataForCaml=function(){var rowlimit=this.rowLimit,parseRowLimit=this.rowLimit,currentTab=this.currentTab,def=new $.Deferred,query;return parseRowLimit=500,query=this.FormPostQuery(this.searchText,this.folderPath,this.currentTab,this.sortField,this.sortOrder,this.webdocLibrary,this.selecteddocLibrary,parseRowLimit,this.Filters,this.Skip),this.Search(this.listTitle,query,parseRowLimit).done(function(data){var listItems=convertRowsToObjects(data.d.postquery.PrimaryQueryResult.RelevantResults.Table.Rows.results);def.resolve(listItems)}).fail(function(error){return def.reject(error)}),def.promise()},Akumina_Interaction_Search_Kql.prototype.Search=function(listTitle,query){var postData="{'request': {'__metadata': { 'type': 'Microsoft.Office.Server.Search.REST.SearchRequest' },"+query+"}}",endpointUrl=(new Akumina.AppPart.DMS).GetAbsoluteSiteName()+"/_api/search/postquery";return $.ajax({type:"POST",headers:{accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose","X-RequestDigest":$("#__REQUESTDIGEST").val()},data:postData,url:endpointUrl})},Akumina_Interaction_Search_Kql.prototype.FormPostQuery=function(searchText,folderPath,currentTab,sortField,sortOrder,webdocLibrary,selecteddocLibrary,rowLimit,filters,start){var docids=[],categories=[],categoryValues=[],categoryProperty=[],key,value,categoryName,categoryQuery,ftype,authors,i,sort,txt_search;for(key in filters)value=filters[key],categoryName="",key.indexOf("category_name")>-1?(categoryName=key.split("-")[1],categories.push("owstaxId"+key.split("-")[1]),value.length>1?categoryValues.push("owstaxId"+key.split("-")[1]+':or("'+value.join('","')+'")'):categoryValues.push("owstaxId"+key.split("-")[1]+':"'+value+'"')):key==="SiteLibrary"&&(docids=value,webdocLibrary.length>0&&(LibIds=webdocLibrary));categories.length>1?categoryProperty=categories.join(","):categories.length===1&&(categoryProperty=categories[0]);categoryProperty!=""&&(categoryQuery="",categoryQuery=categoryValues.length>1?"and("+categoryValues.join(",")+"),":categoryValues+",");var QueryText="'Querytext':'* iscontainer=false',",TrimDuplicates="'TrimDuplicates':false,",startRow="'StartRow':"+start+",",RowLimit="'RowLimit':"+rowLimit+",",SelectProperties=categoryProperty!=""?"'SelectProperties':{'results':['Id','Modified','FieldValuesAsText','File_x0020_Type','EncodedAbsUrl','CheckoutUserId','FileSystemObjectType','EditorId','ListId','SiteId','SiteTitle','ListItemId','ListNameOWSTEXT','Title','ModifiedBy','LastModifiedTime','SecondaryFileExtension','IsContainer','"+categoryProperty+"','AttachmentURI','deeplinks','DefaultEncodingURL','ExternalMediaURL','HierarchyUrl','OrgParentUrls','OrgUrls','OriginalPath','ParentLink','Path','PictureThumbnailURL','PictureURL','PublishingImage','recommendedfor','ServerRedirectedEmbedURL','ServerRedirectedPreviewURL','ServerRedirectedURL','SiteLogo','SitePath','SPSiteURL','UserEncodingURL','fileLeafRef']},":"'SelectProperties':{'results':['Id','Modified','FieldValuesAsText','File_x0020_Type','EncodedAbsUrl','CheckoutUserId','FileSystemObjectType','EditorId','ListId','SiteId','SiteTitle','ListItemId','ListNameOWSTEXT','Title','ModifiedBy','LastModifiedTime','SecondaryFileExtension','IsContainer','AttachmentURI','deeplinks','DefaultEncodingURL','ExternalMediaURL','HierarchyUrl','OrgParentUrls','OrgUrls','OriginalPath','ParentLink','Path','PictureThumbnailURL','PictureURL','PublishingImage','recommendedfor','ServerRedirectedEmbedURL','ServerRedirectedPreviewURL','ServerRedirectedURL','SiteLogo','SitePath','SPSiteURL','UserEncodingURL','fileLeafRef']},";var ListId="",ListIdrefiners="",RefinementFilters="'RefinementFilters':{'results':['and(",ParentLink="ParentLink:*,",selectedFileTypes="SecondaryFileExtension:*,",selectedUsers="ModifiedBy:*,",dateFilter="LastModifiedTime:*,",contentClass="ContentClass:STS_ListItem*)']},",sort_order="0",SortList="'SortList':{'results':[{'Property':'fileLeafRef','Direction':'"+sort_order+"'}]}",fileTypes="",users_Modified="";filters.filetype!=undefined&&(fileTypes=filters.filetype);filters.modifiedby!=undefined&&(users_Modified=filters.modifiedby);var startdate="*",enddate="*",dateFilter="";if(dateFilter="LastModifiedTime:*,",filters.startdate!=undefined&&filters.enddate!=undefined?(startdate=filters.startdate[0],enddate=filters.enddate[0],dateFilter="LastModifiedTime:range("+startdate+","+enddate+', from="ge",to="le"),'):filters.startdate!=undefined?(startdate=filters.startdate[0],dateFilter="LastModifiedTime:range("+startdate+',max,from="ge"),'):filters.enddate!=undefined&&(enddate=filters.enddate[0],dateFilter="LastModifiedTime:range(min,"+enddate+',to="le"),'),fileTypes.length>1){for(ftype="",i=0;i<fileTypes.length;i++)ftype=fileTypes.join(",");selectedFileTypes="SecondaryFileExtension:or("+ftype+"),"}else fileTypes.length===1&&fileTypes[0]!=""&&(selectedFileTypes="SecondaryFileExtension:"+fileTypes[0]+",");if(users_Modified.length>1){for(authors=[],i=0;i<users_Modified.length;i++)authors.push('ModifiedBy:ends-with("'+users_Modified[i]+'")');selectedUsers="or("+authors.join(",")+"),"}else users_Modified.length===1&&users_Modified[0]!=""&&(selectedUsers='ModifiedBy:ends-with("'+users_Modified[0]+'"),');sort_order=sortOrder===!0?"0":"1";sort="";sortField==="FileLeafRef"&&(SortList="'SortList':{'results':[{'Property':'fileLeafRef','Direction':'"+sort_order+"'}]}");sortField==="Modified"&&(SortList="'SortList':{'results':[{'Property':'LastModifiedTime','Direction':'"+sort_order+"'}]}");sortField==="Editor"&&(SortList="'SortList':{'results':[{'Property':'modifiedby','Direction':'"+sort_order+"'}]}");sortField==="SiteTitle"&&(SortList="'SortList':{'results':[{'Property':'SiteTitle','Direction':'"+sort_order+"'}]}");ListId=this.listId;ListIdrefiners='ListId:"'+ListId+'",';var searchUrl="",searchKey="",searchUser="",currentFolderPath=$("#currentFolderPath").val(),currentURL=(new Akumina.AppPart.DMS).GetAbsoluteSiteName();return currentTab==="myfiles"?(txt_search=searchText!=""?searchText:"*",txt_search+=" iscontainer=false",QueryText="'Querytext':'"+txt_search+"',",searchUser=this.userName,selectedUsers='ModifiedBy:ends-with("'+searchUser+'"),',sort_order="1",SortList="'SortList':{'results':[{'Property':'ViewsLifeTime','Direction':'"+sort_order+"'}]}",searchKey=categoryProperty!=""?RefinementFilters+ListIdrefiners+ParentLink+selectedFileTypes+selectedUsers+categoryQuery+dateFilter+contentClass:RefinementFilters+ListIdrefiners+ParentLink+selectedFileTypes+selectedUsers+dateFilter+contentClass,searchUrl=QueryText+TrimDuplicates+startRow+RowLimit+SelectProperties+searchKey+SortList):currentTab==="popularfiles"?(sort_order="1",SortList="'SortList':{'results':[{'Property':'ViewsLifeTime','Direction':'"+sort_order+"'}]}",searchKey=categoryProperty!=""?RefinementFilters+ListIdrefiners+ParentLink+selectedFileTypes+selectedUsers+categoryQuery+dateFilter+contentClass:RefinementFilters+ListIdrefiners+ParentLink+selectedFileTypes+selectedUsers+dateFilter+contentClass,searchUrl=QueryText+TrimDuplicates+RowLimit+SelectProperties+searchKey+SortList):currentTab==="recentfiles"?(sort_order="1",SortList="'SortList':{'results':[{'Property':'ViewsLifeTime','Direction':'"+sort_order+"'}]}",searchKey=categoryProperty!=""?RefinementFilters+ListIdrefiners+ParentLink+selectedFileTypes+selectedUsers+categoryQuery+dateFilter+contentClass:RefinementFilters+ListIdrefiners+ParentLink+selectedFileTypes+selectedUsers+dateFilter+contentClass,searchUrl=QueryText+TrimDuplicates+RowLimit+SelectProperties+searchKey+SortList):(txt_search=searchText!=""?searchText:"*",txt_search+=" iscontainer=false",QueryText="'Querytext':'"+txt_search+"',",sort_order="1",SortList="'SortList':{'results':[{'Property':'ViewsLifeTime','Direction':'"+sort_order+"'}]}",searchKey=categoryProperty!=""?RefinementFilters+ListIdrefiners+ParentLink+selectedFileTypes+selectedUsers+categoryQuery+dateFilter+contentClass:RefinementFilters+ListIdrefiners+ParentLink+selectedFileTypes+selectedUsers+dateFilter+contentClass,searchUrl=QueryText+TrimDuplicates+startRow+RowLimit+SelectProperties+searchKey+SortList),searchUrl},typeof Akumina.AppPart.DMS.Taxonomy=="undefined"&&(Akumina.AppPart.DMS.Taxonomy=function(categories){var _cur=this;this.categories=categories.toString();this.taxonomyMap=null;this.reverseMap=null;this.taxonomyHtml=null;this.LoadTaxonomyMap=function(){var listCategories=[];if(_cur.categories.trim()!=""&&(listCategories=_cur.categories.trim().split(","),listCategories=$.map(listCategories,function(item){return item.trim()})),listCategories.length>0){var def=new $.Deferred;_cur.GetCategory(listCategories,[],[],def,"");def.done(function(result){_cur.taxonomyMap=result.taxonomyMap;_cur.reverseMap=result.reverseMap;_cur.taxonomyHtml=result.html;$(".ax-category-tree").html(result.html)})}};this.GetCategory=function(listCategories,taxonomyMap,reverseMap,def,html){if(listCategories.length>0){var termSet=listCategories[0],treeDef=new $.Deferred;_cur.getTermSetAsTree(termSet,function(termSet,tree){_cur.ShowTree(termSet,tree,taxonomyMap,reverseMap,treeDef,html)});treeDef.done(function(x){listCategories.length==1?def.resolve(x):_cur.GetCategory(listCategories.slice(1,listCategories.length),x.taxonomyMap,x.reverseMap,def,x.html)})}};this.ShowTree=function(termSet,terms,taxonomyMap,reverseMap,def,html){var i,result;for(html+="<ul category='"+termSet.name.toString().toLowerCase()+"'>",taxonomyMap[termSet.id.toString().toLowerCase()]=termSet.name.toString().toLowerCase(),reverseMap[termSet.name.toString().toLowerCase()]=termSet.id.toString().toLowerCase(),i=0;i<terms.children.length;i++)html+="<li>",html+="<input type='checkbox' value='"+termSet.name.toString().toLowerCase()+">"+terms.children[i].title.toLowerCase()+"' id='"+terms.children[i].title+"' /><label>"+terms.children[i].title+"<\/label>",html+=_cur.renderTerm(terms.children[i],termSet.name.toString().toLowerCase()+">"+terms.children[i].title,taxonomyMap,reverseMap),html+="<\/li>";html+="<\/ul>";result={taxonomyMap:taxonomyMap,html:html,reverseMap:reverseMap};def.resolve(result)};this.renderTerm=function(term,termPath,taxonomyMap,reverseMap){var html,i;if(taxonomyMap[term.guid.toString().toLowerCase()]=termPath.toLowerCase(),reverseMap[termPath.toLowerCase()]=term.guid.toString().toLowerCase(),html="",term.children&&term.children.length){for(html+="<ul>",i=0;i<term.children.length;i++)html+="<li>",html+="<input type='checkbox' value='"+term.title.toLowerCase()+">"+term.children[i].title.toLowerCase()+"' id='"+term.children[i].title+"' /><label>"+term.children[i].title+"<\/label>",html+=_cur.renderTerm(term.children[i],term.title+">"+term.children[i].title,taxonomyMap,reverseMap),html+="<\/li>";html+="<\/ul>"}return html};this.getTermSetAsTree=function(id,callback){_cur.getTermSet(id,_cur.getTerms,callback)};this.getTerms=function(termSet,terms,callback){for(var termsEnumerator=terms.getEnumerator(),tree={term:terms,children:[]},i,foundNode,j,term;termsEnumerator.moveNext();){var currentTerm=termsEnumerator.get_current(),currentTermPath=currentTerm.get_pathOfTerm().split(";"),children=tree.children;for(i=0;i<currentTermPath.length;i++){for(foundNode=!1,j=0;j<children.length;j++)if(children[j].name===currentTermPath[i]){foundNode=!0;break}term=foundNode?children[j]:{name:currentTermPath[i],children:[]};i===currentTermPath.length-1&&(term.term=currentTerm,term.title=currentTerm.get_name(),term.guid=currentTerm.get_id().toString());foundNode?children=term.children:(children.push(term),i!==currentTermPath.length-1&&(children=term.children))}}tree=_cur.sortTermsFromTree(tree);callback(termSet,tree)};this.getTermSet=function(id,callback1,callback2){var ctx=SP.ClientContext.get_current(),taxonomySession=SP.Taxonomy.TaxonomySession.getTaxonomySession(ctx),termStore=taxonomySession.getDefaultSiteCollectionTermStore(),termSet=termStore.getTermSet(id),terms=termSet.getAllTerms();ctx.load(termSet);ctx.load(terms);Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.Taxonomy.getTermSet");ctx.executeQueryAsync(Function.createDelegate(this,function(){var termSetModel={};termSetModel.id=termSet.get_id().toString();termSetModel.name=termSet.get_name();callback1(termSetModel,terms,callback2)}),Function.createDelegate(this,function(sender,args){throw"Exception = "+args.get_message();}))};this.sortTermsFromTree=function(tree){var sortOrder,i;for(tree.children.length&&tree.term.get_customSortOrder&&(sortOrder=null,tree.term.get_customSortOrder()&&(sortOrder=tree.term.get_customSortOrder()),sortOrder?(sortOrder=sortOrder.split(":"),tree.children.sort(function(a,b){var indexA=sortOrder.indexOf(a.guid),indexB=sortOrder.indexOf(b.guid);return indexA>indexB?1:indexA<indexB?-1:0})):tree.children.sort(function(a,b){return a.title>b.title?1:a.title<b.title?-1:0})),i=0;i<tree.children.length;i++)tree.children[i]=_cur.sortTermsFromTree(tree.children[i]);return tree}}),$(document).ready(function(){$("div.ia-treeview").each(function(){$(this).find("ul").treeview({persist:"location",collapsed:!0})})}),typeof Akumina.AppPart.DMS.Refinements=="undefined"){Akumina.AppPart.DMS.Refinements=function(){function GetFileType(sFileName){Akumina.AppPart.DMS.Logger.Write("Refinements.GetFileType()");var fileNameTokens=sFileName.split(".");return fileNameTokens.length==1?"":_cur.viewModel.mappingArray&&_cur.viewModel.mappingArray[fileNameTokens[fileNameTokens.length-1].toLowerCase()]!=undefined?_cur.viewModel.mappingArray[fileNameTokens[fileNameTokens.length-1].toLowerCase()]:fileNameTokens[fileNameTokens.length-1].toUpperCase()=="ONE"||fileNameTokens[fileNameTokens.length-1].toUpperCase()=="ONETOC"||fileNameTokens[fileNameTokens.length-1].toUpperCase()=="ONETOC2"?"":fileNameTokens[fileNameTokens.length-1].toUpperCase()}var _cur=this;this.viewModel={};this.Init=function(){var editMode=Akumina.AddIn.Utilities.getEditMode();editMode||(_cur._settings=this.settings,_cur.callRefreshGrid=!0,Akumina.AppPart.DMS.Logger.Write("Refinements.Load"),Akumina.AppPart.DMS.Logger.Write(_cur._settings),Akumina.AppPart.DMS.Eventing.Subscribe("/grid/searchcompleted/",_cur.GridResultsChanged),Akumina.AppPart.DMS.Eventing.Subscribe("/refinement/modifiedbychange/",_cur.onModifiedByChanged),Akumina.AppPart.DMS.Eventing.Subscribe("/refinement/filetypechange/",_cur.onFileTypeChanged),_cur.mapFileExtensions())};this.getModifiedBy=function(model){var filteredModifiedBy=[],results,i,fileType;if(model==undefined)for(i=0;i<_cur.viewModel.gridAllResults.length;i++)filteredModifiedBy.indexOf(_cur.viewModel.gridAllResults[i].firstname.toString())==-1&&filteredModifiedBy.push(_cur.viewModel.gridAllResults[i].firstname.toString());else for(results=_cur.viewModel.gridResults.refinerResults,i=0;i<results.length;i++)fileType=GetFileType(results[i].itemhiddenPath),(model.refiners.filetype==undefined||model.refiners.filetype.length==0||model.refiners.filetype.indexOf(fileType)==-1)&&filteredModifiedBy.indexOf(results[i].firstname.toString())==-1&&filteredModifiedBy.push(results[i].firstname.toString());return filteredModifiedBy};this.getFileTypes=function(model){var filteredFileTypes=[],results,i,fileExtension;if(model==undefined)for(i=0;i<_cur.viewModel.gridAllResults.length;i++)_cur.viewModel.gridAllResults[i].isWordDoc==!0&&(fileExtension=GetFileType(_cur.viewModel.gridAllResults[i].itemhiddenPath),fileExtension!=""&&filteredFileTypes.indexOf(fileExtension)==-1&&filteredFileTypes.push(fileExtension));else for(results=_cur.viewModel.gridResults.refinerResults,i=0;i<results.length;i++)(model.refiners.modifiedby==undefined||model.refiners.modifiedby.length==0||model.refiners.modifiedby.indexOf(results[i].firstname.toString())!=-1)&&results[i].isWordDoc==!0&&(fileExtension=GetFileType(results[i].itemhiddenPath),fileExtension!=""&&filteredFileTypes.indexOf(fileExtension)==-1&&filteredFileTypes.push(fileExtension));return filteredFileTypes};this.onModifiedByChanged=function(model){_cur.viewModel.fileTypes=_cur.getFileTypes(model);_cur.BindRefiner()};this.onFileTypeChanged=function(model){_cur.viewModel.modifiedBy=_cur.getModifiedBy(model);_cur.BindRefiner()};this.BindRefiner=function(model){var data={modifiedBy:_cur.viewModel.modifiedBy,fileType:_cur.viewModel.fileTypes};(new Akumina.AppPart.DMS.Data).Templates.FindAndRender("refinementsTemplate","#ia-dms-refinements",data);_cur.viewModel.categoryModel&&_cur.viewModel.categoryModel.trim()!=""&&($(".ia-filter-category-browse").show(),$(".refinement-apppart .ia-filter-category-browse .ia-accordion-body").html(_cur.viewModel.categoryModel));_cur.BindUIEvents(model)};this.GetCategory=function(listCategories,html,def){if(listCategories.length>0){var termSet=listCategories[0],treeDef=new $.Deferred;_cur.getTermSetAsTree(termSet,function(termSetName,termSetId,tree){var displayCategory=_cur.checkCategorySettings(termSetName);displayCategory?_cur.ShowTree(termSetName,termSetId,tree,html,treeDef):treeDef.resolve(html)});treeDef.done(function(x){listCategories.length==1?def.resolve(x):_cur.GetCategory(listCategories.slice(1,listCategories.length),x,def)})}};this.ShowTree=function(termSet,termSetId,terms,oldhtml,def){for(var html="",i=0;i<terms.children.length;i++)html+=_cur.renderTerm(terms.children[i],termSet+">"+terms.children[i].title);oldhtml+=_cur.BuildTaxonomyHtml(termSet,termSetId,termSet,html);def.resolve(oldhtml)};this.renderTerm=function(term,termPath){var html="<li><input class='ia-filter-input-checkbox ax-filter-tax' type='checkbox' value='"+termPath+"' id='"+term.title+"' />",i;if(html+="<label class='ia-filter-label-checkbox' for='"+term.title+"'>"+term.title+"<\/label>",term.children&&term.children.length){for(html+="<span class='ia-filter-subcategory-expand'>(+)<\/span><ul>",i=0;i<term.children.length;i++)html+=_cur.renderTerm(term.children[i],term.title+">"+term.children[i].title);html+="<\/ul>"}return html+"<\/li>"};this.getTermSetAsTree=function(id,callback){_cur.getTermSet(id,_cur.getTerms,callback)};this.getTerms=function(termSetName,termSetId,terms,callback){for(var termsEnumerator=terms.getEnumerator(),tree={term:terms,children:[]},i,foundNode,j,term;termsEnumerator.moveNext();){var currentTerm=termsEnumerator.get_current(),currentTermPath=currentTerm.get_pathOfTerm().split(";"),children=tree.children;for(i=0;i<currentTermPath.length;i++){for(foundNode=!1,j=0;j<children.length;j++)if(children[j].name===currentTermPath[i]){foundNode=!0;break}term=foundNode?children[j]:{name:currentTermPath[i],children:[]};i===currentTermPath.length-1&&(term.term=currentTerm,term.title=currentTerm.get_name(),term.guid=currentTerm.get_id().toString());foundNode?children=term.children:(children.push(term),i!==currentTermPath.length-1&&(children=term.children))}}tree=_cur.sortTermsFromTree(tree);callback(termSetName,termSetId,tree)};this.getTermSet=function(id,callback1,callback2){SP.SOD.loadMultiple(["sp.js"],function(){SP.SOD.registerSod("sp.taxonomy.js",SP.Utilities.Utility.getLayoutsPageUrl("sp.taxonomy.js"));SP.SOD.loadMultiple(["sp.taxonomy.js"],function(){var ctx=SP.ClientContext.get_current(),taxonomySession=SP.Taxonomy.TaxonomySession.getTaxonomySession(ctx),termStore=taxonomySession.getDefaultSiteCollectionTermStore(),termSet=termStore.getTermSet(id),terms=termSet.getAllTerms();ctx.load(termSet);ctx.load(terms);Akumina.AddIn.Logger.logSPCall("Akumina.AppPart.DMS.Refinements.getTermSet");ctx.executeQueryAsync(Function.createDelegate(this,function(){var termSetName=termSet.get_name();callback1(termSetName,id,terms,callback2)}),Function.createDelegate(this,function(sender,args){Akumina.AppPart.DMS.Logger.Write(args.get_message())}))})})};this.sortTermsFromTree=function(tree){var sortOrder,i;for(tree.children.length&&tree.term.get_customSortOrder&&(sortOrder=null,tree.term.get_customSortOrder()&&(sortOrder=tree.term.get_customSortOrder()),sortOrder?(sortOrder=sortOrder.split(":"),tree.children.sort(function(a,b){var indexA=sortOrder.indexOf(a.guid),indexB=sortOrder.indexOf(b.guid);return indexA>indexB?1:indexA<indexB?-1:0})):tree.children.sort(function(a,b){return a.title>b.title?1:a.title<b.title?-1:0})),i=0;i<tree.children.length;i++)tree.children[i]=_cur.sortTermsFromTree(tree.children[i]);return tree};this.BuildTaxonomyHtml=function(taxTitle,termSetId,taxDisName,subCategories){var taxonomyFields=_cur.viewModel.gridResults.metaData,field=taxonomyFields.filter(function(n){return n.termSetId==termSetId});return"<div class='ia-filter-subcategory ax-subcategory' category='"+field[0].fieldInternalName+"'><h3 class='ia-filter-subcategory-header'>"+taxDisName+"<span class='ia-accordion-icon'><\/span><\/h3><div class='ia-filter-subcategory-body'><ul class='ia-filter-subcategory-checkboxes'>"+subCategories+"<\/ul><\/div><\/div>"};this.BindUIEvents=function(model){$(".ax-filter-tax").unbind().click(function(){_cur.viewModel.refinerFilters=_cur.GetFilters();_cur.viewModel.refinerFilters.raiseInternalEvent=!0;_cur.viewModel.refinerFilters.caller="category";_cur.viewModel.refinerFilters.selectedTerms=_cur.getSelectedCategoryValues();Akumina.AppPart.DMS.Eventing.Publish("/refinement/filterchange/",_cur.viewModel.refinerFilters)});$(".ia-filter-file-type input:checkbox").unbind().click(function(){_cur.viewModel.refinerFilters=_cur.GetFilters();_cur.viewModel.refinerFilters.raiseInternalEvent=!0;_cur.viewModel.refinerFilters.caller="filetype";_cur.viewModel.refinerFilters.selectedTerms=_cur.getSelectedCategoryValues();Akumina.AppPart.DMS.Eventing.Publish("/refinement/filterchange/",_cur.viewModel.refinerFilters)});Jquery_Multiple_category();$(".ia-datepicker").pickadate({selectYears:!0,selectMonths:!0,format:"mmm dd, yyyy"});model!=undefined&&(_cur.expandFilters(model.filters),_cur.persistSelectedOptions(model.filters));$(".refinement-apppart #dateFilter a").unbind().click(function(){_cur.callRefreshGrid=!1;_cur.setDate($(this).attr("id"))});$(".refinement-apppart #txtStrDate").change(function(){_cur.viewModel.refinerFilters=_cur.GetFilters();_cur.viewModel.refinerFilters.raiseInternalEvent=!0;_cur.viewModel.refinerFilters.caller="date";_cur.viewModel.refinerFilters.selectedTerms=_cur.getSelectedCategoryValues();Akumina.AppPart.DMS.Eventing.Publish("/refinement/filterchange/",_cur.viewModel.refinerFilters)});$(".refinement-apppart #txtEndDate").change(function(){_cur.viewModel.refinerFilters=_cur.GetFilters();_cur.viewModel.refinerFilters.raiseInternalEvent=!0;_cur.viewModel.refinerFilters.caller="date";_cur.viewModel.refinerFilters.selectedTerms=_cur.getSelectedCategoryValues();Akumina.AppPart.DMS.Eventing.Publish("/refinement/filterchange/",_cur.viewModel.refinerFilters)});$(".chosen").unbind();$("div.chosen-container").remove();$(".chosen").chosen({width:"100%"}).change(function(){_cur.viewModel.refinerFilters=_cur.GetFilters();_cur.viewModel.refinerFilters.raiseInternalEvent=!0;_cur.viewModel.refinerFilters.caller="modifiedby";_cur.viewModel.refinerFilters.selectedTerms=_cur.getSelectedCategoryValues();Akumina.AppPart.DMS.Eventing.Publish("/refinement/filterchange/",_cur.viewModel.refinerFilters)})};this.expandFilters=function(filters){var i,category,subCategory;if(filters.filetype!=undefined&&filters.filetype.length>0&&($(".refinement-apppart .ia-filter-file-type").find(".ia-accordion-icon").toggleClass("ia-open"),$(".refinement-apppart .ia-filter-file-type").children(".ia-accordion-body").slideToggle()),(filters.startdate!=undefined||filters.enddate!=undefined)&&($(".refinement-apppart .ia-filter-date").find(".ia-accordion-icon").toggleClass("ia-open"),$(".refinement-apppart .ia-filter-date").children(".ia-accordion-body").slideToggle()),filters.modifiedby!=undefined&&filters.modifiedby.length>0&&($(".refinement-apppart .ia-filter-modified-by").find(".ia-accordion-icon").toggleClass("ia-open"),$(".refinement-apppart .ia-filter-modified-by").children(".ia-accordion-body").slideToggle()),filters.Categories!=undefined&&filters.Categories.length>0){$(".refinement-apppart .ia-filter-category-browse").find(".ia-accordion-icon").toggleClass("ia-open");$(".refinement-apppart .ia-filter-category-browse").children(".ia-accordion-body").slideToggle();var filtersToChangeImage=[],filtersToExpand=[],categories=[];for(_cur.subFiltersToExpand=[],_cur.subCategories=[],i=0;i<filters.selectedTerms.length;i++)category=$(".refinement-apppart input[value='"+filters.selectedTerms[i]+"']").closest("div .ia-filter-subcategory-body").prev("h3").text(),categories.indexOf(category)==-1&&(categories.push(category),filtersToChangeImage.push($(".refinement-apppart input[value='"+filters.selectedTerms[i]+"']").closest("div .ia-filter-subcategory-body").prev("h3").children(".ia-accordion-icon")),filtersToExpand.push($(".refinement-apppart input[value='"+filters.selectedTerms[i]+"']").closest("div .ia-filter-subcategory-body"))),subCategory="",$(".refinement-apppart input[value='"+filters.selectedTerms[i]+"']").parent().parent().parent().children(".ia-filter-subcategory-expand:first").length>0&&(subCategory=$(".refinement-apppart input[value='"+filters.selectedTerms[i]+"']").parent().parent().parent().children(".ia-filter-label-checkbox:first").text(),_cur.getSubCategoriesToExpand(filters.selectedTerms[i],subCategory));$.each(filtersToExpand,function(i,item){item.slideToggle()});$.each(filtersToChangeImage,function(i,item){item.addClass("ia-open")});$.each(_cur.subFiltersToExpand,function(i,item){item.toggle()})}};this.getSubCategoriesToExpand=function(selectedTerm,subCategory){if($(".refinement-apppart input[value='"+selectedTerm+"']").parent().parent().parent().children(".ia-filter-subcategory-expand:first").length!=0){_cur.subCategories.indexOf(subCategory)==-1&&(_cur.subCategories.push(subCategory),_cur.subFiltersToExpand.push($(".refinement-apppart input[value='"+selectedTerm+"']").parent().parent().parent().children(".ia-filter-subcategory-expand:first").siblings("ul")));var selectedTerm=$(".refinement-apppart input[value='"+selectedTerm+"']").parent().parent().parent().children("input[type=checkbox]").attr("value"),subCategory=$(".refinement-apppart input[value='"+selectedTerm+"']").parent().parent().parent().children(".ia-filter-label-checkbox:first").text();_cur.getSubCategoriesToExpand(selectedTerm,subCategory)}};this.GridResultsChanged=function(model){var listCategories,i,internalModel;if($("#ia-loading-refiner").css("display","none"),$(".refinement-apppart").css("display","block"),Akumina.AppPart.DMS.Logger.Write("Refinements.GridResultsChanged"),_cur.viewModel.gridResults=model,model.refreshRefiner&&(model.filters&&(model.filters.caller=undefined),_cur.viewModel.gridAllResults=model.refinerResults,_cur.viewModel.fileTypes=_cur.getFileTypes(),_cur.viewModel.modifiedBy=_cur.getModifiedBy()),model.filters==undefined||model.filters==null){for(listCategories=[],i=0;i<model.metaData.length;i++)listCategories.push(model.metaData[i].termSetId);if(listCategories.length==0)_cur.BindRefiner();else{var listCategories=$.map(listCategories,function(item){return item.trim()}),def=new $.Deferred,html="";_cur._settings.categoryName&&_cur._settings.categoryName.toString().trim()!=""?_cur.GetCategory(listCategories,html,def):def.resolve(html);def.done(function(html){_cur.viewModel.categoryModel=html.toString().trim();_cur.BindRefiner()})}}else model.filters.raiseInternalEvent&&!model.refreshRefiner&&(internalModel={caller:model.filters.caller,refiners:_cur.viewModel.refinerFilters},model.filters.caller!="filetype"&&Akumina.AppPart.DMS.Eventing.Publish("/refinement/modifiedbychange/",internalModel),model.filters.caller!="modifiedby"&&Akumina.AppPart.DMS.Eventing.Publish("/refinement/filetypechange/",internalModel)),_cur.BindRefiner(model)};this.checkCategorySettings=function(categoryName){if(_cur._settings.categoryName){var settingsCategories=[];if($.each(_cur._settings.categoryName.toString().toLowerCase().split(","),function(){settingsCategories.push($.trim(this))}),settingsCategories.indexOf(categoryName.toLowerCase().trim())!=-1)return!0}return!1};this.persistSelectedOptions=function(filters){var d,finalDate;filters.filetype!=undefined&&filters.filetype.forEach(function(item){_cur.viewModel.mappingArray[item.toLowerCase()]!=undefined?$(".ia-filter-file-type #"+_cur.viewModel.mappingArray[item.toLowerCase()]).prop("checked",!0):$(".ia-filter-file-type #"+item.toUpperCase()).prop("checked",!0)});filters.startdate!=undefined&&(Akumina.AddIn.Logger.WriteInfoLog("filters.startdate : "+filters.startdate),d=new Date(filters.startdate),Akumina.AddIn.Logger.WriteInfoLog("d : "+d),finalDate=new Date(d.getFullYear(),d.getMonth(),d.getDate()),Akumina.AddIn.Logger.WriteInfoLog("Final start Date: "+finalDate),$(".refinement-apppart #txtStrDate").pickadate("picker").set("select",finalDate));filters.enddate!=undefined&&(Akumina.AddIn.Logger.WriteInfoLog("filters.enddate : "+filters.enddate),d=new Date(filters.enddate),Akumina.AddIn.Logger.WriteInfoLog("d : "+d),finalDate=new Date(d.getFullYear(),d.getMonth(),d.getDate()),Akumina.AddIn.Logger.WriteInfoLog("Final end Date: "+finalDate),$(".refinement-apppart #txtEndDate").pickadate("picker").set("select",finalDate));filters.modifiedby!=undefined&&($(".refinement-apppart #fileModifiedUser").val(filters.modifiedby),$(".refinement-apppart #fileModifiedUser").trigger("chosen:updated"));filters.selectedTerms!=undefined&&filters.selectedTerms.forEach(function(item){$(".ia-filter-subcategory [value='"+item+"']").prop("checked",!0)})};this.getSelectedCategoryValues=function(){var categoryoptions=[];return $(".refinement-apppart .ax-filters .ax-checkbox-filters").each(function(){$(this).find("input:checkbox:checked").each(function(){categoryoptions.push($(this).attr("value"))})}),categoryoptions};this.Update=function(){Akumina.AppPart.DMS.Logger.Write("Refinements.Update")};this.mapFileExtensions=function(){var word=["docx","doc","docm","dot","nws","dotx"],powerPoint=["odp","ppt","pptm","pptx","potm","ppam","ppsm","ppsx"],excel=["odc","xls","xlsb","xlsm","xlsx","xltm","xltx","xlam"],i;for(_cur.viewModel.mappingArray=[],i=0;i<word.length;i++)_cur.viewModel.mappingArray[word[i]]="Word";for(i=0;i<powerPoint.length;i++)_cur.viewModel.mappingArray[powerPoint[i]]="PowerPoint";for(i=0;i<excel.length;i++)_cur.viewModel.mappingArray[excel[i]]="Excel"};this.setDate=function(dateFilterName){window.location.href="#";$(".refinement-apppart #txtEndDate").pickadate("picker").set("select",null);$(".refinement-apppart #txtStrDate").pickadate("picker").set("select",_cur.getDate(dateFilterName));_cur.callRefreshGrid=!0};this.getDate=function(dateFilterName){var d=new Date,finalDate;Akumina.AddIn.Logger.WriteInfoLog("Date: "+d);switch(dateFilterName){case"today":d.setDate(d.getDate());break;case"lastSeven":d.setDate(d.getDate()-7);break;case"lastThirty":d.setDate(d.getDate()-30);break;case"thisYear":d.setDate(d.getDate()-365)}return Akumina.AddIn.Logger.WriteInfoLog("After setting date: "+d),finalDate=new Date(d.getFullYear(),d.getMonth(),d.getDate()),Akumina.AddIn.Logger.WriteInfoLog("Final date: "+finalDate),finalDate};this.GetFilters=function(){var wordMapyKey="Word",powerPointMapKey="PowerPoint",excelMapKey="Excel",mapArray=[wordMapyKey,powerPointMapKey,excelMapKey],word=["docx","doc","docm","dot","nws","dotx"],powerPoint=["odp","ppt","pptm","pptx","potm","ppam","ppsm","ppsx"],excel=["odc","xls","xlsb","xlsm","xlsx","xltm","xltx","xlam"],date=[],modified=[],filetype=[],categoryMeta=[],startdate="",enddate="",qy=this.formrefinerQuery(),filters={},querys,i,category,tempfiletype,categoryNames,values;if(qy!="")for(querys=qy.split("$"),i=0;i<querys.length;i++)category=querys[i].split("@"),category[0]=="Date"?(date=category[1].split("|"),startdate=date[0],enddate=date[1],startdate!=""&&(startdate=GetDateFormat(startdate),filters=this.insertIntoDic(filters,"startdate",startdate)),enddate!=""&&(enddate=GetDateFormat(enddate),filters=this.insertIntoDic(filters,"enddate",enddate))):category[0]=="Modified By"?(modified=category[1].split("|"),filters=this.insertIntoDic(filters,"modifiedby",modified)):category[0]=="File Type"?(tempfiletype=category[1].split("|"),jQuery.each(tempfiletype,function(i,val){$.inArray(val,mapArray)==-1?filetype.push(val.toLowerCase()):val==wordMapyKey?filetype=$.merge($.merge([],word),filetype):val==powerPointMapKey?filetype=$.merge($.merge([],powerPoint),filetype):val==excelMapKey&&(filetype=$.merge($.merge([],excel),filetype))}),filters=this.insertIntoDic(filters,"filetype",filetype)):category[0]=="Category"?(categoryMeta=category[1].trim().split(","),categoryNames=GetTaxNames(categoryMeta),filters=this.insertIntoDic(filters,"category",categoryNames)):category[0].indexOf("category_name")>-1?(categoryNames=GetTaxNames(category[1].split(",")),filters=this.insertIntoDic(filters,category[0],categoryNames)):(values=category[1].split("|"),filters=this.insertIntoDic(filters,category[0],values));return filters};this.formrefinerQuery=function(){var categoryset=[],categoryoptions=[],startdate,enddate;return $(".ax-subcategory").each(function(){var $subcategories=$(this),categoryName="category_name-"+$subcategories.attr("category");categoryoptions=[];$subcategories.find(".ax-filter-tax:checked").each(function(){categoryoptions.push($(this).val())});categoryoptions.length>0&&categoryset.push(categoryName+"@"+categoryoptions.join(","))}),startdate=$(".refinement-apppart #txtStrDate").length>0&&$(".refinement-apppart #txtStrDate").val()!=""?$(".refinement-apppart #txtStrDate").val():"",enddate=$(".refinement-apppart #txtEndDate").length>0&&$(".refinement-apppart #txtEndDate").val()!=""?$(".refinement-apppart #txtEndDate").val():"",(startdate!=""||enddate!="")&&categoryset.push("Date@"+startdate+"|"+enddate),$(".refinement-apppart .ax-filters .ax-checkbox-filters").each(function(){var category=$(this).find("h3").attr("title"),arrUsers,users,k,user;if(categoryoptions=[],$(this).find("input:checkbox:checked").each(function(){categoryoptions.push($(this).attr("id"))}),category.toLowerCase()=="modified by"&&$(".refinement-apppart #fileModifiedUser").chosen().val()&&$(".refinement-apppart #fileModifiedUser").chosen().val().length>0){for(arrUsers=[],users=$(".refinement-apppart #fileModifiedUser").chosen().val(),k=0;k<users.length;k++)user=users[k].replace("_"," "),arrUsers.push(user);categoryoptions=arrUsers}categoryoptions!=null&&categoryoptions.length>0&&categoryset.push(category+"@"+categoryoptions.join("|"))}),categoryset.join("$")};this.insertIntoDic=function(dictionary,key,value){return dictionary[key]&&dictionary[key]instanceof Array||(dictionary[key]=[]),dictionary[key]!=null&&(dictionary[key]=dictionary[key].concat(value)),dictionary}};function GetDateFormat(oDate){var oDateFormat=new Date(oDate),yyyy=oDateFormat.getFullYear().toString(),mm=(oDateFormat.getMonth()+1).toString(),dd=oDateFormat.getDate().toString();return yyyy+"-"+(mm[1]?mm:"0"+mm[0])+"-"+(dd[1]?dd:"0"+dd[0])+(new Date).toISOString().substring(10,24)}function GetTaxNames(categoryMetadata){for(var categoryPath,categoryName,categoryNames=[],i=0;i<categoryMetadata.length;i++)categoryPath=categoryMetadata[i].split(">"),categoryName=categoryPath[categoryPath.length-1],categoryNames.push(categoryName);return categoryNames}}$(document).ready(function(){$(".ia-datepicker").pickadate({selectYears:!0,selectMonths:!0,format:"mmm dd, yyyy"})});$(document).ready(function(){Jquery_Multiple_category()}),function(){var a,AbstractChosen,Chosen,SelectParser,b,c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};SelectParser=function(){function SelectParser(){this.options_index=0;this.parsed=[]}return SelectParser.prototype.add_node=function(a){return"OPTGROUP"===a.nodeName.toUpperCase()?this.add_group(a):this.add_option(a)},SelectParser.prototype.add_group=function(a){var b,c,d,e,f,g;for(b=this.parsed.length,this.parsed.push({array_index:b,group:!0,label:this.escapeExpression(a.label),title:a.title?a.title:void 0,children:0,disabled:a.disabled,classes:a.className}),f=a.childNodes,g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(this.add_option(c,b,a.disabled));return g},SelectParser.prototype.add_option=function(a,b,c){if("OPTION"===a.nodeName.toUpperCase())return(""!==a.text?(null!=b&&(this.parsed[b].children+=1),this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,value:a.value,text:a.text,html:a.innerHTML,title:a.title?a.title:void 0,selected:a.selected,disabled:c===!0?c:a.disabled,group_array_index:b,group_label:null!=b?this.parsed[b].label:null,classes:a.className,style:a.style.cssText})):this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,empty:!0}),this.options_index+=1)},SelectParser.prototype.escapeExpression=function(a){var b,c;return null==a||a===!1?"":/[\&\<\>\"\'\`]/.test(a)?(b={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},c=/&(?!\w+;)|[\<\>\"\'\`]/g,a.replace(c,function(a){return b[a]||"&amp;"})):a},SelectParser}();SelectParser.select_to_array=function(a){var b,c,d,e,f;for(c=new SelectParser,f=a.childNodes,d=0,e=f.length;e>d;d++)b=f[d],c.add_node(b);return c.parsed};AbstractChosen=function(){function AbstractChosen(a,b){this.form_field=a;this.options=null!=b?b:{};AbstractChosen.browser_is_supported()&&(this.is_multiple=this.form_field.multiple,this.set_default_text(),this.set_default_values(),this.setup(),this.set_up_html(),this.register_observers(),this.on_ready())}return AbstractChosen.prototype.set_default_values=function(){var a=this;return this.click_test_action=function(b){return a.test_active_click(b)},this.activate_action=function(b){return a.activate_field(b)},this.active_field=!1,this.mouse_on_container=!1,this.results_showing=!1,this.result_highlighted=null,this.allow_single_deselect=null!=this.options.allow_single_deselect&&null!=this.form_field.options[0]&&""===this.form_field.options[0].text?this.options.allow_single_deselect:!1,this.disable_search_threshold=this.options.disable_search_threshold||0,this.disable_search=this.options.disable_search||!1,this.enable_split_word_search=null!=this.options.enable_split_word_search?this.options.enable_split_word_search:!0,this.group_search=null!=this.options.group_search?this.options.group_search:!0,this.search_contains=this.options.search_contains||!1,this.single_backstroke_delete=null!=this.options.single_backstroke_delete?this.options.single_backstroke_delete:!0,this.max_selected_options=this.options.max_selected_options||1/0,this.inherit_select_classes=this.options.inherit_select_classes||!1,this.display_selected_options=null!=this.options.display_selected_options?this.options.display_selected_options:!0,this.display_disabled_options=null!=this.options.display_disabled_options?this.options.display_disabled_options:!0,this.include_group_label_in_selected=this.options.include_group_label_in_selected||!1},AbstractChosen.prototype.set_default_text=function(){return this.default_text=this.form_field.getAttribute("data-placeholder")?this.form_field.getAttribute("data-placeholder"):this.is_multiple?this.options.placeholder_text_multiple||this.options.placeholder_text||AbstractChosen.default_multiple_text:this.options.placeholder_text_single||this.options.placeholder_text||AbstractChosen.default_single_text,this.results_none_found=this.form_field.getAttribute("data-no_results_text")||this.options.no_results_text||AbstractChosen.default_no_result_text},AbstractChosen.prototype.choice_label=function(a){return this.include_group_label_in_selected&&null!=a.group_label?"<b class='group-name'>"+a.group_label+"<\/b>"+a.html:a.html},AbstractChosen.prototype.mouse_enter=function(){return this.mouse_on_container=!0},AbstractChosen.prototype.mouse_leave=function(){return this.mouse_on_container=!1},AbstractChosen.prototype.input_focus=function(){var a=this;if(this.is_multiple){if(!this.active_field)return setTimeout(function(){return a.container_mousedown()},50)}else if(!this.active_field)return this.activate_field()},AbstractChosen.prototype.input_blur=function(){var a=this;if(!this.mouse_on_container)return(this.active_field=!1,setTimeout(function(){return a.blur_test()},100))},AbstractChosen.prototype.results_option_build=function(a){var b,c,d,e,f;for(b="",f=this.results_data,d=0,e=f.length;e>d;d++)c=f[d],b+=c.group?this.result_add_group(c):this.result_add_option(c),(null!=a?a.first:void 0)&&(c.selected&&this.is_multiple?this.choice_build(c):c.selected&&!this.is_multiple&&this.single_set_selected_text(this.choice_label(c)));return b},AbstractChosen.prototype.result_add_option=function(a){var b,c;return a.search_match?this.include_option_in_results(a)?(b=[],a.disabled||a.selected&&this.is_multiple||b.push("active-result"),!a.disabled||a.selected&&this.is_multiple||b.push("disabled-result"),a.selected&&b.push("result-selected"),null!=a.group_array_index&&b.push("group-option"),""!==a.classes&&b.push(a.classes),c=document.createElement("li"),c.className=b.join(" "),c.style.cssText=a.style,c.setAttribute("data-option-array-index",a.array_index),c.innerHTML=a.search_text,a.title&&(c.title=a.title),this.outerHTML(c)):"":""},AbstractChosen.prototype.result_add_group=function(a){var b,c;return a.search_match||a.group_match?a.active_options>0?(b=[],b.push("group-result"),a.classes&&b.push(a.classes),c=document.createElement("li"),c.className=b.join(" "),c.innerHTML=a.search_text,a.title&&(c.title=a.title),this.outerHTML(c)):"":""},AbstractChosen.prototype.results_update_field=function(){return this.set_default_text(),this.is_multiple||this.results_reset_cleanup(),this.result_clear_highlight(),this.results_build(),this.results_showing?this.winnow_results():void 0},AbstractChosen.prototype.reset_single_select_options=function(){var a,b,c,d,e;for(d=this.results_data,e=[],b=0,c=d.length;c>b;b++)a=d[b],a.selected?e.push(a.selected=!1):e.push(void 0);return e},AbstractChosen.prototype.results_toggle=function(){return this.results_showing?this.results_hide():this.results_show()},AbstractChosen.prototype.results_search=function(){return this.results_showing?this.winnow_results():this.results_show()},AbstractChosen.prototype.winnow_results=function(){var a,b,c,d,e,f,g,h,i,j,k,l;for(this.no_results_clear(),d=0,f=this.get_search_text(),a=f.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),i=new RegExp(a,"i"),c=this.get_search_regex(a),l=this.results_data,j=0,k=l.length;k>j;j++)b=l[j],b.search_match=!1,e=null,this.include_option_in_results(b)&&(b.group&&(b.group_match=!1,b.active_options=0),null!=b.group_array_index&&this.results_data[b.group_array_index]&&(e=this.results_data[b.group_array_index],0===e.active_options&&e.search_match&&(d+=1),e.active_options+=1),b.search_text=b.group?b.label:b.html,(!b.group||this.group_search)&&(b.search_match=this.search_string_match(b.search_text,c),b.search_match&&!b.group&&(d+=1),b.search_match?(f.length&&(g=b.search_text.search(i),h=b.search_text.substr(0,g+f.length)+"<\/em>"+b.search_text.substr(g+f.length),b.search_text=h.substr(0,g)+"<em>"+h.substr(g)),null!=e&&(e.group_match=!0)):null!=b.group_array_index&&this.results_data[b.group_array_index].search_match&&(b.search_match=!0)));return this.result_clear_highlight(),1>d&&f.length?(this.update_results_content(""),this.no_results(f)):(this.update_results_content(this.results_option_build()),this.winnow_results_set_highlight())},AbstractChosen.prototype.get_search_regex=function(a){var b;return b=this.search_contains?"":"^",new RegExp(b+a,"i")},AbstractChosen.prototype.search_string_match=function(a,b){var c,d,e,f;if(b.test(a))return!0;if(this.enable_split_word_search&&(a.indexOf(" ")>=0||0===a.indexOf("["))&&(d=a.replace(/\[|\]/g,"").split(" "),d.length))for(e=0,f=d.length;f>e;e++)if(c=d[e],b.test(c))return!0},AbstractChosen.prototype.choices_count=function(){var a,b,c,d;if(null!=this.selected_option_count)return this.selected_option_count;for(this.selected_option_count=0,d=this.form_field.options,b=0,c=d.length;c>b;b++)a=d[b],a.selected&&(this.selected_option_count+=1);return this.selected_option_count},AbstractChosen.prototype.choices_click=function(a){return a.preventDefault(),this.results_showing||this.is_disabled?void 0:this.results_show()},AbstractChosen.prototype.keyup_checker=function(a){var b,c;switch(b=null!=(c=a.which)?c:a.keyCode,this.search_field_scale(),b){case 8:if(this.is_multiple&&this.backstroke_length<1&&this.choices_count()>0)return this.keydown_backstroke();if(!this.pending_backstroke)return this.result_clear_highlight(),this.results_search();break;case 13:if(a.preventDefault(),this.results_showing)return this.result_select(a);break;case 27:return this.results_showing&&this.results_hide(),!0;case 9:case 38:case 40:case 16:case 91:case 17:break;default:return this.results_search()}},AbstractChosen.prototype.clipboard_event_checker=function(){var a=this;return setTimeout(function(){return a.results_search()},50)},AbstractChosen.prototype.container_width=function(){return null!=this.options.width?this.options.width:""+this.form_field.offsetWidth+"px"},AbstractChosen.prototype.include_option_in_results=function(a){return this.is_multiple&&!this.display_selected_options&&a.selected?!1:!this.display_disabled_options&&a.disabled?!1:a.empty?!1:!0},AbstractChosen.prototype.search_results_touchstart=function(a){return this.touch_started=!0,this.search_results_mouseover(a)},AbstractChosen.prototype.search_results_touchmove=function(a){return this.touch_started=!1,this.search_results_mouseout(a)},AbstractChosen.prototype.search_results_touchend=function(a){if(this.touch_started)return this.search_results_mouseup(a)},AbstractChosen.prototype.outerHTML=function(a){var b;return a.outerHTML?a.outerHTML:(b=document.createElement("div"),b.appendChild(a),b.innerHTML)},AbstractChosen.browser_is_supported=function(){return"Microsoft Internet Explorer"===window.navigator.appName?document.documentMode>=8:/iP(od|hone)/i.test(window.navigator.userAgent)?!1:/Android/i.test(window.navigator.userAgent)&&/Mobile/i.test(window.navigator.userAgent)?!1:!0},AbstractChosen.default_multiple_text="Select Some Options",AbstractChosen.default_single_text="Select an Option",AbstractChosen.default_no_result_text="No results match",AbstractChosen}();a=jQuery;a.fn.extend({chosen:function(b){return AbstractChosen.browser_is_supported()?this.each(function(){var c,d;c=a(this);d=c.data("chosen");"destroy"===b&&d instanceof Chosen?d.destroy():d instanceof Chosen||c.data("chosen",new Chosen(this,b))}):this}});Chosen=function(c){function Chosen(){return b=Chosen.__super__.constructor.apply(this,arguments)}return d(Chosen,c),Chosen.prototype.setup=function(){return this.form_field_jq=a(this.form_field),this.current_selectedIndex=this.form_field.selectedIndex,this.is_rtl=this.form_field_jq.hasClass("chosen-rtl")},Chosen.prototype.set_up_html=function(){var b,c;return b=["chosen-container"],b.push("chosen-container-"+(this.is_multiple?"multi":"single")),this.inherit_select_classes&&this.form_field.className&&b.push(this.form_field.className),this.is_rtl&&b.push("chosen-rtl"),c={"class":b.join(" "),style:"width: "+this.container_width()+";",title:this.form_field.title},this.form_field.id.length&&(c.id=this.form_field.id.replace(/[^\w]/g,"_")+"_chosen"),this.container=a("<div />",c),this.is_multiple?this.container.html('<ul class="chosen-choices"><li class="search-field"><input type="text" value="'+this.default_text+'" class="default" autocomplete="off" style="width:25px;" /><\/li><\/ul><div class="chosen-drop"><ul class="chosen-results"><\/ul><\/div>'):this.container.html('<a class="chosen-single chosen-default" tabindex="-1"><span>'+this.default_text+'<\/span><div><b><\/b><\/div><\/a><div class="chosen-drop"><div class="chosen-search"><input type="text" autocomplete="off" /><\/div><ul class="chosen-results"><\/ul><\/div>'),this.form_field_jq.hide().after(this.container),this.dropdown=this.container.find("div.chosen-drop").first(),this.search_field=this.container.find("input").first(),this.search_results=this.container.find("ul.chosen-results").first(),this.search_field_scale(),this.search_no_results=this.container.find("li.no-results").first(),this.is_multiple?(this.search_choices=this.container.find("ul.chosen-choices").first(),this.search_container=this.container.find("li.search-field").first()):(this.search_container=this.container.find("div.chosen-search").first(),this.selected_item=this.container.find(".chosen-single").first()),this.results_build(),this.set_tab_index(),this.set_label_behavior()},Chosen.prototype.on_ready=function(){return this.form_field_jq.trigger("chosen:ready",{chosen:this})},Chosen.prototype.register_observers=function(){var a=this;return this.container.bind("touchstart.chosen",function(b){return a.container_mousedown(b),b.preventDefault()}),this.container.bind("touchend.chosen",function(b){return a.container_mouseup(b),b.preventDefault()}),this.container.bind("mousedown.chosen",function(b){a.container_mousedown(b)}),this.container.bind("mouseup.chosen",function(b){a.container_mouseup(b)}),this.container.bind("mouseenter.chosen",function(b){a.mouse_enter(b)}),this.container.bind("mouseleave.chosen",function(b){a.mouse_leave(b)}),this.search_results.bind("mouseup.chosen",function(b){a.search_results_mouseup(b)}),this.search_results.bind("mouseover.chosen",function(b){a.search_results_mouseover(b)}),this.search_results.bind("mouseout.chosen",function(b){a.search_results_mouseout(b)}),this.search_results.bind("mousewheel.chosen DOMMouseScroll.chosen",function(b){a.search_results_mousewheel(b)}),this.search_results.bind("touchstart.chosen",function(b){a.search_results_touchstart(b)}),this.search_results.bind("touchmove.chosen",function(b){a.search_results_touchmove(b)}),this.search_results.bind("touchend.chosen",function(b){a.search_results_touchend(b)}),this.form_field_jq.bind("chosen:updated.chosen",function(b){a.results_update_field(b)}),this.form_field_jq.bind("chosen:activate.chosen",function(b){a.activate_field(b)}),this.form_field_jq.bind("chosen:open.chosen",function(b){a.container_mousedown(b)}),this.form_field_jq.bind("chosen:close.chosen",function(b){a.input_blur(b)}),this.search_field.bind("blur.chosen",function(b){a.input_blur(b)}),this.search_field.bind("keyup.chosen",function(b){a.keyup_checker(b)}),this.search_field.bind("keydown.chosen",function(b){a.keydown_checker(b)}),this.search_field.bind("focus.chosen",function(b){a.input_focus(b)}),this.search_field.bind("cut.chosen",function(b){a.clipboard_event_checker(b)}),this.search_field.bind("paste.chosen",function(b){a.clipboard_event_checker(b)}),this.is_multiple?this.search_choices.bind("click.chosen",function(b){a.choices_click(b)}):this.container.bind("click.chosen",function(a){a.preventDefault()})},Chosen.prototype.destroy=function(){return a(this.container[0].ownerDocument).unbind("click.chosen",this.click_test_action),this.search_field[0].tabIndex&&(this.form_field_jq[0].tabIndex=this.search_field[0].tabIndex),this.container.remove(),this.form_field_jq.removeData("chosen"),this.form_field_jq.show()},Chosen.prototype.search_field_disabled=function(){return this.is_disabled=this.form_field_jq[0].disabled,this.is_disabled?(this.container.addClass("chosen-disabled"),this.search_field[0].disabled=!0,this.is_multiple||this.selected_item.unbind("focus.chosen",this.activate_action),this.close_field()):(this.container.removeClass("chosen-disabled"),this.search_field[0].disabled=!1,this.is_multiple?void 0:this.selected_item.bind("focus.chosen",this.activate_action))},Chosen.prototype.container_mousedown=function(b){if(!this.is_disabled&&(b&&"mousedown"===b.type&&!this.results_showing&&b.preventDefault(),null==b||!a(b.target).hasClass("search-choice-close")))return(this.active_field?this.is_multiple||!b||a(b.target)[0]!==this.selected_item[0]&&!a(b.target).parents("a.chosen-single").length||(b.preventDefault(),this.results_toggle()):(this.is_multiple&&this.search_field.val(""),a(this.container[0].ownerDocument).bind("click.chosen",this.click_test_action),this.results_show()),this.activate_field())},Chosen.prototype.container_mouseup=function(a){if("ABBR"===a.target.nodeName&&!this.is_disabled)return this.results_reset(a)},Chosen.prototype.search_results_mousewheel=function(a){var b;return a.originalEvent&&(b=a.originalEvent.deltaY||-a.originalEvent.wheelDelta||a.originalEvent.detail),null!=b?(a.preventDefault(),"DOMMouseScroll"===a.type&&(b=40*b),this.search_results.scrollTop(b+this.search_results.scrollTop())):void 0},Chosen.prototype.blur_test=function(){if(!this.active_field&&this.container.hasClass("chosen-container-active"))return this.close_field()},Chosen.prototype.close_field=function(){return a(this.container[0].ownerDocument).unbind("click.chosen",this.click_test_action),this.active_field=!1,this.results_hide(),this.container.removeClass("chosen-container-active"),this.clear_backstroke(),this.show_search_field_default(),this.search_field_scale()},Chosen.prototype.activate_field=function(){return this.container.addClass("chosen-container-active"),this.active_field=!0,this.search_field.val(this.search_field.val()),this.search_field.focus()},Chosen.prototype.test_active_click=function(b){var c;return c=a(b.target).closest(".chosen-container"),c.length&&this.container[0]===c[0]?this.active_field=!0:this.close_field()},Chosen.prototype.results_build=function(){return this.parsing=!0,this.selected_option_count=null,this.results_data=SelectParser.select_to_array(this.form_field),this.is_multiple?this.search_choices.find("li.search-choice").remove():this.is_multiple||(this.single_set_selected_text(),this.disable_search||this.form_field.options.length<=this.disable_search_threshold?(this.search_field[0].readOnly=!0,this.container.addClass("chosen-container-single-nosearch")):(this.search_field[0].readOnly=!1,this.container.removeClass("chosen-container-single-nosearch"))),this.update_results_content(this.results_option_build({first:!0})),this.search_field_disabled(),this.show_search_field_default(),this.search_field_scale(),this.parsing=!1},Chosen.prototype.result_do_highlight=function(a){var b,c,d,e,f;if(a.length){if(this.result_clear_highlight(),this.result_highlight=a,this.result_highlight.addClass("highlighted"),d=parseInt(this.search_results.css("maxHeight"),10),f=this.search_results.scrollTop(),e=d+f,c=this.result_highlight.position().top+this.search_results.scrollTop(),b=c+this.result_highlight.outerHeight(),b>=e)return this.search_results.scrollTop(b-d>0?b-d:0);if(f>c)return this.search_results.scrollTop(c)}},Chosen.prototype.result_clear_highlight=function(){return this.result_highlight&&this.result_highlight.removeClass("highlighted"),this.result_highlight=null},Chosen.prototype.results_show=function(){return this.is_multiple&&this.max_selected_options<=this.choices_count()?(this.form_field_jq.trigger("chosen:maxselected",{chosen:this}),!1):(this.container.addClass("chosen-with-drop"),this.results_showing=!0,this.search_field.focus(),this.search_field.val(this.search_field.val()),this.winnow_results(),this.form_field_jq.trigger("chosen:showing_dropdown",{chosen:this}))},Chosen.prototype.update_results_content=function(a){return this.search_results.html(a)},Chosen.prototype.results_hide=function(){return this.results_showing&&(this.result_clear_highlight(),this.container.removeClass("chosen-with-drop"),this.form_field_jq.trigger("chosen:hiding_dropdown",{chosen:this})),this.results_showing=!1},Chosen.prototype.set_tab_index=function(){var a;if(this.form_field.tabIndex)return(a=this.form_field.tabIndex,this.form_field.tabIndex=-1,this.search_field[0].tabIndex=a)},Chosen.prototype.set_label_behavior=function(){var b=this;return this.form_field_label=this.form_field_jq.parents("label"),!this.form_field_label.length&&this.form_field.id.length&&(this.form_field_label=a("label[for='"+this.form_field.id+"']")),this.form_field_label.length>0?this.form_field_label.bind("click.chosen",function(a){return b.is_multiple?b.container_mousedown(a):b.activate_field()}):void 0},Chosen.prototype.show_search_field_default=function(){return this.is_multiple&&this.choices_count()<1&&!this.active_field?(this.search_field.val(this.default_text),this.search_field.addClass("default")):(this.search_field.val(""),this.search_field.removeClass("default"))},Chosen.prototype.search_results_mouseup=function(b){var c;return c=a(b.target).hasClass("active-result")?a(b.target):a(b.target).parents(".active-result").first(),c.length?(this.result_highlight=c,this.result_select(b),this.search_field.focus()):void 0},Chosen.prototype.search_results_mouseover=function(b){var c;return c=a(b.target).hasClass("active-result")?a(b.target):a(b.target).parents(".active-result").first(),c?this.result_do_highlight(c):void 0},Chosen.prototype.search_results_mouseout=function(b){if(a(b.target).hasClass("active-result"))return this.result_clear_highlight()},Chosen.prototype.choice_build=function(b){var c,d,e=this;return c=a("<li />",{"class":"search-choice"}).html("<span>"+this.choice_label(b)+"<\/span>"),b.disabled?c.addClass("search-choice-disabled"):(d=a("<a />",{"class":"search-choice-close","data-option-array-index":b.array_index}),d.bind("click.chosen",function(a){return e.choice_destroy_link_click(a)}),c.append(d)),this.search_container.before(c)},Chosen.prototype.choice_destroy_link_click=function(b){return b.preventDefault(),b.stopPropagation(),this.is_disabled?void 0:this.choice_destroy(a(b.target))},Chosen.prototype.choice_destroy=function(a){if(this.result_deselect(a[0].getAttribute("data-option-array-index")))return(this.show_search_field_default(),this.is_multiple&&this.choices_count()>0&&this.search_field.val().length<1&&this.results_hide(),a.parents("li").first().remove(),this.search_field_scale())},Chosen.prototype.results_reset=function(){return this.reset_single_select_options(),this.form_field.options[0].selected=!0,this.single_set_selected_text(),this.show_search_field_default(),this.results_reset_cleanup(),this.form_field_jq.trigger("change"),this.active_field?this.results_hide():void 0},Chosen.prototype.results_reset_cleanup=function(){return this.current_selectedIndex=this.form_field.selectedIndex,this.selected_item.find("abbr").remove()},Chosen.prototype.result_select=function(a){var b,c;if(this.result_highlight)return(b=this.result_highlight,this.result_clear_highlight(),this.is_multiple&&this.max_selected_options<=this.choices_count()?(this.form_field_jq.trigger("chosen:maxselected",{chosen:this}),!1):(this.is_multiple?b.removeClass("active-result"):this.reset_single_select_options(),c=this.results_data[b[0].getAttribute("data-option-array-index")],c.selected=!0,this.form_field.options[c.options_index].selected=!0,this.selected_option_count=null,this.is_multiple?this.choice_build(c):this.single_set_selected_text(this.choice_label(c)),(a.metaKey||a.ctrlKey)&&this.is_multiple||this.results_hide(),this.search_field.val(""),(this.is_multiple||this.form_field.selectedIndex!==this.current_selectedIndex)&&this.form_field_jq.trigger("change",{selected:this.form_field.options[c.options_index].value}),this.current_selectedIndex=this.form_field.selectedIndex,a.preventDefault(),this.search_field_scale()))},Chosen.prototype.single_set_selected_text=function(a){return null==a&&(a=this.default_text),a===this.default_text?this.selected_item.addClass("chosen-default"):(this.single_deselect_control_build(),this.selected_item.removeClass("chosen-default")),this.selected_item.find("span").html(a)},Chosen.prototype.result_deselect=function(a){var b;return b=this.results_data[a],this.form_field.options[b.options_index].disabled?!1:(b.selected=!1,this.form_field.options[b.options_index].selected=!1,this.selected_option_count=null,this.result_clear_highlight(),this.results_showing&&this.winnow_results(),this.form_field_jq.trigger("change",{deselected:this.form_field.options[b.options_index].value}),this.search_field_scale(),!0)},Chosen.prototype.single_deselect_control_build=function(){if(this.allow_single_deselect)return(this.selected_item.find("abbr").length||this.selected_item.find("span").first().after('<abbr class="search-choice-close"><\/abbr>'),this.selected_item.addClass("chosen-single-with-deselect"))},Chosen.prototype.get_search_text=function(){return a("<div/>").text(a.trim(this.search_field.val())).html()},Chosen.prototype.winnow_results_set_highlight=function(){var a,b;return b=this.is_multiple?[]:this.search_results.find(".result-selected.active-result"),a=b.length?b.first():this.search_results.find(".active-result").first(),null!=a?this.result_do_highlight(a):void 0},Chosen.prototype.no_results=function(b){var c;return c=a('<li class="no-results">'+this.results_none_found+' "<span><\/span>"<\/li>'),c.find("span").first().html(b),this.search_results.append(c),this.form_field_jq.trigger("chosen:no_results",{chosen:this})},Chosen.prototype.no_results_clear=function(){return this.search_results.find(".no-results").remove()},Chosen.prototype.keydown_arrow=function(){var a;return this.results_showing&&this.result_highlight?(a=this.result_highlight.nextAll("li.active-result").first())?this.result_do_highlight(a):void 0:this.results_show()},Chosen.prototype.keyup_arrow=function(){var a;return this.results_showing||this.is_multiple?this.result_highlight?(a=this.result_highlight.prevAll("li.active-result"),a.length?this.result_do_highlight(a.first()):(this.choices_count()>0&&this.results_hide(),this.result_clear_highlight())):void 0:this.results_show()},Chosen.prototype.keydown_backstroke=function(){var a;return this.pending_backstroke?(this.choice_destroy(this.pending_backstroke.find("a").first()),this.clear_backstroke()):(a=this.search_container.siblings("li.search-choice").last(),a.length&&!a.hasClass("search-choice-disabled")?(this.pending_backstroke=a,this.single_backstroke_delete?this.keydown_backstroke():this.pending_backstroke.addClass("search-choice-focus")):void 0)},Chosen.prototype.clear_backstroke=function(){return this.pending_backstroke&&this.pending_backstroke.removeClass("search-choice-focus"),this.pending_backstroke=null},Chosen.prototype.keydown_checker=function(a){var b,c;switch(b=null!=(c=a.which)?c:a.keyCode,this.search_field_scale(),8!==b&&this.pending_backstroke&&this.clear_backstroke(),b){case 8:this.backstroke_length=this.search_field.val().length;break;case 9:this.results_showing&&!this.is_multiple&&this.result_select(a);this.mouse_on_container=!1;break;case 13:this.results_showing&&a.preventDefault();break;case 32:this.disable_search&&a.preventDefault();break;case 38:a.preventDefault();this.keyup_arrow();break;case 40:a.preventDefault();this.keydown_arrow()}},Chosen.prototype.search_field_scale=function(){var b,c,d,e,f,g,h,i,j;if(this.is_multiple){for(d=0,h=0,f="position:absolute; left: -1000px; top: -1000px; display:none;",g=["font-size","font-style","font-weight","font-family","line-height","text-transform","letter-spacing"],i=0,j=g.length;j>i;i++)e=g[i],f+=e+":"+this.search_field.css(e)+";";return b=a("<div />",{style:f}),b.text(this.search_field.val()),a("body").append(b),h=b.width()+25,b.remove(),c=this.container.outerWidth(),h>c-10&&(h=c-10),this.search_field.css({width:h+"px"})}},Chosen}(AbstractChosen)}.call(this);
/*!
 handlebars v4.0.5
Copyright (C) 2011-2015 by Yehuda Katz
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
@license
*/
(function(n,t){typeof exports=="object"&&typeof module=="object"?module.exports=t():typeof define=="function"&&define.amd?define([],t):typeof exports=="object"?exports.Handlebars=t():n.Handlebars=t()})(this,function(){return function(n){function t(r){if(i[r])return i[r].exports;var u=i[r]={exports:{},id:r,loaded:!1};return n[r].call(u.exports,u,u.exports,t),u.loaded=!0,u.exports}var i={};return t.m=n,t.c=i,t.p="",t(0)}([function(n,t,i){"use strict";function o(){var n=k();return n.compile=function(t,i){return f.compile(t,i,n)},n.precompile=function(t,i){return f.precompile(t,i,n)},n.AST=l["default"],n.Compiler=f.Compiler,n.JavaScriptCompiler=v["default"],n.Parser=e.parser,n.parse=e.parse,n}var u=i(1)["default"],r;t.__esModule=!0;var s=i(2),h=u(s),c=i(21),l=u(c),e=i(22),f=i(27),a=i(28),v=u(a),y=i(25),p=u(y),w=i(20),b=u(w),k=h["default"].create;r=o();r.create=o;b["default"](r);r.Visitor=p["default"];r["default"]=r;t["default"]=r;n.exports=t["default"]},function(n,t){"use strict";t["default"]=function(n){return n&&n.__esModule?n:{"default":n}};t.__esModule=!0},function(n,t,i){"use strict";function h(){var n=new o.HandlebarsEnvironment;return e.extend(n,o),n.SafeString=a["default"],n.Exception=y["default"],n.Utils=e,n.escapeExpression=e.escapeExpression,n.VM=s,n.template=function(t){return s.template(t,n)},n}var u=i(3)["default"],f=i(1)["default"],r;t.__esModule=!0;var c=i(4),o=u(c),l=i(18),a=f(l),v=i(6),y=f(v),p=i(5),e=u(p),w=i(19),s=u(w),b=i(20),k=f(b);r=h();r.create=h;k["default"](r);r["default"]=r;t["default"]=r;n.exports=t["default"]},function(n,t){"use strict";t["default"]=function(n){var t,i;if(n&&n.__esModule)return n;if(t={},n!=null)for(i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i]);return t["default"]=n,t};t.__esModule=!0},function(n,t,i){"use strict";function o(n,t,i){this.helpers=n||{};this.partials=t||{};this.decorators=i||{};v.registerDefaultHelpers(this);y.registerDefaultDecorators(this)}var s=i(1)["default"],h,c,f,l;t.__esModule=!0;t.HandlebarsEnvironment=o;var r=i(5),a=i(6),e=s(a),v=i(7),y=i(15),p=i(17),u=s(p);t.VERSION="4.0.5";h=7;t.COMPILER_REVISION=h;c={1:"<= 1.0.rc.2",2:"== 1.0.0-rc.3",3:"== 1.0.0-rc.4",4:"== 1.x.x",5:"== 2.0.0-alpha.x",6:">= 2.0.0-beta.1",7:">= 4.0.0"};t.REVISION_CHANGES=c;f="[object Object]";o.prototype={constructor:o,logger:u["default"],log:u["default"].log,registerHelper:function(n,t){if(r.toString.call(n)===f){if(t)throw new e["default"]("Arg not supported with multiple helpers");r.extend(this.helpers,n)}else this.helpers[n]=t},unregisterHelper:function(n){delete this.helpers[n]},registerPartial:function(n,t){if(r.toString.call(n)===f)r.extend(this.partials,n);else{if(typeof t=="undefined")throw new e["default"]('Attempting to register a partial called "'+n+'" as undefined');this.partials[n]=t}},unregisterPartial:function(n){delete this.partials[n]},registerDecorator:function(n,t){if(r.toString.call(n)===f){if(t)throw new e["default"]("Arg not supported with multiple decorators");r.extend(this.decorators,n)}else this.decorators[n]=t},unregisterDecorator:function(n){delete this.decorators[n]}};l=u["default"].log;t.log=l;t.createFrame=r.createFrame;t.logger=u["default"]},function(n,t){"use strict";function h(n){return e[n]}function f(n){for(var i,t=1;t<arguments.length;t++)for(i in arguments[t])Object.prototype.hasOwnProperty.call(arguments[t],i)&&(n[i]=arguments[t][i]);return n}function c(n,t){for(var i=0,r=n.length;i<r;i++)if(n[i]===t)return i;return-1}function l(n){if(typeof n!="string"){if(n&&n.toHTML)return n.toHTML();if(n==null)return"";if(!n)return n+"";n=""+n}return s.test(n)?n.replace(o,h):n}function a(n){return n||n===0?u(n)&&n.length===0?!0:!1:!0}function v(n){var t=f({},n);return t._parent=n,t}function y(n,t){return n.path=t,n}function p(n,t){return(n?n+".":"")+t}var i,r,u;t.__esModule=!0;t.extend=f;t.indexOf=c;t.escapeExpression=l;t.isEmpty=a;t.createFrame=v;t.blockParams=y;t.appendContextPath=p;var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;","=":"&#x3D;"},o=/[&<>"'`=]/g,s=/[&<>"'`=]/;i=Object.prototype.toString;t.toString=i;r=function(n){return typeof n=="function"};r(/x/)&&(t.isFunction=r=function(n){return typeof n=="function"&&i.call(n)==="[object Function]"});t.isFunction=r;u=Array.isArray||function(n){return n&&typeof n=="object"?i.call(n)==="[object Array]":!1};t.isArray=u},function(n,t){"use strict";function r(n,t){var f=t&&t.loc,e=undefined,o=undefined,s,u;for(f&&(e=f.start.line,o=f.start.column,n+=" - "+e+":"+o),s=Error.prototype.constructor.call(this,n),u=0;u<i.length;u++)this[i[u]]=s[i[u]];Error.captureStackTrace&&Error.captureStackTrace(this,r);f&&(this.lineNumber=e,this.column=o)}t.__esModule=!0;var i=["description","fileName","lineNumber","message","name","number","stack"];r.prototype=new Error;t["default"]=r;n.exports=t["default"]},function(n,t,i){"use strict";function k(n){f["default"](n);o["default"](n);h["default"](n);l["default"](n);v["default"](n);p["default"](n);b["default"](n)}var r=i(1)["default"];t.__esModule=!0;t.registerDefaultHelpers=k;var u=i(8),f=r(u),e=i(9),o=r(e),s=i(10),h=r(s),c=i(11),l=r(c),a=i(12),v=r(a),y=i(13),p=r(y),w=i(14),b=r(w)},function(n,t,i){"use strict";t.__esModule=!0;var r=i(5);t["default"]=function(n){n.registerHelper("blockHelperMissing",function(t,i){var f=i.inverse,e=i.fn,u;return t===!0?e(this):t===!1||t==null?f(this):r.isArray(t)?t.length>0?(i.ids&&(i.ids=[i.name]),n.helpers.each(t,i)):f(this):(i.data&&i.ids&&(u=r.createFrame(i.data),u.contextPath=r.appendContextPath(i.data.contextPath,i.name),i={data:u}),e(t,i))})};n.exports=t["default"]},function(n,t,i){"use strict";var u=i(1)["default"];t.__esModule=!0;var r=i(5),f=i(6),e=u(f);t["default"]=function(n){n.registerHelper("each",function(n,t){function h(t,i,f){u&&(u.key=t,u.index=i,u.first=i===0,u.last=!!f,s&&(u.contextPath=s+t));o=o+a(n[t],{data:u,blockParams:r.blockParams([n[t],t],[s+t,null])})}var l,f,c;if(!t)throw new e["default"]("Must pass iterator to #each");var a=t.fn,v=t.inverse,i=0,o="",u=undefined,s=undefined;if(t.data&&t.ids&&(s=r.appendContextPath(t.data.contextPath,t.ids[0])+"."),r.isFunction(n)&&(n=n.call(this)),t.data&&(u=r.createFrame(t.data)),n&&typeof n=="object")if(r.isArray(n))for(l=n.length;i<l;i++)i in n&&h(i,i,i===n.length-1);else{f=undefined;for(c in n)n.hasOwnProperty(c)&&(f!==undefined&&h(f,i-1),f=c,i++);f!==undefined&&h(f,i-1,!0)}return i===0&&(o=v(this)),o})};n.exports=t["default"]},function(n,t,i){"use strict";var f=i(1)["default"],r,u;t.__esModule=!0;r=i(6);u=f(r);t["default"]=function(n){n.registerHelper("helperMissing",function(){if(arguments.length===1)return undefined;throw new u["default"]('Missing helper: "'+arguments[arguments.length-1].name+'"');})};n.exports=t["default"]},function(n,t,i){"use strict";t.__esModule=!0;var r=i(5);t["default"]=function(n){n.registerHelper("if",function(n,t){return r.isFunction(n)&&(n=n.call(this)),(t.hash.includeZero||n)&&!r.isEmpty(n)?t.fn(this):t.inverse(this)});n.registerHelper("unless",function(t,i){return n.helpers["if"].call(this,t,{fn:i.inverse,inverse:i.fn,hash:i.hash})})};n.exports=t["default"]},function(n,t){"use strict";t.__esModule=!0;t["default"]=function(n){n.registerHelper("log",function(){for(var i,r=[undefined],t=arguments[arguments.length-1],u=0;u<arguments.length-1;u++)r.push(arguments[u]);i=1;t.hash.level!=null?i=t.hash.level:t.data&&t.data.level!=null&&(i=t.data.level);r[0]=i;n.log.apply(n,r)})};n.exports=t["default"]},function(n,t){"use strict";t.__esModule=!0;t["default"]=function(n){n.registerHelper("lookup",function(n,t){return n&&n[t]})};n.exports=t["default"]},function(n,t,i){"use strict";t.__esModule=!0;var r=i(5);t["default"]=function(n){n.registerHelper("with",function(n,t){var u,i;return r.isFunction(n)&&(n=n.call(this)),u=t.fn,r.isEmpty(n)?t.inverse(this):(i=t.data,t.data&&t.ids&&(i=r.createFrame(t.data),i.contextPath=r.appendContextPath(t.data.contextPath,t.ids[0])),u(n,{data:i,blockParams:r.blockParams([n],[i&&i.contextPath])}))})};n.exports=t["default"]},function(n,t,i){"use strict";function e(n){u["default"](n)}var f=i(1)["default"],r,u;t.__esModule=!0;t.registerDefaultDecorators=e;r=i(16);u=f(r)},function(n,t,i){"use strict";t.__esModule=!0;var r=i(5);t["default"]=function(n){n.registerDecorator("inline",function(n,t,i,u){var f=n;return t.partials||(t.partials={},f=function(u,f){var e=i.partials,o;return i.partials=r.extend({},e,t.partials),o=n(u,f),i.partials=e,o}),t.partials[u.args[0]]=u.fn,f})};n.exports=t["default"]},function(n,t,i){"use strict";t.__esModule=!0;var u=i(5),r={methodMap:["debug","info","warn","error"],level:"info",lookupLevel:function(n){if(typeof n=="string"){var t=u.indexOf(r.methodMap,n.toLowerCase());n=t>=0?t:parseInt(n,10)}return n},log:function(n){var t;if(n=r.lookupLevel(n),typeof console!="undefined"&&r.lookupLevel(r.level)<=n){t=r.methodMap[n];console[t]||(t="log");for(var u=arguments.length,f=Array(u>1?u-1:0),i=1;i<u;i++)f[i-1]=arguments[i];console[t].apply(console,f)}}};t["default"]=r;n.exports=t["default"]},function(n,t){"use strict";function i(n){this.string=n}t.__esModule=!0;i.prototype.toString=i.prototype.toHTML=function(){return""+this.string};t["default"]=i;n.exports=t["default"]},function(n,t,i){"use strict";function v(n){var t=n&&n[0]||1,i=f.COMPILER_REVISION,u,e;if(t!==i)if(t<i){u=f.REVISION_CHANGES[i];e=f.REVISION_CHANGES[t];throw new r["default"]("Template was precompiled with an older version of Handlebars than the current runtime. Please update your precompiler to a newer version ("+u+") or downgrade your runtime to an older version ("+e+").");}else throw new r["default"]("Template was precompiled with a newer version of Handlebars than the current runtime. Please update your runtime to a newer version ("+n[1]+").");}function y(n,t){function o(i,f,e){var o,h,s,c;if(e.hash&&(f=u.extend({},f,e.hash),e.ids&&(e.ids[0]=!0)),i=t.VM.resolvePartial.call(this,i,f,e),o=t.VM.invokePartial.call(this,i,f,e),o==null&&t.compile&&(e.partials[e.name]=t.compile(i,n.compilerOptions,t),o=e.partials[e.name](f,e)),o!=null){if(e.indent){for(h=o.split("\n"),s=0,c=h.length;s<c;s++){if(!h[s]&&s+1===c)break;h[s]=e.indent+h[s]}o=h.join("\n")}return o}throw new r["default"]("The partial "+e.name+" could not be compiled when running in runtime-only mode");}function f(t){function h(t){return""+n.main(i,t,i.helpers,i.partials,u,o,e)}var r=arguments.length<=1||arguments[1]===undefined?{}:arguments[1],u=r.data,e,o;return f._setup(r),!r.partial&&n.useData&&(u=b(t,u)),e=undefined,o=n.useBlockParams?[]:undefined,n.useDepths&&(e=r.depths?t!==r.depths[0]?[t].concat(r.depths):r.depths:[t]),h=s(n.main,h,i,r.depths||[],u,o),h(t,r)}if(!t)throw new r["default"]("No environment passed to template");if(!n||!n.main)throw new r["default"]("Unknown template object: "+typeof n);n.main.decorator=n.main_d;t.VM.checkRevision(n.compiler);var i={strict:function(n,t){if(!(t in n))throw new r["default"]('"'+t+'" not defined in '+n);return n[t]},lookup:function(n,t){for(var r=n.length,i=0;i<r;i++)if(n[i]&&n[i][t]!=null)return n[i][t]},lambda:function(n,t){return typeof n=="function"?n.call(t):n},escapeExpression:u.escapeExpression,invokePartial:o,fn:function(t){var i=n[t];return i.decorator=n[t+"_d"],i},programs:[],program:function(n,t,i,r,u){var f=this.programs[n],o=this.fn(n);return t||u||r||i?f=e(this,n,o,t,i,r,u):f||(f=this.programs[n]=e(this,n,o)),f},data:function(n,t){while(n&&t--)n=n._parent;return n},merge:function(n,t){var i=n||t;return n&&t&&n!==t&&(i=u.extend({},t,n)),i},noop:t.VM.noop,compilerInfo:n.compiler};return f.isTop=!0,f._setup=function(r){r.partial?(i.helpers=r.helpers,i.partials=r.partials,i.decorators=r.decorators):(i.helpers=i.merge(r.helpers,t.helpers),n.usePartial&&(i.partials=i.merge(r.partials,t.partials)),(n.usePartial||n.useDecorators)&&(i.decorators=i.merge(r.decorators,t.decorators)))},f._child=function(t,u,f,o){if(n.useBlockParams&&!f)throw new r["default"]("must pass block params");if(n.useDepths&&!o)throw new r["default"]("must pass parent depths");return e(i,t,n[t],u,0,f,o)},f}function e(n,t,i,r,u,f,e){function o(t){var u=arguments.length<=1||arguments[1]===undefined?{}:arguments[1],o=e;return e&&t!==e[0]&&(o=[t].concat(e)),i(n,t,n.helpers,n.partials,u.data||r,f&&[u.blockParams].concat(f),o)}return o=s(i,o,n,e,r,f),o.program=t,o.depth=e?e.length:0,o.blockParams=u||0,o}function p(n,t,i){return n?n.call||i.name||(i.name=n,n=i.partials[n]):n=i.name==="@partial-block"?i.data["partial-block"]:i.partials[i.name],n}function w(n,t,i){i.partial=!0;i.ids&&(i.data.contextPath=i.ids[0]||i.data.contextPath);var e=undefined;if(i.fn&&i.fn!==o&&(i.data=f.createFrame(i.data),e=i.data["partial-block"]=i.fn,e.partials&&(i.partials=u.extend({},i.partials,e.partials))),n===undefined&&e&&(n=e),n===undefined)throw new r["default"]("The partial "+i.name+" could not be found");else if(n instanceof Function)return n(t,i)}function o(){return""}function b(n,t){return t&&"root"in t||(t=t?f.createFrame(t):{},t.root=n),t}function s(n,t,i,r,f,e){if(n.decorator){var o={};t=n.decorator(t,o,i,r&&r[0],f,e,r);u.extend(t,o)}return t}var h=i(3)["default"],c=i(1)["default"];t.__esModule=!0;t.checkRevision=v;t.template=y;t.wrapProgram=e;t.resolvePartial=p;t.invokePartial=w;t.noop=o;var l=i(5),u=h(l),a=i(6),r=c(a),f=i(4)},function(n,t){(function(i){"use strict";t.__esModule=!0;t["default"]=function(n){var t=typeof i!="undefined"?i:window,r=t.Handlebars;n.noConflict=function(){return t.Handlebars===n&&(t.Handlebars=r),n}};n.exports=t["default"]}).call(t,function(){return this}())},function(n,t){"use strict";t.__esModule=!0;var i={helpers:{helperExpression:function(n){return n.type==="SubExpression"||(n.type==="MustacheStatement"||n.type==="BlockStatement")&&!!(n.params&&n.params.length||n.hash)},scopedId:function(n){return/^\.|this\b/.test(n.original)},simpleId:function(n){return n.parts.length===1&&!i.helpers.scopedId(n)&&!n.depth}}};t["default"]=i;n.exports=t["default"]},function(n,t,i){"use strict";function v(n,t){if(n.type==="Program")return n;u["default"].yy=r;r.locInfo=function(n){return new r.SourceLocation(t&&t.srcName,n)};var i=new h["default"](t);return i.accept(u["default"].parse(n))}var f=i(1)["default"],e=i(3)["default"],r;t.__esModule=!0;t.parse=v;var o=i(23),u=f(o),s=i(24),h=f(s),c=i(26),l=e(c),a=i(5);t.parser=u["default"];r={};a.extend(r,l)},function(n,t){"use strict";var i=function(){function t(){this.yy={}}var n={trace:function(){},yy:{},symbols_:{error:2,root:3,program:4,EOF:5,program_repetition0:6,statement:7,mustache:8,block:9,rawBlock:10,partial:11,partialBlock:12,content:13,COMMENT:14,CONTENT:15,openRawBlock:16,rawBlock_repetition_plus0:17,END_RAW_BLOCK:18,OPEN_RAW_BLOCK:19,helperName:20,openRawBlock_repetition0:21,openRawBlock_option0:22,CLOSE_RAW_BLOCK:23,openBlock:24,block_option0:25,closeBlock:26,openInverse:27,block_option1:28,OPEN_BLOCK:29,openBlock_repetition0:30,openBlock_option0:31,openBlock_option1:32,CLOSE:33,OPEN_INVERSE:34,openInverse_repetition0:35,openInverse_option0:36,openInverse_option1:37,openInverseChain:38,OPEN_INVERSE_CHAIN:39,openInverseChain_repetition0:40,openInverseChain_option0:41,openInverseChain_option1:42,inverseAndProgram:43,INVERSE:44,inverseChain:45,inverseChain_option0:46,OPEN_ENDBLOCK:47,OPEN:48,mustache_repetition0:49,mustache_option0:50,OPEN_UNESCAPED:51,mustache_repetition1:52,mustache_option1:53,CLOSE_UNESCAPED:54,OPEN_PARTIAL:55,partialName:56,partial_repetition0:57,partial_option0:58,openPartialBlock:59,OPEN_PARTIAL_BLOCK:60,openPartialBlock_repetition0:61,openPartialBlock_option0:62,param:63,sexpr:64,OPEN_SEXPR:65,sexpr_repetition0:66,sexpr_option0:67,CLOSE_SEXPR:68,hash:69,hash_repetition_plus0:70,hashSegment:71,ID:72,EQUALS:73,blockParams:74,OPEN_BLOCK_PARAMS:75,blockParams_repetition_plus0:76,CLOSE_BLOCK_PARAMS:77,path:78,dataName:79,STRING:80,NUMBER:81,BOOLEAN:82,UNDEFINED:83,NULL:84,DATA:85,pathSegments:86,SEP:87,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",14:"COMMENT",15:"CONTENT",18:"END_RAW_BLOCK",19:"OPEN_RAW_BLOCK",23:"CLOSE_RAW_BLOCK",29:"OPEN_BLOCK",33:"CLOSE",34:"OPEN_INVERSE",39:"OPEN_INVERSE_CHAIN",44:"INVERSE",47:"OPEN_ENDBLOCK",48:"OPEN",51:"OPEN_UNESCAPED",54:"CLOSE_UNESCAPED",55:"OPEN_PARTIAL",60:"OPEN_PARTIAL_BLOCK",65:"OPEN_SEXPR",68:"CLOSE_SEXPR",72:"ID",73:"EQUALS",75:"OPEN_BLOCK_PARAMS",77:"CLOSE_BLOCK_PARAMS",80:"STRING",81:"NUMBER",82:"BOOLEAN",83:"UNDEFINED",84:"NULL",85:"DATA",87:"SEP"},productions_:[0,[3,2],[4,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[13,1],[10,3],[16,5],[9,4],[9,4],[24,6],[27,6],[38,6],[43,2],[45,3],[45,1],[26,3],[8,5],[8,5],[11,5],[12,3],[59,5],[63,1],[63,1],[64,5],[69,1],[71,3],[74,3],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[56,1],[56,1],[79,2],[78,1],[86,3],[86,1],[6,0],[6,2],[17,1],[17,2],[21,0],[21,2],[22,0],[22,1],[25,0],[25,1],[28,0],[28,1],[30,0],[30,2],[31,0],[31,1],[32,0],[32,1],[35,0],[35,2],[36,0],[36,1],[37,0],[37,1],[40,0],[40,2],[41,0],[41,1],[42,0],[42,1],[46,0],[46,1],[49,0],[49,2],[50,0],[50,1],[52,0],[52,2],[53,0],[53,1],[57,0],[57,2],[58,0],[58,1],[61,0],[61,2],[62,0],[62,1],[66,0],[66,2],[67,0],[67,1],[70,1],[70,2],[76,1],[76,2]],performAction:function(n,t,i,r,u,f){var e=f.length-1,s,o;switch(u){case 1:return f[e-1];case 2:this.$=r.prepareProgram(f[e]);break;case 3:this.$=f[e];break;case 4:this.$=f[e];break;case 5:this.$=f[e];break;case 6:this.$=f[e];break;case 7:this.$=f[e];break;case 8:this.$=f[e];break;case 9:this.$={type:"CommentStatement",value:r.stripComment(f[e]),strip:r.stripFlags(f[e],f[e]),loc:r.locInfo(this._$)};break;case 10:this.$={type:"ContentStatement",original:f[e],value:f[e],loc:r.locInfo(this._$)};break;case 11:this.$=r.prepareRawBlock(f[e-2],f[e-1],f[e],this._$);break;case 12:this.$={path:f[e-3],params:f[e-2],hash:f[e-1]};break;case 13:this.$=r.prepareBlock(f[e-3],f[e-2],f[e-1],f[e],!1,this._$);break;case 14:this.$=r.prepareBlock(f[e-3],f[e-2],f[e-1],f[e],!0,this._$);break;case 15:this.$={open:f[e-5],path:f[e-4],params:f[e-3],hash:f[e-2],blockParams:f[e-1],strip:r.stripFlags(f[e-5],f[e])};break;case 16:this.$={path:f[e-4],params:f[e-3],hash:f[e-2],blockParams:f[e-1],strip:r.stripFlags(f[e-5],f[e])};break;case 17:this.$={path:f[e-4],params:f[e-3],hash:f[e-2],blockParams:f[e-1],strip:r.stripFlags(f[e-5],f[e])};break;case 18:this.$={strip:r.stripFlags(f[e-1],f[e-1]),program:f[e]};break;case 19:s=r.prepareBlock(f[e-2],f[e-1],f[e],f[e],!1,this._$);o=r.prepareProgram([s],f[e-1].loc);o.chained=!0;this.$={strip:f[e-2].strip,program:o,chain:!0};break;case 20:this.$=f[e];break;case 21:this.$={path:f[e-1],strip:r.stripFlags(f[e-2],f[e])};break;case 22:this.$=r.prepareMustache(f[e-3],f[e-2],f[e-1],f[e-4],r.stripFlags(f[e-4],f[e]),this._$);break;case 23:this.$=r.prepareMustache(f[e-3],f[e-2],f[e-1],f[e-4],r.stripFlags(f[e-4],f[e]),this._$);break;case 24:this.$={type:"PartialStatement",name:f[e-3],params:f[e-2],hash:f[e-1],indent:"",strip:r.stripFlags(f[e-4],f[e]),loc:r.locInfo(this._$)};break;case 25:this.$=r.preparePartialBlock(f[e-2],f[e-1],f[e],this._$);break;case 26:this.$={path:f[e-3],params:f[e-2],hash:f[e-1],strip:r.stripFlags(f[e-4],f[e])};break;case 27:this.$=f[e];break;case 28:this.$=f[e];break;case 29:this.$={type:"SubExpression",path:f[e-3],params:f[e-2],hash:f[e-1],loc:r.locInfo(this._$)};break;case 30:this.$={type:"Hash",pairs:f[e],loc:r.locInfo(this._$)};break;case 31:this.$={type:"HashPair",key:r.id(f[e-2]),value:f[e],loc:r.locInfo(this._$)};break;case 32:this.$=r.id(f[e-1]);break;case 33:this.$=f[e];break;case 34:this.$=f[e];break;case 35:this.$={type:"StringLiteral",value:f[e],original:f[e],loc:r.locInfo(this._$)};break;case 36:this.$={type:"NumberLiteral",value:Number(f[e]),original:Number(f[e]),loc:r.locInfo(this._$)};break;case 37:this.$={type:"BooleanLiteral",value:f[e]==="true",original:f[e]==="true",loc:r.locInfo(this._$)};break;case 38:this.$={type:"UndefinedLiteral",original:undefined,value:undefined,loc:r.locInfo(this._$)};break;case 39:this.$={type:"NullLiteral",original:null,value:null,loc:r.locInfo(this._$)};break;case 40:this.$=f[e];break;case 41:this.$=f[e];break;case 42:this.$=r.preparePath(!0,f[e],this._$);break;case 43:this.$=r.preparePath(!1,f[e],this._$);break;case 44:f[e-2].push({part:r.id(f[e]),original:f[e],separator:f[e-1]});this.$=f[e-2];break;case 45:this.$=[{part:r.id(f[e]),original:f[e]}];break;case 46:this.$=[];break;case 47:f[e-1].push(f[e]);break;case 48:this.$=[f[e]];break;case 49:f[e-1].push(f[e]);break;case 50:this.$=[];break;case 51:f[e-1].push(f[e]);break;case 58:this.$=[];break;case 59:f[e-1].push(f[e]);break;case 64:this.$=[];break;case 65:f[e-1].push(f[e]);break;case 70:this.$=[];break;case 71:f[e-1].push(f[e]);break;case 78:this.$=[];break;case 79:f[e-1].push(f[e]);break;case 82:this.$=[];break;case 83:f[e-1].push(f[e]);break;case 86:this.$=[];break;case 87:f[e-1].push(f[e]);break;case 90:this.$=[];break;case 91:f[e-1].push(f[e]);break;case 94:this.$=[];break;case 95:f[e-1].push(f[e]);break;case 98:this.$=[f[e]];break;case 99:f[e-1].push(f[e]);break;case 100:this.$=[f[e]];break;case 101:f[e-1].push(f[e])}},table:[{3:1,4:2,5:[2,46],6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{1:[3]},{5:[1,4]},{5:[2,2],7:5,8:6,9:7,10:8,11:9,12:10,13:11,14:[1,12],15:[1,20],16:17,19:[1,23],24:15,27:16,29:[1,21],34:[1,22],39:[2,2],44:[2,2],47:[2,2],48:[1,13],51:[1,14],55:[1,18],59:19,60:[1,24]},{1:[2,1]},{5:[2,47],14:[2,47],15:[2,47],19:[2,47],29:[2,47],34:[2,47],39:[2,47],44:[2,47],47:[2,47],48:[2,47],51:[2,47],55:[2,47],60:[2,47]},{5:[2,3],14:[2,3],15:[2,3],19:[2,3],29:[2,3],34:[2,3],39:[2,3],44:[2,3],47:[2,3],48:[2,3],51:[2,3],55:[2,3],60:[2,3]},{5:[2,4],14:[2,4],15:[2,4],19:[2,4],29:[2,4],34:[2,4],39:[2,4],44:[2,4],47:[2,4],48:[2,4],51:[2,4],55:[2,4],60:[2,4]},{5:[2,5],14:[2,5],15:[2,5],19:[2,5],29:[2,5],34:[2,5],39:[2,5],44:[2,5],47:[2,5],48:[2,5],51:[2,5],55:[2,5],60:[2,5]},{5:[2,6],14:[2,6],15:[2,6],19:[2,6],29:[2,6],34:[2,6],39:[2,6],44:[2,6],47:[2,6],48:[2,6],51:[2,6],55:[2,6],60:[2,6]},{5:[2,7],14:[2,7],15:[2,7],19:[2,7],29:[2,7],34:[2,7],39:[2,7],44:[2,7],47:[2,7],48:[2,7],51:[2,7],55:[2,7],60:[2,7]},{5:[2,8],14:[2,8],15:[2,8],19:[2,8],29:[2,8],34:[2,8],39:[2,8],44:[2,8],47:[2,8],48:[2,8],51:[2,8],55:[2,8],60:[2,8]},{5:[2,9],14:[2,9],15:[2,9],19:[2,9],29:[2,9],34:[2,9],39:[2,9],44:[2,9],47:[2,9],48:[2,9],51:[2,9],55:[2,9],60:[2,9]},{20:25,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:36,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:37,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{4:38,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{13:40,15:[1,20],17:39},{20:42,56:41,64:43,65:[1,44],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:45,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{5:[2,10],14:[2,10],15:[2,10],18:[2,10],19:[2,10],29:[2,10],34:[2,10],39:[2,10],44:[2,10],47:[2,10],48:[2,10],51:[2,10],55:[2,10],60:[2,10]},{20:46,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:47,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:48,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:42,56:49,64:43,65:[1,44],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[2,78],49:50,65:[2,78],72:[2,78],80:[2,78],81:[2,78],82:[2,78],83:[2,78],84:[2,78],85:[2,78]},{23:[2,33],33:[2,33],54:[2,33],65:[2,33],68:[2,33],72:[2,33],75:[2,33],80:[2,33],81:[2,33],82:[2,33],83:[2,33],84:[2,33],85:[2,33]},{23:[2,34],33:[2,34],54:[2,34],65:[2,34],68:[2,34],72:[2,34],75:[2,34],80:[2,34],81:[2,34],82:[2,34],83:[2,34],84:[2,34],85:[2,34]},{23:[2,35],33:[2,35],54:[2,35],65:[2,35],68:[2,35],72:[2,35],75:[2,35],80:[2,35],81:[2,35],82:[2,35],83:[2,35],84:[2,35],85:[2,35]},{23:[2,36],33:[2,36],54:[2,36],65:[2,36],68:[2,36],72:[2,36],75:[2,36],80:[2,36],81:[2,36],82:[2,36],83:[2,36],84:[2,36],85:[2,36]},{23:[2,37],33:[2,37],54:[2,37],65:[2,37],68:[2,37],72:[2,37],75:[2,37],80:[2,37],81:[2,37],82:[2,37],83:[2,37],84:[2,37],85:[2,37]},{23:[2,38],33:[2,38],54:[2,38],65:[2,38],68:[2,38],72:[2,38],75:[2,38],80:[2,38],81:[2,38],82:[2,38],83:[2,38],84:[2,38],85:[2,38]},{23:[2,39],33:[2,39],54:[2,39],65:[2,39],68:[2,39],72:[2,39],75:[2,39],80:[2,39],81:[2,39],82:[2,39],83:[2,39],84:[2,39],85:[2,39]},{23:[2,43],33:[2,43],54:[2,43],65:[2,43],68:[2,43],72:[2,43],75:[2,43],80:[2,43],81:[2,43],82:[2,43],83:[2,43],84:[2,43],85:[2,43],87:[1,51]},{72:[1,35],86:52},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{52:53,54:[2,82],65:[2,82],72:[2,82],80:[2,82],81:[2,82],82:[2,82],83:[2,82],84:[2,82],85:[2,82]},{25:54,38:56,39:[1,58],43:57,44:[1,59],45:55,47:[2,54]},{28:60,43:61,44:[1,59],47:[2,56]},{13:63,15:[1,20],18:[1,62]},{15:[2,48],18:[2,48]},{33:[2,86],57:64,65:[2,86],72:[2,86],80:[2,86],81:[2,86],82:[2,86],83:[2,86],84:[2,86],85:[2,86]},{33:[2,40],65:[2,40],72:[2,40],80:[2,40],81:[2,40],82:[2,40],83:[2,40],84:[2,40],85:[2,40]},{33:[2,41],65:[2,41],72:[2,41],80:[2,41],81:[2,41],82:[2,41],83:[2,41],84:[2,41],85:[2,41]},{20:65,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:66,47:[1,67]},{30:68,33:[2,58],65:[2,58],72:[2,58],75:[2,58],80:[2,58],81:[2,58],82:[2,58],83:[2,58],84:[2,58],85:[2,58]},{33:[2,64],35:69,65:[2,64],72:[2,64],75:[2,64],80:[2,64],81:[2,64],82:[2,64],83:[2,64],84:[2,64],85:[2,64]},{21:70,23:[2,50],65:[2,50],72:[2,50],80:[2,50],81:[2,50],82:[2,50],83:[2,50],84:[2,50],85:[2,50]},{33:[2,90],61:71,65:[2,90],72:[2,90],80:[2,90],81:[2,90],82:[2,90],83:[2,90],84:[2,90],85:[2,90]},{20:75,33:[2,80],50:72,63:73,64:76,65:[1,44],69:74,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{72:[1,80]},{23:[2,42],33:[2,42],54:[2,42],65:[2,42],68:[2,42],72:[2,42],75:[2,42],80:[2,42],81:[2,42],82:[2,42],83:[2,42],84:[2,42],85:[2,42],87:[1,51]},{20:75,53:81,54:[2,84],63:82,64:76,65:[1,44],69:83,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:84,47:[1,67]},{47:[2,55]},{4:85,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{47:[2,20]},{20:86,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:87,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{26:88,47:[1,67]},{47:[2,57]},{5:[2,11],14:[2,11],15:[2,11],19:[2,11],29:[2,11],34:[2,11],39:[2,11],44:[2,11],47:[2,11],48:[2,11],51:[2,11],55:[2,11],60:[2,11]},{15:[2,49],18:[2,49]},{20:75,33:[2,88],58:89,63:90,64:76,65:[1,44],69:91,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{65:[2,94],66:92,68:[2,94],72:[2,94],80:[2,94],81:[2,94],82:[2,94],83:[2,94],84:[2,94],85:[2,94]},{5:[2,25],14:[2,25],15:[2,25],19:[2,25],29:[2,25],34:[2,25],39:[2,25],44:[2,25],47:[2,25],48:[2,25],51:[2,25],55:[2,25],60:[2,25]},{20:93,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,31:94,33:[2,60],63:95,64:76,65:[1,44],69:96,70:77,71:78,72:[1,79],75:[2,60],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,33:[2,66],36:97,63:98,64:76,65:[1,44],69:99,70:77,71:78,72:[1,79],75:[2,66],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,22:100,23:[2,52],63:101,64:76,65:[1,44],69:102,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:75,33:[2,92],62:103,63:104,64:76,65:[1,44],69:105,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,106]},{33:[2,79],65:[2,79],72:[2,79],80:[2,79],81:[2,79],82:[2,79],83:[2,79],84:[2,79],85:[2,79]},{33:[2,81]},{23:[2,27],33:[2,27],54:[2,27],65:[2,27],68:[2,27],72:[2,27],75:[2,27],80:[2,27],81:[2,27],82:[2,27],83:[2,27],84:[2,27],85:[2,27]},{23:[2,28],33:[2,28],54:[2,28],65:[2,28],68:[2,28],72:[2,28],75:[2,28],80:[2,28],81:[2,28],82:[2,28],83:[2,28],84:[2,28],85:[2,28]},{23:[2,30],33:[2,30],54:[2,30],68:[2,30],71:107,72:[1,108],75:[2,30]},{23:[2,98],33:[2,98],54:[2,98],68:[2,98],72:[2,98],75:[2,98]},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],73:[1,109],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{23:[2,44],33:[2,44],54:[2,44],65:[2,44],68:[2,44],72:[2,44],75:[2,44],80:[2,44],81:[2,44],82:[2,44],83:[2,44],84:[2,44],85:[2,44],87:[2,44]},{54:[1,110]},{54:[2,83],65:[2,83],72:[2,83],80:[2,83],81:[2,83],82:[2,83],83:[2,83],84:[2,83],85:[2,83]},{54:[2,85]},{5:[2,13],14:[2,13],15:[2,13],19:[2,13],29:[2,13],34:[2,13],39:[2,13],44:[2,13],47:[2,13],48:[2,13],51:[2,13],55:[2,13],60:[2,13]},{38:56,39:[1,58],43:57,44:[1,59],45:112,46:111,47:[2,76]},{33:[2,70],40:113,65:[2,70],72:[2,70],75:[2,70],80:[2,70],81:[2,70],82:[2,70],83:[2,70],84:[2,70],85:[2,70]},{47:[2,18]},{5:[2,14],14:[2,14],15:[2,14],19:[2,14],29:[2,14],34:[2,14],39:[2,14],44:[2,14],47:[2,14],48:[2,14],51:[2,14],55:[2,14],60:[2,14]},{33:[1,114]},{33:[2,87],65:[2,87],72:[2,87],80:[2,87],81:[2,87],82:[2,87],83:[2,87],84:[2,87],85:[2,87]},{33:[2,89]},{20:75,63:116,64:76,65:[1,44],67:115,68:[2,96],69:117,70:77,71:78,72:[1,79],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,118]},{32:119,33:[2,62],74:120,75:[1,121]},{33:[2,59],65:[2,59],72:[2,59],75:[2,59],80:[2,59],81:[2,59],82:[2,59],83:[2,59],84:[2,59],85:[2,59]},{33:[2,61],75:[2,61]},{33:[2,68],37:122,74:123,75:[1,121]},{33:[2,65],65:[2,65],72:[2,65],75:[2,65],80:[2,65],81:[2,65],82:[2,65],83:[2,65],84:[2,65],85:[2,65]},{33:[2,67],75:[2,67]},{23:[1,124]},{23:[2,51],65:[2,51],72:[2,51],80:[2,51],81:[2,51],82:[2,51],83:[2,51],84:[2,51],85:[2,51]},{23:[2,53]},{33:[1,125]},{33:[2,91],65:[2,91],72:[2,91],80:[2,91],81:[2,91],82:[2,91],83:[2,91],84:[2,91],85:[2,91]},{33:[2,93]},{5:[2,22],14:[2,22],15:[2,22],19:[2,22],29:[2,22],34:[2,22],39:[2,22],44:[2,22],47:[2,22],48:[2,22],51:[2,22],55:[2,22],60:[2,22]},{23:[2,99],33:[2,99],54:[2,99],68:[2,99],72:[2,99],75:[2,99]},{73:[1,109]},{20:75,63:126,64:76,65:[1,44],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,23],14:[2,23],15:[2,23],19:[2,23],29:[2,23],34:[2,23],39:[2,23],44:[2,23],47:[2,23],48:[2,23],51:[2,23],55:[2,23],60:[2,23]},{47:[2,19]},{47:[2,77]},{20:75,33:[2,72],41:127,63:128,64:76,65:[1,44],69:129,70:77,71:78,72:[1,79],75:[2,72],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,24],14:[2,24],15:[2,24],19:[2,24],29:[2,24],34:[2,24],39:[2,24],44:[2,24],47:[2,24],48:[2,24],51:[2,24],55:[2,24],60:[2,24]},{68:[1,130]},{65:[2,95],68:[2,95],72:[2,95],80:[2,95],81:[2,95],82:[2,95],83:[2,95],84:[2,95],85:[2,95]},{68:[2,97]},{5:[2,21],14:[2,21],15:[2,21],19:[2,21],29:[2,21],34:[2,21],39:[2,21],44:[2,21],47:[2,21],48:[2,21],51:[2,21],55:[2,21],60:[2,21]},{33:[1,131]},{33:[2,63]},{72:[1,133],76:132},{33:[1,134]},{33:[2,69]},{15:[2,12]},{14:[2,26],15:[2,26],19:[2,26],29:[2,26],34:[2,26],47:[2,26],48:[2,26],51:[2,26],55:[2,26],60:[2,26]},{23:[2,31],33:[2,31],54:[2,31],68:[2,31],72:[2,31],75:[2,31]},{33:[2,74],42:135,74:136,75:[1,121]},{33:[2,71],65:[2,71],72:[2,71],75:[2,71],80:[2,71],81:[2,71],82:[2,71],83:[2,71],84:[2,71],85:[2,71]},{33:[2,73],75:[2,73]},{23:[2,29],33:[2,29],54:[2,29],65:[2,29],68:[2,29],72:[2,29],75:[2,29],80:[2,29],81:[2,29],82:[2,29],83:[2,29],84:[2,29],85:[2,29]},{14:[2,15],15:[2,15],19:[2,15],29:[2,15],34:[2,15],39:[2,15],44:[2,15],47:[2,15],48:[2,15],51:[2,15],55:[2,15],60:[2,15]},{72:[1,138],77:[1,137]},{72:[2,100],77:[2,100]},{14:[2,16],15:[2,16],19:[2,16],29:[2,16],34:[2,16],44:[2,16],47:[2,16],48:[2,16],51:[2,16],55:[2,16],60:[2,16]},{33:[1,139]},{33:[2,75]},{33:[2,32]},{72:[2,101],77:[2,101]},{14:[2,17],15:[2,17],19:[2,17],29:[2,17],34:[2,17],39:[2,17],44:[2,17],47:[2,17],48:[2,17],51:[2,17],55:[2,17],60:[2,17]}],defaultActions:{4:[2,1],55:[2,55],57:[2,20],61:[2,57],74:[2,81],83:[2,85],87:[2,18],91:[2,89],102:[2,53],105:[2,93],111:[2,19],112:[2,77],117:[2,97],120:[2,63],123:[2,69],124:[2,12],136:[2,75],137:[2,32]},parseError:function(n){throw new Error(n);},parse:function(n){function it(){var n;return n=k.lexer.lex()||1,typeof n!="number"&&(n=k.symbols_[n]||n),n}var k=this,r=[0],f=[null],t=[],h=this.table,d="",c=0,g=0,y=0,l,nt,i,p,o,u,w,s,a,e,tt,v,b;for(this.lexer.setInput(n),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,this.yy.parser=this,typeof this.lexer.yylloc=="undefined"&&(this.lexer.yylloc={}),l=this.lexer.yylloc,t.push(l),nt=this.lexer.options&&this.lexer.options.ranges,typeof this.yy.parseError=="function"&&(this.parseError=this.yy.parseError),s={};;){if(o=r[r.length-1],this.defaultActions[o]?u=this.defaultActions[o]:((i===null||typeof i=="undefined")&&(i=it()),u=h[o]&&h[o][i]),(typeof u=="undefined"||!u.length||!u[0])&&(b="",!y)){v=[];for(a in h[o])this.terminals_[a]&&a>2&&v.push("'"+this.terminals_[a]+"'");b=this.lexer.showPosition?"Parse error on line "+(c+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+v.join(", ")+", got '"+(this.terminals_[i]||i)+"'":"Parse error on line "+(c+1)+": Unexpected "+(i==1?"end of input":"'"+(this.terminals_[i]||i)+"'");this.parseError(b,{text:this.lexer.match,token:this.terminals_[i]||i,line:this.lexer.yylineno,loc:l,expected:v})}if(u[0]instanceof Array&&u.length>1)throw new Error("Parse Error: multiple actions possible at state: "+o+", token: "+i);switch(u[0]){case 1:r.push(i);f.push(this.lexer.yytext);t.push(this.lexer.yylloc);r.push(u[1]);i=null;p?(i=p,p=null):(g=this.lexer.yyleng,d=this.lexer.yytext,c=this.lexer.yylineno,l=this.lexer.yylloc,y>0&&y--);break;case 2:if(e=this.productions_[u[1]][1],s.$=f[f.length-e],s._$={first_line:t[t.length-(e||1)].first_line,last_line:t[t.length-1].last_line,first_column:t[t.length-(e||1)].first_column,last_column:t[t.length-1].last_column},nt&&(s._$.range=[t[t.length-(e||1)].range[0],t[t.length-1].range[1]]),w=this.performAction.call(s,d,g,c,this.yy,u[1],f,t),typeof w!="undefined")return w;e&&(r=r.slice(0,-2*e),f=f.slice(0,-1*e),t=t.slice(0,-1*e));r.push(this.productions_[u[1]][0]);f.push(s.$);t.push(s._$);tt=h[r[r.length-2]][r[r.length-1]];r.push(tt);break;case 3:return!0}}return!0}},i=function(){var n={EOF:1,parseError:function(n,t){if(this.yy.parser)this.yy.parser.parseError(n,t);else throw new Error(n);},setInput:function(n){return this._input=n,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var n=this._input[0],t;return this.yytext+=n,this.yyleng++,this.offset++,this.match+=n,this.matched+=n,t=n.match(/(?:\r\n?|\n).*/g),t?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),n},unput:function(n){var i=n.length,t=n.split(/(?:\r\n?|\n)/g),r,u;return this._input=n+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-i-1),this.offset-=i,r=this.match.split(/(?:\r\n?|\n)/g),this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),t.length-1&&(this.yylineno-=t.length-1),u=this.yylloc.range,this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:t?(t.length===r.length?this.yylloc.first_column:0)+r[r.length-t.length].length-t[0].length:this.yylloc.first_column-i},this.options.ranges&&(this.yylloc.range=[u[0],u[0]+this.yyleng-i]),this},more:function(){return this._more=!0,this},less:function(n){this.unput(this.match.slice(n))},pastInput:function(){var n=this.matched.substr(0,this.matched.length-this.match.length);return(n.length>20?"...":"")+n.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var n=this.match;return n.length<20&&(n+=this._input.substr(0,20-n.length)),(n.substr(0,20)+(n.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var n=this.pastInput(),t=new Array(n.length+1).join("-");return n+this.upcomingInput()+"\n"+t+"^"},next:function(){var f,n,r,e,t,u,i;if(this.done)return this.EOF;for(this._input||(this.done=!0),this._more||(this.yytext="",this.match=""),u=this._currentRules(),i=0;i<u.length;i++)if(r=this._input.match(this.rules[u[i]]),r&&(!n||r[0].length>n[0].length)&&(n=r,e=i,!this.options.flex))break;return n?(t=n[0].match(/(?:\r\n?|\n).*/g),t&&(this.yylineno+=t.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:t?t[t.length-1].length-t[t.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+n[0].length},this.yytext+=n[0],this.match+=n[0],this.matches=n,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._input=this._input.slice(n[0].length),this.matched+=n[0],f=this.performAction.call(this,this.yy,this,u[e],this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),f)?f:void 0:this._input===""?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var n=this.next();return typeof n!="undefined"?n:this.lex()},begin:function(n){this.conditionStack.push(n)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules},topState:function(){return this.conditionStack[this.conditionStack.length-2]},pushState:function(n){this.begin(n)}};return n.options={},n.performAction=function(n,t,i,r){function u(n,i){return t.yytext=t.yytext.substr(n,t.yyleng-i)}var f=r;switch(i){case 0:if(t.yytext.slice(-2)==="\\\\"?(u(0,1),this.begin("mu")):t.yytext.slice(-1)==="\\"?(u(0,1),this.begin("emu")):this.begin("mu"),t.yytext)return 15;break;case 1:return 15;case 2:return this.popState(),15;case 3:return this.begin("raw"),15;case 4:return this.popState(),this.conditionStack[this.conditionStack.length-1]==="raw"?15:(t.yytext=t.yytext.substr(5,t.yyleng-9),"END_RAW_BLOCK");case 5:return 15;case 6:return this.popState(),14;case 7:return 65;case 8:return 68;case 9:return 19;case 10:return this.popState(),this.begin("raw"),23;case 11:return 55;case 12:return 60;case 13:return 29;case 14:return 47;case 15:return this.popState(),44;case 16:return this.popState(),44;case 17:return 34;case 18:return 39;case 19:return 51;case 20:return 48;case 21:this.unput(t.yytext);this.popState();this.begin("com");break;case 22:return this.popState(),14;case 23:return 48;case 24:return 73;case 25:return 72;case 26:return 72;case 27:return 87;case 29:return this.popState(),54;case 30:return this.popState(),33;case 31:return t.yytext=u(1,2).replace(/\\"/g,'"'),80;case 32:return t.yytext=u(1,2).replace(/\\'/g,"'"),80;case 33:return 85;case 34:return 82;case 35:return 82;case 36:return 83;case 37:return 84;case 38:return 81;case 39:return 75;case 40:return 77;case 41:return 72;case 42:return t.yytext=t.yytext.replace(/\\([\\\]])/g,"$1"),72;case 43:return"INVALID";case 44:return 5}},n.rules=[/^(?:[^\x00]*?(?=(\{\{)))/,/^(?:[^\x00]+)/,/^(?:[^\x00]{2,}?(?=(\{\{|\\\{\{|\\\\\{\{|$)))/,/^(?:\{\{\{\{(?=[^/]))/,/^(?:\{\{\{\{\/[^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=[=}\s\/.])\}\}\}\})/,/^(?:[^\x00]*?(?=(\{\{\{\{)))/,/^(?:[\s\S]*?--(~)?\}\})/,/^(?:\()/,/^(?:\))/,/^(?:\{\{\{\{)/,/^(?:\}\}\}\})/,/^(?:\{\{(~)?>)/,/^(?:\{\{(~)?#>)/,/^(?:\{\{(~)?#\*?)/,/^(?:\{\{(~)?\/)/,/^(?:\{\{(~)?\^\s*(~)?\}\})/,/^(?:\{\{(~)?\s*else\s*(~)?\}\})/,/^(?:\{\{(~)?\^)/,/^(?:\{\{(~)?\s*else\b)/,/^(?:\{\{(~)?\{)/,/^(?:\{\{(~)?&)/,/^(?:\{\{(~)?!--)/,/^(?:\{\{(~)?![\s\S]*?\}\})/,/^(?:\{\{(~)?\*?)/,/^(?:=)/,/^(?:\.\.)/,/^(?:\.(?=([=~}\s\/.)|])))/,/^(?:[\/.])/,/^(?:\s+)/,/^(?:\}(~)?\}\})/,/^(?:(~)?\}\})/,/^(?:"(\\["]|[^"])*")/,/^(?:'(\\[']|[^'])*')/,/^(?:@)/,/^(?:true(?=([~}\s)])))/,/^(?:false(?=([~}\s)])))/,/^(?:undefined(?=([~}\s)])))/,/^(?:null(?=([~}\s)])))/,/^(?:-?[0-9]+(?:\.[0-9]+)?(?=([~}\s)])))/,/^(?:as\s+\|)/,/^(?:\|)/,/^(?:([^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=([=~}\s\/.)|]))))/,/^(?:\[(\\\]|[^\]])*\])/,/^(?:.)/,/^(?:$)/],n.conditions={mu:{rules:[7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44],inclusive:!1},emu:{rules:[2],inclusive:!1},com:{rules:[6],inclusive:!1},raw:{rules:[3,4,5],inclusive:!1},INITIAL:{rules:[0,1,44],inclusive:!0}},n}();return n.lexer=i,t.prototype=n,n.Parser=t,new t}();t.__esModule=!0;t["default"]=i},function(n,t,i){"use strict";function r(){var n=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];this.options=n}function e(n,t,i){t===undefined&&(t=n.length);var r=n[t-1],u=n[t-2];return r?r.type==="ContentStatement"?(u||!i?/\r?\n\s*?$/:/(^|\r?\n)\s*?$/).test(r.original):void 0:i}function o(n,t,i){t===undefined&&(t=-1);var r=n[t+1],u=n[t+2];return r?r.type==="ContentStatement"?(u||!i?/^\s*?\r?\n/:/^\s*?(\r?\n|$)/).test(r.original):void 0:i}function f(n,t,i){var r=n[t==null?0:t+1],u;r&&r.type==="ContentStatement"&&(i||!r.rightStripped)&&(u=r.value,r.value=r.value.replace(i?/^\s+/:/^[ \t]*\r?\n?/,""),r.rightStripped=r.value!==u)}function u(n,t,i){var r=n[t==null?n.length-1:t-1],u;if(r&&r.type==="ContentStatement"&&(i||!r.leftStripped))return u=r.value,r.value=r.value.replace(i?/\s+$/:/[ \t]+$/,""),r.leftStripped=r.value!==u,r.leftStripped}var c=i(1)["default"],s,h;t.__esModule=!0;s=i(25);h=c(s);r.prototype=new h["default"];r.prototype.Program=function(n){var h=!this.options.ignoreStandalone,c=!this.isRootSeen,i,t,l,r,s;for(this.isRootSeen=!0,i=n.body,t=0,l=i.length;t<l;t++)if(r=i[t],s=this.accept(r),s){var a=e(i,t,c),v=o(i,t,c),y=s.openStandalone&&a,p=s.closeStandalone&&v,w=s.inlineStandalone&&a&&v;s.close&&f(i,t,!0);s.open&&u(i,t,!0);h&&w&&(f(i,t),u(i,t)&&r.type==="PartialStatement"&&(r.indent=/([ \t]+$)/.exec(i[t-1].original)[1]));h&&y&&(f((r.program||r.inverse).body),u(i,t));h&&p&&(f(i,t),u((r.inverse||r.program).body))}return n};r.prototype.BlockStatement=r.prototype.DecoratorBlock=r.prototype.PartialBlockStatement=function(n){var c,h;this.accept(n.program);this.accept(n.inverse);var t=n.program||n.inverse,i=n.program&&n.inverse,r=i,s=i;if(i&&i.chained)for(r=i.body[0].program;s.chained;)s=s.body[s.body.length-1].program;return c={open:n.openStrip.open,close:n.closeStrip.close,openStandalone:o(t.body),closeStandalone:e((r||t).body)},n.openStrip.close&&f(t.body,null,!0),i?(h=n.inverseStrip,h.open&&u(t.body,null,!0),h.close&&f(r.body,null,!0),n.closeStrip.open&&u(s.body,null,!0),!this.options.ignoreStandalone&&e(t.body)&&o(r.body)&&(u(t.body),f(r.body))):n.closeStrip.open&&u(t.body,null,!0),c};r.prototype.Decorator=r.prototype.MustacheStatement=function(n){return n.strip};r.prototype.PartialStatement=r.prototype.CommentStatement=function(n){var t=n.strip||{};return{inlineStandalone:!0,open:t.open,close:t.close}};t["default"]=r;n.exports=t["default"]},function(n,t,i){"use strict";function u(){this.parents=[]}function f(n){this.acceptRequired(n,"path");this.acceptArray(n.params);this.acceptKey(n,"hash")}function o(n){f.call(this,n);this.acceptKey(n,"program");this.acceptKey(n,"inverse")}function s(n){this.acceptRequired(n,"name");this.acceptArray(n.params);this.acceptKey(n,"hash")}var h=i(1)["default"],e,r;t.__esModule=!0;e=i(6);r=h(e);u.prototype={constructor:u,mutating:!1,acceptKey:function(n,t){var i=this.accept(n[t]);if(this.mutating){if(i&&!u.prototype[i.type])throw new r["default"]('Unexpected node type "'+i.type+'" found when accepting '+t+" on "+n.type);n[t]=i}},acceptRequired:function(n,t){if(this.acceptKey(n,t),!n[t])throw new r["default"](n.type+" requires "+t);},acceptArray:function(n){for(var t=0,i=n.length;t<i;t++)this.acceptKey(n,t),n[t]||(n.splice(t,1),t--,i--)},accept:function(n){if(n){if(!this[n.type])throw new r["default"]("Unknown type: "+n.type,n);this.current&&this.parents.unshift(this.current);this.current=n;var t=this[n.type](n);return(this.current=this.parents.shift(),!this.mutating||t)?t:t!==!1?n:void 0}},Program:function(n){this.acceptArray(n.body)},MustacheStatement:f,Decorator:f,BlockStatement:o,DecoratorBlock:o,PartialStatement:s,PartialBlockStatement:function(n){s.call(this,n);this.acceptKey(n,"program")},ContentStatement:function(){},CommentStatement:function(){},SubExpression:f,PathExpression:function(){},StringLiteral:function(){},NumberLiteral:function(){},BooleanLiteral:function(){},UndefinedLiteral:function(){},NullLiteral:function(){},Hash:function(n){this.acceptArray(n.pairs)},HashPair:function(n){this.acceptRequired(n,"value")}};t["default"]=u;n.exports=t["default"]},function(n,t,i){"use strict";function u(n,t){if(t=t.path?t.path.original:t,n.path.original!==t){var i={loc:n.path.loc};throw new r["default"](n.path.original+" doesn't match "+t,i);}}function o(n,t){this.source=n;this.start={line:t.first_line,column:t.first_column};this.end={line:t.last_line,column:t.last_column}}function s(n){return/^\[.*\]$/.test(n)?n.substr(1,n.length-2):n}function h(n,t){return{open:n.charAt(2)==="~",close:t.charAt(t.length-3)==="~"}}function c(n){return n.replace(/^\{\{~?\!-?-?/,"").replace(/-?-?~?\}\}$/,"")}function l(n,t,i){var f,h,u,c;i=this.locInfo(i);var e=n?"@":"",o=[],s=0,l="";for(f=0,h=t.length;f<h;f++)if(u=t[f].part,c=t[f].original!==u,e+=(t[f].separator||"")+u,c||u!==".."&&u!=="."&&u!=="this")o.push(u);else if(o.length>0)throw new r["default"]("Invalid path: "+e,{loc:i});else u===".."&&(s++,l+="../");return{type:"PathExpression",data:n,depth:s,parts:o,original:e,loc:i}}function a(n,t,i,r,u,f){var e=r.charAt(3)||r.charAt(2),o=e!=="{"&&e!=="&",s=/\*/.test(r);return{type:s?"Decorator":"MustacheStatement",path:n,params:t,hash:i,escaped:o,strip:u,loc:this.locInfo(f)}}function v(n,t,i,r){u(n,i);r=this.locInfo(r);var f={type:"Program",body:t,strip:{},loc:r};return{type:"BlockStatement",path:n.path,params:n.params,hash:n.hash,program:f,openStrip:{},inverseStrip:{},closeStrip:{},loc:r}}function y(n,t,i,f,e,o){var h,s,c;if(f&&f.path&&u(n,f),h=/\*/.test(n.open),t.blockParams=n.blockParams,s=undefined,c=undefined,i){if(h)throw new r["default"]("Unexpected inverse block on decorator",i);i.chain&&(i.program.body[0].closeStrip=f.strip);c=i.strip;s=i.program}return e&&(e=s,s=t,t=e),{type:h?"DecoratorBlock":"BlockStatement",path:n.path,params:n.params,hash:n.hash,program:t,inverse:s,openStrip:n.strip,inverseStrip:c,closeStrip:f&&f.strip,loc:this.locInfo(o)}}function p(n,t){if(!t&&n.length){var i=n[0].loc,r=n[n.length-1].loc;i&&r&&(t={source:i.source,start:{line:i.start.line,column:i.start.column},end:{line:r.end.line,column:r.end.column}})}return{type:"Program",body:n,strip:{},loc:t}}function w(n,t,i,r){return u(n,i),{type:"PartialBlockStatement",name:n.path,params:n.params,hash:n.hash,program:t,openStrip:n.strip,closeStrip:i&&i.strip,loc:this.locInfo(r)}}var e=i(1)["default"],f,r;t.__esModule=!0;t.SourceLocation=o;t.id=s;t.stripFlags=h;t.stripComment=c;t.preparePath=l;t.prepareMustache=a;t.prepareRawBlock=v;t.prepareBlock=y;t.prepareProgram=p;t.preparePartialBlock=w;f=i(6);r=e(f)},function(n,t,i){"use strict";function e(){}function v(n,t,i){if(n==null||typeof n!="string"&&n.type!=="Program")throw new r["default"]("You must pass a string or Handlebars AST to Handlebars.precompile. You passed "+n);t=t||{};"data"in t||(t.data=!0);t.compat&&(t.useDepths=!0);var u=i.parse(n,t),f=(new i.Compiler).compile(u,t);return(new i.JavaScriptCompiler).compile(f,t)}function y(n,t,i){function f(){var r=i.parse(n,t),u=(new i.Compiler).compile(r,t),f=(new i.JavaScriptCompiler).compile(u,t,undefined,!0);return i.template(f)}function e(n,t){return u||(u=f()),u.call(this,n,t)}if(t===undefined&&(t={}),n==null||typeof n!="string"&&n.type!=="Program")throw new r["default"]("You must pass a string or Handlebars AST to Handlebars.compile. You passed "+n);"data"in t||(t.data=!0);t.compat&&(t.useDepths=!0);var u=undefined;return e._setup=function(n){return u||(u=f()),u._setup(n)},e._child=function(n,t,i,r){return u||(u=f()),u._child(n,t,i,r)},e}function s(n,t){if(n===t)return!0;if(f.isArray(n)&&f.isArray(t)&&n.length===t.length){for(var i=0;i<n.length;i++)if(!s(n[i],t[i]))return!1;return!0}}function h(n){if(!n.path.parts){var t=n.path;n.path={type:"PathExpression",data:!1,depth:0,parts:[t.original+""],original:t.original+"",loc:t.loc}}}var o=i(1)["default"];t.__esModule=!0;t.Compiler=e;t.precompile=v;t.compile=y;var c=i(6),r=o(c),f=i(5),l=i(21),u=o(l),a=[].slice;e.prototype={compiler:e,equals:function(n){var i=this.opcodes.length,r,u,t;if(n.opcodes.length!==i)return!1;for(t=0;t<i;t++)if(r=this.opcodes[t],u=n.opcodes[t],r.opcode!==u.opcode||!s(r.args,u.args))return!1;for(i=this.children.length,t=0;t<i;t++)if(!this.children[t].equals(n.children[t]))return!1;return!0},guid:0,compile:function(n,t){var i,r;if(this.sourceNode=[],this.opcodes=[],this.children=[],this.options=t,this.stringParams=t.stringParams,this.trackIds=t.trackIds,t.blockParams=t.blockParams||[],i=t.knownHelpers,t.knownHelpers={helperMissing:!0,blockHelperMissing:!0,each:!0,"if":!0,unless:!0,"with":!0,log:!0,lookup:!0},i)for(r in i)r in i&&(t.knownHelpers[r]=i[r]);return this.accept(n)},compileProgram:function(n){var r=new this.compiler,t=r.compile(n,this.options),i=this.guid++;return this.usePartial=this.usePartial||t.usePartial,this.children[i]=t,this.useDepths=this.useDepths||t.useDepths,i},accept:function(n){if(!this[n.type])throw new r["default"]("Unknown type: "+n.type,n);this.sourceNode.unshift(n);var t=this[n.type](n);return this.sourceNode.shift(),t},Program:function(n){var i,r,t;for(this.options.blockParams.unshift(n.blockParams),i=n.body,r=i.length,t=0;t<r;t++)this.accept(i[t]);return this.options.blockParams.shift(),this.isSimple=r===1,this.blockParams=n.blockParams?n.blockParams.length:0,this},BlockStatement:function(n){var t,i,r;h(n);t=n.program;i=n.inverse;t=t&&this.compileProgram(t);i=i&&this.compileProgram(i);r=this.classifySexpr(n);r==="helper"?this.helperSexpr(n,t,i):r==="simple"?(this.simpleSexpr(n),this.opcode("pushProgram",t),this.opcode("pushProgram",i),this.opcode("emptyHash"),this.opcode("blockValue",n.path.original)):(this.ambiguousSexpr(n,t,i),this.opcode("pushProgram",t),this.opcode("pushProgram",i),this.opcode("emptyHash"),this.opcode("ambiguousBlockValue"));this.opcode("append")},DecoratorBlock:function(n){var t=n.program&&this.compileProgram(n.program),i=this.setupFullMustacheParams(n,t,undefined),r=n.path;this.useDecorators=!0;this.opcode("registerDecorator",i.length,r.original)},PartialStatement:function(n){var u,t,e,f,i;if(this.usePartial=!0,u=n.program,u&&(u=this.compileProgram(n.program)),t=n.params,t.length>1)throw new r["default"]("Unsupported number of partial arguments: "+t.length,n);else t.length||(this.options.explicitPartialContext?this.opcode("pushLiteral","undefined"):t.push({type:"PathExpression",parts:[],depth:0}));e=n.name.original;f=n.name.type==="SubExpression";f&&this.accept(n.name);this.setupFullMustacheParams(n,u,undefined,!0);i=n.indent||"";this.options.preventIndent&&i&&(this.opcode("appendContent",i),i="");this.opcode("invokePartial",f,e,i);this.opcode("append")},PartialBlockStatement:function(n){this.PartialStatement(n)},MustacheStatement:function(n){this.SubExpression(n);n.escaped&&!this.options.noEscape?this.opcode("appendEscaped"):this.opcode("append")},Decorator:function(n){this.DecoratorBlock(n)},ContentStatement:function(n){n.value&&this.opcode("appendContent",n.value)},CommentStatement:function(){},SubExpression:function(n){h(n);var t=this.classifySexpr(n);t==="simple"?this.simpleSexpr(n):t==="helper"?this.helperSexpr(n):this.ambiguousSexpr(n)},ambiguousSexpr:function(n,t,i){var r=n.path,u=r.parts[0],f=t!=null||i!=null;this.opcode("getContext",r.depth);this.opcode("pushProgram",t);this.opcode("pushProgram",i);r.strict=!0;this.accept(r);this.opcode("invokeAmbiguous",u,f)},simpleSexpr:function(n){var t=n.path;t.strict=!0;this.accept(t);this.opcode("resolvePossibleLambda")},helperSexpr:function(n,t,i){var o=this.setupFullMustacheParams(n,t,i),f=n.path,e=f.parts[0];if(this.options.knownHelpers[e])this.opcode("invokeKnownHelper",o.length,e);else if(this.options.knownHelpersOnly)throw new r["default"]("You specified knownHelpersOnly, but used the unknown helper "+e,n);else f.strict=!0,f.falsy=!0,this.accept(f),this.opcode("invokeHelper",o.length,f.original,u["default"].helpers.simpleId(f))},PathExpression:function(n){this.addDepth(n.depth);this.opcode("getContext",n.depth);var t=n.parts[0],i=u["default"].helpers.scopedId(n),r=!n.depth&&!i&&this.blockParamIndex(t);r?this.opcode("lookupBlockParam",r,n.parts):t?n.data?(this.options.data=!0,this.opcode("lookupData",n.depth,n.parts,n.strict)):this.opcode("lookupOnContext",n.parts,n.falsy,n.strict,i):this.opcode("pushContext")},StringLiteral:function(n){this.opcode("pushString",n.value)},NumberLiteral:function(n){this.opcode("pushLiteral",n.value)},BooleanLiteral:function(n){this.opcode("pushLiteral",n.value)},UndefinedLiteral:function(){this.opcode("pushLiteral","undefined")},NullLiteral:function(){this.opcode("pushLiteral","null")},Hash:function(n){var i=n.pairs,t=0,r=i.length;for(this.opcode("pushHash");t<r;t++)this.pushParam(i[t].value);while(t--)this.opcode("assignToHash",i[t].key);this.opcode("popHash")},opcode:function(n){this.opcodes.push({opcode:n,args:a.call(arguments,1),loc:this.sourceNode[0].loc})},addDepth:function(n){n&&(this.useDepths=!0)},classifySexpr:function(n){var f=u["default"].helpers.simpleId(n.path),e=f&&!!this.blockParamIndex(n.path.parts[0]),t=!e&&u["default"].helpers.helperExpression(n),i=!e&&(t||f),o,r;return i&&!t&&(o=n.path.parts[0],r=this.options,r.knownHelpers[o]?t=!0:r.knownHelpersOnly&&(i=!1)),t?"helper":i?"ambiguous":"simple"},pushParams:function(n){for(var t=0,i=n.length;t<i;t++)this.pushParam(n[t])},pushParam:function(n){var t=n.value!=null?n.value:n.original||"",i,r;this.stringParams?(t.replace&&(t=t.replace(/^(\.?\.\/)*/g,"").replace(/\//g,".")),n.depth&&this.addDepth(n.depth),this.opcode("getContext",n.depth||0),this.opcode("pushStringParam",t,n.type),n.type==="SubExpression"&&this.accept(n)):(this.trackIds&&(i=undefined,!n.parts||u["default"].helpers.scopedId(n)||n.depth||(i=this.blockParamIndex(n.parts[0])),i?(r=n.parts.slice(1).join("."),this.opcode("pushId","BlockParam",i,r)):(t=n.original||t,t.replace&&(t=t.replace(/^this(?:\.|$)/,"").replace(/^\.\//,"").replace(/^\.$/,"")),this.opcode("pushId",n.type,t))),this.accept(n))},setupFullMustacheParams:function(n,t,i,r){var u=n.params;return this.pushParams(u),this.opcode("pushProgram",t),this.opcode("pushProgram",i),n.hash?this.accept(n.hash):this.opcode("emptyHash",r),u},blockParamIndex:function(n){for(var i,r,t=0,u=this.options.blockParams.length;t<u;t++)if(i=this.options.blockParams[t],r=i&&f.indexOf(i,n),i&&r>=0)return[t,r]}}},function(n,t,i){"use strict";function u(n){this.value=n}function r(){}function a(n,t,i,r){var u=t.popStack(),f=0,e=i.length;for(n&&e--;f<e;f++)u=t.nameLookup(u,i[f],r);return n?[t.aliasable("container.strict"),"(",u,", ",t.quotedString(i[f]),")"]:u}var e=i(1)["default"];t.__esModule=!0;var o=i(4),h=i(6),f=e(h),c=i(5),l=i(29),s=e(l);r.prototype={nameLookup:function(n,t){return r.isValidJavaScriptVariableName(t)?[n,".",t]:[n,"[",JSON.stringify(t),"]"]},depthedLookup:function(n){return[this.aliasable("container.lookup"),'(depths, "',n,'")']},compilerInfo:function(){var n=o.COMPILER_REVISION,t=o.REVISION_CHANGES[n];return[n,t]},appendToBuffer:function(n,t,i){return c.isArray(n)||(n=[n]),n=this.source.wrap(n,t),this.environment.isSimple?["return ",n,";"]:i?["buffer += ",n,";"]:(n.appendToBuffer=!0,n)},initializeBuffer:function(){return this.quotedString("")},compile:function(n,t,i,r){var c,u;this.environment=n;this.options=t;this.stringParams=this.options.stringParams;this.trackIds=this.options.trackIds;this.precompile=!r;this.name=this.environment.name;this.isChild=!!i;this.context=i||{decorators:[],programs:[],environments:[]};this.preamble();this.stackSlot=0;this.stackVars=[];this.aliases={};this.registers={list:[]};this.hashes=[];this.compileStack=[];this.inlineStack=[];this.blockParams=[];this.compileChildren(n,t);this.useDepths=this.useDepths||n.useDepths||n.useDecorators||this.options.compat;this.useBlockParams=this.useBlockParams||n.useBlockParams;for(var a=n.opcodes,o=undefined,h=undefined,e=undefined,s=undefined,e=0,s=a.length;e<s;e++)o=a[e],this.source.currentLocation=o.loc,h=h||o.loc,this[o.opcode].apply(this,o.args);if(this.source.currentLocation=h,this.pushSource(""),this.stackSlot||this.inlineStack.length||this.compileStack.length)throw new f["default"]("Compile completed with content left on stack");if(this.decorators.isEmpty()?this.decorators=undefined:(this.useDecorators=!0,this.decorators.prepend("var decorators = container.decorators;\n"),this.decorators.push("return fn;"),r?this.decorators=Function.apply(this,["fn","props","container","depth0","data","blockParams","depths",this.decorators.merge()]):(this.decorators.prepend("function(fn, props, container, depth0, data, blockParams, depths) {\n"),this.decorators.push("}\n"),this.decorators=this.decorators.merge())),c=this.createFunctionContext(r),this.isChild)return c;u={compiler:this.compilerInfo(),main:c};this.decorators&&(u.main_d=this.decorators,u.useDecorators=!0);var v=this.context,l=v.programs,y=v.decorators;for(e=0,s=l.length;e<s;e++)l[e]&&(u[e]=l[e],y[e]&&(u[e+"_d"]=y[e],u.useDecorators=!0));return this.environment.usePartial&&(u.usePartial=!0),this.options.data&&(u.useData=!0),this.useDepths&&(u.useDepths=!0),this.useBlockParams&&(u.useBlockParams=!0),this.options.compat&&(u.compat=!0),r?u.compilerOptions=this.options:(u.compiler=JSON.stringify(u.compiler),this.source.currentLocation={start:{line:1,column:0}},u=this.objectLiteral(u),t.srcName?(u=u.toStringWithSourceMap({file:t.destName}),u.map=u.map&&u.map.toString()):u=u.toString()),u},preamble:function(){this.lastContext=0;this.source=new s["default"](this.options.srcName);this.decorators=new s["default"](this.options.srcName)},createFunctionContext:function(n){var u="",o=this.stackVars.concat(this.registers.list),f,i,r,t,e;o.length>0&&(u+=", "+o.join(", "));f=0;for(i in this.aliases)r=this.aliases[i],this.aliases.hasOwnProperty(i)&&r.children&&r.referenceCount>1&&(u+=", alias"+ ++f+"="+i,r.children[0]="alias"+f);return t=["container","depth0","helpers","partials","data"],(this.useBlockParams||this.useDepths)&&t.push("blockParams"),this.useDepths&&t.push("depths"),e=this.mergeSource(u),n?(t.push(e),Function.apply(this,t)):this.source.wrap(["function(",t.join(","),") {\n  ",e,"}"])},mergeSource:function(n){var e=this.environment.isSimple,f=!this.forceBuffer,r=undefined,u=undefined,t=undefined,i=undefined;return this.source.each(function(n){n.appendToBuffer?(t?n.prepend("  + "):t=n,i=n):(t&&(u?t.prepend("buffer += "):r=!0,i.add(";"),t=i=undefined),u=!0,e||(f=!1))}),f?t?(t.prepend("return "),i.add(";")):u||this.source.push('return "";'):(n+=", buffer = "+(r?"":this.initializeBuffer()),t?(t.prepend("return buffer + "),i.add(";")):this.source.push("return buffer;")),n&&this.source.prepend("var "+n.substring(2)+(r?"":";\n")),this.source.merge()},blockValue:function(n){var r=this.aliasable("helpers.blockHelperMissing"),t=[this.contextName(0)],i;this.setupHelperArgs(n,0,t);i=this.popStack();t.splice(1,0,i);this.push(this.source.functionCall(r,"call",t))},ambiguousBlockValue:function(){var i=this.aliasable("helpers.blockHelperMissing"),n=[this.contextName(0)],t;this.setupHelperArgs("",0,n,!0);this.flushInline();t=this.topStack();n.splice(1,0,t);this.pushSource(["if (!",this.lastHelper,") { ",t," = ",this.source.functionCall(i,"call",n),"}"])},appendContent:function(n){this.pendingContent?n=this.pendingContent+n:this.pendingLocation=this.source.currentLocation;this.pendingContent=n},append:function(){if(this.isInline())this.replaceStack(function(n){return[" != null ? ",n,' : ""']}),this.pushSource(this.appendToBuffer(this.popStack()));else{var n=this.popStack();this.pushSource(["if (",n," != null) { ",this.appendToBuffer(n,undefined,!0)," }"]);this.environment.isSimple&&this.pushSource(["else { ",this.appendToBuffer("''",undefined,!0)," }"])}},appendEscaped:function(){this.pushSource(this.appendToBuffer([this.aliasable("container.escapeExpression"),"(",this.popStack(),")"]))},getContext:function(n){this.lastContext=n},pushContext:function(){this.pushStackLiteral(this.contextName(this.lastContext))},lookupOnContext:function(n,t,i,r){var u=0;r||!this.options.compat||this.lastContext?this.pushContext():this.push(this.depthedLookup(n[u++]));this.resolvePath("context",n,u,t,i)},lookupBlockParam:function(n,t){this.useBlockParams=!0;this.push(["blockParams[",n[0],"][",n[1],"]"]);this.resolvePath("context",t,1)},lookupData:function(n,t,i){n?this.pushStackLiteral("container.data(data, "+n+")"):this.pushStackLiteral("data");this.resolvePath("data",t,0,!0,i)},resolvePath:function(n,t,i,r,u){var e=this,f;if(this.options.strict||this.options.assumeObjects){this.push(a(this.options.strict&&u,this,t,n));return}for(f=t.length;i<f;i++)this.replaceStack(function(u){var f=e.nameLookup(u,t[i],n);return r?[" && ",f]:[" != null ? ",f," : ",u]})},resolvePossibleLambda:function(){this.push([this.aliasable("container.lambda"),"(",this.popStack(),", ",this.contextName(0),")"])},pushStringParam:function(n,t){this.pushContext();this.pushString(t);t!=="SubExpression"&&(typeof n=="string"?this.pushString(n):this.pushStackLiteral(n))},emptyHash:function(n){this.trackIds&&this.push("{}");this.stringParams&&(this.push("{}"),this.push("{}"));this.pushStackLiteral(n?"undefined":"{}")},pushHash:function(){this.hash&&this.hashes.push(this.hash);this.hash={values:[],types:[],contexts:[],ids:[]}},popHash:function(){var n=this.hash;this.hash=this.hashes.pop();this.trackIds&&this.push(this.objectLiteral(n.ids));this.stringParams&&(this.push(this.objectLiteral(n.contexts)),this.push(this.objectLiteral(n.types)));this.push(this.objectLiteral(n.values))},pushString:function(n){this.pushStackLiteral(this.quotedString(n))},pushLiteral:function(n){this.pushStackLiteral(n)},pushProgram:function(n){n!=null?this.pushStackLiteral(this.programExpression(n)):this.pushStackLiteral(null)},registerDecorator:function(n,t){var i=this.nameLookup("decorators",t,"decorator"),r=this.setupHelperArgs(t,n);this.decorators.push(["fn = ",this.decorators.functionCall(i,"",["fn","props","container",r])," || fn;"])},invokeHelper:function(n,t,i){var f=this.popStack(),u=this.setupHelper(n,t),e=i?[u.name," || "]:"",r=["("].concat(e,f);this.options.strict||r.push(" || ",this.aliasable("helpers.helperMissing"));r.push(")");this.push(this.source.functionCall(r,"call",u.callParams))},invokeKnownHelper:function(n,t){var i=this.setupHelper(n,t);this.push(this.source.functionCall(i.name,"call",i.callParams))},invokeAmbiguous:function(n,t){var u;this.useRegister("helper");u=this.popStack();this.emptyHash();var i=this.setupHelper(0,n,t),f=this.lastHelper=this.nameLookup("helpers",n,"helper"),r=["(","(helper = ",f," || ",u,")"];this.options.strict||(r[0]="(helper = ",r.push(" != null ? helper : ",this.aliasable("helpers.helperMissing")));this.push(["(",r,i.paramsInit?["),(",i.paramsInit]:[],"),","(typeof helper === ",this.aliasable('"function"')," ? ",this.source.functionCall("helper","call",i.callParams)," : helper))"])},invokePartial:function(n,t,i){var u=[],r=this.setupParams(t,1,u);n&&(t=this.popStack(),delete r.name);i&&(r.indent=JSON.stringify(i));r.helpers="helpers";r.partials="partials";r.decorators="container.decorators";n?u.unshift(t):u.unshift(this.nameLookup("partials",t,"partial"));this.options.compat&&(r.depths="depths");r=this.objectLiteral(r);u.push(r);this.push(this.source.functionCall("container.invokePartial","",u))},assignToHash:function(n){var f=this.popStack(),i=undefined,r=undefined,u=undefined,t;this.trackIds&&(u=this.popStack());this.stringParams&&(r=this.popStack(),i=this.popStack());t=this.hash;i&&(t.contexts[n]=i);r&&(t.types[n]=r);u&&(t.ids[n]=u);t.values[n]=f},pushId:function(n,t,i){n==="BlockParam"?this.pushStackLiteral("blockParams["+t[0]+"].path["+t[1]+"]"+(i?" + "+JSON.stringify("."+i):"")):n==="PathExpression"?this.pushString(t):n==="SubExpression"?this.pushStackLiteral("true"):this.pushStackLiteral("null")},compiler:r,compileChildren:function(n,t){for(var r,e=n.children,i=undefined,u=undefined,f=0,o=e.length;f<o;f++)i=e[f],u=new this.compiler,r=this.matchExistingProgram(i),r==null?(this.context.programs.push(""),r=this.context.programs.length,i.index=r,i.name="program"+r,this.context.programs[r]=u.compile(i,t,this.context,!this.precompile),this.context.decorators[r]=u.decorators,this.context.environments[r]=i,this.useDepths=this.useDepths||u.useDepths,this.useBlockParams=this.useBlockParams||u.useBlockParams):(i.index=r,i.name="program"+r,this.useDepths=this.useDepths||i.useDepths,this.useBlockParams=this.useBlockParams||i.useBlockParams)},matchExistingProgram:function(n){for(var i,t=0,r=this.context.environments.length;t<r;t++)if(i=this.context.environments[t],i&&i.equals(n))return t},programExpression:function(n){var i=this.environment.children[n],t=[i.index,"data",i.blockParams];return(this.useBlockParams||this.useDepths)&&t.push("blockParams"),this.useDepths&&t.push("depths"),"container.program("+t.join(", ")+")"},useRegister:function(n){this.registers[n]||(this.registers[n]=!0,this.registers.list.push(n))},push:function(n){return n instanceof u||(n=this.source.wrap(n)),this.inlineStack.push(n),n},pushStackLiteral:function(n){this.push(new u(n))},pushSource:function(n){this.pendingContent&&(this.source.push(this.appendToBuffer(this.source.quotedString(this.pendingContent),this.pendingLocation)),this.pendingContent=undefined);n&&this.source.push(n)},replaceStack:function(n){var r=["("],t=undefined,e=undefined,o=undefined,i,s,h;if(!this.isInline())throw new f["default"]("replaceStack on non-inline");i=this.popStack(!0);i instanceof u?(t=[i.value],r=["(",t],o=!0):(e=!0,s=this.incrStack(),r=["((",this.push(s)," = ",i,")"],t=this.topStack());h=n.call(this,t);o||this.popStack();e&&this.stackSlot--;this.push(r.concat(h,")"))},incrStack:function(){return this.stackSlot++,this.stackSlot>this.stackVars.length&&this.stackVars.push("stack"+this.stackSlot),this.topStackName()},topStackName:function(){return"stack"+this.stackSlot},flushInline:function(){var r=this.inlineStack,n,f,t,i;for(this.inlineStack=[],n=0,f=r.length;n<f;n++)t=r[n],t instanceof u?this.compileStack.push(t):(i=this.incrStack(),this.pushSource([i," = ",t,";"]),this.compileStack.push(i))},isInline:function(){return this.inlineStack.length},popStack:function(n){var i=this.isInline(),t=(i?this.inlineStack:this.compileStack).pop();if(!n&&t instanceof u)return t.value;if(!i){if(!this.stackSlot)throw new f["default"]("Invalid stack pop");this.stackSlot--}return t},topStack:function(){var t=this.isInline()?this.inlineStack:this.compileStack,n=t[t.length-1];return n instanceof u?n.value:n},contextName:function(n){return this.useDepths&&n?"depths["+n+"]":"depth"+n},quotedString:function(n){return this.source.quotedString(n)},objectLiteral:function(n){return this.source.objectLiteral(n)},aliasable:function(n){var t=this.aliases[n];return t?(t.referenceCount++,t):(t=this.aliases[n]=this.source.wrap(n),t.aliasable=!0,t.referenceCount=1,t)},setupHelper:function(n,t,i){var r=[],u=this.setupHelperArgs(t,n,r,i),f=this.nameLookup("helpers",t,"helper"),e=this.aliasable(this.contextName(0)+" != null ? "+this.contextName(0)+" : {}");return{params:r,paramsInit:u,name:f,callParams:[e].concat(r)}},setupParams:function(n,t,i){var r={},o=[],s=[],h=[],c=!i,l=undefined,f,e,u;for(c&&(i=[]),r.name=this.quotedString(n),r.hash=this.popStack(),this.trackIds&&(r.hashIds=this.popStack()),this.stringParams&&(r.hashTypes=this.popStack(),r.hashContexts=this.popStack()),f=this.popStack(),e=this.popStack(),(e||f)&&(r.fn=e||"container.noop",r.inverse=f||"container.noop"),u=t;u--;)l=this.popStack(),i[u]=l,this.trackIds&&(h[u]=this.popStack()),this.stringParams&&(s[u]=this.popStack(),o[u]=this.popStack());return c&&(r.args=this.source.generateArray(i)),this.trackIds&&(r.ids=this.source.generateArray(h)),this.stringParams&&(r.types=this.source.generateArray(s),r.contexts=this.source.generateArray(o)),this.options.data&&(r.data="data"),this.useBlockParams&&(r.blockParams="blockParams"),r},setupHelperArgs:function(n,t,i,r){var u=this.setupParams(n,t,i);return u=this.objectLiteral(u),r?(this.useRegister("options"),i.push("options"),["options=",u]):i?(i.push(u),""):u}},function(){for(var t="break else new var case finally return void catch for switch while continue function this with default if throw delete in try do instanceof typeof abstract enum int short boolean export interface static byte extends long super char final native synchronized class float package throws const goto private transient debugger implements protected volatile double import public let yield await null true false".split(" "),i=r.RESERVED_WORDS={},n=0,u=t.length;n<u;n++)i[t[n]]=!0}();r.isValidJavaScriptVariableName=function(n){return!r.RESERVED_WORDS[n]&&/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(n)};t["default"]=r;n.exports=t["default"]},function(n,t,i){"use strict";function f(n,t,i){var f,r,e;if(u.isArray(n)){for(f=[],r=0,e=n.length;r<e;r++)f.push(t.wrap(n[r],i));return f}return typeof n=="boolean"||typeof n=="number"?n+"":n}function o(n){this.srcFile=n;this.source=[]}var u,r,e;t.__esModule=!0;u=i(5);r=undefined;try{1||(e=require("source-map"),r=e.SourceNode)}catch(s){}r||(r=function(n,t,i,r){this.src="";r&&this.add(r)},r.prototype={add:function(n){u.isArray(n)&&(n=n.join(""));this.src+=n},prepend:function(n){u.isArray(n)&&(n=n.join(""));this.src=n+this.src},toStringWithSourceMap:function(){return{code:this.toString()}},toString:function(){return this.src}});o.prototype={isEmpty:function(){return!this.source.length},prepend:function(n,t){this.source.unshift(this.wrap(n,t))},push:function(n,t){this.source.push(this.wrap(n,t))},merge:function(){var n=this.empty();return this.each(function(t){n.add(["  ",t,"\n"])}),n},each:function(n){for(var t=0,i=this.source.length;t<i;t++)n(this.source[t])},empty:function(){var n=this.currentLocation||{start:{}};return new r(n.start.line,n.start.column,this.srcFile)},wrap:function(n){var t=arguments.length<=1||arguments[1]===undefined?this.currentLocation||{start:{}}:arguments[1];return n instanceof r?n:(n=f(n,this,t),new r(t.start.line,t.start.column,this.srcFile,n))},functionCall:function(n,t,i){return i=this.generateList(i),this.wrap([n,t?"."+t+"(":"(",i,")"])},quotedString:function(n){return'"'+(n+"").replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")+'"'},objectLiteral:function(n){var u=[],t,r,i;for(t in n)n.hasOwnProperty(t)&&(r=f(n[t],this),r!=="undefined"&&u.push([this.quotedString(t),":",r]));return i=this.generateList(u),i.prepend("{"),i.add("}"),i},generateList:function(n){for(var i=this.empty(),t=0,r=n.length;t<r;t++)t&&i.add(","),i.add(f(n[t],this));return i},generateArray:function(n){var t=this.generateList(n);return t.prepend("["),t.add("]"),t}};t["default"]=o;n.exports=t["default"]}])}),function($){$.fn.extend({donetyping:function(callback,timeout){timeout=timeout||1e3;var timeoutReference,doneTyping=function(el){timeoutReference&&(timeoutReference=null,callback.call(el))};return this.each(function(i,el){var $el=$(el);$el.is(":input")&&$el.on("keyup keypress",function(e){(e.type!="keyup"||e.keyCode==8)&&(timeoutReference&&clearTimeout(timeoutReference),timeoutReference=setTimeout(function(){doneTyping(el)},timeout))}).on("blur",function(){doneTyping(el)})})}})}(jQuery);jQuery&&function($){function show(event,object){var trigger=event?$(this):object,dropdown=$(trigger.attr("data-dropdown")),isOpen=trigger.hasClass("dropdown-open");if(event){if($(event.target).hasClass("dropdown-ignore"))return;event.preventDefault();event.stopPropagation()}else if(trigger!==object.target&&$(object.target).hasClass("dropdown-ignore"))return;(hide(),isOpen||trigger.hasClass("dropdown-disabled"))||(trigger.addClass("dropdown-open"),dropdown.data("dropdown-trigger",trigger).show(),position(),dropdown.trigger("show",{dropdown:dropdown,trigger:trigger}))}function hide(event){var targetGroup=event?$(event.target).parents().addBack():null;if(targetGroup&&targetGroup.is(".dropdown"))if(targetGroup.is(".dropdown-menu")){if(!targetGroup.is("A"))return}else return;$(document).find(".dropdown:visible").each(function(){var dropdown=$(this);dropdown.hide().removeData("dropdown-trigger").trigger("hide",{dropdown:dropdown})});$(document).find(".dropdown-open").removeClass("dropdown-open")}function position(){var dropdown=$(".dropdown:visible").eq(0),trigger=dropdown.data("dropdown-trigger"),hOffset=trigger?parseInt(trigger.attr("data-horizontal-offset")||0,10):null,vOffset=trigger?parseInt(trigger.attr("data-vertical-offset")||0,10):null;dropdown.length!==0&&trigger&&(dropdown.hasClass("dropdown-relative")?dropdown.css({left:dropdown.hasClass("dropdown-anchor-right")?trigger.position().left-(dropdown.outerWidth(!0)-trigger.outerWidth(!0))-parseInt(trigger.css("margin-right"),10)+hOffset:trigger.position().left+parseInt(trigger.css("margin-left"),10)+hOffset,top:trigger.position().top+trigger.outerHeight(!0)-parseInt(trigger.css("margin-top"),10)+vOffset}):dropdown.css({left:dropdown.hasClass("dropdown-anchor-right")?trigger.offset().left-(dropdown.outerWidth()-trigger.outerWidth())+hOffset:trigger.offset().left+hOffset,top:trigger.offset().top+trigger.outerHeight()+vOffset}))}$.extend($.fn,{dropdown:function(method,data){switch(method){case"show":return show(null,$(this)),$(this);case"hide":return hide(),$(this);case"attach":return $(this).attr("data-dropdown",data);case"detach":return hide(),$(this).removeAttr("data-dropdown");case"disable":return $(this).addClass("dropdown-disabled");case"enable":return hide(),$(this).removeClass("dropdown-disabled")}}});$(document).on("click.dropdown","[data-dropdown]",show);$(document).on("click.dropdown",hide);$(window).on("resize",position)}(jQuery);
/*! Magnific Popup - v0.9.9 - 2014-09-06
* http://dimsemenov.com/plugins/magnific-popup/
* Copyright (c) 2014 Dmitry Semenov; */
(function($){var CLOSE_EVENT="Close",BEFORE_CLOSE_EVENT="BeforeClose",AFTER_CLOSE_EVENT="AfterClose",BEFORE_APPEND_EVENT="BeforeAppend",MARKUP_PARSE_EVENT="MarkupParse",OPEN_EVENT="Open",CHANGE_EVENT="Change",NS="mfp",EVENT_NS="."+NS,READY_CLASS="mfp-ready",REMOVING_CLASS="mfp-removing",PREVENT_CLOSE_CLASS="mfp-prevent-close",mfp,MagnificPopup=function(){},_isJQ=!!window.jQuery,_prevStatus,_window=$(window),_body,_document,_prevContentType,_wrapClasses,_currPopupType,_mfpOn=function(name,f){mfp.ev.on(NS+name+EVENT_NS,f)},_getEl=function(className,appendTo,html,raw){var el=document.createElement("div");return el.className="mfp-"+className,html&&(el.innerHTML=html),raw?appendTo&&appendTo.appendChild(el):(el=$(el),appendTo&&el.appendTo(appendTo)),el},_mfpTrigger=function(e,data){mfp.ev.triggerHandler(NS+e,data);mfp.st.callbacks&&(e=e.charAt(0).toLowerCase()+e.slice(1),mfp.st.callbacks[e]&&mfp.st.callbacks[e].apply(mfp,$.isArray(data)?data:[data]))},_getCloseBtn=function(type){return type===_currPopupType&&mfp.currTemplate.closeBtn||(mfp.currTemplate.closeBtn=$(mfp.st.closeMarkup.replace("%title%",mfp.st.tClose)),_currPopupType=type),mfp.currTemplate.closeBtn},_checkInstance=function(){$.magnificPopup.instance||(mfp=new MagnificPopup,mfp.init(),$.magnificPopup.instance=mfp)},supportsTransitions=function(){var s=document.createElement("p").style,v=["ms","O","Moz","Webkit"];if(s.transition!==undefined)return!0;while(v.length)if(v.pop()+"Transition"in s)return!0;return!1},INLINE_NS,_hiddenClass,_inlinePlaceholder,_lastInlineElement,_putInlineElementsBack,_imgInterval,_getTitle,hasMozTransform,getHasMozTransform,_getLoopedId,_replaceCurrTotal,RETINA_NS;MagnificPopup.prototype={constructor:MagnificPopup,init:function(){var appVersion=navigator.appVersion;mfp.isIE7=appVersion.indexOf("MSIE 7.")!==-1;mfp.isIE8=appVersion.indexOf("MSIE 8.")!==-1;mfp.isLowIE=mfp.isIE7||mfp.isIE8;mfp.isAndroid=/android/gi.test(appVersion);mfp.isIOS=/iphone|ipad|ipod/gi.test(appVersion);mfp.supportsTransition=supportsTransitions();mfp.probablyMobile=mfp.isAndroid||mfp.isIOS||/(Opera Mini)|Kindle|webOS|BlackBerry|(Opera Mobi)|(Windows Phone)|IEMobile/i.test(navigator.userAgent);_document=$(document);mfp.popupsCache={}},open:function(data){var i,items,item,modules,n,windowHeight,windowStyles,s,classesToadd;if(_body||(_body=$(document.body)),data.isObj===!1){for(mfp.items=data.items.toArray(),mfp.index=0,items=data.items,i=0;i<items.length;i++)if(item=items[i],item.parsed&&(item=item.el[0]),item===data.el[0]){mfp.index=i;break}}else mfp.items=$.isArray(data.items)?data.items:[data.items],mfp.index=data.index||0;if(mfp.isOpen){mfp.updateItemHTML();return}for(mfp.types=[],_wrapClasses="",mfp.ev=data.mainEl&&data.mainEl.length?data.mainEl.eq(0):_document,data.key?(mfp.popupsCache[data.key]||(mfp.popupsCache[data.key]={}),mfp.currTemplate=mfp.popupsCache[data.key]):mfp.currTemplate={},mfp.st=$.extend(!0,{},$.magnificPopup.defaults,data),mfp.fixedContentPos=mfp.st.fixedContentPos==="auto"?!mfp.probablyMobile:mfp.st.fixedContentPos,mfp.st.modal&&(mfp.st.closeOnContentClick=!1,mfp.st.closeOnBgClick=!1,mfp.st.showCloseBtn=!1,mfp.st.enableEscapeKey=!1),mfp.bgOverlay||(mfp.bgOverlay=_getEl("bg").on("click"+EVENT_NS,function(){mfp.close()}),mfp.wrap=_getEl("wrap").attr("tabindex",-1).on("click"+EVENT_NS,function(e){mfp._checkIfClose(e.target)&&mfp.close()}),mfp.container=_getEl("container",mfp.wrap)),mfp.contentContainer=_getEl("content"),mfp.st.preloader&&(mfp.preloader=_getEl("preloader",mfp.container,mfp.st.tLoading)),modules=$.magnificPopup.modules,i=0;i<modules.length;i++)n=modules[i],n=n.charAt(0).toUpperCase()+n.slice(1),mfp["init"+n].call(mfp);if(_mfpTrigger("BeforeOpen"),mfp.st.showCloseBtn&&(mfp.st.closeBtnInside?(_mfpOn(MARKUP_PARSE_EVENT,function(e,template,values,item){values.close_replaceWith=_getCloseBtn(item.type)}),_wrapClasses+=" mfp-close-btn-in"):mfp.wrap.append(_getCloseBtn())),mfp.st.alignTop&&(_wrapClasses+=" mfp-align-top"),mfp.fixedContentPos?mfp.wrap.css({overflow:mfp.st.overflowY,overflowX:"hidden",overflowY:mfp.st.overflowY}):mfp.wrap.css({top:_window.scrollTop(),position:"absolute"}),mfp.st.fixedBgPos!==!1&&(mfp.st.fixedBgPos!=="auto"||mfp.fixedContentPos)||mfp.bgOverlay.css({height:_document.height(),position:"absolute"}),mfp.st.enableEscapeKey)_document.on("keyup"+EVENT_NS,function(e){e.keyCode===27&&mfp.close()});_window.on("resize"+EVENT_NS,function(){mfp.updateSize()});return mfp.st.closeOnContentClick||(_wrapClasses+=" mfp-auto-cursor"),_wrapClasses&&mfp.wrap.addClass(_wrapClasses),windowHeight=mfp.wH=_window.height(),windowStyles={},mfp.fixedContentPos&&mfp._hasScrollBar(windowHeight)&&(s=mfp._getScrollbarSize(),s&&(windowStyles.marginRight=s)),mfp.fixedContentPos&&(mfp.isIE7?$("body, html").css("overflow","hidden"):windowStyles.overflow="hidden"),classesToadd=mfp.st.mainClass,mfp.isIE7&&(classesToadd+=" mfp-ie7"),classesToadd&&mfp._addClassToMFP(classesToadd),mfp.updateItemHTML(),_mfpTrigger("BuildControls"),$("html").css(windowStyles),mfp.bgOverlay.add(mfp.wrap).prependTo(mfp.st.prependTo||_body),mfp._lastFocusedEl=document.activeElement,setTimeout(function(){mfp.content?(mfp._addClassToMFP(READY_CLASS),mfp._setFocus()):mfp.bgOverlay.addClass(READY_CLASS);_document.on("focusin"+EVENT_NS,mfp._onFocusIn)},16),mfp.isOpen=!0,mfp.updateSize(windowHeight),_mfpTrigger(OPEN_EVENT),data},close:function(){mfp.isOpen&&(_mfpTrigger(BEFORE_CLOSE_EVENT),mfp.isOpen=!1,mfp.st.removalDelay&&!mfp.isLowIE&&mfp.supportsTransition?(mfp._addClassToMFP(REMOVING_CLASS),setTimeout(function(){mfp._close()},mfp.st.removalDelay)):mfp._close())},_close:function(){var classesToRemove,windowStyles;_mfpTrigger(CLOSE_EVENT);classesToRemove=REMOVING_CLASS+" "+READY_CLASS+" ";mfp.bgOverlay.detach();mfp.wrap.detach();mfp.container.empty();mfp.st.mainClass&&(classesToRemove+=mfp.st.mainClass+" ");mfp._removeClassFromMFP(classesToRemove);mfp.fixedContentPos&&(windowStyles={marginRight:""},mfp.isIE7?$("body, html").css("overflow",""):windowStyles.overflow="",$("html").css(windowStyles));_document.off("keyup"+EVENT_NS+" focusin"+EVENT_NS);mfp.ev.off(EVENT_NS);mfp.wrap.attr("class","mfp-wrap").removeAttr("style");mfp.bgOverlay.attr("class","mfp-bg");mfp.container.attr("class","mfp-container");mfp.st.showCloseBtn&&(!mfp.st.closeBtnInside||mfp.currTemplate[mfp.currItem.type]===!0)&&mfp.currTemplate.closeBtn&&mfp.currTemplate.closeBtn.detach();mfp._lastFocusedEl&&$(mfp._lastFocusedEl).focus();mfp.currItem=null;mfp.content=null;mfp.currTemplate=null;mfp.prevHeight=0;_mfpTrigger(AFTER_CLOSE_EVENT)},updateSize:function(winHeight){if(mfp.isIOS){var zoomLevel=document.documentElement.clientWidth/window.innerWidth,height=window.innerHeight*zoomLevel;mfp.wrap.css("height",height);mfp.wH=height}else mfp.wH=winHeight||_window.height();mfp.fixedContentPos||mfp.wrap.css("height",mfp.wH);_mfpTrigger("Resize")},updateItemHTML:function(){var item=mfp.items[mfp.index],type,markup,newContent;mfp.contentContainer.detach();mfp.content&&mfp.content.detach();item.parsed||(item=mfp.parseEl(mfp.index));type=item.type;_mfpTrigger("BeforeChange",[mfp.currItem?mfp.currItem.type:"",type]);mfp.currItem=item;mfp.currTemplate[type]||(markup=mfp.st[type]?mfp.st[type].markup:!1,_mfpTrigger("FirstMarkupParse",markup),mfp.currTemplate[type]=markup?$(markup):!0);_prevContentType&&_prevContentType!==item.type&&mfp.container.removeClass("mfp-"+_prevContentType+"-holder");newContent=mfp["get"+type.charAt(0).toUpperCase()+type.slice(1)](item,mfp.currTemplate[type]);mfp.appendContent(newContent,type);item.preloaded=!0;_mfpTrigger(CHANGE_EVENT,item);_prevContentType=item.type;mfp.container.prepend(mfp.contentContainer);_mfpTrigger("AfterChange")},appendContent:function(newContent,type){mfp.content=newContent;newContent?mfp.st.showCloseBtn&&mfp.st.closeBtnInside&&mfp.currTemplate[type]===!0?mfp.content.find(".mfp-close").length||mfp.content.append(_getCloseBtn()):mfp.content=newContent:mfp.content="";_mfpTrigger(BEFORE_APPEND_EVENT);mfp.container.addClass("mfp-"+type+"-holder");mfp.contentContainer.append(mfp.content)},parseEl:function(index){var item=mfp.items[index],type,types,i;if(item.tagName?item={el:$(item)}:(type=item.type,item={data:item,src:item.src}),item.el){for(types=mfp.types,i=0;i<types.length;i++)if(item.el.hasClass("mfp-"+types[i])){type=types[i];break}item.src=item.el.attr("data-mfp-src");item.src||(item.src=item.el.attr("href"))}return item.type=type||mfp.st.type||"inline",item.index=index,item.parsed=!0,mfp.items[index]=item,_mfpTrigger("ElementParse",item),mfp.items[index]},addGroup:function(el,options){var eHandler=function(e){e.mfpEl=this;mfp._openClick(e,el,options)},eName;if(options||(options={}),eName="click.magnificPopup",options.mainEl=el,options.items){options.isObj=!0;el.off(eName).on(eName,eHandler)}else if(options.isObj=!1,options.delegate)el.off(eName).on(eName,options.delegate,eHandler);else{options.items=el;el.off(eName).on(eName,eHandler)}},_openClick:function(e,el,options){var midClick=options.midClick!==undefined?options.midClick:$.magnificPopup.defaults.midClick,disableOn;if(midClick||!(e.which===2||e.ctrlKey||e.metaKey)){if(disableOn=options.disableOn!==undefined?options.disableOn:$.magnificPopup.defaults.disableOn,disableOn)if($.isFunction(disableOn)){if(!disableOn.call(mfp))return!0}else if(_window.width()<disableOn)return!0;e.type&&(e.preventDefault(),mfp.isOpen&&e.stopPropagation());options.el=$(e.mfpEl);options.delegate&&(options.items=el.find(options.delegate));mfp.open(options)}},updateStatus:function(status,text){if(mfp.preloader){_prevStatus!==status&&mfp.container.removeClass("mfp-s-"+_prevStatus);text||status!=="loading"||(text=mfp.st.tLoading);var data={status:status,text:text};_mfpTrigger("UpdateStatus",data);status=data.status;text=data.text;mfp.preloader.html(text);mfp.preloader.find("a").on("click",function(e){e.stopImmediatePropagation()});mfp.container.addClass("mfp-s-"+status);_prevStatus=status}},_checkIfClose:function(target){if(!$(target).hasClass(PREVENT_CLOSE_CLASS)){var closeOnContent=mfp.st.closeOnContentClick,closeOnBg=mfp.st.closeOnBgClick;if(closeOnContent&&closeOnBg||!mfp.content||$(target).hasClass("mfp-close")||mfp.preloader&&target===mfp.preloader[0])return!0;if(target===mfp.content[0]||$.contains(mfp.content[0],target)){if(closeOnContent)return!0}else if(closeOnBg&&$.contains(document,target))return!0;return!1}},_addClassToMFP:function(cName){mfp.bgOverlay.addClass(cName);mfp.wrap.addClass(cName)},_removeClassFromMFP:function(cName){this.bgOverlay.removeClass(cName);mfp.wrap.removeClass(cName)},_hasScrollBar:function(winHeight){return(mfp.isIE7?_document.height():document.body.scrollHeight)>(winHeight||_window.height())},_setFocus:function(){(mfp.st.focus?mfp.content.find(mfp.st.focus).eq(0):mfp.wrap).focus()},_onFocusIn:function(e){if(e.target!==mfp.wrap[0]&&!$.contains(mfp.wrap[0],e.target))return mfp._setFocus(),!1},_parseMarkup:function(template,values,item){var arr;item.data&&(values=$.extend(item.data,values));_mfpTrigger(MARKUP_PARSE_EVENT,[template,values,item]);$.each(values,function(key,value){var el,attr;if(value===undefined||value===!1)return!0;arr=key.split("_");arr.length>1?(el=template.find(EVENT_NS+"-"+arr[0]),el.length>0&&(attr=arr[1],attr==="replaceWith"?el[0]!==value[0]&&el.replaceWith(value):attr==="img"?el.is("img")?el.attr("src",value):el.replaceWith('<img src="'+value+'" class="'+el.attr("class")+'" />'):el.attr(arr[1],value))):template.find(EVENT_NS+"-"+key).html(value)})},_getScrollbarSize:function(){if(mfp.scrollbarSize===undefined){var scrollDiv=document.createElement("div");scrollDiv.style.cssText="width: 99px; height: 99px; overflow: scroll; position: absolute; top: -9999px;";document.body.appendChild(scrollDiv);mfp.scrollbarSize=scrollDiv.offsetWidth-scrollDiv.clientWidth;document.body.removeChild(scrollDiv)}return mfp.scrollbarSize}};$.magnificPopup={instance:null,proto:MagnificPopup.prototype,modules:[],open:function(options,index){return _checkInstance(),options=options?$.extend(!0,{},options):{},options.isObj=!0,options.index=index||0,this.instance.open(options)},close:function(){return $.magnificPopup.instance&&$.magnificPopup.instance.close()},registerModule:function(name,module){module.options&&($.magnificPopup.defaults[name]=module.options);$.extend(this.proto,module.proto);this.modules.push(name)},defaults:{disableOn:0,key:null,midClick:!1,mainClass:"",preloader:!0,focus:"",closeOnContentClick:!1,closeOnBgClick:!0,closeBtnInside:!0,showCloseBtn:!0,enableEscapeKey:!0,modal:!1,alignTop:!1,removalDelay:0,prependTo:null,fixedContentPos:"auto",fixedBgPos:"auto",overflowY:"auto",closeMarkup:'<button title="%title%" type="button" class="mfp-close">&times;<\/button>',tClose:"Close (Esc)",tLoading:"Loading..."}};$.fn.magnificPopup=function(options){var jqEl,items,itemOpts,index;return _checkInstance(),jqEl=$(this),typeof options=="string"?options==="open"?(itemOpts=_isJQ?jqEl.data("magnificPopup"):jqEl[0].magnificPopup,index=parseInt(arguments[1],10)||0,itemOpts.items?items=itemOpts.items[index]:(items=jqEl,itemOpts.delegate&&(items=items.find(itemOpts.delegate)),items=items.eq(index)),mfp._openClick({mfpEl:items},jqEl,itemOpts)):mfp.isOpen&&mfp[options].apply(mfp,Array.prototype.slice.call(arguments,1)):(options=$.extend(!0,{},options),_isJQ?jqEl.data("magnificPopup",options):jqEl[0].magnificPopup=options,mfp.addGroup(jqEl,options)),jqEl};INLINE_NS="inline";_putInlineElementsBack=function(){_lastInlineElement&&(_inlinePlaceholder.after(_lastInlineElement.addClass(_hiddenClass)).detach(),_lastInlineElement=null)};$.magnificPopup.registerModule(INLINE_NS,{options:{hiddenClass:"hide",markup:"",tNotFound:"Content not found"},proto:{initInline:function(){mfp.types.push(INLINE_NS);_mfpOn(CLOSE_EVENT+"."+INLINE_NS,function(){_putInlineElementsBack()})},getInline:function(item,template){var inlineSt,el,parent;return(_putInlineElementsBack(),item.src)?(inlineSt=mfp.st.inline,el=$(item.src),el.length?(parent=el[0].parentNode,parent&&parent.tagName&&(_inlinePlaceholder||(_hiddenClass=inlineSt.hiddenClass,_inlinePlaceholder=_getEl(_hiddenClass),_hiddenClass="mfp-"+_hiddenClass),_lastInlineElement=el.after(_inlinePlaceholder).detach().removeClass(_hiddenClass)),mfp.updateStatus("ready")):(mfp.updateStatus("error",inlineSt.tNotFound),el=$("<div>")),item.inlineElement=el,el):(mfp.updateStatus("ready"),mfp._parseMarkup(template,{},item),template)}}});var AJAX_NS="ajax",_ajaxCur,_removeAjaxCursor=function(){_ajaxCur&&_body.removeClass(_ajaxCur)},_destroyAjaxRequest=function(){_removeAjaxCursor();mfp.req&&mfp.req.abort()};$.magnificPopup.registerModule(AJAX_NS,{options:{settings:null,cursor:"mfp-ajax-cur",tError:'<a href="%url%">The content<\/a> could not be loaded.'},proto:{initAjax:function(){mfp.types.push(AJAX_NS);_ajaxCur=mfp.st.ajax.cursor;_mfpOn(CLOSE_EVENT+"."+AJAX_NS,_destroyAjaxRequest);_mfpOn("BeforeChange."+AJAX_NS,_destroyAjaxRequest)},getAjax:function(item){_ajaxCur&&_body.addClass(_ajaxCur);mfp.updateStatus("loading");var opts=$.extend({url:item.src,success:function(data,textStatus,jqXHR){var temp={data:data,xhr:jqXHR};_mfpTrigger("ParseAjax",temp);mfp.appendContent($(temp.data),AJAX_NS);item.finished=!0;_removeAjaxCursor();mfp._setFocus();setTimeout(function(){mfp.wrap.addClass(READY_CLASS)},16);mfp.updateStatus("ready");_mfpTrigger("AjaxContentAdded")},error:function(){_removeAjaxCursor();item.finished=item.loadError=!0;mfp.updateStatus("error",mfp.st.ajax.tError.replace("%url%",item.src))}},mfp.st.ajax.settings);return mfp.req=$.ajax(opts),""}}});_getTitle=function(item){if(item.data&&item.data.title!==undefined)return item.data.title;var src=mfp.st.image.titleSrc;if(src){if($.isFunction(src))return src.call(mfp,item);if(item.el)return item.el.attr(src)||""}return""};$.magnificPopup.registerModule("image",{options:{markup:'<div class="mfp-figure"><div class="mfp-close"><\/div><figure><div class="mfp-img"><\/div><figcaption><div class="mfp-bottom-bar"><div class="mfp-title"><\/div><div class="mfp-counter"><\/div><\/div><\/figcaption><\/figure><\/div>',cursor:"mfp-zoom-out-cur",titleSrc:"title",verticalFit:!0,tError:'<a href="%url%">The image<\/a> could not be loaded.'},proto:{initImage:function(){var imgSt=mfp.st.image,ns=".image";mfp.types.push("image");_mfpOn(OPEN_EVENT+ns,function(){mfp.currItem.type==="image"&&imgSt.cursor&&_body.addClass(imgSt.cursor)});_mfpOn(CLOSE_EVENT+ns,function(){imgSt.cursor&&_body.removeClass(imgSt.cursor);_window.off("resize"+EVENT_NS)});_mfpOn("Resize"+ns,mfp.resizeImage);mfp.isLowIE&&_mfpOn("AfterChange",mfp.resizeImage)},resizeImage:function(){var item=mfp.currItem,decr;item&&item.img&&mfp.st.image.verticalFit&&(decr=0,mfp.isLowIE&&(decr=parseInt(item.img.css("padding-top"),10)+parseInt(item.img.css("padding-bottom"),10)),item.img.css("max-height",mfp.wH-decr))},_onImageHasSize:function(item){item.img&&(item.hasSize=!0,_imgInterval&&clearInterval(_imgInterval),item.isCheckingImgSize=!1,_mfpTrigger("ImageHasSize",item),item.imgHidden&&(mfp.content&&mfp.content.removeClass("mfp-loading"),item.imgHidden=!1))},findImageSize:function(item){var counter=0,img=item.img[0],mfpSetInterval=function(delay){_imgInterval&&clearInterval(_imgInterval);_imgInterval=setInterval(function(){if(img.naturalWidth>0){mfp._onImageHasSize(item);return}counter>200&&clearInterval(_imgInterval);counter++;counter===3?mfpSetInterval(10):counter===40?mfpSetInterval(50):counter===100&&mfpSetInterval(500)},delay)};mfpSetInterval(1)},getImage:function(item,template){var guard=0,onLoadComplete=function(){item&&(item.img[0].complete?(item.img.off(".mfploader"),item===mfp.currItem&&(mfp._onImageHasSize(item),mfp.updateStatus("ready")),item.hasSize=!0,item.loaded=!0,_mfpTrigger("ImageLoadComplete")):(guard++,guard<200?setTimeout(onLoadComplete,100):onLoadError()))},onLoadError=function(){item&&(item.img.off(".mfploader"),item===mfp.currItem&&(mfp._onImageHasSize(item),mfp.updateStatus("error",imgSt.tError.replace("%url%",item.src))),item.hasSize=!0,item.loaded=!0,item.loadError=!0)},imgSt=mfp.st.image,el=template.find(".mfp-img"),img;return(el.length&&(img=document.createElement("img"),img.className="mfp-img",item.img=$(img).on("load.mfploader",onLoadComplete).on("error.mfploader",onLoadError),img.src=item.src,el.is("img")&&(item.img=item.img.clone()),img=item.img[0],img.naturalWidth>0?item.hasSize=!0:img.width||(item.hasSize=!1)),mfp._parseMarkup(template,{title:_getTitle(item),img_replaceWith:item.img},item),mfp.resizeImage(),item.hasSize)?(_imgInterval&&clearInterval(_imgInterval),item.loadError?(template.addClass("mfp-loading"),mfp.updateStatus("error",imgSt.tError.replace("%url%",item.src))):(template.removeClass("mfp-loading"),mfp.updateStatus("ready")),template):(mfp.updateStatus("loading"),item.loading=!0,item.hasSize||(item.imgHidden=!0,template.addClass("mfp-loading"),mfp.findImageSize(item)),template)}}});getHasMozTransform=function(){return hasMozTransform===undefined&&(hasMozTransform=document.createElement("p").style.MozTransform!==undefined),hasMozTransform};$.magnificPopup.registerModule("zoom",{options:{enabled:!1,easing:"ease-in-out",duration:300,opener:function(element){return element.is("img")?element:element.find("img")}},proto:{initZoom:function(){var zoomSt=mfp.st.zoom,ns=".zoom",image;if(zoomSt.enabled&&mfp.supportsTransition){var duration=zoomSt.duration,getElToAnimate=function(image){var newImg=image.clone().removeAttr("style").removeAttr("class").addClass("mfp-animated-image"),transition="all "+zoomSt.duration/1e3+"s "+zoomSt.easing,cssObj={position:"fixed",zIndex:9999,left:0,top:0,"-webkit-backface-visibility":"hidden"},t="transition";return cssObj["-webkit-"+t]=cssObj["-moz-"+t]=cssObj["-o-"+t]=cssObj[t]=transition,newImg.css(cssObj),newImg},showMainContent=function(){mfp.content.css("visibility","visible")},openTimeout,animatedImg;_mfpOn("BuildControls"+ns,function(){if(mfp._allowZoom()){if(clearTimeout(openTimeout),mfp.content.css("visibility","hidden"),image=mfp._getItemToZoom(),!image){showMainContent();return}animatedImg=getElToAnimate(image);animatedImg.css(mfp._getOffset());mfp.wrap.append(animatedImg);openTimeout=setTimeout(function(){animatedImg.css(mfp._getOffset(!0));openTimeout=setTimeout(function(){showMainContent();setTimeout(function(){animatedImg.remove();image=animatedImg=null;_mfpTrigger("ZoomAnimationEnded")},16)},duration)},16)}});_mfpOn(BEFORE_CLOSE_EVENT+ns,function(){if(mfp._allowZoom()){if(clearTimeout(openTimeout),mfp.st.removalDelay=duration,!image){if(image=mfp._getItemToZoom(),!image)return;animatedImg=getElToAnimate(image)}animatedImg.css(mfp._getOffset(!0));mfp.wrap.append(animatedImg);mfp.content.css("visibility","hidden");setTimeout(function(){animatedImg.css(mfp._getOffset())},16)}});_mfpOn(CLOSE_EVENT+ns,function(){mfp._allowZoom()&&(showMainContent(),animatedImg&&animatedImg.remove(),image=null)})}},_allowZoom:function(){return mfp.currItem.type==="image"},_getItemToZoom:function(){return mfp.currItem.hasSize?mfp.currItem.img:!1},_getOffset:function(isLarge){var el,obj;el=isLarge?mfp.currItem.img:mfp.st.zoom.opener(mfp.currItem.el||mfp.currItem);var offset=el.offset(),paddingTop=parseInt(el.css("padding-top"),10),paddingBottom=parseInt(el.css("padding-bottom"),10);return offset.top-=$(window).scrollTop()-paddingTop,obj={width:el.width(),height:(_isJQ?el.innerHeight():el[0].offsetHeight)-paddingBottom-paddingTop},getHasMozTransform()?obj["-moz-transform"]=obj.transform="translate("+offset.left+"px,"+offset.top+"px)":(obj.left=offset.left,obj.top=offset.top),obj}}});var IFRAME_NS="iframe",_emptyPage="//about:blank",_fixIframeBugs=function(isShowing){if(mfp.currTemplate[IFRAME_NS]){var el=mfp.currTemplate[IFRAME_NS].find("iframe");el.length&&(isShowing||(el[0].src=_emptyPage),mfp.isIE8&&el.css("display",isShowing?"block":"none"))}};$.magnificPopup.registerModule(IFRAME_NS,{options:{markup:'<div class="mfp-iframe-scaler"><div class="mfp-close"><\/div><iframe class="mfp-iframe" src="//about:blank" frameborder="0" allowfullscreen><\/iframe><\/div>',srcAction:"iframe_src",patterns:{youtube:{index:"youtube.com",id:"v=",src:"//www.youtube.com/embed/%id%?autoplay=1"},vimeo:{index:"vimeo.com/",id:"/",src:"//player.vimeo.com/video/%id%?autoplay=1"},gmaps:{index:"//maps.google.",src:"%id%&output=embed"}}},proto:{initIframe:function(){mfp.types.push(IFRAME_NS);_mfpOn("BeforeChange",function(e,prevType,newType){prevType!==newType&&(prevType===IFRAME_NS?_fixIframeBugs():newType===IFRAME_NS&&_fixIframeBugs(!0))});_mfpOn(CLOSE_EVENT+"."+IFRAME_NS,function(){_fixIframeBugs()})},getIframe:function(item,template){var embedSrc=item.src,iframeSt=mfp.st.iframe,dataObj;return $.each(iframeSt.patterns,function(){if(embedSrc.indexOf(this.index)>-1)return this.id&&(embedSrc=typeof this.id=="string"?embedSrc.substr(embedSrc.lastIndexOf(this.id)+this.id.length,embedSrc.length):this.id.call(this,embedSrc)),embedSrc=this.src.replace("%id%",embedSrc),!1}),dataObj={},iframeSt.srcAction&&(dataObj[iframeSt.srcAction]=embedSrc),mfp._parseMarkup(template,dataObj,item),mfp.updateStatus("ready"),template}}});_getLoopedId=function(index){var numSlides=mfp.items.length;return index>numSlides-1?index-numSlides:index<0?numSlides+index:index};_replaceCurrTotal=function(text,curr,total){return text.replace(/%curr%/gi,curr+1).replace(/%total%/gi,total)};$.magnificPopup.registerModule("gallery",{options:{enabled:!1,arrowMarkup:'<button title="%title%" type="button" class="mfp-arrow mfp-arrow-%dir%"><\/button>',preload:[0,2],navigateByImgClick:!0,arrows:!0,tPrev:"Previous (Left arrow key)",tNext:"Next (Right arrow key)",tCounter:"%curr% of %total%"},proto:{initGallery:function(){var gSt=mfp.st.gallery,ns=".mfp-gallery",supportsFastClick=Boolean($.fn.mfpFastClick);if(mfp.direction=!0,!gSt||!gSt.enabled)return!1;_wrapClasses+=" mfp-gallery";_mfpOn(OPEN_EVENT+ns,function(){if(gSt.navigateByImgClick)mfp.wrap.on("click"+ns,".mfp-img",function(){if(mfp.items.length>1)return mfp.next(),!1});_document.on("keydown"+ns,function(e){e.keyCode===37?mfp.prev():e.keyCode===39&&mfp.next()})});_mfpOn("UpdateStatus"+ns,function(e,data){data.text&&(data.text=_replaceCurrTotal(data.text,mfp.currItem.index,mfp.items.length))});_mfpOn(MARKUP_PARSE_EVENT+ns,function(e,element,values,item){var l=mfp.items.length;values.counter=l>1?_replaceCurrTotal(gSt.tCounter,item.index,l):""});_mfpOn("BuildControls"+ns,function(){if(mfp.items.length>1&&gSt.arrows&&!mfp.arrowLeft){var markup=gSt.arrowMarkup,arrowLeft=mfp.arrowLeft=$(markup.replace(/%title%/gi,gSt.tPrev).replace(/%dir%/gi,"left")).addClass(PREVENT_CLOSE_CLASS),arrowRight=mfp.arrowRight=$(markup.replace(/%title%/gi,gSt.tNext).replace(/%dir%/gi,"right")).addClass(PREVENT_CLOSE_CLASS),eName=supportsFastClick?"mfpFastClick":"click";arrowLeft[eName](function(){mfp.prev()});arrowRight[eName](function(){mfp.next()});mfp.isIE7&&(_getEl("b",arrowLeft[0],!1,!0),_getEl("a",arrowLeft[0],!1,!0),_getEl("b",arrowRight[0],!1,!0),_getEl("a",arrowRight[0],!1,!0));mfp.container.append(arrowLeft.add(arrowRight))}});_mfpOn(CHANGE_EVENT+ns,function(){mfp._preloadTimeout&&clearTimeout(mfp._preloadTimeout);mfp._preloadTimeout=setTimeout(function(){mfp.preloadNearbyImages();mfp._preloadTimeout=null},16)});_mfpOn(CLOSE_EVENT+ns,function(){_document.off(ns);mfp.wrap.off("click"+ns);mfp.arrowLeft&&supportsFastClick&&mfp.arrowLeft.add(mfp.arrowRight).destroyMfpFastClick();mfp.arrowRight=mfp.arrowLeft=null})},next:function(){mfp.direction=!0;mfp.index=_getLoopedId(mfp.index+1);mfp.updateItemHTML()},prev:function(){mfp.direction=!1;mfp.index=_getLoopedId(mfp.index-1);mfp.updateItemHTML()},goTo:function(newIndex){mfp.direction=newIndex>=mfp.index;mfp.index=newIndex;mfp.updateItemHTML()},preloadNearbyImages:function(){for(var p=mfp.st.gallery.preload,preloadBefore=Math.min(p[0],mfp.items.length),preloadAfter=Math.min(p[1],mfp.items.length),i=1;i<=(mfp.direction?preloadAfter:preloadBefore);i++)mfp._preloadItem(mfp.index+i);for(i=1;i<=(mfp.direction?preloadBefore:preloadAfter);i++)mfp._preloadItem(mfp.index-i)},_preloadItem:function(index){if(index=_getLoopedId(index),!mfp.items[index].preloaded){var item=mfp.items[index];item.parsed||(item=mfp.parseEl(index));_mfpTrigger("LazyLoad",item);item.type==="image"&&(item.img=$('<img class="mfp-img" />').on("load.mfploader",function(){item.hasSize=!0}).on("error.mfploader",function(){item.hasSize=!0;item.loadError=!0;_mfpTrigger("LazyLoadError",item)}).attr("src",item.src));item.preloaded=!0}}}});RETINA_NS="retina";$.magnificPopup.registerModule(RETINA_NS,{options:{replaceSrc:function(item){return item.src.replace(/\.\w+$/,function(m){return"@2x"+m})},ratio:1},proto:{initRetina:function(){if(window.devicePixelRatio>1){var st=mfp.st.retina,ratio=st.ratio;ratio=isNaN(ratio)?ratio():ratio;ratio>1&&(_mfpOn("ImageHasSize."+RETINA_NS,function(e,item){item.img.css({"max-width":item.img[0].naturalWidth/ratio,width:"100%"})}),_mfpOn("ElementParse."+RETINA_NS,function(e,item){item.src=st.replaceSrc(item,ratio)}))}}}}),function(){var ghostClickDelay=1e3,supportsTouch="ontouchstart"in window,unbindTouchMove=function(){_window.off("touchmove"+ns+" touchend"+ns)},ns=".mfpFastClick";$.fn.mfpFastClick=function(callback){return $(this).each(function(){var elem=$(this),lock,timeout,startX,startY,pointerMoved,point,numPointers;if(supportsTouch)elem.on("touchstart"+ns,function(e){pointerMoved=!1;numPointers=1;point=e.originalEvent?e.originalEvent.touches[0]:e.touches[0];startX=point.clientX;startY=point.clientY;_window.on("touchmove"+ns,function(e){point=e.originalEvent?e.originalEvent.touches:e.touches;numPointers=point.length;point=point[0];(Math.abs(point.clientX-startX)>10||Math.abs(point.clientY-startY)>10)&&(pointerMoved=!0,unbindTouchMove())}).on("touchend"+ns,function(e){(unbindTouchMove(),pointerMoved||numPointers>1)||(lock=!0,e.preventDefault(),clearTimeout(timeout),timeout=setTimeout(function(){lock=!1},ghostClickDelay),callback())})});elem.on("click"+ns,function(){lock||callback()})})};$.fn.destroyMfpFastClick=function(){$(this).off("touchstart"+ns+" click"+ns);supportsTouch&&_window.off("touchmove"+ns+" touchend"+ns)}}();_checkInstance()})(window.jQuery||window.Zepto),function($){var defaults={topSpacing:0,bottomSpacing:0,className:"is-sticky",wrapperClassName:"sticky-wrapper",center:!1,getWidthFrom:"",responsiveWidth:!1},$window=$(window),$document=$(document),sticked=[],windowHeight=$window.height(),scroller=function(){for(var newTop,scrollTop=$window.scrollTop(),documentHeight=$document.height(),dwh=documentHeight-windowHeight,extra=scrollTop>dwh?dwh-scrollTop:0,i=0;i<sticked.length;i++){var s=sticked[i],elementTop=s.stickyWrapper.offset().top,etse=elementTop-s.topSpacing-extra;scrollTop<=etse?s.currentTop!==null&&(s.stickyElement.css("width","").css("position","").css("top",""),s.stickyElement.trigger("sticky-end",[s]).parent().removeClass(s.className),s.currentTop=null):(newTop=documentHeight-s.stickyElement.outerHeight()-s.topSpacing-s.bottomSpacing-scrollTop-extra,newTop=newTop<0?newTop+s.topSpacing:s.topSpacing,s.currentTop!=newTop&&(s.stickyElement.css("width",s.stickyElement.width()).css("position","fixed").css("top",newTop),typeof s.getWidthFrom!="undefined"&&s.stickyElement.css("width",$(s.getWidthFrom).width()),s.stickyElement.trigger("sticky-start",[s]).parent().addClass(s.className),s.currentTop=newTop))}},resizer=function(){var i,s;for(windowHeight=$window.height(),i=0;i<sticked.length;i++)s=sticked[i],typeof s.getWidthFrom!="undefined"&&s.responsiveWidth===!0&&s.stickyElement.css("width",$(s.getWidthFrom).width())},resizer=function(){var i,s;for(windowHeight=$window.height(),i=0;i<sticked.length;i++)s=sticked[i],s.stickyWrapper.css("height",s.stickyElement.outerHeight())},methods={init:function(options){var o=$.extend({},defaults,options);return this.each(function(){var stickyElement=$(this),stickyId=stickyElement.attr("id"),wrapperId=stickyId?stickyId+"-"+defaults.wrapperClassName:defaults.wrapperClassName,wrapper=$("<div><\/div>").attr("id",stickyId+"-sticky-wrapper").addClass(o.wrapperClassName),stickyWrapper;stickyElement.wrapAll(wrapper);o.center&&stickyElement.parent().css({width:stickyElement.outerWidth(),marginLeft:"auto",marginRight:"auto"});stickyElement.css("float")=="right"&&stickyElement.css({float:"none"}).parent().css({float:"right"});stickyWrapper=stickyElement.parent();stickyWrapper.css("height",stickyElement.outerHeight());sticked.push({topSpacing:o.topSpacing,bottomSpacing:o.bottomSpacing,stickyElement:stickyElement,currentTop:null,stickyWrapper:stickyWrapper,className:o.className,getWidthFrom:o.getWidthFrom,responsiveWidth:o.responsiveWidth})})},update:scroller,unstick:function(){return this.each(function(){for(var unstickyElement=$(this),removeIdx=-1,i=0;i<sticked.length;i++)sticked[i].stickyElement.get(0)==unstickyElement.get(0)&&(removeIdx=i);removeIdx!=-1&&(sticked.splice(removeIdx,1),unstickyElement.unwrap(),unstickyElement.removeAttr("style"))})}};window.addEventListener?(window.addEventListener("scroll",scroller,!1),window.addEventListener("resize",resizer,!1)):window.attachEvent&&(window.attachEvent("onscroll",scroller),window.attachEvent("onresize",resizer));$.fn.sticky=function(method){if(methods[method])return methods[method].apply(this,Array.prototype.slice.call(arguments,1));if(typeof method!="object"&&method)$.error("Method "+method+" does not exist on jQuery.sticky");else return methods.init.apply(this,arguments)};$.fn.unstick=function(method){if(methods[method])return methods[method].apply(this,Array.prototype.slice.call(arguments,1));if(typeof method!="object"&&method)$.error("Method "+method+" does not exist on jQuery.sticky");else return methods.unstick.apply(this,arguments)};$(function(){setTimeout(scroller,0)})}(jQuery),function($){$.extend($.fn,{swapClass:function(c1,c2){var c1Elements=this.filter("."+c1);return this.filter("."+c2).removeClass(c2).addClass(c1),c1Elements.removeClass(c1).addClass(c2),this},replaceClass:function(c1,c2){return this.filter("."+c1).removeClass(c1).addClass(c2).end()},hoverClass:function(className){return className=className||"hover",this.hover(function(){$(this).addClass(className)},function(){$(this).removeClass(className)})},heightToggle:function(animated,callback){animated?this.animate({height:"toggle"},animated,callback):this.each(function(){jQuery(this)[jQuery(this).is(":hidden")?"show":"hide"]();callback&&callback.apply(this,arguments)})},heightHide:function(animated,callback){animated?this.animate({height:"hide"},animated,callback):(this.hide(),callback&&this.each(callback))},prepareBranches:function(settings){return settings.prerendered||(this.filter(":last-child:not(ul)").addClass(CLASSES.last),this.filter((settings.collapsed?"":"."+CLASSES.closed)+":not(."+CLASSES.open+")").find(">ul").hide()),this.filter(":has(>ul)")},applyClasses:function(settings,toggler){if(this.filter(":has(>ul):not(:has(>a))").find(">span").unbind("click.treeview").bind("click.treeview",function(event){this==event.target&&toggler.apply($(this).next())}).add($("a",this)).hoverClass(),!settings.prerendered){this.filter(":has(>ul:hidden)").addClass(CLASSES.expandable).replaceClass(CLASSES.last,CLASSES.lastExpandable);this.not(":has(>ul:hidden)").addClass(CLASSES.collapsable).replaceClass(CLASSES.last,CLASSES.lastCollapsable);var hitarea=this.find("div."+CLASSES.hitarea);hitarea.length||(hitarea=this.prepend('<div class="'+CLASSES.hitarea+'"/>').find("div."+CLASSES.hitarea));hitarea.removeClass().addClass(CLASSES.hitarea).each(function(){var classes="";$.each($(this).parent().attr("class").split(" "),function(){classes+=this+"-hitarea "});$(this).addClass(classes)})}this.find("div."+CLASSES.hitarea).click(toggler)},treeview:function(settings){function treeController(tree,control){function handler(filter){return function(){return toggler.apply($("div."+CLASSES.hitarea,tree).filter(function(){return filter?$(this).parent("."+filter).length:!0})),!1}}$("a:eq(0)",control).click(handler(CLASSES.collapsable));$("a:eq(1)",control).click(handler(CLASSES.expandable));$("a:eq(2)",control).click(handler())}function toggler(){$(this).parent().find(">.hitarea").swapClass(CLASSES.collapsableHitarea,CLASSES.expandableHitarea).swapClass(CLASSES.lastCollapsableHitarea,CLASSES.lastExpandableHitarea).end().swapClass(CLASSES.collapsable,CLASSES.expandable).swapClass(CLASSES.lastCollapsable,CLASSES.lastExpandable).find(">ul").heightToggle(settings.animated,settings.toggle);settings.unique&&$(this).parent().siblings().find(">.hitarea").replaceClass(CLASSES.collapsableHitarea,CLASSES.expandableHitarea).replaceClass(CLASSES.lastCollapsableHitarea,CLASSES.lastExpandableHitarea).end().replaceClass(CLASSES.collapsable,CLASSES.expandable).replaceClass(CLASSES.lastCollapsable,CLASSES.lastExpandable).find(">ul").heightHide(settings.animated,settings.toggle)}function serialize(){var data=[];branches.each(function(i,e){data[i]=$(e).is(":has(>ul:visible)")?1:0});$.cookie(settings.cookieId,data.join(""),settings.cookieOptions)}function deserialize(){var stored=$.cookie(settings.cookieId),data;stored&&(data=stored.split(""),branches.each(function(i,e){$(e).find(">ul")[parseInt(data[i])?"show":"hide"]()}))}var callback,branches,toggleCallback,current,items;settings=$.extend({cookieId:"treeview"},settings);settings.toggle&&(callback=settings.toggle,settings.toggle=function(){return callback.apply($(this).parent()[0],arguments)});this.data("toggler",toggler);this.addClass("treeview");branches=this.find("li").prepareBranches(settings);switch(settings.persist){case"cookie":toggleCallback=settings.toggle;settings.toggle=function(){serialize();toggleCallback&&toggleCallback.apply(this,arguments)};deserialize();break;case"location":current=this.find("a").filter(function(){return this.href.toLowerCase()==location.href.toLowerCase()});current.length&&(items=current.addClass("selected").parents("ul, li").add(current.next()).show(),settings.prerendered&&items.filter("li").swapClass(CLASSES.collapsable,CLASSES.expandable).swapClass(CLASSES.lastCollapsable,CLASSES.lastExpandable).find(">.hitarea").swapClass(CLASSES.collapsableHitarea,CLASSES.expandableHitarea).swapClass(CLASSES.lastCollapsableHitarea,CLASSES.lastExpandableHitarea))}return branches.applyClasses(settings,toggler),settings.control&&(treeController(this,settings.control),$(settings.control).show()),this}});$.treeview={};var CLASSES=$.treeview.classes={open:"open",closed:"closed",expandable:"expandable",expandableHitarea:"expandable-hitarea",lastExpandableHitarea:"lastExpandable-hitarea",collapsable:"collapsable",collapsableHitarea:"collapsable-hitarea",lastCollapsableHitarea:"lastCollapsable-hitarea",lastCollapsable:"lastCollapsable",lastExpandable:"lastExpandable",last:"last",hitarea:"hitarea"}}(jQuery),function(factory){"use strict";typeof define=="function"&&define.amd?define(["jquery"],factory):typeof exports=="object"?factory(require("jquery")):factory(jQuery)}(function($,undefined){"use strict";
/*!
 * jsTree 3.0.8
 * http://jstree.com/
 *
 * Copyright (c) 2014 Ivan Bozhanov (http://vakata.com)
 *
 * Licensed same as jquery - under the terms of the MIT License
 *   http://www.opensource.org/licenses/mit-license.php
 */
/*!
 * if using jslint please allow for the jQuery global and use following options: 
 * jslint: browser: true, ass: true, bitwise: true, continue: true, nomen: true, plusplus: true, regexp: true, unparam: true, todo: true, white: true
 */
var _i,to,div;if(!$.jstree){var instance_counter=0,ccp_node=!1,ccp_mode=!1,ccp_inst=!1,themes_loaded=[],src=$("script:last").attr("src"),_d=document,_node=_d.createElement("LI"),_temp1,_temp2;_node.setAttribute("role","treeitem");_temp1=_d.createElement("I");_temp1.className="jstree-icon jstree-ocl";_temp1.setAttribute("role","presentation");_node.appendChild(_temp1);_temp1=_d.createElement("A");_temp1.className="jstree-anchor";_temp1.setAttribute("href","#");_temp1.setAttribute("tabindex","-1");_temp2=_d.createElement("I");_temp2.className="jstree-icon jstree-themeicon";_temp2.setAttribute("role","presentation");_temp1.appendChild(_temp2);_node.appendChild(_temp1);_temp1=_temp2=null;$.jstree={version:"3.0.8",defaults:{plugins:[]},plugins:{},path:src&&src.indexOf("/")!==-1?src.replace(/\/[^\/]+$/,""):"",idregex:/[\\:&!^|()\[\]<>@*'+~#";.,=\- \/${}%]/g};$.jstree.create=function(el,options){var tmp=new $.jstree.core(++instance_counter),opt=options;return options=$.extend(!0,{},$.jstree.defaults,options),opt&&opt.plugins&&(options.plugins=opt.plugins),$.each(options.plugins,function(i,k){i!=="core"&&(tmp=tmp.plugin(k,options[k]))}),tmp.init(el,options),tmp};$.jstree.destroy=function(){$(".jstree:jstree").jstree("destroy");$(document).off(".jstree")};$.jstree.core=function(id){this._id=id;this._cnt=0;this._wrk=null;this._data={core:{themes:{name:!1,dots:!1,icons:!1},selected:[],last_error:{},working:!1,worker_queue:[],focused:null}}};$.jstree.reference=function(needle){var tmp=null,obj=null;if(needle&&needle.id&&(needle=needle.id),!obj||!obj.length)try{obj=$(needle)}catch(ignore){}if(!obj||!obj.length)try{obj=$("#"+needle.replace($.jstree.idregex,"\\$&"))}catch(ignore){}return obj&&obj.length&&(obj=obj.closest(".jstree")).length&&(obj=obj.data("jstree"))?tmp=obj:$(".jstree").each(function(){var inst=$(this).data("jstree");if(inst&&inst._model.data[needle])return tmp=inst,!1}),tmp};$.fn.jstree=function(arg){var is_method=typeof arg=="string",args=Array.prototype.slice.call(arguments,1),result=null;return arg===!0&&!this.length?!1:(this.each(function(){var instance=$.jstree.reference(this),method=is_method&&instance?instance[arg]:null;return result=is_method&&method?method.apply(instance,args):null,instance||is_method||arg!==undefined&&!$.isPlainObject(arg)||$(this).data("jstree",new $.jstree.create(this,arg)),(instance&&!is_method||arg===!0)&&(result=instance||!1),result!==null&&result!==undefined?!1:void 0}),result!==null&&result!==undefined?result:this)};$.expr[":"].jstree=$.expr.createPseudo(function(){return function(a){return $(a).hasClass("jstree")&&$(a).data("jstree")!==undefined}});$.jstree.defaults.core={data:!1,strings:!1,check_callback:!1,error:$.noop,animation:200,multiple:!0,themes:{name:!1,url:!1,dir:!1,dots:!0,icons:!0,stripes:!1,variant:!1,responsive:!1},expand_selected_onload:!0,worker:!0,force_text:!1};$.jstree.core.prototype={plugin:function(deco,opts){var Child=$.jstree.plugins[deco];return Child?(this._data[deco]={},Child.prototype=this,new Child(opts,this)):this},init:function(el,options){this._model={data:{"#":{id:"#",parent:null,parents:[],children:[],children_d:[],state:{loaded:!1}}},changed:[],force_full_redraw:!1,redraw_timeout:!1,default_state:{loaded:!0,opened:!1,selected:!1,disabled:!1}};this.element=$(el).addClass("jstree jstree-"+this._id);this.settings=options;this.element.bind("destroyed",$.proxy(this.teardown,this));this._data.core.ready=!1;this._data.core.loaded=!1;this._data.core.rtl=this.element.css("direction")==="rtl";this.element[this._data.core.rtl?"addClass":"removeClass"]("jstree-rtl");this.element.attr("role","tree");this.settings.core.multiple&&this.element.attr("aria-multiselectable",!0);this.element.attr("tabindex")||this.element.attr("tabindex","0");this.bind();this.trigger("init");this._data.core.original_container_html=this.element.find(" > ul > li").clone(!0);this._data.core.original_container_html.find("li").addBack().contents().filter(function(){return this.nodeType===3&&(!this.nodeValue||/^\s+$/.test(this.nodeValue))}).remove();this.element.html("<ul class='jstree-container-ul jstree-children' role='group'><li id='j"+this._id+"_loading' class='jstree-initial-node jstree-loading jstree-leaf jstree-last' role='tree-item'><i class='jstree-icon jstree-ocl'><\/i><a class='jstree-anchor' href='#'><i class='jstree-icon jstree-themeicon-hidden'><\/i>"+this.get_string("Loading ...")+"<\/a><\/li><\/ul>");this.element.attr("aria-activedescendant","j"+this._id+"_loading");this._data.core.li_height=this.get_container_ul().children("li").first().height()||24;this.trigger("loading");this.load_node("#")},destroy:function(keep_html){if(this._wrk)try{window.URL.revokeObjectURL(this._wrk);this._wrk=null}catch(ignore){}keep_html||this.element.empty();this.element.unbind("destroyed",this.teardown);this.teardown()},teardown:function(){this.unbind();this.element.removeClass("jstree").removeData("jstree").find("[class^='jstree']").addBack().attr("class",function(){return this.className.replace(/jstree[^ ]*|$/ig,"")});this.element=null},bind:function(){var word="",tout=null;this.element.on("dblclick.jstree",function(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var sel=window.getSelection();try{sel.removeAllRanges();sel.collapse()}catch(ignore){}}}).on("click.jstree",".jstree-ocl",$.proxy(function(e){this.toggle_node(e.target)},this)).on("click.jstree",".jstree-anchor",$.proxy(function(e){e.preventDefault();e.currentTarget!==document.activeElement&&$(e.currentTarget).focus();this.activate_node(e.currentTarget,e)},this)).on("keydown.jstree",".jstree-anchor",$.proxy(function(e){if(e.target.tagName==="INPUT")return!0;var o=null;this._data.core.rtl&&(e.which===37?e.which=39:e.which===39&&(e.which=37));switch(e.which){case 32:e.ctrlKey&&(e.type="click",$(e.currentTarget).trigger(e));break;case 13:e.type="click";$(e.currentTarget).trigger(e);break;case 37:e.preventDefault();this.is_open(e.currentTarget)?this.close_node(e.currentTarget):(o=this.get_parent(e.currentTarget),o&&o.id!=="#"&&this.get_node(o,!0).children(".jstree-anchor").focus());break;case 38:e.preventDefault();o=this.get_prev_dom(e.currentTarget);o&&o.length&&o.children(".jstree-anchor").focus();break;case 39:e.preventDefault();this.is_closed(e.currentTarget)?this.open_node(e.currentTarget,function(o){this.get_node(o,!0).children(".jstree-anchor").focus()}):this.is_open(e.currentTarget)&&(o=this.get_node(e.currentTarget,!0).children(".jstree-children")[0],o&&$(this._firstChild(o)).children(".jstree-anchor").focus());break;case 40:e.preventDefault();o=this.get_next_dom(e.currentTarget);o&&o.length&&o.children(".jstree-anchor").focus();break;case 106:this.open_all();break;case 36:e.preventDefault();o=this._firstChild(this.get_container_ul()[0]);o&&$(o).children(".jstree-anchor").filter(":visible").focus();break;case 35:e.preventDefault();this.element.find(".jstree-anchor").filter(":visible").last().focus()}},this)).on("load_node.jstree",$.proxy(function(e,data){if(data.status&&(data.node.id!=="#"||this._data.core.loaded||(this._data.core.loaded=!0,this._firstChild(this.get_container_ul()[0])&&this.element.attr("aria-activedescendant",this._firstChild(this.get_container_ul()[0]).id),this.trigger("loaded")),!this._data.core.ready&&!this.get_container_ul().find(".jstree-loading").length)){if(this._data.core.ready=!0,this._data.core.selected.length){if(this.settings.core.expand_selected_onload){for(var tmp=[],i=0,j=this._data.core.selected.length;i<j;i++)tmp=tmp.concat(this._model.data[this._data.core.selected[i]].parents);for(tmp=$.vakata.array_unique(tmp),i=0,j=tmp.length;i<j;i++)this.open_node(tmp[i],!1,0)}this.trigger("changed",{action:"ready",selected:this._data.core.selected})}setTimeout($.proxy(function(){this.trigger("ready")},this),0)}},this)).on("keypress.jstree",$.proxy(function(e){if(e.target.tagName==="INPUT")return!0;tout&&clearTimeout(tout);tout=setTimeout(function(){word=""},500);var chr=String.fromCharCode(e.which).toLowerCase(),col=this.element.find(".jstree-anchor").filter(":visible"),ind=col.index(document.activeElement)||0,end=!1;if(word+=chr,word.length>1){if(col.slice(ind).each($.proxy(function(i,v){if($(v).text().toLowerCase().indexOf(word)===0)return $(v).focus(),end=!0,!1},this)),end)return;if(col.slice(0,ind).each($.proxy(function(i,v){if($(v).text().toLowerCase().indexOf(word)===0)return $(v).focus(),end=!0,!1},this)),end)return}if(new RegExp("^"+chr+"+$").test(word)){if(col.slice(ind+1).each($.proxy(function(i,v){if($(v).text().toLowerCase().charAt(0)===chr)return $(v).focus(),end=!0,!1},this)),end)return;if(col.slice(0,ind+1).each($.proxy(function(i,v){if($(v).text().toLowerCase().charAt(0)===chr)return $(v).focus(),end=!0,!1},this)),end)return}},this)).on("init.jstree",$.proxy(function(){var s=this.settings.core.themes;this._data.core.themes.dots=s.dots;this._data.core.themes.stripes=s.stripes;this._data.core.themes.icons=s.icons;this.set_theme(s.name||"default",s.url);this.set_theme_variant(s.variant)},this)).on("loading.jstree",$.proxy(function(){this[this._data.core.themes.dots?"show_dots":"hide_dots"]();this[this._data.core.themes.icons?"show_icons":"hide_icons"]();this[this._data.core.themes.stripes?"show_stripes":"hide_stripes"]()},this)).on("blur.jstree",".jstree-anchor",$.proxy(function(e){this._data.core.focused=null;$(e.currentTarget).filter(".jstree-hovered").mouseleave()},this)).on("focus.jstree",".jstree-anchor",$.proxy(function(e){var tmp=this.get_node(e.currentTarget);tmp&&tmp.id&&(this._data.core.focused=tmp.id);this.element.find(".jstree-hovered").not(e.currentTarget).mouseleave();$(e.currentTarget).mouseenter()},this)).on("focus.jstree",$.proxy(function(){this._data.core.focused||this.get_node(this.element.attr("aria-activedescendant"),!0).find("> .jstree-anchor").focus()},this)).on("mouseenter.jstree",".jstree-anchor",$.proxy(function(e){this.hover_node(e.currentTarget)},this)).on("mouseleave.jstree",".jstree-anchor",$.proxy(function(e){this.dehover_node(e.currentTarget)},this))},unbind:function(){this.element.off(".jstree");$(document).off(".jstree-"+this._id)},trigger:function(ev,data){data||(data={});data.instance=this;this.element.triggerHandler(ev.replace(".jstree","")+".jstree",data)},get_container:function(){return this.element},get_container_ul:function(){return this.element.children(".jstree-children").first()},get_string:function(key){var a=this.settings.core.strings;return $.isFunction(a)?a.call(this,key):a&&a[key]?a[key]:key},_firstChild:function(dom){for(dom=dom?dom.firstChild:null;dom!==null&&dom.nodeType!==1;)dom=dom.nextSibling;return dom},_nextSibling:function(dom){for(dom=dom?dom.nextSibling:null;dom!==null&&dom.nodeType!==1;)dom=dom.nextSibling;return dom},_previousSibling:function(dom){for(dom=dom?dom.previousSibling:null;dom!==null&&dom.nodeType!==1;)dom=dom.previousSibling;return dom},get_node:function(obj,as_dom){obj&&obj.id&&(obj=obj.id);var dom;try{if(this._model.data[obj])obj=this._model.data[obj];else if(typeof obj=="string"&&this._model.data[obj.replace(/^#/,"")])obj=this._model.data[obj.replace(/^#/,"")];else if(typeof obj=="string"&&(dom=$("#"+obj.replace($.jstree.idregex,"\\$&"),this.element)).length&&this._model.data[dom.closest(".jstree-node").attr("id")])obj=this._model.data[dom.closest(".jstree-node").attr("id")];else if((dom=$(obj,this.element)).length&&this._model.data[dom.closest(".jstree-node").attr("id")])obj=this._model.data[dom.closest(".jstree-node").attr("id")];else if((dom=$(obj,this.element)).length&&dom.hasClass("jstree"))obj=this._model.data["#"];else return!1;return as_dom&&(obj=obj.id==="#"?this.element:$("#"+obj.id.replace($.jstree.idregex,"\\$&"),this.element)),obj}catch(ex){return!1}},get_path:function(obj,glue,ids){if(obj=obj.parents?obj:this.get_node(obj),!obj||obj.id==="#"||!obj.parents)return!1;var i,j,p=[];for(p.push(ids?obj.id:obj.text),i=0,j=obj.parents.length;i<j;i++)p.push(ids?obj.parents[i]:this.get_text(obj.parents[i]));return p=p.reverse().slice(1),glue?p.join(glue):p},get_next_dom:function(obj,strict){var tmp;if(obj=this.get_node(obj,!0),obj[0]===this.element[0]){for(tmp=this._firstChild(this.get_container_ul()[0]);tmp&&tmp.offsetHeight===0;)tmp=this._nextSibling(tmp);return tmp?$(tmp):!1}if(!obj||!obj.length)return!1;if(strict){tmp=obj[0];do tmp=this._nextSibling(tmp);while(tmp&&tmp.offsetHeight===0);return tmp?$(tmp):!1}if(obj.hasClass("jstree-open")){for(tmp=this._firstChild(obj.children(".jstree-children")[0]);tmp&&tmp.offsetHeight===0;)tmp=this._nextSibling(tmp);if(tmp!==null)return $(tmp)}tmp=obj[0];do tmp=this._nextSibling(tmp);while(tmp&&tmp.offsetHeight===0);return tmp!==null?$(tmp):obj.parentsUntil(".jstree",".jstree-node").next(".jstree-node:visible").first()},get_prev_dom:function(obj,strict){var tmp;if(obj=this.get_node(obj,!0),obj[0]===this.element[0]){for(tmp=this.get_container_ul()[0].lastChild;tmp&&tmp.offsetHeight===0;)tmp=this._previousSibling(tmp);return tmp?$(tmp):!1}if(!obj||!obj.length)return!1;if(strict){tmp=obj[0];do tmp=this._previousSibling(tmp);while(tmp&&tmp.offsetHeight===0);return tmp?$(tmp):!1}tmp=obj[0];do tmp=this._previousSibling(tmp);while(tmp&&tmp.offsetHeight===0);if(tmp!==null){for(obj=$(tmp);obj.hasClass("jstree-open");)obj=obj.children(".jstree-children").first().children(".jstree-node:visible:last");return obj}return tmp=obj[0].parentNode.parentNode,tmp&&tmp.className&&tmp.className.indexOf("jstree-node")!==-1?$(tmp):!1},get_parent:function(obj){return(obj=this.get_node(obj),!obj||obj.id==="#")?!1:obj.parent},get_children_dom:function(obj){return(obj=this.get_node(obj,!0),obj[0]===this.element[0])?this.get_container_ul().children(".jstree-node"):!obj||!obj.length?!1:obj.children(".jstree-children").children(".jstree-node")},is_parent:function(obj){return obj=this.get_node(obj),obj&&(obj.state.loaded===!1||obj.children.length>0)},is_loaded:function(obj){return obj=this.get_node(obj),obj&&obj.state.loaded},is_loading:function(obj){return obj=this.get_node(obj),obj&&obj.state&&obj.state.loading},is_open:function(obj){return obj=this.get_node(obj),obj&&obj.state.opened},is_closed:function(obj){return obj=this.get_node(obj),obj&&this.is_parent(obj)&&!obj.state.opened},is_leaf:function(obj){return!this.is_parent(obj)},load_node:function(obj,callback){var k,l,i,j,c;if($.isArray(obj))return this._load_nodes(obj.slice(),callback),!0;if(obj=this.get_node(obj),!obj)return callback&&callback.call(this,obj,!1),!1;if(obj.state.loaded){for(obj.state.loaded=!1,k=0,l=obj.children_d.length;k<l;k++){for(i=0,j=obj.parents.length;i<j;i++)this._model.data[obj.parents[i]].children_d=$.vakata.array_remove_item(this._model.data[obj.parents[i]].children_d,obj.children_d[k]);this._model.data[obj.children_d[k]].state.selected&&(c=!0,this._data.core.selected=$.vakata.array_remove_item(this._data.core.selected,obj.children_d[k]));delete this._model.data[obj.children_d[k]]}obj.children=[];obj.children_d=[];c&&this.trigger("changed",{action:"load_node",node:obj,selected:this._data.core.selected})}return obj.state.loading=!0,this.get_node(obj,!0).addClass("jstree-loading").attr("aria-busy",!0),this._load_node(obj,$.proxy(function(status){obj=this._model.data[obj.id];obj.state.loading=!1;obj.state.loaded=status;var dom=this.get_node(obj,!0);obj.state.loaded&&!obj.children.length&&dom&&dom.length&&!dom.hasClass("jstree-leaf")&&dom.removeClass("jstree-closed jstree-open").addClass("jstree-leaf");dom.removeClass("jstree-loading").attr("aria-busy",!1);this.trigger("load_node",{node:obj,status:status});callback&&callback.call(this,obj,status)},this)),!0},_load_nodes:function(nodes,callback,is_callback){for(var r=!0,c=function(){this._load_nodes(nodes,callback,!0)},m=this._model.data,i=0,j=nodes.length;i<j;i++)!m[nodes[i]]||m[nodes[i]].state.loaded&&is_callback||(this.is_loading(nodes[i])||this.load_node(nodes[i],c),r=!1);r&&callback&&!callback.done&&(callback.call(this,nodes),callback.done=!0)},load_all:function(obj,callback){if(obj||(obj="#"),obj=this.get_node(obj),!obj)return!1;var to_load=[],m=this._model.data,c=m[obj.id].children_d,i,j;for(obj.state&&!obj.state.loaded&&to_load.push(obj.id),i=0,j=c.length;i<j;i++)m[c[i]]&&m[c[i]].state&&!m[c[i]].state.loaded&&to_load.push(c[i]);to_load.length?this._load_nodes(to_load,function(){this.load_all(obj,callback)}):(callback&&callback.call(this,obj),this.trigger("load_all",{node:obj}))},_load_node:function(obj,callback){var s=this.settings.core.data,t;return s?$.isFunction(s)?s.call(this,obj,$.proxy(function(d){d===!1&&callback.call(this,!1);this[typeof d=="string"?"_append_html_data":"_append_json_data"](obj,typeof d=="string"?$(d):d,function(status){callback.call(this,status)})},this)):typeof s=="object"?s.url?(s=$.extend(!0,{},s),$.isFunction(s.url)&&(s.url=s.url.call(this,obj)),$.isFunction(s.data)&&(s.data=s.data.call(this,obj)),$.ajax(s).done($.proxy(function(d,t,x){var type=x.getResponseHeader("Content-Type");return type.indexOf("json")!==-1||typeof d=="object"?this._append_json_data(obj,d,function(status){callback.call(this,status)}):type.indexOf("html")!==-1||typeof d=="string"?this._append_html_data(obj,$(d),function(status){callback.call(this,status)}):(this._data.core.last_error={error:"ajax",plugin:"core",id:"core_04",reason:"Could not load node",data:JSON.stringify({id:obj.id,xhr:x})},this.settings.core.error.call(this,this._data.core.last_error),callback.call(this,!1))},this)).fail($.proxy(function(f){callback.call(this,!1);this._data.core.last_error={error:"ajax",plugin:"core",id:"core_04",reason:"Could not load node",data:JSON.stringify({id:obj.id,xhr:f})};this.settings.core.error.call(this,this._data.core.last_error)},this))):(t=$.isArray(s)||$.isPlainObject(s)?JSON.parse(JSON.stringify(s)):s,obj.id==="#"?this._append_json_data(obj,t,function(status){callback.call(this,status)}):(this._data.core.last_error={error:"nodata",plugin:"core",id:"core_05",reason:"Could not load node",data:JSON.stringify({id:obj.id})},this.settings.core.error.call(this,this._data.core.last_error),callback.call(this,!1))):typeof s=="string"?obj.id==="#"?this._append_html_data(obj,$(s),function(status){callback.call(this,status)}):(this._data.core.last_error={error:"nodata",plugin:"core",id:"core_06",reason:"Could not load node",data:JSON.stringify({id:obj.id})},this.settings.core.error.call(this,this._data.core.last_error),callback.call(this,!1)):callback.call(this,!1):obj.id==="#"?this._append_html_data(obj,this._data.core.original_container_html.clone(!0),function(status){callback.call(this,status)}):callback.call(this,!1)},_node_changed:function(obj){obj=this.get_node(obj);obj&&this._model.changed.push(obj.id)},_append_html_data:function(dom,data,cb){dom=this.get_node(dom);dom.children=[];dom.children_d=[];var dat=data.is("ul")?data.children():data,par=dom.id,chd=[],dpc=[],m=this._model.data,p=m[par],s=this._data.core.selected.length,tmp,i,j;for(dat.each($.proxy(function(i,v){tmp=this._parse_model_from_html($(v),par,p.parents.concat());tmp&&(chd.push(tmp),dpc.push(tmp),m[tmp].children_d.length&&(dpc=dpc.concat(m[tmp].children_d)))},this)),p.children=chd,p.children_d=dpc,i=0,j=p.parents.length;i<j;i++)m[p.parents[i]].children_d=m[p.parents[i]].children_d.concat(dpc);this.trigger("model",{nodes:dpc,parent:par});par!=="#"?(this._node_changed(par),this.redraw()):(this.get_container_ul().children(".jstree-initial-node").remove(),this.redraw(!0));this._data.core.selected.length!==s&&this.trigger("changed",{action:"model",selected:this._data.core.selected});cb.call(this,!0)},_append_json_data:function(dom,data,cb,force_processing){dom=this.get_node(dom);dom.children=[];dom.children_d=[];data.d&&(data=data.d,typeof data=="string"&&(data=JSON.parse(data)));$.isArray(data)||(data=[data]);var w=null,args={df:this._model.default_state,dat:data,par:dom.id,m:this._model.data,t_id:this._id,t_cnt:this._cnt,sel:this._data.core.selected},func=function(data,undefined){data.data&&(data=data.data);var dat=data.dat,par=data.par,chd=[],dpc=[],add=[],df=data.df,t_id=data.t_id,t_cnt=data.t_cnt,m=data.m,p=m[par],sel=data.sel,tmp,i,j,rslt,parse_flat=function(d,p,ps){ps=ps?ps.concat():[];p&&ps.unshift(p);var tid=d.id.toString(),i,j,c,e,tmp={id:tid,text:d.text||"",icon:d.icon!==undefined?d.icon:!0,parent:p,parents:ps,children:d.children||[],children_d:d.children_d||[],data:d.data,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(i in df)df.hasOwnProperty(i)&&(tmp.state[i]=df[i]);if(d&&d.data&&d.data.jstree&&d.data.jstree.icon&&(tmp.icon=d.data.jstree.icon),d&&d.data&&(tmp.data=d.data,d.data.jstree))for(i in d.data.jstree)d.data.jstree.hasOwnProperty(i)&&(tmp.state[i]=d.data.jstree[i]);if(d&&typeof d.state=="object")for(i in d.state)d.state.hasOwnProperty(i)&&(tmp.state[i]=d.state[i]);if(d&&typeof d.li_attr=="object")for(i in d.li_attr)d.li_attr.hasOwnProperty(i)&&(tmp.li_attr[i]=d.li_attr[i]);if(tmp.li_attr.id||(tmp.li_attr.id=tid),d&&typeof d.a_attr=="object")for(i in d.a_attr)d.a_attr.hasOwnProperty(i)&&(tmp.a_attr[i]=d.a_attr[i]);for(d&&d.children&&d.children===!0&&(tmp.state.loaded=!1,tmp.children=[],tmp.children_d=[]),m[tmp.id]=tmp,i=0,j=tmp.children.length;i<j;i++)c=parse_flat(m[tmp.children[i]],tmp.id,ps),e=m[c],tmp.children_d.push(c),e.children_d.length&&(tmp.children_d=tmp.children_d.concat(e.children_d));return delete d.data,delete d.children,m[tmp.id].original=d,tmp.state.selected&&add.push(tmp.id),tmp.id},parse_nest=function(d,p,ps){ps=ps?ps.concat():[];p&&ps.unshift(p);var tid=!1,i,j,c,e,tmp;do tid="j"+t_id+"_"+ ++t_cnt;while(m[tid]);tmp={id:!1,text:typeof d=="string"?d:"",icon:typeof d=="object"&&d.icon!==undefined?d.icon:!0,parent:p,parents:ps,children:[],children_d:[],data:null,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(i in df)df.hasOwnProperty(i)&&(tmp.state[i]=df[i]);if(d&&d.id&&(tmp.id=d.id.toString()),d&&d.text&&(tmp.text=d.text),d&&d.data&&d.data.jstree&&d.data.jstree.icon&&(tmp.icon=d.data.jstree.icon),d&&d.data&&(tmp.data=d.data,d.data.jstree))for(i in d.data.jstree)d.data.jstree.hasOwnProperty(i)&&(tmp.state[i]=d.data.jstree[i]);if(d&&typeof d.state=="object")for(i in d.state)d.state.hasOwnProperty(i)&&(tmp.state[i]=d.state[i]);if(d&&typeof d.li_attr=="object")for(i in d.li_attr)d.li_attr.hasOwnProperty(i)&&(tmp.li_attr[i]=d.li_attr[i]);if(tmp.li_attr.id&&!tmp.id&&(tmp.id=tmp.li_attr.id.toString()),tmp.id||(tmp.id=tid),tmp.li_attr.id||(tmp.li_attr.id=tmp.id),d&&typeof d.a_attr=="object")for(i in d.a_attr)d.a_attr.hasOwnProperty(i)&&(tmp.a_attr[i]=d.a_attr[i]);if(d&&d.children&&d.children.length){for(i=0,j=d.children.length;i<j;i++)c=parse_nest(d.children[i],tmp.id,ps),e=m[c],tmp.children.push(c),e.children_d.length&&(tmp.children_d=tmp.children_d.concat(e.children_d));tmp.children_d=tmp.children_d.concat(tmp.children)}return d&&d.children&&d.children===!0&&(tmp.state.loaded=!1,tmp.children=[],tmp.children_d=[]),delete d.data,delete d.children,tmp.original=d,m[tmp.id]=tmp,tmp.state.selected&&add.push(tmp.id),tmp.id};if(dat.length&&dat[0].id!==undefined&&dat[0].parent!==undefined){for(i=0,j=dat.length;i<j;i++)dat[i].children||(dat[i].children=[]),m[dat[i].id.toString()]=dat[i];for(i=0,j=dat.length;i<j;i++)m[dat[i].parent.toString()].children.push(dat[i].id.toString()),p.children_d.push(dat[i].id.toString());for(i=0,j=p.children.length;i<j;i++)tmp=parse_flat(m[p.children[i]],par,p.parents.concat()),dpc.push(tmp),m[tmp].children_d.length&&(dpc=dpc.concat(m[tmp].children_d));for(i=0,j=p.parents.length;i<j;i++)m[p.parents[i]].children_d=m[p.parents[i]].children_d.concat(dpc);rslt={cnt:t_cnt,mod:m,sel:sel,par:par,dpc:dpc,add:add}}else{for(i=0,j=dat.length;i<j;i++)tmp=parse_nest(dat[i],par,p.parents.concat()),tmp&&(chd.push(tmp),dpc.push(tmp),m[tmp].children_d.length&&(dpc=dpc.concat(m[tmp].children_d)));for(p.children=chd,p.children_d=dpc,i=0,j=p.parents.length;i<j;i++)m[p.parents[i]].children_d=m[p.parents[i]].children_d.concat(dpc);rslt={cnt:t_cnt,mod:m,sel:sel,par:par,dpc:dpc,add:add}}if(typeof window=="undefined"||typeof document=="undefined")postMessage(rslt);else return rslt},rslt=function(rslt,worker){if(this._cnt=rslt.cnt,this._model.data=rslt.mod,worker){var i,j,a=rslt.add,r=rslt.sel,s=this._data.core.selected.slice(),m=this._model.data;if(r.length!==s.length||$.vakata.array_unique(r.concat(s)).length!==r.length){for(i=0,j=r.length;i<j;i++)$.inArray(r[i],a)===-1&&$.inArray(r[i],s)===-1&&(m[r[i]].state.selected=!1);for(i=0,j=s.length;i<j;i++)$.inArray(s[i],r)===-1&&(m[s[i]].state.selected=!0)}}rslt.add.length&&(this._data.core.selected=this._data.core.selected.concat(rslt.add));this.trigger("model",{nodes:rslt.dpc,parent:rslt.par});rslt.par!=="#"?(this._node_changed(rslt.par),this.redraw()):this.redraw(!0);rslt.add.length&&this.trigger("changed",{action:"model",selected:this._data.core.selected});cb.call(this,!0)};if(this.settings.core.worker&&window.Blob&&window.URL&&window.Worker)try{this._wrk===null&&(this._wrk=window.URL.createObjectURL(new window.Blob(["self.onmessage = "+func.toString()],{type:"text/javascript"})));!this._data.core.working||force_processing?(this._data.core.working=!0,w=new window.Worker(this._wrk),w.onmessage=$.proxy(function(e){rslt.call(this,e.data,!0);try{w.terminate();w=null}catch(ignore){}this._data.core.worker_queue.length?this._append_json_data.apply(this,this._data.core.worker_queue.shift()):this._data.core.working=!1},this),args.par?w.postMessage(args):this._data.core.worker_queue.length?this._append_json_data.apply(this,this._data.core.worker_queue.shift()):this._data.core.working=!1):this._data.core.worker_queue.push([dom,data,cb,!0])}catch(e){rslt.call(this,func(args),!1);this._data.core.worker_queue.length?this._append_json_data.apply(this,this._data.core.worker_queue.shift()):this._data.core.working=!1}else rslt.call(this,func(args),!1)},_parse_model_from_html:function(d,p,ps){ps=ps?[].concat(ps):[];p&&ps.unshift(p);var c,e,m=this._model.data,data={id:!1,text:!1,icon:!0,parent:p,parents:ps,children:[],children_d:[],data:null,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1},i,tmp,tid;for(i in this._model.default_state)this._model.default_state.hasOwnProperty(i)&&(data.state[i]=this._model.default_state[i]);if(tmp=$.vakata.attributes(d,!0),$.each(tmp,function(i,v){if(v=$.trim(v),!v.length)return!0;data.li_attr[i]=v;i==="id"&&(data.id=v.toString())}),tmp=d.children("a").first(),tmp.length&&(tmp=$.vakata.attributes(tmp,!0),$.each(tmp,function(i,v){v=$.trim(v);v.length&&(data.a_attr[i]=v)})),tmp=d.children("a").first().length?d.children("a").first().clone():d.clone(),tmp.children("ins, i, ul").remove(),tmp=tmp.html(),tmp=$("<div />").html(tmp),data.text=this.settings.core.force_text?tmp.text():tmp.html(),tmp=d.data(),data.data=tmp?$.extend(!0,{},tmp):null,data.state.opened=d.hasClass("jstree-open"),data.state.selected=d.children("a").hasClass("jstree-clicked"),data.state.disabled=d.children("a").hasClass("jstree-disabled"),data.data&&data.data.jstree)for(i in data.data.jstree)data.data.jstree.hasOwnProperty(i)&&(data.state[i]=data.data.jstree[i]);tmp=d.children("a").children(".jstree-themeicon");tmp.length&&(data.icon=tmp.hasClass("jstree-themeicon-hidden")?!1:tmp.attr("rel"));data.state.icon&&(data.icon=data.state.icon);tmp=d.children("ul").children("li");do tid="j"+this._id+"_"+ ++this._cnt;while(m[tid]);return data.id=data.li_attr.id?data.li_attr.id.toString():tid,tmp.length?(tmp.each($.proxy(function(i,v){c=this._parse_model_from_html($(v),data.id,ps);e=this._model.data[c];data.children.push(c);e.children_d.length&&(data.children_d=data.children_d.concat(e.children_d))},this)),data.children_d=data.children_d.concat(data.children)):d.hasClass("jstree-closed")&&(data.state.loaded=!1),data.li_attr["class"]&&(data.li_attr["class"]=data.li_attr["class"].replace("jstree-closed","").replace("jstree-open","")),data.a_attr["class"]&&(data.a_attr["class"]=data.a_attr["class"].replace("jstree-clicked","").replace("jstree-disabled","")),m[data.id]=data,data.state.selected&&this._data.core.selected.push(data.id),data.id},_parse_model_from_flat_json:function(d,p,ps){ps=ps?ps.concat():[];p&&ps.unshift(p);var tid=d.id.toString(),m=this._model.data,df=this._model.default_state,i,j,c,e,tmp={id:tid,text:d.text||"",icon:d.icon!==undefined?d.icon:!0,parent:p,parents:ps,children:d.children||[],children_d:d.children_d||[],data:d.data,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(i in df)df.hasOwnProperty(i)&&(tmp.state[i]=df[i]);if(d&&d.data&&d.data.jstree&&d.data.jstree.icon&&(tmp.icon=d.data.jstree.icon),d&&d.data&&(tmp.data=d.data,d.data.jstree))for(i in d.data.jstree)d.data.jstree.hasOwnProperty(i)&&(tmp.state[i]=d.data.jstree[i]);if(d&&typeof d.state=="object")for(i in d.state)d.state.hasOwnProperty(i)&&(tmp.state[i]=d.state[i]);if(d&&typeof d.li_attr=="object")for(i in d.li_attr)d.li_attr.hasOwnProperty(i)&&(tmp.li_attr[i]=d.li_attr[i]);if(tmp.li_attr.id||(tmp.li_attr.id=tid),d&&typeof d.a_attr=="object")for(i in d.a_attr)d.a_attr.hasOwnProperty(i)&&(tmp.a_attr[i]=d.a_attr[i]);for(d&&d.children&&d.children===!0&&(tmp.state.loaded=!1,tmp.children=[],tmp.children_d=[]),m[tmp.id]=tmp,i=0,j=tmp.children.length;i<j;i++)c=this._parse_model_from_flat_json(m[tmp.children[i]],tmp.id,ps),e=m[c],tmp.children_d.push(c),e.children_d.length&&(tmp.children_d=tmp.children_d.concat(e.children_d));return delete d.data,delete d.children,m[tmp.id].original=d,tmp.state.selected&&this._data.core.selected.push(tmp.id),tmp.id},_parse_model_from_json:function(d,p,ps){ps=ps?ps.concat():[];p&&ps.unshift(p);var tid=!1,i,j,c,e,m=this._model.data,df=this._model.default_state,tmp;do tid="j"+this._id+"_"+ ++this._cnt;while(m[tid]);tmp={id:!1,text:typeof d=="string"?d:"",icon:typeof d=="object"&&d.icon!==undefined?d.icon:!0,parent:p,parents:ps,children:[],children_d:[],data:null,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(i in df)df.hasOwnProperty(i)&&(tmp.state[i]=df[i]);if(d&&d.id&&(tmp.id=d.id.toString()),d&&d.text&&(tmp.text=d.text),d&&d.data&&d.data.jstree&&d.data.jstree.icon&&(tmp.icon=d.data.jstree.icon),d&&d.data&&(tmp.data=d.data,d.data.jstree))for(i in d.data.jstree)d.data.jstree.hasOwnProperty(i)&&(tmp.state[i]=d.data.jstree[i]);if(d&&typeof d.state=="object")for(i in d.state)d.state.hasOwnProperty(i)&&(tmp.state[i]=d.state[i]);if(d&&typeof d.li_attr=="object")for(i in d.li_attr)d.li_attr.hasOwnProperty(i)&&(tmp.li_attr[i]=d.li_attr[i]);if(tmp.li_attr.id&&!tmp.id&&(tmp.id=tmp.li_attr.id.toString()),tmp.id||(tmp.id=tid),tmp.li_attr.id||(tmp.li_attr.id=tmp.id),d&&typeof d.a_attr=="object")for(i in d.a_attr)d.a_attr.hasOwnProperty(i)&&(tmp.a_attr[i]=d.a_attr[i]);if(d&&d.children&&d.children.length){for(i=0,j=d.children.length;i<j;i++)c=this._parse_model_from_json(d.children[i],tmp.id,ps),e=m[c],tmp.children.push(c),e.children_d.length&&(tmp.children_d=tmp.children_d.concat(e.children_d));tmp.children_d=tmp.children_d.concat(tmp.children)}return d&&d.children&&d.children===!0&&(tmp.state.loaded=!1,tmp.children=[],tmp.children_d=[]),delete d.data,delete d.children,tmp.original=d,m[tmp.id]=tmp,tmp.state.selected&&this._data.core.selected.push(tmp.id),tmp.id},_redraw:function(){for(var nodes=this._model.force_full_redraw?this._model.data["#"].children.concat([]):this._model.changed.concat([]),f=document.createElement("UL"),tmp,fe=this._data.core.focused,i=0,j=nodes.length;i<j;i++)tmp=this.redraw_node(nodes[i],!0,this._model.force_full_redraw),tmp&&this._model.force_full_redraw&&f.appendChild(tmp);this._model.force_full_redraw&&(f.className=this.get_container_ul()[0].className,f.setAttribute("role","group"),this.element.empty().append(f));fe!==null&&(tmp=this.get_node(fe,!0),tmp&&tmp.length&&tmp.children(".jstree-anchor")[0]!==document.activeElement?tmp.children(".jstree-anchor").focus():this._data.core.focused=null);this._model.force_full_redraw=!1;this._model.changed=[];this.trigger("redraw",{nodes:nodes})},redraw:function(full){full&&(this._model.force_full_redraw=!0);this._redraw()},redraw_node:function(node,deep,is_callback,force_render){var obj=this.get_node(node),par=!1,ind=!1,old=!1,i=!1,j=!1,k=!1,c="",d=document,m=this._model.data,f=!1,tmp=null;if(!obj)return!1;if(obj.id==="#")return this.redraw(!0);if(deep=deep||obj.children.length===0,node=document.querySelector?this.element[0].querySelector("#"+("0123456789".indexOf(obj.id[0])!==-1?"\\3"+obj.id[0]+" "+obj.id.substr(1).replace($.jstree.idregex,"\\$&"):obj.id.replace($.jstree.idregex,"\\$&"))):document.getElementById(obj.id),node)node=$(node),is_callback||(par=node.parent().parent()[0],par===this.element[0]&&(par=null),ind=node.index()),deep||!obj.children.length||node.children(".jstree-children").length||(deep=!0),deep||(old=node.children(".jstree-children")[0]),f=node.children(".jstree-anchor")[0]===document.activeElement,node.remove();else if(deep=!0,!is_callback){if(par=obj.parent!=="#"?$("#"+obj.parent.replace($.jstree.idregex,"\\$&"),this.element)[0]:null,par!==null&&(!par||!m[obj.parent].state.opened))return!1;ind=$.inArray(obj.id,par===null?m["#"].children:m[obj.parent].children)}node=_node.cloneNode(!0);c="jstree-node ";for(i in obj.li_attr)if(obj.li_attr.hasOwnProperty(i)){if(i==="id")continue;i!=="class"?node.setAttribute(i,obj.li_attr[i]):c+=obj.li_attr[i]}obj.a_attr.id||(obj.a_attr.id=obj.id+"_anchor");node.setAttribute("aria-selected",!!obj.state.selected);node.setAttribute("aria-level",obj.parents.length);node.setAttribute("aria-labelledby",obj.a_attr.id);obj.state.disabled&&node.setAttribute("aria-disabled",!0);obj.state.loaded&&!obj.children.length?c+=" jstree-leaf":(c+=obj.state.opened&&obj.state.loaded?" jstree-open":" jstree-closed",node.setAttribute("aria-expanded",obj.state.opened&&obj.state.loaded));obj.parent!==null&&m[obj.parent].children[m[obj.parent].children.length-1]===obj.id&&(c+=" jstree-last");node.id=obj.id;node.className=c;c=(obj.state.selected?" jstree-clicked":"")+(obj.state.disabled?" jstree-disabled":"");for(j in obj.a_attr)if(obj.a_attr.hasOwnProperty(j)){if(j==="href"&&obj.a_attr[j]==="#")continue;j!=="class"?node.childNodes[1].setAttribute(j,obj.a_attr[j]):c+=" "+obj.a_attr[j]}if(c.length&&(node.childNodes[1].className="jstree-anchor "+c),(obj.icon&&obj.icon!==!0||obj.icon===!1)&&(obj.icon===!1?node.childNodes[1].childNodes[0].className+=" jstree-themeicon-hidden":obj.icon.indexOf("/")===-1&&obj.icon.indexOf(".")===-1?node.childNodes[1].childNodes[0].className+=" "+obj.icon+" jstree-themeicon-custom":(node.childNodes[1].childNodes[0].style.backgroundImage="url("+obj.icon+")",node.childNodes[1].childNodes[0].style.backgroundPosition="center center",node.childNodes[1].childNodes[0].style.backgroundSize="auto",node.childNodes[1].childNodes[0].className+=" jstree-themeicon-custom")),this.settings.core.force_text?node.childNodes[1].appendChild(d.createTextNode(obj.text)):node.childNodes[1].innerHTML+=obj.text,deep&&obj.children.length&&(obj.state.opened||force_render)&&obj.state.loaded){for(k=d.createElement("UL"),k.setAttribute("role","group"),k.className="jstree-children",i=0,j=obj.children.length;i<j;i++)k.appendChild(this.redraw_node(obj.children[i],deep,!0));node.appendChild(k)}if(old&&node.appendChild(old),!is_callback){for(par||(par=this.element[0]),i=0,j=par.childNodes.length;i<j;i++)if(par.childNodes[i]&&par.childNodes[i].className&&par.childNodes[i].className.indexOf("jstree-children")!==-1){tmp=par.childNodes[i];break}tmp||(tmp=d.createElement("UL"),tmp.setAttribute("role","group"),tmp.className="jstree-children",par.appendChild(tmp));par=tmp;ind<par.childNodes.length?par.insertBefore(node,par.childNodes[ind]):par.appendChild(node);f&&node.childNodes[1].focus()}return obj.state.opened&&!obj.state.loaded&&(obj.state.opened=!1,setTimeout($.proxy(function(){this.open_node(obj.id,!1,0)},this),0)),node},open_node:function(obj,callback,animation){var t1,t2,d,t;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.open_node(obj[t1],callback,animation);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;if(animation=animation===undefined?this.settings.core.animation:animation,!this.is_closed(obj))return callback&&callback.call(this,obj,!1),!1;if(this.is_loaded(obj))d=this.get_node(obj,!0),t=this,d.length&&(obj.children.length&&!this._firstChild(d.children(".jstree-children")[0])&&(this.redraw_node(obj,!0,!1,!0),d=this.get_node(obj,!0)),animation?(this.trigger("before_open",{node:obj}),d.children(".jstree-children").css("display","none").end().removeClass("jstree-closed").addClass("jstree-open").attr("aria-expanded",!0).children(".jstree-children").stop(!0,!0).slideDown(animation,function(){this.style.display="";t.trigger("after_open",{node:obj})})):(this.trigger("before_open",{node:obj}),d[0].className=d[0].className.replace("jstree-closed","jstree-open"),d[0].setAttribute("aria-expanded",!0))),obj.state.opened=!0,callback&&callback.call(this,obj,!0),d.length||this.trigger("before_open",{node:obj}),this.trigger("open_node",{node:obj}),animation&&d.length||this.trigger("after_open",{node:obj});else{if(this.is_loading(obj))return setTimeout($.proxy(function(){this.open_node(obj,callback,animation)},this),500);this.load_node(obj,function(o,ok){return ok?this.open_node(o,callback,animation):callback?callback.call(this,o,!1):!1})}},_open_to:function(obj){if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;for(var p=obj.parents,i=0,j=p.length;i<j;i+=1)i!=="#"&&this.open_node(p[i],!1,0);return $("#"+obj.id.replace($.jstree.idregex,"\\$&"),this.element)},close_node:function(obj,animation){var t1,t2,t,d;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.close_node(obj[t1],animation);return!0}if((obj=this.get_node(obj),!obj||obj.id==="#")||this.is_closed(obj))return!1;animation=animation===undefined?this.settings.core.animation:animation;t=this;d=this.get_node(obj,!0);d.length&&(animation?d.children(".jstree-children").attr("style","display:block !important").end().removeClass("jstree-open").addClass("jstree-closed").attr("aria-expanded",!1).children(".jstree-children").stop(!0,!0).slideUp(animation,function(){this.style.display="";d.children(".jstree-children").remove();t.trigger("after_close",{node:obj})}):(d[0].className=d[0].className.replace("jstree-open","jstree-closed"),d.attr("aria-expanded",!1).children(".jstree-children").remove()));obj.state.opened=!1;this.trigger("close_node",{node:obj});animation&&d.length||this.trigger("after_close",{node:obj})},toggle_node:function(obj){var t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.toggle_node(obj[t1]);return!0}return this.is_closed(obj)?this.open_node(obj):this.is_open(obj)?this.close_node(obj):void 0},open_all:function(obj,animation,original_obj){if(obj||(obj="#"),obj=this.get_node(obj),!obj)return!1;var dom=obj.id==="#"?this.get_container_ul():this.get_node(obj,!0),i,j,_this;if(!dom.length){for(i=0,j=obj.children_d.length;i<j;i++)this.is_closed(this._model.data[obj.children_d[i]])&&(this._model.data[obj.children_d[i]].state.opened=!0);return this.trigger("open_all",{node:obj})}original_obj=original_obj||dom;_this=this;dom=this.is_closed(obj)?dom.find(".jstree-closed").addBack():dom.find(".jstree-closed");dom.each(function(){_this.open_node(this,function(node,status){status&&this.is_parent(node)&&this.open_all(node,animation,original_obj)},animation||0)});original_obj.find(".jstree-closed").length===0&&this.trigger("open_all",{node:this.get_node(original_obj)})},close_all:function(obj,animation){if(obj||(obj="#"),obj=this.get_node(obj),!obj)return!1;var dom=obj.id==="#"?this.get_container_ul():this.get_node(obj,!0),_this=this,i,j;if(!dom.length){for(i=0,j=obj.children_d.length;i<j;i++)this._model.data[obj.children_d[i]].state.opened=!1;return this.trigger("close_all",{node:obj})}dom=this.is_open(obj)?dom.find(".jstree-open").addBack():dom.find(".jstree-open");$(dom.get().reverse()).each(function(){_this.close_node(this,animation||0)});this.trigger("close_all",{node:obj})},is_disabled:function(obj){return obj=this.get_node(obj),obj&&obj.state&&obj.state.disabled},enable_node:function(obj){var t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.enable_node(obj[t1]);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;obj.state.disabled=!1;this.get_node(obj,!0).children(".jstree-anchor").removeClass("jstree-disabled").attr("aria-disabled",!1);this.trigger("enable_node",{node:obj})},disable_node:function(obj){var t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.disable_node(obj[t1]);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;obj.state.disabled=!0;this.get_node(obj,!0).children(".jstree-anchor").addClass("jstree-disabled").attr("aria-disabled",!0);this.trigger("disable_node",{node:obj})},activate_node:function(obj,e){if(this.is_disabled(obj))return!1;if(this._data.core.last_clicked=this._data.core.last_clicked&&this._data.core.last_clicked.id!==undefined?this.get_node(this._data.core.last_clicked.id):null,this._data.core.last_clicked&&!this._data.core.last_clicked.state.selected&&(this._data.core.last_clicked=null),!this._data.core.last_clicked&&this._data.core.selected.length&&(this._data.core.last_clicked=this.get_node(this._data.core.selected[this._data.core.selected.length-1])),this.settings.core.multiple&&(e.metaKey||e.ctrlKey||e.shiftKey)&&(!e.shiftKey||this._data.core.last_clicked&&this.get_parent(obj)&&this.get_parent(obj)===this._data.core.last_clicked.parent))if(e.shiftKey){for(var o=this.get_node(obj).id,l=this._data.core.last_clicked.id,p=this.get_node(this._data.core.last_clicked.parent).children,c=!1,i=0,j=p.length;i<j;i+=1)p[i]===o&&(c=!c),p[i]===l&&(c=!c),c||p[i]===o||p[i]===l?this.select_node(p[i],!0,!1,e):this.deselect_node(p[i],!0,e);this.trigger("changed",{action:"select_node",node:this.get_node(obj),selected:this._data.core.selected,event:e})}else this.is_selected(obj)?this.deselect_node(obj,!1,e):this.select_node(obj,!1,!1,e);else!this.settings.core.multiple&&(e.metaKey||e.ctrlKey||e.shiftKey)&&this.is_selected(obj)?this.deselect_node(obj,!1,e):(this.deselect_all(!0),this.select_node(obj,!1,!1,e),this._data.core.last_clicked=this.get_node(obj));this.trigger("activate_node",{node:this.get_node(obj)})},hover_node:function(obj){if(obj=this.get_node(obj,!0),!obj||!obj.length||obj.children(".jstree-hovered").length)return!1;var o=this.element.find(".jstree-hovered"),t=this.element;o&&o.length&&this.dehover_node(o);obj.children(".jstree-anchor").addClass("jstree-hovered");this.trigger("hover_node",{node:this.get_node(obj)});setTimeout(function(){t.attr("aria-activedescendant",obj[0].id)},0)},dehover_node:function(obj){if(obj=this.get_node(obj,!0),!obj||!obj.length||!obj.children(".jstree-hovered").length)return!1;obj.children(".jstree-anchor").removeClass("jstree-hovered");this.trigger("dehover_node",{node:this.get_node(obj)})},select_node:function(obj,supress_event,prevent_open,e){var dom,t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.select_node(obj[t1],supress_event,prevent_open,e);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;dom=this.get_node(obj,!0);obj.state.selected||(obj.state.selected=!0,this._data.core.selected.push(obj.id),prevent_open||(dom=this._open_to(obj)),dom&&dom.length&&dom.attr("aria-selected",!0).children(".jstree-anchor").addClass("jstree-clicked"),this.trigger("select_node",{node:obj,selected:this._data.core.selected,event:e}),supress_event||this.trigger("changed",{action:"select_node",node:obj,selected:this._data.core.selected,event:e}))},deselect_node:function(obj,supress_event,e){var t1,t2,dom;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.deselect_node(obj[t1],supress_event,e);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;dom=this.get_node(obj,!0);obj.state.selected&&(obj.state.selected=!1,this._data.core.selected=$.vakata.array_remove_item(this._data.core.selected,obj.id),dom.length&&dom.attr("aria-selected",!1).children(".jstree-anchor").removeClass("jstree-clicked"),this.trigger("deselect_node",{node:obj,selected:this._data.core.selected,event:e}),supress_event||this.trigger("changed",{action:"deselect_node",node:obj,selected:this._data.core.selected,event:e}))},select_all:function(supress_event){var tmp=this._data.core.selected.concat([]),i,j;for(this._data.core.selected=this._model.data["#"].children_d.concat(),i=0,j=this._data.core.selected.length;i<j;i++)this._model.data[this._data.core.selected[i]]&&(this._model.data[this._data.core.selected[i]].state.selected=!0);this.redraw(!0);this.trigger("select_all",{selected:this._data.core.selected});supress_event||this.trigger("changed",{action:"select_all",selected:this._data.core.selected,old_selection:tmp})},deselect_all:function(supress_event){for(var tmp=this._data.core.selected.concat([]),i=0,j=this._data.core.selected.length;i<j;i++)this._model.data[this._data.core.selected[i]]&&(this._model.data[this._data.core.selected[i]].state.selected=!1);this._data.core.selected=[];this.element.find(".jstree-clicked").removeClass("jstree-clicked").parent().attr("aria-selected",!1);this.trigger("deselect_all",{selected:this._data.core.selected,node:tmp});supress_event||this.trigger("changed",{action:"deselect_all",selected:this._data.core.selected,old_selection:tmp})},is_selected:function(obj){return(obj=this.get_node(obj),!obj||obj.id==="#")?!1:obj.state.selected},get_selected:function(full){return full?$.map(this._data.core.selected,$.proxy(function(i){return this.get_node(i)},this)):this._data.core.selected.slice()},get_top_selected:function(full){for(var tmp=this.get_selected(!0),obj={},k,l,i=0,j=tmp.length;i<j;i++)obj[tmp[i].id]=tmp[i];for(i=0,j=tmp.length;i<j;i++)for(k=0,l=tmp[i].children_d.length;k<l;k++)obj[tmp[i].children_d[k]]&&delete obj[tmp[i].children_d[k]];tmp=[];for(i in obj)obj.hasOwnProperty(i)&&tmp.push(i);return full?$.map(tmp,$.proxy(function(i){return this.get_node(i)},this)):tmp},get_bottom_selected:function(full){for(var tmp=this.get_selected(!0),obj=[],i=0,j=tmp.length;i<j;i++)tmp[i].children.length||obj.push(tmp[i].id);return full?$.map(obj,$.proxy(function(i){return this.get_node(i)},this)):obj},get_state:function(){var state={core:{open:[],scroll:{left:this.element.scrollLeft(),top:this.element.scrollTop()},selected:[]}};for(var i in this._model.data)this._model.data.hasOwnProperty(i)&&i!=="#"&&(this._model.data[i].state.opened&&state.core.open.push(i),this._model.data[i].state.selected&&state.core.selected.push(i));return state},set_state:function(state,callback){if(state){if(state.core){var res,n,t,_this;if(state.core.open)return $.isArray(state.core.open)?(res=!0,n=!1,t=this,$.each(state.core.open.concat([]),function(i,v){n=t.get_node(v);n&&(t.is_loaded(v)?(t.is_closed(v)&&t.open_node(v,!1,0),state&&state.core&&state.core.open&&$.vakata.array_remove_item(state.core.open,v)):(t.is_loading(v)||t.open_node(v,$.proxy(function(o,s){!s&&state&&state.core&&state.core.open&&$.vakata.array_remove_item(state.core.open,o.id);this.set_state(state,callback)},t),0),res=!1))}),res&&(delete state.core.open,this.set_state(state,callback)),!1):(delete state.core.open,this.set_state(state,callback),!1);if(state.core.scroll)return state.core.scroll&&state.core.scroll.left!==undefined&&this.element.scrollLeft(state.core.scroll.left),state.core.scroll&&state.core.scroll.top!==undefined&&this.element.scrollTop(state.core.scroll.top),delete state.core.scroll,this.set_state(state,callback),!1;
/*!
					if(state.core.themes) {
						if(state.core.themes.name) {
							this.set_theme(state.core.themes.name);
						}
						if(typeof state.core.themes.dots !== 'undefined') {
							this[ state.core.themes.dots ? "show_dots" : "hide_dots" ]();
						}
						if(typeof state.core.themes.icons !== 'undefined') {
							this[ state.core.themes.icons ? "show_icons" : "hide_icons" ]();
						}
						delete state.core.themes;
						delete state.core.open;
						this.set_state(state, callback);
						return false;
					}
					*/
if(state.core.selected)return _this=this,this.deselect_all(),$.each(state.core.selected,function(i,v){_this.select_node(v)}),delete state.core.selected,this.set_state(state,callback),!1;if($.isEmptyObject(state.core))return delete state.core,this.set_state(state,callback),!1}return $.isEmptyObject(state)?(state=null,callback&&callback.call(this),this.trigger("set_state"),!1):!0}return!1},refresh:function(skip_loading,forget_state){this._data.core.state=forget_state===!0?{}:this.get_state();forget_state&&$.isFunction(forget_state)&&(this._data.core.state=forget_state.call(this,this._data.core.state));this._cnt=0;this._model.data={"#":{id:"#",parent:null,parents:[],children:[],children_d:[],state:{loaded:!1}}};var c=this.get_container_ul()[0].className;skip_loading||(this.element.html("<ul class='"+c+"' role='group'><li class='jstree-initial-node jstree-loading jstree-leaf jstree-last' role='treeitem' id='j"+this._id+"_loading'><i class='jstree-icon jstree-ocl'><\/i><a class='jstree-anchor' href='#'><i class='jstree-icon jstree-themeicon-hidden'><\/i>"+this.get_string("Loading ...")+"<\/a><\/li><\/ul>"),this.element.attr("aria-activedescendant","j"+this._id+"_loading"));this.load_node("#",function(o,s){s&&(this.get_container_ul()[0].className=c,this._firstChild(this.get_container_ul()[0])&&this.element.attr("aria-activedescendant",this._firstChild(this.get_container_ul()[0]).id),this.set_state($.extend(!0,{},this._data.core.state),function(){this.trigger("refresh")}));this._data.core.state=null})},refresh_node:function(obj){if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;var opened=[],to_load=[],s=this._data.core.selected.concat([]);to_load.push(obj.id);obj.state.opened===!0&&opened.push(obj.id);this.get_node(obj,!0).find(".jstree-open").each(function(){opened.push(this.id)});this._load_nodes(to_load,$.proxy(function(nodes){this.open_node(opened,!1,0);this.select_node(this._data.core.selected);this.trigger("refresh_node",{node:obj,nodes:nodes})},this))},set_id:function(obj,id){if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;var i,j,m=this._model.data;for(id=id.toString(),m[obj.parent].children[$.inArray(obj.id,m[obj.parent].children)]=id,i=0,j=obj.parents.length;i<j;i++)m[obj.parents[i]].children_d[$.inArray(obj.id,m[obj.parents[i]].children_d)]=id;for(i=0,j=obj.children.length;i<j;i++)m[obj.children[i]].parent=id;for(i=0,j=obj.children_d.length;i<j;i++)m[obj.children_d[i]].parents[$.inArray(obj.id,m[obj.children_d[i]].parents)]=id;return i=$.inArray(obj.id,this._data.core.selected),i!==-1&&(this._data.core.selected[i]=id),i=this.get_node(obj.id,!0),i&&i.attr("id",id),delete m[obj.id],obj.id=id,m[id]=obj,!0},get_text:function(obj){return obj=this.get_node(obj),!obj||obj.id==="#"?!1:obj.text},set_text:function(obj,val){var t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.set_text(obj[t1],val);return!0}return(obj=this.get_node(obj),!obj||obj.id==="#")?!1:(obj.text=val,this.get_node(obj,!0).length&&this.redraw_node(obj.id),this.trigger("set_text",{obj:obj,text:val}),!0)},get_json:function(obj,options,flat){if(obj=this.get_node(obj||"#"),!obj)return!1;options&&options.flat&&!flat&&(flat=[]);var tmp={id:obj.id,text:obj.text,icon:this.get_icon(obj),li_attr:$.extend(!0,{},obj.li_attr),a_attr:$.extend(!0,{},obj.a_attr),state:{},data:options&&options.no_data?!1:$.extend(!0,{},obj.data)},i,j;if(options&&options.flat?tmp.parent=obj.parent:tmp.children=[],!options||!options.no_state)for(i in obj.state)obj.state.hasOwnProperty(i)&&(tmp.state[i]=obj.state[i]);if(options&&options.no_id&&(delete tmp.id,tmp.li_attr&&tmp.li_attr.id&&delete tmp.li_attr.id,tmp.a_attr&&tmp.a_attr.id&&delete tmp.a_attr.id),options&&options.flat&&obj.id!=="#"&&flat.push(tmp),!options||!options.no_children)for(i=0,j=obj.children.length;i<j;i++)options&&options.flat?this.get_json(obj.children[i],options,flat):tmp.children.push(this.get_json(obj.children[i],options));return options&&options.flat?flat:obj.id==="#"?tmp.children:tmp},create_node:function(par,node,pos,callback,is_loaded){if(par===null&&(par="#"),par=this.get_node(par),!par)return!1;if(pos=pos===undefined?"last":pos,!pos.toString().match(/^(before|after)$/)&&!is_loaded&&!this.is_loaded(par))return this.load_node(par,function(){this.create_node(par,node,pos,callback,!0)});node||(node={text:this.get_string("New node")});node.text===undefined&&(node.text=this.get_string("New node"));var tmp,dpc,i,j;par.id==="#"&&(pos==="before"&&(pos="first"),pos==="after"&&(pos="last"));switch(pos){case"before":tmp=this.get_node(par.parent);pos=$.inArray(par.id,tmp.children);par=tmp;break;case"after":tmp=this.get_node(par.parent);pos=$.inArray(par.id,tmp.children)+1;par=tmp;break;case"inside":case"first":pos=0;break;case"last":pos=par.children.length;break;default:pos||(pos=0)}if(pos>par.children.length&&(pos=par.children.length),node.id||(node.id=!0),!this.check("create_node",node,par,pos))return this.settings.core.error.call(this,this._data.core.last_error),!1;if(node.id===!0&&delete node.id,node=this._parse_model_from_json(node,par.id,par.parents.concat()),!node)return!1;for(tmp=this.get_node(node),dpc=[],dpc.push(node),dpc=dpc.concat(tmp.children_d),this.trigger("model",{nodes:dpc,parent:par.id}),par.children_d=par.children_d.concat(dpc),i=0,j=par.parents.length;i<j;i++)this._model.data[par.parents[i]].children_d=this._model.data[par.parents[i]].children_d.concat(dpc);for(node=tmp,tmp=[],i=0,j=par.children.length;i<j;i++)tmp[i>=pos?i+1:i]=par.children[i];return tmp[pos]=node.id,par.children=tmp,this.redraw_node(par,!0),callback&&callback.call(this,this.get_node(node)),this.trigger("create_node",{node:this.get_node(node),parent:par.id,position:pos}),node.id},rename_node:function(obj,val){var t1,t2,old;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.rename_node(obj[t1],val);return!0}return(obj=this.get_node(obj),!obj||obj.id==="#")?!1:(old=obj.text,!this.check("rename_node",obj,this.get_parent(obj),val))?(this.settings.core.error.call(this,this._data.core.last_error),!1):(this.set_text(obj,val),this.trigger("rename_node",{node:obj,text:val,old:old}),!0)},delete_node:function(obj){var t1,t2,par,pos,tmp,i,j,k,l,c;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.delete_node(obj[t1]);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;if(par=this.get_node(obj.parent),pos=$.inArray(obj.id,par.children),c=!1,!this.check("delete_node",obj,par,pos))return this.settings.core.error.call(this,this._data.core.last_error),!1;for(pos!==-1&&(par.children=$.vakata.array_remove(par.children,pos)),tmp=obj.children_d.concat([]),tmp.push(obj.id),k=0,l=tmp.length;k<l;k++){for(i=0,j=obj.parents.length;i<j;i++)pos=$.inArray(tmp[k],this._model.data[obj.parents[i]].children_d),pos!==-1&&(this._model.data[obj.parents[i]].children_d=$.vakata.array_remove(this._model.data[obj.parents[i]].children_d,pos));this._model.data[tmp[k]].state.selected&&(c=!0,pos=$.inArray(tmp[k],this._data.core.selected),pos!==-1&&(this._data.core.selected=$.vakata.array_remove(this._data.core.selected,pos)))}for(this.trigger("delete_node",{node:obj,parent:par.id}),c&&this.trigger("changed",{action:"delete_node",node:obj,selected:this._data.core.selected,parent:par.id}),k=0,l=tmp.length;k<l;k++)delete this._model.data[tmp[k]];return this.redraw_node(par,!0),!0},check:function(chk,obj,par,pos,more){obj=obj&&obj.id?obj:this.get_node(obj);par=par&&par.id?par:this.get_node(par);var tmp=chk.match(/^move_node|copy_node|create_node$/i)?par:obj,chc=this.settings.core.check_callback;return(chk==="move_node"||chk==="copy_node")&&(!more||!more.is_multi)&&(obj.id===par.id||$.inArray(obj.id,par.children)===pos||$.inArray(par.id,obj.children_d)!==-1)?(this._data.core.last_error={error:"check",plugin:"core",id:"core_01",reason:"Moving parent inside child",data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})},!1):(tmp&&tmp.data&&(tmp=tmp.data),tmp&&tmp.functions&&(tmp.functions[chk]===!1||tmp.functions[chk]===!0))?(tmp.functions[chk]===!1&&(this._data.core.last_error={error:"check",plugin:"core",id:"core_02",reason:"Node data prevents function: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})}),tmp.functions[chk]):chc===!1||$.isFunction(chc)&&chc.call(this,chk,obj,par,pos,more)===!1||chc&&chc[chk]===!1?(this._data.core.last_error={error:"check",plugin:"core",id:"core_03",reason:"User config for core.check_callback prevents function: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})},!1):!0},last_error:function(){return this._data.core.last_error},move_node:function(obj,par,pos,callback,is_loaded,skip_redraw){var t1,t2,old_par,old_pos,new_par,old_ins,is_multi,dpc,tmp,i,j,k,l,p;if(par=this.get_node(par),pos=pos===undefined?0:pos,!par)return!1;if(!pos.toString().match(/^(before|after)$/)&&!is_loaded&&!this.is_loaded(par))return this.load_node(par,function(){this.move_node(obj,par,pos,callback,!0)});if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.move_node(obj[t1],par,pos,callback,is_loaded,!0)&&(par=obj[t1],pos="after");return this.redraw(),!0}if(obj=obj&&obj.id?obj:this.get_node(obj),!obj||obj.id==="#")return!1;if(old_par=(obj.parent||"#").toString(),new_par=!pos.toString().match(/^(before|after)$/)||par.id==="#"?par:this.get_node(par.parent),old_ins=obj.instance?obj.instance:this._model.data[obj.id]?this:$.jstree.reference(obj.id),is_multi=!old_ins||!old_ins._id||this._id!==old_ins._id,old_pos=old_ins&&old_ins._id&&old_par&&old_ins._model.data[old_par]&&old_ins._model.data[old_par].children?$.inArray(obj.id,old_ins._model.data[old_par].children):-1,is_multi)return this.copy_node(obj,par,pos,callback,is_loaded)?(old_ins&&old_ins.delete_node(obj),!0):!1;par.id==="#"&&(pos==="before"&&(pos="first"),pos==="after"&&(pos="last"));switch(pos){case"before":pos=$.inArray(par.id,new_par.children);break;case"after":pos=$.inArray(par.id,new_par.children)+1;break;case"inside":case"first":pos=0;break;case"last":pos=new_par.children.length;break;default:pos||(pos=0)}if(pos>new_par.children.length&&(pos=new_par.children.length),!this.check("move_node",obj,new_par,pos,{core:!0,is_multi:old_ins&&old_ins._id&&old_ins._id!==this._id,is_foreign:!old_ins||!old_ins._id}))return this.settings.core.error.call(this,this._data.core.last_error),!1;if(obj.parent===new_par.id){for(dpc=new_par.children.concat(),tmp=$.inArray(obj.id,dpc),tmp!==-1&&(dpc=$.vakata.array_remove(dpc,tmp),pos>tmp&&pos--),tmp=[],i=0,j=dpc.length;i<j;i++)tmp[i>=pos?i+1:i]=dpc[i];tmp[pos]=obj.id;new_par.children=tmp;this._node_changed(new_par.id);this.redraw(new_par.id==="#")}else{for(tmp=obj.children_d.concat(),tmp.push(obj.id),i=0,j=obj.parents.length;i<j;i++){for(dpc=[],p=old_ins._model.data[obj.parents[i]].children_d,k=0,l=p.length;k<l;k++)$.inArray(p[k],tmp)===-1&&dpc.push(p[k]);old_ins._model.data[obj.parents[i]].children_d=dpc}for(old_ins._model.data[old_par].children=$.vakata.array_remove_item(old_ins._model.data[old_par].children,obj.id),i=0,j=new_par.parents.length;i<j;i++)this._model.data[new_par.parents[i]].children_d=this._model.data[new_par.parents[i]].children_d.concat(tmp);for(dpc=[],i=0,j=new_par.children.length;i<j;i++)dpc[i>=pos?i+1:i]=new_par.children[i];for(dpc[pos]=obj.id,new_par.children=dpc,new_par.children_d.push(obj.id),new_par.children_d=new_par.children_d.concat(obj.children_d),obj.parent=new_par.id,tmp=new_par.parents.concat(),tmp.unshift(new_par.id),p=obj.parents.length,obj.parents=tmp,tmp=tmp.concat(),i=0,j=obj.children_d.length;i<j;i++)this._model.data[obj.children_d[i]].parents=this._model.data[obj.children_d[i]].parents.slice(0,p*-1),Array.prototype.push.apply(this._model.data[obj.children_d[i]].parents,tmp);(old_par==="#"||new_par.id==="#")&&(this._model.force_full_redraw=!0);this._model.force_full_redraw||(this._node_changed(old_par),this._node_changed(new_par.id));skip_redraw||this.redraw()}return callback&&callback.call(this,obj,new_par,pos),this.trigger("move_node",{node:obj,parent:new_par.id,position:pos,old_parent:old_par,old_position:old_pos,is_multi:old_ins&&old_ins._id&&old_ins._id!==this._id,is_foreign:!old_ins||!old_ins._id,old_instance:old_ins,new_instance:this}),!0},copy_node:function(obj,par,pos,callback,is_loaded,skip_redraw){var t1,t2,dpc,tmp,i,j,node,old_par,new_par,old_ins,is_multi;if(par=this.get_node(par),pos=pos===undefined?0:pos,!par)return!1;if(!pos.toString().match(/^(before|after)$/)&&!is_loaded&&!this.is_loaded(par))return this.load_node(par,function(){this.copy_node(obj,par,pos,callback,!0)});if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)tmp=this.copy_node(obj[t1],par,pos,callback,is_loaded,!0),tmp&&(par=tmp,pos="after");return this.redraw(),!0}if(obj=obj&&obj.id?obj:this.get_node(obj),!obj||obj.id==="#")return!1;old_par=(obj.parent||"#").toString();new_par=!pos.toString().match(/^(before|after)$/)||par.id==="#"?par:this.get_node(par.parent);old_ins=obj.instance?obj.instance:this._model.data[obj.id]?this:$.jstree.reference(obj.id);is_multi=!old_ins||!old_ins._id||this._id!==old_ins._id;par.id==="#"&&(pos==="before"&&(pos="first"),pos==="after"&&(pos="last"));switch(pos){case"before":pos=$.inArray(par.id,new_par.children);break;case"after":pos=$.inArray(par.id,new_par.children)+1;break;case"inside":case"first":pos=0;break;case"last":pos=new_par.children.length;break;default:pos||(pos=0)}if(pos>new_par.children.length&&(pos=new_par.children.length),!this.check("copy_node",obj,new_par,pos,{core:!0,is_multi:old_ins&&old_ins._id&&old_ins._id!==this._id,is_foreign:!old_ins||!old_ins._id}))return this.settings.core.error.call(this,this._data.core.last_error),!1;if((node=old_ins?old_ins.get_json(obj,{no_id:!0,no_data:!0,no_state:!0}):obj,!node)||(node.id===!0&&delete node.id,node=this._parse_model_from_json(node,new_par.id,new_par.parents.concat()),!node))return!1;for(tmp=this.get_node(node),obj&&obj.state&&obj.state.loaded===!1&&(tmp.state.loaded=!1),dpc=[],dpc.push(node),dpc=dpc.concat(tmp.children_d),this.trigger("model",{nodes:dpc,parent:new_par.id}),i=0,j=new_par.parents.length;i<j;i++)this._model.data[new_par.parents[i]].children_d=this._model.data[new_par.parents[i]].children_d.concat(dpc);for(dpc=[],i=0,j=new_par.children.length;i<j;i++)dpc[i>=pos?i+1:i]=new_par.children[i];return dpc[pos]=tmp.id,new_par.children=dpc,new_par.children_d.push(tmp.id),new_par.children_d=new_par.children_d.concat(tmp.children_d),new_par.id==="#"&&(this._model.force_full_redraw=!0),this._model.force_full_redraw||this._node_changed(new_par.id),skip_redraw||this.redraw(new_par.id==="#"),callback&&callback.call(this,tmp,new_par,pos),this.trigger("copy_node",{node:tmp,original:obj,parent:new_par.id,position:pos,old_parent:old_par,old_position:old_ins&&old_ins._id&&old_par&&old_ins._model.data[old_par]&&old_ins._model.data[old_par].children?$.inArray(obj.id,old_ins._model.data[old_par].children):-1,is_multi:old_ins&&old_ins._id&&old_ins._id!==this._id,is_foreign:!old_ins||!old_ins._id,old_instance:old_ins,new_instance:this}),tmp.id},cut:function(obj){if(obj||(obj=this._data.core.selected.concat()),$.isArray(obj)||(obj=[obj]),!obj.length)return!1;for(var tmp=[],o,t1=0,t2=obj.length;t1<t2;t1++)o=this.get_node(obj[t1]),o&&o.id&&o.id!=="#"&&tmp.push(o);if(!tmp.length)return!1;ccp_node=tmp;ccp_inst=this;ccp_mode="move_node";this.trigger("cut",{node:obj})},copy:function(obj){if(obj||(obj=this._data.core.selected.concat()),$.isArray(obj)||(obj=[obj]),!obj.length)return!1;for(var tmp=[],o,t1=0,t2=obj.length;t1<t2;t1++)o=this.get_node(obj[t1]),o&&o.id&&o.id!=="#"&&tmp.push(o);if(!tmp.length)return!1;ccp_node=tmp;ccp_inst=this;ccp_mode="copy_node";this.trigger("copy",{node:obj})},get_buffer:function(){return{mode:ccp_mode,node:ccp_node,inst:ccp_inst}},can_paste:function(){return ccp_mode!==!1&&ccp_node!==!1},paste:function(obj,pos){if(obj=this.get_node(obj),!obj||!ccp_mode||!ccp_mode.match(/^(copy_node|move_node)$/)||!ccp_node)return!1;this[ccp_mode](ccp_node,obj,pos)&&this.trigger("paste",{parent:obj.id,node:ccp_node,mode:ccp_mode});ccp_node=!1;ccp_mode=!1;ccp_inst=!1},clear_buffer:function(){ccp_node=!1;ccp_mode=!1;ccp_inst=!1;this.trigger("clear_buffer")},edit:function(obj,default_text){if(obj=this.get_node(obj),!obj)return!1;if(this.settings.core.check_callback===!1)return this._data.core.last_error={error:"check",plugin:"core",id:"core_07",reason:"Could not edit node because of check_callback"},this.settings.core.error.call(this,this._data.core.last_error),!1;default_text=typeof default_text=="string"?default_text:obj.text;this.set_text(obj,"");obj=this._open_to(obj);var rtl=this._data.core.rtl,w=this.element.width(),a=obj.children(".jstree-anchor"),s=$("<span>"),t=default_text,h1=$("<div />",{css:{position:"absolute",top:"-200px",left:rtl?"0px":"-1000px",visibility:"hidden"}}).appendTo("body"),h2=$("<input />",{value:t,"class":"jstree-rename-input",css:{padding:"0",border:"1px solid silver","box-sizing":"border-box",display:"inline-block",height:this._data.core.li_height+"px",lineHeight:this._data.core.li_height+"px",width:"150px"},blur:$.proxy(function(){var i=s.children(".jstree-rename-input"),v=i.val();v===""&&(v=t);h1.remove();s.replaceWith(a);s.remove();this.set_text(obj,t);this.rename_node(obj,$("<div><\/div>").text(v)[this.settings.core.force_text?"text":"html"]())===!1&&this.set_text(obj,t)},this),keydown:function(event){var key=event.which;key===27&&(this.value=t);(key===27||key===13||key===37||key===38||key===39||key===40||key===32)&&event.stopImmediatePropagation();(key===27||key===13)&&(event.preventDefault(),this.blur())},click:function(e){e.stopImmediatePropagation()},mousedown:function(e){e.stopImmediatePropagation()},keyup:function(){h2.width(Math.min(h1.text("pW"+this.value).width(),w))},keypress:function(event){if(event.which===13)return!1}}),fn={fontFamily:a.css("fontFamily")||"",fontSize:a.css("fontSize")||"",fontWeight:a.css("fontWeight")||"",fontStyle:a.css("fontStyle")||"",fontStretch:a.css("fontStretch")||"",fontVariant:a.css("fontVariant")||"",letterSpacing:a.css("letterSpacing")||"",wordSpacing:a.css("wordSpacing")||""};s.attr("class",a.attr("class")).append(a.contents().clone()).append(h2);a.replaceWith(s);h1.css(fn);h2.css(fn).width(Math.min(h1.text("pW"+h2[0].value).width(),w))[0].select()},set_theme:function(theme_name,theme_url){if(!theme_name)return!1;if(theme_url===!0){var dir=this.settings.core.themes.dir;dir||(dir=$.jstree.path+"/themes");theme_url=dir+"/"+theme_name+"/style.css"}theme_url&&$.inArray(theme_url,themes_loaded)===-1&&($("head").append('<link rel="stylesheet" href="'+theme_url+'" type="text/css" />'),themes_loaded.push(theme_url));this._data.core.themes.name&&this.element.removeClass("jstree-"+this._data.core.themes.name);this._data.core.themes.name=theme_name;this.element.addClass("jstree-"+theme_name);this.element[this.settings.core.themes.responsive?"addClass":"removeClass"]("jstree-"+theme_name+"-responsive");this.trigger("set_theme",{theme:theme_name})},get_theme:function(){return this._data.core.themes.name},set_theme_variant:function(variant_name){this._data.core.themes.variant&&this.element.removeClass("jstree-"+this._data.core.themes.name+"-"+this._data.core.themes.variant);this._data.core.themes.variant=variant_name;variant_name&&this.element.addClass("jstree-"+this._data.core.themes.name+"-"+this._data.core.themes.variant)},get_theme_variant:function(){return this._data.core.themes.variant},show_stripes:function(){this._data.core.themes.stripes=!0;this.get_container_ul().addClass("jstree-striped")},hide_stripes:function(){this._data.core.themes.stripes=!1;this.get_container_ul().removeClass("jstree-striped")},toggle_stripes:function(){this._data.core.themes.stripes?this.hide_stripes():this.show_stripes()},show_dots:function(){this._data.core.themes.dots=!0;this.get_container_ul().removeClass("jstree-no-dots")},hide_dots:function(){this._data.core.themes.dots=!1;this.get_container_ul().addClass("jstree-no-dots")},toggle_dots:function(){this._data.core.themes.dots?this.hide_dots():this.show_dots()},show_icons:function(){this._data.core.themes.icons=!0;this.get_container_ul().removeClass("jstree-no-icons")},hide_icons:function(){this._data.core.themes.icons=!1;this.get_container_ul().addClass("jstree-no-icons")},toggle_icons:function(){this._data.core.themes.icons?this.hide_icons():this.show_icons()},set_icon:function(obj,icon){var t1,t2,dom,old;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.set_icon(obj[t1],icon);return!0}return(obj=this.get_node(obj),!obj||obj.id==="#")?!1:(old=obj.icon,obj.icon=icon,dom=this.get_node(obj,!0).children(".jstree-anchor").children(".jstree-themeicon"),icon===!1?this.hide_icon(obj):icon===!0?(dom.removeClass("jstree-themeicon-custom "+old).css("background","").removeAttr("rel"),old===!1&&this.show_icon(obj)):icon.indexOf("/")===-1&&icon.indexOf(".")===-1?(dom.removeClass(old).css("background",""),dom.addClass(icon+" jstree-themeicon-custom").attr("rel",icon),old===!1&&this.show_icon(obj)):(dom.removeClass(old).css("background",""),dom.addClass("jstree-themeicon-custom").css("background","url('"+icon+"') center center no-repeat").attr("rel",icon),old===!1&&this.show_icon(obj)),!0)},get_icon:function(obj){return obj=this.get_node(obj),!obj||obj.id==="#"?!1:obj.icon},hide_icon:function(obj){var t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.hide_icon(obj[t1]);return!0}return(obj=this.get_node(obj),!obj||obj==="#")?!1:(obj.icon=!1,this.get_node(obj,!0).children(".jstree-anchor").children(".jstree-themeicon").addClass("jstree-themeicon-hidden"),!0)},show_icon:function(obj){var t1,t2,dom;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.show_icon(obj[t1]);return!0}return(obj=this.get_node(obj),!obj||obj==="#")?!1:(dom=this.get_node(obj,!0),obj.icon=dom.length?dom.children(".jstree-anchor").children(".jstree-themeicon").attr("rel"):!0,obj.icon||(obj.icon=!0),dom.children(".jstree-anchor").children(".jstree-themeicon").removeClass("jstree-themeicon-hidden"),!0)}};$.vakata={};$.vakata.attributes=function(node,with_values){node=$(node)[0];var attr=with_values?{}:[];return node&&node.attributes&&$.each(node.attributes,function(i,v){$.inArray(v.name.toLowerCase(),["style","contenteditable","hasfocus","tabindex"])===-1&&v.value!==null&&$.trim(v.value)!==""&&(with_values?attr[v.name]=v.value:attr.push(v.name))}),attr};$.vakata.array_unique=function(array){for(var a=[],j,i=0,l=array.length;i<l;i++){for(j=0;j<=i;j++)if(array[i]===array[j])break;j===i&&a.push(array[i])}return a};$.vakata.array_remove=function(array,from,to){var rest=array.slice((to||from)+1||array.length);return array.length=from<0?array.length+from:from,array.push.apply(array,rest),array};$.vakata.array_remove_item=function(array,item){var tmp=$.inArray(item,array);return tmp!==-1?$.vakata.array_remove(array,tmp):array};_i=document.createElement("I");_i.className="jstree-icon jstree-checkbox";_i.setAttribute("role","presentation");$.jstree.defaults.checkbox={visible:!0,three_state:!0,whole_node:!0,keep_selected_style:!0,cascade:"",tie_selection:!0};$.jstree.plugins.checkbox=function(options,parent){this.bind=function(){parent.bind.call(this);this._data.checkbox.uto=!1;this._data.checkbox.selected=[];this.settings.checkbox.three_state&&(this.settings.checkbox.cascade="up+down+undetermined");this.element.on("init.jstree",$.proxy(function(){this._data.checkbox.visible=this.settings.checkbox.visible;this.settings.checkbox.keep_selected_style||this.element.addClass("jstree-checkbox-no-clicked");this.settings.checkbox.tie_selection&&this.element.addClass("jstree-checkbox-selection")},this)).on("loading.jstree",$.proxy(function(){this[this._data.checkbox.visible?"show_checkboxes":"hide_checkboxes"]()},this));if(this.settings.checkbox.cascade.indexOf("undetermined")!==-1)this.element.on("changed.jstree uncheck_node.jstree check_node.jstree uncheck_all.jstree check_all.jstree move_node.jstree copy_node.jstree redraw.jstree open_node.jstree",$.proxy(function(){this._data.checkbox.uto&&clearTimeout(this._data.checkbox.uto);this._data.checkbox.uto=setTimeout($.proxy(this._undetermined,this),50)},this));if(!this.settings.checkbox.tie_selection)this.element.on("model.jstree",$.proxy(function(e,data){for(var m=this._model.data,p=m[data.parent],dpc=data.nodes,i=0,j=dpc.length;i<j;i++)m[dpc[i]].state.checked=m[dpc[i]].original&&m[dpc[i]].original.state&&m[dpc[i]].original.state.checked,m[dpc[i]].state.checked&&this._data.checkbox.selected.push(dpc[i])},this));if(this.settings.checkbox.cascade.indexOf("up")!==-1||this.settings.checkbox.cascade.indexOf("down")!==-1)this.element.on("model.jstree",$.proxy(function(e,data){var m=this._model.data,p=m[data.parent],dpc=data.nodes,chd=[],c,i,j,k,l,tmp,s=this.settings.checkbox.cascade,t=this.settings.checkbox.tie_selection;if(s.indexOf("down")!==-1)if(p.state[t?"selected":"checked"]){for(i=0,j=dpc.length;i<j;i++)m[dpc[i]].state[t?"selected":"checked"]=!0;this._data[t?"core":"checkbox"].selected=this._data[t?"core":"checkbox"].selected.concat(dpc)}else for(i=0,j=dpc.length;i<j;i++)if(m[dpc[i]].state[t?"selected":"checked"]){for(k=0,l=m[dpc[i]].children_d.length;k<l;k++)m[m[dpc[i]].children_d[k]].state[t?"selected":"checked"]=!0;this._data[t?"core":"checkbox"].selected=this._data[t?"core":"checkbox"].selected.concat(m[dpc[i]].children_d)}if(s.indexOf("up")!==-1){for(i=0,j=p.children_d.length;i<j;i++)m[p.children_d[i]].children.length||chd.push(m[p.children_d[i]].parent);for(chd=$.vakata.array_unique(chd),k=0,l=chd.length;k<l;k++)for(p=m[chd[k]];p&&p.id!=="#";){for(c=0,i=0,j=p.children.length;i<j;i++)c+=m[p.children[i]].state[t?"selected":"checked"];if(c===j)p.state[t?"selected":"checked"]=!0,this._data[t?"core":"checkbox"].selected.push(p.id),tmp=this.get_node(p,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!0).children(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked");else break;p=this.get_node(p.parent)}}this._data[t?"core":"checkbox"].selected=$.vakata.array_unique(this._data[t?"core":"checkbox"].selected)},this)).on(this.settings.checkbox.tie_selection?"select_node.jstree":"check_node.jstree",$.proxy(function(e,data){var obj=data.node,m=this._model.data,par=this.get_node(obj.parent),dom=this.get_node(obj,!0),i,j,c,tmp,s=this.settings.checkbox.cascade,t=this.settings.checkbox.tie_selection;if(s.indexOf("down")!==-1)for(this._data[t?"core":"checkbox"].selected=$.vakata.array_unique(this._data[t?"core":"checkbox"].selected.concat(obj.children_d)),i=0,j=obj.children_d.length;i<j;i++)tmp=m[obj.children_d[i]],tmp.state[t?"selected":"checked"]=!0,tmp&&tmp.original&&tmp.original.state&&tmp.original.state.undetermined&&(tmp.original.state.undetermined=!1);if(s.indexOf("up")!==-1)while(par&&par.id!=="#"){for(c=0,i=0,j=par.children.length;i<j;i++)c+=m[par.children[i]].state[t?"selected":"checked"];if(c===j)par.state[t?"selected":"checked"]=!0,this._data[t?"core":"checkbox"].selected.push(par.id),tmp=this.get_node(par,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!0).children(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked");else break;par=this.get_node(par.parent)}s.indexOf("down")!==-1&&dom.length&&dom.find(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked").parent().attr("aria-selected",!0)},this)).on(this.settings.checkbox.tie_selection?"deselect_all.jstree":"uncheck_all.jstree",$.proxy(function(){for(var obj=this.get_node("#"),m=this._model.data,tmp,i=0,j=obj.children_d.length;i<j;i++)tmp=m[obj.children_d[i]],tmp&&tmp.original&&tmp.original.state&&tmp.original.state.undetermined&&(tmp.original.state.undetermined=!1)},this)).on(this.settings.checkbox.tie_selection?"deselect_node.jstree":"uncheck_node.jstree",$.proxy(function(e,data){var obj=data.node,dom=this.get_node(obj,!0),i,j,tmp,s=this.settings.checkbox.cascade,t=this.settings.checkbox.tie_selection;if(obj&&obj.original&&obj.original.state&&obj.original.state.undetermined&&(obj.original.state.undetermined=!1),s.indexOf("down")!==-1)for(i=0,j=obj.children_d.length;i<j;i++)tmp=this._model.data[obj.children_d[i]],tmp.state[t?"selected":"checked"]=!1,tmp&&tmp.original&&tmp.original.state&&tmp.original.state.undetermined&&(tmp.original.state.undetermined=!1);if(s.indexOf("up")!==-1)for(i=0,j=obj.parents.length;i<j;i++)tmp=this._model.data[obj.parents[i]],tmp.state[t?"selected":"checked"]=!1,tmp&&tmp.original&&tmp.original.state&&tmp.original.state.undetermined&&(tmp.original.state.undetermined=!1),tmp=this.get_node(obj.parents[i],!0),tmp&&tmp.length&&tmp.attr("aria-selected",!1).children(".jstree-anchor").removeClass(t?"jstree-clicked":"jstree-checked");for(tmp=[],i=0,j=this._data[t?"core":"checkbox"].selected.length;i<j;i++)(s.indexOf("down")===-1||$.inArray(this._data[t?"core":"checkbox"].selected[i],obj.children_d)===-1)&&(s.indexOf("up")===-1||$.inArray(this._data[t?"core":"checkbox"].selected[i],obj.parents)===-1)&&tmp.push(this._data[t?"core":"checkbox"].selected[i]);this._data[t?"core":"checkbox"].selected=$.vakata.array_unique(tmp);s.indexOf("down")!==-1&&dom.length&&dom.find(".jstree-anchor").removeClass(t?"jstree-clicked":"jstree-checked").parent().attr("aria-selected",!1)},this));if(this.settings.checkbox.cascade.indexOf("up")!==-1)this.element.on("delete_node.jstree",$.proxy(function(e,data){for(var p=this.get_node(data.parent),m=this._model.data,i,j,c,tmp,t=this.settings.checkbox.tie_selection;p&&p.id!=="#";){for(c=0,i=0,j=p.children.length;i<j;i++)c+=m[p.children[i]].state[t?"selected":"checked"];if(c===j)p.state[t?"selected":"checked"]=!0,this._data[t?"core":"checkbox"].selected.push(p.id),tmp=this.get_node(p,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!0).children(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked");else break;p=this.get_node(p.parent)}},this)).on("move_node.jstree",$.proxy(function(e,data){var is_multi=data.is_multi,old_par=data.old_parent,new_par=this.get_node(data.parent),m=this._model.data,p,c,i,j,tmp,t=this.settings.checkbox.tie_selection;if(!is_multi)for(p=this.get_node(old_par);p&&p.id!=="#";){for(c=0,i=0,j=p.children.length;i<j;i++)c+=m[p.children[i]].state[t?"selected":"checked"];if(c===j)p.state[t?"selected":"checked"]=!0,this._data[t?"core":"checkbox"].selected.push(p.id),tmp=this.get_node(p,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!0).children(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked");else break;p=this.get_node(p.parent)}for(p=new_par;p&&p.id!=="#";){for(c=0,i=0,j=p.children.length;i<j;i++)c+=m[p.children[i]].state[t?"selected":"checked"];if(c===j)p.state[t?"selected":"checked"]||(p.state[t?"selected":"checked"]=!0,this._data[t?"core":"checkbox"].selected.push(p.id),tmp=this.get_node(p,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!0).children(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked"));else if(p.state[t?"selected":"checked"])p.state[t?"selected":"checked"]=!1,this._data[t?"core":"checkbox"].selected=$.vakata.array_remove_item(this._data[t?"core":"checkbox"].selected,p.id),tmp=this.get_node(p,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!1).children(".jstree-anchor").removeClass(t?"jstree-clicked":"jstree-checked");else break;p=this.get_node(p.parent)}},this))};this._undetermined=function(){for(var m=this._model.data,t=this.settings.checkbox.tie_selection,s=this._data[t?"core":"checkbox"].selected,p=[],tt=this,i=0,j=s.length;i<j;i++)m[s[i]]&&m[s[i]].parents&&(p=p.concat(m[s[i]].parents));for(this.element.find(".jstree-closed").not(":has(.jstree-children)").each(function(){var tmp=tt.get_node(this),tmp2;if(tmp.state.loaded)for(i=0,j=tmp.children_d.length;i<j;i++)tmp2=m[tmp.children_d[i]],!tmp2.state.loaded&&tmp2.original&&tmp2.original.state&&tmp2.original.state.undetermined&&tmp2.original.state.undetermined===!0&&(p.push(tmp2.id),p=p.concat(tmp2.parents));else tmp.original&&tmp.original.state&&tmp.original.state.undetermined&&tmp.original.state.undetermined===!0&&(p.push(tmp.id),p=p.concat(tmp.parents))}),p=$.vakata.array_unique(p),p=$.vakata.array_remove_item(p,"#"),this.element.find(".jstree-undetermined").removeClass("jstree-undetermined"),i=0,j=p.length;i<j;i++)m[p[i]].state[t?"selected":"checked"]||(s=this.get_node(p[i],!0),s&&s.length&&s.children(".jstree-anchor").children(".jstree-checkbox").addClass("jstree-undetermined"))};this.redraw_node=function(obj,deep,is_callback){if(obj=parent.redraw_node.apply(this,arguments),obj){for(var tmp=null,i=0,j=obj.childNodes.length;i<j;i++)if(obj.childNodes[i]&&obj.childNodes[i].className&&obj.childNodes[i].className.indexOf("jstree-anchor")!==-1){tmp=obj.childNodes[i];break}tmp&&(!this.settings.checkbox.tie_selection&&this._model.data[obj.id].state.checked&&(tmp.className+=" jstree-checked"),tmp.insertBefore(_i.cloneNode(!1),tmp.childNodes[0]))}return is_callback||this.settings.checkbox.cascade.indexOf("undetermined")===-1||(this._data.checkbox.uto&&clearTimeout(this._data.checkbox.uto),this._data.checkbox.uto=setTimeout($.proxy(this._undetermined,this),50)),obj};this.show_checkboxes=function(){this._data.core.themes.checkboxes=!0;this.get_container_ul().removeClass("jstree-no-checkboxes")};this.hide_checkboxes=function(){this._data.core.themes.checkboxes=!1;this.get_container_ul().addClass("jstree-no-checkboxes")};this.toggle_checkboxes=function(){this._data.core.themes.checkboxes?this.hide_checkboxes():this.show_checkboxes()};this.is_undetermined=function(obj){obj=this.get_node(obj);var s=this.settings.checkbox.cascade,i,j,t=this.settings.checkbox.tie_selection,d=this._data[t?"core":"checkbox"].selected,m=this._model.data;if(!obj||obj.state[t?"selected":"checked"]===!0||s.indexOf("undetermined")===-1||s.indexOf("down")===-1&&s.indexOf("up")===-1)return!1;if(!obj.state.loaded&&obj.original.state.undetermined===!0)return!0;for(i=0,j=obj.children_d.length;i<j;i++)if($.inArray(obj.children_d[i],d)!==-1||!m[obj.children_d[i]].state.loaded&&m[obj.children_d[i]].original.state.undetermined)return!0;return!1};this.activate_node=function(obj,e){if(this.settings.checkbox.tie_selection&&(this.settings.checkbox.whole_node||$(e.target).hasClass("jstree-checkbox"))&&(e.ctrlKey=!0),this.settings.checkbox.tie_selection||!this.settings.checkbox.whole_node&&!$(e.target).hasClass("jstree-checkbox"))return parent.activate_node.call(this,obj,e);this.is_checked(obj)?this.uncheck_node(obj,e):this.check_node(obj,e);this.trigger("activate_node",{node:this.get_node(obj)})};this.check_node=function(obj,e){if(this.settings.checkbox.tie_selection)return this.select_node(obj,!1,!0,e);var dom,t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.check_node(obj[t1],e);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;dom=this.get_node(obj,!0);obj.state.checked||(obj.state.checked=!0,this._data.checkbox.selected.push(obj.id),dom&&dom.length&&dom.children(".jstree-anchor").addClass("jstree-checked"),this.trigger("check_node",{node:obj,selected:this._data.checkbox.selected,event:e}))};this.uncheck_node=function(obj,e){if(this.settings.checkbox.tie_selection)return this.deselect_node(obj,!1,e);var t1,t2,dom;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.uncheck_node(obj[t1],e);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;dom=this.get_node(obj,!0);obj.state.checked&&(obj.state.checked=!1,this._data.checkbox.selected=$.vakata.array_remove_item(this._data.checkbox.selected,obj.id),dom.length&&dom.children(".jstree-anchor").removeClass("jstree-checked"),this.trigger("uncheck_node",{node:obj,selected:this._data.checkbox.selected,event:e}))};this.check_all=function(){if(this.settings.checkbox.tie_selection)return this.select_all();var tmp=this._data.checkbox.selected.concat([]),i,j;for(this._data.checkbox.selected=this._model.data["#"].children_d.concat(),i=0,j=this._data.checkbox.selected.length;i<j;i++)this._model.data[this._data.checkbox.selected[i]]&&(this._model.data[this._data.checkbox.selected[i]].state.checked=!0);this.redraw(!0);this.trigger("check_all",{selected:this._data.checkbox.selected})};this.uncheck_all=function(){if(this.settings.checkbox.tie_selection)return this.deselect_all();for(var tmp=this._data.checkbox.selected.concat([]),i=0,j=this._data.checkbox.selected.length;i<j;i++)this._model.data[this._data.checkbox.selected[i]]&&(this._model.data[this._data.checkbox.selected[i]].state.checked=!1);this._data.checkbox.selected=[];this.element.find(".jstree-checked").removeClass("jstree-checked");this.trigger("uncheck_all",{selected:this._data.checkbox.selected,node:tmp})};this.is_checked=function(obj){return this.settings.checkbox.tie_selection?this.is_selected(obj):(obj=this.get_node(obj),!obj||obj.id==="#")?!1:obj.state.checked};this.get_checked=function(full){return this.settings.checkbox.tie_selection?this.get_selected(full):full?$.map(this._data.checkbox.selected,$.proxy(function(i){return this.get_node(i)},this)):this._data.checkbox.selected};this.get_top_checked=function(full){if(this.settings.checkbox.tie_selection)return this.get_top_selected(full);for(var tmp=this.get_checked(!0),obj={},k,l,i=0,j=tmp.length;i<j;i++)obj[tmp[i].id]=tmp[i];for(i=0,j=tmp.length;i<j;i++)for(k=0,l=tmp[i].children_d.length;k<l;k++)obj[tmp[i].children_d[k]]&&delete obj[tmp[i].children_d[k]];tmp=[];for(i in obj)obj.hasOwnProperty(i)&&tmp.push(i);return full?$.map(tmp,$.proxy(function(i){return this.get_node(i)},this)):tmp};this.get_bottom_checked=function(full){if(this.settings.checkbox.tie_selection)return this.get_bottom_selected(full);for(var tmp=this.get_checked(!0),obj=[],i=0,j=tmp.length;i<j;i++)tmp[i].children.length||obj.push(tmp[i].id);return full?$.map(obj,$.proxy(function(i){return this.get_node(i)},this)):obj}};$.jstree.defaults.contextmenu={select_node:!0,show_at_node:!0,items:function(){return{create:{separator_before:!1,separator_after:!0,_disabled:!1,label:"Create",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.create_node(obj,{},"last",function(new_node){setTimeout(function(){inst.edit(new_node)},0)})}},rename:{separator_before:!1,separator_after:!1,_disabled:!1,label:"Rename",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.edit(obj)}},remove:{separator_before:!1,icon:!1,separator_after:!1,_disabled:!1,label:"Delete",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.is_selected(obj)?inst.delete_node(inst.get_selected()):inst.delete_node(obj)}},ccp:{separator_before:!0,icon:!1,separator_after:!1,label:"Edit",action:!1,submenu:{cut:{separator_before:!1,separator_after:!1,label:"Cut",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.is_selected(obj)?inst.cut(inst.get_selected()):inst.cut(obj)}},copy:{separator_before:!1,icon:!1,separator_after:!1,label:"Copy",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.is_selected(obj)?inst.copy(inst.get_selected()):inst.copy(obj)}},paste:{separator_before:!1,icon:!1,_disabled:function(data){return!$.jstree.reference(data.reference).can_paste()},separator_after:!1,label:"Paste",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.paste(obj)}}}}}}};$.jstree.plugins.contextmenu=function(options,parent){this.bind=function(){parent.bind.call(this);var last_ts=0;this.element.on("contextmenu.jstree",".jstree-anchor",$.proxy(function(e){e.preventDefault();last_ts=e.ctrlKey?e.timeStamp:0;this.is_loading(e.currentTarget)||this.show_contextmenu(e.currentTarget,e.pageX,e.pageY,e)},this)).on("click.jstree",".jstree-anchor",$.proxy(function(e){this._data.contextmenu.visible&&(!last_ts||e.timeStamp-last_ts>250)&&$.vakata.context.hide()},this));$(document).on("context_hide.vakata.jstree",$.proxy(function(){this._data.contextmenu.visible=!1},this))};this.teardown=function(){this._data.contextmenu.visible&&$.vakata.context.hide();parent.teardown.call(this)};this.show_contextmenu=function(obj,x,y,e){if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;var s=this.settings.contextmenu,d=this.get_node(obj,!0),a=d.children(".jstree-anchor"),o=!1,i=!1;(s.show_at_node||x===undefined||y===undefined)&&(o=a.offset(),x=o.left,y=o.top+this._data.core.li_height);this.settings.contextmenu.select_node&&!this.is_selected(obj)&&this.activate_node(obj,e);i=s.items;$.isFunction(i)&&(i=i.call(this,obj,$.proxy(function(i){this._show_contextmenu(obj,x,y,i)},this)));$.isPlainObject(i)&&this._show_contextmenu(obj,x,y,i)};this._show_contextmenu=function(obj,x,y,i){var d=this.get_node(obj,!0),a=d.children(".jstree-anchor");$(document).one("context_show.vakata.jstree",$.proxy(function(e,data){var cls="jstree-contextmenu jstree-"+this.get_theme()+"-contextmenu";$(data.element).addClass(cls)},this));this._data.contextmenu.visible=!0;$.vakata.context.show(a,{x:x,y:y},i);this.trigger("show_contextmenu",{node:obj,x:x,y:y})}},function($){var right_to_left=!1,vakata_context={element:!1,reference:!1,position_x:0,position_y:0,items:[],html:"",is_visible:!1};$.vakata.context={settings:{hide_onmouseleave:0,icons:!0},_trigger:function(event_name){$(document).triggerHandler("context_"+event_name+".vakata",{reference:vakata_context.reference,element:vakata_context.element,position:{x:vakata_context.position_x,y:vakata_context.position_y}})},_execute:function(i){return i=vakata_context.items[i],i&&(!i._disabled||$.isFunction(i._disabled)&&!i._disabled({item:i,reference:vakata_context.reference,element:vakata_context.element}))&&i.action?i.action.call(null,{item:i,reference:vakata_context.reference,element:vakata_context.element,position:{x:vakata_context.position_x,y:vakata_context.position_y}}):!1},_parse:function(o,is_callback){if(!o)return!1;is_callback||(vakata_context.html="",vakata_context.items=[]);var str="",sep=!1,tmp;return is_callback&&(str+="<ul>"),$.each(o,function(i,val){if(!val)return!0;vakata_context.items.push(val);!sep&&val.separator_before&&(str+="<li class='vakata-context-separator'><a href='#' "+($.vakata.context.settings.icons?"":'style="margin-left:0px;"')+">&#160;<\/a><\/li>");sep=!1;str+="<li class='"+(val._class||"")+(val._disabled===!0||$.isFunction(val._disabled)&&val._disabled({item:val,reference:vakata_context.reference,element:vakata_context.element})?" vakata-contextmenu-disabled ":"")+"' "+(val.shortcut?" data-shortcut='"+val.shortcut+"' ":"")+">";str+="<a href='#' rel='"+(vakata_context.items.length-1)+"'>";$.vakata.context.settings.icons&&(str+="<i ",val.icon&&(str+=val.icon.indexOf("/")!==-1||val.icon.indexOf(".")!==-1?" style='background:url(\""+val.icon+"\") center center no-repeat' ":" class='"+val.icon+"' "),str+="><\/i><span class='vakata-contextmenu-sep'>&#160;<\/span>");str+=($.isFunction(val.label)?val.label({item:i,reference:vakata_context.reference,element:vakata_context.element}):val.label)+(val.shortcut?' <span class="vakata-contextmenu-shortcut vakata-contextmenu-shortcut-'+val.shortcut+'">'+(val.shortcut_label||"")+"<\/span>":"")+"<\/a>";val.submenu&&(tmp=$.vakata.context._parse(val.submenu,!0),tmp&&(str+=tmp));str+="<\/li>";val.separator_after&&(str+="<li class='vakata-context-separator'><a href='#' "+($.vakata.context.settings.icons?"":'style="margin-left:0px;"')+">&#160;<\/a><\/li>",sep=!0)}),str=str.replace(/<li class\='vakata-context-separator'\><\/li\>$/,""),is_callback&&(str+="<\/ul>"),is_callback||(vakata_context.html=str,$.vakata.context._trigger("parse")),str.length>10?str:!1},_show_submenu:function(o){if(o=$(o),o.length&&o.children("ul").length){var e=o.children("ul"),x=o.offset().left+o.outerWidth(),y=o.offset().top,w=e.width(),h=e.height(),dw=$(window).width()+$(window).scrollLeft(),dh=$(window).height()+$(window).scrollTop();right_to_left?o[x-(w+10+o.outerWidth())<0?"addClass":"removeClass"]("vakata-context-left"):o[x+w+10>dw?"addClass":"removeClass"]("vakata-context-right");y+h+10>dh&&e.css("bottom","-1px");e.show()}},show:function(reference,position,data){var o,e,x,y,w,h,dw,dh;vakata_context.element&&vakata_context.element.length&&vakata_context.element.width("");switch(!0){case!position&&!reference:return!1;case!!position&&!!reference:vakata_context.reference=reference;vakata_context.position_x=position.x;vakata_context.position_y=position.y;break;case!position&&!!reference:vakata_context.reference=reference;o=reference.offset();vakata_context.position_x=o.left+reference.outerHeight();vakata_context.position_y=o.top;break;case!!position&&!reference:vakata_context.position_x=position.x;vakata_context.position_y=position.y}!reference||data||!$(reference).data("vakata_contextmenu")||(data=$(reference).data("vakata_contextmenu"));$.vakata.context._parse(data)&&vakata_context.element.html(vakata_context.html);vakata_context.items.length&&(vakata_context.element.appendTo("body"),e=vakata_context.element,x=vakata_context.position_x,y=vakata_context.position_y,w=e.width(),h=e.height(),dw=$(window).width()+$(window).scrollLeft(),dh=$(window).height()+$(window).scrollTop(),right_to_left&&(x-=e.outerWidth(),x<$(window).scrollLeft()+20&&(x=$(window).scrollLeft()+20)),x+w+20>dw&&(x=dw-(w+20)),y+h+20>dh&&(y=dh-(h+20)),vakata_context.element.css({left:x,top:y}).show().find("a").first().focus().parent().addClass("vakata-context-hover"),vakata_context.is_visible=!0,$.vakata.context._trigger("show"))},hide:function(){vakata_context.is_visible&&(vakata_context.element.hide().find("ul").hide().end().find(":focus").blur().end().detach(),vakata_context.is_visible=!1,$.vakata.context._trigger("hide"))}};$(function(){right_to_left=$("body").css("direction")==="rtl";var to=!1;vakata_context.element=$("<ul class='vakata-context'><\/ul>");vakata_context.element.on("mouseenter","li",function(e){(e.stopImmediatePropagation(),$.contains(this,e.relatedTarget))||(to&&clearTimeout(to),vakata_context.element.find(".vakata-context-hover").removeClass("vakata-context-hover").end(),$(this).siblings().find("ul").hide().end().end().parentsUntil(".vakata-context","li").addBack().addClass("vakata-context-hover"),$.vakata.context._show_submenu(this))}).on("mouseleave","li",function(e){$.contains(this,e.relatedTarget)||$(this).find(".vakata-context-hover").addBack().removeClass("vakata-context-hover")}).on("mouseleave",function(){$(this).find(".vakata-context-hover").removeClass("vakata-context-hover");$.vakata.context.settings.hide_onmouseleave&&(to=setTimeout(function(){return function(){$.vakata.context.hide()}}(this),$.vakata.context.settings.hide_onmouseleave))}).on("click","a",function(e){e.preventDefault();$(this).blur().parent().hasClass("vakata-context-disabled")||$.vakata.context._execute($(this).attr("rel"))===!1||$.vakata.context.hide()}).on("keydown","a",function(e){var o=null;switch(e.which){case 13:case 32:e.type="mouseup";e.preventDefault();$(e.currentTarget).trigger(e);break;case 37:vakata_context.is_visible&&(vakata_context.element.find(".vakata-context-hover").last().closest("li").first().find("ul").hide().find(".vakata-context-hover").removeClass("vakata-context-hover").end().end().children("a").focus(),e.stopImmediatePropagation(),e.preventDefault());break;case 38:vakata_context.is_visible&&(o=vakata_context.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").prevAll("li:not(.vakata-context-separator)").first(),o.length||(o=vakata_context.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").last()),o.addClass("vakata-context-hover").children("a").focus(),e.stopImmediatePropagation(),e.preventDefault());break;case 39:vakata_context.is_visible&&(vakata_context.element.find(".vakata-context-hover").last().children("ul").show().children("li:not(.vakata-context-separator)").removeClass("vakata-context-hover").first().addClass("vakata-context-hover").children("a").focus(),e.stopImmediatePropagation(),e.preventDefault());break;case 40:vakata_context.is_visible&&(o=vakata_context.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").nextAll("li:not(.vakata-context-separator)").first(),o.length||(o=vakata_context.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").first()),o.addClass("vakata-context-hover").children("a").focus(),e.stopImmediatePropagation(),e.preventDefault());break;case 27:$.vakata.context.hide();e.preventDefault()}}).on("keydown",function(e){e.preventDefault();var a=vakata_context.element.find(".vakata-contextmenu-shortcut-"+e.which).parent();a.parent().not(".vakata-context-disabled")&&a.click()});$(document).on("mousedown.vakata.jstree",function(e){vakata_context.is_visible&&!$.contains(vakata_context.element[0],e.target)&&$.vakata.context.hide()}).on("context_show.vakata.jstree",function(){vakata_context.element.find("li:has(ul)").children("a").addClass("vakata-context-parent");right_to_left&&vakata_context.element.addClass("vakata-context-rtl").css("direction","rtl");vakata_context.element.find("ul").hide().end()})})}($);$.jstree.defaults.dnd={copy:!0,open_timeout:500,is_draggable:!0,check_while_dragging:!0,always_copy:!1,inside_pos:0};$.jstree.plugins.dnd=function(options,parent){this.bind=function(){parent.bind.call(this);this.element.on("mousedown.jstree touchstart.jstree",".jstree-anchor",$.proxy(function(e){var obj=this.get_node(e.target),mlt=this.is_selected(obj)?this.get_selected().length:1;if(obj&&obj.id&&obj.id!=="#"&&(e.which===1||e.type==="touchstart")&&(this.settings.dnd.is_draggable===!0||$.isFunction(this.settings.dnd.is_draggable)&&this.settings.dnd.is_draggable.call(this,mlt>1?this.get_selected(!0):[obj])))return this.element.trigger("mousedown.jstree"),$.vakata.dnd.start(e,{jstree:!0,origin:this,obj:this.get_node(obj,!0),nodes:mlt>1?this.get_selected():[obj.id]},'<div id="jstree-dnd" class="jstree-'+this.get_theme()+" jstree-"+this.get_theme()+"-"+this.get_theme_variant()+" "+(this.settings.core.themes.responsive?" jstree-dnd-responsive":"")+'"><i class="jstree-icon jstree-er"><\/i>'+(mlt>1?mlt+" "+this.get_string("nodes"):this.get_text(e.currentTarget,!0))+'<ins class="jstree-copy" style="display:none;">+<\/ins><\/div>')},this))}};$(function(){var lastmv=!1,laster=!1,opento=!1,marker=$('<div id="jstree-marker">&#160;<\/div>').hide();$(document).on("dnd_start.vakata.jstree",function(e,data){(lastmv=!1,data&&data.data&&data.data.jstree)&&marker.appendTo("body")}).on("dnd_move.vakata.jstree",function(e,data){if((opento&&clearTimeout(opento),data&&data.data&&data.data.jstree)&&(!data.event.target.id||data.event.target.id!=="jstree-marker")){var ins=$.jstree.reference(data.event.target),ref=!1,off=!1,rel=!1,l,t,h,p,i,o,ok,t1,t2,op,ps,pr,ip,tm;if(ins&&ins._data&&ins._data.dnd)if(marker.attr("class","jstree-"+ins.get_theme()+(ins.settings.core.themes.responsive?" jstree-dnd-responsive":"")),data.helper.children().attr("class","jstree-"+ins.get_theme()+" jstree-"+ins.get_theme()+"-"+ins.get_theme_variant()+" "+(ins.settings.core.themes.responsive?" jstree-dnd-responsive":"")).find(".jstree-copy").first()[data.data.origin&&(data.data.origin.settings.dnd.always_copy||data.data.origin.settings.dnd.copy&&(data.event.metaKey||data.event.ctrlKey))?"show":"hide"](),(data.event.target===ins.element[0]||data.event.target===ins.get_container_ul()[0])&&ins.get_container_ul().children().length===0){for(ok=!0,t1=0,t2=data.data.nodes.length;t1<t2;t1++)if(ok=ok&&ins.check(data.data.origin&&(data.data.origin.settings.dnd.always_copy||data.data.origin.settings.dnd.copy&&(data.event.metaKey||data.event.ctrlKey))?"copy_node":"move_node",data.data.origin&&data.data.origin!==ins?data.data.origin.get_node(data.data.nodes[t1]):data.data.nodes[t1],"#","last",{dnd:!0,ref:ins.get_node("#"),pos:"i",is_multi:data.data.origin&&data.data.origin!==ins,is_foreign:!data.data.origin}),!ok)break;if(ok){lastmv={ins:ins,par:"#",pos:"last"};marker.hide();data.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok");return}}else if(ref=$(data.event.target).closest(".jstree-anchor"),ref&&ref.length&&ref.parent().is(".jstree-closed, .jstree-open, .jstree-leaf")&&(off=ref.offset(),rel=data.event.pageY-off.top,h=ref.height(),o=rel<h/3?["b","i","a"]:rel>h-h/3?["a","i","b"]:rel>h/2?["i","a","b"]:["i","b","a"],$.each(o,function(j,v){switch(v){case"b":l=off.left-6;t=off.top;p=ins.get_parent(ref);i=ref.parent().index();break;case"i":ip=ins.settings.dnd.inside_pos;tm=ins.get_node(ref.parent());l=off.left-2;t=off.top+h/2+1;p=tm.id;i=ip==="first"?0:ip==="last"?tm.children.length:Math.min(ip,tm.children.length);break;case"a":l=off.left-6;t=off.top+h;p=ins.get_parent(ref);i=ref.parent().index()+1}for(ok=!0,t1=0,t2=data.data.nodes.length;t1<t2;t1++)if(op=data.data.origin&&(data.data.origin.settings.dnd.always_copy||data.data.origin.settings.dnd.copy&&(data.event.metaKey||data.event.ctrlKey))?"copy_node":"move_node",ps=i,op==="move_node"&&v==="a"&&data.data.origin&&data.data.origin===ins&&p===ins.get_parent(data.data.nodes[t1])&&(pr=ins.get_node(p),ps>$.inArray(data.data.nodes[t1],pr.children)&&(ps-=1)),ok=ok&&(ins&&ins.settings&&ins.settings.dnd&&ins.settings.dnd.check_while_dragging===!1||ins.check(op,data.data.origin&&data.data.origin!==ins?data.data.origin.get_node(data.data.nodes[t1]):data.data.nodes[t1],p,ps,{dnd:!0,ref:ins.get_node(ref.parent()),pos:v,is_multi:data.data.origin&&data.data.origin!==ins,is_foreign:!data.data.origin})),!ok){ins&&ins.last_error&&(laster=ins.last_error());break}return v==="i"&&ref.parent().is(".jstree-closed")&&ins.settings.dnd.open_timeout&&(opento=setTimeout(function(x,z){return function(){x.open_node(z)}}(ins,ref),ins.settings.dnd.open_timeout)),ok?(lastmv={ins:ins,par:p,pos:v==="i"&&ip==="last"&&i===0&&!ins.is_loaded(tm)?"last":i},marker.css({left:l+"px",top:t+"px"}).show(),data.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok"),laster={},o=!0,!1):void 0}),o===!0))return;lastmv=!1;data.helper.find(".jstree-icon").removeClass("jstree-ok").addClass("jstree-er");marker.hide()}}).on("dnd_scroll.vakata.jstree",function(e,data){data&&data.data&&data.data.jstree&&(marker.hide(),lastmv=!1,data.helper.find(".jstree-icon").first().removeClass("jstree-ok").addClass("jstree-er"))}).on("dnd_stop.vakata.jstree",function(e,data){if(opento&&clearTimeout(opento),data&&data.data&&data.data.jstree){marker.hide().detach();var i,j,nodes=[];if(lastmv){for(i=0,j=data.data.nodes.length;i<j;i++)nodes[i]=data.data.origin?data.data.origin.get_node(data.data.nodes[i]):data.data.nodes[i],data.data.origin&&(nodes[i].instance=data.data.origin);for(lastmv.ins[data.data.origin&&(data.data.origin.settings.dnd.always_copy||data.data.origin.settings.dnd.copy&&(data.event.metaKey||data.event.ctrlKey))?"copy_node":"move_node"](nodes,lastmv.par,lastmv.pos),i=0,j=nodes.length;i<j;i++)nodes[i].instance&&(nodes[i].instance=null)}else i=$(data.event.target).closest(".jstree"),i.length&&laster&&laster.error&&laster.error==="check"&&(i=i.jstree(!0),i&&i.settings.core.error.call(this,laster))}}).on("keyup.jstree keydown.jstree",function(e,data){data=$.vakata.dnd._get();data&&data.data&&data.data.jstree&&data.helper.find(".jstree-copy").first()[data.data.origin&&(data.data.origin.settings.dnd.always_copy||data.data.origin.settings.dnd.copy&&(e.metaKey||e.ctrlKey))?"show":"hide"]()})}),function($){var vakata_dnd={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1};$.vakata.dnd={settings:{scroll_speed:10,scroll_proximity:20,helper_left:5,helper_top:10,threshold:5,threshold_touch:50},_trigger:function(event_name,e){var data=$.vakata.dnd._get();data.event=e;$(document).triggerHandler("dnd_"+event_name+".vakata",data)},_get:function(){return{data:vakata_dnd.data,element:vakata_dnd.element,helper:vakata_dnd.helper}},_clean:function(){vakata_dnd.helper&&vakata_dnd.helper.remove();vakata_dnd.scroll_i&&(clearInterval(vakata_dnd.scroll_i),vakata_dnd.scroll_i=!1);vakata_dnd={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1};$(document).off("mousemove.vakata.jstree touchmove.vakata.jstree",$.vakata.dnd.drag);$(document).off("mouseup.vakata.jstree touchend.vakata.jstree",$.vakata.dnd.stop)},_scroll:function(init_only){if(!vakata_dnd.scroll_e||!vakata_dnd.scroll_l&&!vakata_dnd.scroll_t)return vakata_dnd.scroll_i&&(clearInterval(vakata_dnd.scroll_i),vakata_dnd.scroll_i=!1),!1;if(!vakata_dnd.scroll_i)return vakata_dnd.scroll_i=setInterval($.vakata.dnd._scroll,100),!1;if(init_only===!0)return!1;var i=vakata_dnd.scroll_e.scrollTop(),j=vakata_dnd.scroll_e.scrollLeft();vakata_dnd.scroll_e.scrollTop(i+vakata_dnd.scroll_t*$.vakata.dnd.settings.scroll_speed);vakata_dnd.scroll_e.scrollLeft(j+vakata_dnd.scroll_l*$.vakata.dnd.settings.scroll_speed);(i!==vakata_dnd.scroll_e.scrollTop()||j!==vakata_dnd.scroll_e.scrollLeft())&&$.vakata.dnd._trigger("scroll",vakata_dnd.scroll_e)},start:function(e,data,html){e.type==="touchstart"&&e.originalEvent&&e.originalEvent.changedTouches&&e.originalEvent.changedTouches[0]&&(e.pageX=e.originalEvent.changedTouches[0].pageX,e.pageY=e.originalEvent.changedTouches[0].pageY,e.target=document.elementFromPoint(e.originalEvent.changedTouches[0].pageX-window.pageXOffset,e.originalEvent.changedTouches[0].pageY-window.pageYOffset));vakata_dnd.is_drag&&$.vakata.dnd.stop({});try{e.currentTarget.unselectable="on";e.currentTarget.onselectstart=function(){return!1};e.currentTarget.style&&(e.currentTarget.style.MozUserSelect="none")}catch(ignore){}vakata_dnd.init_x=e.pageX;vakata_dnd.init_y=e.pageY;vakata_dnd.data=data;vakata_dnd.is_down=!0;vakata_dnd.element=e.currentTarget;vakata_dnd.target=e.target;vakata_dnd.is_touch=e.type==="touchstart";html!==!1&&(vakata_dnd.helper=$("<div id='vakata-dnd'><\/div>").html(html).css({display:"block",margin:"0",padding:"0",position:"absolute",top:"-2000px",lineHeight:"16px",zIndex:"10000"}));$(document).on("mousemove.vakata.jstree touchmove.vakata.jstree",$.vakata.dnd.drag);$(document).on("mouseup.vakata.jstree touchend.vakata.jstree",$.vakata.dnd.stop);return!1},drag:function(e){if(e.type==="touchmove"&&e.originalEvent&&e.originalEvent.changedTouches&&e.originalEvent.changedTouches[0]&&(e.pageX=e.originalEvent.changedTouches[0].pageX,e.pageY=e.originalEvent.changedTouches[0].pageY,e.target=document.elementFromPoint(e.originalEvent.changedTouches[0].pageX-window.pageXOffset,e.originalEvent.changedTouches[0].pageY-window.pageYOffset)),vakata_dnd.is_down){if(!vakata_dnd.is_drag)if(Math.abs(e.pageX-vakata_dnd.init_x)>(vakata_dnd.is_touch?$.vakata.dnd.settings.threshold_touch:$.vakata.dnd.settings.threshold)||Math.abs(e.pageY-vakata_dnd.init_y)>(vakata_dnd.is_touch?$.vakata.dnd.settings.threshold_touch:$.vakata.dnd.settings.threshold))vakata_dnd.helper&&(vakata_dnd.helper.appendTo("body"),vakata_dnd.helper_w=vakata_dnd.helper.outerWidth()),vakata_dnd.is_drag=!0,$.vakata.dnd._trigger("start",e);else return;var d=!1,w=!1,dh=!1,wh=!1,dw=!1,ww=!1,dt=!1,dl=!1,ht=!1,hl=!1;return vakata_dnd.scroll_t=0,vakata_dnd.scroll_l=0,vakata_dnd.scroll_e=!1,$($(e.target).parentsUntil("body").addBack().get().reverse()).filter(function(){return/^auto|scroll$/.test($(this).css("overflow"))&&(this.scrollHeight>this.offsetHeight||this.scrollWidth>this.offsetWidth)}).each(function(){var t=$(this),o=t.offset();return this.scrollHeight>this.offsetHeight&&(o.top+t.height()-e.pageY<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_t=1),e.pageY-o.top<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_t=-1)),this.scrollWidth>this.offsetWidth&&(o.left+t.width()-e.pageX<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_l=1),e.pageX-o.left<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_l=-1)),vakata_dnd.scroll_t||vakata_dnd.scroll_l?(vakata_dnd.scroll_e=$(this),!1):void 0}),vakata_dnd.scroll_e||(d=$(document),w=$(window),dh=d.height(),wh=w.height(),dw=d.width(),ww=w.width(),dt=d.scrollTop(),dl=d.scrollLeft(),dh>wh&&e.pageY-dt<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_t=-1),dh>wh&&wh-(e.pageY-dt)<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_t=1),dw>ww&&e.pageX-dl<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_l=-1),dw>ww&&ww-(e.pageX-dl)<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_l=1),(vakata_dnd.scroll_t||vakata_dnd.scroll_l)&&(vakata_dnd.scroll_e=d)),vakata_dnd.scroll_e&&$.vakata.dnd._scroll(!0),vakata_dnd.helper&&(ht=parseInt(e.pageY+$.vakata.dnd.settings.helper_top,10),hl=parseInt(e.pageX+$.vakata.dnd.settings.helper_left,10),dh&&ht+25>dh&&(ht=dh-50),dw&&hl+vakata_dnd.helper_w>dw&&(hl=dw-(vakata_dnd.helper_w+2)),vakata_dnd.helper.css({left:hl+"px",top:ht+"px"})),$.vakata.dnd._trigger("move",e),!1}},stop:function(e){if(e.type==="touchend"&&e.originalEvent&&e.originalEvent.changedTouches&&e.originalEvent.changedTouches[0]&&(e.pageX=e.originalEvent.changedTouches[0].pageX,e.pageY=e.originalEvent.changedTouches[0].pageY,e.target=document.elementFromPoint(e.originalEvent.changedTouches[0].pageX-window.pageXOffset,e.originalEvent.changedTouches[0].pageY-window.pageYOffset)),vakata_dnd.is_drag)$.vakata.dnd._trigger("stop",e);else if(e.type==="touchend"&&e.target===vakata_dnd.target){var to=setTimeout(function(){$(e.target).click()},100);$(e.target).one("click",function(){to&&clearTimeout(to)})}return $.vakata.dnd._clean(),!1}}}($);$.jstree.defaults.search={ajax:!1,fuzzy:!1,case_sensitive:!1,show_only_matches:!1,close_opened_onclear:!0,search_leaves_only:!1,search_callback:!1};$.jstree.plugins.search=function(options,parent){this.bind=function(){parent.bind.call(this);this._data.search.str="";this._data.search.dom=$();this._data.search.res=[];this._data.search.opn=[];this._data.search.som=!1;this.element.on("before_open.jstree",$.proxy(function(){var i,j,r=this._data.search.res,s=[],o=$();if(r&&r.length&&(this._data.search.dom=$(this.element[0].querySelectorAll("#"+$.map(r,function(v){return"0123456789".indexOf(v[0])!==-1?"\\3"+v[0]+" "+v.substr(1).replace($.jstree.idregex,"\\$&"):v.replace($.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.dom.children(".jstree-anchor").addClass("jstree-search"),this._data.search.som&&this._data.search.res.length)){for(i=0,j=r.length;i<j;i++)s=s.concat(this.get_node(r[i]).parents);s=$.vakata.array_remove_item($.vakata.array_unique(s),"#");o=s.length?$(this.element[0].querySelectorAll("#"+$.map(s,function(v){return"0123456789".indexOf(v[0])!==-1?"\\3"+v[0]+" "+v.substr(1).replace($.jstree.idregex,"\\$&"):v.replace($.jstree.idregex,"\\$&")}).join(", #"))):$();this.element.find(".jstree-node").hide().filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last");o=o.add(this._data.search.dom);o.parentsUntil(".jstree").addBack().show().filter(".jstree-children").each(function(){$(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last")})}},this)).on("search.jstree",$.proxy(function(e,data){this._data.search.som&&data.nodes.length&&(this.element.find(".jstree-node").hide().filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last"),data.nodes.parentsUntil(".jstree").addBack().show().filter(".jstree-children").each(function(){$(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last")}))},this)).on("clear_search.jstree",$.proxy(function(e,data){this._data.search.som&&data.nodes.length&&this.element.find(".jstree-node").css("display","").filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last")},this))};this.search=function(str,skip_async,show_only_matches){if(str===!1||$.trim(str.toString())==="")return this.clear_search();str=str.toString();var s=this.settings.search,a=s.ajax?s.ajax:!1,f=null,r=[],p=[];if(this._data.search.res.length&&this.clear_search(),show_only_matches===undefined&&(show_only_matches=s.show_only_matches),!skip_async&&a!==!1)return $.isFunction(a)?a.call(this,str,$.proxy(function(d){d&&d.d&&(d=d.d);this._load_nodes($.isArray(d)?$.vakata.array_unique(d):[],function(){this.search(str,!0,show_only_matches)},!0)},this)):(a=$.extend({},a),a.data||(a.data={}),a.data.str=str,$.ajax(a).fail($.proxy(function(){this._data.core.last_error={error:"ajax",plugin:"search",id:"search_01",reason:"Could not load search parents",data:JSON.stringify(a)};this.settings.core.error.call(this,this._data.core.last_error)},this)).done($.proxy(function(d){d&&d.d&&(d=d.d);this._load_nodes($.isArray(d)?$.vakata.array_unique(d):[],function(){this.search(str,!0,show_only_matches)},!0)},this)));this._data.search.str=str;this._data.search.dom=$();this._data.search.res=[];this._data.search.opn=[];this._data.search.som=show_only_matches;f=new $.vakata.search(str,!0,{caseSensitive:s.case_sensitive,fuzzy:s.fuzzy});$.each(this._model.data,function(i,v){v.text&&(s.search_callback&&s.search_callback.call(this,str,v)||!s.search_callback&&f.search(v.text).isMatch)&&(!s.search_leaves_only||v.state.loaded&&v.children.length===0)&&(r.push(i),p=p.concat(v.parents))});r.length&&(p=$.vakata.array_unique(p),this._search_open(p),this._data.search.dom=$(this.element[0].querySelectorAll("#"+$.map(r,function(v){return"0123456789".indexOf(v[0])!==-1?"\\3"+v[0]+" "+v.substr(1).replace($.jstree.idregex,"\\$&"):v.replace($.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.res=r,this._data.search.dom.children(".jstree-anchor").addClass("jstree-search"));this.trigger("search",{nodes:this._data.search.dom,str:str,res:this._data.search.res,show_only_matches:show_only_matches})};this.clear_search=function(){this._data.search.dom.children(".jstree-anchor").removeClass("jstree-search");this.settings.search.close_opened_onclear&&this.close_node(this._data.search.opn,0);this.trigger("clear_search",{nodes:this._data.search.dom,str:this._data.search.str,res:this._data.search.res});this._data.search.str="";this._data.search.res=[];this._data.search.opn=[];this._data.search.dom=$()};this._search_open=function(d){var t=this;$.each(d.concat([]),function(i,v){if(v==="#")return!0;try{v=$("#"+v.replace($.jstree.idregex,"\\$&"),t.element)}catch(ignore){}v&&v.length&&t.is_closed(v)&&(t._data.search.opn.push(v[0].id),t.open_node(v,function(){t._search_open(d)},0))})}},function($){$.vakata.search=function(pattern,txt,options){options=options||{};options.fuzzy!==!1&&(options.fuzzy=!0);pattern=options.caseSensitive?pattern:pattern.toLowerCase();var MATCH_LOCATION=options.location||0,MATCH_DISTANCE=options.distance||100,MATCH_THRESHOLD=options.threshold||.6,patternLen=pattern.length,matchmask,pattern_alphabet,match_bitapScore,search;return patternLen>32&&(options.fuzzy=!1),options.fuzzy&&(matchmask=1<<patternLen-1,pattern_alphabet=function(){for(var mask={},i=0,i=0;i<patternLen;i++)mask[pattern.charAt(i)]=0;for(i=0;i<patternLen;i++)mask[pattern.charAt(i)]|=1<<patternLen-i-1;return mask}(),match_bitapScore=function(e,x){var accuracy=e/patternLen,proximity=Math.abs(MATCH_LOCATION-x);return MATCH_DISTANCE?accuracy+proximity/MATCH_DISTANCE:proximity?1:accuracy}),search=function(text){if(text=options.caseSensitive?text:text.toLowerCase(),pattern===text||text.indexOf(pattern)!==-1)return{isMatch:!0,score:0};if(!options.fuzzy)return{isMatch:!1,score:1};var i,j,textLen=text.length,scoreThreshold=MATCH_THRESHOLD,bestLoc=text.indexOf(pattern,MATCH_LOCATION),binMin,binMid,binMax=patternLen+textLen,lastRd,start,finish,rd,charMatch,score=1,locations=[];for(bestLoc!==-1&&(scoreThreshold=Math.min(match_bitapScore(0,bestLoc),scoreThreshold),bestLoc=text.lastIndexOf(pattern,MATCH_LOCATION+patternLen),bestLoc!==-1&&(scoreThreshold=Math.min(match_bitapScore(0,bestLoc),scoreThreshold))),bestLoc=-1,i=0;i<patternLen;i++){for(binMin=0,binMid=binMax;binMin<binMid;)match_bitapScore(i,MATCH_LOCATION+binMid)<=scoreThreshold?binMin=binMid:binMax=binMid,binMid=Math.floor((binMax-binMin)/2+binMin);for(binMax=binMid,start=Math.max(1,MATCH_LOCATION-binMid+1),finish=Math.min(MATCH_LOCATION+binMid,textLen)+patternLen,rd=new Array(finish+2),rd[finish+1]=(1<<i)-1,j=finish;j>=start;j--)if(charMatch=pattern_alphabet[text.charAt(j-1)],rd[j]=i===0?(rd[j+1]<<1|1)&charMatch:(rd[j+1]<<1|1)&charMatch|(lastRd[j+1]|lastRd[j])<<1|1|lastRd[j+1],rd[j]&matchmask&&(score=match_bitapScore(i,j-1),score<=scoreThreshold))if(scoreThreshold=score,bestLoc=j-1,locations.push(bestLoc),bestLoc>MATCH_LOCATION)start=Math.max(1,2*MATCH_LOCATION-bestLoc);else break;if(match_bitapScore(i+1,MATCH_LOCATION)>scoreThreshold)break;lastRd=rd}return{isMatch:bestLoc>=0,score:score}},txt===!0?{search:search}:search(txt)}}($);$.jstree.defaults.sort=function(a,b){return this.get_text(a)>this.get_text(b)?1:-1};$.jstree.plugins.sort=function(options,parent){this.bind=function(){parent.bind.call(this);this.element.on("model.jstree",$.proxy(function(e,data){this.sort(data.parent,!0)},this)).on("rename_node.jstree create_node.jstree",$.proxy(function(e,data){this.sort(data.parent||data.node.parent,!1);this.redraw_node(data.parent||data.node.parent,!0)},this)).on("move_node.jstree copy_node.jstree",$.proxy(function(e,data){this.sort(data.parent,!1);this.redraw_node(data.parent,!0)},this))};this.sort=function(obj,deep){var i,j;if(obj=this.get_node(obj),obj&&obj.children&&obj.children.length&&(obj.children.sort($.proxy(this.settings.sort,this)),deep))for(i=0,j=obj.children_d.length;i<j;i++)this.sort(obj.children_d[i],!1)}};to=!1;$.jstree.defaults.state={key:"jstree",events:"changed.jstree open_node.jstree close_node.jstree",ttl:!1,filter:!1};$.jstree.plugins.state=function(options,parent){this.bind=function(){parent.bind.call(this);var bind=$.proxy(function(){this.element.on(this.settings.state.events,$.proxy(function(){to&&clearTimeout(to);to=setTimeout($.proxy(function(){this.save_state()},this),100)},this))},this);this.element.on("ready.jstree",$.proxy(function(){this.element.one("restore_state.jstree",bind);this.restore_state()||bind()},this))};this.save_state=function(){var st={state:this.get_state(),ttl:this.settings.state.ttl,sec:+new Date};$.vakata.storage.set(this.settings.state.key,JSON.stringify(st))};this.restore_state=function(){var k=$.vakata.storage.get(this.settings.state.key);if(!!k)try{k=JSON.parse(k)}catch(ex){return!1}if(!!k&&k.ttl&&k.sec&&+new Date-k.sec>k.ttl)return!1;if(!!k&&k.state&&(k=k.state),!!k&&$.isFunction(this.settings.state.filter)&&(k=this.settings.state.filter.call(this,k)),!!k){this.element.one("set_state.jstree",function(e,data){data.instance.trigger("restore_state",{state:$.extend(!0,{},k)})});return this.set_state(k),!0}return!1};this.clear_state=function(){return $.vakata.storage.del(this.settings.state.key)}},function($){$.vakata.storage={set:function(key,val){return window.localStorage.setItem(key,val)},get:function(key){return window.localStorage.getItem(key)},del:function(key){return window.localStorage.removeItem(key)}}}($);$.jstree.defaults.types={"#":{},"default":{}};$.jstree.plugins.types=function(options,parent){this.init=function(el,options){var i,j;if(options&&options.types&&options.types["default"])for(i in options.types)if(i!=="default"&&i!=="#"&&options.types.hasOwnProperty(i))for(j in options.types["default"])options.types["default"].hasOwnProperty(j)&&options.types[i][j]===undefined&&(options.types[i][j]=options.types["default"][j]);parent.init.call(this,el,options);this._model.data["#"].type="#"};this.refresh=function(skip_loading,forget_state){parent.refresh.call(this,skip_loading,forget_state);this._model.data["#"].type="#"};this.bind=function(){this.element.on("model.jstree",$.proxy(function(e,data){for(var m=this._model.data,dpc=data.nodes,t=this.settings.types,c="default",i=0,j=dpc.length;i<j;i++)c="default",m[dpc[i]].original&&m[dpc[i]].original.type&&t[m[dpc[i]].original.type]&&(c=m[dpc[i]].original.type),m[dpc[i]].data&&m[dpc[i]].data.jstree&&m[dpc[i]].data.jstree.type&&t[m[dpc[i]].data.jstree.type]&&(c=m[dpc[i]].data.jstree.type),m[dpc[i]].type=c,m[dpc[i]].icon===!0&&t[c].icon!==undefined&&(m[dpc[i]].icon=t[c].icon);m["#"].type="#"},this));parent.bind.call(this)};this.get_json=function(obj,options,flat){var i,j,m=this._model.data,opt=options?$.extend(!0,{},options,{no_id:!1}):{},tmp=parent.get_json.call(this,obj,opt,flat);if(tmp===!1)return!1;if($.isArray(tmp))for(i=0,j=tmp.length;i<j;i++)tmp[i].type=tmp[i].id&&m[tmp[i].id]&&m[tmp[i].id].type?m[tmp[i].id].type:"default",options&&options.no_id&&(delete tmp[i].id,tmp[i].li_attr&&tmp[i].li_attr.id&&delete tmp[i].li_attr.id,tmp[i].a_attr&&tmp[i].a_attr.id&&delete tmp[i].a_attr.id);else tmp.type=tmp.id&&m[tmp.id]&&m[tmp.id].type?m[tmp.id].type:"default",options&&options.no_id&&(tmp=this._delete_ids(tmp));return tmp};this._delete_ids=function(tmp){if($.isArray(tmp)){for(var i=0,j=tmp.length;i<j;i++)tmp[i]=this._delete_ids(tmp[i]);return tmp}return delete tmp.id,tmp.li_attr&&tmp.li_attr.id&&delete tmp.li_attr.id,tmp.a_attr&&tmp.a_attr.id&&delete tmp.a_attr.id,tmp.children&&$.isArray(tmp.children)&&(tmp.children=this._delete_ids(tmp.children)),tmp};this.check=function(chk,obj,par,pos,more){if(parent.check.call(this,chk,obj,par,pos,more)===!1)return!1;obj=obj&&obj.id?obj:this.get_node(obj);par=par&&par.id?par:this.get_node(par);var m=obj&&obj.id?$.jstree.reference(obj.id):null,tmp,d,i,j;m=m&&m._model&&m._model.data?m._model.data:null;switch(chk){case"create_node":case"move_node":case"copy_node":if(chk!=="move_node"||$.inArray(obj.id,par.children)===-1){if(tmp=this.get_rules(par),tmp.max_children!==undefined&&tmp.max_children!==-1&&tmp.max_children===par.children.length)return this._data.core.last_error={error:"check",plugin:"types",id:"types_01",reason:"max_children prevents function: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})},!1;if(tmp.valid_children!==undefined&&tmp.valid_children!==-1&&$.inArray(obj.type||"default",tmp.valid_children)===-1)return this._data.core.last_error={error:"check",plugin:"types",id:"types_02",reason:"valid_children prevents function: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})},!1;if(m&&obj.children_d&&obj.parents){for(d=0,i=0,j=obj.children_d.length;i<j;i++)d=Math.max(d,m[obj.children_d[i]].parents.length);d=d-obj.parents.length+1}(d<=0||d===undefined)&&(d=1);do{if(tmp.max_depth!==undefined&&tmp.max_depth!==-1&&tmp.max_depth<d)return this._data.core.last_error={error:"check",plugin:"types",id:"types_03",reason:"max_depth prevents function: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})},!1;par=this.get_node(par.parent);tmp=this.get_rules(par);d++}while(par)}}return!0};this.get_rules=function(obj){if(obj=this.get_node(obj),!obj)return!1;var tmp=this.get_type(obj,!0);return tmp.max_depth===undefined&&(tmp.max_depth=-1),tmp.max_children===undefined&&(tmp.max_children=-1),tmp.valid_children===undefined&&(tmp.valid_children=-1),tmp};this.get_type=function(obj,rules){return obj=this.get_node(obj),obj?rules?$.extend({type:obj.type},this.settings.types[obj.type]):obj.type:!1};this.set_type=function(obj,type){var t,t1,t2,old_type,old_icon;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.set_type(obj[t1],type);return!0}return(t=this.settings.types,obj=this.get_node(obj),!t[type]||!obj)?!1:(old_type=obj.type,old_icon=this.get_icon(obj),obj.type=type,(old_icon===!0||t[old_type]&&t[old_type].icon!==undefined&&old_icon===t[old_type].icon)&&this.set_icon(obj,t[type].icon!==undefined?t[type].icon:!0),!0)}};$.jstree.defaults.unique={case_sensitive:!1,duplicate:function(name,counter){return name+" ("+counter+")"}};$.jstree.plugins.unique=function(options,parent){this.check=function(chk,obj,par,pos,more){if(parent.check.call(this,chk,obj,par,pos,more)===!1)return!1;if(obj=obj&&obj.id?obj:this.get_node(obj),par=par&&par.id?par:this.get_node(par),!par||!par.children)return!0;for(var n=chk==="rename_node"?pos:obj.text,c=[],s=this.settings.unique.case_sensitive,m=this._model.data,i=0,j=par.children.length;i<j;i++)c.push(s?m[par.children[i]].text:m[par.children[i]].text.toLowerCase());s||(n=n.toLowerCase());switch(chk){case"delete_node":return!0;case"rename_node":return i=$.inArray(n,c)===-1||obj.text&&obj.text[s?"toString":"toLowerCase"]()===n,i||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_01",reason:"Child with name "+n+" already exists. Preventing: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})}),i;case"create_node":return i=$.inArray(n,c)===-1,i||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_04",reason:"Child with name "+n+" already exists. Preventing: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})}),i;case"copy_node":return i=$.inArray(n,c)===-1,i||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_02",reason:"Child with name "+n+" already exists. Preventing: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})}),i;case"move_node":return i=obj.parent===par.id||$.inArray(n,c)===-1,i||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_03",reason:"Child with name "+n+" already exists. Preventing: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})}),i}return!0};this.create_node=function(par,node,pos,callback,is_loaded){if(!node||node.text===undefined){if((par===null&&(par="#"),par=this.get_node(par),!par)||(pos=pos===undefined?"last":pos,!pos.toString().match(/^(before|after)$/)&&!is_loaded&&!this.is_loaded(par)))return parent.create_node.call(this,par,node,pos,callback,is_loaded);node||(node={});var tmp,n,dpc,i,j,m=this._model.data,s=this.settings.unique.case_sensitive,cb=this.settings.unique.duplicate;for(n=tmp=this.get_string("New node"),dpc=[],i=0,j=par.children.length;i<j;i++)dpc.push(s?m[par.children[i]].text:m[par.children[i]].text.toLowerCase());for(i=1;$.inArray(s?n:n.toLowerCase(),dpc)!==-1;)n=cb.call(this,tmp,++i).toString();node.text=n}return parent.create_node.call(this,par,node,pos,callback,is_loaded)}};div=document.createElement("DIV");div.setAttribute("unselectable","on");div.setAttribute("role","presentation");div.className="jstree-wholerow";div.innerHTML="&#160;";$.jstree.plugins.wholerow=function(options,parent){this.bind=function(){parent.bind.call(this);this.element.on("ready.jstree set_state.jstree",$.proxy(function(){this.hide_dots()},this)).on("init.jstree loading.jstree ready.jstree",$.proxy(function(){this.get_container_ul().addClass("jstree-wholerow-ul")},this)).on("deselect_all.jstree",$.proxy(function(){this.element.find(".jstree-wholerow-clicked").removeClass("jstree-wholerow-clicked")},this)).on("changed.jstree",$.proxy(function(e,data){this.element.find(".jstree-wholerow-clicked").removeClass("jstree-wholerow-clicked");for(var tmp=!1,i=0,j=data.selected.length;i<j;i++)tmp=this.get_node(data.selected[i],!0),tmp&&tmp.length&&tmp.children(".jstree-wholerow").addClass("jstree-wholerow-clicked")},this)).on("open_node.jstree",$.proxy(function(e,data){this.get_node(data.node,!0).find(".jstree-clicked").parent().children(".jstree-wholerow").addClass("jstree-wholerow-clicked")},this)).on("hover_node.jstree dehover_node.jstree",$.proxy(function(e,data){e.type==="hover_node"&&this.is_disabled(data.node)||this.get_node(data.node,!0).children(".jstree-wholerow")[e.type==="hover_node"?"addClass":"removeClass"]("jstree-wholerow-hovered")},this)).on("contextmenu.jstree",".jstree-wholerow",$.proxy(function(e){e.preventDefault();var tmp=$.Event("contextmenu",{metaKey:e.metaKey,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey,pageX:e.pageX,pageY:e.pageY});$(e.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(tmp)},this)).on("click.jstree",".jstree-wholerow",function(e){e.stopImmediatePropagation();var tmp=$.Event("click",{metaKey:e.metaKey,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey});$(e.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(tmp).focus()}).on("click.jstree",".jstree-leaf > .jstree-ocl",$.proxy(function(e){e.stopImmediatePropagation();var tmp=$.Event("click",{metaKey:e.metaKey,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey});$(e.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(tmp).focus()},this)).on("mouseover.jstree",".jstree-wholerow, .jstree-icon",$.proxy(function(e){return e.stopImmediatePropagation(),this.is_disabled(e.currentTarget)||this.hover_node(e.currentTarget),!1},this)).on("mouseleave.jstree",".jstree-node",$.proxy(function(e){this.dehover_node(e.currentTarget)},this))};this.teardown=function(){this.settings.wholerow&&this.element.find(".jstree-wholerow").remove();parent.teardown.call(this)};this.redraw_node=function(obj){if(obj=parent.redraw_node.apply(this,arguments),obj){var tmp=div.cloneNode(!0);$.inArray(obj.id,this._data.core.selected)!==-1&&(tmp.className+=" jstree-wholerow-clicked");this._data.core.focused&&this._data.core.focused===obj.id&&(tmp.className+=" jstree-wholerow-hovered");obj.insertBefore(tmp,obj.childNodes[0])}return obj}},function($){if(document.registerElement&&Object&&Object.create){var proto=Object.create(HTMLElement.prototype);proto.createdCallback=function(){var c={core:{},plugins:[]};for(var i in $.jstree.plugins)$.jstree.plugins.hasOwnProperty(i)&&this.attributes[i]&&(c.plugins.push(i),this.getAttribute(i)&&JSON.parse(this.getAttribute(i))&&(c[i]=JSON.parse(this.getAttribute(i))));for(i in $.jstree.defaults.core)$.jstree.defaults.core.hasOwnProperty(i)&&this.attributes[i]&&(c.core[i]=JSON.parse(this.getAttribute(i))||this.getAttribute(i));jQuery(this).jstree(c)};try{document.registerElement("vakata-jstree",{prototype:proto})}catch(ignore){}}}(jQuery)}});$(document).ready(function(){callPreview()});window.Modernizr=function(a,b,c){function C(a){j.cssText=a}function E(a,b){return typeof a===b}function F(a,b){return!!~(""+a).indexOf(b)}function G(a,b){var d,e;for(d in a)if(e=a[d],!F(e,"-")&&j[e]!==c)return b=="pfx"?e:!0;return!1}function H(a,b,d){var e,f;for(e in a)if(f=b[a[e]],f!==c)return d===!1?a[e]:E(f,"function")?f.bind(d||b):f;return!1}function I(a,b,c){var d=a.charAt(0).toUpperCase()+a.slice(1),e=(a+" "+p.join(d+" ")+d).split(" ");return E(b,"string")||E(b,"undefined")?G(e,b):(e=(a+" "+q.join(d+" ")+d).split(" "),H(e,b,c))}function J(){e.input=function(c){for(var d=0,e=c.length;d<e;d++)u[c[d]]=c[d]in k;return u.list&&(u.list=!!b.createElement("datalist")&&!!a.HTMLDataListElement),u}("autocomplete autofocus list placeholder max min multiple pattern required step".split(" "));e.inputtypes=function(a){for(var d=0,e,f,h,i=a.length;d<i;d++)k.setAttribute("type",f=a[d]),e=k.type!=="text",e&&(k.value=l,k.style.cssText="position:absolute;visibility:hidden;",/^range$/.test(f)&&k.style.WebkitAppearance!==c?(g.appendChild(k),h=b.defaultView,e=h.getComputedStyle&&h.getComputedStyle(k,null).WebkitAppearance!=="textfield"&&k.offsetHeight!==0,g.removeChild(k)):/^(search|tel)$/.test(f)||(e=/^(url|email)$/.test(f)?k.checkValidity&&k.checkValidity()===!1:k.value!=l)),t[a[d]]=!!e;return t}("search tel url email datetime date month week time datetime-local number range color".split(" "))}var e={},f=!0,g=b.documentElement,h="modernizr",i=b.createElement(h),j=i.style,k=b.createElement("input"),l=":)",m={}.toString,n=" -webkit- -moz- -o- -ms- ".split(" "),o="Webkit Moz O ms",p=o.split(" "),q=o.toLowerCase().split(" "),r={svg:"http://www.w3.org/2000/svg"},s={},t={},u={},v=[],w=v.slice,x,y=function(a,c,d,e){var f,i,j,k,l=b.createElement("div"),m=b.body,n=m||b.createElement("body");if(parseInt(d,10))while(d--)j=b.createElement("div"),j.id=e?e[d]:h+(d+1),l.appendChild(j);return f=["&#173;",'<style id="s',h,'">',a,"<\/style>"].join(""),l.id=h,(m?l:n).innerHTML+=f,n.appendChild(l),m||(n.style.background="",n.style.overflow="hidden",k=g.style.overflow,g.style.overflow="hidden",g.appendChild(n)),i=c(l,a),m?l.parentNode.removeChild(l):(n.parentNode.removeChild(n),g.style.overflow=k),!!i},z=function(){function d(d,e){e=e||b.createElement(a[d]||"div");d="on"+d;var f=d in e;return f||(e.setAttribute||(e=b.createElement("div")),e.setAttribute&&e.removeAttribute&&(e.setAttribute(d,""),f=E(e[d],"function"),E(e[d],"undefined")||(e[d]=c),e.removeAttribute(d))),e=null,f}var a={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};return d}(),A={}.hasOwnProperty,B,K;B=!E(A,"undefined")&&!E(A.call,"undefined")?function(a,b){return A.call(a,b)}:function(a,b){return b in a&&E(a.constructor.prototype[b],"undefined")};Function.prototype.bind||(Function.prototype.bind=function(b){var c=this,d,e;if(typeof c!="function")throw new TypeError;return d=w.call(arguments,1),e=function(){var a,f,g;return this instanceof e?(a=function(){},a.prototype=c.prototype,f=new a,g=c.apply(f,d.concat(w.call(arguments))),Object(g)===g?g:f):c.apply(b,d.concat(w.call(arguments)))},e});s.webgl=function(){return!!a.WebGLRenderingContext};s.touch=function(){var c;return"ontouchstart"in a||a.DocumentTouch&&b instanceof DocumentTouch?c=!0:y(["@media (",n.join("touch-enabled),("),h,")","{#modernizr{top:9px;position:absolute}}"].join(""),function(a){c=a.offsetTop===9}),c};s.geolocation=function(){return"geolocation"in navigator};s.draganddrop=function(){var a=b.createElement("div");return"draggable"in a||"ondragstart"in a&&"ondrop"in a};s.multiplebgs=function(){return C("background:url(https://),url(https://),red url(https://)"),/(url\s*\(.*?){3}/.test(j.background)};s.backgroundsize=function(){return I("backgroundSize")};s.cssanimations=function(){return I("animationName")};s.cssgradients=function(){var a="background-image:";return C((a+"-webkit- ".split(" ").join("gradient(linear,left top,right bottom,from(#9f9),to(white));"+a)+n.join("linear-gradient(left top,#9f9, white);"+a)).slice(0,-a.length)),F(j.backgroundImage,"gradient")};s.csstransforms=function(){return!!I("transform")};s.csstransforms3d=function(){var a=!!I("perspective");return a&&"webkitPerspective"in g.style&&y("@media (transform-3d),(-webkit-transform-3d){#modernizr{left:9px;position:absolute;height:3px;}}",function(b){a=b.offsetLeft===9&&b.offsetHeight===3}),a};s.csstransitions=function(){return I("transition")};s.video=function(){var a=b.createElement("video"),c=!1;try{(c=!!a.canPlayType)&&(c=new Boolean(c),c.ogg=a.canPlayType('video/ogg; codecs="theora"').replace(/^no$/,""),c.h264=a.canPlayType('video/mp4; codecs="avc1.42E01E"').replace(/^no$/,""),c.webm=a.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/^no$/,""))}catch(d){}return c};s.audio=function(){var a=b.createElement("audio"),c=!1;try{(c=!!a.canPlayType)&&(c=new Boolean(c),c.ogg=a.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),c.mp3=a.canPlayType("audio/mpeg;").replace(/^no$/,""),c.wav=a.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),c.m4a=(a.canPlayType("audio/x-m4a;")||a.canPlayType("audio/aac;")).replace(/^no$/,""))}catch(d){}return c};s.svg=function(){return!!b.createElementNS&&!!b.createElementNS(r.svg,"svg").createSVGRect};s.svgclippaths=function(){return!!b.createElementNS&&/SVGClipPath/.test(m.call(b.createElementNS(r.svg,"clipPath")))};for(K in s)B(s,K)&&(x=K.toLowerCase(),e[x]=s[K](),v.push((e[x]?"":"no-")+x));return e.input||J(),e.addTest=function(a,b){if(typeof a=="object")for(var d in a)B(a,d)&&e.addTest(d,a[d]);else{if(a=a.toLowerCase(),e[a]!==c)return e;b=typeof b=="function"?b():b;typeof f!="undefined"&&f&&(g.className+=" "+(b?"":"no-")+a);e[a]=b}return e},C(""),i=k=null,function(a,b){function l(a,b){var c=a.createElement("p"),d=a.getElementsByTagName("head")[0]||a.documentElement;return c.innerHTML="x<style>"+b+"<\/style>",d.insertBefore(c.lastChild,d.firstChild)}function m(){var a=s.elements;return typeof a=="string"?a.split(" "):a}function n(a){var b=j[a[h]];return b||(b={},i++,a[h]=i,j[i]=b),b}function o(a,c,d){if(c||(c=b),k)return c.createElement(a);d||(d=n(c));var g;return g=d.cache[a]?d.cache[a].cloneNode():f.test(a)?(d.cache[a]=d.createElem(a)).cloneNode():d.createElem(a),g.canHaveChildren&&!e.test(a)&&!g.tagUrn?d.frag.appendChild(g):g}function p(a,c){if(a||(a=b),k)return a.createDocumentFragment();c=c||n(a);for(var d=c.frag.cloneNode(),e=0,f=m(),g=f.length;e<g;e++)d.createElement(f[e]);return d}function q(a,b){b.cache||(b.cache={},b.createElem=a.createElement,b.createFrag=a.createDocumentFragment,b.frag=b.createFrag());a.createElement=function(c){return s.shivMethods?o(c,a,b):b.createElem(c)};a.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+m().join().replace(/[\w\-]+/g,function(a){return b.createElem(a),b.frag.createElement(a),'c("'+a+'")'})+");return n}")(s,b.frag)}function r(a){a||(a=b);var c=n(a);return s.shivCSS&&!g&&!c.hasCSS&&(c.hasCSS=!!l(a,"article,aside,dialog,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}mark{background:#FF0;color:#000}template{display:none}")),k||q(a,c),a}var d=a.html5||{},e=/^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i,f=/^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i,g,h="_html5shiv",i=0,j={},k,s;(function(){try{var a=b.createElement("a");a.innerHTML="<xyz><\/xyz>";g="hidden"in a;k=a.childNodes.length==1||function(){b.createElement("a");var a=b.createDocumentFragment();return typeof a.cloneNode=="undefined"||typeof a.createDocumentFragment=="undefined"||typeof a.createElement=="undefined"}()}catch(c){g=!0;k=!0}})();s={elements:d.elements||"abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video",version:"3.7.0",shivCSS:d.shivCSS!==!1,supportsUnknownElements:k,shivMethods:d.shivMethods!==!1,type:"default",shivDocument:r,createElement:o,createDocumentFragment:p};a.html5=s;r(b)}(this,b),e._version="2.8.3",e._prefixes=n,e._domPrefixes=q,e._cssomPrefixes=p,e.hasEvent=z,e.testProp=function(a){return G([a])},e.testAllProps=I,e.testStyles=y,g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(f?" js "+v.join(" "):""),e}(this,this.document),function(a,b,c){function d(a){return"[object Function]"==o.call(a)}function e(a){return"string"==typeof a}function f(){}function g(a){return!a||"loaded"==a||"complete"==a||"uninitialized"==a}function h(){var a=p.shift();q=1;a?a.t?m(function(){("c"==a.t?B.injectCss:B.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),h()):q=0}function i(a,c,d,e,f,i,j){function k(b){if(!o&&g(l.readyState)&&(u.r=o=1,!q&&h(),l.onload=l.onreadystatechange=null,b)){"img"!=a&&m(function(){t.removeChild(l)},50);for(var d in y[c])y[c].hasOwnProperty(d)&&y[c][d].onload()}}var j=j||B.errorTimeout,l=b.createElement(a),o=0,r=0,u={t:d,s:c,e:f,a:i,x:j};1===y[c]&&(r=1,y[c]=[]);"object"==a?l.data=c:(l.src=c,l.type=a);l.width=l.height="0";l.onerror=l.onload=l.onreadystatechange=function(){k.call(this,r)};p.splice(e,0,u);"img"!=a&&(r||2===y[c]?(t.insertBefore(l,s?null:n),m(k,j)):y[c].push(l))}function j(a,b,c,d,f){return q=0,b=b||"j",e(a)?i("c"==b?v:u,a,b,this.i++,c,d,f):(p.splice(this.i++,0,a),1==p.length&&h()),this}function k(){var a=B;return a.loader={load:j,i:0},a}var l=b.documentElement,m=a.setTimeout,n=b.getElementsByTagName("script")[0],o={}.toString,p=[],q=0,r="MozAppearance"in l.style,s=r&&!!b.createRange().compareNode,t=s?l:n.parentNode,l=a.opera&&"[object Opera]"==o.call(a.opera),l=!!b.attachEvent&&!l,u=r?"object":l?"script":"img",v=l?"script":u,w=Array.isArray||function(a){return"[object Array]"==o.call(a)},x=[],y={},z={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}},A,B;B=function(a){function b(a){for(var a=a.split("!"),b=x.length,c=a.pop(),d=a.length,c={url:c,origUrl:c,prefixes:a},e,g,f=0;f<d;f++)g=a[f].split("="),(e=z[g.shift()])&&(c=e(c,g));for(f=0;f<b;f++)c=x[f](c);return c}function g(a,e,f,g,h){var i=b(a),j=i.autoCallback;i.url.split(".").pop().split("?").shift();i.bypass||(e&&(e=d(e)?e:e[a]||e[g]||e[a.split("/").pop().split("?")[0]]),i.instead?i.instead(a,e,f,g,h):(y[i.url]?i.noexec=!0:y[i.url]=1,f.load(i.url,i.forceCSS||!i.forceJS&&"css"==i.url.split(".").pop().split("?").shift()?"c":c,i.noexec,i.attrs,i.timeout),(d(e)||d(j))&&f.load(function(){k();e&&e(i.origUrl,h,g);j&&j(i.origUrl,h,g);y[i.url]=2})))}function h(a,b){function c(a,c){if(a){if(e(a))c||(j=function(){var a=[].slice.call(arguments);k.apply(this,a);l()}),g(a,j,b,0,h);else if(Object(a)===a)for(n in m=function(){var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b}(),a)a.hasOwnProperty(n)&&(!c&&!--m&&(d(j)?j=function(){var a=[].slice.call(arguments);k.apply(this,a);l()}:j[n]=function(a){return function(){var b=[].slice.call(arguments);a&&a.apply(this,b);l()}}(k[n])),g(a[n],j,b,n,h))}else c||l()}var h=!!a.test,i=a.load||a.both,j=a.callback||f,k=j,l=a.complete||f,m,n;c(h?a.yep:a.nope,!!i);i&&c(i)}var i,j,l=this.yepnope.loader;if(e(a))g(a,0,l,0);else if(w(a))for(i=0;i<a.length;i++)j=a[i],e(j)?g(j,0,l,0):w(j)?B(j):Object(j)===j&&h(j,l);else Object(a)===a&&h(a,l)};B.addPrefix=function(a,b){z[a]=b};B.addFilter=function(a){x.push(a)};B.errorTimeout=1e4;null==b.readyState&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",A=function(){b.removeEventListener("DOMContentLoaded",A,0);b.readyState="complete"},0));a.yepnope=k();a.yepnope.executeStack=h;a.yepnope.injectJs=function(a,c,d,e,i,j){var k=b.createElement("script"),l,o,e=e||B.errorTimeout;k.src=a;for(o in d)k.setAttribute(o,d[o]);c=j?h:c||f;k.onreadystatechange=k.onload=function(){!l&&g(k.readyState)&&(l=1,c(),k.onload=k.onreadystatechange=null)};m(function(){l||(l=1,c(1))},e);i?k.onload():n.parentNode.insertBefore(k,n)};a.yepnope.injectCss=function(a,c,d,e,g,i){var e=b.createElement("link"),j,c=i?h:c||f;e.href=a;e.rel="stylesheet";e.type="text/css";for(j in d)e.setAttribute(j,d[j]);g||(n.parentNode.insertBefore(e,n),m(c,0))}}(this,document);Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))};
/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */
(function(global,factory){typeof exports=="object"&&exports&&typeof exports.nodeName!="string"?factory(exports):typeof define=="function"&&define.amd?define(["exports"],factory):(global.Mustache={},factory(global.Mustache))})(this,function(mustache){function isFunction(object){return typeof object=="function"}function typeStr(obj){return isArray(obj)?"array":typeof obj}function escapeRegExp(string){return string.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function hasProperty(obj,propName){return obj!=null&&typeof obj=="object"&&propName in obj}function testRegExp(re,string){return regExpTest.call(re,string)}function isWhitespace(string){return!testRegExp(nonSpaceRe,string)}function escapeHtml(string){return String(string).replace(/[&<>"'`=\/]/g,function(s){return entityMap[s]})}function parseTemplate(template,tags){function stripSpace(){if(hasTag&&!nonSpace)while(spaces.length)delete tokens[spaces.pop()];else spaces=[];hasTag=!1;nonSpace=!1}function compileTags(tagsToCompile){if(typeof tagsToCompile=="string"&&(tagsToCompile=tagsToCompile.split(spaceRe,2)),!isArray(tagsToCompile)||tagsToCompile.length!==2)throw new Error("Invalid tags: "+tagsToCompile);openingTagRe=new RegExp(escapeRegExp(tagsToCompile[0])+"\\s*");closingTagRe=new RegExp("\\s*"+escapeRegExp(tagsToCompile[1]));closingCurlyRe=new RegExp("\\s*"+escapeRegExp("}"+tagsToCompile[1]))}var openingTagRe,closingTagRe,closingCurlyRe,scanner,start,type,value,chr,token,openSection,i,valueLength;if(!template)return[];var sections=[],tokens=[],spaces=[],hasTag=!1,nonSpace=!1;for(compileTags(tags||mustache.tags),scanner=new Scanner(template);!scanner.eos();){if(start=scanner.pos,value=scanner.scanUntil(openingTagRe),value)for(i=0,valueLength=value.length;i<valueLength;++i)chr=value.charAt(i),isWhitespace(chr)?spaces.push(tokens.length):nonSpace=!0,tokens.push(["text",chr,start,start+1]),start+=1,chr==="\n"&&stripSpace();if(!scanner.scan(openingTagRe))break;if(hasTag=!0,type=scanner.scan(tagRe)||"name",scanner.scan(whiteRe),type==="="?(value=scanner.scanUntil(equalsRe),scanner.scan(equalsRe),scanner.scanUntil(closingTagRe)):type==="{"?(value=scanner.scanUntil(closingCurlyRe),scanner.scan(curlyRe),scanner.scanUntil(closingTagRe),type="&"):value=scanner.scanUntil(closingTagRe),!scanner.scan(closingTagRe))throw new Error("Unclosed tag at "+scanner.pos);if(token=[type,value,start,scanner.pos],tokens.push(token),type==="#"||type==="^")sections.push(token);else if(type==="/"){if(openSection=sections.pop(),!openSection)throw new Error('Unopened section "'+value+'" at '+start);if(openSection[1]!==value)throw new Error('Unclosed section "'+openSection[1]+'" at '+start);}else type==="name"||type==="{"||type==="&"?nonSpace=!0:type==="="&&compileTags(value)}if(openSection=sections.pop(),openSection)throw new Error('Unclosed section "'+openSection[1]+'" at '+scanner.pos);return nestTokens(squashTokens(tokens))}function squashTokens(tokens){for(var squashedTokens=[],token,lastToken,i=0,numTokens=tokens.length;i<numTokens;++i)token=tokens[i],token&&(token[0]==="text"&&lastToken&&lastToken[0]==="text"?(lastToken[1]+=token[1],lastToken[3]=token[3]):(squashedTokens.push(token),lastToken=token));return squashedTokens}function nestTokens(tokens){for(var nestedTokens=[],collector=nestedTokens,sections=[],token,section,i=0,numTokens=tokens.length;i<numTokens;++i){token=tokens[i];switch(token[0]){case"#":case"^":collector.push(token);sections.push(token);collector=token[4]=[];break;case"/":section=sections.pop();section[5]=token[2];collector=sections.length>0?sections[sections.length-1][4]:nestedTokens;break;default:collector.push(token)}}return nestedTokens}function Scanner(string){this.string=string;this.tail=string;this.pos=0}function Context(view,parentContext){this.view=view;this.cache={".":this.view};this.parent=parentContext}function Writer(){this.cache={}}var objectToString=Object.prototype.toString,isArray=Array.isArray||function(object){return objectToString.call(object)==="[object Array]"},regExpTest=RegExp.prototype.test,nonSpaceRe=/\S/,entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},whiteRe=/\s*/,spaceRe=/\s+/,equalsRe=/\s*=/,curlyRe=/\s*\}/,tagRe=/#|\^|\/|>|\{|&|=|!/,defaultWriter;Scanner.prototype.eos=function(){return this.tail===""};Scanner.prototype.scan=function(re){var match=this.tail.match(re),string;return!match||match.index!==0?"":(string=match[0],this.tail=this.tail.substring(string.length),this.pos+=string.length,string)};Scanner.prototype.scanUntil=function(re){var index=this.tail.search(re),match;switch(index){case-1:match=this.tail;this.tail="";break;case 0:match="";break;default:match=this.tail.substring(0,index);this.tail=this.tail.substring(index)}return this.pos+=match.length,match};Context.prototype.push=function(view){return new Context(view,this)};Context.prototype.lookup=function(name){var cache=this.cache,value,context,names,index,lookupHit;if(cache.hasOwnProperty(name))value=cache[name];else{for(context=this,lookupHit=!1;context;){if(name.indexOf(".")>0)for(value=context.view,names=name.split("."),index=0;value!=null&&index<names.length;)index===names.length-1&&(lookupHit=hasProperty(value,names[index])),value=value[names[index++]];else value=context.view[name],lookupHit=hasProperty(context.view,name);if(lookupHit)break;context=context.parent}cache[name]=value}return isFunction(value)&&(value=value.call(this.view)),value};Writer.prototype.clearCache=function(){this.cache={}};Writer.prototype.parse=function(template,tags){var cache=this.cache,tokens=cache[template];return tokens==null&&(tokens=cache[template]=parseTemplate(template,tags)),tokens};Writer.prototype.render=function(template,view,partials){var tokens=this.parse(template),context=view instanceof Context?view:new Context(view);return this.renderTokens(tokens,context,partials,template)};Writer.prototype.renderTokens=function(tokens,context,partials,originalTemplate){for(var buffer="",token,symbol,value,i=0,numTokens=tokens.length;i<numTokens;++i)value=undefined,token=tokens[i],symbol=token[0],symbol==="#"?value=this.renderSection(token,context,partials,originalTemplate):symbol==="^"?value=this.renderInverted(token,context,partials,originalTemplate):symbol===">"?value=this.renderPartial(token,context,partials,originalTemplate):symbol==="&"?value=this.unescapedValue(token,context):symbol==="name"?value=this.escapedValue(token,context):symbol==="text"&&(value=this.rawValue(token)),value!==undefined&&(buffer+=value);return buffer};Writer.prototype.renderSection=function(token,context,partials,originalTemplate){function subRender(template){return self.render(template,context,partials)}var self=this,buffer="",value=context.lookup(token[1]),j,valueLength;if(value){if(isArray(value))for(j=0,valueLength=value.length;j<valueLength;++j)buffer+=this.renderTokens(token[4],context.push(value[j]),partials,originalTemplate);else if(typeof value=="object"||typeof value=="string"||typeof value=="number")buffer+=this.renderTokens(token[4],context.push(value),partials,originalTemplate);else if(isFunction(value)){if(typeof originalTemplate!="string")throw new Error("Cannot use higher-order sections without the original template");value=value.call(context.view,originalTemplate.slice(token[3],token[5]),subRender);value!=null&&(buffer+=value)}else buffer+=this.renderTokens(token[4],context,partials,originalTemplate);return buffer}};Writer.prototype.renderInverted=function(token,context,partials,originalTemplate){var value=context.lookup(token[1]);if(!value||isArray(value)&&value.length===0)return this.renderTokens(token[4],context,partials,originalTemplate)};Writer.prototype.renderPartial=function(token,context,partials){if(partials){var value=isFunction(partials)?partials(token[1]):partials[token[1]];if(value!=null)return this.renderTokens(this.parse(value),context,partials,value)}};Writer.prototype.unescapedValue=function(token,context){var value=context.lookup(token[1]);if(value!=null)return value};Writer.prototype.escapedValue=function(token,context){var value=context.lookup(token[1]);if(value!=null)return mustache.escape(value)};Writer.prototype.rawValue=function(token){return token[1]};mustache.name="mustache.js";mustache.version="2.2.1";mustache.tags=["{{","}}"];defaultWriter=new Writer;mustache.clearCache=function(){return defaultWriter.clearCache()};mustache.parse=function(template,tags){return defaultWriter.parse(template,tags)};mustache.render=function(template,view,partials){if(typeof template!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+typeStr(template)+'" was given as the first argument for mustache#render(template, view, partials)');return defaultWriter.render(template,view,partials)};mustache.to_html=function(template,view,partials,send){var result=mustache.render(template,view,partials);if(isFunction(send))send(result);else return result};mustache.escape=escapeHtml;mustache.Scanner=Scanner;mustache.Context=Context;mustache.Writer=Writer});__extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},function(Akumina){var AddIn;(function(AddIn){var discussionShared=function(){function discussionShared(){}return discussionShared.prototype.getUser=function(userId,discussionItem,discussionRequest,hostUrl,isHosted){var deferred=$.Deferred(),context=discussionItem.get_context(),web,parentContext,userInfoList,camlQuery,collListItem;return isHosted?(parentContext=new SP.AppContextSite(context,hostUrl),web=parentContext.get_web()):web=context.get_web(),userInfoList=web.get_siteUserInfoList(),camlQuery=new SP.CamlQuery,camlQuery.set_viewXml("<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+userId+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>"),collListItem=userInfoList.getItems(camlQuery),context.load(collListItem),context.load(discussionItem,"EffectiveBasePermissions"),Akumina.AddIn.Logger.logSPCall("discussionShared.prototype.getUser"),context.executeQueryAsync(Function.createDelegate(this,function(){deferred.resolve(collListItem,discussionItem,discussionRequest)}),Function.createDelegate(this,function(sender,args){deferred.reject(sender,args)})),deferred.promise()},discussionShared.prototype.getReplies=function(discussionItem,discussionRequest,hostUrl,rowLimit,isHosted){var deferred=$.Deferred(),context=discussionItem.get_context(),web,parentContext,collListItem;isHosted?(parentContext=new SP.AppContextSite(context,hostUrl),web=parentContext.get_web()):web=context.get_web();var list=web.get_lists().getByTitle(discussionRequest.ListName),camlQuery=new SP.CamlQuery.createAllFoldersQuery,relativeUrl=discussionItem.get_item("FileRef").toString();return camlQuery.set_folderServerRelativeUrl(relativeUrl),camlQuery.set_viewXml("<View><Query><OrderBy><FieldRef Name='ID' Ascending='FALSE' /><\/OrderBy><\/Query><RowLimit>"+rowLimit+"<\/RowLimit><\/View>"),collListItem=list.getItems(camlQuery),context.load(collListItem,"Include("+Akumina.AddIn.Configuration.getSelectFields("DiscussionReply").join()+",AttachmentFiles,AttachmentLinks)"),Akumina.AddIn.Logger.logSPCall("discussionShared.prototype.getReplies"),context.executeQueryAsync(Function.createDelegate(this,function(){deferred.resolve(collListItem,discussionItem,discussionRequest)}),Function.createDelegate(this,function(sender,args){deferred.reject(sender,args)})),deferred.promise()},discussionShared}();AddIn.discussionShared=discussionShared})(AddIn=Akumina.AddIn||(Akumina.AddIn={}))}(Akumina||(Akumina={}));var selectedNode="a.jstree-clicked",closeIcon=".mfp-close",addFileDivId="listOfFiles",filesAdd_MustempId="files_Addtemplate",filesAdd_Hidden="listOfFilesHidden",addReplyPostId="li.addReplyToPost";$(document).ready(function(){DisplayEditor()}),function(factory){"use strict";typeof define=="function"&&define.amd?define(["jquery"],factory):typeof exports=="object"?factory(require("jquery")):factory(jQuery)}(function($,undefined){"use strict";
/*!
 * jsTree 3.0.8
 * http://jstree.com/
 *
 * Copyright (c) 2014 Ivan Bozhanov (http://vakata.com)
 *
 * Licensed same as jquery - under the terms of the MIT License
 *   http://www.opensource.org/licenses/mit-license.php
 */
/*!
 * if using jslint please allow for the jQuery global and use following options: 
 * jslint: browser: true, ass: true, bitwise: true, continue: true, nomen: true, plusplus: true, regexp: true, unparam: true, todo: true, white: true
 */
var _i,to,div;if(!$.jstree){var instance_counter=0,ccp_node=!1,ccp_mode=!1,ccp_inst=!1,themes_loaded=[],src=$("script:last").attr("src"),_d=document,_node=_d.createElement("LI"),_temp1,_temp2;_node.setAttribute("role","treeitem");_temp1=_d.createElement("I");_temp1.className="jstree-icon jstree-ocl";_temp1.setAttribute("role","presentation");_node.appendChild(_temp1);_temp1=_d.createElement("A");_temp1.className="jstree-anchor";_temp1.setAttribute("href","#");_temp1.setAttribute("tabindex","-1");_temp2=_d.createElement("I");_temp2.className="jstree-icon jstree-themeicon";_temp2.setAttribute("role","presentation");_temp1.appendChild(_temp2);_node.appendChild(_temp1);_temp1=_temp2=null;$.jstree={version:"3.0.8",defaults:{plugins:[]},plugins:{},path:src&&src.indexOf("/")!==-1?src.replace(/\/[^\/]+$/,""):"",idregex:/[\\:&!^|()\[\]<>@*'+~#";.,=\- \/${}%]/g};$.jstree.create=function(el,options){var tmp=new $.jstree.core(++instance_counter),opt=options;return options=$.extend(!0,{},$.jstree.defaults,options),opt&&opt.plugins&&(options.plugins=opt.plugins),$.each(options.plugins,function(i,k){i!=="core"&&(tmp=tmp.plugin(k,options[k]))}),tmp.init(el,options),tmp};$.jstree.destroy=function(){$(".jstree:jstree").jstree("destroy");$(document).off(".jstree")};$.jstree.core=function(id){this._id=id;this._cnt=0;this._wrk=null;this._data={core:{themes:{name:!1,dots:!1,icons:!1},selected:[],last_error:{},working:!1,worker_queue:[],focused:null}}};$.jstree.reference=function(needle){var tmp=null,obj=null;if(needle&&needle.id&&(needle=needle.id),!obj||!obj.length)try{obj=$(needle)}catch(ignore){}if(!obj||!obj.length)try{obj=$("#"+needle.replace($.jstree.idregex,"\\$&"))}catch(ignore){}return obj&&obj.length&&(obj=obj.closest(".jstree")).length&&(obj=obj.data("jstree"))?tmp=obj:$(".jstree").each(function(){var inst=$(this).data("jstree");if(inst&&inst._model.data[needle])return tmp=inst,!1}),tmp};$.fn.jstree=function(arg){var is_method=typeof arg=="string",args=Array.prototype.slice.call(arguments,1),result=null;return arg===!0&&!this.length?!1:(this.each(function(){var instance=$.jstree.reference(this),method=is_method&&instance?instance[arg]:null;return result=is_method&&method?method.apply(instance,args):null,instance||is_method||arg!==undefined&&!$.isPlainObject(arg)||$(this).data("jstree",new $.jstree.create(this,arg)),(instance&&!is_method||arg===!0)&&(result=instance||!1),result!==null&&result!==undefined?!1:void 0}),result!==null&&result!==undefined?result:this)};$.expr[":"].jstree=$.expr.createPseudo(function(){return function(a){return $(a).hasClass("jstree")&&$(a).data("jstree")!==undefined}});$.jstree.defaults.core={data:!1,strings:!1,check_callback:!1,error:$.noop,animation:200,multiple:!0,themes:{name:!1,url:!1,dir:!1,dots:!0,icons:!0,stripes:!1,variant:!1,responsive:!1},expand_selected_onload:!0,worker:!0,force_text:!1};$.jstree.core.prototype={plugin:function(deco,opts){var Child=$.jstree.plugins[deco];return Child?(this._data[deco]={},Child.prototype=this,new Child(opts,this)):this},init:function(el,options){this._model={data:{"#":{id:"#",parent:null,parents:[],children:[],children_d:[],state:{loaded:!1}}},changed:[],force_full_redraw:!1,redraw_timeout:!1,default_state:{loaded:!0,opened:!1,selected:!1,disabled:!1}};this.element=$(el).addClass("jstree jstree-"+this._id);this.settings=options;this.element.bind("destroyed",$.proxy(this.teardown,this));this._data.core.ready=!1;this._data.core.loaded=!1;this._data.core.rtl=this.element.css("direction")==="rtl";this.element[this._data.core.rtl?"addClass":"removeClass"]("jstree-rtl");this.element.attr("role","tree");this.settings.core.multiple&&this.element.attr("aria-multiselectable",!0);this.element.attr("tabindex")||this.element.attr("tabindex","0");this.bind();this.trigger("init");this._data.core.original_container_html=this.element.find(" > ul > li").clone(!0);this._data.core.original_container_html.find("li").addBack().contents().filter(function(){return this.nodeType===3&&(!this.nodeValue||/^\s+$/.test(this.nodeValue))}).remove();this.element.html("<ul class='jstree-container-ul jstree-children' role='group'><li id='j"+this._id+"_loading' class='jstree-initial-node jstree-loading jstree-leaf jstree-last' role='tree-item'><i class='jstree-icon jstree-ocl'><\/i><a class='jstree-anchor' href='#'><i class='jstree-icon jstree-themeicon-hidden'><\/i>"+this.get_string("Loading ...")+"<\/a><\/li><\/ul>");this.element.attr("aria-activedescendant","j"+this._id+"_loading");this._data.core.li_height=this.get_container_ul().children("li").first().height()||24;this.trigger("loading");this.load_node("#")},destroy:function(keep_html){if(this._wrk)try{window.URL.revokeObjectURL(this._wrk);this._wrk=null}catch(ignore){}keep_html||this.element.empty();this.element.unbind("destroyed",this.teardown);this.teardown()},teardown:function(){this.unbind();this.element.removeClass("jstree").removeData("jstree").find("[class^='jstree']").addBack().attr("class",function(){return this.className.replace(/jstree[^ ]*|$/ig,"")});this.element=null},bind:function(){var word="",tout=null;this.element.on("dblclick.jstree",function(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var sel=window.getSelection();try{sel.removeAllRanges();sel.collapse()}catch(ignore){}}}).on("click.jstree",".jstree-ocl",$.proxy(function(e){this.toggle_node(e.target)},this)).on("click.jstree",".jstree-anchor",$.proxy(function(e){e.preventDefault();e.currentTarget!==document.activeElement&&$(e.currentTarget).focus();this.activate_node(e.currentTarget,e)},this)).on("keydown.jstree",".jstree-anchor",$.proxy(function(e){if(e.target.tagName==="INPUT")return!0;var o=null;this._data.core.rtl&&(e.which===37?e.which=39:e.which===39&&(e.which=37));switch(e.which){case 32:e.ctrlKey&&(e.type="click",$(e.currentTarget).trigger(e));break;case 13:e.type="click";$(e.currentTarget).trigger(e);break;case 37:e.preventDefault();this.is_open(e.currentTarget)?this.close_node(e.currentTarget):(o=this.get_parent(e.currentTarget),o&&o.id!=="#"&&this.get_node(o,!0).children(".jstree-anchor").focus());break;case 38:e.preventDefault();o=this.get_prev_dom(e.currentTarget);o&&o.length&&o.children(".jstree-anchor").focus();break;case 39:e.preventDefault();this.is_closed(e.currentTarget)?this.open_node(e.currentTarget,function(o){this.get_node(o,!0).children(".jstree-anchor").focus()}):this.is_open(e.currentTarget)&&(o=this.get_node(e.currentTarget,!0).children(".jstree-children")[0],o&&$(this._firstChild(o)).children(".jstree-anchor").focus());break;case 40:e.preventDefault();o=this.get_next_dom(e.currentTarget);o&&o.length&&o.children(".jstree-anchor").focus();break;case 106:this.open_all();break;case 36:e.preventDefault();o=this._firstChild(this.get_container_ul()[0]);o&&$(o).children(".jstree-anchor").filter(":visible").focus();break;case 35:e.preventDefault();this.element.find(".jstree-anchor").filter(":visible").last().focus()}},this)).on("load_node.jstree",$.proxy(function(e,data){if(data.status&&(data.node.id!=="#"||this._data.core.loaded||(this._data.core.loaded=!0,this._firstChild(this.get_container_ul()[0])&&this.element.attr("aria-activedescendant",this._firstChild(this.get_container_ul()[0]).id),this.trigger("loaded")),!this._data.core.ready&&!this.get_container_ul().find(".jstree-loading").length)){if(this._data.core.ready=!0,this._data.core.selected.length){if(this.settings.core.expand_selected_onload){for(var tmp=[],i=0,j=this._data.core.selected.length;i<j;i++)tmp=tmp.concat(this._model.data[this._data.core.selected[i]].parents);for(tmp=$.vakata.array_unique(tmp),i=0,j=tmp.length;i<j;i++)this.open_node(tmp[i],!1,0)}this.trigger("changed",{action:"ready",selected:this._data.core.selected})}setTimeout($.proxy(function(){this.trigger("ready")},this),0)}},this)).on("keypress.jstree",$.proxy(function(e){if(e.target.tagName==="INPUT")return!0;tout&&clearTimeout(tout);tout=setTimeout(function(){word=""},500);var chr=String.fromCharCode(e.which).toLowerCase(),col=this.element.find(".jstree-anchor").filter(":visible"),ind=col.index(document.activeElement)||0,end=!1;if(word+=chr,word.length>1){if(col.slice(ind).each($.proxy(function(i,v){if($(v).text().toLowerCase().indexOf(word)===0)return $(v).focus(),end=!0,!1},this)),end)return;if(col.slice(0,ind).each($.proxy(function(i,v){if($(v).text().toLowerCase().indexOf(word)===0)return $(v).focus(),end=!0,!1},this)),end)return}if(new RegExp("^"+chr+"+$").test(word)){if(col.slice(ind+1).each($.proxy(function(i,v){if($(v).text().toLowerCase().charAt(0)===chr)return $(v).focus(),end=!0,!1},this)),end)return;if(col.slice(0,ind+1).each($.proxy(function(i,v){if($(v).text().toLowerCase().charAt(0)===chr)return $(v).focus(),end=!0,!1},this)),end)return}},this)).on("init.jstree",$.proxy(function(){var s=this.settings.core.themes;this._data.core.themes.dots=s.dots;this._data.core.themes.stripes=s.stripes;this._data.core.themes.icons=s.icons;this.set_theme(s.name||"default",s.url);this.set_theme_variant(s.variant)},this)).on("loading.jstree",$.proxy(function(){this[this._data.core.themes.dots?"show_dots":"hide_dots"]();this[this._data.core.themes.icons?"show_icons":"hide_icons"]();this[this._data.core.themes.stripes?"show_stripes":"hide_stripes"]()},this)).on("blur.jstree",".jstree-anchor",$.proxy(function(e){this._data.core.focused=null;$(e.currentTarget).filter(".jstree-hovered").mouseleave()},this)).on("focus.jstree",".jstree-anchor",$.proxy(function(e){var tmp=this.get_node(e.currentTarget);tmp&&tmp.id&&(this._data.core.focused=tmp.id);this.element.find(".jstree-hovered").not(e.currentTarget).mouseleave();$(e.currentTarget).mouseenter()},this)).on("focus.jstree",$.proxy(function(){this._data.core.focused||this.get_node(this.element.attr("aria-activedescendant"),!0).find("> .jstree-anchor").focus()},this)).on("mouseenter.jstree",".jstree-anchor",$.proxy(function(e){this.hover_node(e.currentTarget)},this)).on("mouseleave.jstree",".jstree-anchor",$.proxy(function(e){this.dehover_node(e.currentTarget)},this))},unbind:function(){this.element.off(".jstree");$(document).off(".jstree-"+this._id)},trigger:function(ev,data){data||(data={});data.instance=this;this.element.triggerHandler(ev.replace(".jstree","")+".jstree",data)},get_container:function(){return this.element},get_container_ul:function(){return this.element.children(".jstree-children").first()},get_string:function(key){var a=this.settings.core.strings;return $.isFunction(a)?a.call(this,key):a&&a[key]?a[key]:key},_firstChild:function(dom){for(dom=dom?dom.firstChild:null;dom!==null&&dom.nodeType!==1;)dom=dom.nextSibling;return dom},_nextSibling:function(dom){for(dom=dom?dom.nextSibling:null;dom!==null&&dom.nodeType!==1;)dom=dom.nextSibling;return dom},_previousSibling:function(dom){for(dom=dom?dom.previousSibling:null;dom!==null&&dom.nodeType!==1;)dom=dom.previousSibling;return dom},get_node:function(obj,as_dom){obj&&obj.id&&(obj=obj.id);var dom;try{if(this._model.data[obj])obj=this._model.data[obj];else if(typeof obj=="string"&&this._model.data[obj.replace(/^#/,"")])obj=this._model.data[obj.replace(/^#/,"")];else if(typeof obj=="string"&&(dom=$("#"+obj.replace($.jstree.idregex,"\\$&"),this.element)).length&&this._model.data[dom.closest(".jstree-node").attr("id")])obj=this._model.data[dom.closest(".jstree-node").attr("id")];else if((dom=$(obj,this.element)).length&&this._model.data[dom.closest(".jstree-node").attr("id")])obj=this._model.data[dom.closest(".jstree-node").attr("id")];else if((dom=$(obj,this.element)).length&&dom.hasClass("jstree"))obj=this._model.data["#"];else return!1;return as_dom&&(obj=obj.id==="#"?this.element:$("#"+obj.id.replace($.jstree.idregex,"\\$&"),this.element)),obj}catch(ex){return!1}},get_path:function(obj,glue,ids){if(obj=obj.parents?obj:this.get_node(obj),!obj||obj.id==="#"||!obj.parents)return!1;var i,j,p=[];for(p.push(ids?obj.id:obj.text),i=0,j=obj.parents.length;i<j;i++)p.push(ids?obj.parents[i]:this.get_text(obj.parents[i]));return p=p.reverse().slice(1),glue?p.join(glue):p},get_next_dom:function(obj,strict){var tmp;if(obj=this.get_node(obj,!0),obj[0]===this.element[0]){for(tmp=this._firstChild(this.get_container_ul()[0]);tmp&&tmp.offsetHeight===0;)tmp=this._nextSibling(tmp);return tmp?$(tmp):!1}if(!obj||!obj.length)return!1;if(strict){tmp=obj[0];do tmp=this._nextSibling(tmp);while(tmp&&tmp.offsetHeight===0);return tmp?$(tmp):!1}if(obj.hasClass("jstree-open")){for(tmp=this._firstChild(obj.children(".jstree-children")[0]);tmp&&tmp.offsetHeight===0;)tmp=this._nextSibling(tmp);if(tmp!==null)return $(tmp)}tmp=obj[0];do tmp=this._nextSibling(tmp);while(tmp&&tmp.offsetHeight===0);return tmp!==null?$(tmp):obj.parentsUntil(".jstree",".jstree-node").next(".jstree-node:visible").first()},get_prev_dom:function(obj,strict){var tmp;if(obj=this.get_node(obj,!0),obj[0]===this.element[0]){for(tmp=this.get_container_ul()[0].lastChild;tmp&&tmp.offsetHeight===0;)tmp=this._previousSibling(tmp);return tmp?$(tmp):!1}if(!obj||!obj.length)return!1;if(strict){tmp=obj[0];do tmp=this._previousSibling(tmp);while(tmp&&tmp.offsetHeight===0);return tmp?$(tmp):!1}tmp=obj[0];do tmp=this._previousSibling(tmp);while(tmp&&tmp.offsetHeight===0);if(tmp!==null){for(obj=$(tmp);obj.hasClass("jstree-open");)obj=obj.children(".jstree-children").first().children(".jstree-node:visible:last");return obj}return tmp=obj[0].parentNode.parentNode,tmp&&tmp.className&&tmp.className.indexOf("jstree-node")!==-1?$(tmp):!1},get_parent:function(obj){return(obj=this.get_node(obj),!obj||obj.id==="#")?!1:obj.parent},get_children_dom:function(obj){return(obj=this.get_node(obj,!0),obj[0]===this.element[0])?this.get_container_ul().children(".jstree-node"):!obj||!obj.length?!1:obj.children(".jstree-children").children(".jstree-node")},is_parent:function(obj){return obj=this.get_node(obj),obj&&(obj.state.loaded===!1||obj.children.length>0)},is_loaded:function(obj){return obj=this.get_node(obj),obj&&obj.state.loaded},is_loading:function(obj){return obj=this.get_node(obj),obj&&obj.state&&obj.state.loading},is_open:function(obj){return obj=this.get_node(obj),obj&&obj.state.opened},is_closed:function(obj){return obj=this.get_node(obj),obj&&this.is_parent(obj)&&!obj.state.opened},is_leaf:function(obj){return!this.is_parent(obj)},load_node:function(obj,callback){var k,l,i,j,c;if($.isArray(obj))return this._load_nodes(obj.slice(),callback),!0;if(obj=this.get_node(obj),!obj)return callback&&callback.call(this,obj,!1),!1;if(obj.state.loaded){for(obj.state.loaded=!1,k=0,l=obj.children_d.length;k<l;k++){for(i=0,j=obj.parents.length;i<j;i++)this._model.data[obj.parents[i]].children_d=$.vakata.array_remove_item(this._model.data[obj.parents[i]].children_d,obj.children_d[k]);this._model.data[obj.children_d[k]].state.selected&&(c=!0,this._data.core.selected=$.vakata.array_remove_item(this._data.core.selected,obj.children_d[k]));delete this._model.data[obj.children_d[k]]}obj.children=[];obj.children_d=[];c&&this.trigger("changed",{action:"load_node",node:obj,selected:this._data.core.selected})}return obj.state.loading=!0,this.get_node(obj,!0).addClass("jstree-loading").attr("aria-busy",!0),this._load_node(obj,$.proxy(function(status){obj=this._model.data[obj.id];obj.state.loading=!1;obj.state.loaded=status;var dom=this.get_node(obj,!0);obj.state.loaded&&!obj.children.length&&dom&&dom.length&&!dom.hasClass("jstree-leaf")&&dom.removeClass("jstree-closed jstree-open").addClass("jstree-leaf");dom.removeClass("jstree-loading").attr("aria-busy",!1);this.trigger("load_node",{node:obj,status:status});callback&&callback.call(this,obj,status)},this)),!0},_load_nodes:function(nodes,callback,is_callback){for(var r=!0,c=function(){this._load_nodes(nodes,callback,!0)},m=this._model.data,i=0,j=nodes.length;i<j;i++)!m[nodes[i]]||m[nodes[i]].state.loaded&&is_callback||(this.is_loading(nodes[i])||this.load_node(nodes[i],c),r=!1);r&&callback&&!callback.done&&(callback.call(this,nodes),callback.done=!0)},load_all:function(obj,callback){if(obj||(obj="#"),obj=this.get_node(obj),!obj)return!1;var to_load=[],m=this._model.data,c=m[obj.id].children_d,i,j;for(obj.state&&!obj.state.loaded&&to_load.push(obj.id),i=0,j=c.length;i<j;i++)m[c[i]]&&m[c[i]].state&&!m[c[i]].state.loaded&&to_load.push(c[i]);to_load.length?this._load_nodes(to_load,function(){this.load_all(obj,callback)}):(callback&&callback.call(this,obj),this.trigger("load_all",{node:obj}))},_load_node:function(obj,callback){var s=this.settings.core.data,t;return s?$.isFunction(s)?s.call(this,obj,$.proxy(function(d){d===!1&&callback.call(this,!1);this[typeof d=="string"?"_append_html_data":"_append_json_data"](obj,typeof d=="string"?$(d):d,function(status){callback.call(this,status)})},this)):typeof s=="object"?s.url?(s=$.extend(!0,{},s),$.isFunction(s.url)&&(s.url=s.url.call(this,obj)),$.isFunction(s.data)&&(s.data=s.data.call(this,obj)),$.ajax(s).done($.proxy(function(d,t,x){var type=x.getResponseHeader("Content-Type");return type.indexOf("json")!==-1||typeof d=="object"?this._append_json_data(obj,d,function(status){callback.call(this,status)}):type.indexOf("html")!==-1||typeof d=="string"?this._append_html_data(obj,$(d),function(status){callback.call(this,status)}):(this._data.core.last_error={error:"ajax",plugin:"core",id:"core_04",reason:"Could not load node",data:JSON.stringify({id:obj.id,xhr:x})},this.settings.core.error.call(this,this._data.core.last_error),callback.call(this,!1))},this)).fail($.proxy(function(f){callback.call(this,!1);this._data.core.last_error={error:"ajax",plugin:"core",id:"core_04",reason:"Could not load node",data:JSON.stringify({id:obj.id,xhr:f})};this.settings.core.error.call(this,this._data.core.last_error)},this))):(t=$.isArray(s)||$.isPlainObject(s)?JSON.parse(JSON.stringify(s)):s,obj.id==="#"?this._append_json_data(obj,t,function(status){callback.call(this,status)}):(this._data.core.last_error={error:"nodata",plugin:"core",id:"core_05",reason:"Could not load node",data:JSON.stringify({id:obj.id})},this.settings.core.error.call(this,this._data.core.last_error),callback.call(this,!1))):typeof s=="string"?obj.id==="#"?this._append_html_data(obj,$(s),function(status){callback.call(this,status)}):(this._data.core.last_error={error:"nodata",plugin:"core",id:"core_06",reason:"Could not load node",data:JSON.stringify({id:obj.id})},this.settings.core.error.call(this,this._data.core.last_error),callback.call(this,!1)):callback.call(this,!1):obj.id==="#"?this._append_html_data(obj,this._data.core.original_container_html.clone(!0),function(status){callback.call(this,status)}):callback.call(this,!1)},_node_changed:function(obj){obj=this.get_node(obj);obj&&this._model.changed.push(obj.id)},_append_html_data:function(dom,data,cb){dom=this.get_node(dom);dom.children=[];dom.children_d=[];var dat=data.is("ul")?data.children():data,par=dom.id,chd=[],dpc=[],m=this._model.data,p=m[par],s=this._data.core.selected.length,tmp,i,j;for(dat.each($.proxy(function(i,v){tmp=this._parse_model_from_html($(v),par,p.parents.concat());tmp&&(chd.push(tmp),dpc.push(tmp),m[tmp].children_d.length&&(dpc=dpc.concat(m[tmp].children_d)))},this)),p.children=chd,p.children_d=dpc,i=0,j=p.parents.length;i<j;i++)m[p.parents[i]].children_d=m[p.parents[i]].children_d.concat(dpc);this.trigger("model",{nodes:dpc,parent:par});par!=="#"?(this._node_changed(par),this.redraw()):(this.get_container_ul().children(".jstree-initial-node").remove(),this.redraw(!0));this._data.core.selected.length!==s&&this.trigger("changed",{action:"model",selected:this._data.core.selected});cb.call(this,!0)},_append_json_data:function(dom,data,cb,force_processing){dom=this.get_node(dom);dom.children=[];dom.children_d=[];data.d&&(data=data.d,typeof data=="string"&&(data=JSON.parse(data)));$.isArray(data)||(data=[data]);var w=null,args={df:this._model.default_state,dat:data,par:dom.id,m:this._model.data,t_id:this._id,t_cnt:this._cnt,sel:this._data.core.selected},func=function(data,undefined){data.data&&(data=data.data);var dat=data.dat,par=data.par,chd=[],dpc=[],add=[],df=data.df,t_id=data.t_id,t_cnt=data.t_cnt,m=data.m,p=m[par],sel=data.sel,tmp,i,j,rslt,parse_flat=function(d,p,ps){ps=ps?ps.concat():[];p&&ps.unshift(p);var tid=d.id.toString(),i,j,c,e,tmp={id:tid,text:d.text||"",icon:d.icon!==undefined?d.icon:!0,parent:p,parents:ps,children:d.children||[],children_d:d.children_d||[],data:d.data,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(i in df)df.hasOwnProperty(i)&&(tmp.state[i]=df[i]);if(d&&d.data&&d.data.jstree&&d.data.jstree.icon&&(tmp.icon=d.data.jstree.icon),d&&d.data&&(tmp.data=d.data,d.data.jstree))for(i in d.data.jstree)d.data.jstree.hasOwnProperty(i)&&(tmp.state[i]=d.data.jstree[i]);if(d&&typeof d.state=="object")for(i in d.state)d.state.hasOwnProperty(i)&&(tmp.state[i]=d.state[i]);if(d&&typeof d.li_attr=="object")for(i in d.li_attr)d.li_attr.hasOwnProperty(i)&&(tmp.li_attr[i]=d.li_attr[i]);if(tmp.li_attr.id||(tmp.li_attr.id=tid),d&&typeof d.a_attr=="object")for(i in d.a_attr)d.a_attr.hasOwnProperty(i)&&(tmp.a_attr[i]=d.a_attr[i]);for(d&&d.children&&d.children===!0&&(tmp.state.loaded=!1,tmp.children=[],tmp.children_d=[]),m[tmp.id]=tmp,i=0,j=tmp.children.length;i<j;i++)c=parse_flat(m[tmp.children[i]],tmp.id,ps),e=m[c],tmp.children_d.push(c),e.children_d.length&&(tmp.children_d=tmp.children_d.concat(e.children_d));return delete d.data,delete d.children,m[tmp.id].original=d,tmp.state.selected&&add.push(tmp.id),tmp.id},parse_nest=function(d,p,ps){ps=ps?ps.concat():[];p&&ps.unshift(p);var tid=!1,i,j,c,e,tmp;do tid="j"+t_id+"_"+ ++t_cnt;while(m[tid]);tmp={id:!1,text:typeof d=="string"?d:"",icon:typeof d=="object"&&d.icon!==undefined?d.icon:!0,parent:p,parents:ps,children:[],children_d:[],data:null,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(i in df)df.hasOwnProperty(i)&&(tmp.state[i]=df[i]);if(d&&d.id&&(tmp.id=d.id.toString()),d&&d.text&&(tmp.text=d.text),d&&d.data&&d.data.jstree&&d.data.jstree.icon&&(tmp.icon=d.data.jstree.icon),d&&d.data&&(tmp.data=d.data,d.data.jstree))for(i in d.data.jstree)d.data.jstree.hasOwnProperty(i)&&(tmp.state[i]=d.data.jstree[i]);if(d&&typeof d.state=="object")for(i in d.state)d.state.hasOwnProperty(i)&&(tmp.state[i]=d.state[i]);if(d&&typeof d.li_attr=="object")for(i in d.li_attr)d.li_attr.hasOwnProperty(i)&&(tmp.li_attr[i]=d.li_attr[i]);if(tmp.li_attr.id&&!tmp.id&&(tmp.id=tmp.li_attr.id.toString()),tmp.id||(tmp.id=tid),tmp.li_attr.id||(tmp.li_attr.id=tmp.id),d&&typeof d.a_attr=="object")for(i in d.a_attr)d.a_attr.hasOwnProperty(i)&&(tmp.a_attr[i]=d.a_attr[i]);if(d&&d.children&&d.children.length){for(i=0,j=d.children.length;i<j;i++)c=parse_nest(d.children[i],tmp.id,ps),e=m[c],tmp.children.push(c),e.children_d.length&&(tmp.children_d=tmp.children_d.concat(e.children_d));tmp.children_d=tmp.children_d.concat(tmp.children)}return d&&d.children&&d.children===!0&&(tmp.state.loaded=!1,tmp.children=[],tmp.children_d=[]),delete d.data,delete d.children,tmp.original=d,m[tmp.id]=tmp,tmp.state.selected&&add.push(tmp.id),tmp.id};if(dat.length&&dat[0].id!==undefined&&dat[0].parent!==undefined){for(i=0,j=dat.length;i<j;i++)dat[i].children||(dat[i].children=[]),m[dat[i].id.toString()]=dat[i];for(i=0,j=dat.length;i<j;i++)m[dat[i].parent.toString()].children.push(dat[i].id.toString()),p.children_d.push(dat[i].id.toString());for(i=0,j=p.children.length;i<j;i++)tmp=parse_flat(m[p.children[i]],par,p.parents.concat()),dpc.push(tmp),m[tmp].children_d.length&&(dpc=dpc.concat(m[tmp].children_d));for(i=0,j=p.parents.length;i<j;i++)m[p.parents[i]].children_d=m[p.parents[i]].children_d.concat(dpc);rslt={cnt:t_cnt,mod:m,sel:sel,par:par,dpc:dpc,add:add}}else{for(i=0,j=dat.length;i<j;i++)tmp=parse_nest(dat[i],par,p.parents.concat()),tmp&&(chd.push(tmp),dpc.push(tmp),m[tmp].children_d.length&&(dpc=dpc.concat(m[tmp].children_d)));for(p.children=chd,p.children_d=dpc,i=0,j=p.parents.length;i<j;i++)m[p.parents[i]].children_d=m[p.parents[i]].children_d.concat(dpc);rslt={cnt:t_cnt,mod:m,sel:sel,par:par,dpc:dpc,add:add}}if(typeof window=="undefined"||typeof document=="undefined")postMessage(rslt);else return rslt},rslt=function(rslt,worker){if(this._cnt=rslt.cnt,this._model.data=rslt.mod,worker){var i,j,a=rslt.add,r=rslt.sel,s=this._data.core.selected.slice(),m=this._model.data;if(r.length!==s.length||$.vakata.array_unique(r.concat(s)).length!==r.length){for(i=0,j=r.length;i<j;i++)$.inArray(r[i],a)===-1&&$.inArray(r[i],s)===-1&&(m[r[i]].state.selected=!1);for(i=0,j=s.length;i<j;i++)$.inArray(s[i],r)===-1&&(m[s[i]].state.selected=!0)}}rslt.add.length&&(this._data.core.selected=this._data.core.selected.concat(rslt.add));this.trigger("model",{nodes:rslt.dpc,parent:rslt.par});rslt.par!=="#"?(this._node_changed(rslt.par),this.redraw()):this.redraw(!0);rslt.add.length&&this.trigger("changed",{action:"model",selected:this._data.core.selected});cb.call(this,!0)};if(this.settings.core.worker&&window.Blob&&window.URL&&window.Worker)try{this._wrk===null&&(this._wrk=window.URL.createObjectURL(new window.Blob(["self.onmessage = "+func.toString()],{type:"text/javascript"})));!this._data.core.working||force_processing?(this._data.core.working=!0,w=new window.Worker(this._wrk),w.onmessage=$.proxy(function(e){rslt.call(this,e.data,!0);try{w.terminate();w=null}catch(ignore){}this._data.core.worker_queue.length?this._append_json_data.apply(this,this._data.core.worker_queue.shift()):this._data.core.working=!1},this),args.par?w.postMessage(args):this._data.core.worker_queue.length?this._append_json_data.apply(this,this._data.core.worker_queue.shift()):this._data.core.working=!1):this._data.core.worker_queue.push([dom,data,cb,!0])}catch(e){rslt.call(this,func(args),!1);this._data.core.worker_queue.length?this._append_json_data.apply(this,this._data.core.worker_queue.shift()):this._data.core.working=!1}else rslt.call(this,func(args),!1)},_parse_model_from_html:function(d,p,ps){ps=ps?[].concat(ps):[];p&&ps.unshift(p);var c,e,m=this._model.data,data={id:!1,text:!1,icon:!0,parent:p,parents:ps,children:[],children_d:[],data:null,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1},i,tmp,tid;for(i in this._model.default_state)this._model.default_state.hasOwnProperty(i)&&(data.state[i]=this._model.default_state[i]);if(tmp=$.vakata.attributes(d,!0),$.each(tmp,function(i,v){if(v=$.trim(v),!v.length)return!0;data.li_attr[i]=v;i==="id"&&(data.id=v.toString())}),tmp=d.children("a").first(),tmp.length&&(tmp=$.vakata.attributes(tmp,!0),$.each(tmp,function(i,v){v=$.trim(v);v.length&&(data.a_attr[i]=v)})),tmp=d.children("a").first().length?d.children("a").first().clone():d.clone(),tmp.children("ins, i, ul").remove(),tmp=tmp.html(),tmp=$("<div />").html(tmp),data.text=this.settings.core.force_text?tmp.text():tmp.html(),tmp=d.data(),data.data=tmp?$.extend(!0,{},tmp):null,data.state.opened=d.hasClass("jstree-open"),data.state.selected=d.children("a").hasClass("jstree-clicked"),data.state.disabled=d.children("a").hasClass("jstree-disabled"),data.data&&data.data.jstree)for(i in data.data.jstree)data.data.jstree.hasOwnProperty(i)&&(data.state[i]=data.data.jstree[i]);tmp=d.children("a").children(".jstree-themeicon");tmp.length&&(data.icon=tmp.hasClass("jstree-themeicon-hidden")?!1:tmp.attr("rel"));data.state.icon&&(data.icon=data.state.icon);tmp=d.children("ul").children("li");do tid="j"+this._id+"_"+ ++this._cnt;while(m[tid]);return data.id=data.li_attr.id?data.li_attr.id.toString():tid,tmp.length?(tmp.each($.proxy(function(i,v){c=this._parse_model_from_html($(v),data.id,ps);e=this._model.data[c];data.children.push(c);e.children_d.length&&(data.children_d=data.children_d.concat(e.children_d))},this)),data.children_d=data.children_d.concat(data.children)):d.hasClass("jstree-closed")&&(data.state.loaded=!1),data.li_attr["class"]&&(data.li_attr["class"]=data.li_attr["class"].replace("jstree-closed","").replace("jstree-open","")),data.a_attr["class"]&&(data.a_attr["class"]=data.a_attr["class"].replace("jstree-clicked","").replace("jstree-disabled","")),m[data.id]=data,data.state.selected&&this._data.core.selected.push(data.id),data.id},_parse_model_from_flat_json:function(d,p,ps){ps=ps?ps.concat():[];p&&ps.unshift(p);var tid=d.id.toString(),m=this._model.data,df=this._model.default_state,i,j,c,e,tmp={id:tid,text:d.text||"",icon:d.icon!==undefined?d.icon:!0,parent:p,parents:ps,children:d.children||[],children_d:d.children_d||[],data:d.data,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(i in df)df.hasOwnProperty(i)&&(tmp.state[i]=df[i]);if(d&&d.data&&d.data.jstree&&d.data.jstree.icon&&(tmp.icon=d.data.jstree.icon),d&&d.data&&(tmp.data=d.data,d.data.jstree))for(i in d.data.jstree)d.data.jstree.hasOwnProperty(i)&&(tmp.state[i]=d.data.jstree[i]);if(d&&typeof d.state=="object")for(i in d.state)d.state.hasOwnProperty(i)&&(tmp.state[i]=d.state[i]);if(d&&typeof d.li_attr=="object")for(i in d.li_attr)d.li_attr.hasOwnProperty(i)&&(tmp.li_attr[i]=d.li_attr[i]);if(tmp.li_attr.id||(tmp.li_attr.id=tid),d&&typeof d.a_attr=="object")for(i in d.a_attr)d.a_attr.hasOwnProperty(i)&&(tmp.a_attr[i]=d.a_attr[i]);for(d&&d.children&&d.children===!0&&(tmp.state.loaded=!1,tmp.children=[],tmp.children_d=[]),m[tmp.id]=tmp,i=0,j=tmp.children.length;i<j;i++)c=this._parse_model_from_flat_json(m[tmp.children[i]],tmp.id,ps),e=m[c],tmp.children_d.push(c),e.children_d.length&&(tmp.children_d=tmp.children_d.concat(e.children_d));return delete d.data,delete d.children,m[tmp.id].original=d,tmp.state.selected&&this._data.core.selected.push(tmp.id),tmp.id},_parse_model_from_json:function(d,p,ps){ps=ps?ps.concat():[];p&&ps.unshift(p);var tid=!1,i,j,c,e,m=this._model.data,df=this._model.default_state,tmp;do tid="j"+this._id+"_"+ ++this._cnt;while(m[tid]);tmp={id:!1,text:typeof d=="string"?d:"",icon:typeof d=="object"&&d.icon!==undefined?d.icon:!0,parent:p,parents:ps,children:[],children_d:[],data:null,state:{},li_attr:{id:!1},a_attr:{href:"#"},original:!1};for(i in df)df.hasOwnProperty(i)&&(tmp.state[i]=df[i]);if(d&&d.id&&(tmp.id=d.id.toString()),d&&d.text&&(tmp.text=d.text),d&&d.data&&d.data.jstree&&d.data.jstree.icon&&(tmp.icon=d.data.jstree.icon),d&&d.data&&(tmp.data=d.data,d.data.jstree))for(i in d.data.jstree)d.data.jstree.hasOwnProperty(i)&&(tmp.state[i]=d.data.jstree[i]);if(d&&typeof d.state=="object")for(i in d.state)d.state.hasOwnProperty(i)&&(tmp.state[i]=d.state[i]);if(d&&typeof d.li_attr=="object")for(i in d.li_attr)d.li_attr.hasOwnProperty(i)&&(tmp.li_attr[i]=d.li_attr[i]);if(tmp.li_attr.id&&!tmp.id&&(tmp.id=tmp.li_attr.id.toString()),tmp.id||(tmp.id=tid),tmp.li_attr.id||(tmp.li_attr.id=tmp.id),d&&typeof d.a_attr=="object")for(i in d.a_attr)d.a_attr.hasOwnProperty(i)&&(tmp.a_attr[i]=d.a_attr[i]);if(d&&d.children&&d.children.length){for(i=0,j=d.children.length;i<j;i++)c=this._parse_model_from_json(d.children[i],tmp.id,ps),e=m[c],tmp.children.push(c),e.children_d.length&&(tmp.children_d=tmp.children_d.concat(e.children_d));tmp.children_d=tmp.children_d.concat(tmp.children)}return d&&d.children&&d.children===!0&&(tmp.state.loaded=!1,tmp.children=[],tmp.children_d=[]),delete d.data,delete d.children,tmp.original=d,m[tmp.id]=tmp,tmp.state.selected&&this._data.core.selected.push(tmp.id),tmp.id},_redraw:function(){for(var nodes=this._model.force_full_redraw?this._model.data["#"].children.concat([]):this._model.changed.concat([]),f=document.createElement("UL"),tmp,fe=this._data.core.focused,i=0,j=nodes.length;i<j;i++)tmp=this.redraw_node(nodes[i],!0,this._model.force_full_redraw),tmp&&this._model.force_full_redraw&&f.appendChild(tmp);this._model.force_full_redraw&&(f.className=this.get_container_ul()[0].className,f.setAttribute("role","group"),this.element.empty().append(f));fe!==null&&(tmp=this.get_node(fe,!0),tmp&&tmp.length&&tmp.children(".jstree-anchor")[0]!==document.activeElement?tmp.children(".jstree-anchor").focus():this._data.core.focused=null);this._model.force_full_redraw=!1;this._model.changed=[];this.trigger("redraw",{nodes:nodes})},redraw:function(full){full&&(this._model.force_full_redraw=!0);this._redraw()},redraw_node:function(node,deep,is_callback,force_render){var obj=this.get_node(node),par=!1,ind=!1,old=!1,i=!1,j=!1,k=!1,c="",d=document,m=this._model.data,f=!1,tmp=null;if(!obj)return!1;if(obj.id==="#")return this.redraw(!0);if(deep=deep||obj.children.length===0,node=document.querySelector?this.element[0].querySelector("#"+("0123456789".indexOf(obj.id[0])!==-1?"\\3"+obj.id[0]+" "+obj.id.substr(1).replace($.jstree.idregex,"\\$&"):obj.id.replace($.jstree.idregex,"\\$&"))):document.getElementById(obj.id),node)node=$(node),is_callback||(par=node.parent().parent()[0],par===this.element[0]&&(par=null),ind=node.index()),deep||!obj.children.length||node.children(".jstree-children").length||(deep=!0),deep||(old=node.children(".jstree-children")[0]),f=node.children(".jstree-anchor")[0]===document.activeElement,node.remove();else if(deep=!0,!is_callback){if(par=obj.parent!=="#"?$("#"+obj.parent.replace($.jstree.idregex,"\\$&"),this.element)[0]:null,par!==null&&(!par||!m[obj.parent].state.opened))return!1;ind=$.inArray(obj.id,par===null?m["#"].children:m[obj.parent].children)}node=_node.cloneNode(!0);c="jstree-node ";for(i in obj.li_attr)if(obj.li_attr.hasOwnProperty(i)){if(i==="id")continue;i!=="class"?node.setAttribute(i,obj.li_attr[i]):c+=obj.li_attr[i]}obj.a_attr.id||(obj.a_attr.id=obj.id+"_anchor");node.setAttribute("aria-selected",!!obj.state.selected);node.setAttribute("aria-level",obj.parents.length);node.setAttribute("aria-labelledby",obj.a_attr.id);obj.state.disabled&&node.setAttribute("aria-disabled",!0);obj.state.loaded&&!obj.children.length?c+=" jstree-leaf":(c+=obj.state.opened&&obj.state.loaded?" jstree-open":" jstree-closed",node.setAttribute("aria-expanded",obj.state.opened&&obj.state.loaded));obj.parent!==null&&m[obj.parent].children[m[obj.parent].children.length-1]===obj.id&&(c+=" jstree-last");node.id=obj.id;node.className=c;c=(obj.state.selected?" jstree-clicked":"")+(obj.state.disabled?" jstree-disabled":"");for(j in obj.a_attr)if(obj.a_attr.hasOwnProperty(j)){if(j==="href"&&obj.a_attr[j]==="#")continue;j!=="class"?node.childNodes[1].setAttribute(j,obj.a_attr[j]):c+=" "+obj.a_attr[j]}if(c.length&&(node.childNodes[1].className="jstree-anchor "+c),(obj.icon&&obj.icon!==!0||obj.icon===!1)&&(obj.icon===!1?node.childNodes[1].childNodes[0].className+=" jstree-themeicon-hidden":obj.icon.indexOf("/")===-1&&obj.icon.indexOf(".")===-1?node.childNodes[1].childNodes[0].className+=" "+obj.icon+" jstree-themeicon-custom":(node.childNodes[1].childNodes[0].style.backgroundImage="url("+obj.icon+")",node.childNodes[1].childNodes[0].style.backgroundPosition="center center",node.childNodes[1].childNodes[0].style.backgroundSize="auto",node.childNodes[1].childNodes[0].className+=" jstree-themeicon-custom")),this.settings.core.force_text?node.childNodes[1].appendChild(d.createTextNode(obj.text)):node.childNodes[1].innerHTML+=obj.text,deep&&obj.children.length&&(obj.state.opened||force_render)&&obj.state.loaded){for(k=d.createElement("UL"),k.setAttribute("role","group"),k.className="jstree-children",i=0,j=obj.children.length;i<j;i++)k.appendChild(this.redraw_node(obj.children[i],deep,!0));node.appendChild(k)}if(old&&node.appendChild(old),!is_callback){for(par||(par=this.element[0]),i=0,j=par.childNodes.length;i<j;i++)if(par.childNodes[i]&&par.childNodes[i].className&&par.childNodes[i].className.indexOf("jstree-children")!==-1){tmp=par.childNodes[i];break}tmp||(tmp=d.createElement("UL"),tmp.setAttribute("role","group"),tmp.className="jstree-children",par.appendChild(tmp));par=tmp;ind<par.childNodes.length?par.insertBefore(node,par.childNodes[ind]):par.appendChild(node);f&&node.childNodes[1].focus()}return obj.state.opened&&!obj.state.loaded&&(obj.state.opened=!1,setTimeout($.proxy(function(){this.open_node(obj.id,!1,0)},this),0)),node},open_node:function(obj,callback,animation){var t1,t2,d,t;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.open_node(obj[t1],callback,animation);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;if(animation=animation===undefined?this.settings.core.animation:animation,!this.is_closed(obj))return callback&&callback.call(this,obj,!1),!1;if(this.is_loaded(obj))d=this.get_node(obj,!0),t=this,d.length&&(obj.children.length&&!this._firstChild(d.children(".jstree-children")[0])&&(this.redraw_node(obj,!0,!1,!0),d=this.get_node(obj,!0)),animation?(this.trigger("before_open",{node:obj}),d.children(".jstree-children").css("display","none").end().removeClass("jstree-closed").addClass("jstree-open").attr("aria-expanded",!0).children(".jstree-children").stop(!0,!0).slideDown(animation,function(){this.style.display="";t.trigger("after_open",{node:obj})})):(this.trigger("before_open",{node:obj}),d[0].className=d[0].className.replace("jstree-closed","jstree-open"),d[0].setAttribute("aria-expanded",!0))),obj.state.opened=!0,callback&&callback.call(this,obj,!0),d.length||this.trigger("before_open",{node:obj}),this.trigger("open_node",{node:obj}),animation&&d.length||this.trigger("after_open",{node:obj});else{if(this.is_loading(obj))return setTimeout($.proxy(function(){this.open_node(obj,callback,animation)},this),500);this.load_node(obj,function(o,ok){return ok?this.open_node(o,callback,animation):callback?callback.call(this,o,!1):!1})}},_open_to:function(obj){if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;for(var p=obj.parents,i=0,j=p.length;i<j;i+=1)i!=="#"&&this.open_node(p[i],!1,0);return $("#"+obj.id.replace($.jstree.idregex,"\\$&"),this.element)},close_node:function(obj,animation){var t1,t2,t,d;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.close_node(obj[t1],animation);return!0}if((obj=this.get_node(obj),!obj||obj.id==="#")||this.is_closed(obj))return!1;animation=animation===undefined?this.settings.core.animation:animation;t=this;d=this.get_node(obj,!0);d.length&&(animation?d.children(".jstree-children").attr("style","display:block !important").end().removeClass("jstree-open").addClass("jstree-closed").attr("aria-expanded",!1).children(".jstree-children").stop(!0,!0).slideUp(animation,function(){this.style.display="";d.children(".jstree-children").remove();t.trigger("after_close",{node:obj})}):(d[0].className=d[0].className.replace("jstree-open","jstree-closed"),d.attr("aria-expanded",!1).children(".jstree-children").remove()));obj.state.opened=!1;this.trigger("close_node",{node:obj});animation&&d.length||this.trigger("after_close",{node:obj})},toggle_node:function(obj){var t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.toggle_node(obj[t1]);return!0}return this.is_closed(obj)?this.open_node(obj):this.is_open(obj)?this.close_node(obj):void 0},open_all:function(obj,animation,original_obj){if(obj||(obj="#"),obj=this.get_node(obj),!obj)return!1;var dom=obj.id==="#"?this.get_container_ul():this.get_node(obj,!0),i,j,_this;if(!dom.length){for(i=0,j=obj.children_d.length;i<j;i++)this.is_closed(this._model.data[obj.children_d[i]])&&(this._model.data[obj.children_d[i]].state.opened=!0);return this.trigger("open_all",{node:obj})}original_obj=original_obj||dom;_this=this;dom=this.is_closed(obj)?dom.find(".jstree-closed").addBack():dom.find(".jstree-closed");dom.each(function(){_this.open_node(this,function(node,status){status&&this.is_parent(node)&&this.open_all(node,animation,original_obj)},animation||0)});original_obj.find(".jstree-closed").length===0&&this.trigger("open_all",{node:this.get_node(original_obj)})},close_all:function(obj,animation){if(obj||(obj="#"),obj=this.get_node(obj),!obj)return!1;var dom=obj.id==="#"?this.get_container_ul():this.get_node(obj,!0),_this=this,i,j;if(!dom.length){for(i=0,j=obj.children_d.length;i<j;i++)this._model.data[obj.children_d[i]].state.opened=!1;return this.trigger("close_all",{node:obj})}dom=this.is_open(obj)?dom.find(".jstree-open").addBack():dom.find(".jstree-open");$(dom.get().reverse()).each(function(){_this.close_node(this,animation||0)});this.trigger("close_all",{node:obj})},is_disabled:function(obj){return obj=this.get_node(obj),obj&&obj.state&&obj.state.disabled},enable_node:function(obj){var t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.enable_node(obj[t1]);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;obj.state.disabled=!1;this.get_node(obj,!0).children(".jstree-anchor").removeClass("jstree-disabled").attr("aria-disabled",!1);this.trigger("enable_node",{node:obj})},disable_node:function(obj){var t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.disable_node(obj[t1]);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;obj.state.disabled=!0;this.get_node(obj,!0).children(".jstree-anchor").addClass("jstree-disabled").attr("aria-disabled",!0);this.trigger("disable_node",{node:obj})},activate_node:function(obj,e){if(this.is_disabled(obj))return!1;if(this._data.core.last_clicked=this._data.core.last_clicked&&this._data.core.last_clicked.id!==undefined?this.get_node(this._data.core.last_clicked.id):null,this._data.core.last_clicked&&!this._data.core.last_clicked.state.selected&&(this._data.core.last_clicked=null),!this._data.core.last_clicked&&this._data.core.selected.length&&(this._data.core.last_clicked=this.get_node(this._data.core.selected[this._data.core.selected.length-1])),this.settings.core.multiple&&(e.metaKey||e.ctrlKey||e.shiftKey)&&(!e.shiftKey||this._data.core.last_clicked&&this.get_parent(obj)&&this.get_parent(obj)===this._data.core.last_clicked.parent))if(e.shiftKey){for(var o=this.get_node(obj).id,l=this._data.core.last_clicked.id,p=this.get_node(this._data.core.last_clicked.parent).children,c=!1,i=0,j=p.length;i<j;i+=1)p[i]===o&&(c=!c),p[i]===l&&(c=!c),c||p[i]===o||p[i]===l?this.select_node(p[i],!0,!1,e):this.deselect_node(p[i],!0,e);this.trigger("changed",{action:"select_node",node:this.get_node(obj),selected:this._data.core.selected,event:e})}else this.is_selected(obj)?this.deselect_node(obj,!1,e):this.select_node(obj,!1,!1,e);else!this.settings.core.multiple&&(e.metaKey||e.ctrlKey||e.shiftKey)&&this.is_selected(obj)?this.deselect_node(obj,!1,e):(this.deselect_all(!0),this.select_node(obj,!1,!1,e),this._data.core.last_clicked=this.get_node(obj));this.trigger("activate_node",{node:this.get_node(obj)})},hover_node:function(obj){if(obj=this.get_node(obj,!0),!obj||!obj.length||obj.children(".jstree-hovered").length)return!1;var o=this.element.find(".jstree-hovered"),t=this.element;o&&o.length&&this.dehover_node(o);obj.children(".jstree-anchor").addClass("jstree-hovered");this.trigger("hover_node",{node:this.get_node(obj)});setTimeout(function(){t.attr("aria-activedescendant",obj[0].id)},0)},dehover_node:function(obj){if(obj=this.get_node(obj,!0),!obj||!obj.length||!obj.children(".jstree-hovered").length)return!1;obj.children(".jstree-anchor").removeClass("jstree-hovered");this.trigger("dehover_node",{node:this.get_node(obj)})},select_node:function(obj,supress_event,prevent_open,e){var dom,t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.select_node(obj[t1],supress_event,prevent_open,e);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;dom=this.get_node(obj,!0);obj.state.selected||(obj.state.selected=!0,this._data.core.selected.push(obj.id),prevent_open||(dom=this._open_to(obj)),dom&&dom.length&&dom.attr("aria-selected",!0).children(".jstree-anchor").addClass("jstree-clicked"),this.trigger("select_node",{node:obj,selected:this._data.core.selected,event:e}),supress_event||this.trigger("changed",{action:"select_node",node:obj,selected:this._data.core.selected,event:e}))},deselect_node:function(obj,supress_event,e){var t1,t2,dom;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.deselect_node(obj[t1],supress_event,e);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;dom=this.get_node(obj,!0);obj.state.selected&&(obj.state.selected=!1,this._data.core.selected=$.vakata.array_remove_item(this._data.core.selected,obj.id),dom.length&&dom.attr("aria-selected",!1).children(".jstree-anchor").removeClass("jstree-clicked"),this.trigger("deselect_node",{node:obj,selected:this._data.core.selected,event:e}),supress_event||this.trigger("changed",{action:"deselect_node",node:obj,selected:this._data.core.selected,event:e}))},select_all:function(supress_event){var tmp=this._data.core.selected.concat([]),i,j;for(this._data.core.selected=this._model.data["#"].children_d.concat(),i=0,j=this._data.core.selected.length;i<j;i++)this._model.data[this._data.core.selected[i]]&&(this._model.data[this._data.core.selected[i]].state.selected=!0);this.redraw(!0);this.trigger("select_all",{selected:this._data.core.selected});supress_event||this.trigger("changed",{action:"select_all",selected:this._data.core.selected,old_selection:tmp})},deselect_all:function(supress_event){for(var tmp=this._data.core.selected.concat([]),i=0,j=this._data.core.selected.length;i<j;i++)this._model.data[this._data.core.selected[i]]&&(this._model.data[this._data.core.selected[i]].state.selected=!1);this._data.core.selected=[];this.element.find(".jstree-clicked").removeClass("jstree-clicked").parent().attr("aria-selected",!1);this.trigger("deselect_all",{selected:this._data.core.selected,node:tmp});supress_event||this.trigger("changed",{action:"deselect_all",selected:this._data.core.selected,old_selection:tmp})},is_selected:function(obj){return(obj=this.get_node(obj),!obj||obj.id==="#")?!1:obj.state.selected},get_selected:function(full){return full?$.map(this._data.core.selected,$.proxy(function(i){return this.get_node(i)},this)):this._data.core.selected.slice()},get_top_selected:function(full){for(var tmp=this.get_selected(!0),obj={},k,l,i=0,j=tmp.length;i<j;i++)obj[tmp[i].id]=tmp[i];for(i=0,j=tmp.length;i<j;i++)for(k=0,l=tmp[i].children_d.length;k<l;k++)obj[tmp[i].children_d[k]]&&delete obj[tmp[i].children_d[k]];tmp=[];for(i in obj)obj.hasOwnProperty(i)&&tmp.push(i);return full?$.map(tmp,$.proxy(function(i){return this.get_node(i)},this)):tmp},get_bottom_selected:function(full){for(var tmp=this.get_selected(!0),obj=[],i=0,j=tmp.length;i<j;i++)tmp[i].children.length||obj.push(tmp[i].id);return full?$.map(obj,$.proxy(function(i){return this.get_node(i)},this)):obj},get_state:function(){var state={core:{open:[],scroll:{left:this.element.scrollLeft(),top:this.element.scrollTop()},selected:[]}};for(var i in this._model.data)this._model.data.hasOwnProperty(i)&&i!=="#"&&(this._model.data[i].state.opened&&state.core.open.push(i),this._model.data[i].state.selected&&state.core.selected.push(i));return state},set_state:function(state,callback){if(state){if(state.core){var res,n,t,_this;if(state.core.open)return $.isArray(state.core.open)?(res=!0,n=!1,t=this,$.each(state.core.open.concat([]),function(i,v){n=t.get_node(v);n&&(t.is_loaded(v)?(t.is_closed(v)&&t.open_node(v,!1,0),state&&state.core&&state.core.open&&$.vakata.array_remove_item(state.core.open,v)):(t.is_loading(v)||t.open_node(v,$.proxy(function(o,s){!s&&state&&state.core&&state.core.open&&$.vakata.array_remove_item(state.core.open,o.id);this.set_state(state,callback)},t),0),res=!1))}),res&&(delete state.core.open,this.set_state(state,callback)),!1):(delete state.core.open,this.set_state(state,callback),!1);if(state.core.scroll)return state.core.scroll&&state.core.scroll.left!==undefined&&this.element.scrollLeft(state.core.scroll.left),state.core.scroll&&state.core.scroll.top!==undefined&&this.element.scrollTop(state.core.scroll.top),delete state.core.scroll,this.set_state(state,callback),!1;
/*!
					if(state.core.themes) {
						if(state.core.themes.name) {
							this.set_theme(state.core.themes.name);
						}
						if(typeof state.core.themes.dots !== 'undefined') {
							this[ state.core.themes.dots ? "show_dots" : "hide_dots" ]();
						}
						if(typeof state.core.themes.icons !== 'undefined') {
							this[ state.core.themes.icons ? "show_icons" : "hide_icons" ]();
						}
						delete state.core.themes;
						delete state.core.open;
						this.set_state(state, callback);
						return false;
					}
					*/
if(state.core.selected)return _this=this,this.deselect_all(),$.each(state.core.selected,function(i,v){_this.select_node(v)}),delete state.core.selected,this.set_state(state,callback),!1;if($.isEmptyObject(state.core))return delete state.core,this.set_state(state,callback),!1}return $.isEmptyObject(state)?(state=null,callback&&callback.call(this),this.trigger("set_state"),!1):!0}return!1},refresh:function(skip_loading,forget_state){this._data.core.state=forget_state===!0?{}:this.get_state();forget_state&&$.isFunction(forget_state)&&(this._data.core.state=forget_state.call(this,this._data.core.state));this._cnt=0;this._model.data={"#":{id:"#",parent:null,parents:[],children:[],children_d:[],state:{loaded:!1}}};var c=this.get_container_ul()[0].className;skip_loading||(this.element.html("<ul class='"+c+"' role='group'><li class='jstree-initial-node jstree-loading jstree-leaf jstree-last' role='treeitem' id='j"+this._id+"_loading'><i class='jstree-icon jstree-ocl'><\/i><a class='jstree-anchor' href='#'><i class='jstree-icon jstree-themeicon-hidden'><\/i>"+this.get_string("Loading ...")+"<\/a><\/li><\/ul>"),this.element.attr("aria-activedescendant","j"+this._id+"_loading"));this.load_node("#",function(o,s){s&&(this.get_container_ul()[0].className=c,this._firstChild(this.get_container_ul()[0])&&this.element.attr("aria-activedescendant",this._firstChild(this.get_container_ul()[0]).id),this.set_state($.extend(!0,{},this._data.core.state),function(){this.trigger("refresh")}));this._data.core.state=null})},refresh_node:function(obj){if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;var opened=[],to_load=[],s=this._data.core.selected.concat([]);to_load.push(obj.id);obj.state.opened===!0&&opened.push(obj.id);this.get_node(obj,!0).find(".jstree-open").each(function(){opened.push(this.id)});this._load_nodes(to_load,$.proxy(function(nodes){this.open_node(opened,!1,0);this.select_node(this._data.core.selected);this.trigger("refresh_node",{node:obj,nodes:nodes})},this))},set_id:function(obj,id){if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;var i,j,m=this._model.data;for(id=id.toString(),m[obj.parent].children[$.inArray(obj.id,m[obj.parent].children)]=id,i=0,j=obj.parents.length;i<j;i++)m[obj.parents[i]].children_d[$.inArray(obj.id,m[obj.parents[i]].children_d)]=id;for(i=0,j=obj.children.length;i<j;i++)m[obj.children[i]].parent=id;for(i=0,j=obj.children_d.length;i<j;i++)m[obj.children_d[i]].parents[$.inArray(obj.id,m[obj.children_d[i]].parents)]=id;return i=$.inArray(obj.id,this._data.core.selected),i!==-1&&(this._data.core.selected[i]=id),i=this.get_node(obj.id,!0),i&&i.attr("id",id),delete m[obj.id],obj.id=id,m[id]=obj,!0},get_text:function(obj){return obj=this.get_node(obj),!obj||obj.id==="#"?!1:obj.text},set_text:function(obj,val){var t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.set_text(obj[t1],val);return!0}return(obj=this.get_node(obj),!obj||obj.id==="#")?!1:(obj.text=val,this.get_node(obj,!0).length&&this.redraw_node(obj.id),this.trigger("set_text",{obj:obj,text:val}),!0)},get_json:function(obj,options,flat){if(obj=this.get_node(obj||"#"),!obj)return!1;options&&options.flat&&!flat&&(flat=[]);var tmp={id:obj.id,text:obj.text,icon:this.get_icon(obj),li_attr:$.extend(!0,{},obj.li_attr),a_attr:$.extend(!0,{},obj.a_attr),state:{},data:options&&options.no_data?!1:$.extend(!0,{},obj.data)},i,j;if(options&&options.flat?tmp.parent=obj.parent:tmp.children=[],!options||!options.no_state)for(i in obj.state)obj.state.hasOwnProperty(i)&&(tmp.state[i]=obj.state[i]);if(options&&options.no_id&&(delete tmp.id,tmp.li_attr&&tmp.li_attr.id&&delete tmp.li_attr.id,tmp.a_attr&&tmp.a_attr.id&&delete tmp.a_attr.id),options&&options.flat&&obj.id!=="#"&&flat.push(tmp),!options||!options.no_children)for(i=0,j=obj.children.length;i<j;i++)options&&options.flat?this.get_json(obj.children[i],options,flat):tmp.children.push(this.get_json(obj.children[i],options));return options&&options.flat?flat:obj.id==="#"?tmp.children:tmp},create_node:function(par,node,pos,callback,is_loaded){if(par===null&&(par="#"),par=this.get_node(par),!par)return!1;if(pos=pos===undefined?"last":pos,!pos.toString().match(/^(before|after)$/)&&!is_loaded&&!this.is_loaded(par))return this.load_node(par,function(){this.create_node(par,node,pos,callback,!0)});node||(node={text:this.get_string("New node")});node.text===undefined&&(node.text=this.get_string("New node"));var tmp,dpc,i,j;par.id==="#"&&(pos==="before"&&(pos="first"),pos==="after"&&(pos="last"));switch(pos){case"before":tmp=this.get_node(par.parent);pos=$.inArray(par.id,tmp.children);par=tmp;break;case"after":tmp=this.get_node(par.parent);pos=$.inArray(par.id,tmp.children)+1;par=tmp;break;case"inside":case"first":pos=0;break;case"last":pos=par.children.length;break;default:pos||(pos=0)}if(pos>par.children.length&&(pos=par.children.length),node.id||(node.id=!0),!this.check("create_node",node,par,pos))return this.settings.core.error.call(this,this._data.core.last_error),!1;if(node.id===!0&&delete node.id,node=this._parse_model_from_json(node,par.id,par.parents.concat()),!node)return!1;for(tmp=this.get_node(node),dpc=[],dpc.push(node),dpc=dpc.concat(tmp.children_d),this.trigger("model",{nodes:dpc,parent:par.id}),par.children_d=par.children_d.concat(dpc),i=0,j=par.parents.length;i<j;i++)this._model.data[par.parents[i]].children_d=this._model.data[par.parents[i]].children_d.concat(dpc);for(node=tmp,tmp=[],i=0,j=par.children.length;i<j;i++)tmp[i>=pos?i+1:i]=par.children[i];return tmp[pos]=node.id,par.children=tmp,this.redraw_node(par,!0),callback&&callback.call(this,this.get_node(node)),this.trigger("create_node",{node:this.get_node(node),parent:par.id,position:pos}),node.id},rename_node:function(obj,val){var t1,t2,old;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.rename_node(obj[t1],val);return!0}return(obj=this.get_node(obj),!obj||obj.id==="#")?!1:(old=obj.text,!this.check("rename_node",obj,this.get_parent(obj),val))?(this.settings.core.error.call(this,this._data.core.last_error),!1):(this.set_text(obj,val),this.trigger("rename_node",{node:obj,text:val,old:old}),!0)},delete_node:function(obj){var t1,t2,par,pos,tmp,i,j,k,l,c;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.delete_node(obj[t1]);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;if(par=this.get_node(obj.parent),pos=$.inArray(obj.id,par.children),c=!1,!this.check("delete_node",obj,par,pos))return this.settings.core.error.call(this,this._data.core.last_error),!1;for(pos!==-1&&(par.children=$.vakata.array_remove(par.children,pos)),tmp=obj.children_d.concat([]),tmp.push(obj.id),k=0,l=tmp.length;k<l;k++){for(i=0,j=obj.parents.length;i<j;i++)pos=$.inArray(tmp[k],this._model.data[obj.parents[i]].children_d),pos!==-1&&(this._model.data[obj.parents[i]].children_d=$.vakata.array_remove(this._model.data[obj.parents[i]].children_d,pos));this._model.data[tmp[k]].state.selected&&(c=!0,pos=$.inArray(tmp[k],this._data.core.selected),pos!==-1&&(this._data.core.selected=$.vakata.array_remove(this._data.core.selected,pos)))}for(this.trigger("delete_node",{node:obj,parent:par.id}),c&&this.trigger("changed",{action:"delete_node",node:obj,selected:this._data.core.selected,parent:par.id}),k=0,l=tmp.length;k<l;k++)delete this._model.data[tmp[k]];return this.redraw_node(par,!0),!0},check:function(chk,obj,par,pos,more){obj=obj&&obj.id?obj:this.get_node(obj);par=par&&par.id?par:this.get_node(par);var tmp=chk.match(/^move_node|copy_node|create_node$/i)?par:obj,chc=this.settings.core.check_callback;return(chk==="move_node"||chk==="copy_node")&&(!more||!more.is_multi)&&(obj.id===par.id||$.inArray(obj.id,par.children)===pos||$.inArray(par.id,obj.children_d)!==-1)?(this._data.core.last_error={error:"check",plugin:"core",id:"core_01",reason:"Moving parent inside child",data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})},!1):(tmp&&tmp.data&&(tmp=tmp.data),tmp&&tmp.functions&&(tmp.functions[chk]===!1||tmp.functions[chk]===!0))?(tmp.functions[chk]===!1&&(this._data.core.last_error={error:"check",plugin:"core",id:"core_02",reason:"Node data prevents function: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})}),tmp.functions[chk]):chc===!1||$.isFunction(chc)&&chc.call(this,chk,obj,par,pos,more)===!1||chc&&chc[chk]===!1?(this._data.core.last_error={error:"check",plugin:"core",id:"core_03",reason:"User config for core.check_callback prevents function: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})},!1):!0},last_error:function(){return this._data.core.last_error},move_node:function(obj,par,pos,callback,is_loaded,skip_redraw){var t1,t2,old_par,old_pos,new_par,old_ins,is_multi,dpc,tmp,i,j,k,l,p;if(par=this.get_node(par),pos=pos===undefined?0:pos,!par)return!1;if(!pos.toString().match(/^(before|after)$/)&&!is_loaded&&!this.is_loaded(par))return this.load_node(par,function(){this.move_node(obj,par,pos,callback,!0)});if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.move_node(obj[t1],par,pos,callback,is_loaded,!0)&&(par=obj[t1],pos="after");return this.redraw(),!0}if(obj=obj&&obj.id?obj:this.get_node(obj),!obj||obj.id==="#")return!1;if(old_par=(obj.parent||"#").toString(),new_par=!pos.toString().match(/^(before|after)$/)||par.id==="#"?par:this.get_node(par.parent),old_ins=obj.instance?obj.instance:this._model.data[obj.id]?this:$.jstree.reference(obj.id),is_multi=!old_ins||!old_ins._id||this._id!==old_ins._id,old_pos=old_ins&&old_ins._id&&old_par&&old_ins._model.data[old_par]&&old_ins._model.data[old_par].children?$.inArray(obj.id,old_ins._model.data[old_par].children):-1,is_multi)return this.copy_node(obj,par,pos,callback,is_loaded)?(old_ins&&old_ins.delete_node(obj),!0):!1;par.id==="#"&&(pos==="before"&&(pos="first"),pos==="after"&&(pos="last"));switch(pos){case"before":pos=$.inArray(par.id,new_par.children);break;case"after":pos=$.inArray(par.id,new_par.children)+1;break;case"inside":case"first":pos=0;break;case"last":pos=new_par.children.length;break;default:pos||(pos=0)}if(pos>new_par.children.length&&(pos=new_par.children.length),!this.check("move_node",obj,new_par,pos,{core:!0,is_multi:old_ins&&old_ins._id&&old_ins._id!==this._id,is_foreign:!old_ins||!old_ins._id}))return this.settings.core.error.call(this,this._data.core.last_error),!1;if(obj.parent===new_par.id){for(dpc=new_par.children.concat(),tmp=$.inArray(obj.id,dpc),tmp!==-1&&(dpc=$.vakata.array_remove(dpc,tmp),pos>tmp&&pos--),tmp=[],i=0,j=dpc.length;i<j;i++)tmp[i>=pos?i+1:i]=dpc[i];tmp[pos]=obj.id;new_par.children=tmp;this._node_changed(new_par.id);this.redraw(new_par.id==="#")}else{for(tmp=obj.children_d.concat(),tmp.push(obj.id),i=0,j=obj.parents.length;i<j;i++){for(dpc=[],p=old_ins._model.data[obj.parents[i]].children_d,k=0,l=p.length;k<l;k++)$.inArray(p[k],tmp)===-1&&dpc.push(p[k]);old_ins._model.data[obj.parents[i]].children_d=dpc}for(old_ins._model.data[old_par].children=$.vakata.array_remove_item(old_ins._model.data[old_par].children,obj.id),i=0,j=new_par.parents.length;i<j;i++)this._model.data[new_par.parents[i]].children_d=this._model.data[new_par.parents[i]].children_d.concat(tmp);for(dpc=[],i=0,j=new_par.children.length;i<j;i++)dpc[i>=pos?i+1:i]=new_par.children[i];for(dpc[pos]=obj.id,new_par.children=dpc,new_par.children_d.push(obj.id),new_par.children_d=new_par.children_d.concat(obj.children_d),obj.parent=new_par.id,tmp=new_par.parents.concat(),tmp.unshift(new_par.id),p=obj.parents.length,obj.parents=tmp,tmp=tmp.concat(),i=0,j=obj.children_d.length;i<j;i++)this._model.data[obj.children_d[i]].parents=this._model.data[obj.children_d[i]].parents.slice(0,p*-1),Array.prototype.push.apply(this._model.data[obj.children_d[i]].parents,tmp);(old_par==="#"||new_par.id==="#")&&(this._model.force_full_redraw=!0);this._model.force_full_redraw||(this._node_changed(old_par),this._node_changed(new_par.id));skip_redraw||this.redraw()}return callback&&callback.call(this,obj,new_par,pos),this.trigger("move_node",{node:obj,parent:new_par.id,position:pos,old_parent:old_par,old_position:old_pos,is_multi:old_ins&&old_ins._id&&old_ins._id!==this._id,is_foreign:!old_ins||!old_ins._id,old_instance:old_ins,new_instance:this}),!0},copy_node:function(obj,par,pos,callback,is_loaded,skip_redraw){var t1,t2,dpc,tmp,i,j,node,old_par,new_par,old_ins,is_multi;if(par=this.get_node(par),pos=pos===undefined?0:pos,!par)return!1;if(!pos.toString().match(/^(before|after)$/)&&!is_loaded&&!this.is_loaded(par))return this.load_node(par,function(){this.copy_node(obj,par,pos,callback,!0)});if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)tmp=this.copy_node(obj[t1],par,pos,callback,is_loaded,!0),tmp&&(par=tmp,pos="after");return this.redraw(),!0}if(obj=obj&&obj.id?obj:this.get_node(obj),!obj||obj.id==="#")return!1;old_par=(obj.parent||"#").toString();new_par=!pos.toString().match(/^(before|after)$/)||par.id==="#"?par:this.get_node(par.parent);old_ins=obj.instance?obj.instance:this._model.data[obj.id]?this:$.jstree.reference(obj.id);is_multi=!old_ins||!old_ins._id||this._id!==old_ins._id;par.id==="#"&&(pos==="before"&&(pos="first"),pos==="after"&&(pos="last"));switch(pos){case"before":pos=$.inArray(par.id,new_par.children);break;case"after":pos=$.inArray(par.id,new_par.children)+1;break;case"inside":case"first":pos=0;break;case"last":pos=new_par.children.length;break;default:pos||(pos=0)}if(pos>new_par.children.length&&(pos=new_par.children.length),!this.check("copy_node",obj,new_par,pos,{core:!0,is_multi:old_ins&&old_ins._id&&old_ins._id!==this._id,is_foreign:!old_ins||!old_ins._id}))return this.settings.core.error.call(this,this._data.core.last_error),!1;if((node=old_ins?old_ins.get_json(obj,{no_id:!0,no_data:!0,no_state:!0}):obj,!node)||(node.id===!0&&delete node.id,node=this._parse_model_from_json(node,new_par.id,new_par.parents.concat()),!node))return!1;for(tmp=this.get_node(node),obj&&obj.state&&obj.state.loaded===!1&&(tmp.state.loaded=!1),dpc=[],dpc.push(node),dpc=dpc.concat(tmp.children_d),this.trigger("model",{nodes:dpc,parent:new_par.id}),i=0,j=new_par.parents.length;i<j;i++)this._model.data[new_par.parents[i]].children_d=this._model.data[new_par.parents[i]].children_d.concat(dpc);for(dpc=[],i=0,j=new_par.children.length;i<j;i++)dpc[i>=pos?i+1:i]=new_par.children[i];return dpc[pos]=tmp.id,new_par.children=dpc,new_par.children_d.push(tmp.id),new_par.children_d=new_par.children_d.concat(tmp.children_d),new_par.id==="#"&&(this._model.force_full_redraw=!0),this._model.force_full_redraw||this._node_changed(new_par.id),skip_redraw||this.redraw(new_par.id==="#"),callback&&callback.call(this,tmp,new_par,pos),this.trigger("copy_node",{node:tmp,original:obj,parent:new_par.id,position:pos,old_parent:old_par,old_position:old_ins&&old_ins._id&&old_par&&old_ins._model.data[old_par]&&old_ins._model.data[old_par].children?$.inArray(obj.id,old_ins._model.data[old_par].children):-1,is_multi:old_ins&&old_ins._id&&old_ins._id!==this._id,is_foreign:!old_ins||!old_ins._id,old_instance:old_ins,new_instance:this}),tmp.id},cut:function(obj){if(obj||(obj=this._data.core.selected.concat()),$.isArray(obj)||(obj=[obj]),!obj.length)return!1;for(var tmp=[],o,t1=0,t2=obj.length;t1<t2;t1++)o=this.get_node(obj[t1]),o&&o.id&&o.id!=="#"&&tmp.push(o);if(!tmp.length)return!1;ccp_node=tmp;ccp_inst=this;ccp_mode="move_node";this.trigger("cut",{node:obj})},copy:function(obj){if(obj||(obj=this._data.core.selected.concat()),$.isArray(obj)||(obj=[obj]),!obj.length)return!1;for(var tmp=[],o,t1=0,t2=obj.length;t1<t2;t1++)o=this.get_node(obj[t1]),o&&o.id&&o.id!=="#"&&tmp.push(o);if(!tmp.length)return!1;ccp_node=tmp;ccp_inst=this;ccp_mode="copy_node";this.trigger("copy",{node:obj})},get_buffer:function(){return{mode:ccp_mode,node:ccp_node,inst:ccp_inst}},can_paste:function(){return ccp_mode!==!1&&ccp_node!==!1},paste:function(obj,pos){if(obj=this.get_node(obj),!obj||!ccp_mode||!ccp_mode.match(/^(copy_node|move_node)$/)||!ccp_node)return!1;this[ccp_mode](ccp_node,obj,pos)&&this.trigger("paste",{parent:obj.id,node:ccp_node,mode:ccp_mode});ccp_node=!1;ccp_mode=!1;ccp_inst=!1},clear_buffer:function(){ccp_node=!1;ccp_mode=!1;ccp_inst=!1;this.trigger("clear_buffer")},edit:function(obj,default_text){if(obj=this.get_node(obj),!obj)return!1;if(this.settings.core.check_callback===!1)return this._data.core.last_error={error:"check",plugin:"core",id:"core_07",reason:"Could not edit node because of check_callback"},this.settings.core.error.call(this,this._data.core.last_error),!1;default_text=typeof default_text=="string"?default_text:obj.text;this.set_text(obj,"");obj=this._open_to(obj);var rtl=this._data.core.rtl,w=this.element.width(),a=obj.children(".jstree-anchor"),s=$("<span>"),t=default_text,h1=$("<div />",{css:{position:"absolute",top:"-200px",left:rtl?"0px":"-1000px",visibility:"hidden"}}).appendTo("body"),h2=$("<input />",{value:t,"class":"jstree-rename-input",css:{padding:"0",border:"1px solid silver","box-sizing":"border-box",display:"inline-block",height:this._data.core.li_height+"px",lineHeight:this._data.core.li_height+"px",width:"150px"},blur:$.proxy(function(){var i=s.children(".jstree-rename-input"),v=i.val();v===""&&(v=t);h1.remove();s.replaceWith(a);s.remove();this.set_text(obj,t);this.rename_node(obj,$("<div><\/div>").text(v)[this.settings.core.force_text?"text":"html"]())===!1&&this.set_text(obj,t)},this),keydown:function(event){var key=event.which;key===27&&(this.value=t);(key===27||key===13||key===37||key===38||key===39||key===40||key===32)&&event.stopImmediatePropagation();(key===27||key===13)&&(event.preventDefault(),this.blur())},click:function(e){e.stopImmediatePropagation()},mousedown:function(e){e.stopImmediatePropagation()},keyup:function(){h2.width(Math.min(h1.text("pW"+this.value).width(),w))},keypress:function(event){if(event.which===13)return!1}}),fn={fontFamily:a.css("fontFamily")||"",fontSize:a.css("fontSize")||"",fontWeight:a.css("fontWeight")||"",fontStyle:a.css("fontStyle")||"",fontStretch:a.css("fontStretch")||"",fontVariant:a.css("fontVariant")||"",letterSpacing:a.css("letterSpacing")||"",wordSpacing:a.css("wordSpacing")||""};s.attr("class",a.attr("class")).append(a.contents().clone()).append(h2);a.replaceWith(s);h1.css(fn);h2.css(fn).width(Math.min(h1.text("pW"+h2[0].value).width(),w))[0].select()},set_theme:function(theme_name,theme_url){if(!theme_name)return!1;if(theme_url===!0){var dir=this.settings.core.themes.dir;dir||(dir=$.jstree.path+"/themes");theme_url=dir+"/"+theme_name+"/style.css"}theme_url&&$.inArray(theme_url,themes_loaded)===-1&&($("head").append('<link rel="stylesheet" href="'+theme_url+'" type="text/css" />'),themes_loaded.push(theme_url));this._data.core.themes.name&&this.element.removeClass("jstree-"+this._data.core.themes.name);this._data.core.themes.name=theme_name;this.element.addClass("jstree-"+theme_name);this.element[this.settings.core.themes.responsive?"addClass":"removeClass"]("jstree-"+theme_name+"-responsive");this.trigger("set_theme",{theme:theme_name})},get_theme:function(){return this._data.core.themes.name},set_theme_variant:function(variant_name){this._data.core.themes.variant&&this.element.removeClass("jstree-"+this._data.core.themes.name+"-"+this._data.core.themes.variant);this._data.core.themes.variant=variant_name;variant_name&&this.element.addClass("jstree-"+this._data.core.themes.name+"-"+this._data.core.themes.variant)},get_theme_variant:function(){return this._data.core.themes.variant},show_stripes:function(){this._data.core.themes.stripes=!0;this.get_container_ul().addClass("jstree-striped")},hide_stripes:function(){this._data.core.themes.stripes=!1;this.get_container_ul().removeClass("jstree-striped")},toggle_stripes:function(){this._data.core.themes.stripes?this.hide_stripes():this.show_stripes()},show_dots:function(){this._data.core.themes.dots=!0;this.get_container_ul().removeClass("jstree-no-dots")},hide_dots:function(){this._data.core.themes.dots=!1;this.get_container_ul().addClass("jstree-no-dots")},toggle_dots:function(){this._data.core.themes.dots?this.hide_dots():this.show_dots()},show_icons:function(){this._data.core.themes.icons=!0;this.get_container_ul().removeClass("jstree-no-icons")},hide_icons:function(){this._data.core.themes.icons=!1;this.get_container_ul().addClass("jstree-no-icons")},toggle_icons:function(){this._data.core.themes.icons?this.hide_icons():this.show_icons()},set_icon:function(obj,icon){var t1,t2,dom,old;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.set_icon(obj[t1],icon);return!0}return(obj=this.get_node(obj),!obj||obj.id==="#")?!1:(old=obj.icon,obj.icon=icon,dom=this.get_node(obj,!0).children(".jstree-anchor").children(".jstree-themeicon"),icon===!1?this.hide_icon(obj):icon===!0?(dom.removeClass("jstree-themeicon-custom "+old).css("background","").removeAttr("rel"),old===!1&&this.show_icon(obj)):icon.indexOf("/")===-1&&icon.indexOf(".")===-1?(dom.removeClass(old).css("background",""),dom.addClass(icon+" jstree-themeicon-custom").attr("rel",icon),old===!1&&this.show_icon(obj)):(dom.removeClass(old).css("background",""),dom.addClass("jstree-themeicon-custom").css("background","url('"+icon+"') center center no-repeat").attr("rel",icon),old===!1&&this.show_icon(obj)),!0)},get_icon:function(obj){return obj=this.get_node(obj),!obj||obj.id==="#"?!1:obj.icon},hide_icon:function(obj){var t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.hide_icon(obj[t1]);return!0}return(obj=this.get_node(obj),!obj||obj==="#")?!1:(obj.icon=!1,this.get_node(obj,!0).children(".jstree-anchor").children(".jstree-themeicon").addClass("jstree-themeicon-hidden"),!0)},show_icon:function(obj){var t1,t2,dom;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.show_icon(obj[t1]);return!0}return(obj=this.get_node(obj),!obj||obj==="#")?!1:(dom=this.get_node(obj,!0),obj.icon=dom.length?dom.children(".jstree-anchor").children(".jstree-themeicon").attr("rel"):!0,obj.icon||(obj.icon=!0),dom.children(".jstree-anchor").children(".jstree-themeicon").removeClass("jstree-themeicon-hidden"),!0)}};$.vakata={};$.vakata.attributes=function(node,with_values){node=$(node)[0];var attr=with_values?{}:[];return node&&node.attributes&&$.each(node.attributes,function(i,v){$.inArray(v.name.toLowerCase(),["style","contenteditable","hasfocus","tabindex"])===-1&&v.value!==null&&$.trim(v.value)!==""&&(with_values?attr[v.name]=v.value:attr.push(v.name))}),attr};$.vakata.array_unique=function(array){for(var a=[],j,i=0,l=array.length;i<l;i++){for(j=0;j<=i;j++)if(array[i]===array[j])break;j===i&&a.push(array[i])}return a};$.vakata.array_remove=function(array,from,to){var rest=array.slice((to||from)+1||array.length);return array.length=from<0?array.length+from:from,array.push.apply(array,rest),array};$.vakata.array_remove_item=function(array,item){var tmp=$.inArray(item,array);return tmp!==-1?$.vakata.array_remove(array,tmp):array};_i=document.createElement("I");_i.className="jstree-icon jstree-checkbox";_i.setAttribute("role","presentation");$.jstree.defaults.checkbox={visible:!0,three_state:!0,whole_node:!0,keep_selected_style:!0,cascade:"",tie_selection:!0};$.jstree.plugins.checkbox=function(options,parent){this.bind=function(){parent.bind.call(this);this._data.checkbox.uto=!1;this._data.checkbox.selected=[];this.settings.checkbox.three_state&&(this.settings.checkbox.cascade="up+down+undetermined");this.element.on("init.jstree",$.proxy(function(){this._data.checkbox.visible=this.settings.checkbox.visible;this.settings.checkbox.keep_selected_style||this.element.addClass("jstree-checkbox-no-clicked");this.settings.checkbox.tie_selection&&this.element.addClass("jstree-checkbox-selection")},this)).on("loading.jstree",$.proxy(function(){this[this._data.checkbox.visible?"show_checkboxes":"hide_checkboxes"]()},this));if(this.settings.checkbox.cascade.indexOf("undetermined")!==-1)this.element.on("changed.jstree uncheck_node.jstree check_node.jstree uncheck_all.jstree check_all.jstree move_node.jstree copy_node.jstree redraw.jstree open_node.jstree",$.proxy(function(){this._data.checkbox.uto&&clearTimeout(this._data.checkbox.uto);this._data.checkbox.uto=setTimeout($.proxy(this._undetermined,this),50)},this));if(!this.settings.checkbox.tie_selection)this.element.on("model.jstree",$.proxy(function(e,data){for(var m=this._model.data,p=m[data.parent],dpc=data.nodes,i=0,j=dpc.length;i<j;i++)m[dpc[i]].state.checked=m[dpc[i]].original&&m[dpc[i]].original.state&&m[dpc[i]].original.state.checked,m[dpc[i]].state.checked&&this._data.checkbox.selected.push(dpc[i])},this));if(this.settings.checkbox.cascade.indexOf("up")!==-1||this.settings.checkbox.cascade.indexOf("down")!==-1)this.element.on("model.jstree",$.proxy(function(e,data){var m=this._model.data,p=m[data.parent],dpc=data.nodes,chd=[],c,i,j,k,l,tmp,s=this.settings.checkbox.cascade,t=this.settings.checkbox.tie_selection;if(s.indexOf("down")!==-1)if(p.state[t?"selected":"checked"]){for(i=0,j=dpc.length;i<j;i++)m[dpc[i]].state[t?"selected":"checked"]=!0;this._data[t?"core":"checkbox"].selected=this._data[t?"core":"checkbox"].selected.concat(dpc)}else for(i=0,j=dpc.length;i<j;i++)if(m[dpc[i]].state[t?"selected":"checked"]){for(k=0,l=m[dpc[i]].children_d.length;k<l;k++)m[m[dpc[i]].children_d[k]].state[t?"selected":"checked"]=!0;this._data[t?"core":"checkbox"].selected=this._data[t?"core":"checkbox"].selected.concat(m[dpc[i]].children_d)}if(s.indexOf("up")!==-1){for(i=0,j=p.children_d.length;i<j;i++)m[p.children_d[i]].children.length||chd.push(m[p.children_d[i]].parent);for(chd=$.vakata.array_unique(chd),k=0,l=chd.length;k<l;k++)for(p=m[chd[k]];p&&p.id!=="#";){for(c=0,i=0,j=p.children.length;i<j;i++)c+=m[p.children[i]].state[t?"selected":"checked"];if(c===j)p.state[t?"selected":"checked"]=!0,this._data[t?"core":"checkbox"].selected.push(p.id),tmp=this.get_node(p,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!0).children(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked");else break;p=this.get_node(p.parent)}}this._data[t?"core":"checkbox"].selected=$.vakata.array_unique(this._data[t?"core":"checkbox"].selected)},this)).on(this.settings.checkbox.tie_selection?"select_node.jstree":"check_node.jstree",$.proxy(function(e,data){var obj=data.node,m=this._model.data,par=this.get_node(obj.parent),dom=this.get_node(obj,!0),i,j,c,tmp,s=this.settings.checkbox.cascade,t=this.settings.checkbox.tie_selection;if(s.indexOf("down")!==-1)for(this._data[t?"core":"checkbox"].selected=$.vakata.array_unique(this._data[t?"core":"checkbox"].selected.concat(obj.children_d)),i=0,j=obj.children_d.length;i<j;i++)tmp=m[obj.children_d[i]],tmp.state[t?"selected":"checked"]=!0,tmp&&tmp.original&&tmp.original.state&&tmp.original.state.undetermined&&(tmp.original.state.undetermined=!1);if(s.indexOf("up")!==-1)while(par&&par.id!=="#"){for(c=0,i=0,j=par.children.length;i<j;i++)c+=m[par.children[i]].state[t?"selected":"checked"];if(c===j)par.state[t?"selected":"checked"]=!0,this._data[t?"core":"checkbox"].selected.push(par.id),tmp=this.get_node(par,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!0).children(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked");else break;par=this.get_node(par.parent)}s.indexOf("down")!==-1&&dom.length&&dom.find(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked").parent().attr("aria-selected",!0)},this)).on(this.settings.checkbox.tie_selection?"deselect_all.jstree":"uncheck_all.jstree",$.proxy(function(){for(var obj=this.get_node("#"),m=this._model.data,tmp,i=0,j=obj.children_d.length;i<j;i++)tmp=m[obj.children_d[i]],tmp&&tmp.original&&tmp.original.state&&tmp.original.state.undetermined&&(tmp.original.state.undetermined=!1)},this)).on(this.settings.checkbox.tie_selection?"deselect_node.jstree":"uncheck_node.jstree",$.proxy(function(e,data){var obj=data.node,dom=this.get_node(obj,!0),i,j,tmp,s=this.settings.checkbox.cascade,t=this.settings.checkbox.tie_selection;if(obj&&obj.original&&obj.original.state&&obj.original.state.undetermined&&(obj.original.state.undetermined=!1),s.indexOf("down")!==-1)for(i=0,j=obj.children_d.length;i<j;i++)tmp=this._model.data[obj.children_d[i]],tmp.state[t?"selected":"checked"]=!1,tmp&&tmp.original&&tmp.original.state&&tmp.original.state.undetermined&&(tmp.original.state.undetermined=!1);if(s.indexOf("up")!==-1)for(i=0,j=obj.parents.length;i<j;i++)tmp=this._model.data[obj.parents[i]],tmp.state[t?"selected":"checked"]=!1,tmp&&tmp.original&&tmp.original.state&&tmp.original.state.undetermined&&(tmp.original.state.undetermined=!1),tmp=this.get_node(obj.parents[i],!0),tmp&&tmp.length&&tmp.attr("aria-selected",!1).children(".jstree-anchor").removeClass(t?"jstree-clicked":"jstree-checked");for(tmp=[],i=0,j=this._data[t?"core":"checkbox"].selected.length;i<j;i++)(s.indexOf("down")===-1||$.inArray(this._data[t?"core":"checkbox"].selected[i],obj.children_d)===-1)&&(s.indexOf("up")===-1||$.inArray(this._data[t?"core":"checkbox"].selected[i],obj.parents)===-1)&&tmp.push(this._data[t?"core":"checkbox"].selected[i]);this._data[t?"core":"checkbox"].selected=$.vakata.array_unique(tmp);s.indexOf("down")!==-1&&dom.length&&dom.find(".jstree-anchor").removeClass(t?"jstree-clicked":"jstree-checked").parent().attr("aria-selected",!1)},this));if(this.settings.checkbox.cascade.indexOf("up")!==-1)this.element.on("delete_node.jstree",$.proxy(function(e,data){for(var p=this.get_node(data.parent),m=this._model.data,i,j,c,tmp,t=this.settings.checkbox.tie_selection;p&&p.id!=="#";){for(c=0,i=0,j=p.children.length;i<j;i++)c+=m[p.children[i]].state[t?"selected":"checked"];if(c===j)p.state[t?"selected":"checked"]=!0,this._data[t?"core":"checkbox"].selected.push(p.id),tmp=this.get_node(p,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!0).children(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked");else break;p=this.get_node(p.parent)}},this)).on("move_node.jstree",$.proxy(function(e,data){var is_multi=data.is_multi,old_par=data.old_parent,new_par=this.get_node(data.parent),m=this._model.data,p,c,i,j,tmp,t=this.settings.checkbox.tie_selection;if(!is_multi)for(p=this.get_node(old_par);p&&p.id!=="#";){for(c=0,i=0,j=p.children.length;i<j;i++)c+=m[p.children[i]].state[t?"selected":"checked"];if(c===j)p.state[t?"selected":"checked"]=!0,this._data[t?"core":"checkbox"].selected.push(p.id),tmp=this.get_node(p,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!0).children(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked");else break;p=this.get_node(p.parent)}for(p=new_par;p&&p.id!=="#";){for(c=0,i=0,j=p.children.length;i<j;i++)c+=m[p.children[i]].state[t?"selected":"checked"];if(c===j)p.state[t?"selected":"checked"]||(p.state[t?"selected":"checked"]=!0,this._data[t?"core":"checkbox"].selected.push(p.id),tmp=this.get_node(p,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!0).children(".jstree-anchor").addClass(t?"jstree-clicked":"jstree-checked"));else if(p.state[t?"selected":"checked"])p.state[t?"selected":"checked"]=!1,this._data[t?"core":"checkbox"].selected=$.vakata.array_remove_item(this._data[t?"core":"checkbox"].selected,p.id),tmp=this.get_node(p,!0),tmp&&tmp.length&&tmp.attr("aria-selected",!1).children(".jstree-anchor").removeClass(t?"jstree-clicked":"jstree-checked");else break;p=this.get_node(p.parent)}},this))};this._undetermined=function(){for(var m=this._model.data,t=this.settings.checkbox.tie_selection,s=this._data[t?"core":"checkbox"].selected,p=[],tt=this,i=0,j=s.length;i<j;i++)m[s[i]]&&m[s[i]].parents&&(p=p.concat(m[s[i]].parents));for(this.element.find(".jstree-closed").not(":has(.jstree-children)").each(function(){var tmp=tt.get_node(this),tmp2;if(tmp.state.loaded)for(i=0,j=tmp.children_d.length;i<j;i++)tmp2=m[tmp.children_d[i]],!tmp2.state.loaded&&tmp2.original&&tmp2.original.state&&tmp2.original.state.undetermined&&tmp2.original.state.undetermined===!0&&(p.push(tmp2.id),p=p.concat(tmp2.parents));else tmp.original&&tmp.original.state&&tmp.original.state.undetermined&&tmp.original.state.undetermined===!0&&(p.push(tmp.id),p=p.concat(tmp.parents))}),p=$.vakata.array_unique(p),p=$.vakata.array_remove_item(p,"#"),this.element.find(".jstree-undetermined").removeClass("jstree-undetermined"),i=0,j=p.length;i<j;i++)m[p[i]].state[t?"selected":"checked"]||(s=this.get_node(p[i],!0),s&&s.length&&s.children(".jstree-anchor").children(".jstree-checkbox").addClass("jstree-undetermined"))};this.redraw_node=function(obj,deep,is_callback){if(obj=parent.redraw_node.apply(this,arguments),obj){for(var tmp=null,i=0,j=obj.childNodes.length;i<j;i++)if(obj.childNodes[i]&&obj.childNodes[i].className&&obj.childNodes[i].className.indexOf("jstree-anchor")!==-1){tmp=obj.childNodes[i];break}tmp&&(!this.settings.checkbox.tie_selection&&this._model.data[obj.id].state.checked&&(tmp.className+=" jstree-checked"),tmp.insertBefore(_i.cloneNode(!1),tmp.childNodes[0]))}return is_callback||this.settings.checkbox.cascade.indexOf("undetermined")===-1||(this._data.checkbox.uto&&clearTimeout(this._data.checkbox.uto),this._data.checkbox.uto=setTimeout($.proxy(this._undetermined,this),50)),obj};this.show_checkboxes=function(){this._data.core.themes.checkboxes=!0;this.get_container_ul().removeClass("jstree-no-checkboxes")};this.hide_checkboxes=function(){this._data.core.themes.checkboxes=!1;this.get_container_ul().addClass("jstree-no-checkboxes")};this.toggle_checkboxes=function(){this._data.core.themes.checkboxes?this.hide_checkboxes():this.show_checkboxes()};this.is_undetermined=function(obj){obj=this.get_node(obj);var s=this.settings.checkbox.cascade,i,j,t=this.settings.checkbox.tie_selection,d=this._data[t?"core":"checkbox"].selected,m=this._model.data;if(!obj||obj.state[t?"selected":"checked"]===!0||s.indexOf("undetermined")===-1||s.indexOf("down")===-1&&s.indexOf("up")===-1)return!1;if(!obj.state.loaded&&obj.original.state.undetermined===!0)return!0;for(i=0,j=obj.children_d.length;i<j;i++)if($.inArray(obj.children_d[i],d)!==-1||!m[obj.children_d[i]].state.loaded&&m[obj.children_d[i]].original.state.undetermined)return!0;return!1};this.activate_node=function(obj,e){if(this.settings.checkbox.tie_selection&&(this.settings.checkbox.whole_node||$(e.target).hasClass("jstree-checkbox"))&&(e.ctrlKey=!0),this.settings.checkbox.tie_selection||!this.settings.checkbox.whole_node&&!$(e.target).hasClass("jstree-checkbox"))return parent.activate_node.call(this,obj,e);this.is_checked(obj)?this.uncheck_node(obj,e):this.check_node(obj,e);this.trigger("activate_node",{node:this.get_node(obj)})};this.check_node=function(obj,e){if(this.settings.checkbox.tie_selection)return this.select_node(obj,!1,!0,e);var dom,t1,t2;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.check_node(obj[t1],e);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;dom=this.get_node(obj,!0);obj.state.checked||(obj.state.checked=!0,this._data.checkbox.selected.push(obj.id),dom&&dom.length&&dom.children(".jstree-anchor").addClass("jstree-checked"),this.trigger("check_node",{node:obj,selected:this._data.checkbox.selected,event:e}))};this.uncheck_node=function(obj,e){if(this.settings.checkbox.tie_selection)return this.deselect_node(obj,!1,e);var t1,t2,dom;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.uncheck_node(obj[t1],e);return!0}if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;dom=this.get_node(obj,!0);obj.state.checked&&(obj.state.checked=!1,this._data.checkbox.selected=$.vakata.array_remove_item(this._data.checkbox.selected,obj.id),dom.length&&dom.children(".jstree-anchor").removeClass("jstree-checked"),this.trigger("uncheck_node",{node:obj,selected:this._data.checkbox.selected,event:e}))};this.check_all=function(){if(this.settings.checkbox.tie_selection)return this.select_all();var tmp=this._data.checkbox.selected.concat([]),i,j;for(this._data.checkbox.selected=this._model.data["#"].children_d.concat(),i=0,j=this._data.checkbox.selected.length;i<j;i++)this._model.data[this._data.checkbox.selected[i]]&&(this._model.data[this._data.checkbox.selected[i]].state.checked=!0);this.redraw(!0);this.trigger("check_all",{selected:this._data.checkbox.selected})};this.uncheck_all=function(){if(this.settings.checkbox.tie_selection)return this.deselect_all();for(var tmp=this._data.checkbox.selected.concat([]),i=0,j=this._data.checkbox.selected.length;i<j;i++)this._model.data[this._data.checkbox.selected[i]]&&(this._model.data[this._data.checkbox.selected[i]].state.checked=!1);this._data.checkbox.selected=[];this.element.find(".jstree-checked").removeClass("jstree-checked");this.trigger("uncheck_all",{selected:this._data.checkbox.selected,node:tmp})};this.is_checked=function(obj){return this.settings.checkbox.tie_selection?this.is_selected(obj):(obj=this.get_node(obj),!obj||obj.id==="#")?!1:obj.state.checked};this.get_checked=function(full){return this.settings.checkbox.tie_selection?this.get_selected(full):full?$.map(this._data.checkbox.selected,$.proxy(function(i){return this.get_node(i)},this)):this._data.checkbox.selected};this.get_top_checked=function(full){if(this.settings.checkbox.tie_selection)return this.get_top_selected(full);for(var tmp=this.get_checked(!0),obj={},k,l,i=0,j=tmp.length;i<j;i++)obj[tmp[i].id]=tmp[i];for(i=0,j=tmp.length;i<j;i++)for(k=0,l=tmp[i].children_d.length;k<l;k++)obj[tmp[i].children_d[k]]&&delete obj[tmp[i].children_d[k]];tmp=[];for(i in obj)obj.hasOwnProperty(i)&&tmp.push(i);return full?$.map(tmp,$.proxy(function(i){return this.get_node(i)},this)):tmp};this.get_bottom_checked=function(full){if(this.settings.checkbox.tie_selection)return this.get_bottom_selected(full);for(var tmp=this.get_checked(!0),obj=[],i=0,j=tmp.length;i<j;i++)tmp[i].children.length||obj.push(tmp[i].id);return full?$.map(obj,$.proxy(function(i){return this.get_node(i)},this)):obj}};$.jstree.defaults.contextmenu={select_node:!0,show_at_node:!0,items:function(){return{create:{separator_before:!1,separator_after:!0,_disabled:!1,label:"Create",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.create_node(obj,{},"last",function(new_node){setTimeout(function(){inst.edit(new_node)},0)})}},rename:{separator_before:!1,separator_after:!1,_disabled:!1,label:"Rename",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.edit(obj)}},remove:{separator_before:!1,icon:!1,separator_after:!1,_disabled:!1,label:"Delete",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.is_selected(obj)?inst.delete_node(inst.get_selected()):inst.delete_node(obj)}},ccp:{separator_before:!0,icon:!1,separator_after:!1,label:"Edit",action:!1,submenu:{cut:{separator_before:!1,separator_after:!1,label:"Cut",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.is_selected(obj)?inst.cut(inst.get_selected()):inst.cut(obj)}},copy:{separator_before:!1,icon:!1,separator_after:!1,label:"Copy",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.is_selected(obj)?inst.copy(inst.get_selected()):inst.copy(obj)}},paste:{separator_before:!1,icon:!1,_disabled:function(data){return!$.jstree.reference(data.reference).can_paste()},separator_after:!1,label:"Paste",action:function(data){var inst=$.jstree.reference(data.reference),obj=inst.get_node(data.reference);inst.paste(obj)}}}}}}};$.jstree.plugins.contextmenu=function(options,parent){this.bind=function(){parent.bind.call(this);var last_ts=0;this.element.on("contextmenu.jstree",".jstree-anchor",$.proxy(function(e){e.preventDefault();last_ts=e.ctrlKey?e.timeStamp:0;this.is_loading(e.currentTarget)||this.show_contextmenu(e.currentTarget,e.pageX,e.pageY,e)},this)).on("click.jstree",".jstree-anchor",$.proxy(function(e){this._data.contextmenu.visible&&(!last_ts||e.timeStamp-last_ts>250)&&$.vakata.context.hide()},this));$(document).on("context_hide.vakata.jstree",$.proxy(function(){this._data.contextmenu.visible=!1},this))};this.teardown=function(){this._data.contextmenu.visible&&$.vakata.context.hide();parent.teardown.call(this)};this.show_contextmenu=function(obj,x,y,e){if(obj=this.get_node(obj),!obj||obj.id==="#")return!1;var s=this.settings.contextmenu,d=this.get_node(obj,!0),a=d.children(".jstree-anchor"),o=!1,i=!1;(s.show_at_node||x===undefined||y===undefined)&&(o=a.offset(),x=o.left,y=o.top+this._data.core.li_height);this.settings.contextmenu.select_node&&!this.is_selected(obj)&&this.activate_node(obj,e);i=s.items;$.isFunction(i)&&(i=i.call(this,obj,$.proxy(function(i){this._show_contextmenu(obj,x,y,i)},this)));$.isPlainObject(i)&&this._show_contextmenu(obj,x,y,i)};this._show_contextmenu=function(obj,x,y,i){var d=this.get_node(obj,!0),a=d.children(".jstree-anchor");$(document).one("context_show.vakata.jstree",$.proxy(function(e,data){var cls="jstree-contextmenu jstree-"+this.get_theme()+"-contextmenu";$(data.element).addClass(cls)},this));this._data.contextmenu.visible=!0;$.vakata.context.show(a,{x:x,y:y},i);this.trigger("show_contextmenu",{node:obj,x:x,y:y})}},function($){var right_to_left=!1,vakata_context={element:!1,reference:!1,position_x:0,position_y:0,items:[],html:"",is_visible:!1};$.vakata.context={settings:{hide_onmouseleave:0,icons:!0},_trigger:function(event_name){$(document).triggerHandler("context_"+event_name+".vakata",{reference:vakata_context.reference,element:vakata_context.element,position:{x:vakata_context.position_x,y:vakata_context.position_y}})},_execute:function(i){return i=vakata_context.items[i],i&&(!i._disabled||$.isFunction(i._disabled)&&!i._disabled({item:i,reference:vakata_context.reference,element:vakata_context.element}))&&i.action?i.action.call(null,{item:i,reference:vakata_context.reference,element:vakata_context.element,position:{x:vakata_context.position_x,y:vakata_context.position_y}}):!1},_parse:function(o,is_callback){if(!o)return!1;is_callback||(vakata_context.html="",vakata_context.items=[]);var str="",sep=!1,tmp;return is_callback&&(str+="<ul>"),$.each(o,function(i,val){if(!val)return!0;vakata_context.items.push(val);!sep&&val.separator_before&&(str+="<li class='vakata-context-separator'><a href='#' "+($.vakata.context.settings.icons?"":'style="margin-left:0px;"')+">&#160;<\/a><\/li>");sep=!1;str+="<li class='"+(val._class||"")+(val._disabled===!0||$.isFunction(val._disabled)&&val._disabled({item:val,reference:vakata_context.reference,element:vakata_context.element})?" vakata-contextmenu-disabled ":"")+"' "+(val.shortcut?" data-shortcut='"+val.shortcut+"' ":"")+">";str+="<a href='#' rel='"+(vakata_context.items.length-1)+"'>";$.vakata.context.settings.icons&&(str+="<i ",val.icon&&(str+=val.icon.indexOf("/")!==-1||val.icon.indexOf(".")!==-1?" style='background:url(\""+val.icon+"\") center center no-repeat' ":" class='"+val.icon+"' "),str+="><\/i><span class='vakata-contextmenu-sep'>&#160;<\/span>");str+=($.isFunction(val.label)?val.label({item:i,reference:vakata_context.reference,element:vakata_context.element}):val.label)+(val.shortcut?' <span class="vakata-contextmenu-shortcut vakata-contextmenu-shortcut-'+val.shortcut+'">'+(val.shortcut_label||"")+"<\/span>":"")+"<\/a>";val.submenu&&(tmp=$.vakata.context._parse(val.submenu,!0),tmp&&(str+=tmp));str+="<\/li>";val.separator_after&&(str+="<li class='vakata-context-separator'><a href='#' "+($.vakata.context.settings.icons?"":'style="margin-left:0px;"')+">&#160;<\/a><\/li>",sep=!0)}),str=str.replace(/<li class\='vakata-context-separator'\><\/li\>$/,""),is_callback&&(str+="<\/ul>"),is_callback||(vakata_context.html=str,$.vakata.context._trigger("parse")),str.length>10?str:!1},_show_submenu:function(o){if(o=$(o),o.length&&o.children("ul").length){var e=o.children("ul"),x=o.offset().left+o.outerWidth(),y=o.offset().top,w=e.width(),h=e.height(),dw=$(window).width()+$(window).scrollLeft(),dh=$(window).height()+$(window).scrollTop();right_to_left?o[x-(w+10+o.outerWidth())<0?"addClass":"removeClass"]("vakata-context-left"):o[x+w+10>dw?"addClass":"removeClass"]("vakata-context-right");y+h+10>dh&&e.css("bottom","-1px");e.show()}},show:function(reference,position,data){var o,e,x,y,w,h,dw,dh;vakata_context.element&&vakata_context.element.length&&vakata_context.element.width("");switch(!0){case!position&&!reference:return!1;case!!position&&!!reference:vakata_context.reference=reference;vakata_context.position_x=position.x;vakata_context.position_y=position.y;break;case!position&&!!reference:vakata_context.reference=reference;o=reference.offset();vakata_context.position_x=o.left+reference.outerHeight();vakata_context.position_y=o.top;break;case!!position&&!reference:vakata_context.position_x=position.x;vakata_context.position_y=position.y}!reference||data||!$(reference).data("vakata_contextmenu")||(data=$(reference).data("vakata_contextmenu"));$.vakata.context._parse(data)&&vakata_context.element.html(vakata_context.html);vakata_context.items.length&&(vakata_context.element.appendTo("body"),e=vakata_context.element,x=vakata_context.position_x,y=vakata_context.position_y,w=e.width(),h=e.height(),dw=$(window).width()+$(window).scrollLeft(),dh=$(window).height()+$(window).scrollTop(),right_to_left&&(x-=e.outerWidth(),x<$(window).scrollLeft()+20&&(x=$(window).scrollLeft()+20)),x+w+20>dw&&(x=dw-(w+20)),y+h+20>dh&&(y=dh-(h+20)),vakata_context.element.css({left:x,top:y}).show().find("a").first().focus().parent().addClass("vakata-context-hover"),vakata_context.is_visible=!0,$.vakata.context._trigger("show"))},hide:function(){vakata_context.is_visible&&(vakata_context.element.hide().find("ul").hide().end().find(":focus").blur().end().detach(),vakata_context.is_visible=!1,$.vakata.context._trigger("hide"))}};$(function(){right_to_left=$("body").css("direction")==="rtl";var to=!1;vakata_context.element=$("<ul class='vakata-context'><\/ul>");vakata_context.element.on("mouseenter","li",function(e){(e.stopImmediatePropagation(),$.contains(this,e.relatedTarget))||(to&&clearTimeout(to),vakata_context.element.find(".vakata-context-hover").removeClass("vakata-context-hover").end(),$(this).siblings().find("ul").hide().end().end().parentsUntil(".vakata-context","li").addBack().addClass("vakata-context-hover"),$.vakata.context._show_submenu(this))}).on("mouseleave","li",function(e){$.contains(this,e.relatedTarget)||$(this).find(".vakata-context-hover").addBack().removeClass("vakata-context-hover")}).on("mouseleave",function(){$(this).find(".vakata-context-hover").removeClass("vakata-context-hover");$.vakata.context.settings.hide_onmouseleave&&(to=setTimeout(function(){return function(){$.vakata.context.hide()}}(this),$.vakata.context.settings.hide_onmouseleave))}).on("click","a",function(e){e.preventDefault();$(this).blur().parent().hasClass("vakata-context-disabled")||$.vakata.context._execute($(this).attr("rel"))===!1||$.vakata.context.hide()}).on("keydown","a",function(e){var o=null;switch(e.which){case 13:case 32:e.type="mouseup";e.preventDefault();$(e.currentTarget).trigger(e);break;case 37:vakata_context.is_visible&&(vakata_context.element.find(".vakata-context-hover").last().closest("li").first().find("ul").hide().find(".vakata-context-hover").removeClass("vakata-context-hover").end().end().children("a").focus(),e.stopImmediatePropagation(),e.preventDefault());break;case 38:vakata_context.is_visible&&(o=vakata_context.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").prevAll("li:not(.vakata-context-separator)").first(),o.length||(o=vakata_context.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").last()),o.addClass("vakata-context-hover").children("a").focus(),e.stopImmediatePropagation(),e.preventDefault());break;case 39:vakata_context.is_visible&&(vakata_context.element.find(".vakata-context-hover").last().children("ul").show().children("li:not(.vakata-context-separator)").removeClass("vakata-context-hover").first().addClass("vakata-context-hover").children("a").focus(),e.stopImmediatePropagation(),e.preventDefault());break;case 40:vakata_context.is_visible&&(o=vakata_context.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").nextAll("li:not(.vakata-context-separator)").first(),o.length||(o=vakata_context.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").first()),o.addClass("vakata-context-hover").children("a").focus(),e.stopImmediatePropagation(),e.preventDefault());break;case 27:$.vakata.context.hide();e.preventDefault()}}).on("keydown",function(e){e.preventDefault();var a=vakata_context.element.find(".vakata-contextmenu-shortcut-"+e.which).parent();a.parent().not(".vakata-context-disabled")&&a.click()});$(document).on("mousedown.vakata.jstree",function(e){vakata_context.is_visible&&!$.contains(vakata_context.element[0],e.target)&&$.vakata.context.hide()}).on("context_show.vakata.jstree",function(){vakata_context.element.find("li:has(ul)").children("a").addClass("vakata-context-parent");right_to_left&&vakata_context.element.addClass("vakata-context-rtl").css("direction","rtl");vakata_context.element.find("ul").hide().end()})})}($);$.jstree.defaults.dnd={copy:!0,open_timeout:500,is_draggable:!0,check_while_dragging:!0,always_copy:!1,inside_pos:0};$.jstree.plugins.dnd=function(options,parent){this.bind=function(){parent.bind.call(this);this.element.on("mousedown.jstree touchstart.jstree",".jstree-anchor",$.proxy(function(e){var obj=this.get_node(e.target),mlt=this.is_selected(obj)?this.get_selected().length:1;if(obj&&obj.id&&obj.id!=="#"&&(e.which===1||e.type==="touchstart")&&(this.settings.dnd.is_draggable===!0||$.isFunction(this.settings.dnd.is_draggable)&&this.settings.dnd.is_draggable.call(this,mlt>1?this.get_selected(!0):[obj])))return this.element.trigger("mousedown.jstree"),$.vakata.dnd.start(e,{jstree:!0,origin:this,obj:this.get_node(obj,!0),nodes:mlt>1?this.get_selected():[obj.id]},'<div id="jstree-dnd" class="jstree-'+this.get_theme()+" jstree-"+this.get_theme()+"-"+this.get_theme_variant()+" "+(this.settings.core.themes.responsive?" jstree-dnd-responsive":"")+'"><i class="jstree-icon jstree-er"><\/i>'+(mlt>1?mlt+" "+this.get_string("nodes"):this.get_text(e.currentTarget,!0))+'<ins class="jstree-copy" style="display:none;">+<\/ins><\/div>')},this))}};$(function(){var lastmv=!1,laster=!1,opento=!1,marker=$('<div id="jstree-marker">&#160;<\/div>').hide();$(document).on("dnd_start.vakata.jstree",function(e,data){(lastmv=!1,data&&data.data&&data.data.jstree)&&marker.appendTo("body")}).on("dnd_move.vakata.jstree",function(e,data){if((opento&&clearTimeout(opento),data&&data.data&&data.data.jstree)&&(!data.event.target.id||data.event.target.id!=="jstree-marker")){var ins=$.jstree.reference(data.event.target),ref=!1,off=!1,rel=!1,l,t,h,p,i,o,ok,t1,t2,op,ps,pr,ip,tm;if(ins&&ins._data&&ins._data.dnd)if(marker.attr("class","jstree-"+ins.get_theme()+(ins.settings.core.themes.responsive?" jstree-dnd-responsive":"")),data.helper.children().attr("class","jstree-"+ins.get_theme()+" jstree-"+ins.get_theme()+"-"+ins.get_theme_variant()+" "+(ins.settings.core.themes.responsive?" jstree-dnd-responsive":"")).find(".jstree-copy").first()[data.data.origin&&(data.data.origin.settings.dnd.always_copy||data.data.origin.settings.dnd.copy&&(data.event.metaKey||data.event.ctrlKey))?"show":"hide"](),(data.event.target===ins.element[0]||data.event.target===ins.get_container_ul()[0])&&ins.get_container_ul().children().length===0){for(ok=!0,t1=0,t2=data.data.nodes.length;t1<t2;t1++)if(ok=ok&&ins.check(data.data.origin&&(data.data.origin.settings.dnd.always_copy||data.data.origin.settings.dnd.copy&&(data.event.metaKey||data.event.ctrlKey))?"copy_node":"move_node",data.data.origin&&data.data.origin!==ins?data.data.origin.get_node(data.data.nodes[t1]):data.data.nodes[t1],"#","last",{dnd:!0,ref:ins.get_node("#"),pos:"i",is_multi:data.data.origin&&data.data.origin!==ins,is_foreign:!data.data.origin}),!ok)break;if(ok){lastmv={ins:ins,par:"#",pos:"last"};marker.hide();data.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok");return}}else if(ref=$(data.event.target).closest(".jstree-anchor"),ref&&ref.length&&ref.parent().is(".jstree-closed, .jstree-open, .jstree-leaf")&&(off=ref.offset(),rel=data.event.pageY-off.top,h=ref.height(),o=rel<h/3?["b","i","a"]:rel>h-h/3?["a","i","b"]:rel>h/2?["i","a","b"]:["i","b","a"],$.each(o,function(j,v){switch(v){case"b":l=off.left-6;t=off.top;p=ins.get_parent(ref);i=ref.parent().index();break;case"i":ip=ins.settings.dnd.inside_pos;tm=ins.get_node(ref.parent());l=off.left-2;t=off.top+h/2+1;p=tm.id;i=ip==="first"?0:ip==="last"?tm.children.length:Math.min(ip,tm.children.length);break;case"a":l=off.left-6;t=off.top+h;p=ins.get_parent(ref);i=ref.parent().index()+1}for(ok=!0,t1=0,t2=data.data.nodes.length;t1<t2;t1++)if(op=data.data.origin&&(data.data.origin.settings.dnd.always_copy||data.data.origin.settings.dnd.copy&&(data.event.metaKey||data.event.ctrlKey))?"copy_node":"move_node",ps=i,op==="move_node"&&v==="a"&&data.data.origin&&data.data.origin===ins&&p===ins.get_parent(data.data.nodes[t1])&&(pr=ins.get_node(p),ps>$.inArray(data.data.nodes[t1],pr.children)&&(ps-=1)),ok=ok&&(ins&&ins.settings&&ins.settings.dnd&&ins.settings.dnd.check_while_dragging===!1||ins.check(op,data.data.origin&&data.data.origin!==ins?data.data.origin.get_node(data.data.nodes[t1]):data.data.nodes[t1],p,ps,{dnd:!0,ref:ins.get_node(ref.parent()),pos:v,is_multi:data.data.origin&&data.data.origin!==ins,is_foreign:!data.data.origin})),!ok){ins&&ins.last_error&&(laster=ins.last_error());break}return v==="i"&&ref.parent().is(".jstree-closed")&&ins.settings.dnd.open_timeout&&(opento=setTimeout(function(x,z){return function(){x.open_node(z)}}(ins,ref),ins.settings.dnd.open_timeout)),ok?(lastmv={ins:ins,par:p,pos:v==="i"&&ip==="last"&&i===0&&!ins.is_loaded(tm)?"last":i},marker.css({left:l+"px",top:t+"px"}).show(),data.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok"),laster={},o=!0,!1):void 0}),o===!0))return;lastmv=!1;data.helper.find(".jstree-icon").removeClass("jstree-ok").addClass("jstree-er");marker.hide()}}).on("dnd_scroll.vakata.jstree",function(e,data){data&&data.data&&data.data.jstree&&(marker.hide(),lastmv=!1,data.helper.find(".jstree-icon").first().removeClass("jstree-ok").addClass("jstree-er"))}).on("dnd_stop.vakata.jstree",function(e,data){if(opento&&clearTimeout(opento),data&&data.data&&data.data.jstree){marker.hide().detach();var i,j,nodes=[];if(lastmv){for(i=0,j=data.data.nodes.length;i<j;i++)nodes[i]=data.data.origin?data.data.origin.get_node(data.data.nodes[i]):data.data.nodes[i],data.data.origin&&(nodes[i].instance=data.data.origin);for(lastmv.ins[data.data.origin&&(data.data.origin.settings.dnd.always_copy||data.data.origin.settings.dnd.copy&&(data.event.metaKey||data.event.ctrlKey))?"copy_node":"move_node"](nodes,lastmv.par,lastmv.pos),i=0,j=nodes.length;i<j;i++)nodes[i].instance&&(nodes[i].instance=null)}else i=$(data.event.target).closest(".jstree"),i.length&&laster&&laster.error&&laster.error==="check"&&(i=i.jstree(!0),i&&i.settings.core.error.call(this,laster))}}).on("keyup.jstree keydown.jstree",function(e,data){data=$.vakata.dnd._get();data&&data.data&&data.data.jstree&&data.helper.find(".jstree-copy").first()[data.data.origin&&(data.data.origin.settings.dnd.always_copy||data.data.origin.settings.dnd.copy&&(e.metaKey||e.ctrlKey))?"show":"hide"]()})}),function($){var vakata_dnd={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1};$.vakata.dnd={settings:{scroll_speed:10,scroll_proximity:20,helper_left:5,helper_top:10,threshold:5,threshold_touch:50},_trigger:function(event_name,e){var data=$.vakata.dnd._get();data.event=e;$(document).triggerHandler("dnd_"+event_name+".vakata",data)},_get:function(){return{data:vakata_dnd.data,element:vakata_dnd.element,helper:vakata_dnd.helper}},_clean:function(){vakata_dnd.helper&&vakata_dnd.helper.remove();vakata_dnd.scroll_i&&(clearInterval(vakata_dnd.scroll_i),vakata_dnd.scroll_i=!1);vakata_dnd={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1};$(document).off("mousemove.vakata.jstree touchmove.vakata.jstree",$.vakata.dnd.drag);$(document).off("mouseup.vakata.jstree touchend.vakata.jstree",$.vakata.dnd.stop)},_scroll:function(init_only){if(!vakata_dnd.scroll_e||!vakata_dnd.scroll_l&&!vakata_dnd.scroll_t)return vakata_dnd.scroll_i&&(clearInterval(vakata_dnd.scroll_i),vakata_dnd.scroll_i=!1),!1;if(!vakata_dnd.scroll_i)return vakata_dnd.scroll_i=setInterval($.vakata.dnd._scroll,100),!1;if(init_only===!0)return!1;var i=vakata_dnd.scroll_e.scrollTop(),j=vakata_dnd.scroll_e.scrollLeft();vakata_dnd.scroll_e.scrollTop(i+vakata_dnd.scroll_t*$.vakata.dnd.settings.scroll_speed);vakata_dnd.scroll_e.scrollLeft(j+vakata_dnd.scroll_l*$.vakata.dnd.settings.scroll_speed);(i!==vakata_dnd.scroll_e.scrollTop()||j!==vakata_dnd.scroll_e.scrollLeft())&&$.vakata.dnd._trigger("scroll",vakata_dnd.scroll_e)},start:function(e,data,html){e.type==="touchstart"&&e.originalEvent&&e.originalEvent.changedTouches&&e.originalEvent.changedTouches[0]&&(e.pageX=e.originalEvent.changedTouches[0].pageX,e.pageY=e.originalEvent.changedTouches[0].pageY,e.target=document.elementFromPoint(e.originalEvent.changedTouches[0].pageX-window.pageXOffset,e.originalEvent.changedTouches[0].pageY-window.pageYOffset));vakata_dnd.is_drag&&$.vakata.dnd.stop({});try{e.currentTarget.unselectable="on";e.currentTarget.onselectstart=function(){return!1};e.currentTarget.style&&(e.currentTarget.style.MozUserSelect="none")}catch(ignore){}vakata_dnd.init_x=e.pageX;vakata_dnd.init_y=e.pageY;vakata_dnd.data=data;vakata_dnd.is_down=!0;vakata_dnd.element=e.currentTarget;vakata_dnd.target=e.target;vakata_dnd.is_touch=e.type==="touchstart";html!==!1&&(vakata_dnd.helper=$("<div id='vakata-dnd'><\/div>").html(html).css({display:"block",margin:"0",padding:"0",position:"absolute",top:"-2000px",lineHeight:"16px",zIndex:"10000"}));$(document).on("mousemove.vakata.jstree touchmove.vakata.jstree",$.vakata.dnd.drag);$(document).on("mouseup.vakata.jstree touchend.vakata.jstree",$.vakata.dnd.stop);return!1},drag:function(e){if(e.type==="touchmove"&&e.originalEvent&&e.originalEvent.changedTouches&&e.originalEvent.changedTouches[0]&&(e.pageX=e.originalEvent.changedTouches[0].pageX,e.pageY=e.originalEvent.changedTouches[0].pageY,e.target=document.elementFromPoint(e.originalEvent.changedTouches[0].pageX-window.pageXOffset,e.originalEvent.changedTouches[0].pageY-window.pageYOffset)),vakata_dnd.is_down){if(!vakata_dnd.is_drag)if(Math.abs(e.pageX-vakata_dnd.init_x)>(vakata_dnd.is_touch?$.vakata.dnd.settings.threshold_touch:$.vakata.dnd.settings.threshold)||Math.abs(e.pageY-vakata_dnd.init_y)>(vakata_dnd.is_touch?$.vakata.dnd.settings.threshold_touch:$.vakata.dnd.settings.threshold))vakata_dnd.helper&&(vakata_dnd.helper.appendTo("body"),vakata_dnd.helper_w=vakata_dnd.helper.outerWidth()),vakata_dnd.is_drag=!0,$.vakata.dnd._trigger("start",e);else return;var d=!1,w=!1,dh=!1,wh=!1,dw=!1,ww=!1,dt=!1,dl=!1,ht=!1,hl=!1;return vakata_dnd.scroll_t=0,vakata_dnd.scroll_l=0,vakata_dnd.scroll_e=!1,$($(e.target).parentsUntil("body").addBack().get().reverse()).filter(function(){return/^auto|scroll$/.test($(this).css("overflow"))&&(this.scrollHeight>this.offsetHeight||this.scrollWidth>this.offsetWidth)}).each(function(){var t=$(this),o=t.offset();return this.scrollHeight>this.offsetHeight&&(o.top+t.height()-e.pageY<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_t=1),e.pageY-o.top<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_t=-1)),this.scrollWidth>this.offsetWidth&&(o.left+t.width()-e.pageX<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_l=1),e.pageX-o.left<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_l=-1)),vakata_dnd.scroll_t||vakata_dnd.scroll_l?(vakata_dnd.scroll_e=$(this),!1):void 0}),vakata_dnd.scroll_e||(d=$(document),w=$(window),dh=d.height(),wh=w.height(),dw=d.width(),ww=w.width(),dt=d.scrollTop(),dl=d.scrollLeft(),dh>wh&&e.pageY-dt<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_t=-1),dh>wh&&wh-(e.pageY-dt)<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_t=1),dw>ww&&e.pageX-dl<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_l=-1),dw>ww&&ww-(e.pageX-dl)<$.vakata.dnd.settings.scroll_proximity&&(vakata_dnd.scroll_l=1),(vakata_dnd.scroll_t||vakata_dnd.scroll_l)&&(vakata_dnd.scroll_e=d)),vakata_dnd.scroll_e&&$.vakata.dnd._scroll(!0),vakata_dnd.helper&&(ht=parseInt(e.pageY+$.vakata.dnd.settings.helper_top,10),hl=parseInt(e.pageX+$.vakata.dnd.settings.helper_left,10),dh&&ht+25>dh&&(ht=dh-50),dw&&hl+vakata_dnd.helper_w>dw&&(hl=dw-(vakata_dnd.helper_w+2)),vakata_dnd.helper.css({left:hl+"px",top:ht+"px"})),$.vakata.dnd._trigger("move",e),!1}},stop:function(e){if(e.type==="touchend"&&e.originalEvent&&e.originalEvent.changedTouches&&e.originalEvent.changedTouches[0]&&(e.pageX=e.originalEvent.changedTouches[0].pageX,e.pageY=e.originalEvent.changedTouches[0].pageY,e.target=document.elementFromPoint(e.originalEvent.changedTouches[0].pageX-window.pageXOffset,e.originalEvent.changedTouches[0].pageY-window.pageYOffset)),vakata_dnd.is_drag)$.vakata.dnd._trigger("stop",e);else if(e.type==="touchend"&&e.target===vakata_dnd.target){var to=setTimeout(function(){$(e.target).click()},100);$(e.target).one("click",function(){to&&clearTimeout(to)})}return $.vakata.dnd._clean(),!1}}}($);$.jstree.defaults.search={ajax:!1,fuzzy:!1,case_sensitive:!1,show_only_matches:!1,close_opened_onclear:!0,search_leaves_only:!1,search_callback:!1};$.jstree.plugins.search=function(options,parent){this.bind=function(){parent.bind.call(this);this._data.search.str="";this._data.search.dom=$();this._data.search.res=[];this._data.search.opn=[];this._data.search.som=!1;this.element.on("before_open.jstree",$.proxy(function(){var i,j,r=this._data.search.res,s=[],o=$();if(r&&r.length&&(this._data.search.dom=$(this.element[0].querySelectorAll("#"+$.map(r,function(v){return"0123456789".indexOf(v[0])!==-1?"\\3"+v[0]+" "+v.substr(1).replace($.jstree.idregex,"\\$&"):v.replace($.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.dom.children(".jstree-anchor").addClass("jstree-search"),this._data.search.som&&this._data.search.res.length)){for(i=0,j=r.length;i<j;i++)s=s.concat(this.get_node(r[i]).parents);s=$.vakata.array_remove_item($.vakata.array_unique(s),"#");o=s.length?$(this.element[0].querySelectorAll("#"+$.map(s,function(v){return"0123456789".indexOf(v[0])!==-1?"\\3"+v[0]+" "+v.substr(1).replace($.jstree.idregex,"\\$&"):v.replace($.jstree.idregex,"\\$&")}).join(", #"))):$();this.element.find(".jstree-node").hide().filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last");o=o.add(this._data.search.dom);o.parentsUntil(".jstree").addBack().show().filter(".jstree-children").each(function(){$(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last")})}},this)).on("search.jstree",$.proxy(function(e,data){this._data.search.som&&data.nodes.length&&(this.element.find(".jstree-node").hide().filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last"),data.nodes.parentsUntil(".jstree").addBack().show().filter(".jstree-children").each(function(){$(this).children(".jstree-node:visible").eq(-1).addClass("jstree-last")}))},this)).on("clear_search.jstree",$.proxy(function(e,data){this._data.search.som&&data.nodes.length&&this.element.find(".jstree-node").css("display","").filter(".jstree-last").filter(function(){return this.nextSibling}).removeClass("jstree-last")},this))};this.search=function(str,skip_async,show_only_matches){if(str===!1||$.trim(str.toString())==="")return this.clear_search();str=str.toString();var s=this.settings.search,a=s.ajax?s.ajax:!1,f=null,r=[],p=[];if(this._data.search.res.length&&this.clear_search(),show_only_matches===undefined&&(show_only_matches=s.show_only_matches),!skip_async&&a!==!1)return $.isFunction(a)?a.call(this,str,$.proxy(function(d){d&&d.d&&(d=d.d);this._load_nodes($.isArray(d)?$.vakata.array_unique(d):[],function(){this.search(str,!0,show_only_matches)},!0)},this)):(a=$.extend({},a),a.data||(a.data={}),a.data.str=str,$.ajax(a).fail($.proxy(function(){this._data.core.last_error={error:"ajax",plugin:"search",id:"search_01",reason:"Could not load search parents",data:JSON.stringify(a)};this.settings.core.error.call(this,this._data.core.last_error)},this)).done($.proxy(function(d){d&&d.d&&(d=d.d);this._load_nodes($.isArray(d)?$.vakata.array_unique(d):[],function(){this.search(str,!0,show_only_matches)},!0)},this)));this._data.search.str=str;this._data.search.dom=$();this._data.search.res=[];this._data.search.opn=[];this._data.search.som=show_only_matches;f=new $.vakata.search(str,!0,{caseSensitive:s.case_sensitive,fuzzy:s.fuzzy});$.each(this._model.data,function(i,v){v.text&&(s.search_callback&&s.search_callback.call(this,str,v)||!s.search_callback&&f.search(v.text).isMatch)&&(!s.search_leaves_only||v.state.loaded&&v.children.length===0)&&(r.push(i),p=p.concat(v.parents))});r.length&&(p=$.vakata.array_unique(p),this._search_open(p),this._data.search.dom=$(this.element[0].querySelectorAll("#"+$.map(r,function(v){return"0123456789".indexOf(v[0])!==-1?"\\3"+v[0]+" "+v.substr(1).replace($.jstree.idregex,"\\$&"):v.replace($.jstree.idregex,"\\$&")}).join(", #"))),this._data.search.res=r,this._data.search.dom.children(".jstree-anchor").addClass("jstree-search"));this.trigger("search",{nodes:this._data.search.dom,str:str,res:this._data.search.res,show_only_matches:show_only_matches})};this.clear_search=function(){this._data.search.dom.children(".jstree-anchor").removeClass("jstree-search");this.settings.search.close_opened_onclear&&this.close_node(this._data.search.opn,0);this.trigger("clear_search",{nodes:this._data.search.dom,str:this._data.search.str,res:this._data.search.res});this._data.search.str="";this._data.search.res=[];this._data.search.opn=[];this._data.search.dom=$()};this._search_open=function(d){var t=this;$.each(d.concat([]),function(i,v){if(v==="#")return!0;try{v=$("#"+v.replace($.jstree.idregex,"\\$&"),t.element)}catch(ignore){}v&&v.length&&t.is_closed(v)&&(t._data.search.opn.push(v[0].id),t.open_node(v,function(){t._search_open(d)},0))})}},function($){$.vakata.search=function(pattern,txt,options){options=options||{};options.fuzzy!==!1&&(options.fuzzy=!0);pattern=options.caseSensitive?pattern:pattern.toLowerCase();var MATCH_LOCATION=options.location||0,MATCH_DISTANCE=options.distance||100,MATCH_THRESHOLD=options.threshold||.6,patternLen=pattern.length,matchmask,pattern_alphabet,match_bitapScore,search;return patternLen>32&&(options.fuzzy=!1),options.fuzzy&&(matchmask=1<<patternLen-1,pattern_alphabet=function(){for(var mask={},i=0,i=0;i<patternLen;i++)mask[pattern.charAt(i)]=0;for(i=0;i<patternLen;i++)mask[pattern.charAt(i)]|=1<<patternLen-i-1;return mask}(),match_bitapScore=function(e,x){var accuracy=e/patternLen,proximity=Math.abs(MATCH_LOCATION-x);return MATCH_DISTANCE?accuracy+proximity/MATCH_DISTANCE:proximity?1:accuracy}),search=function(text){if(text=options.caseSensitive?text:text.toLowerCase(),pattern===text||text.indexOf(pattern)!==-1)return{isMatch:!0,score:0};if(!options.fuzzy)return{isMatch:!1,score:1};var i,j,textLen=text.length,scoreThreshold=MATCH_THRESHOLD,bestLoc=text.indexOf(pattern,MATCH_LOCATION),binMin,binMid,binMax=patternLen+textLen,lastRd,start,finish,rd,charMatch,score=1,locations=[];for(bestLoc!==-1&&(scoreThreshold=Math.min(match_bitapScore(0,bestLoc),scoreThreshold),bestLoc=text.lastIndexOf(pattern,MATCH_LOCATION+patternLen),bestLoc!==-1&&(scoreThreshold=Math.min(match_bitapScore(0,bestLoc),scoreThreshold))),bestLoc=-1,i=0;i<patternLen;i++){for(binMin=0,binMid=binMax;binMin<binMid;)match_bitapScore(i,MATCH_LOCATION+binMid)<=scoreThreshold?binMin=binMid:binMax=binMid,binMid=Math.floor((binMax-binMin)/2+binMin);for(binMax=binMid,start=Math.max(1,MATCH_LOCATION-binMid+1),finish=Math.min(MATCH_LOCATION+binMid,textLen)+patternLen,rd=new Array(finish+2),rd[finish+1]=(1<<i)-1,j=finish;j>=start;j--)if(charMatch=pattern_alphabet[text.charAt(j-1)],rd[j]=i===0?(rd[j+1]<<1|1)&charMatch:(rd[j+1]<<1|1)&charMatch|(lastRd[j+1]|lastRd[j])<<1|1|lastRd[j+1],rd[j]&matchmask&&(score=match_bitapScore(i,j-1),score<=scoreThreshold))if(scoreThreshold=score,bestLoc=j-1,locations.push(bestLoc),bestLoc>MATCH_LOCATION)start=Math.max(1,2*MATCH_LOCATION-bestLoc);else break;if(match_bitapScore(i+1,MATCH_LOCATION)>scoreThreshold)break;lastRd=rd}return{isMatch:bestLoc>=0,score:score}},txt===!0?{search:search}:search(txt)}}($);$.jstree.defaults.sort=function(a,b){return this.get_text(a)>this.get_text(b)?1:-1};$.jstree.plugins.sort=function(options,parent){this.bind=function(){parent.bind.call(this);this.element.on("model.jstree",$.proxy(function(e,data){this.sort(data.parent,!0)},this)).on("rename_node.jstree create_node.jstree",$.proxy(function(e,data){this.sort(data.parent||data.node.parent,!1);this.redraw_node(data.parent||data.node.parent,!0)},this)).on("move_node.jstree copy_node.jstree",$.proxy(function(e,data){this.sort(data.parent,!1);this.redraw_node(data.parent,!0)},this))};this.sort=function(obj,deep){var i,j;if(obj=this.get_node(obj),obj&&obj.children&&obj.children.length&&(obj.children.sort($.proxy(this.settings.sort,this)),deep))for(i=0,j=obj.children_d.length;i<j;i++)this.sort(obj.children_d[i],!1)}};to=!1;$.jstree.defaults.state={key:"jstree",events:"changed.jstree open_node.jstree close_node.jstree",ttl:!1,filter:!1};$.jstree.plugins.state=function(options,parent){this.bind=function(){parent.bind.call(this);var bind=$.proxy(function(){this.element.on(this.settings.state.events,$.proxy(function(){to&&clearTimeout(to);to=setTimeout($.proxy(function(){this.save_state()},this),100)},this))},this);this.element.on("ready.jstree",$.proxy(function(){this.element.one("restore_state.jstree",bind);this.restore_state()||bind()},this))};this.save_state=function(){var st={state:this.get_state(),ttl:this.settings.state.ttl,sec:+new Date};$.vakata.storage.set(this.settings.state.key,JSON.stringify(st))};this.restore_state=function(){var k=$.vakata.storage.get(this.settings.state.key);if(!!k)try{k=JSON.parse(k)}catch(ex){return!1}if(!!k&&k.ttl&&k.sec&&+new Date-k.sec>k.ttl)return!1;if(!!k&&k.state&&(k=k.state),!!k&&$.isFunction(this.settings.state.filter)&&(k=this.settings.state.filter.call(this,k)),!!k){this.element.one("set_state.jstree",function(e,data){data.instance.trigger("restore_state",{state:$.extend(!0,{},k)})});return this.set_state(k),!0}return!1};this.clear_state=function(){return $.vakata.storage.del(this.settings.state.key)}},function($){$.vakata.storage={set:function(key,val){return window.localStorage.setItem(key,val)},get:function(key){return window.localStorage.getItem(key)},del:function(key){return window.localStorage.removeItem(key)}}}($);$.jstree.defaults.types={"#":{},"default":{}};$.jstree.plugins.types=function(options,parent){this.init=function(el,options){var i,j;if(options&&options.types&&options.types["default"])for(i in options.types)if(i!=="default"&&i!=="#"&&options.types.hasOwnProperty(i))for(j in options.types["default"])options.types["default"].hasOwnProperty(j)&&options.types[i][j]===undefined&&(options.types[i][j]=options.types["default"][j]);parent.init.call(this,el,options);this._model.data["#"].type="#"};this.refresh=function(skip_loading,forget_state){parent.refresh.call(this,skip_loading,forget_state);this._model.data["#"].type="#"};this.bind=function(){this.element.on("model.jstree",$.proxy(function(e,data){for(var m=this._model.data,dpc=data.nodes,t=this.settings.types,c="default",i=0,j=dpc.length;i<j;i++)c="default",m[dpc[i]].original&&m[dpc[i]].original.type&&t[m[dpc[i]].original.type]&&(c=m[dpc[i]].original.type),m[dpc[i]].data&&m[dpc[i]].data.jstree&&m[dpc[i]].data.jstree.type&&t[m[dpc[i]].data.jstree.type]&&(c=m[dpc[i]].data.jstree.type),m[dpc[i]].type=c,m[dpc[i]].icon===!0&&t[c].icon!==undefined&&(m[dpc[i]].icon=t[c].icon);m["#"].type="#"},this));parent.bind.call(this)};this.get_json=function(obj,options,flat){var i,j,m=this._model.data,opt=options?$.extend(!0,{},options,{no_id:!1}):{},tmp=parent.get_json.call(this,obj,opt,flat);if(tmp===!1)return!1;if($.isArray(tmp))for(i=0,j=tmp.length;i<j;i++)tmp[i].type=tmp[i].id&&m[tmp[i].id]&&m[tmp[i].id].type?m[tmp[i].id].type:"default",options&&options.no_id&&(delete tmp[i].id,tmp[i].li_attr&&tmp[i].li_attr.id&&delete tmp[i].li_attr.id,tmp[i].a_attr&&tmp[i].a_attr.id&&delete tmp[i].a_attr.id);else tmp.type=tmp.id&&m[tmp.id]&&m[tmp.id].type?m[tmp.id].type:"default",options&&options.no_id&&(tmp=this._delete_ids(tmp));return tmp};this._delete_ids=function(tmp){if($.isArray(tmp)){for(var i=0,j=tmp.length;i<j;i++)tmp[i]=this._delete_ids(tmp[i]);return tmp}return delete tmp.id,tmp.li_attr&&tmp.li_attr.id&&delete tmp.li_attr.id,tmp.a_attr&&tmp.a_attr.id&&delete tmp.a_attr.id,tmp.children&&$.isArray(tmp.children)&&(tmp.children=this._delete_ids(tmp.children)),tmp};this.check=function(chk,obj,par,pos,more){if(parent.check.call(this,chk,obj,par,pos,more)===!1)return!1;obj=obj&&obj.id?obj:this.get_node(obj);par=par&&par.id?par:this.get_node(par);var m=obj&&obj.id?$.jstree.reference(obj.id):null,tmp,d,i,j;m=m&&m._model&&m._model.data?m._model.data:null;switch(chk){case"create_node":case"move_node":case"copy_node":if(chk!=="move_node"||$.inArray(obj.id,par.children)===-1){if(tmp=this.get_rules(par),tmp.max_children!==undefined&&tmp.max_children!==-1&&tmp.max_children===par.children.length)return this._data.core.last_error={error:"check",plugin:"types",id:"types_01",reason:"max_children prevents function: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})},!1;if(tmp.valid_children!==undefined&&tmp.valid_children!==-1&&$.inArray(obj.type||"default",tmp.valid_children)===-1)return this._data.core.last_error={error:"check",plugin:"types",id:"types_02",reason:"valid_children prevents function: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})},!1;if(m&&obj.children_d&&obj.parents){for(d=0,i=0,j=obj.children_d.length;i<j;i++)d=Math.max(d,m[obj.children_d[i]].parents.length);d=d-obj.parents.length+1}(d<=0||d===undefined)&&(d=1);do{if(tmp.max_depth!==undefined&&tmp.max_depth!==-1&&tmp.max_depth<d)return this._data.core.last_error={error:"check",plugin:"types",id:"types_03",reason:"max_depth prevents function: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})},!1;par=this.get_node(par.parent);tmp=this.get_rules(par);d++}while(par)}}return!0};this.get_rules=function(obj){if(obj=this.get_node(obj),!obj)return!1;var tmp=this.get_type(obj,!0);return tmp.max_depth===undefined&&(tmp.max_depth=-1),tmp.max_children===undefined&&(tmp.max_children=-1),tmp.valid_children===undefined&&(tmp.valid_children=-1),tmp};this.get_type=function(obj,rules){return obj=this.get_node(obj),obj?rules?$.extend({type:obj.type},this.settings.types[obj.type]):obj.type:!1};this.set_type=function(obj,type){var t,t1,t2,old_type,old_icon;if($.isArray(obj)){for(obj=obj.slice(),t1=0,t2=obj.length;t1<t2;t1++)this.set_type(obj[t1],type);return!0}return(t=this.settings.types,obj=this.get_node(obj),!t[type]||!obj)?!1:(old_type=obj.type,old_icon=this.get_icon(obj),obj.type=type,(old_icon===!0||t[old_type]&&t[old_type].icon!==undefined&&old_icon===t[old_type].icon)&&this.set_icon(obj,t[type].icon!==undefined?t[type].icon:!0),!0)}};$.jstree.defaults.unique={case_sensitive:!1,duplicate:function(name,counter){return name+" ("+counter+")"}};$.jstree.plugins.unique=function(options,parent){this.check=function(chk,obj,par,pos,more){if(parent.check.call(this,chk,obj,par,pos,more)===!1)return!1;if(obj=obj&&obj.id?obj:this.get_node(obj),par=par&&par.id?par:this.get_node(par),!par||!par.children)return!0;for(var n=chk==="rename_node"?pos:obj.text,c=[],s=this.settings.unique.case_sensitive,m=this._model.data,i=0,j=par.children.length;i<j;i++)c.push(s?m[par.children[i]].text:m[par.children[i]].text.toLowerCase());s||(n=n.toLowerCase());switch(chk){case"delete_node":return!0;case"rename_node":return i=$.inArray(n,c)===-1||obj.text&&obj.text[s?"toString":"toLowerCase"]()===n,i||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_01",reason:"Child with name "+n+" already exists. Preventing: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})}),i;case"create_node":return i=$.inArray(n,c)===-1,i||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_04",reason:"Child with name "+n+" already exists. Preventing: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})}),i;case"copy_node":return i=$.inArray(n,c)===-1,i||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_02",reason:"Child with name "+n+" already exists. Preventing: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})}),i;case"move_node":return i=obj.parent===par.id||$.inArray(n,c)===-1,i||(this._data.core.last_error={error:"check",plugin:"unique",id:"unique_03",reason:"Child with name "+n+" already exists. Preventing: "+chk,data:JSON.stringify({chk:chk,pos:pos,obj:obj&&obj.id?obj.id:!1,par:par&&par.id?par.id:!1})}),i}return!0};this.create_node=function(par,node,pos,callback,is_loaded){if(!node||node.text===undefined){if((par===null&&(par="#"),par=this.get_node(par),!par)||(pos=pos===undefined?"last":pos,!pos.toString().match(/^(before|after)$/)&&!is_loaded&&!this.is_loaded(par)))return parent.create_node.call(this,par,node,pos,callback,is_loaded);node||(node={});var tmp,n,dpc,i,j,m=this._model.data,s=this.settings.unique.case_sensitive,cb=this.settings.unique.duplicate;for(n=tmp=this.get_string("New node"),dpc=[],i=0,j=par.children.length;i<j;i++)dpc.push(s?m[par.children[i]].text:m[par.children[i]].text.toLowerCase());for(i=1;$.inArray(s?n:n.toLowerCase(),dpc)!==-1;)n=cb.call(this,tmp,++i).toString();node.text=n}return parent.create_node.call(this,par,node,pos,callback,is_loaded)}};div=document.createElement("DIV");div.setAttribute("unselectable","on");div.setAttribute("role","presentation");div.className="jstree-wholerow";div.innerHTML="&#160;";$.jstree.plugins.wholerow=function(options,parent){this.bind=function(){parent.bind.call(this);this.element.on("ready.jstree set_state.jstree",$.proxy(function(){this.hide_dots()},this)).on("init.jstree loading.jstree ready.jstree",$.proxy(function(){this.get_container_ul().addClass("jstree-wholerow-ul")},this)).on("deselect_all.jstree",$.proxy(function(){this.element.find(".jstree-wholerow-clicked").removeClass("jstree-wholerow-clicked")},this)).on("changed.jstree",$.proxy(function(e,data){this.element.find(".jstree-wholerow-clicked").removeClass("jstree-wholerow-clicked");for(var tmp=!1,i=0,j=data.selected.length;i<j;i++)tmp=this.get_node(data.selected[i],!0),tmp&&tmp.length&&tmp.children(".jstree-wholerow").addClass("jstree-wholerow-clicked")},this)).on("open_node.jstree",$.proxy(function(e,data){this.get_node(data.node,!0).find(".jstree-clicked").parent().children(".jstree-wholerow").addClass("jstree-wholerow-clicked")},this)).on("hover_node.jstree dehover_node.jstree",$.proxy(function(e,data){e.type==="hover_node"&&this.is_disabled(data.node)||this.get_node(data.node,!0).children(".jstree-wholerow")[e.type==="hover_node"?"addClass":"removeClass"]("jstree-wholerow-hovered")},this)).on("contextmenu.jstree",".jstree-wholerow",$.proxy(function(e){e.preventDefault();var tmp=$.Event("contextmenu",{metaKey:e.metaKey,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey,pageX:e.pageX,pageY:e.pageY});$(e.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(tmp)},this)).on("click.jstree",".jstree-wholerow",function(e){e.stopImmediatePropagation();var tmp=$.Event("click",{metaKey:e.metaKey,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey});$(e.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(tmp).focus()}).on("click.jstree",".jstree-leaf > .jstree-ocl",$.proxy(function(e){e.stopImmediatePropagation();var tmp=$.Event("click",{metaKey:e.metaKey,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey});$(e.currentTarget).closest(".jstree-node").children(".jstree-anchor").first().trigger(tmp).focus()},this)).on("mouseover.jstree",".jstree-wholerow, .jstree-icon",$.proxy(function(e){return e.stopImmediatePropagation(),this.is_disabled(e.currentTarget)||this.hover_node(e.currentTarget),!1},this)).on("mouseleave.jstree",".jstree-node",$.proxy(function(e){this.dehover_node(e.currentTarget)},this))};this.teardown=function(){this.settings.wholerow&&this.element.find(".jstree-wholerow").remove();parent.teardown.call(this)};this.redraw_node=function(obj){if(obj=parent.redraw_node.apply(this,arguments),obj){var tmp=div.cloneNode(!0);$.inArray(obj.id,this._data.core.selected)!==-1&&(tmp.className+=" jstree-wholerow-clicked");this._data.core.focused&&this._data.core.focused===obj.id&&(tmp.className+=" jstree-wholerow-hovered");obj.insertBefore(tmp,obj.childNodes[0])}return obj}},function($){if(document.registerElement&&Object&&Object.create){var proto=Object.create(HTMLElement.prototype);proto.createdCallback=function(){var c={core:{},plugins:[]};for(var i in $.jstree.plugins)$.jstree.plugins.hasOwnProperty(i)&&this.attributes[i]&&(c.plugins.push(i),this.getAttribute(i)&&JSON.parse(this.getAttribute(i))&&(c[i]=JSON.parse(this.getAttribute(i))));for(i in $.jstree.defaults.core)$.jstree.defaults.core.hasOwnProperty(i)&&this.attributes[i]&&(c.core[i]=JSON.parse(this.getAttribute(i))||this.getAttribute(i));jQuery(this).jstree(c)};try{document.registerElement("vakata-jstree",{prototype:proto})}catch(ignore){}}}(jQuery)}});__extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},function(Akumina){var AddIn;(function(AddIn){var discussionResponse=function(){function discussionResponse(){this.Showdiscussion=!0}return discussionResponse}(),discussionRequest,createDiscussionBlock;AddIn.discussionResponse=discussionResponse;discussionRequest=function(_super){function discussionRequest(){_super.apply(this,arguments)}return __extends(discussionRequest,_super),discussionRequest}(AddIn.BaseRequest);AddIn.discussionRequest=discussionRequest;createDiscussionBlock=function(){function createDiscussionBlock(createDiscussionRequest){this.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));this.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));this.discussionRequest=createDiscussionRequest;this.discussionRequest.EditMode=Akumina.AddIn.Utilities.getEditMode()}return createDiscussionBlock.prototype.renderdiscussion=function(){var data,utils,displayTemplate;this.discussionRequest.EditMode||(data=new discussionResponse,utils=Akumina.AddIn.Utilities,this.discussionRequest.Hosted&&utils.IsNullOrEmpty(this.discussionRequest.DisplayTemplateUrl)&&(this.discussionRequest.DisplayTemplateUrl="/Content/Templates/CreateNewDiscussion/Default.html"),displayTemplate=this.appWebUrl+this.discussionRequest.DisplayTemplateUrl,data.SenderId=this.discussionRequest.SenderId,data.LibraryName=this.discussionRequest.DocumentListName,data.ListName=this.discussionRequest.ListName,data.WebPartTitle=this.discussionRequest.Title,data.DiscussionListingPageUrl=this.discussionRequest.DiscussionListingUrl,data.hosted=this.discussionRequest.Hosted,data.Items=[],this.discussionRequest.EditMode||createDiscussionBlock.prototype.render(displayTemplate,data))},createDiscussionBlock.prototype.error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},createDiscussionBlock.prototype.render=function(templateUri,data){$.ajax(templateUri).done(function(template){var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){if(data.hosted)$("body").html(data.Html),AKSenderData.options={discussionlistingpageurl:data.DiscussionListingPageUrl,approoturl:document.location.protocol+"//"+document.location.hostname+(document.location.port!=""?":"+document.location.port:"")+"/"},AKNotifyParent(data.SenderId);else{$("#"+data.SenderId).html(data.Html);var discussionOptions={apppart:!1,UniqueId:data.SenderId,Hosted:data.hosted,html:data.Html,options:{dataJSON:{},discussionlistingpageurl:data.DiscussionListingPageUrl,approoturl:{}}},iaCreateNewDiscussion=new Akumina.AppParts.CreateNewDiscussion(discussionOptions)}})},createDiscussionBlock}();AddIn.createDiscussionBlock=createDiscussionBlock})(AddIn=Akumina.AddIn||(Akumina.AddIn={}))}(Akumina||(Akumina={}));__extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},function(Akumina){var AddIn;(function(AddIn){var discussionResponse=function(){function discussionResponse(){this.Showdiscussion=!0}return discussionResponse}(),discussionRequest,discussionBoardListingBlock;AddIn.discussionResponse=discussionResponse;discussionRequest=function(_super){function discussionRequest(){_super.apply(this,arguments)}return __extends(discussionRequest,_super),discussionRequest}(AddIn.BaseRequest);AddIn.discussionRequest=discussionRequest;discussionBoardListingBlock=function(){function discussionBoardListingBlock(discussionBlockRequest){this.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));this.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));this.discussionRequest=discussionBlockRequest;this.discussionRequest.EditMode=Akumina.AddIn.Utilities.getEditMode()}return discussionBoardListingBlock.prototype.renderdiscussion=function(){var discussionOptions,iaDiscussionBoard,context,web,parentContext,camlQuery,query;this.discussionRequest.EditMode||(this.discussionRequest.Hosted||(discussionOptions={UniqueId:this.discussionRequest.SenderId,Hosted:this.discussionRequest.Hosted,options:{showspinner:!0,dataJSON:{},DisplayAvatar:this.discussionRequest.DisplayAvatar,DiscussionListingPageUrl:this.discussionRequest.DiscussionListingUrl}},iaDiscussionBoard=new Akumina.AppParts.DiscussionBoard(discussionOptions)),context=new SP.ClientContext.get_current,this.discussionRequest.Hosted?(parentContext=new SP.AppContextSite(context,this.hostUrl),web=parentContext.get_web()):web=context.get_web(),this.list=web.get_lists().getByTitle(this.discussionRequest.ListName),camlQuery=new SP.CamlQuery,query="<View><Query><Where><Eq><FieldRef Name='ConfirmArchive'/><Value Type='Boolean'>False<\/Value><\/Eq><\/Where><\/Query><\/View>",context.load(web,"EffectiveBasePermissions"),context.load(this.list,"EffectiveBasePermissions"),Akumina.AddIn.Logger.logSPCall("discussionBoardListingBlock.prototype.renderdiscussion"),context.executeQueryAsync(Function.createDelegate(this,function(){this.managePermissions=web.get_effectiveBasePermissions().has(SP.PermissionKind.managePermissions);camlQuery.set_viewXml(query);this.listItems=this.list.getItems(camlQuery);context.load(this.listItems,"ListItemCollectionPosition","Include("+Akumina.AddIn.Configuration.getSelectFields("DiscussionBoard").join()+")");Akumina.AddIn.Logger.logSPCall("discussionBoardListingBlock.prototype.renderdiscussion");context.executeQueryAsync(Function.createDelegate(this,this.success),Function.createDelegate(this,this.error))}),Function.createDelegate(this,this.error)))},discussionBoardListingBlock.prototype.success=function(){var me=this,discussionShared=new Akumina.AddIn.discussionShared,listEnumerator=this.listItems.getEnumerator(),data=new discussionResponse,utils=Akumina.AddIn.Utilities,DiscussionThreadPageUrl,displayTemplate,count,pageSize,lastindex;data.Items=[];DiscussionThreadPageUrl=this.discussionRequest.DiscussionThreadUrl;this.discussionRequest.Hosted&&utils.IsNullOrEmpty(this.discussionRequest.DisplayTemplateUrl)&&(this.discussionRequest.DisplayTemplateUrl="/Content/Templates/DiscussionBoard/Default.html");displayTemplate=this.appWebUrl+this.discussionRequest.DisplayTemplateUrl;count=0;data.SenderId=this.discussionRequest.SenderId;data.WebPartTitle=this.discussionRequest.Title;data.DiscussionCreatePageUrl=this.discussionRequest.DiscussionCreateUrl;data.DiscussionListingPageUrl=this.discussionRequest.DiscussionListingUrl;data.DisplayAvatar=this.discussionRequest.DisplayAvatar;data.Hosted=this.discussionRequest.Hosted;data.ListName=this.discussionRequest.ListName;data.previousPagingInfo="PagedPrev=TRUE&Paged=TRUE&p_ID="+(this.listItems.get_count()>0?this.listItems.itemAt(0).get_item("ID"):"");var pageIndex=me.getparamsiframe("pg"),columnValue=me.getparamsiframe("col"),sortOrderValue=me.getparamsiframe("sort");pageIndex==""&&(pageIndex=1);data.hdnPageValue=pageIndex;columnValue==""&&(columnValue="Created");data.hdnColumnValue=columnValue;sortOrderValue==""&&(sortOrderValue="DESC");data.hdnSortOrderValue=sortOrderValue;pageSize=parseInt(this.discussionRequest.NumberPosts);data.StartNumber=(pageIndex-1)*pageSize+1;data.EndNumber=(pageIndex-1)*pageSize+pageSize;data.TotalNumber=this.listItems.get_count();data.EndNumber>data.TotalNumber&&(data.EndNumber=data.TotalNumber);data.TotalPages=Math.ceil(data.TotalNumber/pageSize);data.ShowPaging=data.TotalNumber>pageSize;lastindex=(data.TotalPages-1)*pageSize-1;data.LastIndexID=this.listItems.itemAt(lastindex)!=undefined?this.listItems.itemAt(lastindex).get_item("ID"):"";var hostUrl=this.hostUrl,appWebUrl=this.appWebUrl,properties=this.discussionRequest,effectivePermission=this.list.get_effectiveBasePermissions(),addPermission=effectivePermission.has(SP.PermissionKind.addListItems);data.AllowAddNew=addPermission;data.TotalNumber==0?(data.Items=[],me.preparerender(displayTemplate,data)):this.GetCurrentUsername().then(function(currentUser){for(var listItem,userId;listEnumerator.moveNext();)listItem=listEnumerator.get_current(),me.discussionRequest.PostType=="lp"?discussionShared.getReplies(listItem,properties,hostUrl,"1",data.Hosted,me.discussionRequest.SubSite).then(function(itemReply,discussionItem,discussionRequest){var totalreplies=discussionItem.get_item("ItemChildCount"),discussionLastPostDate=new Date(discussionItem.get_item("DiscussionLastUpdated")),discussionCreatedPostDate=new Date(discussionItem.get_item("Created")),body=discussionItem.get_item("Body")!=null?discussionItem.get_item("Body").replace(/<.*?>/g,"").length>discussionRequest.PreviewCount?discussionItem.get_item("Body").replace(/<.*?>/g,"").substring(0,discussionRequest.PreviewCount)+"...":discussionItem.get_item("Body").replace(/<.*?>/g,""):null,author=discussionItem.get_item("Author").get_lookupValue(),userId=discussionItem.get_item("Author").get_lookupId(),replyEnumerator,listItem;if(discussionItem.get_item("ItemChildCount")>0)for(replyEnumerator=itemReply.getEnumerator();replyEnumerator.moveNext();)listItem=replyEnumerator.get_current(),body=listItem.get_item("Body")!=null?listItem.get_item("Body").replace(/<.*?>/g,"").length>discussionRequest.PreviewCount?listItem.get_item("Body").replace(/<.*?>/g,"").substring(0,discussionRequest.PreviewCount)+"...":listItem.get_item("Body").replace(/<.*?>/g,""):null,author=listItem.get_item("Author").get_lookupValue(),userId=listItem.get_item("Author").get_lookupId();discussionShared.getUser(userId,discussionItem,discussionRequest,hostUrl,data.Hosted).then(function(user,discussionItem,discussionRequest){var discussionPostDate=new Date(discussionItem.get_item("DiscussionLastUpdated")),permissions,itemDiscussion;count=count+1;permissions=me.checkpermissions(currentUser,discussionItem.get_item("Author").get_lookupId(),discussionItem);itemDiscussion={AuthorPicture:user.itemAt(0).get_item("Picture")!=null?hostUrl+"/_layouts/15/userphoto.aspx?size=L&url="+user.itemAt(0).get_item("Picture").get_url():__getTemplatePrefix()+"/Style Library/DigitalWorkplace/images/anonymous-user.png",Author:author,EditDiscussionPost:DiscussionThreadPageUrl+"?DiscussionId="+discussionItem.get_item("ID"),Title:discussionItem.get_item("Title").length>discussionRequest.TitleCount?discussionItem.get_item("Title").substring(0,discussionRequest.TitleCount)+"...":discussionItem.get_item("Title"),Body:body,ID:discussionItem.get_item("ID"),TimeAgoDiscussionLastUpdated:discussionLastPostDate.format("MMM. dd,yyyy"),TimeAgoCreated:discussionCreatedPostDate.format("MMM. dd,yyyy"),TotalReplies:totalreplies,ModifyPermission:permissions.threadAdmin,Created:new Date(discussionItem.get_item("Created")),DiscussionLastUpdated:new Date(discussionItem.get_item("DiscussionLastUpdated"))};data.Items.push(itemDiscussion);data.TotalNumber==count&&me.preparerender(displayTemplate,data)},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("An error occured while retrieving libraries:"+args.get_message())})},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("An error occured while retrieving libraries:"+args.get_message())}):(userId=listItem.get_item("Author").get_lookupId(),discussionShared.getUser(userId,listItem,properties,hostUrl,data.Hosted).then(function(user,discussionItem,discussionRequest){var totalreplies=discussionItem.get_item("ItemChildCount");count=count+1;var permissions=me.checkpermissions(currentUser,discussionItem.get_item("Author").get_lookupId(),discussionItem),discussionLastPostDate=new Date(discussionItem.get_item("DiscussionLastUpdated")),discussionCreatedPostDate=new Date(discussionItem.get_item("Created")),itemDiscussion={AuthorPicture:user.itemAt(0).get_item("Picture")!=null?hostUrl+"/_layouts/15/userphoto.aspx?size=L&url="+user.itemAt(0).get_item("Picture").get_url():__getTemplatePrefix()+"/Style Library/DigitalWorkplace/images/anonymous-user.png",Author:discussionItem.get_item("Author").get_lookupValue(),EditDiscussionPost:DiscussionThreadPageUrl+"?DiscussionId="+discussionItem.get_item("ID"),Title:discussionItem.get_item("Title").length>discussionRequest.TitleCount?discussionItem.get_item("Title").substring(0,discussionRequest.TitleCount)+"...":discussionItem.get_item("Title"),Body:discussionItem.get_item("Body")!=null?discussionItem.get_item("Body").replace(/<.*?>/g,"").length>discussionRequest.PreviewCount?discussionItem.get_item("Body").replace(/<.*?>/g,"").substring(0,discussionRequest.PreviewCount)+"...":discussionItem.get_item("Body").replace(/<.*?>/g,""):null,ID:discussionItem.get_item("ID"),TimeAgoDiscussionLastUpdated:discussionLastPostDate.format("MMM. dd,yyyy"),TimeAgoCreated:discussionCreatedPostDate.format("MMM. dd,yyyy"),TotalReplies:totalreplies,ModifyPermission:permissions.threadAdmin,Created:new Date(discussionItem.get_item("Created")),DiscussionLastUpdated:new Date(discussionItem.get_item("DiscussionLastUpdated"))};data.Items.push(itemDiscussion);data.TotalNumber==count&&me.preparerender(displayTemplate,data)},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("An error occured while retrieving libraries:"+args.get_message())}))},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message())})},discussionBoardListingBlock.prototype.getparamsiframe=function(field){var utils=Akumina.AddIn.Utilities,iframeUrl="";return iframeUrl=this.discussionRequest.Hosted?document.referrer:document.location.href,discussionBoardListingBlock.prototype.getQueryStringParameterFromString(decodeURIComponent(iframeUrl),field,"")},discussionBoardListingBlock.prototype.preparerender=function(displayTemplate,data){var fieldNameUrl=this.getparamsiframe("col"),sortUrl=this.getparamsiframe("sort");data.Items.length>0&&(data.Items=this.sortItems(data.Items,fieldNameUrl,sortUrl),data.Items=this.pageItems(data));this.render(displayTemplate,data)},discussionBoardListingBlock.prototype.pageItems=function(data){var pageSize=parseInt(this.discussionRequest.NumberPosts),pageIndex=this.getparamsiframe("pg"),skipValue=((pageIndex!=""?pageIndex:1)-1)*pageSize;return data.Items=data.Items.slice(skipValue,pageSize+skipValue),data.Items},discussionBoardListingBlock.prototype.error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},discussionBoardListingBlock.prototype.GetCurrentUsername=function(){var def=$.Deferred(),me=this,ctxt=new SP.ClientContext.get_current,web,parentContext;return this.discussionRequest.Hosted?(parentContext=new SP.AppContextSite(ctxt,this.hostUrl),web=parentContext.get_web()):web=ctxt.get_web(),me.currentUser=web.get_currentUser(),ctxt.load(me.currentUser),Akumina.AddIn.Logger.logSPCall("discussionBoardListingBlock.prototype.GetCurrentUsername"),ctxt.executeQueryAsync(Function.createDelegate(me,function(){def.resolve(this.currentUser)}),Function.createDelegate(me,function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message());def.reject()})),def},discussionBoardListingBlock.prototype.checkpermissions=function(user,itemUserID){var permissions={threadAdmin:!1,siteAdmin:!1},managePermissions;return user.get_id()==itemUserID&&(permissions.threadAdmin=!0),managePermissions=this.managePermissions,(user.get_title()=="System Account"||user.get_isSiteAdmin()==!0||managePermissions==!0)&&(permissions.siteAdmin=!0,permissions.threadAdmin=!0),permissions},discussionBoardListingBlock.prototype.sortItems=function(items,field,ascending){switch(field){case"":field="Created";break;case"ItemChildCount":field="TotalReplies"}return ascending=="ASC"?items.sort(function(a,b){return a[field]-b[field]}):items.sort(function(a,b){return b[field]-a[field]})},discussionBoardListingBlock.prototype.getQueryStringParameterFromString=function(url,paramToRetrieve,defaultValue){var queryString=url.split("?"),params,i,singleParam;for(queryString=decodeURIComponent(queryString[queryString.length-1]),params=queryString.split("&"),i=0;i<params.length;i=i+1)if(singleParam=params[i].split("="),singleParam[0]===paramToRetrieve)return decodeURIComponent(singleParam[1]);return defaultValue},discussionBoardListingBlock.prototype.render=function(templateUri,data){$.ajax(templateUri).done(function(template){var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){if(data.Hosted)$("body").html(data.Html),AKSenderData.options={DisplayAvatar:data.DisplayAvatar},AKNotifyParent(data.SenderId);else{$("#"+data.SenderId).html(data.Html);var discussionOptions={UniqueId:data.SenderId,Hosted:data.Hosted,options:{showspinner:!1,dataJSON:{},DisplayAvatar:data.DisplayAvatar,DiscussionListingPageUrl:data.DiscussionListingPageUrl}},iaDiscussionBoard=new Akumina.AppParts.DiscussionBoard(discussionOptions)}})},discussionBoardListingBlock}();AddIn.discussionBoardListingBlock=discussionBoardListingBlock})(AddIn=Akumina.AddIn||(Akumina.AddIn={}))}(Akumina||(Akumina={}));__extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},function(Akumina){var AddIn;(function(AddIn){var discussionResponse=function(){function discussionResponse(){this.Showdiscussion=!0}return discussionResponse}(),discussionRequest,discussionSummaryBlock;AddIn.discussionResponse=discussionResponse;discussionRequest=function(_super){function discussionRequest(){_super.apply(this,arguments)}return __extends(discussionRequest,_super),discussionRequest}(AddIn.BaseRequest);AddIn.discussionRequest=discussionRequest;discussionSummaryBlock=function(){function discussionSummaryBlock(discussionSummaryRequest){this.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));this.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));this.discussionRequest=discussionSummaryRequest;this.discussionRequest.EditMode=Akumina.AddIn.Utilities.getEditMode()}return discussionSummaryBlock.prototype.renderdiscussion=function(){var context,siteUrl,parentContext;if(!this.discussionRequest.EditMode){context=null;Akumina.AddIn.Utilities.IsNullOrEmpty(this.discussionRequest.SubSite)?context=new SP.ClientContext.get_current:(siteUrl=_spPageContextInfo.siteServerRelativeUrl+"/"+this.discussionRequest.SubSite,context=new SP.ClientContext(siteUrl));this.discussionRequest.Hosted?(parentContext=new SP.AppContextSite(context,this.hostUrl),web=parentContext.get_web()):web=context.get_web();var list=web.get_lists().getByTitle(this.discussionRequest.ListName),camlQuery=new SP.CamlQuery,query="<View><Query><Where><Eq><FieldRef Name='ConfirmArchive'/><Value Type='Boolean'>FALSE<\/Value><\/Eq><\/Where><\/Query><RowLimit>"+this.discussionRequest.NumberPosts+"<\/RowLimit><OrderBy><FieldRef Name='ID' Ascending='FALSE' /><\/OrderBy><\/View>";camlQuery.set_viewXml(query);this.listItems=list.getItems(camlQuery);context.load(this.listItems,"Include("+Akumina.AddIn.Configuration.getSelectFields("DiscussionSummary").join()+")");Akumina.AddIn.Logger.logSPCall("discussionSummaryBlock.prototype.renderdiscussion");context.executeQueryAsync(Function.createDelegate(this,this.success),Function.createDelegate(this,this.error))}},discussionSummaryBlock.prototype.success=function(){var me=this,discussionShared=new Akumina.AddIn.discussionShared,listEnumerator=this.listItems.getEnumerator(),data=new discussionResponse,utils=Akumina.AddIn.Utilities,DiscussionThreadPageUrl,displayTemplate,count,listItem,userId;data.Items=[];DiscussionThreadPageUrl=this.discussionRequest.DiscussionThreadUrl;this.discussionRequest.Hosted&&utils.IsNullOrEmpty(this.discussionRequest.DisplayTemplateUrl)&&(this.discussionRequest.DisplayTemplateUrl="/Content/Templates/DiscussionSummary/Default.html");displayTemplate=this.appWebUrl+this.discussionRequest.DisplayTemplateUrl;count=0;data.SenderId=this.discussionRequest.SenderId;data.WebPartTitle=this.discussionRequest.Title;data.WebPartIcon=utils.GetIcon(this.discussionRequest.Icon);data.DisplayWebPartIcon=data.WebPartIcon=="0"||data.WebPartIcon.toLowerCase().trim()=="none"?!1:!0;data.ShowHeader=this.discussionRequest.Title!==""||utils.GetIcon(this.discussionRequest.Icon)!=="0";data.DiscussionListingPageUrl=this.discussionRequest.DiscussionListingUrl;data.DisplayAvatar=this.discussionRequest.DisplayAvatar;data.Hosted=this.discussionRequest.Hosted;for(var hostUrl=this.hostUrl,appWebUrl=this.appWebUrl,discussionTitleTextCount=this.discussionRequest.TitleCount,properties=this.discussionRequest,totalItems=this.listItems.get_count();listEnumerator.moveNext();)listItem=listEnumerator.get_current(),this.discussionRequest.PostType=="lp"?discussionShared.getReplies(listItem,properties,hostUrl,"1",data.Hosted,this.discussionRequest.SubSite).then(function(itemReply,discussionItem,discussionRequest){var body=discussionItem.get_item("Body")!=null?discussionItem.get_item("Body").replace(/<.*?>/g,"").length>discussionRequest.PreviewCount?discussionItem.get_item("Body").replace(/<.*?>/g,"").substring(0,discussionRequest.PreviewCount)+"...":discussionItem.get_item("Body").replace(/<.*?>/g,""):null,author=discussionItem.get_item("Author").get_lookupValue(),userId=discussionItem.get_item("Author").get_lookupId(),replyEnumerator,listItem;if(discussionItem.get_item("ItemChildCount")>0)for(replyEnumerator=itemReply.getEnumerator();replyEnumerator.moveNext();)listItem=replyEnumerator.get_current(),body=listItem.get_item("Body")!=null?listItem.get_item("Body").replace(/<.*?>/g,"").length>discussionRequest.PreviewCount?listItem.get_item("Body").replace(/<.*?>/g,"").substring(0,discussionRequest.PreviewCount)+"...":listItem.get_item("Body").replace(/<.*?>/g,""):null,author=listItem.get_item("Author").get_lookupValue(),userId=listItem.get_item("Author").get_lookupId();discussionShared.getUser(userId,discussionItem,discussionRequest,hostUrl,data.Hosted,me.discussionRequest.SubSite).then(function(user,discussionItem,discussionRequest){var discussionPostDate=new Date(discussionItem.get_item("DiscussionLastUpdated")),itemDiscussion;count=count+1;itemDiscussion={AuthorPicture:user.itemAt(0).get_item("Picture")!=null?hostUrl+"/_layouts/15/userphoto.aspx?size=L&url="+user.itemAt(0).get_item("Picture").get_url():__getTemplatePrefix()+"/Style Library/DigitalWorkplace/images/anonymous-user.png",DisplayAvatarPicture:discussionRequest.DisplayAvatar,Author:author,EditDiscussionPost:DiscussionThreadPageUrl+"?DiscussionId="+discussionItem.get_item("ID"),Title:discussionItem.get_item("Title").length>discussionRequest.TitleCount?discussionItem.get_item("Title").substring(0,discussionRequest.TitleCount)+"...":discussionItem.get_item("Title"),Body:body,Id:discussionItem.get_item("ID"),DisplayPostDate:discussionPostDate.format("MMM. dd,yyyy")};data.Items.push(itemDiscussion);totalItems==count&&discussionSummaryBlock.prototype.render(displayTemplate,data)},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("An error occured while retrieving libraries:"+args.get_message())})},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("An error occured while retrieving libraries:"+args.get_message())}):(userId=listItem.get_item("Author").get_lookupId(),discussionShared.getUser(userId,listItem,properties,hostUrl,data.Hosted).then(function(user,discussionItem,discussionRequest){count=count+1;var discussionPostDate=new Date(discussionItem.get_item("DiscussionLastUpdated")),itemDiscussion={AuthorPicture:user.itemAt(0).get_item("Picture")!=null?hostUrl+"/_layouts/15/userphoto.aspx?size=L&url="+user.itemAt(0).get_item("Picture").get_url():__getTemplatePrefix()+"/Style Library/DigitalWorkplace/images/anonymous-user.png",DisplayAvatarPicture:discussionRequest.DisplayAvatar,Author:discussionItem.get_item("Author").get_lookupValue(),EditDiscussionPost:DiscussionThreadPageUrl+"?DiscussionId="+discussionItem.get_item("ID"),Title:discussionItem.get_item("Title").length>discussionRequest.TitleCount?discussionItem.get_item("Title").substring(0,discussionRequest.TitleCount)+"...":discussionItem.get_item("Title"),Body:discussionItem.get_item("Body")!=null?discussionItem.get_item("Body").replace(/<.*?>/g,"").length>discussionRequest.PreviewCount?discussionItem.get_item("Body").replace(/<.*?>/g,"").substring(0,discussionRequest.PreviewCount)+"...":discussionItem.get_item("Body").replace(/<.*?>/g,""):null,Id:discussionItem.get_item("ID"),DisplayPostDate:discussionPostDate.format("MMM. dd,yyyy")};data.Items.push(itemDiscussion);totalItems==count&&discussionSummaryBlock.prototype.render(displayTemplate,data)},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("An error occured while retrieving libraries:"+args.get_message())}))},discussionSummaryBlock.prototype.error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},discussionSummaryBlock.prototype.render=function(templateUri,data){$.ajax(templateUri).done(function(template){var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){if(data.Hosted)$("body").html(data.Html),AKSenderData.options={DisplayAvatar:data.DisplayAvatar},AKNotifyParent(data.SenderId);else{$("#"+data.SenderId).html(data.Html);var discussionOptions={UniqueId:data.SenderId,Hosted:data.Hosted,options:{dataJSON:{},DisplayAvatar:data.DisplayAvatar}},iaDiscussionSummary=new Akumina.AppParts.DiscussionSummary(discussionOptions)}})},discussionSummaryBlock}();AddIn.discussionSummaryBlock=discussionSummaryBlock})(AddIn=Akumina.AddIn||(Akumina.AddIn={}))}(Akumina||(Akumina={}));Akumina===undefined&&(Akumina={});Akumina.AppParts===undefined&&(Akumina.AppParts={});Akumina.AppParts.DiscussionSummary===undefined&&(Akumina.AppParts.DiscussionSummary=function(options){var me=this;this.Init=function(options){var me=this,senderId,webPartIframe;this.uniqueId=options.UniqueId;this.targetDiv="."+this.uniqueId;this.Hosted=options.Hosted||options.apppart;senderId=this.uniqueId;this.Hosted==!0?(webPartIframe=$("iframe[src*='SenderId%3D"+senderId+"']"),webPartIframe.length==0&&(webPartIframe=$("iframe[src*='SenderId%253D"+senderId+"']")),this.targetDiv="#"+$(webPartIframe).parents(".ms-WPBody").attr("id")+" .interAction"):this.targetDiv="#"+this.uniqueId+" .interAction";options.options.DisplayAvatar=="true"&&$(this.targetDiv).find(".ia-discussion-author-icon img").show()};this.Init(options)});__extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},function(Akumina){var AddIn;(function(AddIn){var discussionResponse=function(){function discussionResponse(){this.Showdiscussion=!0}return discussionResponse}(),discussionRequest,discussionThreadBlock;AddIn.discussionResponse=discussionResponse;discussionRequest=function(_super){function discussionRequest(){_super.apply(this,arguments)}return __extends(discussionRequest,_super),discussionRequest}(AddIn.BaseRequest);AddIn.discussionRequest=discussionRequest;discussionThreadBlock=function(){function discussionThreadBlock(discussionThreadRequest){this.appWebUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPAppWebUrl",""));this.hostUrl=decodeURIComponent(Akumina.AddIn.Utilities.getQueryStringParameter("SPHostUrl",""));this.discussionRequest=discussionThreadRequest;this.discussionRequest.EditMode=Akumina.AddIn.Utilities.getEditMode()}return discussionThreadBlock.prototype.renderdiscussion=function(){var discussionID,discussionOptions,iaDiscussionThread,context,web,parentContext;this.discussionRequest.EditMode||(discussionID=this.getDiscussionID(),this.discussionRequest.Hosted||(discussionOptions={UniqueId:this.discussionRequest.SenderId,Hosted:this.discussionRequest.Hosted,options:{showspinner:!0,isValidThreadID:discussionID==""?!1:!0,DisplayAvatar:this.discussionRequest.DisplayAvatar,dataJSON:{},discussionlistingpageurl:this.discussionRequest.DiscussionListingUrl,approoturl:{}}},iaDiscussionThread=new Akumina.AppParts.DiscussionThread(discussionOptions)),discussionID!="")&&(context=new SP.ClientContext.get_current,this.discussionRequest.Hosted?(parentContext=new SP.AppContextSite(context,this.hostUrl),web=parentContext.get_web()):web=context.get_web(),context.load(web,"EffectiveBasePermissions"),Akumina.AddIn.Logger.logSPCall("discussionThreadBlock.prototype.renderdiscussion"),context.executeQueryAsync(Function.createDelegate(this,function(){this.managePermissions=web.get_effectiveBasePermissions().has(SP.PermissionKind.managePermissions);var list=web.get_lists().getByTitle(this.discussionRequest.ListName),camlQuery=new SP.CamlQuery,query="<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+discussionID+" <\/Value><\/Eq><\/Where><\/Query><\/View>";camlQuery.set_viewXml(query);this.listItems=list.getItems(camlQuery);context.load(this.listItems,"Include("+Akumina.AddIn.Configuration.getSelectFields("DiscussionBoard").join()+",AttachmentFiles,AttachmentLinks)");Akumina.AddIn.Logger.logSPCall("discussionThreadBlock.prototype.renderdiscussion");context.executeQueryAsync(Function.createDelegate(this,this.success),Function.createDelegate(this,this.error))}),Function.createDelegate(this,this.error)))},discussionThreadBlock.prototype.success=function(){var me=this,discussionShared=new Akumina.AddIn.discussionShared,listEnumerator=this.listItems.getEnumerator(),data=new discussionResponse,utils=Akumina.AddIn.Utilities,DiscussionThreadPageUrl=this.discussionRequest.DiscussionThreadUrl;data.SenderId=this.discussionRequest.SenderId;data.WebPartTitle=this.discussionRequest.Title;data.DiscussionCreatePageUrl=this.discussionRequest.DiscussionCreateUrl;data.DisplayAvatar=this.discussionRequest.DisplayAvatar;data.ListName=this.discussionRequest.ListName;data.LibraryName=this.discussionRequest.DocumentListName;data.DiscussionListingPageUrl=this.discussionRequest.DiscussionListingUrl;data.Hosted=this.discussionRequest.Hosted;this.discussionRequest.Hosted&&utils.IsNullOrEmpty(this.discussionRequest.DisplayTemplateUrl)&&(this.discussionRequest.DisplayTemplateUrl="/Content/Templates/DiscussionBoardThread/Default.html");data.DisplayTemplate=this.appWebUrl+this.discussionRequest.DisplayTemplateUrl;var totalItems=this.listItems.get_count(),hostUrl=this.hostUrl,appWebUrl=this.appWebUrl,properties=this.discussionRequest,adminPermission=!1;this.GetCurrentUsername().then(function(currentUser,collListItem){for(var listItem,userId,count;listEnumerator.moveNext();)listItem=listEnumerator.get_current(),userId=listItem.get_item("Author").get_lookupId(),discussionShared.getUser(userId,listItem,discussionRequest,hostUrl,data.Hosted).then(function(user,discussionItem){me.getAttachments(discussionItem,user).then(function(attachmentsModel){var discussionCreatedPostDate=new Date(attachmentsModel.replyItem.get_item("Created")),permissions,totalreplies;data.AuthorPicture=attachmentsModel.user.itemAt(0).get_item("Picture")!=null?hostUrl+"/_layouts/15/userphoto.aspx?size=L&url="+attachmentsModel.user.itemAt(0).get_item("Picture").get_url():__getTemplatePrefix()+"/Style Library/DigitalWorkplace/images/anonymous-user.png";data.Author=attachmentsModel.replyItem.get_item("Author").get_lookupValue();data.Title=attachmentsModel.replyItem.get_item("Title");data.Body=attachmentsModel.replyItem.get_item("Body")==null||!attachmentsModel.replyItem.get_item("Body")?null:attachmentsModel.replyItem.get_item("Body").replace(/<.*?>/g,"");data.ID=attachmentsModel.replyItem.get_item("ID");data.DisplayPostDate=discussionCreatedPostDate.format("MMM. dd;yyyy");permissions=me.checkpermissions(currentUser,attachmentsModel.replyItem.get_item("Author").get_lookupId(),attachmentsModel.replyItem);data.HasAdminPermission=permissions.siteAdmin;adminPermission=permissions;data.ThreadAdmin=permissions.threadAdmin;data.HasAddPermission=discussionItem.get_effectiveBasePermissions().has(SP.PermissionKind.editListItems)==!0;data.CurrentUserPicture=collListItem.itemAt(0).get_item("Picture")!=null?hostUrl+"/_layouts/15/userphoto.aspx?size=L&url="+collListItem.itemAt(0).get_item("Picture").get_url():__getTemplatePrefix()+"/Style Library/DigitalWorkplace/images/anonymous-user.png";data.Attachments=attachmentsModel.attachments;data.HasAttachments=attachmentsModel.attachments.length>0?!0:!1;totalreplies=attachmentsModel.replyItem.get_item("ItemChildCount");totalreplies==0&&discussionThreadBlock.prototype.preparerender(data.DisplayTemplate,data)})});count=0;totalItems>0&&me.listItems.itemAt(0).get_item("ItemChildCount")>0&&(data.Items=[],discussionShared.getReplies(me.listItems.itemAt(0),properties,hostUrl,"",data.Hosted).then(function(itemReply,discussionItem,discussionRequest){for(var replyEnumerator=itemReply.getEnumerator(),totalreplies=itemReply.get_count(),replyItem,userId;replyEnumerator.moveNext();)replyItem=replyEnumerator.get_current(),userId=replyItem.get_item("Author").get_lookupId(),discussionShared.getUser(userId,replyItem,discussionRequest,hostUrl,data.Hosted).then(function(user,replyItem){me.getAttachments(replyItem,user).then(function(attachmentsModel){var author=attachmentsModel.replyItem.get_item("Author").get_lookupValue(),discussionCreatedPostDate=new Date(attachmentsModel.replyItem.get_item("Created")),itemDiscussion={AuthorPicture:attachmentsModel.user.itemAt(0).get_item("Picture")!=null?hostUrl+"/_layouts/15/userphoto.aspx?size=L&url="+attachmentsModel.user.itemAt(0).get_item("Picture").get_url():__getTemplatePrefix()+"/Style Library/DigitalWorkplace/images/anonymous-user.png",Author:author,Title:attachmentsModel.replyItem.get_item("Title"),Body:attachmentsModel.replyItem.get_item("Body"),ID:attachmentsModel.replyItem.get_item("ID"),Attachments:attachmentsModel.attachments,HasAttachments:attachmentsModel.attachments.length>0?!0:!1,DisplayPostDate:discussionCreatedPostDate.format("MMM. dd,yyyy"),ThreadAdmin:adminPermission.siteAdmin||adminPermission.threadAdmin};count=count+1;data.Items.push(itemDiscussion);totalreplies==count&&discussionThreadBlock.prototype.preparerender(data.DisplayTemplate,data)})})}))},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message())})},discussionThreadBlock.prototype.GetCurrentUsername=function(){var def=$.Deferred(),me=this,ctxt=new SP.ClientContext.get_current,web,parentContext;return this.discussionRequest.Hosted?(parentContext=new SP.AppContextSite(ctxt,this.hostUrl),web=parentContext.get_web()):web=ctxt.get_web(),me.currentUser=web.get_currentUser(),me.userInfoList=web.get_siteUserInfoList(),ctxt.load(me.currentUser),Akumina.AddIn.Logger.logSPCall("discussionThreadBlock.prototype.GetCurrentUsername"),ctxt.executeQueryAsync(Function.createDelegate(me,function(){var camlQuery=new SP.CamlQuery,collListItem;camlQuery.set_viewXml("<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+me.currentUser.get_id()+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>");collListItem=me.userInfoList.getItems(camlQuery);ctxt.load(collListItem);Akumina.AddIn.Logger.logSPCall("discussionThreadBlock.prototype.GetCurrentUsername");ctxt.executeQueryAsync(Function.createDelegate(this,function(){def.resolve(me.currentUser,collListItem)}),Function.createDelegate(this,function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message());def.reject(sender,args)}))}),Function.createDelegate(me,function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message());def.reject(sender,args)})),def},discussionThreadBlock.prototype.getAttachments=function(replyItem,user){var attachments=replyItem.get_item("AttachmentLinks"),def=$.Deferred(),attachmentsModel={replyItem:replyItem,user:user,attachments:[]},context=new SP.ClientContext.get_current,web,parentContext,i,listName,itemID;if(this.discussionRequest.Hosted?(parentContext=new SP.AppContextSite(context,this.hostUrl),web=parentContext.get_web()):web=context.get_web(),attachments&&attachments!=null&&attachments.toString().trim()!="")for(attachments=attachments.split("|"),i=0;i<attachments.length;i++)listName=attachments[i].split(":")[0],itemID=attachments[i].split(":")[1],discussionThreadBlock.prototype.getItemsFromList(context,web,listName,itemID,i,attachments.length-1,def,attachmentsModel);else def.resolve(attachmentsModel);return def.promise()},discussionThreadBlock.prototype.getItemsFromList=function(context,web,listName,itemID,i,length,def,attachmentsModel){var list=web.get_lists().getByTitle(listName),item=list.getItemById(itemID),file=item.get_file();context.load(file);Akumina.AddIn.Logger.logSPCall("discussionThreadBlock.prototype.getItemsFromList");context.executeQueryAsync(Function.createDelegate(this,function(){var fileName=file.get_name(),url=file.get_serverRelativeUrl();attachmentsModel.attachments.push({Title:fileName,Url:url});i==length&&def.resolve(attachmentsModel)}),Function.createDelegate(this,function(){Akumina.AddIn.Logger.WriteErrorLog("Error in getItemsFromsList");i==length&&def.resolve(attachmentsModel)}))},discussionThreadBlock.prototype.preparerender=function(displayTemplate,data){data.Items&&data.Items.length>0&&(data.Items=this.sortItems(data.Items,"ID","ASC"));discussionThreadBlock.prototype.render(displayTemplate,data)},discussionThreadBlock.prototype.error=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},discussionThreadBlock.prototype.sortItems=function(items,field,ascending){return ascending=="ASC"?items.sort(function(a,b){return a[field]-b[field]}):items.sort(function(a,b){return b[field]-a[field]})},discussionThreadBlock.prototype.checkpermissions=function(user,itemUserID){var permissions={threadAdmin:!1,siteAdmin:!1},managePermissions;return user.get_id()==itemUserID&&(permissions.threadAdmin=!0),managePermissions=this.managePermissions,(user.get_title()=="System Account"||user.get_isSiteAdmin()==!0||managePermissions==!0)&&(permissions.siteAdmin=!0,permissions.threadAdmin=!0),permissions},discussionThreadBlock.prototype.getDiscussionID=function(){var url=$("link[rel='canonical']").attr("href"),params=url.split("?")[1],i,singleParam;if(params)for(params=params.split("&"),i=0;i<params.length;i=i+1)if(singleParam=params[i].split("="),singleParam[0]==="DiscussionId")return decodeURIComponent(singleParam[1]);return""},discussionThreadBlock.prototype.render=function(templateUri,data){$.ajax(templateUri).done(function(template){var hbstemplate=Handlebars.compile(template);data.Html=hbstemplate(data)}).always(function(){if(data.Hosted)$("body").html(data.Html),AKSenderData.options={discussionlistingpageurl:data.DiscussionListingPageUrl,approoturl:document.location.protocol+"//"+document.location.hostname+(document.location.port!=""?":"+document.location.port:"")+"/"},AKNotifyParent(data.SenderId);else{$("#"+data.SenderId).html(data.Html);var discussionOptions={UniqueId:data.SenderId,Hosted:data.Hosted,options:{showspinner:!1,DisplayAvatar:data.DisplayAvatar,dataJSON:{},discussionlistingpageurl:data.DiscussionListingPageUrl,approoturl:{}}},iaDiscussionThread=new Akumina.AppParts.DiscussionThread(discussionOptions)}})},discussionThreadBlock}();AddIn.discussionThreadBlock=discussionThreadBlock})(AddIn=Akumina.AddIn||(Akumina.AddIn={}))}(Akumina||(Akumina={}));Akumina===undefined&&(Akumina={});Akumina.AppParts===undefined&&(Akumina.AppParts={});Akumina.AppParts.CreateNewDiscussion===undefined&&(Akumina.AppParts.CreateNewDiscussion=function(options){var me=this;this.Init=function(options){var me,senderId,webPartIframe;this.HideOverlay();me=this;this.uniqueId=options.UniqueId;this.targetDiv="."+this.uniqueId;this.resultTemplateJson=options.options.dataJSON;this.DiscussionListingPageUrl=options.options.discussionlistingpageurl;this.AppRootUrl=options.options.approoturl;this.Files=[];this.Groups=[];this.ItemId=0;this.libList="";this.Hosted=options.Hosted||options.apppart;senderId=this.uniqueId;this.Hosted==!0?(webPartIframe=$("iframe[src*='SenderId%3D"+senderId+"']"),webPartIframe.length==0&&(webPartIframe=$("iframe[src*='SenderId%253D"+senderId+"']")),this.targetDiv="#"+$(webPartIframe).parents(".ms-WPBody").attr("id")+" .interAction"):this.targetDiv="#"+this.uniqueId+" .interAction";commonDiscussionThreadListing();$(this.targetDiv+" .ia-modal-inline-trigger").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0});$(this.targetDiv+" .ia-modal-inline-trigger-preview").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!1,showCloseBtn:!0});$(document).on("click",this.targetDiv+" .ia-modal-dismiss",function(e){e.preventDefault();$.magnificPopup.close()});$(this.targetDiv+" #titleDiscussion").keypress(function(event){event.keyCode==13&&event.preventDefault()});$(me.targetDiv+" #bodyDiscussion").ckeditor();this.GetFolderTree();$(this.targetDiv+" #files_Addtemplate").html($(this.targetDiv+" #files_Addtemplate").html().replace(/{ {/g,"{{").replace(/} }/g,"}}"));$.ajax({type:"GET",url:_spPageContextInfo.webAbsoluteUrl+"/_api/Web/SiteGroups",dataType:"xml",success:function(xml){groupList=[];$(xml).find("entry").each(function(){var properties=$(this).find("content").children().first().children(),propValue;for(i=0;i<properties.length;i++)if(propValue=$(properties)[i],$(propValue).prop("tagName")=="d:Title"){groupList.push($(propValue).text());break}});groupList.length>0&&$.each(groupList,function(key,value){$(me.targetDiv+" #userAndUserGroups").append($("<option><\/option>").attr("value",key).text(value))})}});$("#userAndUserGroups").chosen({width:"95%"});setTimeout(function(){$(me.targetDiv+" .ia-search-picker").trigger("chosen:updated");$("#userAndUserGroups").chosen({width:"95%"})},1e3);$(this.targetDiv+" .ia-discussion-post").click({obj:me},function(event){var validationMsg=me.PostValidate();validationMsg.length>0?(me.ShowError(validationMsg.join(" ")),event.preventDefault()):(me.ShowOverlay(),me.PostDiscussion())});$(this.targetDiv+" #btncanConfirm").click({obj:me},function(){window.location.href=me.DiscussionListingPageUrl});$(this.targetDiv+" .ia-modal-dismiss").click({obj:me},function(){$.magnificPopup.close()})};this.PostValidate=function(){var validationMsg=[],title=$(me.targetDiv+" .ia-discussion-create-title").val(),specialCharacterIndex=title.search(/[~`!@#$%^&*()+=|\\{}':;.,<>/?[\]""_-]/i);return title==""&&validationMsg.push("*Title is required."),specialCharacterIndex>-1&&validationMsg.push("*Special Characters are not allowed in Discussion Title."),validationMsg};this.ShowOverlay=function(){$.magnificPopup.close();$(me.targetDiv+" .ia-loading-panel")&&$(me.targetDiv+" .ia-loading-panel").addClass("ia-show");$(me.targetDiv+" .ia-loading-panel").removeClass("ia-hide")};this.HideOverlay=function(){$(".ia-loading-panel")&&$(".ia-loading-panel").addClass("ia-hide");$(".ia-loading-panel").removeClass("ia-show")};this.PostDiscussion=function(){var titleVal=$(me.targetDiv+" .ia-discussion-create-title").val(),bodyVal=$(me.targetDiv+" #bodyDiscussion").val(),listVal=$(me.targetDiv+" #hdnListName").val(),libraryVal=$(me.targetDiv+" #hdnLibraryName").val(),groupsVal=[],filesVal=[],selectedGroups=$("ul.chosen-choices li.search-choice"),selectedFiles=$(me.targetDiv+" #listOfFilesHn").val().split("|"),groupVal,fileVal;for(i=0;i<selectedGroups.length;i++)groupVal=$($(selectedGroups)[i]).text(),groupsVal.push(groupVal);for(i=0;i<selectedFiles.length;i++)fileVal=selectedFiles[i],fileVal!=""&&filesVal.push(fileVal);me.CreateItem(titleVal,bodyVal,groupsVal,filesVal,listVal)};this.CreateItem=function(titleVal,bodyVal,groupsVal,filesVal,listVal){me.ListValue=listVal;me.AkuminaDiscussionBoardContentTypeId="";me.AttachmentLinks=filesVal.join("|");var clientContext=new SP.ClientContext,oList=clientContext.get_web().get_lists().getByTitle(listVal),itemCreateInfo=new SP.ListItemCreationInformation;me.ListContentTypes=oList.get_contentTypes();me.Groups=groupsVal;me.Files=filesVal;oListItem=SP.Utilities.Utility.createNewDiscussion(clientContext,oList,titleVal);oListItem.set_item("Title",titleVal);oListItem.set_item("Body",bodyVal);oListItem.update();clientContext.load(me.ListContentTypes);clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.CreateNewDiscussion.CreateItem");clientContext.executeQueryAsync(Function.createDelegate(me,me.OnAddSucceeded),Function.createDelegate(me,me.OnQueryFailed))};this.OnAddSucceeded=function(){var currentItem,contentTypeTitle;me.ItemId=oListItem.get_id();for(var clientContext=new SP.ClientContext,oList=clientContext.get_web().get_lists().getByTitle(me.ListValue),ContentTypeEnumerator=me.ListContentTypes.getEnumerator();ContentTypeEnumerator.moveNext();)if(currentItem=ContentTypeEnumerator.get_current(),contentTypeTitle=currentItem.get_name(),Akumina.AddIn.Logger.WriteInfoLog(contentTypeTitle),contentTypeTitle.toLowerCase()=="AkuminaDiscussionBoardContentType".toLowerCase()){me.AkuminaDiscussionBoardContentTypeId=currentItem.get_id();break}oListItem=oList.getItemById(me.ItemId);oListItem.set_item("ContentTypeId",me.AkuminaDiscussionBoardContentTypeId);oListItem.set_item("ConfirmArchive","false");oListItem.set_item("AttachmentLinks",me.AttachmentLinks);oListItem.update();clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.CreateNewDiscussion.OnAddSucceeded");clientContext.executeQueryAsync(Function.createDelegate(me,me.OnQuerySucceeded),Function.createDelegate(me,me.OnQueryFailed))};this.OnQuerySucceeded=function(){me.ItemId=oListItem.get_id();me.BreakSecurityInheritanceChangeUser()};this.OnQueryFailed=function(sender,args){me.ShowError("There was an error. "+args.get_message());me.HideOverlay()};this.BreakSecurityInheritanceChangeUser=function(){if(me.Groups.length>0){var listVal=$(me.targetDiv+" #hdnListName").val(),clientContext=new SP.ClientContext(_spPageContextInfo.webAbsoluteUrl),oList=clientContext.get_web().get_lists().getByTitle(listVal),oListItem=oList.getItemById(me.ItemId);for(oListItem.breakRoleInheritance(!1),i=0;i<me.Groups.length;i++){var groupName=me.Groups[i],oGroup=clientContext.get_web().get_siteGroups().getByName(groupName),collRoleDefinitionBinding=SP.RoleDefinitionBindingCollection.newObject(clientContext);collRoleDefinitionBinding.add(clientContext.get_web().get_roleDefinitions().getByType(SP.RoleType.administrator));oListItem.get_roleAssignments().add(oGroup,collRoleDefinitionBinding)}clientContext.load(oGroup);clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.CreateNewDiscussion.BreakSecurityInheritanceChangeUser");clientContext.executeQueryAsync(Function.createDelegate(me,me.onSecurityQuerySucceeded),Function.createDelegate(me,me.onSecurityQueryFailed))}else window.location.href=me.DiscussionListingPageUrl};this.onSecurityQuerySucceeded=function(){window.location.href=me.DiscussionListingPageUrl};this.onSecurityQueryFailed=function(sender,args){me.ShowError("There was an error assigning permissions. "+args.get_message());me.HideOverlay()};this.ShowError=function(msg){$(me.targetDiv+" #titleError").text(msg);$(me.targetDiv+" #titleError").show()};this.GetFolderTree=function(){var libraryVal=$(me.targetDiv+" #hdnLibraryName").val(),ctx=new SP.ClientContext.get_current,caml;me.oLibDocs=ctx.get_web().get_lists().getByTitle(libraryVal);caml=SP.CamlQuery.createAllItemsQuery();caml.set_viewXml("<View Scope='RecursiveAll'><Query><Where><Neq><FieldRef Name='ContentType' /><Value Type='Text'>Folder<\/Value><\/Neq><\/Where><OrderBy><FieldRef Name = 'FileLeafRef' Ascending = 'True'/><\/OrderBy><\/Query><\/View>");me.allDocumentsCol=me.oLibDocs.getItems(caml);ctx.load(me.oLibDocs);ctx.load(me.oLibDocs.get_rootFolder());ctx.load(me.allDocumentsCol,"Include(FileLeafRef, ServerUrl, Id, Title, DocIcon)");Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.CreateNewDiscussion.GetFolderTree");ctx.executeQueryAsync(Function.createDelegate(this,me.onTreeSucceededCallback),Function.createDelegate(this,me.onTreeFailedCallback))};this.onTreeSucceededCallback=function(){for(var libraryName=me.oLibDocs.get_title(),libraryUrl=me.oLibDocs.get_rootFolder().get_serverRelativeUrl(),ListEnumerator=me.allDocumentsCol.getEnumerator(),rootFolder={Name:libraryName,Folders:[],Files:[]},currentItemIconUrl,itemDetails,html;ListEnumerator.moveNext();){var currentItem=ListEnumerator.get_current(),currentItemId=currentItem.get_id(),currentItemName=currentItem.get_fieldValues().Title;currentItemName==null&&(currentItemName=currentItem.get_item("FileLeafRef"));var currentItemURL=currentItem.get_item("ServerUrl"),currentItemIconVal=currentItem.get_item("DocIcon"),currentItemIconExt="gif";switch(currentItemIconVal){case"txt":case"png":case"gif":case"jpg":case"zip":currentItemIconExt="gif";break;default:currentItemIconExt="png"}var siteName=this.GetSiteName(),folderUrl=this.getFolderURL(currentItemURL.replace(siteName,"")),pathTokens=currentItemURL.replace(siteName,"").replace("Shared Documents","Documents").split("/");pathTokens=pathTokens.splice(1,pathTokens.length-1);currentItemIconUrl=_spPageContextInfo.webServerRelativeUrl+"/_layouts/15/images/ic"+currentItemIconVal+"."+currentItemIconExt;itemDetails={currentItemId:currentItemId,currentItemName:currentItemName,currentItemIconUrl:currentItemIconUrl,currentItemURL:currentItemURL,listName:libraryName,folderUrl:folderUrl};this.createFolderStructure(rootFolder,pathTokens,1,itemDetails)}html=this.traverseFolder(rootFolder);$(me.targetDiv+" .ia-folder-tree").html(html);this.bindFolderTreeItemClickEvent()};this.bindFolderTreeItemClickEvent=function(){$(me.targetDiv+" .ia-folder-tree").on("changed.jstree",function(e,data){if(data.selected.length>1)$(".ia-folder-tree").jstree("deselect_all");else if(data.selected.length==1){var isfolder=$("#"+data.node.id).attr("isfolder");isfolder=="1"&&$(".ia-folder-tree").jstree("deselect_all")}}).jstree()};this.onTreeFailedCallback=function(){};this.GetSiteName=function(){return _spPageContextInfo.webServerRelativeUrl=="/"?"":_spPageContextInfo.webServerRelativeUrl};this.getFolderURL=function(currentItemURL){var folderURL=currentItemURL.split("/");return folderURL.splice(0,folderURL.length-1).join("/")};this.createFolderStructure=function(currentFolder,pathTokens,idxToken,itemDetails){var currentToken=pathTokens[idxToken],isLastToken=pathTokens.length-1==idxToken,subFolder;isLastToken?currentFolder.Files.push(itemDetails):(subFolder=this.getSubFolder(currentFolder,pathTokens[idxToken]),subFolder==null&&(subFolder=this.createSubFolder(currentFolder,pathTokens[idxToken],itemDetails)),this.createFolderStructure(subFolder,pathTokens,idxToken+1,itemDetails))};this.createSubFolder=function(currentFolder,name,itemDetails){var subFolder={Name:name,currentItemId:itemDetails.currentItemId,folderUrl:itemDetails.folderUrl,Folders:[],Files:[]};return currentFolder.Folders.push(subFolder),subFolder};this.getSubFolder=function(currentFolder,name){for(var i=0;i<currentFolder.Folders.length;i++)if(currentFolder.Folders[i].Name==name)return currentFolder.Folders[i];return null};this.traverseFolder=function(rootFolder){for(var html="<ul><li isfolder='1' title='"+rootFolder.Name+"' url-data='"+rootFolder.folderUrl+"' item-id='"+rootFolder.currentItemId+"' list-name='"+rootFolder.Name+"'>"+rootFolder.Name,i=0;i<rootFolder.Folders.length;i++)html+=this.traverseFolder(rootFolder.Folders[i]);for(html+="<ul>",i=0;i<rootFolder.Files.length;i++)html+="<li isfolder='0' data-jstree='{\"icon\":\"ia-hide-folder-icon\"}' title='"+rootFolder.Files[i].currentItemName+"' item-id='"+rootFolder.Files[i].currentItemId+"' list-name='"+rootFolder.Files[i].listName+"' url-data='"+rootFolder.Files[i].currentItemURL+"'><img src='"+rootFolder.Files[i].currentItemIconUrl+"' class='ia-folder-tree-icon'/> <span title='"+rootFolder.Files[i].currentItemName+"'>"+rootFolder.Files[i].currentItemName+"<\/span><\/li>";return html+="<\/ul>",html+"<\/li><\/ul>"};this.Init(options)});Akumina===undefined&&(Akumina={});Akumina.AppParts===undefined&&(Akumina.AppParts={});Akumina.AppParts.DiscussionBoard===undefined&&(Akumina.AppParts.DiscussionBoard=function(options){var me=this;me.Hosted=options.Hosted;me.DiscussionListingPageUrl=options.options.DiscussionListingPageUrl;this.Init=function(options){var me=this,senderId,webPartIframe;if(this.uniqueId=options.UniqueId,this.targetDiv="."+this.uniqueId,this.resultTemplateJson=options.options.dataJSON,this.DiscussionListingPageUrl=options.options.DiscussionListingPageUrl,this.Hosted=options.Hosted||options.apppart,senderId=this.uniqueId,this.Hosted==!0?(webPartIframe=$("iframe[src*='SenderId%3D"+senderId+"']"),webPartIframe.length==0&&(webPartIframe=$("iframe[src*='SenderId%253D"+senderId+"']")),this.targetDiv="#"+$(webPartIframe).parents(".ms-WPBody").attr("id")+" .interAction"):this.targetDiv="#"+this.uniqueId+" .interAction",options.options.showspinner==!0){this.ShowOverlay();return}this.HideOverlay();commonDiscussionThreadListing();var pageValue=1,columnValue="Created",sortOrderValue="DESC",totalPageValue=parseInt($(this.targetDiv).find("input[name$='hdnTotalPageValue']").val());options.options.DisplayAvatar=="true"?$(this.targetDiv).find(".ia-discussion-author-icon img").show():$(this.targetDiv).find(".ia-discussion-board-table-headers .ia-discussion-author-icon").remove();$(this.targetDiv).find("input[name$='hdnPageValue']").length==0?$(me.targetDiv+" .ia-discussion-board-list").append("<input type='hidden' name='hdnPageValue' value='"+pageValue+"'/>"):pageValue=parseInt($(this.targetDiv).find("input[name$='hdnPageValue']").val());$(this.targetDiv).find("input[name$='hdnColumnValue']").length==0?$(me.targetDiv+" .ia-discussion-board-list").append("<input type='hidden' name='hdnColumnValue' value='"+columnValue+"'/>"):columnValue=$(this.targetDiv).find("input[name$='hdnColumnValue']").val();$(this.targetDiv).find("input[name$='hdnSortOrderValue']").length==0?$(me.targetDiv+" .ia-discussion-board-list").append("<input type='hidden' name='hdnSortOrderValue' value='"+sortOrderValue+"'/>"):sortOrderValue=$(this.targetDiv).find("input[name$='hdnSortOrderValue']").val();$(this.targetDiv+" .ia-modal-inline-trigger").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0});$(this.targetDiv+" .ia-modal-inline-trigger-preview").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!1,showCloseBtn:!0});$(document).on("click",this.targetDiv+" .ia-modal-dismiss",function(e){e.preventDefault();$.magnificPopup.close()});pageValue==1?($(this.targetDiv+" #iafirstpage").removeAttr("class").attr("class","ia-paging-first ia-paging-disabled"),$(this.targetDiv+" #iapreviouspage").removeAttr("class").attr("class","ia-paging-previous ia-paging-disabled")):pageValue==totalPageValue?($(this.targetDiv+" #ianextpage").removeAttr("class").attr("class","ia-paging-next ia-paging-disabled"),$(this.targetDiv+" #ialastpage").removeAttr("class").attr("class","ia-paging-last ia-paging-disabled")):($(this.targetDiv+" #iafirstpage").removeAttr("class").attr("class","ia-paging-first"),$(this.targetDiv+" #iapreviouspage").removeAttr("class").attr("class","ia-paging-previous"),$(this.targetDiv+" #ianextpage").removeAttr("class").attr("class","ia-paging-next"),$(this.targetDiv+" #ialastpage").removeAttr("class").attr("class","ia-paging-last"));columnValue=="Created"?(sortOrderValue=="ASC"?$(this.targetDiv+" [id$=linkSortCreated]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-desc ia-sort-desc"):$(this.targetDiv+" [id$=linkSortCreated]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-asc ia-sort-asc"),$(this.targetDiv+" [id$=linkSortPostTime]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off"),$(this.targetDiv+" [id$=linkSortReplies]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off")):columnValue=="DiscussionLastUpdated"?(sortOrderValue=="ASC"?$(this.targetDiv+" [id$=linkSortPostTime]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-desc ia-sort-desc"):$(this.targetDiv+" [id$=linkSortPostTime]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-asc ia-sort-asc"),$(this.targetDiv+" [id$=linkSortCreated]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off"),$(this.targetDiv+" [id$=linkSortReplies]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off")):columnValue=="ItemChildCount"&&(sortOrderValue=="ASC"?$(this.targetDiv+" [id$=linkSortReplies]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-desc ia-sort-desc"):$(this.targetDiv+" [id$=linkSortReplies]").removeAttr("class").addClass("ia-sort-icon fa fa-sort-asc ia-sort-asc"),$(this.targetDiv+" [id$=linkSortCreated]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off"),$(this.targetDiv+" [id$=linkSortPostTime]").removeAttr("class").attr("class","ia-sort-icon fa fa-sort ia-sort-off"));$(this.targetDiv+" .ia-discussion-archive-btn").click({obj:me},function(){var idValue=$(this).data("id");$(me.targetDiv+" #hdnActionId").val(idValue)});$(this.targetDiv+" #btnarcConfirm").click({obj:me},function(){var idValue=$(me.targetDiv+" #hdnActionId").val();me.Archive(idValue)});$(this.targetDiv+" .ia-discussion-delete-btn").click({obj:me},function(){var idValue=$(this).data("id");$(me.targetDiv+" #hdnActionId").val(idValue)});$(this.targetDiv+" #btndelConfirm").click({obj:me},function(){var idValue=$(me.targetDiv+" #hdnActionId").val();me.Delete(idValue)});$(this.targetDiv+" .ia-discussion-board-table-headers a").click({obj:me},function(){var sortValue=$(this).data("sort");me.Sort(sortValue)});$(this.targetDiv+" .ia-paging-first a").click({obj:me},function(){me.FirstPage()});$(this.targetDiv+" .ia-paging-previous a").click({obj:me},function(){me.PreviousPage()});$(this.targetDiv+" .ia-paging-next a").click({obj:me},function(){me.NextPage()});$(this.targetDiv+" .ia-paging-last a").click({obj:me},function(){me.LastPage()})};this.ShowOverlay=function(){$.magnificPopup.close();$(me.targetDiv).length==0&&$("#"+this.uniqueId).html('<div class="interAction"><h1>Loading...<\/h1><div class="ia-loading-panel ia-hide"><div class="ia-loader"><\/div><\/div><\/div>');$(me.targetDiv+" .ia-loading-panel")&&$(me.targetDiv+" .ia-loading-panel").addClass("ia-show");$(me.targetDiv+" .ia-loading-panel").removeClass("ia-hide")};this.HideOverlay=function(){$(".ia-loading-panel")&&$(".ia-loading-panel").addClass("ia-hide");$(".ia-loading-panel").removeClass("ia-show")};this.Archive=function(idValue){var listValue=$(me.targetDiv+" #hdnListName").val(),clientContext=new SP.ClientContext,oList=clientContext.get_web().get_lists().getByTitle(listValue),oListItem=oList.getItemById(idValue);oListItem.set_item("ConfirmArchive","true");oListItem.update();Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionBoard.Archive");clientContext.executeQueryAsync(Function.createDelegate(me,me.onQuerySucceeded),Function.createDelegate(me,me.onQueryFailed))};this.Delete=function(idValue){var listValue=$(me.targetDiv+" #hdnListName").val(),clientContext=new SP.ClientContext,oList=clientContext.get_web().get_lists().getByTitle(listValue),oListItem=oList.getItemById(idValue);oListItem.deleteObject();Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionBoard.Delete");clientContext.executeQueryAsync(Function.createDelegate(me,me.onQuerySucceeded),Function.createDelegate(me,me.onQueryFailed))};this.onQuerySucceeded=function(){me.UpdateView();$.magnificPopup.close()};this.onQueryFailed=function(sender,args){me.HideOverlay();Akumina.AddIn.Logger.WriteErrorLog("There was an error. "+args.get_message())};this.FirstPage=function(){var pageField=$(me.targetDiv).find("input[name$='hdnPageValue']"),oldValue=parseInt($(pageField).val()),newValue;oldValue>1&&(newValue=1,$(pageField).val(newValue),me.UpdateView())};this.PreviousPage=function(){var pageField,oldValue,newValue;$(me.targetDiv).find("input[name$='hdnActionPagination']").val($(me.targetDiv).find("input[name$='previousPagingInfo']").val());pageField=$(me.targetDiv).find("input[name$='hdnPageValue']");oldValue=parseInt($(pageField).val());oldValue>1&&(newValue=oldValue-1,$(pageField).val(newValue),me.UpdateView())};this.NextPage=function(){var newValue;$(me.targetDiv).find("input[name$='hdnActionPagination']").val($(me.targetDiv).find("input[name$='nextPagingInfo']").val());var pageField=$(me.targetDiv).find("input[name$='hdnPageValue']"),oldValue=parseInt($(pageField).val()),totalPageField=$(me.targetDiv).find("input[name$='hdnTotalPageValue']"),totalPageValue=parseInt($(totalPageField).val());oldValue<totalPageValue&&(newValue=oldValue+1,$(pageField).val(newValue),me.UpdateView())};this.LastPage=function(){var firstIndex=$(me.targetDiv).find("input[name$='LastIndexID']").val(),newValue;$(me.targetDiv).find("input[name$='hdnActionPagination']").val("Paged=TRUE&p_ID="+firstIndex);var pageField=$(me.targetDiv).find("input[name$='hdnPageValue']"),oldValue=parseInt($(pageField).val()),totalPageField=$(me.targetDiv).find("input[name$='hdnTotalPageValue']"),totalPageValue=parseInt($(totalPageField).val());oldValue<totalPageValue&&(newValue=totalPageValue,$(pageField).val(newValue),me.UpdateView())};this.UpdateView=function(){var redirectUrl;this.ShowOverlay();var pageField=$(me.targetDiv).find("input[name$='hdnPageValue']"),columnField=$(me.targetDiv).find("input[name$='hdnColumnValue']"),sortOrderField=$(me.targetDiv).find("input[name$='hdnSortOrderValue']"),pagingInfo=$(me.targetDiv).find("input[name$='hdnActionPagination']").val(),pageValue=$(pageField).val(),columnValue=$(columnField).val(),sortOrderValue=$(sortOrderField).val();if(me.Hosted){var iframeObj=document.getElementById($(me.targetDiv).parent().find("iframe").attr("id")),iframeUrl=iframeObj.src,redirectUrl=decodeURIComponent(getquerystringparam(iframeUrl,"redirect_uri",""));redirectUrl=this.UpdateQueryStringParam(redirectUrl,"pg",pageValue);redirectUrl=this.UpdateQueryStringParam(redirectUrl,"col",columnValue);redirectUrl=this.UpdateQueryStringParam(redirectUrl,"sort",sortOrderValue);redirectUrl=this.UpdateQueryStringParam(redirectUrl,"p_ID",this.getQueryStringParameterFromString(pagingInfo,"p_ID",""));redirectUrl=this.UpdateQueryStringParam(redirectUrl,"Paged",this.getQueryStringParameterFromString(pagingInfo,"Paged",""));redirectUrl=this.UpdateQueryStringParam(redirectUrl,"PagedPrev",this.getQueryStringParameterFromString(pagingInfo,"PagedPrev",""));iframeUrl=updatequerystringparam(iframeUrl,"redirect_uri",encodeURIComponent(redirectUrl));iframeObj.src=iframeUrl}else redirectUrl=decodeURIComponent(me.DiscussionListingPageUrl),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"pg",pageValue),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"col",columnValue),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"sort",sortOrderValue),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"p_ID",this.getQueryStringParameterFromString(pagingInfo,"p_ID","")),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"Paged",this.getQueryStringParameterFromString(pagingInfo,"Paged","")),redirectUrl=this.UpdateQueryStringParam(redirectUrl,"PagedPrev",this.getQueryStringParameterFromString(pagingInfo,"PagedPrev","")),window.location.href=redirectUrl};this.Sort=function(sort){var columnField=$(me.targetDiv).find("input[name$='hdnColumnValue']"),sortOrderField=$(me.targetDiv).find("input[name$='hdnSortOrderValue']"),columnValue,sortOrderValue;$(me.targetDiv).find("input[name$='hdnActionPagination']").val($(me.targetDiv).find("input[name$='hdnOldActionPagination']").val());columnValue=$(columnField).val();sortOrderValue=$(sortOrderField).val();columnValue.toLowerCase()==sort.toLowerCase()?sortOrderValue.toLowerCase()=="desc"?$(sortOrderField).val("ASC"):$(sortOrderField).val("DESC"):($(columnField).val(sort),$(sortOrderField).val("DESC"));me.UpdateView()};this.UpdateQueryStringParam=function(uri,key,value){var re=new RegExp("([?&])"+key+"=.*?(&|$)","i"),separator=uri.indexOf("?")!==-1?"&":"?";return uri.match(re)?uri.replace(re,"$1"+key+"="+value+"$2"):uri+separator+key+"="+value};this.getQueryStringParameterFromString=function(url,paramToRetrieve,defaultValue){for(var singleParam,params=url.split("&"),i=0;i<params.length;i=i+1)if(singleParam=params[i].split("="),singleParam[0]===paramToRetrieve)return decodeURIComponent(singleParam[1]);return defaultValue};this.Init(options)});Akumina===undefined&&(Akumina={});Akumina.AppParts===undefined&&(Akumina.AppParts={});Akumina.AppParts.DiscussionThread===undefined&&(Akumina.AppParts.DiscussionThread=function(options){var me=this;me.pageIsFollowed=!1;this.Init=function(options){var me=this,senderId,webPartIframe;if(this.uniqueId=options.UniqueId,this.targetDiv="."+this.uniqueId,this.resultTemplateJson=options.options.dataJSON,this.DiscussionListingPageUrl=options.options.discussionlistingpageurl,this.AppRootUrl=options.options.approoturl,this.Files=[],this.Groups=[],this.ItemId=0,this.libList="",this.Hosted=options.Hosted||options.apppart,senderId=this.uniqueId,this.Hosted==!0?(webPartIframe=$("iframe[src*='SenderId%3D"+senderId+"']"),webPartIframe.length==0&&(webPartIframe=$("iframe[src*='SenderId%253D"+senderId+"']")),this.targetDiv="#"+$(webPartIframe).parents(".ms-WPBody").attr("id")+" .interAction"):this.targetDiv="#"+this.uniqueId+" .interAction",options.options.isValidThreadID==!1){$("#"+this.uniqueId).html('<div class="interAction"><div>Please specify a valid thread id.<\/div><\/div>');return}if(options.options.showspinner==!0){this.ShowOverlay();return}this.HideOverlay();options.options.DisplayAvatar=="true"?$(this.targetDiv).find(".ia-discussion-author-icon img").show():$(this.targetDiv).find(".ia-discussion-author-icon").remove();commonDiscussionThreadListing();$(this.targetDiv+" .ia-modal-inline-trigger").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!0,showCloseBtn:!0});$(this.targetDiv+" .ia-modal-inline-trigger-preview").magnificPopup({type:"inline",preloader:!1,closeBtnInside:!1,showCloseBtn:!0});$(me.targetDiv+" .ia-discussion-reply-content").on("focus","input[name='ia-discussion-add-reply-box']",function(){$(this).fadeOut("fast",function(){$(me.targetDiv+" .ia-discussion-reply-editor").fadeIn("fast")})});$(me.targetDiv+" #bodyDiscussion").ckeditor();this.GetFolderTree();$(this.targetDiv+" #files_Addtemplate").html($(this.targetDiv+" #files_Addtemplate").html().replace(/{ {/g,"{{").replace(/} }/g,"}}"));$.ajax({type:"GET",url:_spPageContextInfo.webAbsoluteUrl+"/_api/Web/SiteGroups",dataType:"xml",success:function(xml){groupList=[];try{$(xml).find("entry").each(function(){var properties=$(this).find("content").children().first().children(),value="",text="",propValue;for(i=0;i<properties.length;i++)propValue=$(properties)[i],$(propValue).prop("tagName")=="d:Id"&&(value=$(propValue).text()),$(propValue).prop("tagName")=="d:Title"&&(text=$(propValue).text());groupList.push({value:value,text:text})});groupList.length>0&&$.each(groupList,function(index,value){$(me.targetDiv+" #userAndUserGroups").append($("<option><\/option>").attr("value",value.value).text(value.text))})}catch(err){}}});$(this.targetDiv+" .ia-discussion-thread-permissions-btn").click({obj:me},function(){me.getPermissions();$(".ia-search-picker").trigger("chosen:updated")});$("#userAndUserGroups").chosen({width:"95%"});$(this.targetDiv+" #btnPermissions").click({obj:me},function(){me.BreakSecurityInheritanceChangeUser()});$(this.targetDiv+" .ia-action-menu-content li.addReplyToPost").click({obj:me},function(e){e.preventDefault();$(me.targetDiv+" input[name='ia-discussion-add-reply-box']").trigger("focus")});$(this.targetDiv+" #anchrFollow").click({obj:me},function(e){me.toggleFollow();e.preventDefault()});$(this.targetDiv+" #anchrFollowing").click({obj:me},function(e){me.toggleFollow();e.preventDefault()});$(this.targetDiv+" #anchrDeleteThread").click({obj:me},function(){me.DeleteThread()});$(this.targetDiv+" .ia-discussion-delete-btn").click({obj:me},function(){var replyId=$(this).data("replyid");$(me.targetDiv+" #hdnActionID").val(replyId)});$(this.targetDiv+" #anhrDeleteReply").click({obj:me},function(){me.DeleteReply()});$(this.targetDiv+" #anchrPostreply").click({obj:me},function(){me.ShowOverlay();me.PostReply()});$(this.targetDiv+" #btncanConfirm").click({obj:me},function(){window.location.reload()});$(this.targetDiv+" .ia-modal-dismiss").click(function(e){$.magnificPopup.close();e.preventDefault()});$(this.targetDiv+" .ia-action-menu-toggle").click(function(e){e.preventDefault();$(this.targetDiv+" .ia-action-menu-content").slideToggle("slow");$(this.targetDiv+" .ia-action-menu-arrow").toggleClass("fa-chevron-up").toggleClass("fa-chevron-down")});$(this.targetDiv+" input[name='ia-discussion-add-reply-box']").focus(function(){$(this).fadeOut("fast",function(){$(this.targetDiv+" .ia-discussion-reply-editor").fadeIn("fast")})});typeof $.fn.sticky!="undefined"&&$(this.targetDiv+" .ia-action-menu-content").sticky({topSpacing:10,responsiveWidth:!0});$(window).resize(function(){var browserWidth=me.viewport().width;browserWidth>640?$(this.targetDiv+" .ia-action-menu-content").show():$(this.targetDiv+" .ia-action-menu-content").hide()});var windowElem="#s4-workspace",elem=".ia-action-menu-content",ribbonElem="#s4-ribbonrow";if($(this.targetDiv+" #backOnTop").click(function(){$(windowElem).scrollTop(0)}),ribbonPosition=$(ribbonElem).position().top,$(elem).length>0){var eTop=$(elem).offset().top,initialRibbonHeight=$(ribbonElem).height()+ribbonPosition,topScrollPos=eTop-$(windowElem).scrollTop()-initialRibbonHeight;$(windowElem).scroll(function(){var ribbonHeight=$(ribbonElem).height()+ribbonPosition,pxFromTop=eTop-$(windowElem).scrollTop()-ribbonHeight,right;pxFromTop<0?(right=$(elem).offset().right,$(elem).offset({top:ribbonHeight,right:right})):pxFromTop>=topScrollPos&&(right=$(elem).offset().right,$(elem).offset({top:eTop,right:right}))})}};this.viewport=function(){var e=window,a="inner";return"innerWidth"in window||(a="client",e=document.documentElement||document.body),{width:e[a+"Width"],height:e[a+"Height"]}};this.GetFollowUrl=function(){return window.location.protocol+"//"+window.location.host+window.location.pathname};this.Follow=function(){this.pageIsFollowed=!0;window.SetFollowStatus(this.GetFollowUrl(),!0,!0);this.showHideFollowLink(this.pageIsFollowed)};this.UnFollow=function(){this.pageIsFollowed=!1;window.SetFollowStatus(this.GetFollowUrl(),!1,!0);this.showHideFollowLink(this.pageIsFollowed)};this.getUrl=function(){var ctxCurrent=SP.ClientContext.get_current(),url=ctxCurrent.get_url();return window.location.protocol+"//"+window.location.host+url+"?listId="+_spPageContextInfo.pageListId+"&itemId="+_spPageContextInfo.pageItemId};this.isAlreadyFollowed=function(){var clientContext=SP.ClientContext.get_current(),socialManager=new SP.Social.SocialFollowingManager(clientContext),socialActor=new SP.Social.SocialActorInfo;socialActor.set_contentUri(me.getUrl());socialActor.set_actorType(SP.Social.SocialActorTypes.documents);this.result=socialManager.isFollowed(socialActor);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.isAlreadyFollowed");clientContext.executeQueryAsync(Function.createDelegate(this,me.onCheckFollowSucceeded),Function.createDelegate(this,me.onQueryFailed))};this.onCheckFollowSucceeded=function(){me.showHideFollowLink(this.result.get_value());me.pageIsFollowed=this.result.get_value()};this.showHideFollowLink=function(isFollow){isFollow?($("#liFollowingThread").show(),$("#liFollowThread").hide()):($("#liFollowThread").show(),$("#liFollowingThread").hide())};this.onQueryFailed=function(sender,args){alert("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};$(document).ready(function(){SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){SP.SOD.executeFunc("userprofile","SP.Social.SocialFollowingManager",function(){me.isAlreadyFollowed()})});SP.SOD.executeFunc("followingcommon.js",null,function(){Akumina.AddIn.Logger.WriteErrorLog("followcommon.js loaded")})});this.toggleFollow=function(){me.pageIsFollowed?me.UnFollow():me.Follow()};this.ShowOverlay=function(){$.magnificPopup.close();$(me.targetDiv).length==0&&$("#"+this.uniqueId).html('<div class="interAction"><h1>Loading...<\/h1><div class="ia-loading-panel ia-hide"><div class="ia-loader"><\/div><\/div><\/div>');$(me.targetDiv+" .ia-loading-panel")&&$(me.targetDiv+" .ia-loading-panel").addClass("ia-show");$(me.targetDiv+" .ia-loading-panel").removeClass("ia-hide")};this.HideOverlay=function(){$(".ia-loading-panel")&&$(".ia-loading-panel").addClass("ia-hide");$(".ia-loading-panel").removeClass("ia-show")};this.DeleteThread=function(){var listVal=$(me.targetDiv+" #hdnListName").val(),idVal=$(me.targetDiv+" #hdnID").val(),clientContext=new SP.ClientContext,oList=clientContext.get_web().get_lists().getByTitle(listVal),oListItem=oList.getItemById(idVal);oListItem.deleteObject();Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.DeleteThread");clientContext.executeQueryAsync(Function.createDelegate(this,this.onDeleteThreadSucceeded),Function.createDelegate(this,this.onDeleteThreadFailed))};this.onDeleteThreadSucceeded=function(){window.location.href=this.DiscussionListingPageUrl};this.onDeleteThreadFailed=function(sender,args){me.ShowError("There was an error. "+args.get_message());me.HideOverlay()};this.DeleteReply=function(){me.ShowOverlay();var listVal=$(me.targetDiv+" #hdnListName").val(),threadIdVal=$(me.targetDiv+" #hdnID").val(),replyIdVal=$(me.targetDiv+" #hdnActionID").val(),clientContext=new SP.ClientContext,oList=clientContext.get_web().get_lists().getByTitle(listVal),oListItem=oList.getItemById(replyIdVal);oListItem.deleteObject();Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.DeleteReply");clientContext.executeQueryAsync(Function.createDelegate(this,this.onDeleteReplySucceeded),Function.createDelegate(this,this.onDeleteReplyFailed))};this.onDeleteReplySucceeded=function(){window.location.reload();me.HideOverlay()};this.onDeleteReplyFailed=function(sender,args){me.ShowError("There was an error. "+args.get_message());me.HideOverlay()};this.PostReply=function(){var fileVal;this.ShowOverlay();var threadIdVal=$(me.targetDiv+" #hdnID").val(),bodyVal=$(me.targetDiv+" #bodyDiscussion").val(),listVal=$(me.targetDiv+" #hdnListName").val(),libraryVal=$(me.targetDiv+" #hdnLibraryName").val(),filesVal=[],selectedFiles=$(me.targetDiv+" #listOfFilesHn").val().split("|");for(i=0;i<selectedFiles.length;i++)fileVal=selectedFiles[i],fileVal!=""&&filesVal.push(fileVal);me.CreateItem(threadIdVal,bodyVal,filesVal,listVal)};this.CreateItem=function(threadIdVal,bodyVal,filesVal,listVal){try{var clientContext=SP.ClientContext.get_current(),oList=clientContext.get_web().get_lists().getByTitle(listVal),discussionItem=oList.getItemById(threadIdVal);messageItem=SP.Utilities.Utility.createNewDiscussionReply(clientContext,discussionItem);messageItem.set_item("Body",bodyVal);messageItem.set_item("AttachmentLinks",filesVal.join("|"));messageItem.update();clientContext.load(messageItem);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.CreateItem");clientContext.executeQueryAsync(Function.createDelegate(this,this.OnQuerySucceeded),Function.createDelegate(this,this.OnQueryFailed))}catch(err){me.ShowError("There was an error. "+err.message);me.HideOverlay()}};this.OnQuerySucceeded=function(){window.location.reload()};this.OnQueryFailed=function(sender,args){me.ShowError("There was an error. "+args.get_message());me.HideOverlay()};this.getPermissions=function(){var selectedRoles=[],def=$.Deferred();me.count=0;me.rolesCount=0;this.GetCurrentUsername().then(function(){var threadIdVal=$(me.targetDiv+" #hdnID").val(),listVal=$(me.targetDiv+" #hdnListName").val(),ctx=new SP.ClientContext(_spPageContextInfo.webAbsoluteUrl),oList=ctx.get_web().get_lists().getByTitle(listVal),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+parseInt(threadIdVal)+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>");collListItem=oList.getItems(camlQuery);ctx.load(collListItem,"Include(Id, HasUniqueRoleAssignments)");Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.getPermissions");ctx.executeQueryAsync(Function.createDelegate(this,function(){for(var listItemEnumerator=collListItem.getEnumerator(),oListItem,hasUniqueRoleAssignments,roles;listItemEnumerator.moveNext();)oListItem=listItemEnumerator.get_current(),hasUniqueRoleAssignments=oListItem.get_hasUniqueRoleAssignments(),hasUniqueRoleAssignments?(roles=oListItem.get_roleAssignments(),ctx.load(roles),Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.get_roleAssignments"),ctx.executeQueryAsync(function(){var roleEnumerator=roles.getEnumerator();for(me.rolesCount=roles.get_count(),me.rolesCount==0&&def.reject();roleEnumerator.moveNext();)this.role=roleEnumerator.get_current(),ctx.load(this.role),Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.get_role"),ctx.executeQueryAsync(Function.createDelegate(this,me.getRolesSuccess(this.role,selectedRoles,def)),Function.createDelegate(this,function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())}))},function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())})):def.reject()}),Function.createDelegate(this,this.onSecurityQueryFailed))});def.then(function(roles){var selectedPermissions=[],allPermissions=[],i;for($(".ia-search-picker option").each(function(){allPermissions.push($(this).attr("value"))}),i=0;i<allPermissions.length;i++)roles.indexOf(parseInt(allPermissions[i]))!=-1&&selectedPermissions.push(allPermissions[i]);me.isSuperset(roles,allPermissions)||$(".ia-search-picker").val(selectedPermissions).trigger("chosen:updated")})};this.isSuperset=function(arr1,arr2){for(var i=0;i<arr2.length;i++)if(arr1.indexOf(parseInt(arr2[i]))===-1)return!1;return!0};this.getRolesSuccess=function(currentRole,selectedRoles,def){var roleID=currentRole.get_principalId();selectedRoles.indexOf(roleID)==-1&&selectedRoles.push(roleID);me.count=me.count+1;me.rolesCount==me.count&&def.resolve(selectedRoles)};this.getRolesFailure=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())};this.GetCurrentUsername=function(){var def=$.Deferred(),me=this,ctxt=new SP.ClientContext.get_current,web=ctxt.get_web();return me.currentUser=web.get_currentUser(),ctxt.load(me.currentUser),Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.GetCurrentUsername"),ctxt.executeQueryAsync(Function.createDelegate(me,function(){def.resolve(this.currentUser)}),Function.createDelegate(me,function(sender,args){Akumina.AddIn.Logger.WriteErrorLog(args.get_message());def.reject()})),def};this.BreakSecurityInheritanceChangeUser=function(){var me=this,listVal=$(me.targetDiv+" #hdnListName").val(),clientContext=new SP.ClientContext(_spPageContextInfo.webAbsoluteUrl),oList=clientContext.get_web().get_lists().getByTitle(listVal),threadIdVal=$(me.targetDiv+" #hdnID").val(),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<View><Query><Where><Eq><FieldRef Name='ID'/><Value Type='Number'>"+parseInt(threadIdVal)+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>");collListItem=oList.getItems(camlQuery);clientContext.load(collListItem,"Include(Id, HasUniqueRoleAssignments)");Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.BreakSecurityInheritanceChangeUser");clientContext.executeQueryAsync(Function.createDelegate(this,function(){me.listItemLoadSuccess(clientContext,collListItem)}),Function.createDelegate(this,this.onSecurityQueryFailed))};this.listItemLoadSuccess=function(clientContext,collListItem){for(var listItemEnumerator=collListItem.getEnumerator(),groupVal,roles;listItemEnumerator.moveNext();){var oListItem=listItemEnumerator.get_current(),hasUniqueRoleAssignments=oListItem.get_hasUniqueRoleAssignments(),groupsVal=[],selectedGroups=$("ul.chosen-choices li.search-choice");for(i=0;i<selectedGroups.length;i++)groupVal=$($(selectedGroups)[i]).text(),groupsVal.push(groupVal);groupsVal.length>0?(hasUniqueRoleAssignments||oListItem.breakRoleInheritance(!1),roles=oListItem.get_roleAssignments(),clientContext.load(roles),Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.listItemLoadSuccess"),clientContext.executeQueryAsync(function(){for(var roleEnumerator=roles.getEnumerator(),role="",principalId;roleEnumerator.moveNext();)role=roleEnumerator.get_current(),principalId=role.get_principalId(),oListItem.get_roleAssignments().getByPrincipalId(principalId).deleteObject();clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.listItemLoadSuccess.deleteObject");clientContext.executeQueryAsync(Function.createDelegate(me,function(){for(i=0;i<groupsVal.length;i++){var groupName=groupsVal[i],oGroup=clientContext.get_web().get_siteGroups().getByName(groupName),collRoleDefinitionBinding=SP.RoleDefinitionBindingCollection.newObject(clientContext);collRoleDefinitionBinding.add(clientContext.get_web().get_roleDefinitions().getByType(SP.RoleType.administrator));oListItem.get_roleAssignments().add(oGroup,collRoleDefinitionBinding)}clientContext.load(oGroup);clientContext.load(oListItem);Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.listItemLoadSuccess.get_roleAssignments.add");clientContext.executeQueryAsync(Function.createDelegate(me,me.onSecurityQuerySucceeded),Function.createDelegate(me,me.onSecurityQueryFailed))}),Function.createDelegate(me,me.onSecurityQueryFailed))})):hasUniqueRoleAssignments&&(oListItem.resetRoleInheritance(),clientContext.load(oListItem),Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.listItemLoadSuccess.resetRoleInheritance"),clientContext.executeQueryAsync(Function.createDelegate(me,me.onSecurityQuerySucceeded),Function.createDelegate(me,me.onSecurityQueryFailed)))}};this.onSecurityQuerySucceeded=function(){window.location.reload()};this.onSecurityQueryFailed=function(sender,args){me.ShowError("There was an error assigning permissions. "+args.get_message());me.HideOverlay()};this.ShowError=function(msg){alert(msg)};this.GetFolderTree=function(){var libraryVal=$(me.targetDiv+" #hdnLibraryName").val(),ctx=new SP.ClientContext.get_current,caml;me.oLibDocs=ctx.get_web().get_lists().getByTitle(libraryVal);caml=SP.CamlQuery.createAllItemsQuery();caml.set_viewXml("<View Scope='RecursiveAll'><Query><Where><Neq><FieldRef Name='ContentType' /><Value Type='Text'>Folder<\/Value><\/Neq><\/Where><OrderBy><FieldRef Name = 'FileLeafRef' Ascending = 'True'/><\/OrderBy><\/Query><\/View>");me.allDocumentsCol=me.oLibDocs.getItems(caml);ctx.load(me.oLibDocs);ctx.load(me.oLibDocs.get_rootFolder());ctx.load(me.allDocumentsCol,"Include(FileLeafRef, ServerUrl, Id, Title, DocIcon)");Akumina.AddIn.Logger.logSPCall("Akumina.AppParts.DiscussionThread.GetFolderTree");ctx.executeQueryAsync(Function.createDelegate(this,me.onTreeSucceededCallback),Function.createDelegate(this,me.onTreeFailedCallback))};this.onTreeSucceededCallback=function(){for(var libraryName=me.oLibDocs.get_title(),libraryUrl=me.oLibDocs.get_rootFolder().get_serverRelativeUrl(),ListEnumerator=me.allDocumentsCol.getEnumerator(),rootFolder={Name:libraryName,Folders:[],Files:[]},currentItemIconUrl,itemDetails,html;ListEnumerator.moveNext();){var currentItem=ListEnumerator.get_current(),currentItemId=currentItem.get_id(),currentItemName=currentItem.get_fieldValues().Title;currentItemName==null&&(currentItemName=currentItem.get_item("FileLeafRef"));var currentItemURL=currentItem.get_item("ServerUrl"),currentItemIconVal=currentItem.get_item("DocIcon"),currentItemIconExt="gif";switch(currentItemIconVal){case"txt":case"png":case"gif":case"jpg":case"zip":currentItemIconExt="gif";break;default:currentItemIconExt="png"}var siteName=this.GetSiteName(),folderUrl=this.getFolderURL(currentItemURL.replace(siteName,"")),pathTokens=currentItemURL.replace(siteName,"").replace("Shared Documents","Documents").split("/");pathTokens=pathTokens.splice(1,pathTokens.length-1);currentItemIconUrl=_spPageContextInfo.webServerRelativeUrl+"/_layouts/15/images/ic"+currentItemIconVal+"."+currentItemIconExt;itemDetails={currentItemId:currentItemId,currentItemName:currentItemName,currentItemIconUrl:currentItemIconUrl,currentItemURL:currentItemURL,listName:libraryName,folderUrl:folderUrl};this.createFolderStructure(rootFolder,pathTokens,1,itemDetails)}html=this.traverseFolder(rootFolder);$(me.targetDiv+" .ia-folder-tree").html(html);this.bindFolderTreeItemClickEvent()};this.bindFolderTreeItemClickEvent=function(){$(me.targetDiv+" .ia-folder-tree").on("changed.jstree",function(e,data){if(data.selected.length>1)$(".ia-folder-tree").jstree("deselect_all");else if(data.selected.length==1){var isfolder=$("#"+data.node.id).attr("isfolder");isfolder=="1"&&$(".ia-folder-tree").jstree("deselect_all")}}).jstree()};this.onTreeFailedCallback=function(){};this.GetSiteName=function(){return _spPageContextInfo.webServerRelativeUrl=="/"?"":_spPageContextInfo.webServerRelativeUrl};this.getFolderURL=function(currentItemURL){var folderURL=currentItemURL.split("/");return folderURL.splice(0,folderURL.length-1).join("/")};this.createFolderStructure=function(currentFolder,pathTokens,idxToken,itemDetails){var currentToken=pathTokens[idxToken],isLastToken=pathTokens.length-1==idxToken,subFolder;isLastToken?currentFolder.Files.push(itemDetails):(subFolder=this.getSubFolder(currentFolder,pathTokens[idxToken]),subFolder==null&&(subFolder=this.createSubFolder(currentFolder,pathTokens[idxToken],itemDetails)),this.createFolderStructure(subFolder,pathTokens,idxToken+1,itemDetails))};this.createSubFolder=function(currentFolder,name,itemDetails){var subFolder={Name:name,currentItemId:itemDetails.currentItemId,folderUrl:itemDetails.folderUrl,Folders:[],Files:[]};return currentFolder.Folders.push(subFolder),subFolder};this.getSubFolder=function(currentFolder,name){for(var i=0;i<currentFolder.Folders.length;i++)if(currentFolder.Folders[i].Name==name)return currentFolder.Folders[i];return null};this.traverseFolder=function(rootFolder){for(var html="<ul><li isfolder='1' title='"+rootFolder.Name+"' url-data='"+rootFolder.folderUrl+"' item-id='"+rootFolder.currentItemId+"' list-name='"+rootFolder.Name+"'>"+rootFolder.Name,i=0;i<rootFolder.Folders.length;i++)html+=this.traverseFolder(rootFolder.Folders[i]);for(html+="<ul>",i=0;i<rootFolder.Files.length;i++)html+="<li isfolder='0' data-jstree='{\"icon\":\"ia-hide-folder-icon\"}' title='"+rootFolder.Files[i].currentItemName+"' item-id='"+rootFolder.Files[i].currentItemId+"' list-name='"+rootFolder.Files[i].listName+"' url-data='"+rootFolder.Files[i].currentItemURL+"'><img src='"+rootFolder.Files[i].currentItemIconUrl+"' class='ia-folder-tree-icon'/> <span title='"+rootFolder.Files[i].currentItemName+"'>"+rootFolder.Files[i].currentItemName+"<\/span><\/li>";return html+="<\/ul>",html+"<\/li><\/ul>"};this.Init(options)}),function(Akumina){var AddIn;(function(AddIn){var JsPageData=function(){function JsPageData(){}return JsPageData.prototype.createItem=function(listTitle,itemTitle,pageTitle,retentionHours){if(!JsPageData.prototype.excludePage(itemTitle)){this.itemTitle=itemTitle;this.listTitle=listTitle;this.pageTitle=pageTitle;this.spWeb=null;this.siteId="";this.itemId=0;this.modified="";this.retentionHours=retentionHours;var clientContext=SP.ClientContext.get_current(),list=clientContext.get_site().get_rootWeb().get_lists().getByTitle(this.listTitle),camlQuery=new SP.CamlQuery;camlQuery.set_viewXml("<View><Query><Where><Eq><FieldRef Name='Title'/><Value Type='Text'>"+this.itemTitle+"<\/Value><\/Eq><\/Where><\/Query><RowLimit>1<\/RowLimit><\/View>");this.spWeb=clientContext.get_web();this.listItem=list.getItems(camlQuery);clientContext.load(this.spWeb);clientContext.load(this.listItem,"Include(ID,Title,PageDataTitle,PageDataSiteId,Modified)");Akumina.AddIn.Logger.logSPCall("JsPageData.prototype.createItem");clientContext.executeQueryAsync(Function.createDelegate(this,JsPageData.prototype.onGetQuerySucceeded),Function.createDelegate(this,JsPageData.prototype.onGetQueryFailed))}},JsPageData.prototype.excludePage=function(itemTitle){for(var excludeItem,isMatch,exclude=!1,excludeList=Akumina.Digispace.ConfigurationContext.SearchPageExclusionList,i=0;i<excludeList.length;i++)if(excludeItem=excludeList[i],isMatch=itemTitle.toLowerCase().indexOf(excludeItem.toLowerCase())>-1,isMatch){exclude=!0;break}return exclude},JsPageData.prototype.onGetQuerySucceeded=function(){for(var listEnumerator=this.listItem.getEnumerator(),current;listEnumerator.moveNext();)current=listEnumerator.get_current(),this.itemId=current.get_item("ID"),this.modified=current.get_item("Modified");this.siteId=this.spWeb.get_id().toString();JsPageData.prototype.insertOrUpdate(this.listTitle,this.itemId,this.itemTitle,this.pageTitle,this.siteId)},JsPageData.prototype.onGetQueryFailed=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},JsPageData.prototype.insertOrUpdate=function(listTitle,itemId,itemTitle,pageTitle,siteId){var clientContext=SP.ClientContext.get_current(),list=clientContext.get_site().get_rootWeb().get_lists().getByTitle(listTitle),itemCreateInfo,html;itemId>0?this.listItem=list.getItemById(itemId):(itemCreateInfo=new SP.ListItemCreationInformation,this.listItem=list.addItem(itemCreateInfo),this.listItem.set_item("Title",itemTitle));html=$(".interAction").clone();html.find("script").remove();this.listItem.set_item("Html",html.text().replace(/(\r\n|\n|\r)/gm,""));this.listItem.set_item("PageDataTitle",pageTitle);this.listItem.set_item("PageDataSiteId",siteId);this.listItem.update();Akumina.AddIn.Logger.logSPCall("JsPageData.prototype.insertOrUpdate");clientContext.executeQueryAsync(Function.createDelegate(this,JsPageData.prototype.onQuerySucceeded),Function.createDelegate(this,JsPageData.prototype.onQueryFailed))},JsPageData.prototype.onQuerySucceeded=function(){Akumina.AddIn.Logger.WriteInfoLog("write succeeded.")},JsPageData.prototype.onQueryFailed=function(sender,args){Akumina.AddIn.Logger.WriteErrorLog("Request failed. "+args.get_message()+"\n"+args.get_stackTrace())},JsPageData}();AddIn.JsPageData=JsPageData})(AddIn=Akumina.AddIn||(Akumina.AddIn={}))}(Akumina||(Akumina={}));$(document).ready(function(){$(".ak-user-nav-trigger").click(function(){$(".ak-user-nav").toggleClass("ak-active");$(".ak-page-container").toggleClass("ak-nav-active");$(".ak-user-nav-trigger").toggleClass("ak-nav-active")});$(".ak-user-nav-flyout-link").click(function(e){e.preventDefault();$(".ak-user-nav-flyout").removeClass("ak-active");$(this).next(".ak-user-nav-flyout").toggleClass("ak-active");taskHeight=$(".ak-task-title").height();$(".ak-task-due").css("min-height",taskHeight)})});$(document).on("click",function(event){$(event.target).closest(".ak-user-nav-link").length||$(".ak-user-nav-flyout").removeClass("ak-active")});$(window).load(function(){setPageHeight()});$(window).resize(function(){clearTimeout(resizeId);resizeId=setTimeout(doneResizing,500)});$(document).ready(function(){if($(".ak-main-nav-trigger").click(function(){$(this).toggleClass("ak-active");$(".ak-main-nav").toggleClass("ak-active")}),_spPageContextInfo.serverRequestPath.split("/").pop().toLowerCase().indexOf("search.aspx")>-1)$(window).on("hashchange",function(){$("#s4-workspace").animate({scrollTop:0},"fast")})})
//# sourceMappingURL=digitalworkplace.min.js.map
